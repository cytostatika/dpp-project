<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-3"></span><span>
</span><span id="line-4"></span><span class="hs-comment">-- | Do various kernel optimisations - mostly related to coalescing.</span><span>
</span><span id="line-5"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Futhark.Pass.KernelBabysitting</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.KernelBabysitting.html#babysitKernels"><span class="hs-identifier">babysitKernels</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-6"></span><span>
</span><span id="line-7"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Arrow</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">first</span></span><span class="hs-special">)</span><span>
</span><span id="line-8"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.State.Strict</span></span><span>
</span><span id="line-9"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Foldable</span></span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">elemIndex</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">isPrefixOf</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">sort</span></span><span class="hs-special">)</span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map.Strict</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.html"><span class="hs-identifier">Futhark.IR</span></a></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html"><span class="hs-identifier">Futhark.IR.GPU</span></a></span><span> </span><span class="hs-keyword">hiding</span><span>
</span><span id="line-15"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier">BasicOp</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-16"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier">Body</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-17"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#Exp"><span class="hs-identifier">Exp</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-18"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#FParam"><span class="hs-identifier">FParam</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-19"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#FunDef"><span class="hs-identifier">FunDef</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-20"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#LParam"><span class="hs-identifier">LParam</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-21"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier">Lambda</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-22"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier">Pat</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-23"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#PatElem"><span class="hs-identifier">PatElem</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-24"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#Prog"><span class="hs-identifier">Prog</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-25"></span><span>    </span><span class="annot"><a href="Futhark.IR.Rep.html#RetType"><span class="hs-identifier">RetType</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-26"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier">Stm</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-27"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.MonadFreshNames.html"><span class="hs-identifier">Futhark.MonadFreshNames</span></a></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Pass.html"><span class="hs-identifier">Futhark.Pass</span></a></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Tools.html"><span class="hs-identifier">Futhark.Tools</span></a></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Util.html"><span class="hs-identifier">Futhark.Util</span></a></span><span>
</span><span id="line-32"></span><span>
</span><span id="line-33"></span><span class="hs-comment">-- | The pass definition.</span><span>
</span><span id="line-34"></span><span class="annot"><a href="Futhark.Pass.KernelBabysitting.html#babysitKernels"><span class="hs-identifier hs-type">babysitKernels</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Pass.html#Pass"><span class="hs-identifier hs-type">Pass</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span>
</span><span id="line-35"></span><span id="babysitKernels"><span class="annot"><span class="annottext">babysitKernels :: Pass GPU GPU
</span><a href="Futhark.Pass.KernelBabysitting.html#babysitKernels"><span class="hs-identifier hs-var hs-var">babysitKernels</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-36"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; String -&gt; (Prog GPU -&gt; PassM (Prog GPU)) -&gt; Pass GPU GPU
forall fromrep torep.
String
-&gt; String
-&gt; (Prog fromrep -&gt; PassM (Prog torep))
-&gt; Pass fromrep torep
</span><a href="Futhark.Pass.html#Pass"><span class="hs-identifier hs-var">Pass</span></a></span><span>
</span><span id="line-37"></span><span>    </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;babysit kernels&quot;</span></span><span>
</span><span id="line-38"></span><span>    </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Transpose kernel input arrays for better performance.&quot;</span></span><span>
</span><span id="line-39"></span><span>    </span><span class="annot"><span class="annottext">((Prog GPU -&gt; PassM (Prog GPU)) -&gt; Pass GPU GPU)
-&gt; (Prog GPU -&gt; PassM (Prog GPU)) -&gt; Pass GPU GPU
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Scope GPU -&gt; Stms GPU -&gt; PassM (Stms GPU))
-&gt; Prog GPU -&gt; PassM (Prog GPU)
forall rep.
(Scope rep -&gt; Stms rep -&gt; PassM (Stms rep))
-&gt; Prog rep -&gt; PassM (Prog rep)
</span><a href="Futhark.Pass.html#intraproceduralTransformation"><span class="hs-identifier hs-var">intraproceduralTransformation</span></a></span><span> </span><span class="annot"><span class="annottext">Scope GPU -&gt; Stms GPU -&gt; PassM (Stms GPU)
forall {f :: * -&gt; *}.
MonadFreshNames f =&gt;
Scope GPU -&gt; Stms GPU -&gt; f (Stms GPU)
</span><a href="#local-6989586621684418177"><span class="hs-identifier hs-var">onStms</span></a></span><span>
</span><span id="line-40"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-41"></span><span>    </span><span id="local-6989586621684418177"><span class="annot"><span class="annottext">onStms :: Scope GPU -&gt; Stms GPU -&gt; f (Stms GPU)
</span><a href="#local-6989586621684418177"><span class="hs-identifier hs-var hs-var">onStms</span></a></span></span><span> </span><span id="local-6989586621684418161"><span class="annot"><span class="annottext">Scope GPU
</span><a href="#local-6989586621684418161"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span id="local-6989586621684418160"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684418160"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-42"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684418159"><span class="annot"><span class="annottext">m :: BuilderT GPU (State VNameSource) (Stms GPU)
</span><a href="#local-6989586621684418159"><span class="hs-identifier hs-var hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Scope GPU
-&gt; BuilderT GPU (State VNameSource) (Stms GPU)
-&gt; BuilderT GPU (State VNameSource) (Stms GPU)
forall rep (m :: * -&gt; *) a.
LocalScope rep m =&gt;
Scope rep -&gt; m a -&gt; m a
</span><a href="Futhark.IR.Prop.Scope.html#localScope"><span class="hs-identifier hs-var">localScope</span></a></span><span> </span><span class="annot"><span class="annottext">Scope GPU
</span><a href="#local-6989586621684418161"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="annot"><span class="annottext">(BuilderT GPU (State VNameSource) (Stms GPU)
 -&gt; BuilderT GPU (State VNameSource) (Stms GPU))
-&gt; BuilderT GPU (State VNameSource) (Stms GPU)
-&gt; BuilderT GPU (State VNameSource) (Stms GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Map VName (Stm GPU)
-&gt; Stms GPU -&gt; BuilderT GPU (State VNameSource) (Stms GPU)
</span><a href="Futhark.Pass.KernelBabysitting.html#transformStms"><span class="hs-identifier hs-var">transformStms</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName (Stm GPU)
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684418160"><span class="hs-identifier hs-var">stms</span></a></span><span>
</span><span id="line-43"></span><span>      </span><span class="annot"><span class="annottext">((Stms GPU, Stms GPU) -&gt; Stms GPU)
-&gt; f (Stms GPU, Stms GPU) -&gt; f (Stms GPU)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">(Stms GPU, Stms GPU) -&gt; Stms GPU
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">(f (Stms GPU, Stms GPU) -&gt; f (Stms GPU))
-&gt; f (Stms GPU, Stms GPU) -&gt; f (Stms GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(VNameSource -&gt; ((Stms GPU, Stms GPU), VNameSource))
-&gt; f (Stms GPU, Stms GPU)
forall (m :: * -&gt; *) a.
MonadFreshNames m =&gt;
(VNameSource -&gt; (a, VNameSource)) -&gt; m a
</span><a href="Futhark.MonadFreshNames.html#modifyNameSource"><span class="hs-identifier hs-var">modifyNameSource</span></a></span><span> </span><span class="annot"><span class="annottext">((VNameSource -&gt; ((Stms GPU, Stms GPU), VNameSource))
 -&gt; f (Stms GPU, Stms GPU))
-&gt; (VNameSource -&gt; ((Stms GPU, Stms GPU), VNameSource))
-&gt; f (Stms GPU, Stms GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">State VNameSource (Stms GPU, Stms GPU)
-&gt; VNameSource -&gt; ((Stms GPU, Stms GPU), VNameSource)
forall s a. State s a -&gt; s -&gt; (a, s)
</span><span class="hs-identifier hs-var">runState</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BuilderT GPU (State VNameSource) (Stms GPU)
-&gt; Scope GPU -&gt; State VNameSource (Stms GPU, Stms GPU)
forall (m :: * -&gt; *) rep a.
MonadFreshNames m =&gt;
BuilderT rep m a -&gt; Scope rep -&gt; m (a, Stms rep)
</span><a href="Futhark.Builder.html#runBuilderT"><span class="hs-identifier hs-var">runBuilderT</span></a></span><span> </span><span class="annot"><span class="annottext">BuilderT GPU (State VNameSource) (Stms GPU)
</span><a href="#local-6989586621684418159"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">Scope GPU
forall k a. Map k a
</span><span class="hs-identifier hs-var">M.empty</span></span><span class="hs-special">)</span><span>
</span><span id="line-44"></span><span>
</span><span id="line-45"></span><span class="hs-keyword">type</span><span> </span><span id="BabysitM"><span class="annot"><a href="Futhark.Pass.KernelBabysitting.html#BabysitM"><span class="hs-identifier hs-var">BabysitM</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Futhark.Builder.html#Builder"><span class="hs-identifier hs-type">Builder</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span>
</span><span id="line-46"></span><span>
</span><span id="line-47"></span><span class="annot"><a href="Futhark.Pass.KernelBabysitting.html#transformStms"><span class="hs-identifier hs-type">transformStms</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Pass.KernelBabysitting.html#ExpMap"><span class="hs-identifier hs-type">ExpMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.KernelBabysitting.html#BabysitM"><span class="hs-identifier hs-type">BabysitM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-48"></span><span id="transformStms"><span class="annot"><span class="annottext">transformStms :: Map VName (Stm GPU)
-&gt; Stms GPU -&gt; BuilderT GPU (State VNameSource) (Stms GPU)
</span><a href="Futhark.Pass.KernelBabysitting.html#transformStms"><span class="hs-identifier hs-var hs-var">transformStms</span></a></span></span><span> </span><span id="local-6989586621684418150"><span class="annot"><span class="annottext">Map VName (Stm GPU)
</span><a href="#local-6989586621684418150"><span class="hs-identifier hs-var">expmap</span></a></span></span><span> </span><span id="local-6989586621684418149"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684418149"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BuilderT GPU (State VNameSource) ()
-&gt; BuilderT
     GPU
     (State VNameSource)
     (Stms (Rep (BuilderT GPU (State VNameSource))))
forall (m :: * -&gt; *) a. MonadBuilder m =&gt; m a -&gt; m (Stms (Rep m))
</span><a href="Futhark.Builder.Class.html#collectStms_"><span class="hs-identifier hs-var">collectStms_</span></a></span><span> </span><span class="annot"><span class="annottext">(BuilderT GPU (State VNameSource) ()
 -&gt; BuilderT
      GPU
      (State VNameSource)
      (Stms (Rep (BuilderT GPU (State VNameSource)))))
-&gt; BuilderT GPU (State VNameSource) ()
-&gt; BuilderT
     GPU
     (State VNameSource)
     (Stms (Rep (BuilderT GPU (State VNameSource))))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Map VName (Stm GPU)
 -&gt; Stm GPU
 -&gt; BuilderT GPU (State VNameSource) (Map VName (Stm GPU)))
-&gt; Map VName (Stm GPU)
-&gt; Stms GPU
-&gt; BuilderT GPU (State VNameSource) ()
forall (t :: * -&gt; *) (m :: * -&gt; *) b a.
(Foldable t, Monad m) =&gt;
(b -&gt; a -&gt; m b) -&gt; b -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">foldM_</span></span><span> </span><span class="annot"><span class="annottext">Map VName (Stm GPU)
-&gt; Stm GPU
-&gt; BuilderT GPU (State VNameSource) (Map VName (Stm GPU))
</span><a href="Futhark.Pass.KernelBabysitting.html#transformStm"><span class="hs-identifier hs-var">transformStm</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName (Stm GPU)
</span><a href="#local-6989586621684418150"><span class="hs-identifier hs-var">expmap</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684418149"><span class="hs-identifier hs-var">stms</span></a></span><span>
</span><span id="line-49"></span><span>
</span><span id="line-50"></span><span class="annot"><a href="Futhark.Pass.KernelBabysitting.html#transformBody"><span class="hs-identifier hs-type">transformBody</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Pass.KernelBabysitting.html#ExpMap"><span class="hs-identifier hs-type">ExpMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.KernelBabysitting.html#BabysitM"><span class="hs-identifier hs-type">BabysitM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span id="transformBody"><span class="annot"><span class="annottext">transformBody :: Map VName (Stm GPU) -&gt; Body GPU -&gt; BabysitM (Body GPU)
</span><a href="Futhark.Pass.KernelBabysitting.html#transformBody"><span class="hs-identifier hs-var hs-var">transformBody</span></a></span></span><span> </span><span id="local-6989586621684418144"><span class="annot"><span class="annottext">Map VName (Stm GPU)
</span><a href="#local-6989586621684418144"><span class="hs-identifier hs-var">expmap</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span id="local-6989586621684418143"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684418143"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span id="local-6989586621684418142"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684418142"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-52"></span><span>  </span><span id="local-6989586621684418141"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684418141"><span class="hs-identifier hs-var">stms'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Map VName (Stm GPU)
-&gt; Stms GPU -&gt; BuilderT GPU (State VNameSource) (Stms GPU)
</span><a href="Futhark.Pass.KernelBabysitting.html#transformStms"><span class="hs-identifier hs-var">transformStms</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName (Stm GPU)
</span><a href="#local-6989586621684418144"><span class="hs-identifier hs-var">expmap</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684418143"><span class="hs-identifier hs-var">stms</span></a></span><span>
</span><span id="line-53"></span><span>  </span><span class="annot"><span class="annottext">Body GPU -&gt; BabysitM (Body GPU)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Body GPU -&gt; BabysitM (Body GPU))
-&gt; Body GPU -&gt; BabysitM (Body GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BodyDec GPU -&gt; Stms GPU -&gt; Result -&gt; Body GPU
forall rep. BodyDec rep -&gt; Stms rep -&gt; Result -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-var">Body</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684418141"><span class="hs-identifier hs-var">stms'</span></a></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684418142"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-54"></span><span>
</span><span id="line-55"></span><span class="hs-comment">-- | Map from variable names to defining expression.  We use this to</span><span>
</span><span id="line-56"></span><span class="hs-comment">-- hackily determine whether something is transposed or otherwise</span><span>
</span><span id="line-57"></span><span class="hs-comment">-- funky in memory (and we'd prefer it not to be).  If we cannot find</span><span>
</span><span id="line-58"></span><span class="hs-comment">-- it in the map, we just assume it's all good.  HACK and FIXME, I</span><span>
</span><span id="line-59"></span><span class="hs-comment">-- suppose.  We really should do this at the memory level.</span><span>
</span><span id="line-60"></span><span class="hs-keyword">type</span><span> </span><span id="ExpMap"><span class="annot"><a href="Futhark.Pass.KernelBabysitting.html#ExpMap"><span class="hs-identifier hs-var">ExpMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-61"></span><span>
</span><span id="line-62"></span><span class="annot"><a href="Futhark.Pass.KernelBabysitting.html#nonlinearInMemory"><span class="hs-identifier hs-type">nonlinearInMemory</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.KernelBabysitting.html#ExpMap"><span class="hs-identifier hs-type">ExpMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-63"></span><span id="nonlinearInMemory"><span class="annot"><span class="annottext">nonlinearInMemory :: VName -&gt; Map VName (Stm GPU) -&gt; Maybe (Maybe [Int])
</span><a href="Futhark.Pass.KernelBabysitting.html#nonlinearInMemory"><span class="hs-identifier hs-var hs-var">nonlinearInMemory</span></a></span></span><span> </span><span id="local-6989586621684418139"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684418139"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621684418138"><span class="annot"><span class="annottext">Map VName (Stm GPU)
</span><a href="#local-6989586621684418138"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-64"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Map VName (Stm GPU) -&gt; Maybe (Stm GPU)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684418139"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName (Stm GPU)
</span><a href="#local-6989586621684418138"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-65"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPU
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec GPU)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Opaque"><span class="hs-identifier hs-type">Opaque</span></a></span><span> </span><span class="annot"><span class="annottext">OpaqueOp
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684418133"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684418133"><span class="hs-identifier hs-var">arr</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Map VName (Stm GPU) -&gt; Maybe (Maybe [Int])
</span><a href="Futhark.Pass.KernelBabysitting.html#nonlinearInMemory"><span class="hs-identifier hs-var">nonlinearInMemory</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684418133"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName (Stm GPU)
</span><a href="#local-6989586621684418138"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-66"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPU
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec GPU)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Rearrange"><span class="hs-identifier hs-type">Rearrange</span></a></span><span> </span><span id="local-6989586621684418131"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684418131"><span class="hs-identifier hs-var">perm</span></a></span></span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe [Int] -&gt; Maybe (Maybe [Int])
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Maybe [Int] -&gt; Maybe (Maybe [Int]))
-&gt; Maybe [Int] -&gt; Maybe (Maybe [Int])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; Maybe [Int]
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">([Int] -&gt; Maybe [Int]) -&gt; [Int] -&gt; Maybe [Int]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; [Int]
</span><a href="Futhark.IR.Prop.Rearrange.html#rearrangeInverse"><span class="hs-identifier hs-var">rearrangeInverse</span></a></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684418131"><span class="hs-identifier hs-var">perm</span></a></span><span>
</span><span id="line-67"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPU
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec GPU)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Reshape"><span class="hs-identifier hs-type">Reshape</span></a></span><span> </span><span class="annot"><span class="annottext">ShapeChange SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684418128"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684418128"><span class="hs-identifier hs-var">arr</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Map VName (Stm GPU) -&gt; Maybe (Maybe [Int])
</span><a href="Futhark.Pass.KernelBabysitting.html#nonlinearInMemory"><span class="hs-identifier hs-var">nonlinearInMemory</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684418128"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName (Stm GPU)
</span><a href="#local-6989586621684418138"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-68"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPU
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec GPU)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Manifest"><span class="hs-identifier hs-type">Manifest</span></a></span><span> </span><span id="local-6989586621684418126"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684418126"><span class="hs-identifier hs-var">perm</span></a></span></span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe [Int] -&gt; Maybe (Maybe [Int])
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Maybe [Int] -&gt; Maybe (Maybe [Int]))
-&gt; Maybe [Int] -&gt; Maybe (Maybe [Int])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; Maybe [Int]
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684418126"><span class="hs-identifier hs-var">perm</span></a></span><span>
</span><span id="line-69"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684418125"><span class="annot"><span class="annottext">Pat GPU
</span><a href="#local-6989586621684418125"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec GPU)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SegOp"><span class="hs-identifier hs-type">SegOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#SegMap"><span class="hs-identifier hs-type">SegMap</span></a></span><span> </span><span class="annot"><span class="annottext">SegLevel
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684418121"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684418121"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span class="annot"><span class="annottext">KernelBody GPU
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-70"></span><span>      </span><span class="annot"><span class="annottext">(PatElemT Type, Type) -&gt; Maybe (Maybe [Int])
forall {shape} {dec} {u}.
(ArrayShape shape, Typed dec) =&gt;
(PatElemT dec, TypeBase shape u) -&gt; Maybe (Maybe [Int])
</span><a href="#local-6989586621684418120"><span class="hs-identifier hs-var">nonlinear</span></a></span><span>
</span><span id="line-71"></span><span>        </span><span class="annot"><span class="annottext">((PatElemT Type, Type) -&gt; Maybe (Maybe [Int]))
-&gt; Maybe (PatElemT Type, Type) -&gt; Maybe (Maybe [Int])
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">((PatElemT Type, Type) -&gt; Bool)
-&gt; [(PatElemT Type, Type)] -&gt; Maybe (PatElemT Type, Type)
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Maybe a
</span><span class="hs-identifier hs-var">find</span></span><span>
</span><span id="line-72"></span><span>          </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; VName -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684418139"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Bool)
-&gt; ((PatElemT Type, Type) -&gt; VName)
-&gt; (PatElemT Type, Type)
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PatElemT Type -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">(PatElemT Type -&gt; VName)
-&gt; ((PatElemT Type, Type) -&gt; PatElemT Type)
-&gt; (PatElemT Type, Type)
-&gt; VName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(PatElemT Type, Type) -&gt; PatElemT Type
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span>
</span><span id="line-73"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PatElemT Type] -&gt; [Type] -&gt; [(PatElemT Type, Type)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatT Type -&gt; [PatElemT Type]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span> </span><span class="annot"><span class="annottext">PatT Type
Pat GPU
</span><a href="#local-6989586621684418125"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684418121"><span class="hs-identifier hs-var">ts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-74"></span><span>    </span><span class="annot"><span class="annottext">Maybe (Stm GPU)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (Maybe [Int])
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-75"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-76"></span><span>    </span><span id="local-6989586621684418120"><span class="annot"><span class="annottext">nonlinear :: (PatElemT dec, TypeBase shape u) -&gt; Maybe (Maybe [Int])
</span><a href="#local-6989586621684418120"><span class="hs-identifier hs-var hs-var">nonlinear</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684418097"><span class="annot"><span class="annottext">PatElemT dec
</span><a href="#local-6989586621684418097"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684418096"><span class="annot"><span class="annottext">TypeBase shape u
</span><a href="#local-6989586621684418096"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-77"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621684418095"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684418095"><span class="hs-identifier hs-var">inner_r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TypeBase shape u -&gt; Int
forall shape u. ArrayShape shape =&gt; TypeBase shape u -&gt; Int
</span><a href="Futhark.IR.Prop.Types.html#arrayRank"><span class="hs-identifier hs-var">arrayRank</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase shape u
</span><a href="#local-6989586621684418096"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-78"></span><span>        </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684418095"><span class="hs-identifier hs-var">inner_r</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-79"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684418092"><span class="annot"><span class="annottext">outer_r :: Int
</span><a href="#local-6989586621684418092"><span class="hs-identifier hs-var hs-var">outer_r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Int
forall shape u. ArrayShape shape =&gt; TypeBase shape u -&gt; Int
</span><a href="Futhark.IR.Prop.Types.html#arrayRank"><span class="hs-identifier hs-var">arrayRank</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT dec -&gt; Type
forall dec. Typed dec =&gt; PatElemT dec -&gt; Type
</span><a href="Futhark.IR.Prop.Patterns.html#patElemType"><span class="hs-identifier hs-var">patElemType</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT dec
</span><a href="#local-6989586621684418097"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684418095"><span class="hs-identifier hs-var">inner_r</span></a></span><span>
</span><span id="line-80"></span><span>        </span><span class="annot"><span class="annottext">Maybe [Int] -&gt; Maybe (Maybe [Int])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe [Int] -&gt; Maybe (Maybe [Int]))
-&gt; Maybe [Int] -&gt; Maybe (Maybe [Int])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; Maybe [Int]
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">([Int] -&gt; Maybe [Int]) -&gt; [Int] -&gt; Maybe [Int]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; [Int]
</span><a href="Futhark.IR.Prop.Rearrange.html#rearrangeInverse"><span class="hs-identifier hs-var">rearrangeInverse</span></a></span><span> </span><span class="annot"><span class="annottext">([Int] -&gt; [Int]) -&gt; [Int] -&gt; [Int]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684418095"><span class="hs-identifier hs-var">inner_r</span></a></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684418095"><span class="hs-identifier hs-var">inner_r</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684418092"><span class="hs-identifier hs-var">outer_r</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; [Int] -&gt; [Int]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684418095"><span class="hs-identifier hs-var">inner_r</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span>
</span><span id="line-81"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (Maybe [Int])
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-82"></span><span>
</span><span id="line-83"></span><span class="annot"><a href="Futhark.Pass.KernelBabysitting.html#transformStm"><span class="hs-identifier hs-type">transformStm</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Pass.KernelBabysitting.html#ExpMap"><span class="hs-identifier hs-type">ExpMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.KernelBabysitting.html#BabysitM"><span class="hs-identifier hs-type">BabysitM</span></a></span><span> </span><span class="annot"><a href="Futhark.Pass.KernelBabysitting.html#ExpMap"><span class="hs-identifier hs-type">ExpMap</span></a></span><span>
</span><span id="line-84"></span><span id="transformStm"><span class="annot"><span class="annottext">transformStm :: Map VName (Stm GPU)
-&gt; Stm GPU
-&gt; BuilderT GPU (State VNameSource) (Map VName (Stm GPU))
</span><a href="Futhark.Pass.KernelBabysitting.html#transformStm"><span class="hs-identifier hs-var hs-var">transformStm</span></a></span></span><span> </span><span id="local-6989586621684418089"><span class="annot"><span class="annottext">Map VName (Stm GPU)
</span><a href="#local-6989586621684418089"><span class="hs-identifier hs-var">expmap</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684418088"><span class="annot"><span class="annottext">Pat GPU
</span><a href="#local-6989586621684418088"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684418087"><span class="annot"><span class="annottext">StmAux (ExpDec GPU)
</span><a href="#local-6989586621684418087"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SegOp"><span class="hs-identifier hs-type">SegOp</span></a></span><span> </span><span id="local-6989586621684418086"><span class="annot"><span class="annottext">SegOp SegLevel GPU
</span><a href="#local-6989586621684418086"><span class="hs-identifier hs-var">op</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-85"></span><span>  </span><span class="hs-comment">-- FIXME: We only make coalescing optimisations for SegThread</span><span>
</span><span id="line-86"></span><span>  </span><span class="hs-comment">-- SegOps, because that's what the analysis assumes.  For SegGroup</span><span>
</span><span id="line-87"></span><span>  </span><span class="hs-comment">-- we should probably look at the component SegThreads, but it</span><span>
</span><span id="line-88"></span><span>  </span><span class="hs-comment">-- apparently hasn't come up in practice yet.</span><span>
</span><span id="line-89"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SegThread"><span class="hs-identifier hs-type">SegThread</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SegOp SegLevel GPU -&gt; SegLevel
forall lvl rep. SegOp lvl rep -&gt; lvl
</span><a href="Futhark.IR.SegOp.html#segLevel"><span class="hs-identifier hs-var">segLevel</span></a></span><span> </span><span class="annot"><span class="annottext">SegOp SegLevel GPU
</span><a href="#local-6989586621684418086"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-90"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684418083"><span class="annot"><span class="annottext">mapper :: SegOpMapper SegLevel GPU GPU (BuilderT GPU (State VNameSource))
</span><a href="#local-6989586621684418083"><span class="hs-identifier hs-var hs-var">mapper</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-91"></span><span>          </span><span class="annot"><span class="annottext">SegOpMapper SegLevel GPU GPU (BuilderT GPU (State VNameSource))
forall (m :: * -&gt; *) lvl rep. Monad m =&gt; SegOpMapper lvl rep rep m
</span><a href="Futhark.IR.SegOp.html#identitySegOpMapper"><span class="hs-identifier hs-var">identitySegOpMapper</span></a></span><span>
</span><span id="line-92"></span><span>            </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">mapOnSegOpBody :: KernelBody GPU -&gt; BuilderT GPU (State VNameSource) (KernelBody GPU)
</span><a href="Futhark.IR.SegOp.html#mapOnSegOpBody"><span class="hs-identifier hs-var">mapOnSegOpBody</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-93"></span><span>                </span><span class="annot"><span class="annottext">Map VName (Stm GPU)
-&gt; SegLevel
-&gt; SegSpace
-&gt; KernelBody GPU
-&gt; BuilderT GPU (State VNameSource) (KernelBody GPU)
</span><a href="Futhark.Pass.KernelBabysitting.html#transformKernelBody"><span class="hs-identifier hs-var">transformKernelBody</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName (Stm GPU)
</span><a href="#local-6989586621684418089"><span class="hs-identifier hs-var">expmap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegOp SegLevel GPU -&gt; SegLevel
forall lvl rep. SegOp lvl rep -&gt; lvl
</span><a href="Futhark.IR.SegOp.html#segLevel"><span class="hs-identifier hs-var">segLevel</span></a></span><span> </span><span class="annot"><span class="annottext">SegOp SegLevel GPU
</span><a href="#local-6989586621684418086"><span class="hs-identifier hs-var">op</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegOp SegLevel GPU -&gt; SegSpace
forall lvl rep. SegOp lvl rep -&gt; SegSpace
</span><a href="Futhark.IR.SegOp.html#segSpace"><span class="hs-identifier hs-var">segSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SegOp SegLevel GPU
</span><a href="#local-6989586621684418086"><span class="hs-identifier hs-var">op</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-94"></span><span>            </span><span class="hs-special">}</span><span>
</span><span id="line-95"></span><span>    </span><span id="local-6989586621684418078"><span class="annot"><span class="annottext">SegOp SegLevel GPU
</span><a href="#local-6989586621684418078"><span class="hs-identifier hs-var">op'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SegOpMapper SegLevel GPU GPU (BuilderT GPU (State VNameSource))
-&gt; SegOp SegLevel GPU
-&gt; BuilderT GPU (State VNameSource) (SegOp SegLevel GPU)
forall (m :: * -&gt; *) lvl frep trep.
(Applicative m, Monad m) =&gt;
SegOpMapper lvl frep trep m -&gt; SegOp lvl frep -&gt; m (SegOp lvl trep)
</span><a href="Futhark.IR.SegOp.html#mapSegOpM"><span class="hs-identifier hs-var">mapSegOpM</span></a></span><span> </span><span class="annot"><span class="annottext">SegOpMapper SegLevel GPU GPU (BuilderT GPU (State VNameSource))
</span><a href="#local-6989586621684418083"><span class="hs-identifier hs-var">mapper</span></a></span><span> </span><span class="annot"><span class="annottext">SegOp SegLevel GPU
</span><a href="#local-6989586621684418086"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-96"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684418076"><span class="annot"><span class="annottext">stm' :: Stm GPU
</span><a href="#local-6989586621684418076"><span class="hs-identifier hs-var hs-var">stm'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Pat GPU -&gt; StmAux (ExpDec GPU) -&gt; ExpT GPU -&gt; Stm GPU
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPU
</span><a href="#local-6989586621684418088"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec GPU)
</span><a href="#local-6989586621684418087"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">(ExpT GPU -&gt; Stm GPU) -&gt; ExpT GPU -&gt; Stm GPU
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Op GPU -&gt; ExpT GPU
forall rep. Op rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-var">Op</span></a></span><span> </span><span class="annot"><span class="annottext">(Op GPU -&gt; ExpT GPU) -&gt; Op GPU -&gt; ExpT GPU
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegOp SegLevel GPU -&gt; HostOp GPU (SOAC GPU)
forall rep op. SegOp SegLevel rep -&gt; HostOp rep op
</span><a href="Futhark.IR.GPU.Op.html#SegOp"><span class="hs-identifier hs-var">SegOp</span></a></span><span> </span><span class="annot"><span class="annottext">SegOp SegLevel GPU
</span><a href="#local-6989586621684418078"><span class="hs-identifier hs-var">op'</span></a></span><span>
</span><span id="line-97"></span><span>    </span><span class="annot"><span class="annottext">Stm (Rep (BuilderT GPU (State VNameSource)))
-&gt; BuilderT GPU (State VNameSource) ()
forall (m :: * -&gt; *). MonadBuilder m =&gt; Stm (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#addStm"><span class="hs-identifier hs-var">addStm</span></a></span><span> </span><span class="annot"><span class="annottext">Stm (Rep (BuilderT GPU (State VNameSource)))
Stm GPU
</span><a href="#local-6989586621684418076"><span class="hs-identifier hs-var">stm'</span></a></span><span>
</span><span id="line-98"></span><span>    </span><span class="annot"><span class="annottext">Map VName (Stm GPU)
-&gt; BuilderT GPU (State VNameSource) (Map VName (Stm GPU))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Map VName (Stm GPU)
 -&gt; BuilderT GPU (State VNameSource) (Map VName (Stm GPU)))
-&gt; Map VName (Stm GPU)
-&gt; BuilderT GPU (State VNameSource) (Map VName (Stm GPU))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(VName, Stm GPU)] -&gt; Map VName (Stm GPU)
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684418073"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stm GPU
</span><a href="#local-6989586621684418076"><span class="hs-identifier hs-var">stm'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621684418073"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684418073"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PatT Type -&gt; [VName]
forall dec. PatT dec -&gt; [VName]
</span><a href="Futhark.IR.Prop.Patterns.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="annot"><span class="annottext">PatT Type
Pat GPU
</span><a href="#local-6989586621684418088"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Map VName (Stm GPU) -&gt; Map VName (Stm GPU) -&gt; Map VName (Stm GPU)
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Map VName (Stm GPU)
</span><a href="#local-6989586621684418089"><span class="hs-identifier hs-var">expmap</span></a></span><span>
</span><span id="line-99"></span><span class="annot"><a href="Futhark.Pass.KernelBabysitting.html#transformStm"><span class="hs-identifier hs-var">transformStm</span></a></span><span> </span><span id="local-6989586621684418071"><span class="annot"><span class="annottext">Map VName (Stm GPU)
</span><a href="#local-6989586621684418071"><span class="hs-identifier hs-var">expmap</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684418070"><span class="annot"><span class="annottext">Pat GPU
</span><a href="#local-6989586621684418070"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684418069"><span class="annot"><span class="annottext">StmAux (ExpDec GPU)
</span><a href="#local-6989586621684418069"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span id="local-6989586621684418068"><span class="annot"><span class="annottext">ExpT GPU
</span><a href="#local-6989586621684418068"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-100"></span><span>  </span><span id="local-6989586621684418067"><span class="annot"><span class="annottext">ExpT GPU
</span><a href="#local-6989586621684418067"><span class="hs-identifier hs-var">e'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Mapper GPU GPU (BuilderT GPU (State VNameSource))
-&gt; ExpT GPU -&gt; BabysitM (ExpT GPU)
forall (m :: * -&gt; *) frep trep.
(Applicative m, Monad m) =&gt;
Mapper frep trep m -&gt; Exp frep -&gt; m (Exp trep)
</span><a href="Futhark.IR.Traversals.html#mapExpM"><span class="hs-identifier hs-var">mapExpM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName (Stm GPU)
-&gt; Mapper GPU GPU (BuilderT GPU (State VNameSource))
</span><a href="Futhark.Pass.KernelBabysitting.html#transform"><span class="hs-identifier hs-var">transform</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName (Stm GPU)
</span><a href="#local-6989586621684418071"><span class="hs-identifier hs-var">expmap</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ExpT GPU
</span><a href="#local-6989586621684418068"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-101"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684418064"><span class="annot"><span class="annottext">stm' :: Stm GPU
</span><a href="#local-6989586621684418064"><span class="hs-identifier hs-var hs-var">stm'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Pat GPU -&gt; StmAux (ExpDec GPU) -&gt; ExpT GPU -&gt; Stm GPU
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPU
</span><a href="#local-6989586621684418070"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec GPU)
</span><a href="#local-6989586621684418069"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">ExpT GPU
</span><a href="#local-6989586621684418067"><span class="hs-identifier hs-var">e'</span></a></span><span>
</span><span id="line-102"></span><span>  </span><span class="annot"><span class="annottext">Stm (Rep (BuilderT GPU (State VNameSource)))
-&gt; BuilderT GPU (State VNameSource) ()
forall (m :: * -&gt; *). MonadBuilder m =&gt; Stm (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#addStm"><span class="hs-identifier hs-var">addStm</span></a></span><span> </span><span class="annot"><span class="annottext">Stm (Rep (BuilderT GPU (State VNameSource)))
Stm GPU
</span><a href="#local-6989586621684418064"><span class="hs-identifier hs-var">stm'</span></a></span><span>
</span><span id="line-103"></span><span>  </span><span class="annot"><span class="annottext">Map VName (Stm GPU)
-&gt; BuilderT GPU (State VNameSource) (Map VName (Stm GPU))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Map VName (Stm GPU)
 -&gt; BuilderT GPU (State VNameSource) (Map VName (Stm GPU)))
-&gt; Map VName (Stm GPU)
-&gt; BuilderT GPU (State VNameSource) (Map VName (Stm GPU))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(VName, Stm GPU)] -&gt; Map VName (Stm GPU)
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684418063"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stm GPU
</span><a href="#local-6989586621684418064"><span class="hs-identifier hs-var">stm'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621684418063"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684418063"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PatT Type -&gt; [VName]
forall dec. PatT dec -&gt; [VName]
</span><a href="Futhark.IR.Prop.Patterns.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="annot"><span class="annottext">PatT Type
Pat GPU
</span><a href="#local-6989586621684418070"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Map VName (Stm GPU) -&gt; Map VName (Stm GPU) -&gt; Map VName (Stm GPU)
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Map VName (Stm GPU)
</span><a href="#local-6989586621684418071"><span class="hs-identifier hs-var">expmap</span></a></span><span>
</span><span id="line-104"></span><span>
</span><span id="line-105"></span><span class="annot"><a href="Futhark.Pass.KernelBabysitting.html#transform"><span class="hs-identifier hs-type">transform</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Pass.KernelBabysitting.html#ExpMap"><span class="hs-identifier hs-type">ExpMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Traversals.html#Mapper"><span class="hs-identifier hs-type">Mapper</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span> </span><span class="annot"><a href="Futhark.Pass.KernelBabysitting.html#BabysitM"><span class="hs-identifier hs-type">BabysitM</span></a></span><span>
</span><span id="line-106"></span><span id="transform"><span class="annot"><span class="annottext">transform :: Map VName (Stm GPU)
-&gt; Mapper GPU GPU (BuilderT GPU (State VNameSource))
</span><a href="Futhark.Pass.KernelBabysitting.html#transform"><span class="hs-identifier hs-var hs-var">transform</span></a></span></span><span> </span><span id="local-6989586621684418062"><span class="annot"><span class="annottext">Map VName (Stm GPU)
</span><a href="#local-6989586621684418062"><span class="hs-identifier hs-var">expmap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-107"></span><span>  </span><span class="annot"><span class="annottext">Mapper GPU GPU (BuilderT GPU (State VNameSource))
forall (m :: * -&gt; *) rep. Monad m =&gt; Mapper rep rep m
</span><a href="Futhark.IR.Traversals.html#identityMapper"><span class="hs-identifier hs-var">identityMapper</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">mapOnBody :: Scope GPU -&gt; Body GPU -&gt; BabysitM (Body GPU)
</span><a href="Futhark.IR.Traversals.html#mapOnBody"><span class="hs-identifier hs-var">mapOnBody</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684418059"><span class="annot"><span class="annottext">Scope GPU
</span><a href="#local-6989586621684418059"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Scope GPU -&gt; BabysitM (Body GPU) -&gt; BabysitM (Body GPU)
forall rep (m :: * -&gt; *) a.
LocalScope rep m =&gt;
Scope rep -&gt; m a -&gt; m a
</span><a href="Futhark.IR.Prop.Scope.html#localScope"><span class="hs-identifier hs-var">localScope</span></a></span><span> </span><span class="annot"><span class="annottext">Scope GPU
</span><a href="#local-6989586621684418059"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="annot"><span class="annottext">(BabysitM (Body GPU) -&gt; BabysitM (Body GPU))
-&gt; (Body GPU -&gt; BabysitM (Body GPU))
-&gt; Body GPU
-&gt; BabysitM (Body GPU)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Map VName (Stm GPU) -&gt; Body GPU -&gt; BabysitM (Body GPU)
</span><a href="Futhark.Pass.KernelBabysitting.html#transformBody"><span class="hs-identifier hs-var">transformBody</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName (Stm GPU)
</span><a href="#local-6989586621684418062"><span class="hs-identifier hs-var">expmap</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-108"></span><span>
</span><span id="line-109"></span><span class="annot"><a href="Futhark.Pass.KernelBabysitting.html#transformKernelBody"><span class="hs-identifier hs-type">transformKernelBody</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-110"></span><span>  </span><span class="annot"><a href="Futhark.Pass.KernelBabysitting.html#ExpMap"><span class="hs-identifier hs-type">ExpMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-111"></span><span>  </span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SegLevel"><span class="hs-identifier hs-type">SegLevel</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-112"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegSpace"><span class="hs-identifier hs-type">SegSpace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-113"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-type">KernelBody</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-114"></span><span>  </span><span class="annot"><a href="Futhark.Pass.KernelBabysitting.html#BabysitM"><span class="hs-identifier hs-type">BabysitM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-type">KernelBody</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-115"></span><span id="transformKernelBody"><span class="annot"><span class="annottext">transformKernelBody :: Map VName (Stm GPU)
-&gt; SegLevel
-&gt; SegSpace
-&gt; KernelBody GPU
-&gt; BuilderT GPU (State VNameSource) (KernelBody GPU)
</span><a href="Futhark.Pass.KernelBabysitting.html#transformKernelBody"><span class="hs-identifier hs-var hs-var">transformKernelBody</span></a></span></span><span> </span><span id="local-6989586621684418058"><span class="annot"><span class="annottext">Map VName (Stm GPU)
</span><a href="#local-6989586621684418058"><span class="hs-identifier hs-var">expmap</span></a></span></span><span> </span><span id="local-6989586621684418057"><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684418057"><span class="hs-identifier hs-var">lvl</span></a></span></span><span> </span><span id="local-6989586621684418056"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684418056"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684418055"><span class="annot"><span class="annottext">KernelBody GPU
</span><a href="#local-6989586621684418055"><span class="hs-identifier hs-var">kbody</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-116"></span><span>  </span><span class="hs-comment">-- Go spelunking for accesses to arrays that are defined outside the</span><span>
</span><span id="line-117"></span><span>  </span><span class="hs-comment">-- kernel body and where the indices are kernel thread indices.</span><span>
</span><span id="line-118"></span><span>  </span><span id="local-6989586621684418054"><span class="annot"><span class="annottext">Scope GPU
</span><a href="#local-6989586621684418054"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">BuilderT GPU (State VNameSource) (Scope GPU)
forall rep (m :: * -&gt; *). HasScope rep m =&gt; m (Scope rep)
</span><a href="Futhark.IR.Prop.Scope.html#askScope"><span class="hs-identifier hs-var">askScope</span></a></span><span>
</span><span id="line-119"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684418052"><span class="annot"><span class="annottext">thread_gids :: [VName]
</span><a href="#local-6989586621684418052"><span class="hs-identifier hs-var hs-var">thread_gids</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((VName, SubExp) -&gt; VName) -&gt; [(VName, SubExp)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(VName, SubExp) -&gt; VName
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">([(VName, SubExp)] -&gt; [VName]) -&gt; [(VName, SubExp)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; [(VName, SubExp)]
</span><a href="Futhark.IR.SegOp.html#unSegSpace"><span class="hs-identifier hs-var hs-var">unSegSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684418056"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-120"></span><span>      </span><span id="local-6989586621684418050"><span class="annot"><span class="annottext">thread_local :: Names
</span><a href="#local-6989586621684418050"><span class="hs-identifier hs-var hs-var">thread_local</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#namesFromList"><span class="hs-identifier hs-var">namesFromList</span></a></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; Names) -&gt; [VName] -&gt; Names
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; VName
</span><a href="Futhark.IR.SegOp.html#segFlat"><span class="hs-identifier hs-var hs-var">segFlat</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684418056"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [VName] -&gt; [VName]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684418052"><span class="hs-identifier hs-var">thread_gids</span></a></span><span>
</span><span id="line-121"></span><span>      </span><span id="local-6989586621684418047"><span class="annot"><span class="annottext">free_ker_vars :: Names
</span><a href="#local-6989586621684418047"><span class="hs-identifier hs-var hs-var">free_ker_vars</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">KernelBody GPU -&gt; Names
forall a. FreeIn a =&gt; a -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#freeIn"><span class="hs-identifier hs-var">freeIn</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody GPU
</span><a href="#local-6989586621684418055"><span class="hs-identifier hs-var">kbody</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#namesSubtract"><span class="hs-operator hs-var">`namesSubtract`</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; Names
</span><a href="#local-6989586621684418044"><span class="hs-identifier hs-var">getKerVariantIds</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684418056"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-122"></span><span>  </span><span id="local-6989586621684418043"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684418043"><span class="hs-identifier hs-var">num_threads</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-123"></span><span>    </span><span class="annot"><span class="annottext">String
-&gt; Exp (Rep (BuilderT GPU (State VNameSource)))
-&gt; BuilderT GPU (State VNameSource) SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;num_threads&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (BuilderT GPU (State VNameSource)))
 -&gt; BuilderT GPU (State VNameSource) SubExp)
-&gt; Exp (Rep (BuilderT GPU (State VNameSource)))
-&gt; BuilderT GPU (State VNameSource) SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-124"></span><span>      </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT GPU
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT GPU) -&gt; BasicOp -&gt; ExpT GPU
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-125"></span><span>        </span><span class="annot"><span class="annottext">BinOp -&gt; SubExp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#BinOp"><span class="hs-identifier hs-var">BinOp</span></a></span><span>
</span><span id="line-126"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Overflow -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#Mul"><span class="hs-identifier hs-var">Mul</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Overflow
</span><a href="Futhark.IR.Primitive.html#OverflowUndef"><span class="hs-identifier hs-var">OverflowUndef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-127"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Count NumGroups SubExp -&gt; SubExp
forall u e. Count u e -&gt; e
</span><a href="Futhark.IR.GPU.Sizes.html#unCount"><span class="hs-identifier hs-var hs-var">unCount</span></a></span><span> </span><span class="annot"><span class="annottext">(Count NumGroups SubExp -&gt; SubExp)
-&gt; Count NumGroups SubExp -&gt; SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegLevel -&gt; Count NumGroups SubExp
</span><a href="Futhark.IR.GPU.Op.html#segNumGroups"><span class="hs-identifier hs-var hs-var">segNumGroups</span></a></span><span> </span><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684418057"><span class="hs-identifier hs-var">lvl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-128"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Count GroupSize SubExp -&gt; SubExp
forall u e. Count u e -&gt; e
</span><a href="Futhark.IR.GPU.Sizes.html#unCount"><span class="hs-identifier hs-var hs-var">unCount</span></a></span><span> </span><span class="annot"><span class="annottext">(Count GroupSize SubExp -&gt; SubExp)
-&gt; Count GroupSize SubExp -&gt; SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegLevel -&gt; Count GroupSize SubExp
</span><a href="Futhark.IR.GPU.Op.html#segGroupSize"><span class="hs-identifier hs-var hs-var">segGroupSize</span></a></span><span> </span><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684418057"><span class="hs-identifier hs-var">lvl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-129"></span><span>  </span><span class="annot"><span class="annottext">StateT
  Replacements (BuilderT GPU (State VNameSource)) (KernelBody GPU)
-&gt; Replacements
-&gt; BuilderT GPU (State VNameSource) (KernelBody GPU)
forall (m :: * -&gt; *) s a. Monad m =&gt; StateT s m a -&gt; s -&gt; m a
</span><span class="hs-identifier hs-var">evalStateT</span></span><span>
</span><span id="line-130"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Names
-&gt; Names
-&gt; Scope GPU
-&gt; ArrayIndexTransform
     (StateT Replacements (BuilderT GPU (State VNameSource)))
-&gt; KernelBody GPU
-&gt; StateT
     Replacements (BuilderT GPU (State VNameSource)) (KernelBody GPU)
forall (f :: * -&gt; *).
(Applicative f, Monad f) =&gt;
Names
-&gt; Names
-&gt; Scope GPU
-&gt; ArrayIndexTransform f
-&gt; KernelBody GPU
-&gt; f (KernelBody GPU)
</span><a href="Futhark.Pass.KernelBabysitting.html#traverseKernelBodyArrayIndexes"><span class="hs-identifier hs-var">traverseKernelBodyArrayIndexes</span></a></span><span>
</span><span id="line-131"></span><span>        </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684418047"><span class="hs-identifier hs-var">free_ker_vars</span></a></span><span>
</span><span id="line-132"></span><span>        </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684418050"><span class="hs-identifier hs-var">thread_local</span></a></span><span>
</span><span id="line-133"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Scope GPU
</span><a href="#local-6989586621684418054"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="annot"><span class="annottext">Scope GPU -&gt; Scope GPU -&gt; Scope GPU
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; Scope GPU
forall rep. SegSpace -&gt; Scope rep
</span><a href="Futhark.IR.SegOp.html#scopeOfSegSpace"><span class="hs-identifier hs-var">scopeOfSegSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684418056"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-134"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName (Stm GPU)
-&gt; [(VName, SubExp)]
-&gt; SubExp
-&gt; ArrayIndexTransform
     (StateT Replacements (BuilderT GPU (State VNameSource)))
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Map VName (Stm GPU)
-&gt; [(VName, SubExp)]
-&gt; SubExp
-&gt; ArrayIndexTransform (StateT Replacements m)
</span><a href="Futhark.Pass.KernelBabysitting.html#ensureCoalescedAccess"><span class="hs-identifier hs-var">ensureCoalescedAccess</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName (Stm GPU)
</span><a href="#local-6989586621684418058"><span class="hs-identifier hs-var">expmap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegSpace -&gt; [(VName, SubExp)]
</span><a href="Futhark.IR.SegOp.html#unSegSpace"><span class="hs-identifier hs-var hs-var">unSegSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684418056"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684418043"><span class="hs-identifier hs-var">num_threads</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-135"></span><span>        </span><span class="annot"><span class="annottext">KernelBody GPU
</span><a href="#local-6989586621684418055"><span class="hs-identifier hs-var">kbody</span></a></span><span>
</span><span id="line-136"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-137"></span><span>    </span><span class="annot"><span class="annottext">Replacements
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-138"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-139"></span><span>    </span><span id="local-6989586621684418044"><span class="annot"><span class="annottext">getKerVariantIds :: SegSpace -&gt; Names
</span><a href="#local-6989586621684418044"><span class="hs-identifier hs-var hs-var">getKerVariantIds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#namesFromList"><span class="hs-identifier hs-var">namesFromList</span></a></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; Names) -&gt; (SegSpace -&gt; [VName]) -&gt; SegSpace -&gt; Names
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Map VName (NameInfo Any) -&gt; [VName]
forall k a. Map k a -&gt; [k]
</span><span class="hs-identifier hs-var">M.keys</span></span><span> </span><span class="annot"><span class="annottext">(Map VName (NameInfo Any) -&gt; [VName])
-&gt; (SegSpace -&gt; Map VName (NameInfo Any)) -&gt; SegSpace -&gt; [VName]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; Map VName (NameInfo Any)
forall rep. SegSpace -&gt; Scope rep
</span><a href="Futhark.IR.SegOp.html#scopeOfSegSpace"><span class="hs-identifier hs-var">scopeOfSegSpace</span></a></span><span>
</span><span id="line-140"></span><span>
</span><span id="line-141"></span><span class="hs-keyword">type</span><span> </span><span id="ArrayIndexTransform"><span class="annot"><a href="Futhark.Pass.KernelBabysitting.html#ArrayIndexTransform"><span class="hs-identifier hs-var">ArrayIndexTransform</span></a></span></span><span> </span><span id="local-6989586621684418029"><span class="annot"><a href="#local-6989586621684418029"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-142"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-143"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-comment">-- thread local?</span><span>
</span><span id="line-144"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-comment">-- variant to a certain gid (given as first param)?</span><span>
</span><span id="line-145"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-comment">-- split substitution?</span><span>
</span><span id="line-146"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-comment">-- type environment</span><span>
</span><span id="line-147"></span><span>  </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-148"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-type">Slice</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-149"></span><span>  </span><span class="annot"><a href="#local-6989586621684418029"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-type">Slice</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-150"></span><span>
</span><span id="line-151"></span><span id="local-6989586621684418512"><span class="annot"><a href="Futhark.Pass.KernelBabysitting.html#traverseKernelBodyArrayIndexes"><span class="hs-identifier hs-type">traverseKernelBodyArrayIndexes</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-152"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Applicative</span></span><span> </span><span class="annot"><a href="#local-6989586621684418512"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621684418512"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-153"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-154"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-155"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-156"></span><span>  </span><span class="annot"><a href="Futhark.Pass.KernelBabysitting.html#ArrayIndexTransform"><span class="hs-identifier hs-type">ArrayIndexTransform</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684418512"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-157"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-type">KernelBody</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-158"></span><span>  </span><span class="annot"><a href="#local-6989586621684418512"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-type">KernelBody</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-159"></span><span id="traverseKernelBodyArrayIndexes"><span class="annot"><span class="annottext">traverseKernelBodyArrayIndexes :: forall (f :: * -&gt; *).
(Applicative f, Monad f) =&gt;
Names
-&gt; Names
-&gt; Scope GPU
-&gt; ArrayIndexTransform f
-&gt; KernelBody GPU
-&gt; f (KernelBody GPU)
</span><a href="Futhark.Pass.KernelBabysitting.html#traverseKernelBodyArrayIndexes"><span class="hs-identifier hs-var hs-var">traverseKernelBodyArrayIndexes</span></a></span></span><span> </span><span id="local-6989586621684417988"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684417988"><span class="hs-identifier hs-var">free_ker_vars</span></a></span></span><span> </span><span id="local-6989586621684417987"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684417987"><span class="hs-identifier hs-var">thread_variant</span></a></span></span><span> </span><span id="local-6989586621684417986"><span class="annot"><span class="annottext">Scope GPU
</span><a href="#local-6989586621684417986"><span class="hs-identifier hs-var">outer_scope</span></a></span></span><span> </span><span id="local-6989586621684417985"><span class="annot"><span class="annottext">ArrayIndexTransform f
</span><a href="#local-6989586621684417985"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-type">KernelBody</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span id="local-6989586621684417983"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684417983"><span class="hs-identifier hs-var">kstms</span></a></span></span><span> </span><span id="local-6989586621684417982"><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684417982"><span class="hs-identifier hs-var">kres</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-160"></span><span>  </span><span class="annot"><span class="annottext">BodyDec GPU -&gt; Stms GPU -&gt; [KernelResult] -&gt; KernelBody GPU
forall rep.
BodyDec rep -&gt; Stms rep -&gt; [KernelResult] -&gt; KernelBody rep
</span><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-var">KernelBody</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Stms GPU -&gt; [KernelResult] -&gt; KernelBody GPU)
-&gt; ([Stm GPU] -&gt; Stms GPU)
-&gt; [Stm GPU]
-&gt; [KernelResult]
-&gt; KernelBody GPU
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[Stm GPU] -&gt; Stms GPU
forall rep. [Stm rep] -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#stmsFromList"><span class="hs-identifier hs-var">stmsFromList</span></a></span><span>
</span><span id="line-161"></span><span>    </span><span class="annot"><span class="annottext">([Stm GPU] -&gt; [KernelResult] -&gt; KernelBody GPU)
-&gt; f [Stm GPU] -&gt; f ([KernelResult] -&gt; KernelBody GPU)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Stm GPU -&gt; f (Stm GPU)) -&gt; [Stm GPU] -&gt; f [Stm GPU]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span>
</span><span id="line-162"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">(VarianceTable, Map VName SubExp, Scope GPU)
-&gt; Stm GPU -&gt; f (Stm GPU)
</span><a href="#local-6989586621684417978"><span class="hs-identifier hs-var">onStm</span></a></span><span>
</span><span id="line-163"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">VarianceTable -&gt; Stms GPU -&gt; VarianceTable
</span><a href="Futhark.Pass.KernelBabysitting.html#varianceInStms"><span class="hs-identifier hs-var">varianceInStms</span></a></span><span> </span><span class="annot"><span class="annottext">VarianceTable
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684417983"><span class="hs-identifier hs-var">kstms</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-164"></span><span>            </span><span class="annot"><span class="annottext">Stms GPU -&gt; Map VName SubExp
</span><a href="#local-6989586621684417976"><span class="hs-identifier hs-var">mkSizeSubsts</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684417983"><span class="hs-identifier hs-var">kstms</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-165"></span><span>            </span><span class="annot"><span class="annottext">Scope GPU
</span><a href="#local-6989586621684417986"><span class="hs-identifier hs-var">outer_scope</span></a></span><span>
</span><span id="line-166"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-167"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-168"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms GPU -&gt; [Stm GPU]
forall rep. Stms rep -&gt; [Stm rep]
</span><a href="Futhark.IR.Syntax.html#stmsToList"><span class="hs-identifier hs-var">stmsToList</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684417983"><span class="hs-identifier hs-var">kstms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-169"></span><span>    </span><span class="annot"><span class="annottext">f ([KernelResult] -&gt; KernelBody GPU)
-&gt; f [KernelResult] -&gt; f (KernelBody GPU)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">[KernelResult] -&gt; f [KernelResult]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684417982"><span class="hs-identifier hs-var">kres</span></a></span><span>
</span><span id="line-170"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-171"></span><span>    </span><span id="local-6989586621684417974"><span class="annot"><span class="annottext">onLambda :: (VarianceTable, Map VName SubExp, Scope GPU)
-&gt; LambdaT GPU -&gt; f (LambdaT GPU)
</span><a href="#local-6989586621684417974"><span class="hs-identifier hs-var hs-var">onLambda</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684417973"><span class="annot"><span class="annottext">VarianceTable
</span><a href="#local-6989586621684417973"><span class="hs-identifier hs-var">variance</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684417972"><span class="annot"><span class="annottext">Map VName SubExp
</span><a href="#local-6989586621684417972"><span class="hs-identifier hs-var">szsubst</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684417971"><span class="annot"><span class="annottext">Scope GPU
</span><a href="#local-6989586621684417971"><span class="hs-identifier hs-var">scope</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684417970"><span class="annot"><span class="annottext">LambdaT GPU
</span><a href="#local-6989586621684417970"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-172"></span><span>      </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621684417969"><span class="annot"><span class="annottext">Body GPU
</span><a href="#local-6989586621684417969"><span class="hs-identifier hs-var">body'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LambdaT GPU
</span><a href="#local-6989586621684417970"><span class="hs-identifier hs-var">lam</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">lambdaBody :: Body GPU
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var">lambdaBody</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Body GPU
</span><a href="#local-6989586621684417969"><span class="hs-identifier hs-var">body'</span></a></span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-173"></span><span>        </span><span class="annot"><span class="annottext">(Body GPU -&gt; LambdaT GPU) -&gt; f (Body GPU) -&gt; f (LambdaT GPU)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(VarianceTable, Map VName SubExp, Scope GPU)
-&gt; Body GPU -&gt; f (Body GPU)
</span><a href="#local-6989586621684417967"><span class="hs-identifier hs-var">onBody</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarianceTable
</span><a href="#local-6989586621684417973"><span class="hs-identifier hs-var">variance</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map VName SubExp
</span><a href="#local-6989586621684417972"><span class="hs-identifier hs-var">szsubst</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Scope GPU
</span><a href="#local-6989586621684417966"><span class="hs-identifier hs-var">scope'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LambdaT GPU -&gt; Body GPU
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT GPU
</span><a href="#local-6989586621684417970"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-174"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-175"></span><span>        </span><span id="local-6989586621684417966"><span class="annot"><span class="annottext">scope' :: Scope GPU
</span><a href="#local-6989586621684417966"><span class="hs-identifier hs-var hs-var">scope'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Scope GPU
</span><a href="#local-6989586621684417971"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="annot"><span class="annottext">Scope GPU -&gt; Scope GPU -&gt; Scope GPU
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Param Type] -&gt; Scope GPU
forall rep dec. (LParamInfo rep ~ dec) =&gt; [Param dec] -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOfLParams"><span class="hs-identifier hs-var">scopeOfLParams</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LambdaT GPU -&gt; [LParam GPU]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT GPU
</span><a href="#local-6989586621684417970"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-176"></span><span>
</span><span id="line-177"></span><span>    </span><span id="local-6989586621684417967"><span class="annot"><span class="annottext">onBody :: (VarianceTable, Map VName SubExp, Scope GPU)
-&gt; Body GPU -&gt; f (Body GPU)
</span><a href="#local-6989586621684417967"><span class="hs-identifier hs-var hs-var">onBody</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684417963"><span class="annot"><span class="annottext">VarianceTable
</span><a href="#local-6989586621684417963"><span class="hs-identifier hs-var">variance</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684417962"><span class="annot"><span class="annottext">Map VName SubExp
</span><a href="#local-6989586621684417962"><span class="hs-identifier hs-var">szsubst</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684417961"><span class="annot"><span class="annottext">Scope GPU
</span><a href="#local-6989586621684417961"><span class="hs-identifier hs-var">scope</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span id="local-6989586621684417960"><span class="annot"><span class="annottext">BodyDec GPU
</span><a href="#local-6989586621684417960"><span class="hs-identifier hs-var">bdec</span></a></span></span><span> </span><span id="local-6989586621684417959"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684417959"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span id="local-6989586621684417958"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684417958"><span class="hs-identifier hs-var">bres</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-178"></span><span>      </span><span id="local-6989586621684417957"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684417957"><span class="hs-identifier hs-var">stms'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Stm GPU] -&gt; Stms GPU
forall rep. [Stm rep] -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#stmsFromList"><span class="hs-identifier hs-var">stmsFromList</span></a></span><span> </span><span class="annot"><span class="annottext">([Stm GPU] -&gt; Stms GPU) -&gt; f [Stm GPU] -&gt; f (Stms GPU)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Stm GPU -&gt; f (Stm GPU)) -&gt; [Stm GPU] -&gt; f [Stm GPU]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(VarianceTable, Map VName SubExp, Scope GPU)
-&gt; Stm GPU -&gt; f (Stm GPU)
</span><a href="#local-6989586621684417978"><span class="hs-identifier hs-var">onStm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarianceTable
</span><a href="#local-6989586621684417956"><span class="hs-identifier hs-var">variance'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map VName SubExp
</span><a href="#local-6989586621684417955"><span class="hs-identifier hs-var">szsubst'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Scope GPU
</span><a href="#local-6989586621684417954"><span class="hs-identifier hs-var">scope'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms GPU -&gt; [Stm GPU]
forall rep. Stms rep -&gt; [Stm rep]
</span><a href="Futhark.IR.Syntax.html#stmsToList"><span class="hs-identifier hs-var">stmsToList</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684417959"><span class="hs-identifier hs-var">stms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-179"></span><span>      </span><span class="annot"><span class="annottext">Body GPU -&gt; f (Body GPU)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Body GPU -&gt; f (Body GPU)) -&gt; Body GPU -&gt; f (Body GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BodyDec GPU -&gt; Stms GPU -&gt; Result -&gt; Body GPU
forall rep. BodyDec rep -&gt; Stms rep -&gt; Result -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-var">Body</span></a></span><span> </span><span class="annot"><span class="annottext">BodyDec GPU
</span><a href="#local-6989586621684417960"><span class="hs-identifier hs-var">bdec</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684417957"><span class="hs-identifier hs-var">stms'</span></a></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684417958"><span class="hs-identifier hs-var">bres</span></a></span><span>
</span><span id="line-180"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-181"></span><span>        </span><span id="local-6989586621684417956"><span class="annot"><span class="annottext">variance' :: VarianceTable
</span><a href="#local-6989586621684417956"><span class="hs-identifier hs-var hs-var">variance'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarianceTable -&gt; Stms GPU -&gt; VarianceTable
</span><a href="Futhark.Pass.KernelBabysitting.html#varianceInStms"><span class="hs-identifier hs-var">varianceInStms</span></a></span><span> </span><span class="annot"><span class="annottext">VarianceTable
</span><a href="#local-6989586621684417963"><span class="hs-identifier hs-var">variance</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684417959"><span class="hs-identifier hs-var">stms</span></a></span><span>
</span><span id="line-182"></span><span>        </span><span id="local-6989586621684417955"><span class="annot"><span class="annottext">szsubst' :: Map VName SubExp
</span><a href="#local-6989586621684417955"><span class="hs-identifier hs-var hs-var">szsubst'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stms GPU -&gt; Map VName SubExp
</span><a href="#local-6989586621684417976"><span class="hs-identifier hs-var">mkSizeSubsts</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684417959"><span class="hs-identifier hs-var">stms</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SubExp -&gt; Map VName SubExp -&gt; Map VName SubExp
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Map VName SubExp
</span><a href="#local-6989586621684417962"><span class="hs-identifier hs-var">szsubst</span></a></span><span>
</span><span id="line-183"></span><span>        </span><span id="local-6989586621684417954"><span class="annot"><span class="annottext">scope' :: Scope GPU
</span><a href="#local-6989586621684417954"><span class="hs-identifier hs-var hs-var">scope'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Scope GPU
</span><a href="#local-6989586621684417961"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="annot"><span class="annottext">Scope GPU -&gt; Scope GPU -&gt; Scope GPU
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Stms GPU -&gt; Scope GPU
forall rep a. Scoped rep a =&gt; a -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOf"><span class="hs-identifier hs-var">scopeOf</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684417959"><span class="hs-identifier hs-var">stms</span></a></span><span>
</span><span id="line-184"></span><span>
</span><span id="line-185"></span><span>    </span><span id="local-6989586621684417978"><span class="annot"><span class="annottext">onStm :: (VarianceTable, Map VName SubExp, Scope GPU)
-&gt; Stm GPU -&gt; f (Stm GPU)
</span><a href="#local-6989586621684417978"><span class="hs-identifier hs-var hs-var">onStm</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684417952"><span class="annot"><span class="annottext">VarianceTable
</span><a href="#local-6989586621684417952"><span class="hs-identifier hs-var">variance</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684417951"><span class="annot"><span class="annottext">Map VName SubExp
</span><a href="#local-6989586621684417951"><span class="hs-identifier hs-var">szsubst</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Scope GPU
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684417950"><span class="annot"><span class="annottext">Pat GPU
</span><a href="#local-6989586621684417950"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684417949"><span class="annot"><span class="annottext">StmAux (ExpDec GPU)
</span><a href="#local-6989586621684417949"><span class="hs-identifier hs-var">dec</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Index"><span class="hs-identifier hs-type">Index</span></a></span><span> </span><span id="local-6989586621684417947"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417947"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span id="local-6989586621684417946"><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684417946"><span class="hs-identifier hs-var">is</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-186"></span><span>      </span><span class="annot"><span class="annottext">Pat GPU -&gt; StmAux (ExpDec GPU) -&gt; ExpT GPU -&gt; Stm GPU
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPU
</span><a href="#local-6989586621684417950"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec GPU)
</span><a href="#local-6989586621684417949"><span class="hs-identifier hs-var">dec</span></a></span><span> </span><span class="annot"><span class="annottext">(ExpT GPU -&gt; Stm GPU)
-&gt; (Maybe (VName, Slice SubExp) -&gt; ExpT GPU)
-&gt; Maybe (VName, Slice SubExp)
-&gt; Stm GPU
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Maybe (VName, Slice SubExp) -&gt; ExpT GPU
</span><a href="#local-6989586621684417945"><span class="hs-identifier hs-var">oldOrNew</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (VName, Slice SubExp) -&gt; Stm GPU)
-&gt; f (Maybe (VName, Slice SubExp)) -&gt; f (Stm GPU)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ArrayIndexTransform f
</span><a href="#local-6989586621684417985"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684417988"><span class="hs-identifier hs-var">free_ker_vars</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Bool
</span><a href="#local-6989586621684417944"><span class="hs-identifier hs-var">isThreadLocal</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp -&gt; Bool
</span><a href="#local-6989586621684417943"><span class="hs-identifier hs-var">isGidVariant</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Maybe SubExp
</span><a href="#local-6989586621684417942"><span class="hs-identifier hs-var">sizeSubst</span></a></span><span> </span><span class="annot"><span class="annottext">Scope GPU
</span><a href="#local-6989586621684417986"><span class="hs-identifier hs-var">outer_scope</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417947"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684417946"><span class="hs-identifier hs-var">is</span></a></span><span>
</span><span id="line-187"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-188"></span><span>        </span><span id="local-6989586621684417945"><span class="annot"><span class="annottext">oldOrNew :: Maybe (VName, Slice SubExp) -&gt; ExpT GPU
</span><a href="#local-6989586621684417945"><span class="hs-identifier hs-var hs-var">oldOrNew</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe (VName, Slice SubExp)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-189"></span><span>          </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT GPU
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT GPU) -&gt; BasicOp -&gt; ExpT GPU
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Slice SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Index"><span class="hs-identifier hs-var">Index</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417947"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684417946"><span class="hs-identifier hs-var">is</span></a></span><span>
</span><span id="line-190"></span><span>        </span><span class="annot"><a href="#local-6989586621684417945"><span class="hs-identifier hs-var">oldOrNew</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684417941"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417941"><span class="hs-identifier hs-var">arr'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684417940"><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684417940"><span class="hs-identifier hs-var">is'</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-191"></span><span>          </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT GPU
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT GPU) -&gt; BasicOp -&gt; ExpT GPU
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Slice SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Index"><span class="hs-identifier hs-var">Index</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417941"><span class="hs-identifier hs-var">arr'</span></a></span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684417940"><span class="hs-identifier hs-var">is'</span></a></span><span>
</span><span id="line-192"></span><span>
</span><span id="line-193"></span><span>        </span><span id="local-6989586621684417943"><span class="annot"><span class="annottext">isGidVariant :: VName -&gt; SubExp -&gt; Bool
</span><a href="#local-6989586621684417943"><span class="hs-identifier hs-var hs-var">isGidVariant</span></a></span></span><span> </span><span id="local-6989586621684417939"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417939"><span class="hs-identifier hs-var">gid</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684417938"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417938"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-194"></span><span>          </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417939"><span class="hs-identifier hs-var">gid</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; VName -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417938"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#nameIn"><span class="hs-identifier hs-var">nameIn</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417939"><span class="hs-identifier hs-var">gid</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Names -&gt; VName -&gt; VarianceTable -&gt; Names
forall k a. Ord k =&gt; a -&gt; k -&gt; Map k a -&gt; a
</span><span class="hs-identifier hs-var">M.findWithDefault</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#oneName"><span class="hs-identifier hs-var">oneName</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417938"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417938"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">VarianceTable
</span><a href="#local-6989586621684417952"><span class="hs-identifier hs-var">variance</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-195"></span><span>        </span><span class="annot"><a href="#local-6989586621684417943"><span class="hs-identifier hs-var">isGidVariant</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-196"></span><span>
</span><span id="line-197"></span><span>        </span><span id="local-6989586621684417944"><span class="annot"><span class="annottext">isThreadLocal :: VName -&gt; Bool
</span><a href="#local-6989586621684417944"><span class="hs-identifier hs-var hs-var">isThreadLocal</span></a></span></span><span> </span><span id="local-6989586621684417933"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417933"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-198"></span><span>          </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684417987"><span class="hs-identifier hs-var">thread_variant</span></a></span><span>
</span><span id="line-199"></span><span>            </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#namesIntersect"><span class="hs-operator hs-var">`namesIntersect`</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; VName -&gt; VarianceTable -&gt; Names
forall k a. Ord k =&gt; a -&gt; k -&gt; Map k a -&gt; a
</span><span class="hs-identifier hs-var">M.findWithDefault</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#oneName"><span class="hs-identifier hs-var">oneName</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417933"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417933"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">VarianceTable
</span><a href="#local-6989586621684417952"><span class="hs-identifier hs-var">variance</span></a></span><span>
</span><span id="line-200"></span><span>
</span><span id="line-201"></span><span>        </span><span id="local-6989586621684417942"><span class="annot"><span class="annottext">sizeSubst :: SubExp -&gt; Maybe SubExp
</span><a href="#local-6989586621684417942"><span class="hs-identifier hs-var hs-var">sizeSubst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span> </span><span id="local-6989586621684417930"><span class="annot"><span class="annottext">PrimValue
</span><a href="#local-6989586621684417930"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Maybe SubExp
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; Maybe SubExp) -&gt; SubExp -&gt; Maybe SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimValue -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Constant"><span class="hs-identifier hs-var">Constant</span></a></span><span> </span><span class="annot"><span class="annottext">PrimValue
</span><a href="#local-6989586621684417930"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-202"></span><span>        </span><span class="annot"><a href="#local-6989586621684417942"><span class="hs-identifier hs-var">sizeSubst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684417929"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417929"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-203"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417929"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Scope GPU -&gt; Bool
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Bool
</span><span class="hs-operator hs-var">`M.member`</span></span><span> </span><span class="annot"><span class="annottext">Scope GPU
</span><a href="#local-6989586621684417986"><span class="hs-identifier hs-var">outer_scope</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Maybe SubExp
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; Maybe SubExp) -&gt; SubExp -&gt; Maybe SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417929"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-204"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684417927"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684417927"><span class="hs-identifier hs-var">v'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Map VName SubExp -&gt; Maybe SubExp
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417929"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SubExp
</span><a href="#local-6989586621684417951"><span class="hs-identifier hs-var">szsubst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Maybe SubExp
</span><a href="#local-6989586621684417942"><span class="hs-identifier hs-var">sizeSubst</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684417927"><span class="hs-identifier hs-var">v'</span></a></span><span>
</span><span id="line-205"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe SubExp
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-206"></span><span>    </span><span class="annot"><a href="#local-6989586621684417978"><span class="hs-identifier hs-var">onStm</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684417926"><span class="annot"><span class="annottext">VarianceTable
</span><a href="#local-6989586621684417926"><span class="hs-identifier hs-var">variance</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684417925"><span class="annot"><span class="annottext">Map VName SubExp
</span><a href="#local-6989586621684417925"><span class="hs-identifier hs-var">szsubst</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684417924"><span class="annot"><span class="annottext">Scope GPU
</span><a href="#local-6989586621684417924"><span class="hs-identifier hs-var">scope</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684417923"><span class="annot"><span class="annottext">Pat GPU
</span><a href="#local-6989586621684417923"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684417922"><span class="annot"><span class="annottext">StmAux (ExpDec GPU)
</span><a href="#local-6989586621684417922"><span class="hs-identifier hs-var">dec</span></a></span></span><span> </span><span id="local-6989586621684417921"><span class="annot"><span class="annottext">ExpT GPU
</span><a href="#local-6989586621684417921"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-207"></span><span>      </span><span class="annot"><span class="annottext">Pat GPU -&gt; StmAux (ExpDec GPU) -&gt; ExpT GPU -&gt; Stm GPU
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPU
</span><a href="#local-6989586621684417923"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec GPU)
</span><a href="#local-6989586621684417922"><span class="hs-identifier hs-var">dec</span></a></span><span> </span><span class="annot"><span class="annottext">(ExpT GPU -&gt; Stm GPU) -&gt; f (ExpT GPU) -&gt; f (Stm GPU)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Mapper GPU GPU f -&gt; ExpT GPU -&gt; f (ExpT GPU)
forall (m :: * -&gt; *) frep trep.
(Applicative m, Monad m) =&gt;
Mapper frep trep m -&gt; Exp frep -&gt; m (Exp trep)
</span><a href="Futhark.IR.Traversals.html#mapExpM"><span class="hs-identifier hs-var">mapExpM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(VarianceTable, Map VName SubExp, Scope GPU) -&gt; Mapper GPU GPU f
</span><a href="#local-6989586621684417920"><span class="hs-identifier hs-var">mapper</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarianceTable
</span><a href="#local-6989586621684417926"><span class="hs-identifier hs-var">variance</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map VName SubExp
</span><a href="#local-6989586621684417925"><span class="hs-identifier hs-var">szsubst</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Scope GPU
</span><a href="#local-6989586621684417924"><span class="hs-identifier hs-var">scope</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ExpT GPU
</span><a href="#local-6989586621684417921"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-208"></span><span>
</span><span id="line-209"></span><span>    </span><span id="local-6989586621684417919"><span class="annot"><span class="annottext">onOp :: (VarianceTable, Map VName SubExp, Scope GPU)
-&gt; HostOp GPU (SOAC GPU) -&gt; f (HostOp GPU (SOAC GPU))
</span><a href="#local-6989586621684417919"><span class="hs-identifier hs-var hs-var">onOp</span></a></span></span><span> </span><span id="local-6989586621684417918"><span class="annot"><span class="annottext">(VarianceTable, Map VName SubExp, Scope GPU)
</span><a href="#local-6989586621684417918"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#OtherOp"><span class="hs-identifier hs-type">OtherOp</span></a></span><span> </span><span id="local-6989586621684417916"><span class="annot"><span class="annottext">SOAC GPU
</span><a href="#local-6989586621684417916"><span class="hs-identifier hs-var">soac</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-210"></span><span>      </span><span class="annot"><span class="annottext">SOAC GPU -&gt; HostOp GPU (SOAC GPU)
forall rep op. op -&gt; HostOp rep op
</span><a href="Futhark.IR.GPU.Op.html#OtherOp"><span class="hs-identifier hs-var">OtherOp</span></a></span><span> </span><span class="annot"><span class="annottext">(SOAC GPU -&gt; HostOp GPU (SOAC GPU))
-&gt; f (SOAC GPU) -&gt; f (HostOp GPU (SOAC GPU))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">SOACMapper GPU GPU f -&gt; SOAC GPU -&gt; f (SOAC GPU)
forall (m :: * -&gt; *) frep trep.
(Applicative m, Monad m) =&gt;
SOACMapper frep trep m -&gt; SOAC frep -&gt; m (SOAC trep)
</span><a href="Futhark.IR.SOACS.SOAC.html#mapSOACM"><span class="hs-identifier hs-var">mapSOACM</span></a></span><span> </span><span class="annot"><span class="annottext">SOACMapper Any Any f
forall (m :: * -&gt; *) rep. Monad m =&gt; SOACMapper rep rep m
</span><a href="Futhark.IR.SOACS.SOAC.html#identitySOACMapper"><span class="hs-identifier hs-var">identitySOACMapper</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">mapOnSOACLambda :: LambdaT GPU -&gt; f (LambdaT GPU)
</span><a href="#local-6989586621684417913"><span class="hs-identifier hs-var">mapOnSOACLambda</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VarianceTable, Map VName SubExp, Scope GPU)
-&gt; LambdaT GPU -&gt; f (LambdaT GPU)
</span><a href="#local-6989586621684417974"><span class="hs-identifier hs-var">onLambda</span></a></span><span> </span><span class="annot"><span class="annottext">(VarianceTable, Map VName SubExp, Scope GPU)
</span><a href="#local-6989586621684417918"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">}</span><span> </span><span class="annot"><span class="annottext">SOAC GPU
</span><a href="#local-6989586621684417916"><span class="hs-identifier hs-var">soac</span></a></span><span>
</span><span id="line-211"></span><span>    </span><span class="annot"><a href="#local-6989586621684417919"><span class="hs-identifier hs-var">onOp</span></a></span><span> </span><span class="annot"><span class="annottext">(VarianceTable, Map VName SubExp, Scope GPU)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684417912"><span class="annot"><span class="annottext">HostOp GPU (SOAC GPU)
</span><a href="#local-6989586621684417912"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HostOp GPU (SOAC GPU) -&gt; f (HostOp GPU (SOAC GPU))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">HostOp GPU (SOAC GPU)
</span><a href="#local-6989586621684417912"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-212"></span><span>
</span><span id="line-213"></span><span>    </span><span id="local-6989586621684417920"><span class="annot"><span class="annottext">mapper :: (VarianceTable, Map VName SubExp, Scope GPU) -&gt; Mapper GPU GPU f
</span><a href="#local-6989586621684417920"><span class="hs-identifier hs-var hs-var">mapper</span></a></span></span><span> </span><span id="local-6989586621684417911"><span class="annot"><span class="annottext">(VarianceTable, Map VName SubExp, Scope GPU)
</span><a href="#local-6989586621684417911"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-214"></span><span>      </span><span class="annot"><span class="annottext">Mapper GPU GPU f
forall (m :: * -&gt; *) rep. Monad m =&gt; Mapper rep rep m
</span><a href="Futhark.IR.Traversals.html#identityMapper"><span class="hs-identifier hs-var">identityMapper</span></a></span><span>
</span><span id="line-215"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">mapOnBody :: Scope GPU -&gt; Body GPU -&gt; f (Body GPU)
</span><a href="Futhark.IR.Traversals.html#mapOnBody"><span class="hs-identifier hs-var">mapOnBody</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Body GPU -&gt; f (Body GPU)) -&gt; Scope GPU -&gt; Body GPU -&gt; f (Body GPU)
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(VarianceTable, Map VName SubExp, Scope GPU)
-&gt; Body GPU -&gt; f (Body GPU)
</span><a href="#local-6989586621684417967"><span class="hs-identifier hs-var">onBody</span></a></span><span> </span><span class="annot"><span class="annottext">(VarianceTable, Map VName SubExp, Scope GPU)
</span><a href="#local-6989586621684417911"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-216"></span><span>          </span><span class="annot"><span class="annottext">mapOnOp :: Op GPU -&gt; f (Op GPU)
</span><a href="#local-6989586621684417909"><span class="hs-identifier hs-var">mapOnOp</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VarianceTable, Map VName SubExp, Scope GPU)
-&gt; HostOp GPU (SOAC GPU) -&gt; f (HostOp GPU (SOAC GPU))
</span><a href="#local-6989586621684417919"><span class="hs-identifier hs-var">onOp</span></a></span><span> </span><span class="annot"><span class="annottext">(VarianceTable, Map VName SubExp, Scope GPU)
</span><a href="#local-6989586621684417911"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-217"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-218"></span><span>
</span><span id="line-219"></span><span>    </span><span id="local-6989586621684417976"><span class="annot"><span class="annottext">mkSizeSubsts :: Stms GPU -&gt; Map VName SubExp
</span><a href="#local-6989586621684417976"><span class="hs-identifier hs-var hs-var">mkSizeSubsts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Stm GPU -&gt; Map VName SubExp) -&gt; Stms GPU -&gt; Map VName SubExp
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">Stm GPU -&gt; Map VName SubExp
forall {rep} {rep} {op}.
(Op rep ~ HostOp rep op) =&gt;
Stm rep -&gt; Map VName SubExp
</span><a href="#local-6989586621684417902"><span class="hs-identifier hs-var">mkStmSizeSubst</span></a></span><span>
</span><span id="line-220"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-221"></span><span>        </span><span id="local-6989586621684417902"><span class="annot"><span class="annottext">mkStmSizeSubst :: Stm rep -&gt; Map VName SubExp
</span><a href="#local-6989586621684417902"><span class="hs-identifier hs-var hs-var">mkStmSizeSubst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621684417895"><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684417895"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SizeOp"><span class="hs-identifier hs-type">SizeOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SplitSpace"><span class="hs-identifier hs-type">SplitSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SplitOrdering
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684417892"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684417892"><span class="hs-identifier hs-var">elems_per_i</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-222"></span><span>          </span><span class="annot"><span class="annottext">VName -&gt; SubExp -&gt; Map VName SubExp
forall k a. k -&gt; a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.singleton</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT (LetDec rep) -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684417895"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684417892"><span class="hs-identifier hs-var">elems_per_i</span></a></span><span>
</span><span id="line-223"></span><span>        </span><span class="annot"><a href="#local-6989586621684417902"><span class="hs-identifier hs-var">mkStmSizeSubst</span></a></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map VName SubExp
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-224"></span><span>
</span><span id="line-225"></span><span class="hs-keyword">type</span><span> </span><span id="Replacements"><span class="annot"><a href="Futhark.Pass.KernelBabysitting.html#Replacements"><span class="hs-identifier hs-var">Replacements</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-type">Slice</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span>
</span><span id="line-226"></span><span>
</span><span id="line-227"></span><span id="local-6989586621684418510"><span class="annot"><a href="Futhark.Pass.KernelBabysitting.html#ensureCoalescedAccess"><span class="hs-identifier hs-type">ensureCoalescedAccess</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-228"></span><span>  </span><span class="annot"><a href="Futhark.Builder.Class.html#MonadBuilder"><span class="hs-identifier hs-type">MonadBuilder</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684418510"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-229"></span><span>  </span><span class="annot"><a href="Futhark.Pass.KernelBabysitting.html#ExpMap"><span class="hs-identifier hs-type">ExpMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-230"></span><span>  </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-231"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-232"></span><span>  </span><span class="annot"><a href="Futhark.Pass.KernelBabysitting.html#ArrayIndexTransform"><span class="hs-identifier hs-type">ArrayIndexTransform</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="Futhark.Pass.KernelBabysitting.html#Replacements"><span class="hs-identifier hs-type">Replacements</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684418510"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-233"></span><span id="ensureCoalescedAccess"><span class="annot"><span class="annottext">ensureCoalescedAccess :: forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Map VName (Stm GPU)
-&gt; [(VName, SubExp)]
-&gt; SubExp
-&gt; ArrayIndexTransform (StateT Replacements m)
</span><a href="Futhark.Pass.KernelBabysitting.html#ensureCoalescedAccess"><span class="hs-identifier hs-var hs-var">ensureCoalescedAccess</span></a></span></span><span>
</span><span id="line-234"></span><span>  </span><span id="local-6989586621684417788"><span class="annot"><span class="annottext">Map VName (Stm GPU)
</span><a href="#local-6989586621684417788"><span class="hs-identifier hs-var">expmap</span></a></span></span><span>
</span><span id="line-235"></span><span>  </span><span id="local-6989586621684417787"><span class="annot"><span class="annottext">[(VName, SubExp)]
</span><a href="#local-6989586621684417787"><span class="hs-identifier hs-var">thread_space</span></a></span></span><span>
</span><span id="line-236"></span><span>  </span><span id="local-6989586621684417786"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684417786"><span class="hs-identifier hs-var">num_threads</span></a></span></span><span>
</span><span id="line-237"></span><span>  </span><span id="local-6989586621684417785"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684417785"><span class="hs-identifier hs-var">free_ker_vars</span></a></span></span><span>
</span><span id="line-238"></span><span>  </span><span id="local-6989586621684417784"><span class="annot"><span class="annottext">VName -&gt; Bool
</span><a href="#local-6989586621684417784"><span class="hs-identifier hs-var">isThreadLocal</span></a></span></span><span>
</span><span id="line-239"></span><span>  </span><span id="local-6989586621684417783"><span class="annot"><span class="annottext">VName -&gt; SubExp -&gt; Bool
</span><a href="#local-6989586621684417783"><span class="hs-identifier hs-var">isGidVariant</span></a></span></span><span>
</span><span id="line-240"></span><span>  </span><span id="local-6989586621684417782"><span class="annot"><span class="annottext">SubExp -&gt; Maybe SubExp
</span><a href="#local-6989586621684417782"><span class="hs-identifier hs-var">sizeSubst</span></a></span></span><span>
</span><span id="line-241"></span><span>  </span><span id="local-6989586621684417781"><span class="annot"><span class="annottext">Scope GPU
</span><a href="#local-6989586621684417781"><span class="hs-identifier hs-var">outer_scope</span></a></span></span><span>
</span><span id="line-242"></span><span>  </span><span id="local-6989586621684417780"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417780"><span class="hs-identifier hs-var">arr</span></a></span></span><span>
</span><span id="line-243"></span><span>  </span><span id="local-6989586621684417779"><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684417779"><span class="hs-identifier hs-var">slice</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-244"></span><span>    </span><span id="local-6989586621684417778"><span class="annot"><span class="annottext">Maybe VName
</span><a href="#local-6989586621684417778"><span class="hs-identifier hs-var">seen</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Replacements -&gt; Maybe VName)
-&gt; StateT Replacements m (Maybe VName)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">((Replacements -&gt; Maybe VName)
 -&gt; StateT Replacements m (Maybe VName))
-&gt; (Replacements -&gt; Maybe VName)
-&gt; StateT Replacements m (Maybe VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(VName, Slice SubExp) -&gt; Replacements -&gt; Maybe VName
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417780"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684417779"><span class="hs-identifier hs-var">slice</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-245"></span><span>
</span><span id="line-246"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe VName
</span><a href="#local-6989586621684417778"><span class="hs-identifier hs-var">seen</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Bool
</span><a href="#local-6989586621684417784"><span class="hs-identifier hs-var">isThreadLocal</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417780"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">NameInfo GPU -&gt; Type
forall t. Typed t =&gt; t -&gt; Type
</span><a href="Futhark.IR.Prop.Types.html#typeOf"><span class="hs-identifier hs-var">typeOf</span></a></span><span> </span><span class="annot"><span class="annottext">(NameInfo GPU -&gt; Type) -&gt; Maybe (NameInfo GPU) -&gt; Maybe Type
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Scope GPU -&gt; Maybe (NameInfo GPU)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417780"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">Scope GPU
</span><a href="#local-6989586621684417781"><span class="hs-identifier hs-var">outer_scope</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-247"></span><span>      </span><span class="hs-comment">-- Already took care of this case elsewhere.</span><span>
</span><span id="line-248"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684417775"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417775"><span class="hs-identifier hs-var">arr'</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-249"></span><span>        </span><span class="annot"><span class="annottext">Maybe (VName, Slice SubExp)
-&gt; StateT Replacements m (Maybe (VName, Slice SubExp))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (VName, Slice SubExp)
 -&gt; StateT Replacements m (Maybe (VName, Slice SubExp)))
-&gt; Maybe (VName, Slice SubExp)
-&gt; StateT Replacements m (Maybe (VName, Slice SubExp))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(VName, Slice SubExp) -&gt; Maybe (VName, Slice SubExp)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417775"><span class="hs-identifier hs-var">arr'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684417779"><span class="hs-identifier hs-var">slice</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-250"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe VName
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684417774"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684417774"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-251"></span><span>        </span><span class="hs-comment">-- We are fully indexing the array with thread IDs, but the</span><span>
</span><span id="line-252"></span><span>        </span><span class="hs-comment">-- indices are in a permuted order.</span><span>
</span><span id="line-253"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684417773"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684417773"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Slice SubExp -&gt; Maybe [SubExp]
forall d. Slice d -&gt; Maybe [d]
</span><a href="Futhark.IR.Syntax.Core.html#sliceIndices"><span class="hs-identifier hs-var">sliceIndices</span></a></span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684417779"><span class="hs-identifier hs-var">slice</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-254"></span><span>          </span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684417773"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Int
forall shape u. ArrayShape shape =&gt; TypeBase shape u -&gt; Int
</span><a href="Futhark.IR.Prop.Types.html#arrayRank"><span class="hs-identifier hs-var">arrayRank</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684417774"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-255"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684417770"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684417770"><span class="hs-identifier hs-var">is'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Names
-&gt; (VName -&gt; SubExp -&gt; Bool)
-&gt; [SubExp]
-&gt; [SubExp]
-&gt; Maybe [SubExp]
</span><a href="Futhark.Pass.KernelBabysitting.html#coalescedIndexes"><span class="hs-identifier hs-var">coalescedIndexes</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684417785"><span class="hs-identifier hs-var">free_ker_vars</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp -&gt; Bool
</span><a href="#local-6989586621684417783"><span class="hs-identifier hs-var">isGidVariant</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(VName -&gt; SubExp) -&gt; [VName] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684417768"><span class="hs-identifier hs-var">thread_gids</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684417773"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-256"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684417767"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684417767"><span class="hs-identifier hs-var">perm</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684417770"><span class="hs-identifier hs-var">is'</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; [SubExp] -&gt; Maybe [Int]
forall a. Eq a =&gt; [a] -&gt; [a] -&gt; Maybe [Int]
</span><a href="Futhark.IR.Prop.Rearrange.html#isPermutationOf"><span class="hs-operator hs-var">`isPermutationOf`</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684417773"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-257"></span><span>          </span><span class="annot"><span class="annottext">VName -&gt; StateT Replacements m (Maybe (VName, Slice SubExp))
</span><a href="#local-6989586621684417765"><span class="hs-identifier hs-var">replace</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; StateT Replacements m (Maybe (VName, Slice SubExp)))
-&gt; StateT Replacements m VName
-&gt; StateT Replacements m (Maybe (VName, Slice SubExp))
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">m VName -&gt; StateT Replacements m VName
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (Maybe [Int]) -&gt; [Int] -&gt; VName -&gt; m VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Maybe (Maybe [Int]) -&gt; [Int] -&gt; VName -&gt; m VName
</span><a href="Futhark.Pass.KernelBabysitting.html#rearrangeInput"><span class="hs-identifier hs-var">rearrangeInput</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Map VName (Stm GPU) -&gt; Maybe (Maybe [Int])
</span><a href="Futhark.Pass.KernelBabysitting.html#nonlinearInMemory"><span class="hs-identifier hs-var">nonlinearInMemory</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417780"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName (Stm GPU)
</span><a href="#local-6989586621684417788"><span class="hs-identifier hs-var">expmap</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684417767"><span class="hs-identifier hs-var">perm</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417780"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-258"></span><span>        </span><span class="hs-comment">-- Check whether the access is already coalesced because of a</span><span>
</span><span id="line-259"></span><span>        </span><span class="hs-comment">-- previous rearrange being applied to the current array:</span><span>
</span><span id="line-260"></span><span>        </span><span class="hs-comment">-- 1. get the permutation of the source-array rearrange</span><span>
</span><span id="line-261"></span><span>        </span><span class="hs-comment">-- 2. apply it to the slice</span><span>
</span><span id="line-262"></span><span>        </span><span class="hs-comment">-- 3. check that the innermost index is actually the gid</span><span>
</span><span id="line-263"></span><span>        </span><span class="hs-comment">--    of the innermost kernel dimension.</span><span>
</span><span id="line-264"></span><span>        </span><span class="hs-comment">-- If so, the access is already coalesced, nothing to do!</span><span>
</span><span id="line-265"></span><span>        </span><span class="hs-comment">-- (Cosmin's Heuristic.)</span><span>
</span><span id="line-266"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPU
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec GPU)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Rearrange"><span class="hs-identifier hs-type">Rearrange</span></a></span><span> </span><span id="local-6989586621684417762"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684417762"><span class="hs-identifier hs-var">perm</span></a></span></span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Map VName (Stm GPU) -&gt; Maybe (Stm GPU)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417780"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName (Stm GPU)
</span><a href="#local-6989586621684417788"><span class="hs-identifier hs-var">expmap</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-267"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684417762"><span class="hs-identifier hs-var">perm</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-268"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684417768"><span class="hs-identifier hs-var">thread_gids</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-269"></span><span>          </span><span id="local-6989586621684417759"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417759"><span class="hs-identifier hs-var">inner_gid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; VName
forall a. [a] -&gt; a
</span><span class="hs-identifier hs-var">last</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684417768"><span class="hs-identifier hs-var">thread_gids</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-270"></span><span>          </span><span class="annot"><span class="annottext">Slice SubExp -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684417779"><span class="hs-identifier hs-var">slice</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684417762"><span class="hs-identifier hs-var">perm</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-271"></span><span>          </span><span id="local-6989586621684417757"><span class="annot"><span class="annottext">[DimIndex SubExp]
</span><a href="#local-6989586621684417757"><span class="hs-identifier hs-var">slice'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Int -&gt; DimIndex SubExp) -&gt; [Int] -&gt; [DimIndex SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Slice SubExp -&gt; [DimIndex SubExp]
forall d. Slice d -&gt; [DimIndex d]
</span><a href="Futhark.IR.Syntax.Core.html#unSlice"><span class="hs-identifier hs-var hs-var">unSlice</span></a></span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684417779"><span class="hs-identifier hs-var">slice</span></a></span><span> </span><span class="annot"><span class="annottext">[DimIndex SubExp] -&gt; Int -&gt; DimIndex SubExp
forall a. [a] -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">!!</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684417762"><span class="hs-identifier hs-var">perm</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-272"></span><span>          </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-type">DimFix</span></a></span><span> </span><span id="local-6989586621684417753"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684417753"><span class="hs-identifier hs-var">inner_ind</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[DimIndex SubExp] -&gt; DimIndex SubExp
forall a. [a] -&gt; a
</span><span class="hs-identifier hs-var">last</span></span><span> </span><span class="annot"><span class="annottext">[DimIndex SubExp]
</span><a href="#local-6989586621684417757"><span class="hs-identifier hs-var">slice'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-273"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684417768"><span class="hs-identifier hs-var">thread_gids</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-274"></span><span>          </span><span class="annot"><span class="annottext">VName -&gt; SubExp -&gt; Bool
</span><a href="#local-6989586621684417783"><span class="hs-identifier hs-var">isGidVariant</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417759"><span class="hs-identifier hs-var">inner_gid</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684417753"><span class="hs-identifier hs-var">inner_ind</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-275"></span><span>          </span><span class="annot"><span class="annottext">Maybe (VName, Slice SubExp)
-&gt; StateT Replacements m (Maybe (VName, Slice SubExp))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe (VName, Slice SubExp)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-276"></span><span>        </span><span class="hs-comment">-- We are not fully indexing an array, but the remaining slice</span><span>
</span><span id="line-277"></span><span>        </span><span class="hs-comment">-- is invariant to the innermost-kernel dimension. We assume</span><span>
</span><span id="line-278"></span><span>        </span><span class="hs-comment">-- the remaining slice will be sequentially streamed, hence</span><span>
</span><span id="line-279"></span><span>        </span><span class="hs-comment">-- tiling will be applied later and will solve coalescing.</span><span>
</span><span id="line-280"></span><span>        </span><span class="hs-comment">-- Hence nothing to do at this point. (Cosmin's Heuristic.)</span><span>
</span><span id="line-281"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684417752"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684417752"><span class="hs-identifier hs-var">is</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684417751"><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684417751"><span class="hs-identifier hs-var">rem_slice</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Slice SubExp -&gt; ([SubExp], Slice SubExp)
</span><a href="Futhark.Pass.KernelBabysitting.html#splitSlice"><span class="hs-identifier hs-var">splitSlice</span></a></span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684417779"><span class="hs-identifier hs-var">slice</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-282"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Slice SubExp -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684417751"><span class="hs-identifier hs-var">rem_slice</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-283"></span><span>          </span><span class="annot"><span class="annottext">Slice SubExp -&gt; Bool
</span><a href="Futhark.Pass.KernelBabysitting.html#allDimAreSlice"><span class="hs-identifier hs-var">allDimAreSlice</span></a></span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684417751"><span class="hs-identifier hs-var">rem_slice</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-284"></span><span>          </span><span class="annot"><span class="annottext">Maybe (Stm GPU)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Map VName (Stm GPU) -&gt; Maybe (Stm GPU)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417780"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName (Stm GPU)
</span><a href="#local-6989586621684417788"><span class="hs-identifier hs-var">expmap</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-285"></span><span>          </span><span id="local-6989586621684417748"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684417748"><span class="hs-identifier hs-var">pt</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; PrimType
forall shape u. TypeBase shape u -&gt; PrimType
</span><a href="Futhark.IR.Prop.Types.html#elemType"><span class="hs-identifier hs-var">elemType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684417774"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-286"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int32 -&gt; Slice SubExp -&gt; Bool
</span><a href="Futhark.Pass.KernelBabysitting.html#tooSmallSlice"><span class="hs-identifier hs-var">tooSmallSlice</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimType -&gt; Int32
forall a. Num a =&gt; PrimType -&gt; a
</span><a href="Futhark.IR.Primitive.html#primByteSize"><span class="hs-identifier hs-var">primByteSize</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684417748"><span class="hs-identifier hs-var">pt</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684417751"><span class="hs-identifier hs-var">rem_slice</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-287"></span><span>          </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684417752"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; [SubExp] -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SubExp) -&gt; [VName] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; [VName] -&gt; [VName]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">take</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684417752"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684417768"><span class="hs-identifier hs-var">thread_gids</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684417752"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684417768"><span class="hs-identifier hs-var">thread_gids</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-288"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684417768"><span class="hs-identifier hs-var">thread_gids</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684417752"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-289"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; VName
forall a. [a] -&gt; a
</span><span class="hs-identifier hs-var">last</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684417768"><span class="hs-identifier hs-var">thread_gids</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#nameIn"><span class="hs-operator hs-var">`nameIn`</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Names
forall a. FreeIn a =&gt; a -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#freeIn"><span class="hs-identifier hs-var">freeIn</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684417752"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Slice SubExp -&gt; Names
forall a. FreeIn a =&gt; a -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#freeIn"><span class="hs-identifier hs-var">freeIn</span></a></span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684417751"><span class="hs-identifier hs-var">rem_slice</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-290"></span><span>          </span><span class="annot"><span class="annottext">Maybe (VName, Slice SubExp)
-&gt; StateT Replacements m (Maybe (VName, Slice SubExp))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe (VName, Slice SubExp)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-291"></span><span>        </span><span class="hs-comment">-- We are not fully indexing the array, and the indices are not</span><span>
</span><span id="line-292"></span><span>        </span><span class="hs-comment">-- a proper prefix of the thread indices, and some indices are</span><span>
</span><span id="line-293"></span><span>        </span><span class="hs-comment">-- thread local, so we assume (HEURISTIC!)  that the remaining</span><span>
</span><span id="line-294"></span><span>        </span><span class="hs-comment">-- dimensions will be traversed sequentially.</span><span>
</span><span id="line-295"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684417742"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684417742"><span class="hs-identifier hs-var">is</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684417741"><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684417741"><span class="hs-identifier hs-var">rem_slice</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Slice SubExp -&gt; ([SubExp], Slice SubExp)
</span><a href="Futhark.Pass.KernelBabysitting.html#splitSlice"><span class="hs-identifier hs-var">splitSlice</span></a></span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684417779"><span class="hs-identifier hs-var">slice</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-296"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Slice SubExp -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684417741"><span class="hs-identifier hs-var">rem_slice</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-297"></span><span>          </span><span id="local-6989586621684417740"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684417740"><span class="hs-identifier hs-var">pt</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; PrimType
forall shape u. TypeBase shape u -&gt; PrimType
</span><a href="Futhark.IR.Prop.Types.html#elemType"><span class="hs-identifier hs-var">elemType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684417774"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-298"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int32 -&gt; Slice SubExp -&gt; Bool
</span><a href="Futhark.Pass.KernelBabysitting.html#tooSmallSlice"><span class="hs-identifier hs-var">tooSmallSlice</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimType -&gt; Int32
forall a. Num a =&gt; PrimType -&gt; a
</span><a href="Futhark.IR.Primitive.html#primByteSize"><span class="hs-identifier hs-var">primByteSize</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684417740"><span class="hs-identifier hs-var">pt</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684417741"><span class="hs-identifier hs-var">rem_slice</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-299"></span><span>          </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684417742"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; [SubExp] -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SubExp) -&gt; [VName] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; [VName] -&gt; [VName]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">take</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684417742"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684417768"><span class="hs-identifier hs-var">thread_gids</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684417742"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684417768"><span class="hs-identifier hs-var">thread_gids</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-300"></span><span>          </span><span class="annot"><span class="annottext">(VName -&gt; Bool) -&gt; [VName] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Bool
</span><a href="#local-6989586621684417784"><span class="hs-identifier hs-var">isThreadLocal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Names -&gt; [VName]
</span><a href="Futhark.IR.Prop.Names.html#namesToList"><span class="hs-identifier hs-var">namesToList</span></a></span><span> </span><span class="annot"><span class="annottext">(Names -&gt; [VName]) -&gt; Names -&gt; [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; Names
forall a. FreeIn a =&gt; a -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#freeIn"><span class="hs-identifier hs-var">freeIn</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684417742"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-301"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684417737"><span class="annot"><span class="annottext">perm :: [Int]
</span><a href="#local-6989586621684417737"><span class="hs-identifier hs-var hs-var">perm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; [Int]
</span><a href="Futhark.Pass.KernelBabysitting.html#coalescingPermutation"><span class="hs-identifier hs-var">coalescingPermutation</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684417742"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Int -&gt; [Int]) -&gt; Int -&gt; [Int]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Int
forall shape u. ArrayShape shape =&gt; TypeBase shape u -&gt; Int
</span><a href="Futhark.IR.Prop.Types.html#arrayRank"><span class="hs-identifier hs-var">arrayRank</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684417774"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-302"></span><span>          </span><span class="annot"><span class="annottext">VName -&gt; StateT Replacements m (Maybe (VName, Slice SubExp))
</span><a href="#local-6989586621684417765"><span class="hs-identifier hs-var">replace</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; StateT Replacements m (Maybe (VName, Slice SubExp)))
-&gt; StateT Replacements m VName
-&gt; StateT Replacements m (Maybe (VName, Slice SubExp))
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">m VName -&gt; StateT Replacements m VName
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (Maybe [Int]) -&gt; [Int] -&gt; VName -&gt; m VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Maybe (Maybe [Int]) -&gt; [Int] -&gt; VName -&gt; m VName
</span><a href="Futhark.Pass.KernelBabysitting.html#rearrangeInput"><span class="hs-identifier hs-var">rearrangeInput</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Map VName (Stm GPU) -&gt; Maybe (Maybe [Int])
</span><a href="Futhark.Pass.KernelBabysitting.html#nonlinearInMemory"><span class="hs-identifier hs-var">nonlinearInMemory</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417780"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName (Stm GPU)
</span><a href="#local-6989586621684417788"><span class="hs-identifier hs-var">expmap</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684417737"><span class="hs-identifier hs-var">perm</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417780"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-303"></span><span>
</span><span id="line-304"></span><span>        </span><span class="hs-comment">-- We are taking a slice of the array with a unit stride.  We</span><span>
</span><span id="line-305"></span><span>        </span><span class="hs-comment">-- assume that the slice will be traversed sequentially.</span><span>
</span><span id="line-306"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-307"></span><span>        </span><span class="hs-comment">-- We will really want to treat the sliced dimension like two</span><span>
</span><span id="line-308"></span><span>        </span><span class="hs-comment">-- dimensions so we can transpose them.  This may require</span><span>
</span><span id="line-309"></span><span>        </span><span class="hs-comment">-- padding.</span><span>
</span><span id="line-310"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684417735"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684417735"><span class="hs-identifier hs-var">is</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684417734"><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684417734"><span class="hs-identifier hs-var">rem_slice</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Slice SubExp -&gt; ([SubExp], Slice SubExp)
</span><a href="Futhark.Pass.KernelBabysitting.html#splitSlice"><span class="hs-identifier hs-var">splitSlice</span></a></span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684417779"><span class="hs-identifier hs-var">slice</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-311"></span><span>          </span><span class="annot"><span class="annottext">[Bool] -&gt; Bool
forall (t :: * -&gt; *). Foldable t =&gt; t Bool -&gt; Bool
</span><span class="hs-identifier hs-var">and</span></span><span> </span><span class="annot"><span class="annottext">([Bool] -&gt; Bool) -&gt; [Bool] -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; SubExp -&gt; Bool) -&gt; [SubExp] -&gt; [SubExp] -&gt; [Bool]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; SubExp -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">(==)</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684417735"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [Bool]) -&gt; [SubExp] -&gt; [Bool]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SubExp) -&gt; [VName] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684417768"><span class="hs-identifier hs-var">thread_gids</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-312"></span><span>          </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#DimSlice"><span class="hs-identifier hs-type">DimSlice</span></a></span><span> </span><span id="local-6989586621684417730"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684417730"><span class="hs-identifier hs-var">offset</span></a></span></span><span> </span><span id="local-6989586621684417729"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684417729"><span class="hs-identifier hs-var">len</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span> </span><span id="local-6989586621684417728"><span class="annot"><span class="annottext">PrimValue
</span><a href="#local-6989586621684417728"><span class="hs-identifier hs-var">stride</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><span class="annottext">[DimIndex SubExp]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Slice SubExp -&gt; [DimIndex SubExp]
forall d. Slice d -&gt; [DimIndex d]
</span><a href="Futhark.IR.Syntax.Core.html#unSlice"><span class="hs-identifier hs-var hs-var">unSlice</span></a></span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684417734"><span class="hs-identifier hs-var">rem_slice</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-313"></span><span>          </span><span class="annot"><span class="annottext">SubExp -&gt; Bool
</span><a href="#local-6989586621684417727"><span class="hs-identifier hs-var">isThreadLocalSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684417730"><span class="hs-identifier hs-var">offset</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-314"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Maybe SubExp
</span><a href="#local-6989586621684417782"><span class="hs-identifier hs-var">sizeSubst</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684417729"><span class="hs-identifier hs-var">len</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-315"></span><span>          </span><span class="annot"><span class="annottext">PrimValue -&gt; Bool
</span><a href="Futhark.IR.Primitive.html#oneIsh"><span class="hs-identifier hs-var">oneIsh</span></a></span><span> </span><span class="annot"><span class="annottext">PrimValue
</span><a href="#local-6989586621684417728"><span class="hs-identifier hs-var">stride</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-316"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684417725"><span class="annot"><span class="annottext">num_chunks :: PrimExp VName
</span><a href="#local-6989586621684417725"><span class="hs-identifier hs-var hs-var">num_chunks</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-317"></span><span>                </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684417735"><span class="hs-identifier hs-var">is</span></a></span><span>
</span><span id="line-318"></span><span>                  </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">TPrimExp Int32 VName -&gt; PrimExp VName
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int32 VName -&gt; PrimExp VName)
-&gt; TPrimExp Int32 VName -&gt; PrimExp VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TPrimExp Int32 VName
</span><a href="Futhark.Analysis.PrimExp.Convert.html#pe32"><span class="hs-identifier hs-var">pe32</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684417786"><span class="hs-identifier hs-var">num_threads</span></a></span><span>
</span><span id="line-319"></span><span>                  </span><span class="hs-keyword">else</span><span>
</span><span id="line-320"></span><span>                    </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; PrimExp VName
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName -&gt; PrimExp VName)
-&gt; TPrimExp Int64 VName -&gt; PrimExp VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-321"></span><span>                      </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName] -&gt; TPrimExp Int64 VName
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">product</span></span><span> </span><span class="annot"><span class="annottext">([TPrimExp Int64 VName] -&gt; TPrimExp Int64 VName)
-&gt; [TPrimExp Int64 VName] -&gt; TPrimExp Int64 VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-322"></span><span>                        </span><span class="annot"><span class="annottext">(SubExp -&gt; TPrimExp Int64 VName)
-&gt; [SubExp] -&gt; [TPrimExp Int64 VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TPrimExp Int64 VName
</span><a href="Futhark.Analysis.PrimExp.Convert.html#pe64"><span class="hs-identifier hs-var">pe64</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [TPrimExp Int64 VName])
-&gt; [SubExp] -&gt; [TPrimExp Int64 VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-323"></span><span>                          </span><span class="annot"><span class="annottext">Int -&gt; [SubExp] -&gt; [SubExp]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684417735"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684417719"><span class="hs-identifier hs-var">thread_gdims</span></a></span><span>
</span><span id="line-324"></span><span>          </span><span class="annot"><span class="annottext">VName -&gt; StateT Replacements m (Maybe (VName, Slice SubExp))
</span><a href="#local-6989586621684417765"><span class="hs-identifier hs-var">replace</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; StateT Replacements m (Maybe (VName, Slice SubExp)))
-&gt; StateT Replacements m VName
-&gt; StateT Replacements m (Maybe (VName, Slice SubExp))
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">m VName -&gt; StateT Replacements m VName
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; SubExp -&gt; PrimExp VName -&gt; VName -&gt; m VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Int -&gt; SubExp -&gt; PrimExp VName -&gt; VName -&gt; m VName
</span><a href="Futhark.Pass.KernelBabysitting.html#rearrangeSlice"><span class="hs-identifier hs-var">rearrangeSlice</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684417735"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Type -&gt; SubExp
forall u. Int -&gt; TypeBase Shape u -&gt; SubExp
</span><a href="Futhark.IR.Prop.Types.html#arraySize"><span class="hs-identifier hs-var">arraySize</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684417735"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684417774"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684417725"><span class="hs-identifier hs-var">num_chunks</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417780"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-325"></span><span>
</span><span id="line-326"></span><span>        </span><span class="hs-comment">-- Everything is fine... assuming that the array is in row-major</span><span>
</span><span id="line-327"></span><span>        </span><span class="hs-comment">-- order!  Make sure that is the case.</span><span>
</span><span id="line-328"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Map VName (Stm GPU) -&gt; Maybe (Maybe [Int])
</span><a href="Futhark.Pass.KernelBabysitting.html#nonlinearInMemory"><span class="hs-identifier hs-var">nonlinearInMemory</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417780"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName (Stm GPU)
</span><a href="#local-6989586621684417788"><span class="hs-identifier hs-var">expmap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-329"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Slice SubExp -&gt; Maybe [SubExp]
forall d. Slice d -&gt; Maybe [d]
</span><a href="Futhark.IR.Syntax.Core.html#sliceIndices"><span class="hs-identifier hs-var">sliceIndices</span></a></span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684417779"><span class="hs-identifier hs-var">slice</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-330"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684417716"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684417716"><span class="hs-identifier hs-var">is</span></a></span></span><span>
</span><span id="line-331"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Names
-&gt; (VName -&gt; SubExp -&gt; Bool)
-&gt; [SubExp]
-&gt; [SubExp]
-&gt; Maybe [SubExp]
</span><a href="Futhark.Pass.KernelBabysitting.html#coalescedIndexes"><span class="hs-identifier hs-var">coalescedIndexes</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684417785"><span class="hs-identifier hs-var">free_ker_vars</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp -&gt; Bool
</span><a href="#local-6989586621684417783"><span class="hs-identifier hs-var">isGidVariant</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(VName -&gt; SubExp) -&gt; [VName] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684417768"><span class="hs-identifier hs-var">thread_gids</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684417716"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-332"></span><span>                </span><span class="annot"><span class="annottext">VName -&gt; StateT Replacements m (Maybe (VName, Slice SubExp))
</span><a href="#local-6989586621684417765"><span class="hs-identifier hs-var">replace</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; StateT Replacements m (Maybe (VName, Slice SubExp)))
-&gt; StateT Replacements m VName
-&gt; StateT Replacements m (Maybe (VName, Slice SubExp))
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">m VName -&gt; StateT Replacements m VName
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; m VName
forall (m :: * -&gt; *). MonadBuilder m =&gt; VName -&gt; m VName
</span><a href="Futhark.Pass.KernelBabysitting.html#rowMajorArray"><span class="hs-identifier hs-var">rowMajorArray</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417780"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-333"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-334"></span><span>                </span><span class="annot"><span class="annottext">Maybe (VName, Slice SubExp)
-&gt; StateT Replacements m (Maybe (VName, Slice SubExp))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe (VName, Slice SubExp)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-335"></span><span>            </span><span class="annot"><span class="annottext">Maybe [SubExp]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">VName -&gt; StateT Replacements m (Maybe (VName, Slice SubExp))
</span><a href="#local-6989586621684417765"><span class="hs-identifier hs-var">replace</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; StateT Replacements m (Maybe (VName, Slice SubExp)))
-&gt; StateT Replacements m VName
-&gt; StateT Replacements m (Maybe (VName, Slice SubExp))
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">m VName -&gt; StateT Replacements m VName
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; m VName
forall (m :: * -&gt; *). MonadBuilder m =&gt; VName -&gt; m VName
</span><a href="Futhark.Pass.KernelBabysitting.html#rowMajorArray"><span class="hs-identifier hs-var">rowMajorArray</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417780"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-336"></span><span>      </span><span class="annot"><span class="annottext">(Maybe VName, Bool, Maybe Type)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (VName, Slice SubExp)
-&gt; StateT Replacements m (Maybe (VName, Slice SubExp))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe (VName, Slice SubExp)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-337"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-338"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684417768"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684417768"><span class="hs-identifier hs-var">thread_gids</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684417719"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684417719"><span class="hs-identifier hs-var">thread_gdims</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VName, SubExp)] -&gt; ([VName], [SubExp])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">[(VName, SubExp)]
</span><a href="#local-6989586621684417787"><span class="hs-identifier hs-var">thread_space</span></a></span><span>
</span><span id="line-339"></span><span>
</span><span id="line-340"></span><span>      </span><span id="local-6989586621684417765"><span class="annot"><span class="annottext">replace :: VName -&gt; StateT Replacements m (Maybe (VName, Slice SubExp))
</span><a href="#local-6989586621684417765"><span class="hs-identifier hs-var hs-var">replace</span></a></span></span><span> </span><span id="local-6989586621684417713"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417713"><span class="hs-identifier hs-var">arr'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-341"></span><span>        </span><span class="annot"><span class="annottext">(Replacements -&gt; Replacements) -&gt; StateT Replacements m ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((Replacements -&gt; Replacements) -&gt; StateT Replacements m ())
-&gt; (Replacements -&gt; Replacements) -&gt; StateT Replacements m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(VName, Slice SubExp) -&gt; VName -&gt; Replacements -&gt; Replacements
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417780"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684417779"><span class="hs-identifier hs-var">slice</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417713"><span class="hs-identifier hs-var">arr'</span></a></span><span>
</span><span id="line-342"></span><span>        </span><span class="annot"><span class="annottext">Maybe (VName, Slice SubExp)
-&gt; StateT Replacements m (Maybe (VName, Slice SubExp))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (VName, Slice SubExp)
 -&gt; StateT Replacements m (Maybe (VName, Slice SubExp)))
-&gt; Maybe (VName, Slice SubExp)
-&gt; StateT Replacements m (Maybe (VName, Slice SubExp))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(VName, Slice SubExp) -&gt; Maybe (VName, Slice SubExp)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417713"><span class="hs-identifier hs-var">arr'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684417779"><span class="hs-identifier hs-var">slice</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-343"></span><span>
</span><span id="line-344"></span><span>      </span><span id="local-6989586621684417727"><span class="annot"><span class="annottext">isThreadLocalSubExp :: SubExp -&gt; Bool
</span><a href="#local-6989586621684417727"><span class="hs-identifier hs-var hs-var">isThreadLocalSubExp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684417710"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417710"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Bool
</span><a href="#local-6989586621684417784"><span class="hs-identifier hs-var">isThreadLocal</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417710"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-345"></span><span>      </span><span class="annot"><a href="#local-6989586621684417727"><span class="hs-identifier hs-var">isThreadLocalSubExp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-346"></span><span>
</span><span id="line-347"></span><span class="hs-comment">-- Heuristic for avoiding rearranging too small arrays.</span><span>
</span><span id="line-348"></span><span class="annot"><a href="Futhark.Pass.KernelBabysitting.html#tooSmallSlice"><span class="hs-identifier hs-type">tooSmallSlice</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-type">Slice</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-349"></span><span id="tooSmallSlice"><span class="annot"><span class="annottext">tooSmallSlice :: Int32 -&gt; Slice SubExp -&gt; Bool
</span><a href="Futhark.Pass.KernelBabysitting.html#tooSmallSlice"><span class="hs-identifier hs-var hs-var">tooSmallSlice</span></a></span></span><span> </span><span id="local-6989586621684417709"><span class="annot"><span class="annottext">Int32
</span><a href="#local-6989586621684417709"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Bool, Int32) -&gt; Bool
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">((Bool, Int32) -&gt; Bool)
-&gt; (Slice SubExp -&gt; (Bool, Int32)) -&gt; Slice SubExp -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">((Bool, Int32) -&gt; SubExp -&gt; (Bool, Int32))
-&gt; (Bool, Int32) -&gt; [SubExp] -&gt; (Bool, Int32)
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl</span></span><span> </span><span class="annot"><span class="annottext">(Bool, Int32) -&gt; SubExp -&gt; (Bool, Int32)
</span><a href="#local-6989586621684417707"><span class="hs-identifier hs-var">comb</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int32
</span><a href="#local-6989586621684417709"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; (Bool, Int32))
-&gt; (Slice SubExp -&gt; [SubExp]) -&gt; Slice SubExp -&gt; (Bool, Int32)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Slice SubExp -&gt; [SubExp]
forall d. Slice d -&gt; [d]
</span><a href="Futhark.IR.Syntax.Core.html#sliceDims"><span class="hs-identifier hs-var">sliceDims</span></a></span><span>
</span><span id="line-350"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-351"></span><span>    </span><span id="local-6989586621684417707"><span class="annot"><span class="annottext">comb :: (Bool, Int32) -&gt; SubExp -&gt; (Bool, Int32)
</span><a href="#local-6989586621684417707"><span class="hs-identifier hs-var hs-var">comb</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684417700"><span class="annot"><span class="annottext">Int32
</span><a href="#local-6989586621684417700"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Primitive.html#IntValue"><span class="hs-identifier hs-type">IntValue</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Primitive.html#Int32Value"><span class="hs-identifier hs-type">Int32Value</span></a></span><span> </span><span id="local-6989586621684417697"><span class="annot"><span class="annottext">Int32
</span><a href="#local-6989586621684417697"><span class="hs-identifier hs-var">d</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int32
</span><a href="#local-6989586621684417697"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">Int32 -&gt; Int32 -&gt; Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Int32
</span><a href="#local-6989586621684417700"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">Int32 -&gt; Int32 -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Int32
</span><span class="hs-number">4</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int32
</span><a href="#local-6989586621684417697"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">Int32 -&gt; Int32 -&gt; Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Int32
</span><a href="#local-6989586621684417700"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-352"></span><span>    </span><span class="annot"><a href="#local-6989586621684417707"><span class="hs-identifier hs-var">comb</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684417694"><span class="annot"><span class="annottext">Int32
</span><a href="#local-6989586621684417694"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int32
</span><a href="#local-6989586621684417694"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-353"></span><span>
</span><span id="line-354"></span><span class="annot"><a href="Futhark.Pass.KernelBabysitting.html#splitSlice"><span class="hs-identifier hs-type">splitSlice</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-type">Slice</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-type">Slice</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-355"></span><span id="splitSlice"><span class="annot"><span class="annottext">splitSlice :: Slice SubExp -&gt; ([SubExp], Slice SubExp)
</span><a href="Futhark.Pass.KernelBabysitting.html#splitSlice"><span class="hs-identifier hs-var hs-var">splitSlice</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-type">Slice</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[DimIndex SubExp] -&gt; Slice SubExp
forall d. [DimIndex d] -&gt; Slice d
</span><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-var">Slice</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-356"></span><span class="annot"><a href="Futhark.Pass.KernelBabysitting.html#splitSlice"><span class="hs-identifier hs-var">splitSlice</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-type">Slice</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-type">DimFix</span></a></span><span> </span><span id="local-6989586621684417692"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684417692"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684417691"><span class="annot"><span class="annottext">[DimIndex SubExp]
</span><a href="#local-6989586621684417691"><span class="hs-identifier hs-var">is</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [SubExp])
-&gt; ([SubExp], Slice SubExp) -&gt; ([SubExp], Slice SubExp)
forall (a :: * -&gt; * -&gt; *) b c d.
Arrow a =&gt;
a b c -&gt; a (b, d) (c, d)
</span><span class="hs-identifier hs-var">first</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684417692"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; [SubExp] -&gt; [SubExp]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(([SubExp], Slice SubExp) -&gt; ([SubExp], Slice SubExp))
-&gt; ([SubExp], Slice SubExp) -&gt; ([SubExp], Slice SubExp)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Slice SubExp -&gt; ([SubExp], Slice SubExp)
</span><a href="Futhark.Pass.KernelBabysitting.html#splitSlice"><span class="hs-identifier hs-var">splitSlice</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DimIndex SubExp] -&gt; Slice SubExp
forall d. [DimIndex d] -&gt; Slice d
</span><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-var">Slice</span></a></span><span> </span><span class="annot"><span class="annottext">[DimIndex SubExp]
</span><a href="#local-6989586621684417691"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-357"></span><span class="annot"><a href="Futhark.Pass.KernelBabysitting.html#splitSlice"><span class="hs-identifier hs-var">splitSlice</span></a></span><span> </span><span id="local-6989586621684417690"><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684417690"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684417690"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-358"></span><span>
</span><span id="line-359"></span><span class="annot"><a href="Futhark.Pass.KernelBabysitting.html#allDimAreSlice"><span class="hs-identifier hs-type">allDimAreSlice</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-type">Slice</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-360"></span><span id="allDimAreSlice"><span class="annot"><span class="annottext">allDimAreSlice :: Slice SubExp -&gt; Bool
</span><a href="Futhark.Pass.KernelBabysitting.html#allDimAreSlice"><span class="hs-identifier hs-var hs-var">allDimAreSlice</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-type">Slice</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-361"></span><span class="annot"><a href="Futhark.Pass.KernelBabysitting.html#allDimAreSlice"><span class="hs-identifier hs-var">allDimAreSlice</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-type">Slice</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-type">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><span class="annottext">[DimIndex SubExp]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-362"></span><span class="annot"><a href="Futhark.Pass.KernelBabysitting.html#allDimAreSlice"><span class="hs-identifier hs-var">allDimAreSlice</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-type">Slice</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DimIndex SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684417689"><span class="annot"><span class="annottext">[DimIndex SubExp]
</span><a href="#local-6989586621684417689"><span class="hs-identifier hs-var">is</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Slice SubExp -&gt; Bool
</span><a href="Futhark.Pass.KernelBabysitting.html#allDimAreSlice"><span class="hs-identifier hs-var">allDimAreSlice</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DimIndex SubExp] -&gt; Slice SubExp
forall d. [DimIndex d] -&gt; Slice d
</span><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-var">Slice</span></a></span><span> </span><span class="annot"><span class="annottext">[DimIndex SubExp]
</span><a href="#local-6989586621684417689"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-363"></span><span>
</span><span id="line-364"></span><span class="hs-comment">-- Try to move thread indexes into their proper position.</span><span>
</span><span id="line-365"></span><span class="annot"><a href="Futhark.Pass.KernelBabysitting.html#coalescedIndexes"><span class="hs-identifier hs-type">coalescedIndexes</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-366"></span><span id="coalescedIndexes"><span class="annot"><span class="annottext">coalescedIndexes :: Names
-&gt; (VName -&gt; SubExp -&gt; Bool)
-&gt; [SubExp]
-&gt; [SubExp]
-&gt; Maybe [SubExp]
</span><a href="Futhark.Pass.KernelBabysitting.html#coalescedIndexes"><span class="hs-identifier hs-var hs-var">coalescedIndexes</span></a></span></span><span> </span><span id="local-6989586621684417688"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684417688"><span class="hs-identifier hs-var">free_ker_vars</span></a></span></span><span> </span><span id="local-6989586621684417687"><span class="annot"><span class="annottext">VName -&gt; SubExp -&gt; Bool
</span><a href="#local-6989586621684417687"><span class="hs-identifier hs-var">isGidVariant</span></a></span></span><span> </span><span id="local-6989586621684417686"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684417686"><span class="hs-identifier hs-var">tgids</span></a></span></span><span> </span><span id="local-6989586621684417685"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684417685"><span class="hs-identifier hs-var">is</span></a></span></span><span>
</span><span id="line-367"></span><span>  </span><span class="hs-comment">-- Do Nothing if:</span><span>
</span><span id="line-368"></span><span>  </span><span class="hs-comment">-- 1. any of the indices is a constant or a kernel free variable</span><span>
</span><span id="line-369"></span><span>  </span><span class="hs-comment">--    (because it would transpose a bigger array then needed -- big overhead).</span><span>
</span><span id="line-370"></span><span>  </span><span class="hs-comment">-- 2. the innermost index is variant to the innermost-thread gid</span><span>
</span><span id="line-371"></span><span>  </span><span class="hs-comment">--    (because access is likely to be already coalesced)</span><span>
</span><span id="line-372"></span><span>  </span><span class="hs-comment">-- 3. the indexes are a prefix of the thread indexes, because that</span><span>
</span><span id="line-373"></span><span>  </span><span class="hs-comment">-- means multiple threads will be accessing the same element.</span><span>
</span><span id="line-374"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; Bool) -&gt; [SubExp] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Bool
</span><a href="#local-6989586621684417684"><span class="hs-identifier hs-var">isCt</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684417685"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-375"></span><span>    </span><span class="annot"><span class="annottext">Maybe [SubExp]
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-376"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Bool) -&gt; [VName] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#nameIn"><span class="hs-operator hs-var">`nameIn`</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684417688"><span class="hs-identifier hs-var">free_ker_vars</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; [VName]
</span><a href="Futhark.IR.Prop.html#subExpVars"><span class="hs-identifier hs-var">subExpVars</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684417685"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-377"></span><span>    </span><span class="annot"><span class="annottext">Maybe [SubExp]
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-378"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684417685"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; [SubExp] -&gt; Bool
forall a. Eq a =&gt; [a] -&gt; [a] -&gt; Bool
</span><span class="hs-operator hs-var">`isPrefixOf`</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684417686"><span class="hs-identifier hs-var">tgids</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-379"></span><span>    </span><span class="annot"><span class="annottext">Maybe [SubExp]
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-380"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684417686"><span class="hs-identifier hs-var">tgids</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-381"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684417685"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-382"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684417682"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417682"><span class="hs-identifier hs-var">innergid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; SubExp
forall a. [a] -&gt; a
</span><span class="hs-identifier hs-var">last</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684417686"><span class="hs-identifier hs-var">tgids</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-383"></span><span>    </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684417681"><span class="hs-identifier hs-var">num_is</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp -&gt; Bool
</span><a href="#local-6989586621684417687"><span class="hs-identifier hs-var">isGidVariant</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417682"><span class="hs-identifier hs-var">innergid</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; SubExp
forall a. [a] -&gt; a
</span><span class="hs-identifier hs-var">last</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684417685"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-384"></span><span>    </span><span class="annot"><span class="annottext">[SubExp] -&gt; Maybe [SubExp]
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684417685"><span class="hs-identifier hs-var">is</span></a></span><span>
</span><span id="line-385"></span><span>  </span><span class="hs-comment">-- 3. Otherwise try fix coalescing</span><span>
</span><span id="line-386"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-387"></span><span>    </span><span class="annot"><span class="annottext">[SubExp] -&gt; Maybe [SubExp]
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; Maybe [SubExp]) -&gt; [SubExp] -&gt; Maybe [SubExp]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; [SubExp]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [SubExp]) -&gt; [SubExp] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; (Int, SubExp) -&gt; [SubExp])
-&gt; [SubExp] -&gt; [(Int, SubExp)] -&gt; [SubExp]
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl</span></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; (Int, SubExp) -&gt; [SubExp]
</span><a href="#local-6989586621684417678"><span class="hs-identifier hs-var">move</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; [SubExp]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684417685"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(Int, SubExp)] -&gt; [SubExp]) -&gt; [(Int, SubExp)] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; [SubExp] -&gt; [(Int, SubExp)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">..</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; [SubExp]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684417686"><span class="hs-identifier hs-var">tgids</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-388"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-389"></span><span>    </span><span id="local-6989586621684417681"><span class="annot"><span class="annottext">num_is :: Int
</span><a href="#local-6989586621684417681"><span class="hs-identifier hs-var hs-var">num_is</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684417685"><span class="hs-identifier hs-var">is</span></a></span><span>
</span><span id="line-390"></span><span>
</span><span id="line-391"></span><span>    </span><span id="local-6989586621684417678"><span class="annot"><span class="annottext">move :: [SubExp] -&gt; (Int, SubExp) -&gt; [SubExp]
</span><a href="#local-6989586621684417678"><span class="hs-identifier hs-var hs-var">move</span></a></span></span><span> </span><span id="local-6989586621684417677"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684417677"><span class="hs-identifier hs-var">is_rev</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684417676"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684417676"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684417675"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684417675"><span class="hs-identifier hs-var">tgid</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-392"></span><span>      </span><span class="hs-comment">-- If tgid is in is_rev anywhere but at position i, and</span><span>
</span><span id="line-393"></span><span>      </span><span class="hs-comment">-- position i exists, we move it to position i instead.</span><span>
</span><span id="line-394"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684417674"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684417674"><span class="hs-identifier hs-var">j</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; [SubExp] -&gt; Maybe Int
forall a. Eq a =&gt; a -&gt; [a] -&gt; Maybe Int
</span><span class="hs-identifier hs-var">elemIndex</span></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684417675"><span class="hs-identifier hs-var">tgid</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684417677"><span class="hs-identifier hs-var">is_rev</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-395"></span><span>        </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684417676"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684417674"><span class="hs-identifier hs-var">j</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-396"></span><span>        </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684417676"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684417681"><span class="hs-identifier hs-var">num_is</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-397"></span><span>        </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; [SubExp] -&gt; [SubExp]
forall {a} {b} {t}.
(Integral a, Integral b, Show a, Show b, Show t) =&gt;
a -&gt; b -&gt; [t] -&gt; [t]
</span><a href="#local-6989586621684417673"><span class="hs-identifier hs-var">swap</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684417676"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684417674"><span class="hs-identifier hs-var">j</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684417677"><span class="hs-identifier hs-var">is_rev</span></a></span><span>
</span><span id="line-398"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-399"></span><span>        </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684417677"><span class="hs-identifier hs-var">is_rev</span></a></span><span>
</span><span id="line-400"></span><span>
</span><span id="line-401"></span><span>    </span><span id="local-6989586621684417673"><span class="annot"><span class="annottext">swap :: a -&gt; b -&gt; [t] -&gt; [t]
</span><a href="#local-6989586621684417673"><span class="hs-identifier hs-var hs-var">swap</span></a></span></span><span> </span><span id="local-6989586621684417640"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684417640"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621684417639"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684417639"><span class="hs-identifier hs-var">j</span></a></span></span><span> </span><span id="local-6989586621684417638"><span class="annot"><span class="annottext">[t]
</span><a href="#local-6989586621684417638"><span class="hs-identifier hs-var">l</span></a></span></span><span>
</span><span id="line-402"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684417637"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621684417637"><span class="hs-identifier hs-var">ix</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">a -&gt; [t] -&gt; Maybe t
forall int a. Integral int =&gt; int -&gt; [a] -&gt; Maybe a
</span><a href="Futhark.Util.html#maybeNth"><span class="hs-identifier hs-var">maybeNth</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684417640"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">[t]
</span><a href="#local-6989586621684417638"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-403"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684417635"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621684417635"><span class="hs-identifier hs-var">jx</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">b -&gt; [t] -&gt; Maybe t
forall int a. Integral int =&gt; int -&gt; [a] -&gt; Maybe a
</span><a href="Futhark.Util.html#maybeNth"><span class="hs-identifier hs-var">maybeNth</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684417639"><span class="hs-identifier hs-var">j</span></a></span><span> </span><span class="annot"><span class="annottext">[t]
</span><a href="#local-6989586621684417638"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-404"></span><span>        </span><span class="annot"><span class="annottext">a -&gt; t -&gt; [t] -&gt; [t]
forall {t} {t}. (Eq t, Num t) =&gt; t -&gt; t -&gt; [t] -&gt; [t]
</span><a href="#local-6989586621684417634"><span class="hs-identifier hs-var">update</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684417640"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621684417635"><span class="hs-identifier hs-var">jx</span></a></span><span> </span><span class="annot"><span class="annottext">([t] -&gt; [t]) -&gt; [t] -&gt; [t]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">b -&gt; t -&gt; [t] -&gt; [t]
forall {t} {t}. (Eq t, Num t) =&gt; t -&gt; t -&gt; [t] -&gt; [t]
</span><a href="#local-6989586621684417634"><span class="hs-identifier hs-var">update</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684417639"><span class="hs-identifier hs-var">j</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621684417637"><span class="hs-identifier hs-var">ix</span></a></span><span> </span><span class="annot"><span class="annottext">[t]
</span><a href="#local-6989586621684417638"><span class="hs-identifier hs-var">l</span></a></span><span>
</span><span id="line-405"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-406"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; [t]
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; [t]) -&gt; String -&gt; [t]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;coalescedIndexes swap: invalid indices&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">(a, b, [t]) -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684417640"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684417639"><span class="hs-identifier hs-var">j</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[t]
</span><a href="#local-6989586621684417638"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-407"></span><span>
</span><span id="line-408"></span><span>    </span><span id="local-6989586621684417634"><span class="annot"><span class="annottext">update :: t -&gt; t -&gt; [t] -&gt; [t]
</span><a href="#local-6989586621684417634"><span class="hs-identifier hs-var hs-var">update</span></a></span></span><span> </span><span class="annot"><span class="annottext">t
</span><span class="hs-number">0</span></span><span> </span><span id="local-6989586621684417623"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621684417623"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">t
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684417622"><span class="annot"><span class="annottext">[t]
</span><a href="#local-6989586621684417622"><span class="hs-identifier hs-var">ys</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621684417623"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">t -&gt; [t] -&gt; [t]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[t]
</span><a href="#local-6989586621684417622"><span class="hs-identifier hs-var">ys</span></a></span><span>
</span><span id="line-409"></span><span>    </span><span class="annot"><a href="#local-6989586621684417634"><span class="hs-identifier hs-var">update</span></a></span><span> </span><span id="local-6989586621684417621"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621684417621"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621684417620"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621684417620"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684417619"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621684417619"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684417618"><span class="annot"><span class="annottext">[t]
</span><a href="#local-6989586621684417618"><span class="hs-identifier hs-var">ys</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621684417619"><span class="hs-identifier hs-var">y</span></a></span><span> </span><span class="annot"><span class="annottext">t -&gt; [t] -&gt; [t]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">t -&gt; t -&gt; [t] -&gt; [t]
</span><a href="#local-6989586621684417634"><span class="hs-identifier hs-var">update</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621684417621"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">t -&gt; t -&gt; t
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span class="annot"><span class="annottext">t
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621684417620"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">[t]
</span><a href="#local-6989586621684417618"><span class="hs-identifier hs-var">ys</span></a></span><span>
</span><span id="line-410"></span><span>    </span><span class="annot"><a href="#local-6989586621684417634"><span class="hs-identifier hs-var">update</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">t
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; [t]
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;coalescedIndexes: update&quot;</span></span><span>
</span><span id="line-411"></span><span>
</span><span id="line-412"></span><span>    </span><span class="annot"><a href="#local-6989586621684417684"><span class="hs-identifier hs-type">isCt</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-413"></span><span>    </span><span id="local-6989586621684417684"><span class="annot"><span class="annottext">isCt :: SubExp -&gt; Bool
</span><a href="#local-6989586621684417684"><span class="hs-identifier hs-var hs-var">isCt</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span> </span><span class="annot"><span class="annottext">PrimValue
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-414"></span><span>    </span><span class="annot"><a href="#local-6989586621684417684"><span class="hs-identifier hs-var">isCt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-415"></span><span>
</span><span id="line-416"></span><span class="annot"><a href="Futhark.Pass.KernelBabysitting.html#coalescingPermutation"><span class="hs-identifier hs-type">coalescingPermutation</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">]</span><span>
</span><span id="line-417"></span><span id="coalescingPermutation"><span class="annot"><span class="annottext">coalescingPermutation :: Int -&gt; Int -&gt; [Int]
</span><a href="Futhark.Pass.KernelBabysitting.html#coalescingPermutation"><span class="hs-identifier hs-var hs-var">coalescingPermutation</span></a></span></span><span> </span><span id="local-6989586621684417617"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684417617"><span class="hs-identifier hs-var">num_is</span></a></span></span><span> </span><span id="local-6989586621684417616"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684417616"><span class="hs-identifier hs-var">rank</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-418"></span><span>  </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684417617"><span class="hs-identifier hs-var">num_is</span></a></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684417616"><span class="hs-identifier hs-var">rank</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; [Int] -&gt; [Int]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684417617"><span class="hs-identifier hs-var">num_is</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span>
</span><span id="line-419"></span><span>
</span><span id="line-420"></span><span id="local-6989586621684418431"><span class="annot"><a href="Futhark.Pass.KernelBabysitting.html#rearrangeInput"><span class="hs-identifier hs-type">rearrangeInput</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-421"></span><span>  </span><span class="annot"><a href="Futhark.Builder.Class.html#MonadBuilder"><span class="hs-identifier hs-type">MonadBuilder</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684418431"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-422"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-423"></span><span>  </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-424"></span><span>  </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-425"></span><span>  </span><span class="annot"><a href="#local-6989586621684418431"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span></span><span>
</span><span id="line-426"></span><span id="rearrangeInput"><span class="annot"><span class="annottext">rearrangeInput :: forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Maybe (Maybe [Int]) -&gt; [Int] -&gt; VName -&gt; m VName
</span><a href="Futhark.Pass.KernelBabysitting.html#rearrangeInput"><span class="hs-identifier hs-var hs-var">rearrangeInput</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684417599"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684417599"><span class="hs-identifier hs-var">current_perm</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621684417598"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684417598"><span class="hs-identifier hs-var">perm</span></a></span></span><span> </span><span id="local-6989586621684417597"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417597"><span class="hs-identifier hs-var">arr</span></a></span></span><span>
</span><span id="line-427"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684417599"><span class="hs-identifier hs-var">current_perm</span></a></span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; [Int] -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684417598"><span class="hs-identifier hs-var">perm</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; m VName
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417597"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="hs-comment">-- Already has desired representation.</span><span>
</span><span id="line-428"></span><span class="annot"><a href="Futhark.Pass.KernelBabysitting.html#rearrangeInput"><span class="hs-identifier hs-var">rearrangeInput</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Maybe [Int])
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span id="local-6989586621684417596"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684417596"><span class="hs-identifier hs-var">perm</span></a></span></span><span> </span><span id="local-6989586621684417595"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417595"><span class="hs-identifier hs-var">arr</span></a></span></span><span>
</span><span id="line-429"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; [Int]
forall a. Ord a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">sort</span></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684417596"><span class="hs-identifier hs-var">perm</span></a></span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; [Int] -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684417596"><span class="hs-identifier hs-var">perm</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; m VName
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417595"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="hs-comment">-- We don't know the current</span><span>
</span><span id="line-430"></span><span>  </span><span class="hs-comment">-- representation, but the indexing</span><span>
</span><span id="line-431"></span><span>  </span><span class="hs-comment">-- is linear, so let's hope the</span><span>
</span><span id="line-432"></span><span>  </span><span class="hs-comment">-- array is too.</span><span>
</span><span id="line-433"></span><span class="annot"><a href="Futhark.Pass.KernelBabysitting.html#rearrangeInput"><span class="hs-identifier hs-var">rearrangeInput</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621684417594"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684417594"><span class="hs-identifier hs-var">perm</span></a></span></span><span> </span><span id="local-6989586621684417593"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417593"><span class="hs-identifier hs-var">arr</span></a></span></span><span>
</span><span id="line-434"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; [Int]
forall a. Ord a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">sort</span></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684417594"><span class="hs-identifier hs-var">perm</span></a></span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; [Int] -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684417594"><span class="hs-identifier hs-var">perm</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; m VName
forall (m :: * -&gt; *). MonadBuilder m =&gt; VName -&gt; m VName
</span><a href="Futhark.Pass.KernelBabysitting.html#rowMajorArray"><span class="hs-identifier hs-var">rowMajorArray</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417593"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="hs-comment">-- We just want a row-major array, no tricks.</span><span>
</span><span id="line-435"></span><span class="annot"><a href="Futhark.Pass.KernelBabysitting.html#rearrangeInput"><span class="hs-identifier hs-var">rearrangeInput</span></a></span><span> </span><span id="local-6989586621684417592"><span class="annot"><span class="annottext">Maybe (Maybe [Int])
</span><a href="#local-6989586621684417592"><span class="hs-identifier hs-var">manifest</span></a></span></span><span> </span><span id="local-6989586621684417591"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684417591"><span class="hs-identifier hs-var">perm</span></a></span></span><span> </span><span id="local-6989586621684417590"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417590"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-436"></span><span>  </span><span class="hs-comment">-- We may first manifest the array to ensure that it is flat in</span><span>
</span><span id="line-437"></span><span>  </span><span class="hs-comment">-- memory.  This is sometimes unnecessary, in which case the copy</span><span>
</span><span id="line-438"></span><span>  </span><span class="hs-comment">-- will hopefully be removed by the simplifier.</span><span>
</span><span id="line-439"></span><span>  </span><span id="local-6989586621684417589"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417589"><span class="hs-identifier hs-var">manifested</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Maybe (Maybe [Int]) -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Maybe [Int])
</span><a href="#local-6989586621684417592"><span class="hs-identifier hs-var">manifest</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">VName -&gt; m VName
forall (m :: * -&gt; *). MonadBuilder m =&gt; VName -&gt; m VName
</span><a href="Futhark.Pass.KernelBabysitting.html#rowMajorArray"><span class="hs-identifier hs-var">rowMajorArray</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417590"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">VName -&gt; m VName
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417590"><span class="hs-identifier hs-var">arr</span></a></span><span>
</span><span id="line-440"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; Exp (Rep m) -&gt; m VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m VName
</span><a href="Futhark.Construct.html#letExp"><span class="hs-identifier hs-var">letExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; String
</span><a href="Language.Futhark.Core.html#baseString"><span class="hs-identifier hs-var">baseString</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417590"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_coalesced&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Exp (Rep m) -&gt; m VName) -&gt; Exp (Rep m) -&gt; m VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-441"></span><span>    </span><span class="annot"><span class="annottext">BasicOp -&gt; Exp (Rep m)
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; Exp (Rep m)) -&gt; BasicOp -&gt; Exp (Rep m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; VName -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Manifest"><span class="hs-identifier hs-var">Manifest</span></a></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684417591"><span class="hs-identifier hs-var">perm</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417589"><span class="hs-identifier hs-var">manifested</span></a></span><span>
</span><span id="line-442"></span><span>
</span><span id="line-443"></span><span id="local-6989586621684418409"><span class="annot"><a href="Futhark.Pass.KernelBabysitting.html#rowMajorArray"><span class="hs-identifier hs-type">rowMajorArray</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-444"></span><span>  </span><span class="annot"><a href="Futhark.Builder.Class.html#MonadBuilder"><span class="hs-identifier hs-type">MonadBuilder</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684418409"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-445"></span><span>  </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-446"></span><span>  </span><span class="annot"><a href="#local-6989586621684418409"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span></span><span>
</span><span id="line-447"></span><span id="rowMajorArray"><span class="annot"><span class="annottext">rowMajorArray :: forall (m :: * -&gt; *). MonadBuilder m =&gt; VName -&gt; m VName
</span><a href="Futhark.Pass.KernelBabysitting.html#rowMajorArray"><span class="hs-identifier hs-var hs-var">rowMajorArray</span></a></span></span><span> </span><span id="local-6989586621684417566"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417566"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-448"></span><span>  </span><span id="local-6989586621684417565"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684417565"><span class="hs-identifier hs-var">rank</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Int
forall shape u. ArrayShape shape =&gt; TypeBase shape u -&gt; Int
</span><a href="Futhark.IR.Prop.Types.html#arrayRank"><span class="hs-identifier hs-var">arrayRank</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Int) -&gt; m Type -&gt; m Int
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; m Type
forall rep (m :: * -&gt; *). HasScope rep m =&gt; VName -&gt; m Type
</span><a href="Futhark.IR.Prop.Scope.html#lookupType"><span class="hs-identifier hs-var">lookupType</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417566"><span class="hs-identifier hs-var">arr</span></a></span><span>
</span><span id="line-449"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; Exp (Rep m) -&gt; m VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m VName
</span><a href="Futhark.Construct.html#letExp"><span class="hs-identifier hs-var">letExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; String
</span><a href="Language.Futhark.Core.html#baseString"><span class="hs-identifier hs-var">baseString</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417566"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_rowmajor&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Exp (Rep m) -&gt; m VName) -&gt; Exp (Rep m) -&gt; m VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; Exp (Rep m)
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; Exp (Rep m)) -&gt; BasicOp -&gt; Exp (Rep m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; VName -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Manifest"><span class="hs-identifier hs-var">Manifest</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684417565"><span class="hs-identifier hs-var">rank</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417566"><span class="hs-identifier hs-var">arr</span></a></span><span>
</span><span id="line-450"></span><span>
</span><span id="line-451"></span><span id="local-6989586621684418411"><span class="annot"><a href="Futhark.Pass.KernelBabysitting.html#rearrangeSlice"><span class="hs-identifier hs-type">rearrangeSlice</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-452"></span><span>  </span><span class="annot"><a href="Futhark.Builder.Class.html#MonadBuilder"><span class="hs-identifier hs-type">MonadBuilder</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684418411"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-453"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-454"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-455"></span><span>  </span><span class="annot"><a href="Futhark.Analysis.PrimExp.html#PrimExp"><span class="hs-identifier hs-type">PrimExp</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-456"></span><span>  </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-457"></span><span>  </span><span class="annot"><a href="#local-6989586621684418411"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span></span><span>
</span><span id="line-458"></span><span id="rearrangeSlice"><span class="annot"><span class="annottext">rearrangeSlice :: forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Int -&gt; SubExp -&gt; PrimExp VName -&gt; VName -&gt; m VName
</span><a href="Futhark.Pass.KernelBabysitting.html#rearrangeSlice"><span class="hs-identifier hs-var hs-var">rearrangeSlice</span></a></span></span><span> </span><span id="local-6989586621684417502"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684417502"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span id="local-6989586621684417501"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684417501"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684417500"><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684417500"><span class="hs-identifier hs-var">num_chunks</span></a></span></span><span> </span><span id="local-6989586621684417499"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417499"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-459"></span><span>  </span><span id="local-6989586621684417498"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684417498"><span class="hs-identifier hs-var">num_chunks'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; PrimExp VName -&gt; m SubExp
forall (m :: * -&gt; *) a.
(MonadBuilder m, ToExp a) =&gt;
String -&gt; a -&gt; m SubExp
</span><a href="Futhark.Construct.html#toSubExp"><span class="hs-identifier hs-var">toSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;num_chunks&quot;</span></span><span> </span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684417500"><span class="hs-identifier hs-var">num_chunks</span></a></span><span>
</span><span id="line-460"></span><span>
</span><span id="line-461"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684417496"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684417496"><span class="hs-identifier hs-var">w_padded</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684417495"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684417495"><span class="hs-identifier hs-var">padding</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; SubExp -&gt; m (SubExp, SubExp)
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
SubExp -&gt; SubExp -&gt; m (SubExp, SubExp)
</span><a href="Futhark.Pass.KernelBabysitting.html#paddedScanReduceInput"><span class="hs-identifier hs-var">paddedScanReduceInput</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684417501"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684417498"><span class="hs-identifier hs-var">num_chunks'</span></a></span><span>
</span><span id="line-462"></span><span>
</span><span id="line-463"></span><span>  </span><span id="local-6989586621684417493"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684417493"><span class="hs-identifier hs-var">per_chunk</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-464"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; Exp (Rep m) -&gt; m SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;per_chunk&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep m) -&gt; m SubExp) -&gt; Exp (Rep m) -&gt; m SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-465"></span><span>      </span><span class="annot"><span class="annottext">BasicOp -&gt; Exp (Rep m)
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; Exp (Rep m)) -&gt; BasicOp -&gt; Exp (Rep m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BinOp -&gt; SubExp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#BinOp"><span class="hs-identifier hs-var">BinOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Safety -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#SQuot"><span class="hs-identifier hs-var">SQuot</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Safety
</span><a href="Futhark.IR.Primitive.html#Unsafe"><span class="hs-identifier hs-var">Unsafe</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684417496"><span class="hs-identifier hs-var">w_padded</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684417498"><span class="hs-identifier hs-var">num_chunks'</span></a></span><span>
</span><span id="line-466"></span><span>  </span><span id="local-6989586621684417490"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684417490"><span class="hs-identifier hs-var">arr_t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; m Type
forall rep (m :: * -&gt; *). HasScope rep m =&gt; VName -&gt; m Type
</span><a href="Futhark.IR.Prop.Scope.html#lookupType"><span class="hs-identifier hs-var">lookupType</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417499"><span class="hs-identifier hs-var">arr</span></a></span><span>
</span><span id="line-467"></span><span>  </span><span id="local-6989586621684417489"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417489"><span class="hs-identifier hs-var">arr_padded</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; SubExp -&gt; Type -&gt; m VName
</span><a href="#local-6989586621684417488"><span class="hs-identifier hs-var">padArray</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684417496"><span class="hs-identifier hs-var">w_padded</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684417495"><span class="hs-identifier hs-var">padding</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684417490"><span class="hs-identifier hs-var">arr_t</span></a></span><span>
</span><span id="line-468"></span><span>  </span><span class="annot"><span class="annottext">SubExp -&gt; SubExp -&gt; SubExp -&gt; String -&gt; VName -&gt; Type -&gt; m VName
</span><a href="#local-6989586621684417487"><span class="hs-identifier hs-var">rearrange</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684417498"><span class="hs-identifier hs-var">num_chunks'</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684417496"><span class="hs-identifier hs-var">w_padded</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684417493"><span class="hs-identifier hs-var">per_chunk</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; String
</span><a href="Language.Futhark.Core.html#baseString"><span class="hs-identifier hs-var">baseString</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417499"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417489"><span class="hs-identifier hs-var">arr_padded</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684417490"><span class="hs-identifier hs-var">arr_t</span></a></span><span>
</span><span id="line-469"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-470"></span><span>    </span><span id="local-6989586621684417488"><span class="annot"><span class="annottext">padArray :: SubExp -&gt; SubExp -&gt; Type -&gt; m VName
</span><a href="#local-6989586621684417488"><span class="hs-identifier hs-var hs-var">padArray</span></a></span></span><span> </span><span id="local-6989586621684417486"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684417486"><span class="hs-identifier hs-var">w_padded</span></a></span></span><span> </span><span id="local-6989586621684417485"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684417485"><span class="hs-identifier hs-var">padding</span></a></span></span><span> </span><span id="local-6989586621684417484"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684417484"><span class="hs-identifier hs-var">arr_t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-471"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684417483"><span class="annot"><span class="annottext">arr_shape :: Shape
</span><a href="#local-6989586621684417483"><span class="hs-identifier hs-var hs-var">arr_shape</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Shape
forall shape u. ArrayShape shape =&gt; TypeBase shape u -&gt; shape
</span><a href="Futhark.IR.Prop.Types.html#arrayShape"><span class="hs-identifier hs-var">arrayShape</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684417484"><span class="hs-identifier hs-var">arr_t</span></a></span><span>
</span><span id="line-472"></span><span>          </span><span id="local-6989586621684417481"><span class="annot"><span class="annottext">padding_shape :: Shape
</span><a href="#local-6989586621684417481"><span class="hs-identifier hs-var hs-var">padding_shape</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Shape -&gt; SubExp -&gt; Shape
forall d. Int -&gt; ShapeBase d -&gt; d -&gt; ShapeBase d
</span><a href="Futhark.IR.Prop.Types.html#setDim"><span class="hs-identifier hs-var">setDim</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684417502"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684417483"><span class="hs-identifier hs-var">arr_shape</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684417485"><span class="hs-identifier hs-var">padding</span></a></span><span>
</span><span id="line-473"></span><span>      </span><span id="local-6989586621684417479"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417479"><span class="hs-identifier hs-var">arr_padding</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-474"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; Exp (Rep m) -&gt; m VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m VName
</span><a href="Futhark.Construct.html#letExp"><span class="hs-identifier hs-var">letExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; String
</span><a href="Language.Futhark.Core.html#baseString"><span class="hs-identifier hs-var">baseString</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417499"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_padding&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Exp (Rep m) -&gt; m VName) -&gt; Exp (Rep m) -&gt; m VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-475"></span><span>          </span><span class="annot"><span class="annottext">BasicOp -&gt; Exp (Rep m)
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; Exp (Rep m)) -&gt; BasicOp -&gt; Exp (Rep m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; [SubExp] -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Scratch"><span class="hs-identifier hs-var">Scratch</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; PrimType
forall shape u. TypeBase shape u -&gt; PrimType
</span><a href="Futhark.IR.Prop.Types.html#elemType"><span class="hs-identifier hs-var">elemType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684417484"><span class="hs-identifier hs-var">arr_t</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Shape -&gt; [SubExp]
forall d. ShapeBase d -&gt; [d]
</span><a href="Futhark.IR.Syntax.Core.html#shapeDims"><span class="hs-identifier hs-var hs-var">shapeDims</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684417481"><span class="hs-identifier hs-var">padding_shape</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-476"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; Exp (Rep m) -&gt; m VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m VName
</span><a href="Futhark.Construct.html#letExp"><span class="hs-identifier hs-var">letExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; String
</span><a href="Language.Futhark.Core.html#baseString"><span class="hs-identifier hs-var">baseString</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417499"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_padded&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Exp (Rep m) -&gt; m VName) -&gt; Exp (Rep m) -&gt; m VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-477"></span><span>        </span><span class="annot"><span class="annottext">BasicOp -&gt; Exp (Rep m)
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; Exp (Rep m)) -&gt; BasicOp -&gt; Exp (Rep m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; VName -&gt; [VName] -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Concat"><span class="hs-identifier hs-var">Concat</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684417502"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417499"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417479"><span class="hs-identifier hs-var">arr_padding</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684417486"><span class="hs-identifier hs-var">w_padded</span></a></span><span>
</span><span id="line-478"></span><span>
</span><span id="line-479"></span><span>    </span><span id="local-6989586621684417487"><span class="annot"><span class="annottext">rearrange :: SubExp -&gt; SubExp -&gt; SubExp -&gt; String -&gt; VName -&gt; Type -&gt; m VName
</span><a href="#local-6989586621684417487"><span class="hs-identifier hs-var hs-var">rearrange</span></a></span></span><span> </span><span id="local-6989586621684417475"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684417475"><span class="hs-identifier hs-var">num_chunks'</span></a></span></span><span> </span><span id="local-6989586621684417474"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684417474"><span class="hs-identifier hs-var">w_padded</span></a></span></span><span> </span><span id="local-6989586621684417473"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684417473"><span class="hs-identifier hs-var">per_chunk</span></a></span></span><span> </span><span id="local-6989586621684417472"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621684417472"><span class="hs-identifier hs-var">arr_name</span></a></span></span><span> </span><span id="local-6989586621684417471"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417471"><span class="hs-identifier hs-var">arr_padded</span></a></span></span><span> </span><span id="local-6989586621684417470"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684417470"><span class="hs-identifier hs-var">arr_t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-480"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684417469"><span class="annot"><span class="annottext">arr_dims :: [SubExp]
</span><a href="#local-6989586621684417469"><span class="hs-identifier hs-var hs-var">arr_dims</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; [SubExp]
forall u. TypeBase Shape u -&gt; [SubExp]
</span><a href="Futhark.IR.Prop.Types.html#arrayDims"><span class="hs-identifier hs-var">arrayDims</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684417470"><span class="hs-identifier hs-var">arr_t</span></a></span><span>
</span><span id="line-481"></span><span>          </span><span id="local-6989586621684417467"><span class="annot"><span class="annottext">pre_dims :: [SubExp]
</span><a href="#local-6989586621684417467"><span class="hs-identifier hs-var hs-var">pre_dims</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [SubExp] -&gt; [SubExp]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">take</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684417502"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684417469"><span class="hs-identifier hs-var">arr_dims</span></a></span><span>
</span><span id="line-482"></span><span>          </span><span id="local-6989586621684417466"><span class="annot"><span class="annottext">post_dims :: [SubExp]
</span><a href="#local-6989586621684417466"><span class="hs-identifier hs-var hs-var">post_dims</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [SubExp] -&gt; [SubExp]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684417502"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684417469"><span class="hs-identifier hs-var">arr_dims</span></a></span><span>
</span><span id="line-483"></span><span>          </span><span id="local-6989586621684417465"><span class="annot"><span class="annottext">extradim_shape :: Shape
</span><a href="#local-6989586621684417465"><span class="hs-identifier hs-var hs-var">extradim_shape</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; Shape
forall d. [d] -&gt; ShapeBase d
</span><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-var">Shape</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; Shape) -&gt; [SubExp] -&gt; Shape
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684417467"><span class="hs-identifier hs-var">pre_dims</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; [SubExp] -&gt; [SubExp]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684417475"><span class="hs-identifier hs-var">num_chunks'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684417473"><span class="hs-identifier hs-var">per_chunk</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; [SubExp] -&gt; [SubExp]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684417466"><span class="hs-identifier hs-var">post_dims</span></a></span><span>
</span><span id="line-484"></span><span>          </span><span id="local-6989586621684417463"><span class="annot"><span class="annottext">tr_perm :: [Int]
</span><a href="#local-6989586621684417463"><span class="hs-identifier hs-var hs-var">tr_perm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684417502"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; [Int] -&gt; [Int]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Int) -&gt; [Int] -&gt; [Int]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684417502"><span class="hs-identifier hs-var">d</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; [Int] -&gt; [Int]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">Shape -&gt; Int
forall a. ArrayShape a =&gt; a -&gt; Int
</span><a href="Futhark.IR.Syntax.Core.html#shapeRank"><span class="hs-identifier hs-var">shapeRank</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684417465"><span class="hs-identifier hs-var">extradim_shape</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684417502"><span class="hs-identifier hs-var">d</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; [Int] -&gt; [Int]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-485"></span><span>      </span><span id="local-6989586621684417461"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417461"><span class="hs-identifier hs-var">arr_extradim</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-486"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; Exp (Rep m) -&gt; m VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m VName
</span><a href="Futhark.Construct.html#letExp"><span class="hs-identifier hs-var">letExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621684417472"><span class="hs-identifier hs-var">arr_name</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_extradim&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Exp (Rep m) -&gt; m VName) -&gt; Exp (Rep m) -&gt; m VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-487"></span><span>          </span><span class="annot"><span class="annottext">BasicOp -&gt; Exp (Rep m)
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; Exp (Rep m)) -&gt; BasicOp -&gt; Exp (Rep m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ShapeChange SubExp -&gt; VName -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Reshape"><span class="hs-identifier hs-var">Reshape</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SubExp -&gt; DimChange SubExp) -&gt; [SubExp] -&gt; ShapeChange SubExp
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; DimChange SubExp
forall d. d -&gt; DimChange d
</span><a href="Futhark.IR.Syntax.html#DimNew"><span class="hs-identifier hs-var">DimNew</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; ShapeChange SubExp) -&gt; [SubExp] -&gt; ShapeChange SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Shape -&gt; [SubExp]
forall d. ShapeBase d -&gt; [d]
</span><a href="Futhark.IR.Syntax.Core.html#shapeDims"><span class="hs-identifier hs-var hs-var">shapeDims</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684417465"><span class="hs-identifier hs-var">extradim_shape</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417471"><span class="hs-identifier hs-var">arr_padded</span></a></span><span>
</span><span id="line-488"></span><span>      </span><span id="local-6989586621684417459"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417459"><span class="hs-identifier hs-var">arr_extradim_tr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-489"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; Exp (Rep m) -&gt; m VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m VName
</span><a href="Futhark.Construct.html#letExp"><span class="hs-identifier hs-var">letExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621684417472"><span class="hs-identifier hs-var">arr_name</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_extradim_tr&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Exp (Rep m) -&gt; m VName) -&gt; Exp (Rep m) -&gt; m VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-490"></span><span>          </span><span class="annot"><span class="annottext">BasicOp -&gt; Exp (Rep m)
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; Exp (Rep m)) -&gt; BasicOp -&gt; Exp (Rep m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; VName -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Manifest"><span class="hs-identifier hs-var">Manifest</span></a></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684417463"><span class="hs-identifier hs-var">tr_perm</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417461"><span class="hs-identifier hs-var">arr_extradim</span></a></span><span>
</span><span id="line-491"></span><span>      </span><span id="local-6989586621684417458"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417458"><span class="hs-identifier hs-var">arr_inv_tr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-492"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; Exp (Rep m) -&gt; m VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m VName
</span><a href="Futhark.Construct.html#letExp"><span class="hs-identifier hs-var">letExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621684417472"><span class="hs-identifier hs-var">arr_name</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_inv_tr&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Exp (Rep m) -&gt; m VName) -&gt; Exp (Rep m) -&gt; m VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-493"></span><span>          </span><span class="annot"><span class="annottext">BasicOp -&gt; Exp (Rep m)
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; Exp (Rep m)) -&gt; BasicOp -&gt; Exp (Rep m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-494"></span><span>            </span><span class="annot"><span class="annottext">ShapeChange SubExp -&gt; VName -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Reshape"><span class="hs-identifier hs-var">Reshape</span></a></span><span>
</span><span id="line-495"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SubExp -&gt; DimChange SubExp) -&gt; [SubExp] -&gt; ShapeChange SubExp
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; DimChange SubExp
forall d. d -&gt; DimChange d
</span><a href="Futhark.IR.Syntax.html#DimCoercion"><span class="hs-identifier hs-var">DimCoercion</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684417467"><span class="hs-identifier hs-var">pre_dims</span></a></span><span> </span><span class="annot"><span class="annottext">ShapeChange SubExp -&gt; ShapeChange SubExp -&gt; ShapeChange SubExp
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; DimChange SubExp) -&gt; [SubExp] -&gt; ShapeChange SubExp
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; DimChange SubExp
forall d. d -&gt; DimChange d
</span><a href="Futhark.IR.Syntax.html#DimNew"><span class="hs-identifier hs-var">DimNew</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684417474"><span class="hs-identifier hs-var">w_padded</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; [SubExp] -&gt; [SubExp]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684417466"><span class="hs-identifier hs-var">post_dims</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-496"></span><span>              </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417459"><span class="hs-identifier hs-var">arr_extradim_tr</span></a></span><span>
</span><span id="line-497"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; Exp (Rep m) -&gt; m VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m VName
</span><a href="Futhark.Construct.html#letExp"><span class="hs-identifier hs-var">letExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621684417472"><span class="hs-identifier hs-var">arr_name</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_inv_tr_init&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-498"></span><span>        </span><span class="annot"><span class="annottext">(Exp (Rep m) -&gt; m VName) -&gt; m (Exp (Rep m)) -&gt; m VName
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">Int
-&gt; VName -&gt; m (Exp (Rep m)) -&gt; m (Exp (Rep m)) -&gt; m (Exp (Rep m))
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Int
-&gt; VName -&gt; m (Exp (Rep m)) -&gt; m (Exp (Rep m)) -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#eSliceArray"><span class="hs-identifier hs-var">eSliceArray</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684417502"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417458"><span class="hs-identifier hs-var">arr_inv_tr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp -&gt; m (Exp (Rep m))
forall (m :: * -&gt; *). MonadBuilder m =&gt; SubExp -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#eSubExp"><span class="hs-identifier hs-var">eSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; m (Exp (Rep m))) -&gt; SubExp -&gt; m (Exp (Rep m))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int64 -&gt; SubExp
forall v. IsValue v =&gt; v -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#constant"><span class="hs-identifier hs-var">constant</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int64
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp -&gt; m (Exp (Rep m))
forall (m :: * -&gt; *). MonadBuilder m =&gt; SubExp -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#eSubExp"><span class="hs-identifier hs-var">eSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684417501"><span class="hs-identifier hs-var">w</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-499"></span><span>
</span><span id="line-500"></span><span id="local-6989586621684418362"><span class="annot"><a href="Futhark.Pass.KernelBabysitting.html#paddedScanReduceInput"><span class="hs-identifier hs-type">paddedScanReduceInput</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-501"></span><span>  </span><span class="annot"><a href="Futhark.Builder.Class.html#MonadBuilder"><span class="hs-identifier hs-type">MonadBuilder</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684418362"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-502"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-503"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-504"></span><span>  </span><span class="annot"><a href="#local-6989586621684418362"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-505"></span><span id="paddedScanReduceInput"><span class="annot"><span class="annottext">paddedScanReduceInput :: forall (m :: * -&gt; *).
MonadBuilder m =&gt;
SubExp -&gt; SubExp -&gt; m (SubExp, SubExp)
</span><a href="Futhark.Pass.KernelBabysitting.html#paddedScanReduceInput"><span class="hs-identifier hs-var hs-var">paddedScanReduceInput</span></a></span></span><span> </span><span id="local-6989586621684417440"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684417440"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684417439"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684417439"><span class="hs-identifier hs-var">stride</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-506"></span><span>  </span><span id="local-6989586621684417438"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684417438"><span class="hs-identifier hs-var">w_padded</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-507"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; ExpT (Rep m) -&gt; m SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;padded_size&quot;</span></span><span>
</span><span id="line-508"></span><span>      </span><span class="annot"><span class="annottext">(ExpT (Rep m) -&gt; m SubExp) -&gt; m (ExpT (Rep m)) -&gt; m SubExp
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">IntType -&gt; m (ExpT (Rep m)) -&gt; m (ExpT (Rep m)) -&gt; m (ExpT (Rep m))
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
IntType -&gt; m (Exp (Rep m)) -&gt; m (Exp (Rep m)) -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#eRoundToMultipleOf"><span class="hs-identifier hs-var">eRoundToMultipleOf</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp -&gt; m (ExpT (Rep m))
forall (m :: * -&gt; *). MonadBuilder m =&gt; SubExp -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#eSubExp"><span class="hs-identifier hs-var">eSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684417440"><span class="hs-identifier hs-var">w</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp -&gt; m (ExpT (Rep m))
forall (m :: * -&gt; *). MonadBuilder m =&gt; SubExp -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#eSubExp"><span class="hs-identifier hs-var">eSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684417439"><span class="hs-identifier hs-var">stride</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-509"></span><span>  </span><span id="local-6989586621684417436"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684417436"><span class="hs-identifier hs-var">padding</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; ExpT (Rep m) -&gt; m SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;padding&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ExpT (Rep m) -&gt; m SubExp) -&gt; ExpT (Rep m) -&gt; m SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT (Rep m)
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT (Rep m)) -&gt; BasicOp -&gt; ExpT (Rep m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BinOp -&gt; SubExp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#BinOp"><span class="hs-identifier hs-var">BinOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Overflow -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#Sub"><span class="hs-identifier hs-var">Sub</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Overflow
</span><a href="Futhark.IR.Primitive.html#OverflowUndef"><span class="hs-identifier hs-var">OverflowUndef</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684417438"><span class="hs-identifier hs-var">w_padded</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684417440"><span class="hs-identifier hs-var">w</span></a></span><span>
</span><span id="line-510"></span><span>  </span><span class="annot"><span class="annottext">(SubExp, SubExp) -&gt; m (SubExp, SubExp)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684417438"><span class="hs-identifier hs-var">w_padded</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684417436"><span class="hs-identifier hs-var">padding</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-511"></span><span>
</span><span id="line-512"></span><span class="hs-comment">--- Computing variance.</span><span>
</span><span id="line-513"></span><span>
</span><span id="line-514"></span><span class="hs-keyword">type</span><span> </span><span id="VarianceTable"><span class="annot"><a href="Futhark.Pass.KernelBabysitting.html#VarianceTable"><span class="hs-identifier hs-var">VarianceTable</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span>
</span><span id="line-515"></span><span>
</span><span id="line-516"></span><span class="annot"><a href="Futhark.Pass.KernelBabysitting.html#varianceInStms"><span class="hs-identifier hs-type">varianceInStms</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Pass.KernelBabysitting.html#VarianceTable"><span class="hs-identifier hs-type">VarianceTable</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.KernelBabysitting.html#VarianceTable"><span class="hs-identifier hs-type">VarianceTable</span></a></span><span>
</span><span id="line-517"></span><span id="varianceInStms"><span class="annot"><span class="annottext">varianceInStms :: VarianceTable -&gt; Stms GPU -&gt; VarianceTable
</span><a href="Futhark.Pass.KernelBabysitting.html#varianceInStms"><span class="hs-identifier hs-var hs-var">varianceInStms</span></a></span></span><span> </span><span id="local-6989586621684417434"><span class="annot"><span class="annottext">VarianceTable
</span><a href="#local-6989586621684417434"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VarianceTable -&gt; Stm GPU -&gt; VarianceTable)
-&gt; VarianceTable -&gt; [Stm GPU] -&gt; VarianceTable
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl</span></span><span> </span><span class="annot"><span class="annottext">VarianceTable -&gt; Stm GPU -&gt; VarianceTable
</span><a href="Futhark.Pass.KernelBabysitting.html#varianceInStm"><span class="hs-identifier hs-var">varianceInStm</span></a></span><span> </span><span class="annot"><span class="annottext">VarianceTable
</span><a href="#local-6989586621684417434"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">([Stm GPU] -&gt; VarianceTable)
-&gt; (Stms GPU -&gt; [Stm GPU]) -&gt; Stms GPU -&gt; VarianceTable
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Stms GPU -&gt; [Stm GPU]
forall rep. Stms rep -&gt; [Stm rep]
</span><a href="Futhark.IR.Syntax.html#stmsToList"><span class="hs-identifier hs-var">stmsToList</span></a></span><span>
</span><span id="line-518"></span><span>
</span><span id="line-519"></span><span class="annot"><a href="Futhark.Pass.KernelBabysitting.html#varianceInStm"><span class="hs-identifier hs-type">varianceInStm</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Pass.KernelBabysitting.html#VarianceTable"><span class="hs-identifier hs-type">VarianceTable</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.KernelBabysitting.html#VarianceTable"><span class="hs-identifier hs-type">VarianceTable</span></a></span><span>
</span><span id="line-520"></span><span id="varianceInStm"><span class="annot"><span class="annottext">varianceInStm :: VarianceTable -&gt; Stm GPU -&gt; VarianceTable
</span><a href="Futhark.Pass.KernelBabysitting.html#varianceInStm"><span class="hs-identifier hs-var hs-var">varianceInStm</span></a></span></span><span> </span><span id="local-6989586621684417432"><span class="annot"><span class="annottext">VarianceTable
</span><a href="#local-6989586621684417432"><span class="hs-identifier hs-var">variance</span></a></span></span><span> </span><span id="local-6989586621684417431"><span class="annot"><span class="annottext">Stm GPU
</span><a href="#local-6989586621684417431"><span class="hs-identifier hs-var">stm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-521"></span><span>  </span><span class="annot"><span class="annottext">(VarianceTable -&gt; VName -&gt; VarianceTable)
-&gt; VarianceTable -&gt; [VName] -&gt; VarianceTable
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span> </span><span class="annot"><span class="annottext">VarianceTable -&gt; VName -&gt; VarianceTable
</span><a href="#local-6989586621684417429"><span class="hs-identifier hs-var">add</span></a></span><span> </span><span class="annot"><span class="annottext">VarianceTable
</span><a href="#local-6989586621684417432"><span class="hs-identifier hs-var">variance</span></a></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; VarianceTable) -&gt; [VName] -&gt; VarianceTable
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatT Type -&gt; [VName]
forall dec. PatT dec -&gt; [VName]
</span><a href="Futhark.IR.Prop.Patterns.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="annot"><span class="annottext">(PatT Type -&gt; [VName]) -&gt; PatT Type -&gt; [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stm GPU -&gt; Pat GPU
forall rep. Stm rep -&gt; Pat rep
</span><a href="Futhark.IR.Syntax.html#stmPat"><span class="hs-identifier hs-var hs-var">stmPat</span></a></span><span> </span><span class="annot"><span class="annottext">Stm GPU
</span><a href="#local-6989586621684417431"><span class="hs-identifier hs-var">stm</span></a></span><span>
</span><span id="line-522"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-523"></span><span>    </span><span id="local-6989586621684417429"><span class="annot"><span class="annottext">add :: VarianceTable -&gt; VName -&gt; VarianceTable
</span><a href="#local-6989586621684417429"><span class="hs-identifier hs-var hs-var">add</span></a></span></span><span> </span><span id="local-6989586621684417427"><span class="annot"><span class="annottext">VarianceTable
</span><a href="#local-6989586621684417427"><span class="hs-identifier hs-var">variance'</span></a></span></span><span> </span><span id="local-6989586621684417426"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417426"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Names -&gt; VarianceTable -&gt; VarianceTable
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417426"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684417425"><span class="hs-identifier hs-var">binding_variance</span></a></span><span> </span><span class="annot"><span class="annottext">VarianceTable
</span><a href="#local-6989586621684417427"><span class="hs-identifier hs-var">variance'</span></a></span><span>
</span><span id="line-524"></span><span>    </span><span id="local-6989586621684417421"><span class="annot"><span class="annottext">look :: VarianceTable -&gt; VName -&gt; Names
</span><a href="#local-6989586621684417421"><span class="hs-identifier hs-var hs-var">look</span></a></span></span><span> </span><span id="local-6989586621684417420"><span class="annot"><span class="annottext">VarianceTable
</span><a href="#local-6989586621684417420"><span class="hs-identifier hs-var">variance'</span></a></span></span><span> </span><span id="local-6989586621684417419"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417419"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#oneName"><span class="hs-identifier hs-var">oneName</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417419"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Names -&gt; VName -&gt; VarianceTable -&gt; Names
forall k a. Ord k =&gt; a -&gt; k -&gt; Map k a -&gt; a
</span><span class="hs-identifier hs-var">M.findWithDefault</span></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684417419"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">VarianceTable
</span><a href="#local-6989586621684417420"><span class="hs-identifier hs-var">variance'</span></a></span><span>
</span><span id="line-525"></span><span>    </span><span id="local-6989586621684417425"><span class="annot"><span class="annottext">binding_variance :: Names
</span><a href="#local-6989586621684417425"><span class="hs-identifier hs-var hs-var">binding_variance</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Names] -&gt; Names
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">([Names] -&gt; Names) -&gt; [Names] -&gt; Names
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Names) -&gt; [VName] -&gt; [Names]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarianceTable -&gt; VName -&gt; Names
</span><a href="#local-6989586621684417421"><span class="hs-identifier hs-var">look</span></a></span><span> </span><span class="annot"><span class="annottext">VarianceTable
</span><a href="#local-6989586621684417432"><span class="hs-identifier hs-var">variance</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; [Names]) -&gt; [VName] -&gt; [Names]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Names -&gt; [VName]
</span><a href="Futhark.IR.Prop.Names.html#namesToList"><span class="hs-identifier hs-var">namesToList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stm GPU -&gt; Names
forall a. FreeIn a =&gt; a -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#freeIn"><span class="hs-identifier hs-var">freeIn</span></a></span><span> </span><span class="annot"><span class="annottext">Stm GPU
</span><a href="#local-6989586621684417431"><span class="hs-identifier hs-var">stm</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-526"></span></pre></body></html>