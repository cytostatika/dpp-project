<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE ConstraintKinds #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE FlexibleInstances #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE MultiParamTypeClasses #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-8"></span><span>
</span><span id="line-9"></span><span class="hs-comment">-- | The simplification engine is only willing to hoist allocations</span><span>
</span><span id="line-10"></span><span class="hs-comment">-- out of loops if the memory block resulting from the allocation is</span><span>
</span><span id="line-11"></span><span class="hs-comment">-- dead at the end of the loop.  If it is not, we may cause data</span><span>
</span><span id="line-12"></span><span class="hs-comment">-- hazards.</span><span>
</span><span id="line-13"></span><span class="hs-comment">--</span><span>
</span><span id="line-14"></span><span class="hs-comment">-- This pass tries to rewrite loops with memory parameters.</span><span>
</span><span id="line-15"></span><span class="hs-comment">-- Specifically, it takes loops of this form:</span><span>
</span><span id="line-16"></span><span class="hs-comment">--</span><span>
</span><span id="line-17"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-18"></span><span class="hs-comment">-- loop {..., A_mem, ..., A, ...} ... do {</span><span>
</span><span id="line-19"></span><span class="hs-comment">--   ...</span><span>
</span><span id="line-20"></span><span class="hs-comment">--   let A_out_mem = alloc(...) -- stores A_out</span><span>
</span><span id="line-21"></span><span class="hs-comment">--   in {..., A_out_mem, ..., A_out, ...}</span><span>
</span><span id="line-22"></span><span class="hs-comment">-- }</span><span>
</span><span id="line-23"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-24"></span><span class="hs-comment">--</span><span>
</span><span id="line-25"></span><span class="hs-comment">-- and turns them into</span><span>
</span><span id="line-26"></span><span class="hs-comment">--</span><span>
</span><span id="line-27"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-28"></span><span class="hs-comment">-- let A_in_mem = alloc(...)</span><span>
</span><span id="line-29"></span><span class="hs-comment">-- let A_out_mem = alloc(...)</span><span>
</span><span id="line-30"></span><span class="hs-comment">-- let A_in = copy A -- in A_in_mem</span><span>
</span><span id="line-31"></span><span class="hs-comment">-- loop {..., A_in_mem, A_out_mem, ..., A=A_in, ...} ... do {</span><span>
</span><span id="line-32"></span><span class="hs-comment">--   ...</span><span>
</span><span id="line-33"></span><span class="hs-comment">--   in {..., A_out_mem, A_mem, ..., A_out, ...}</span><span>
</span><span id="line-34"></span><span class="hs-comment">-- }</span><span>
</span><span id="line-35"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-36"></span><span class="hs-comment">--</span><span>
</span><span id="line-37"></span><span class="hs-comment">-- The result is essentially &quot;pointer swapping&quot; between the two memory</span><span>
</span><span id="line-38"></span><span class="hs-comment">-- initial blocks @A_mem@ and @A_out_mem@.  The invariant is that the</span><span>
</span><span id="line-39"></span><span class="hs-comment">-- array is always stored in the &quot;first&quot; memory block at the beginning</span><span>
</span><span id="line-40"></span><span class="hs-comment">-- of the loop (and also in the final result).  We do need to add an</span><span>
</span><span id="line-41"></span><span class="hs-comment">-- extra element to the pattern, however.  The initial copy of @A@</span><span>
</span><span id="line-42"></span><span class="hs-comment">-- could be elided if @A@ is unique (thus @A_in_mem=A_mem@).  This is</span><span>
</span><span id="line-43"></span><span class="hs-comment">-- because only then is it safe to use @A_mem@ to store loop results.</span><span>
</span><span id="line-44"></span><span class="hs-comment">-- We don't currently do this.</span><span>
</span><span id="line-45"></span><span class="hs-comment">--</span><span>
</span><span id="line-46"></span><span class="hs-comment">-- Unfortunately, not all loops fit the pattern above.  In particular,</span><span>
</span><span id="line-47"></span><span class="hs-comment">-- a nested loop that has been transformed as such does not!</span><span>
</span><span id="line-48"></span><span class="hs-comment">-- Therefore we also have another double buffering strategy, that</span><span>
</span><span id="line-49"></span><span class="hs-comment">-- turns</span><span>
</span><span id="line-50"></span><span class="hs-comment">--</span><span>
</span><span id="line-51"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-52"></span><span class="hs-comment">-- loop {..., A_mem, ..., A, ...} ... do {</span><span>
</span><span id="line-53"></span><span class="hs-comment">--   ...</span><span>
</span><span id="line-54"></span><span class="hs-comment">--   let A_out_mem = alloc(...)</span><span>
</span><span id="line-55"></span><span class="hs-comment">--   -- A in A_out_mem</span><span>
</span><span id="line-56"></span><span class="hs-comment">--   in {..., A_out_mem, ..., A, ...}</span><span>
</span><span id="line-57"></span><span class="hs-comment">-- }</span><span>
</span><span id="line-58"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-59"></span><span class="hs-comment">--</span><span>
</span><span id="line-60"></span><span class="hs-comment">-- into</span><span>
</span><span id="line-61"></span><span class="hs-comment">--</span><span>
</span><span id="line-62"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-63"></span><span class="hs-comment">-- let A_res_mem = alloc(...)</span><span>
</span><span id="line-64"></span><span class="hs-comment">-- loop {..., A_mem, ..., A, ...} ... do {</span><span>
</span><span id="line-65"></span><span class="hs-comment">--   ...</span><span>
</span><span id="line-66"></span><span class="hs-comment">--   let A_out_mem = alloc(...)</span><span>
</span><span id="line-67"></span><span class="hs-comment">--   -- A in A_out_mem</span><span>
</span><span id="line-68"></span><span class="hs-comment">--   let A' = copy A</span><span>
</span><span id="line-69"></span><span class="hs-comment">--   -- A' in A_res_mem</span><span>
</span><span id="line-70"></span><span class="hs-comment">--   in {..., A_res_mem, ..., A, ...}</span><span>
</span><span id="line-71"></span><span class="hs-comment">-- }</span><span>
</span><span id="line-72"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-73"></span><span class="hs-comment">--</span><span>
</span><span id="line-74"></span><span class="hs-comment">-- The allocation of A_out_mem can then be hoisted out because it is</span><span>
</span><span id="line-75"></span><span class="hs-comment">-- dead at the end of the loop.  This always works as long as</span><span>
</span><span id="line-76"></span><span class="hs-comment">-- A_out_mem has a loop-invariant allocation size, but requires a copy</span><span>
</span><span id="line-77"></span><span class="hs-comment">-- per iteration (and an initial one, elided above).</span><span>
</span><span id="line-78"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Futhark.Optimise.DoubleBuffer</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#doubleBufferGPU"><span class="hs-identifier">doubleBufferGPU</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#doubleBufferMC"><span class="hs-identifier">doubleBufferMC</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-79"></span><span>
</span><span id="line-80"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Reader</span></span><span>
</span><span id="line-81"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.State</span></span><span>
</span><span id="line-82"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Writer</span></span><span>
</span><span id="line-83"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Bifunctor</span></span><span>
</span><span id="line-84"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">find</span></span><span class="hs-special">)</span><span>
</span><span id="line-85"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map.Strict</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-86"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span>
</span><span id="line-87"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Construct.html"><span class="hs-identifier">Futhark.Construct</span></a></span><span>
</span><span id="line-88"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html"><span class="hs-identifier">Futhark.IR.GPUMem</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">GPU</span></span><span>
</span><span id="line-89"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html"><span class="hs-identifier">Futhark.IR.MCMem</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">MC</span></span><span>
</span><span id="line-90"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html"><span class="hs-identifier">Futhark.IR.Mem.IxFun</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">IxFun</span></span><span>
</span><span id="line-91"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Pass.html"><span class="hs-identifier">Futhark.Pass</span></a></span><span>
</span><span id="line-92"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html"><span class="hs-identifier">Futhark.Pass.ExplicitAllocations</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#arraySizeInBytesExp"><span class="hs-identifier">arraySizeInBytesExp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-93"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.GPU.html"><span class="hs-identifier">Futhark.Pass.ExplicitAllocations.GPU</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-94"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Transform.Substitute.html"><span class="hs-identifier">Futhark.Transform.Substitute</span></a></span><span>
</span><span id="line-95"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Util.html"><span class="hs-identifier">Futhark.Util</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Util.html#mapAccumLM"><span class="hs-identifier">mapAccumLM</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Util.html#maybeHead"><span class="hs-identifier">maybeHead</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-96"></span><span>
</span><span id="line-97"></span><span class="hs-comment">-- | The pass for GPU kernels.</span><span>
</span><span id="line-98"></span><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#doubleBufferGPU"><span class="hs-identifier hs-type">doubleBufferGPU</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Pass.html#Pass"><span class="hs-identifier hs-type">Pass</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span>
</span><span id="line-99"></span><span id="doubleBufferGPU"><span class="annot"><span class="annottext">doubleBufferGPU :: Pass GPUMem GPUMem
</span><a href="Futhark.Optimise.DoubleBuffer.html#doubleBufferGPU"><span class="hs-identifier hs-var hs-var">doubleBufferGPU</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OptimiseOp GPUMem -&gt; Pass GPUMem GPUMem
forall rep inner. Mem rep inner =&gt; OptimiseOp rep -&gt; Pass rep rep
</span><a href="Futhark.Optimise.DoubleBuffer.html#doubleBuffer"><span class="hs-identifier hs-var">doubleBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">OptimiseOp GPUMem
</span><a href="Futhark.Optimise.DoubleBuffer.html#optimiseGPUOp"><span class="hs-identifier hs-var">optimiseGPUOp</span></a></span><span>
</span><span id="line-100"></span><span>
</span><span id="line-101"></span><span class="hs-comment">-- | The pass for multicore</span><span>
</span><span id="line-102"></span><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#doubleBufferMC"><span class="hs-identifier hs-type">doubleBufferMC</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Pass.html#Pass"><span class="hs-identifier hs-type">Pass</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span>
</span><span id="line-103"></span><span id="doubleBufferMC"><span class="annot"><span class="annottext">doubleBufferMC :: Pass MCMem MCMem
</span><a href="Futhark.Optimise.DoubleBuffer.html#doubleBufferMC"><span class="hs-identifier hs-var hs-var">doubleBufferMC</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OptimiseOp MCMem -&gt; Pass MCMem MCMem
forall rep inner. Mem rep inner =&gt; OptimiseOp rep -&gt; Pass rep rep
</span><a href="Futhark.Optimise.DoubleBuffer.html#doubleBuffer"><span class="hs-identifier hs-var">doubleBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">OptimiseOp MCMem
</span><a href="Futhark.Optimise.DoubleBuffer.html#optimiseMCOp"><span class="hs-identifier hs-var">optimiseMCOp</span></a></span><span>
</span><span id="line-104"></span><span>
</span><span id="line-105"></span><span class="hs-comment">-- | The double buffering pass definition.</span><span>
</span><span id="line-106"></span><span id="local-6989586621684445623"><span id="local-6989586621684445624"><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#doubleBuffer"><span class="hs-identifier hs-type">doubleBuffer</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#Mem"><span class="hs-identifier hs-type">Mem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445624"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445623"><span class="hs-identifier hs-type">inner</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#OptimiseOp"><span class="hs-identifier hs-type">OptimiseOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445624"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.html#Pass"><span class="hs-identifier hs-type">Pass</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445624"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445624"><span class="hs-identifier hs-type">rep</span></a></span></span></span><span>
</span><span id="line-107"></span><span id="doubleBuffer"><span class="annot"><span class="annottext">doubleBuffer :: forall rep inner. Mem rep inner =&gt; OptimiseOp rep -&gt; Pass rep rep
</span><a href="Futhark.Optimise.DoubleBuffer.html#doubleBuffer"><span class="hs-identifier hs-var hs-var">doubleBuffer</span></a></span></span><span> </span><span id="local-6989586621684445008"><span class="annot"><span class="annottext">OptimiseOp rep
</span><a href="#local-6989586621684445008"><span class="hs-identifier hs-var">onOp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-108"></span><span>  </span><span class="annot"><span class="annottext">Pass :: forall fromrep torep.
String
-&gt; String
-&gt; (Prog fromrep -&gt; PassM (Prog torep))
-&gt; Pass fromrep torep
</span><a href="Futhark.Pass.html#Pass"><span class="hs-identifier hs-type">Pass</span></a></span><span>
</span><span id="line-109"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">passName :: String
</span><a href="Futhark.Pass.html#passName"><span class="hs-identifier hs-var">passName</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Double buffer&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-110"></span><span>      </span><span class="annot"><span class="annottext">passDescription :: String
</span><a href="Futhark.Pass.html#passDescription"><span class="hs-identifier hs-var">passDescription</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Perform double buffering for merge parameters of sequential loops.&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-111"></span><span>      </span><span class="annot"><span class="annottext">passFunction :: Prog rep -&gt; PassM (Prog rep)
</span><a href="Futhark.Pass.html#passFunction"><span class="hs-identifier hs-var">passFunction</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Scope rep -&gt; Stms rep -&gt; PassM (Stms rep))
-&gt; Prog rep -&gt; PassM (Prog rep)
forall rep.
(Scope rep -&gt; Stms rep -&gt; PassM (Stms rep))
-&gt; Prog rep -&gt; PassM (Prog rep)
</span><a href="Futhark.Pass.html#intraproceduralTransformation"><span class="hs-identifier hs-var">intraproceduralTransformation</span></a></span><span> </span><span class="annot"><span class="annottext">Scope rep -&gt; Stms rep -&gt; PassM (Stms rep)
</span><a href="#local-6989586621684445002"><span class="hs-identifier hs-var">optimise</span></a></span><span>
</span><span id="line-112"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-113"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-114"></span><span>    </span><span id="local-6989586621684445002"><span class="annot"><span class="annottext">optimise :: Scope rep -&gt; Stms rep -&gt; PassM (Stms rep)
</span><a href="#local-6989586621684445002"><span class="hs-identifier hs-var hs-var">optimise</span></a></span></span><span> </span><span id="local-6989586621684445001"><span class="annot"><span class="annottext">Scope rep
</span><a href="#local-6989586621684445001"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span id="local-6989586621684445000"><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684445000"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VNameSource -&gt; (Stms rep, VNameSource)) -&gt; PassM (Stms rep)
forall (m :: * -&gt; *) a.
MonadFreshNames m =&gt;
(VNameSource -&gt; (a, VNameSource)) -&gt; m a
</span><a href="Futhark.MonadFreshNames.html#modifyNameSource"><span class="hs-identifier hs-var">modifyNameSource</span></a></span><span> </span><span class="annot"><span class="annottext">((VNameSource -&gt; (Stms rep, VNameSource)) -&gt; PassM (Stms rep))
-&gt; (VNameSource -&gt; (Stms rep, VNameSource)) -&gt; PassM (Stms rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684444998"><span class="annot"><span class="annottext">VNameSource
</span><a href="#local-6989586621684444998"><span class="hs-identifier hs-var">src</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-115"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684444997"><span class="annot"><span class="annottext">m :: ReaderT (Env rep) (State VNameSource) (Stms rep)
</span><a href="#local-6989586621684444997"><span class="hs-identifier hs-var hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-116"></span><span>            </span><span class="annot"><span class="annottext">DoubleBufferM rep (Stms rep)
-&gt; ReaderT (Env rep) (State VNameSource) (Stms rep)
forall rep a.
DoubleBufferM rep a -&gt; ReaderT (Env rep) (State VNameSource) a
</span><a href="Futhark.Optimise.DoubleBuffer.html#runDoubleBufferM"><span class="hs-identifier hs-var hs-var">runDoubleBufferM</span></a></span><span> </span><span class="annot"><span class="annottext">(DoubleBufferM rep (Stms rep)
 -&gt; ReaderT (Env rep) (State VNameSource) (Stms rep))
-&gt; DoubleBufferM rep (Stms rep)
-&gt; ReaderT (Env rep) (State VNameSource) (Stms rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Scope rep
-&gt; DoubleBufferM rep (Stms rep) -&gt; DoubleBufferM rep (Stms rep)
forall rep (m :: * -&gt; *) a.
LocalScope rep m =&gt;
Scope rep -&gt; m a -&gt; m a
</span><a href="Futhark.IR.Prop.Scope.html#localScope"><span class="hs-identifier hs-var">localScope</span></a></span><span> </span><span class="annot"><span class="annottext">Scope rep
</span><a href="#local-6989586621684445001"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="annot"><span class="annottext">(DoubleBufferM rep (Stms rep) -&gt; DoubleBufferM rep (Stms rep))
-&gt; DoubleBufferM rep (Stms rep) -&gt; DoubleBufferM rep (Stms rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Stm rep] -&gt; DoubleBufferM rep (Stms rep)
forall rep. ASTRep rep =&gt; [Stm rep] -&gt; DoubleBufferM rep (Stms rep)
</span><a href="Futhark.Optimise.DoubleBuffer.html#optimiseStms"><span class="hs-identifier hs-var">optimiseStms</span></a></span><span> </span><span class="annot"><span class="annottext">([Stm rep] -&gt; DoubleBufferM rep (Stms rep))
-&gt; [Stm rep] -&gt; DoubleBufferM rep (Stms rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stms rep -&gt; [Stm rep]
forall rep. Stms rep -&gt; [Stm rep]
</span><a href="Futhark.IR.Syntax.html#stmsToList"><span class="hs-identifier hs-var">stmsToList</span></a></span><span> </span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684445000"><span class="hs-identifier hs-var">stms</span></a></span><span>
</span><span id="line-117"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">State VNameSource (Stms rep)
-&gt; VNameSource -&gt; (Stms rep, VNameSource)
forall s a. State s a -&gt; s -&gt; (a, s)
</span><span class="hs-identifier hs-var">runState</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ReaderT (Env rep) (State VNameSource) (Stms rep)
-&gt; Env rep -&gt; State VNameSource (Stms rep)
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var hs-var">runReaderT</span></span><span> </span><span class="annot"><span class="annottext">ReaderT (Env rep) (State VNameSource) (Stms rep)
</span><a href="#local-6989586621684444997"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">Env rep
</span><a href="#local-6989586621684444990"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VNameSource
</span><a href="#local-6989586621684444998"><span class="hs-identifier hs-var">src</span></a></span><span>
</span><span id="line-118"></span><span>
</span><span id="line-119"></span><span>    </span><span id="local-6989586621684444990"><span class="annot"><span class="annottext">env :: Env rep
</span><a href="#local-6989586621684444990"><span class="hs-identifier hs-var hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Scope rep -&gt; OptimiseLoop rep -&gt; OptimiseOp rep -&gt; Env rep
forall rep.
Scope rep -&gt; OptimiseLoop rep -&gt; OptimiseOp rep -&gt; Env rep
</span><a href="Futhark.Optimise.DoubleBuffer.html#Env"><span class="hs-identifier hs-var">Env</span></a></span><span> </span><span class="annot"><span class="annottext">Scope rep
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">OptimiseLoop rep
forall {f :: * -&gt; *} {a} {b} {c} {d}.
(Applicative f, Monoid a) =&gt;
b -&gt; c -&gt; d -&gt; f (a, b, c, d)
</span><a href="#local-6989586621684444988"><span class="hs-identifier hs-var">doNotTouchLoop</span></a></span><span> </span><span class="annot"><span class="annottext">OptimiseOp rep
</span><a href="#local-6989586621684445008"><span class="hs-identifier hs-var">onOp</span></a></span><span>
</span><span id="line-120"></span><span>    </span><span id="local-6989586621684444988"><span class="annot"><span class="annottext">doNotTouchLoop :: b -&gt; c -&gt; d -&gt; f (a, b, c, d)
</span><a href="#local-6989586621684444988"><span class="hs-identifier hs-var hs-var">doNotTouchLoop</span></a></span></span><span> </span><span id="local-6989586621684444983"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684444983"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684444982"><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621684444982"><span class="hs-identifier hs-var">merge</span></a></span></span><span> </span><span id="local-6989586621684444981"><span class="annot"><span class="annottext">d
</span><a href="#local-6989586621684444981"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(a, b, c, d) -&gt; f (a, b, c, d)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684444983"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621684444982"><span class="hs-identifier hs-var">merge</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">d
</span><a href="#local-6989586621684444981"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-121"></span><span>
</span><span id="line-122"></span><span class="hs-keyword">type</span><span> </span><span id="OptimiseLoop"><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#OptimiseLoop"><span class="hs-identifier hs-var">OptimiseLoop</span></a></span></span><span> </span><span id="local-6989586621684444980"><span class="annot"><a href="#local-6989586621684444980"><span class="hs-identifier hs-type">rep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-123"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684444980"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-124"></span><span>  </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#FParam"><span class="hs-identifier hs-type">FParam</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684444980"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-125"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684444980"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-126"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#DoubleBufferM"><span class="hs-identifier hs-type">DoubleBufferM</span></a></span><span>
</span><span id="line-127"></span><span>    </span><span class="annot"><a href="#local-6989586621684444980"><span class="hs-identifier hs-type">rep</span></a></span><span>
</span><span id="line-128"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684444980"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-129"></span><span>      </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684444980"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-130"></span><span>      </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#FParam"><span class="hs-identifier hs-type">FParam</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684444980"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><span id="line-131"></span><span>      </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684444980"><span class="hs-identifier hs-type">rep</span></a></span><span>
</span><span id="line-132"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-133"></span><span>
</span><span id="line-134"></span><span class="hs-keyword">type</span><span> </span><span id="OptimiseOp"><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#OptimiseOp"><span class="hs-identifier hs-var">OptimiseOp</span></a></span></span><span> </span><span id="local-6989586621684444979"><span class="annot"><a href="#local-6989586621684444979"><span class="hs-identifier hs-type">rep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-135"></span><span>  </span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684444979"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#DoubleBufferM"><span class="hs-identifier hs-type">DoubleBufferM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684444979"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684444979"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-136"></span><span>
</span><span id="line-137"></span><span class="hs-keyword">data</span><span> </span><span id="Env"><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#Env"><span class="hs-identifier hs-var">Env</span></a></span></span><span> </span><span id="local-6989586621684445576"><span class="annot"><a href="#local-6989586621684445576"><span class="hs-identifier hs-type">rep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Env"><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#Env"><span class="hs-identifier hs-var">Env</span></a></span></span><span>
</span><span id="line-138"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="envScope"><span class="annot"><span class="annottext">forall rep. Env rep -&gt; Scope rep
</span><a href="Futhark.Optimise.DoubleBuffer.html#envScope"><span class="hs-identifier hs-var hs-var">envScope</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445576"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-139"></span><span>    </span><span id="envOptimiseLoop"><span class="annot"><span class="annottext">forall rep. Env rep -&gt; OptimiseLoop rep
</span><a href="Futhark.Optimise.DoubleBuffer.html#envOptimiseLoop"><span class="hs-identifier hs-var hs-var">envOptimiseLoop</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#OptimiseLoop"><span class="hs-identifier hs-type">OptimiseLoop</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445576"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-140"></span><span>    </span><span id="envOptimiseOp"><span class="annot"><span class="annottext">forall rep. Env rep -&gt; OptimiseOp rep
</span><a href="Futhark.Optimise.DoubleBuffer.html#envOptimiseOp"><span class="hs-identifier hs-var hs-var">envOptimiseOp</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#OptimiseOp"><span class="hs-identifier hs-type">OptimiseOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445576"><span class="hs-identifier hs-type">rep</span></a></span><span>
</span><span id="line-141"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-142"></span><span>
</span><span id="line-143"></span><span class="hs-keyword">newtype</span><span> </span><span id="DoubleBufferM"><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#DoubleBufferM"><span class="hs-identifier hs-var">DoubleBufferM</span></a></span></span><span> </span><span id="local-6989586621684445627"><span class="annot"><a href="#local-6989586621684445627"><span class="hs-identifier hs-type">rep</span></a></span></span><span> </span><span id="local-6989586621684445589"><span class="annot"><a href="#local-6989586621684445589"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="DoubleBufferM"><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#DoubleBufferM"><span class="hs-identifier hs-var">DoubleBufferM</span></a></span></span><span>
</span><span id="line-144"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="runDoubleBufferM"><span class="annot"><span class="annottext">forall rep a.
DoubleBufferM rep a -&gt; ReaderT (Env rep) (State VNameSource) a
</span><a href="Futhark.Optimise.DoubleBuffer.html#runDoubleBufferM"><span class="hs-identifier hs-var hs-var">runDoubleBufferM</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ReaderT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445627"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">State</span></span><span> </span><span class="annot"><a href="Futhark.FreshNames.html#VNameSource"><span class="hs-identifier hs-type">VNameSource</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621684445589"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-145"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-146"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684444967"><span id="local-6989586621684444973"><span class="annot"><span class="annottext">(forall a b.
 (a -&gt; b) -&gt; DoubleBufferM rep a -&gt; DoubleBufferM rep b)
-&gt; (forall a b. a -&gt; DoubleBufferM rep b -&gt; DoubleBufferM rep a)
-&gt; Functor (DoubleBufferM rep)
forall a b. a -&gt; DoubleBufferM rep b -&gt; DoubleBufferM rep a
forall a b. (a -&gt; b) -&gt; DoubleBufferM rep a -&gt; DoubleBufferM rep b
forall rep a b. a -&gt; DoubleBufferM rep b -&gt; DoubleBufferM rep a
forall rep a b.
(a -&gt; b) -&gt; DoubleBufferM rep a -&gt; DoubleBufferM rep b
forall (f :: * -&gt; *).
(forall a b. (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b. a -&gt; f b -&gt; f a) -&gt; Functor f
&lt;$ :: forall a b. a -&gt; DoubleBufferM rep b -&gt; DoubleBufferM rep a
$c&lt;$ :: forall rep a b. a -&gt; DoubleBufferM rep b -&gt; DoubleBufferM rep a
fmap :: forall a b. (a -&gt; b) -&gt; DoubleBufferM rep a -&gt; DoubleBufferM rep b
$cfmap :: forall rep a b.
(a -&gt; b) -&gt; DoubleBufferM rep a -&gt; DoubleBufferM rep b
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Functor</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684444934"><span id="local-6989586621684444939"><span id="local-6989586621684444944"><span id="local-6989586621684444949"><span id="local-6989586621684444955"><span class="annot"><span class="annottext">Functor (DoubleBufferM rep)
Functor (DoubleBufferM rep)
-&gt; (forall a. a -&gt; DoubleBufferM rep a)
-&gt; (forall a b.
    DoubleBufferM rep (a -&gt; b)
    -&gt; DoubleBufferM rep a -&gt; DoubleBufferM rep b)
-&gt; (forall a b c.
    (a -&gt; b -&gt; c)
    -&gt; DoubleBufferM rep a
    -&gt; DoubleBufferM rep b
    -&gt; DoubleBufferM rep c)
-&gt; (forall a b.
    DoubleBufferM rep a -&gt; DoubleBufferM rep b -&gt; DoubleBufferM rep b)
-&gt; (forall a b.
    DoubleBufferM rep a -&gt; DoubleBufferM rep b -&gt; DoubleBufferM rep a)
-&gt; Applicative (DoubleBufferM rep)
forall rep. Functor (DoubleBufferM rep)
forall a. a -&gt; DoubleBufferM rep a
forall rep a. a -&gt; DoubleBufferM rep a
forall a b.
DoubleBufferM rep a -&gt; DoubleBufferM rep b -&gt; DoubleBufferM rep a
forall a b.
DoubleBufferM rep a -&gt; DoubleBufferM rep b -&gt; DoubleBufferM rep b
forall a b.
DoubleBufferM rep (a -&gt; b)
-&gt; DoubleBufferM rep a -&gt; DoubleBufferM rep b
forall rep a b.
DoubleBufferM rep a -&gt; DoubleBufferM rep b -&gt; DoubleBufferM rep a
forall rep a b.
DoubleBufferM rep a -&gt; DoubleBufferM rep b -&gt; DoubleBufferM rep b
forall rep a b.
DoubleBufferM rep (a -&gt; b)
-&gt; DoubleBufferM rep a -&gt; DoubleBufferM rep b
forall a b c.
(a -&gt; b -&gt; c)
-&gt; DoubleBufferM rep a
-&gt; DoubleBufferM rep b
-&gt; DoubleBufferM rep c
forall rep a b c.
(a -&gt; b -&gt; c)
-&gt; DoubleBufferM rep a
-&gt; DoubleBufferM rep b
-&gt; DoubleBufferM rep c
forall (f :: * -&gt; *).
Functor f
-&gt; (forall a. a -&gt; f a)
-&gt; (forall a b. f (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b c. (a -&gt; b -&gt; c) -&gt; f a -&gt; f b -&gt; f c)
-&gt; (forall a b. f a -&gt; f b -&gt; f b)
-&gt; (forall a b. f a -&gt; f b -&gt; f a)
-&gt; Applicative f
&lt;* :: forall a b.
DoubleBufferM rep a -&gt; DoubleBufferM rep b -&gt; DoubleBufferM rep a
$c&lt;* :: forall rep a b.
DoubleBufferM rep a -&gt; DoubleBufferM rep b -&gt; DoubleBufferM rep a
*&gt; :: forall a b.
DoubleBufferM rep a -&gt; DoubleBufferM rep b -&gt; DoubleBufferM rep b
$c*&gt; :: forall rep a b.
DoubleBufferM rep a -&gt; DoubleBufferM rep b -&gt; DoubleBufferM rep b
liftA2 :: forall a b c.
(a -&gt; b -&gt; c)
-&gt; DoubleBufferM rep a
-&gt; DoubleBufferM rep b
-&gt; DoubleBufferM rep c
$cliftA2 :: forall rep a b c.
(a -&gt; b -&gt; c)
-&gt; DoubleBufferM rep a
-&gt; DoubleBufferM rep b
-&gt; DoubleBufferM rep c
&lt;*&gt; :: forall a b.
DoubleBufferM rep (a -&gt; b)
-&gt; DoubleBufferM rep a -&gt; DoubleBufferM rep b
$c&lt;*&gt; :: forall rep a b.
DoubleBufferM rep (a -&gt; b)
-&gt; DoubleBufferM rep a -&gt; DoubleBufferM rep b
pure :: forall a. a -&gt; DoubleBufferM rep a
$cpure :: forall rep a. a -&gt; DoubleBufferM rep a
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Applicative</span></span></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684444903"><span id="local-6989586621684444908"><span id="local-6989586621684444914"><span class="annot"><span class="annottext">Applicative (DoubleBufferM rep)
Applicative (DoubleBufferM rep)
-&gt; (forall a b.
    DoubleBufferM rep a
    -&gt; (a -&gt; DoubleBufferM rep b) -&gt; DoubleBufferM rep b)
-&gt; (forall a b.
    DoubleBufferM rep a -&gt; DoubleBufferM rep b -&gt; DoubleBufferM rep b)
-&gt; (forall a. a -&gt; DoubleBufferM rep a)
-&gt; Monad (DoubleBufferM rep)
forall rep. Applicative (DoubleBufferM rep)
forall a. a -&gt; DoubleBufferM rep a
forall rep a. a -&gt; DoubleBufferM rep a
forall a b.
DoubleBufferM rep a -&gt; DoubleBufferM rep b -&gt; DoubleBufferM rep b
forall a b.
DoubleBufferM rep a
-&gt; (a -&gt; DoubleBufferM rep b) -&gt; DoubleBufferM rep b
forall rep a b.
DoubleBufferM rep a -&gt; DoubleBufferM rep b -&gt; DoubleBufferM rep b
forall rep a b.
DoubleBufferM rep a
-&gt; (a -&gt; DoubleBufferM rep b) -&gt; DoubleBufferM rep b
forall (m :: * -&gt; *).
Applicative m
-&gt; (forall a b. m a -&gt; (a -&gt; m b) -&gt; m b)
-&gt; (forall a b. m a -&gt; m b -&gt; m b)
-&gt; (forall a. a -&gt; m a)
-&gt; Monad m
return :: forall a. a -&gt; DoubleBufferM rep a
$creturn :: forall rep a. a -&gt; DoubleBufferM rep a
&gt;&gt; :: forall a b.
DoubleBufferM rep a -&gt; DoubleBufferM rep b -&gt; DoubleBufferM rep b
$c&gt;&gt; :: forall rep a b.
DoubleBufferM rep a -&gt; DoubleBufferM rep b -&gt; DoubleBufferM rep b
&gt;&gt;= :: forall a b.
DoubleBufferM rep a
-&gt; (a -&gt; DoubleBufferM rep b) -&gt; DoubleBufferM rep b
$c&gt;&gt;= :: forall rep a b.
DoubleBufferM rep a
-&gt; (a -&gt; DoubleBufferM rep b) -&gt; DoubleBufferM rep b
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Monad</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684444880"><span id="local-6989586621684444885"><span id="local-6989586621684444891"><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445627"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684444861"><span id="local-6989586621684444867"><span class="annot"><span class="annottext">Monad (DoubleBufferM rep)
Applicative (DoubleBufferM rep)
DoubleBufferM rep VNameSource
Applicative (DoubleBufferM rep)
-&gt; Monad (DoubleBufferM rep)
-&gt; DoubleBufferM rep VNameSource
-&gt; (VNameSource -&gt; DoubleBufferM rep ())
-&gt; MonadFreshNames (DoubleBufferM rep)
VNameSource -&gt; DoubleBufferM rep ()
forall rep. Monad (DoubleBufferM rep)
forall rep. Applicative (DoubleBufferM rep)
forall rep. DoubleBufferM rep VNameSource
forall rep. VNameSource -&gt; DoubleBufferM rep ()
forall (m :: * -&gt; *).
Applicative m
-&gt; Monad m
-&gt; m VNameSource
-&gt; (VNameSource -&gt; m ())
-&gt; MonadFreshNames m
putNameSource :: VNameSource -&gt; DoubleBufferM rep ()
$cputNameSource :: forall rep. VNameSource -&gt; DoubleBufferM rep ()
getNameSource :: DoubleBufferM rep VNameSource
$cgetNameSource :: forall rep. DoubleBufferM rep VNameSource
</span><a href="Futhark.MonadFreshNames.html#C%3AMonadFreshNames"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">MonadFreshNames</span></a></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-147"></span><span>
</span><span id="line-148"></span><span id="local-6989586621684445487"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621684444839"><span id="local-6989586621684444842"><span id="local-6989586621684444844"><span class="annot"><a href="Futhark.IR.Prop.html#ASTRep"><span class="hs-identifier hs-type">ASTRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445487"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#HasScope"><span class="hs-identifier hs-type">HasScope</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445487"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#DoubleBufferM"><span class="hs-identifier hs-type">DoubleBufferM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445487"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-149"></span><span>  </span><span id="local-6989586621684444836"><span class="annot"><span class="annottext">askScope :: DoubleBufferM rep (Scope rep)
</span><a href="Futhark.IR.Prop.Scope.html#askScope"><span class="hs-identifier hs-var hs-var hs-var hs-var">askScope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Env rep -&gt; Scope rep) -&gt; DoubleBufferM rep (Scope rep)
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">Env rep -&gt; Scope rep
forall rep. Env rep -&gt; Scope rep
</span><a href="Futhark.Optimise.DoubleBuffer.html#envScope"><span class="hs-identifier hs-var hs-var">envScope</span></a></span></span><span>
</span><span id="line-150"></span><span>
</span><span id="line-151"></span><span id="local-6989586621684445602"><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.html#ASTRep"><span class="hs-identifier hs-type">ASTRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445602"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#LocalScope"><span class="hs-identifier hs-type">LocalScope</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445602"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#DoubleBufferM"><span class="hs-identifier hs-type">DoubleBufferM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445602"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-152"></span><span>  </span><span id="local-6989586621684444822"><span class="annot"><span class="annottext">localScope :: forall a. Scope rep -&gt; DoubleBufferM rep a -&gt; DoubleBufferM rep a
</span><a href="#local-6989586621684444822"><span class="hs-identifier hs-var hs-var hs-var hs-var">localScope</span></a></span></span><span> </span><span id="local-6989586621684444821"><span class="annot"><span class="annottext">Scope rep
</span><a href="#local-6989586621684444821"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Env rep -&gt; Env rep) -&gt; DoubleBufferM rep a -&gt; DoubleBufferM rep a
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; r) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">local</span></span><span> </span><span class="annot"><span class="annottext">((Env rep -&gt; Env rep)
 -&gt; DoubleBufferM rep a -&gt; DoubleBufferM rep a)
-&gt; (Env rep -&gt; Env rep)
-&gt; DoubleBufferM rep a
-&gt; DoubleBufferM rep a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684444819"><span class="annot"><span class="annottext">Env rep
</span><a href="#local-6989586621684444819"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Env rep
</span><a href="#local-6989586621684444819"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">envScope :: Scope rep
</span><a href="Futhark.Optimise.DoubleBuffer.html#envScope"><span class="hs-identifier hs-var">envScope</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Env rep -&gt; Scope rep
forall rep. Env rep -&gt; Scope rep
</span><a href="Futhark.Optimise.DoubleBuffer.html#envScope"><span class="hs-identifier hs-var hs-var">envScope</span></a></span><span> </span><span class="annot"><span class="annottext">Env rep
</span><a href="#local-6989586621684444819"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Scope rep -&gt; Scope rep -&gt; Scope rep
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Scope rep
</span><a href="#local-6989586621684444821"><span class="hs-identifier hs-var">scope</span></a></span><span class="hs-special">}</span></span><span>
</span><span id="line-153"></span><span>
</span><span id="line-154"></span><span id="local-6989586621684445478"><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#optimiseBody"><span class="hs-identifier hs-type">optimiseBody</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.html#ASTRep"><span class="hs-identifier hs-type">ASTRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445478"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445478"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#DoubleBufferM"><span class="hs-identifier hs-type">DoubleBufferM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445478"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445478"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-155"></span><span id="optimiseBody"><span class="annot"><span class="annottext">optimiseBody :: forall rep. ASTRep rep =&gt; Body rep -&gt; DoubleBufferM rep (Body rep)
</span><a href="Futhark.Optimise.DoubleBuffer.html#optimiseBody"><span class="hs-identifier hs-var hs-var">optimiseBody</span></a></span></span><span> </span><span id="local-6989586621684444813"><span class="annot"><span class="annottext">Body rep
</span><a href="#local-6989586621684444813"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-156"></span><span>  </span><span id="local-6989586621684444812"><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684444812"><span class="hs-identifier hs-var">stms'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Stm rep] -&gt; DoubleBufferM rep (Stms rep)
forall rep. ASTRep rep =&gt; [Stm rep] -&gt; DoubleBufferM rep (Stms rep)
</span><a href="Futhark.Optimise.DoubleBuffer.html#optimiseStms"><span class="hs-identifier hs-var">optimiseStms</span></a></span><span> </span><span class="annot"><span class="annottext">([Stm rep] -&gt; DoubleBufferM rep (Stms rep))
-&gt; [Stm rep] -&gt; DoubleBufferM rep (Stms rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stms rep -&gt; [Stm rep]
forall rep. Stms rep -&gt; [Stm rep]
</span><a href="Futhark.IR.Syntax.html#stmsToList"><span class="hs-identifier hs-var">stmsToList</span></a></span><span> </span><span class="annot"><span class="annottext">(Stms rep -&gt; [Stm rep]) -&gt; Stms rep -&gt; [Stm rep]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Body rep -&gt; Stms rep
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">Body rep
</span><a href="#local-6989586621684444813"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-157"></span><span>  </span><span class="annot"><span class="annottext">Body rep -&gt; DoubleBufferM rep (Body rep)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Body rep -&gt; DoubleBufferM rep (Body rep))
-&gt; Body rep -&gt; DoubleBufferM rep (Body rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Body rep
</span><a href="#local-6989586621684444813"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">bodyStms :: Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var">bodyStms</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684444812"><span class="hs-identifier hs-var">stms'</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-158"></span><span>
</span><span id="line-159"></span><span id="local-6989586621684445584"><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#optimiseStms"><span class="hs-identifier hs-type">optimiseStms</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.html#ASTRep"><span class="hs-identifier hs-type">ASTRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445584"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445584"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#DoubleBufferM"><span class="hs-identifier hs-type">DoubleBufferM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445584"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445584"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-160"></span><span id="optimiseStms"><span class="annot"><span class="annottext">optimiseStms :: forall rep. ASTRep rep =&gt; [Stm rep] -&gt; DoubleBufferM rep (Stms rep)
</span><a href="Futhark.Optimise.DoubleBuffer.html#optimiseStms"><span class="hs-identifier hs-var hs-var">optimiseStms</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stms rep -&gt; DoubleBufferM rep (Stms rep)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Stms rep
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-161"></span><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#optimiseStms"><span class="hs-identifier hs-var">optimiseStms</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684444789"><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684444789"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684444788"><span class="annot"><span class="annottext">[Stm rep]
</span><a href="#local-6989586621684444788"><span class="hs-identifier hs-var">es</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-162"></span><span>  </span><span id="local-6989586621684444787"><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684444787"><span class="hs-identifier hs-var">e_es</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; DoubleBufferM rep (Stms rep)
forall rep. ASTRep rep =&gt; Stm rep -&gt; DoubleBufferM rep (Stms rep)
</span><a href="Futhark.Optimise.DoubleBuffer.html#optimiseStm"><span class="hs-identifier hs-var">optimiseStm</span></a></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684444789"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-163"></span><span>  </span><span id="local-6989586621684444785"><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684444785"><span class="hs-identifier hs-var">es'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Scope rep
-&gt; DoubleBufferM rep (Stms rep) -&gt; DoubleBufferM rep (Stms rep)
forall rep (m :: * -&gt; *) a.
LocalScope rep m =&gt;
Scope rep -&gt; m a -&gt; m a
</span><a href="Futhark.IR.Prop.Scope.html#localScope"><span class="hs-identifier hs-var">localScope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Scope rep -&gt; Scope rep
forall fromrep torep.
SameScope fromrep torep =&gt;
Scope fromrep -&gt; Scope torep
</span><a href="Futhark.IR.Prop.Scope.html#castScope"><span class="hs-identifier hs-var">castScope</span></a></span><span> </span><span class="annot"><span class="annottext">(Scope rep -&gt; Scope rep) -&gt; Scope rep -&gt; Scope rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stms rep -&gt; Scope rep
forall rep a. Scoped rep a =&gt; a -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOf"><span class="hs-identifier hs-var">scopeOf</span></a></span><span> </span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684444787"><span class="hs-identifier hs-var">e_es</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(DoubleBufferM rep (Stms rep) -&gt; DoubleBufferM rep (Stms rep))
-&gt; DoubleBufferM rep (Stms rep) -&gt; DoubleBufferM rep (Stms rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Stm rep] -&gt; DoubleBufferM rep (Stms rep)
forall rep. ASTRep rep =&gt; [Stm rep] -&gt; DoubleBufferM rep (Stms rep)
</span><a href="Futhark.Optimise.DoubleBuffer.html#optimiseStms"><span class="hs-identifier hs-var">optimiseStms</span></a></span><span> </span><span class="annot"><span class="annottext">[Stm rep]
</span><a href="#local-6989586621684444788"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-164"></span><span>  </span><span class="annot"><span class="annottext">Stms rep -&gt; DoubleBufferM rep (Stms rep)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Stms rep -&gt; DoubleBufferM rep (Stms rep))
-&gt; Stms rep -&gt; DoubleBufferM rep (Stms rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684444787"><span class="hs-identifier hs-var">e_es</span></a></span><span> </span><span class="annot"><span class="annottext">Stms rep -&gt; Stms rep -&gt; Stms rep
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684444785"><span class="hs-identifier hs-var">es'</span></a></span><span>
</span><span id="line-165"></span><span>
</span><span id="line-166"></span><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#optimiseStm"><span class="hs-identifier hs-type">optimiseStm</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621684445468"><span class="annot"><a href="#local-6989586621684445468"><span class="hs-identifier hs-type">rep</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.html#ASTRep"><span class="hs-identifier hs-type">ASTRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445468"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445468"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#DoubleBufferM"><span class="hs-identifier hs-type">DoubleBufferM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445468"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445468"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-167"></span><span id="optimiseStm"><span class="annot"><span class="annottext">optimiseStm :: forall rep. ASTRep rep =&gt; Stm rep -&gt; DoubleBufferM rep (Stms rep)
</span><a href="Futhark.Optimise.DoubleBuffer.html#optimiseStm"><span class="hs-identifier hs-var hs-var">optimiseStm</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684444756"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684444756"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684444755"><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><a href="#local-6989586621684444755"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#DoLoop"><span class="hs-identifier hs-type">DoLoop</span></a></span><span> </span><span id="local-6989586621684444753"><span class="annot"><span class="annottext">[(FParam rep, SubExp)]
</span><a href="#local-6989586621684444753"><span class="hs-identifier hs-var">merge</span></a></span></span><span> </span><span id="local-6989586621684444752"><span class="annot"><span class="annottext">LoopForm rep
</span><a href="#local-6989586621684444752"><span class="hs-identifier hs-var">form</span></a></span></span><span> </span><span id="local-6989586621684444751"><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684444751"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-168"></span><span>  </span><span id="local-6989586621684444750"><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684444750"><span class="hs-identifier hs-var">body'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-169"></span><span>    </span><span class="annot"><span class="annottext">Scope rep
-&gt; DoubleBufferM rep (BodyT rep) -&gt; DoubleBufferM rep (BodyT rep)
forall rep (m :: * -&gt; *) a.
LocalScope rep m =&gt;
Scope rep -&gt; m a -&gt; m a
</span><a href="Futhark.IR.Prop.Scope.html#localScope"><span class="hs-identifier hs-var">localScope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LoopForm rep -&gt; Scope rep
forall rep a. Scoped rep a =&gt; a -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOf"><span class="hs-identifier hs-var">scopeOf</span></a></span><span> </span><span class="annot"><span class="annottext">LoopForm rep
</span><a href="#local-6989586621684444752"><span class="hs-identifier hs-var">form</span></a></span><span> </span><span class="annot"><span class="annottext">Scope rep -&gt; Scope rep -&gt; Scope rep
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[FParam rep] -&gt; Scope rep
forall rep dec. (FParamInfo rep ~ dec) =&gt; [Param dec] -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOfFParams"><span class="hs-identifier hs-var">scopeOfFParams</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((FParam rep, SubExp) -&gt; FParam rep)
-&gt; [(FParam rep, SubExp)] -&gt; [FParam rep]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(FParam rep, SubExp) -&gt; FParam rep
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(FParam rep, SubExp)]
</span><a href="#local-6989586621684444753"><span class="hs-identifier hs-var">merge</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(DoubleBufferM rep (BodyT rep) -&gt; DoubleBufferM rep (BodyT rep))
-&gt; DoubleBufferM rep (BodyT rep) -&gt; DoubleBufferM rep (BodyT rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-170"></span><span>      </span><span class="annot"><span class="annottext">BodyT rep -&gt; DoubleBufferM rep (BodyT rep)
forall rep. ASTRep rep =&gt; Body rep -&gt; DoubleBufferM rep (Body rep)
</span><a href="Futhark.Optimise.DoubleBuffer.html#optimiseBody"><span class="hs-identifier hs-var">optimiseBody</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684444751"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-171"></span><span>  </span><span id="local-6989586621684444748"><span class="annot"><span class="annottext">Pat rep
-&gt; [(FParam rep, SubExp)]
-&gt; BodyT rep
-&gt; DoubleBufferM
     rep (Stms rep, Pat rep, [(FParam rep, SubExp)], BodyT rep)
</span><a href="#local-6989586621684444748"><span class="hs-identifier hs-var">opt_loop</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Env rep
 -&gt; Pat rep
 -&gt; [(FParam rep, SubExp)]
 -&gt; BodyT rep
 -&gt; DoubleBufferM
      rep (Stms rep, Pat rep, [(FParam rep, SubExp)], BodyT rep))
-&gt; DoubleBufferM
     rep
     (Pat rep
      -&gt; [(FParam rep, SubExp)]
      -&gt; BodyT rep
      -&gt; DoubleBufferM
           rep (Stms rep, Pat rep, [(FParam rep, SubExp)], BodyT rep))
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">Env rep
-&gt; Pat rep
-&gt; [(FParam rep, SubExp)]
-&gt; BodyT rep
-&gt; DoubleBufferM
     rep (Stms rep, Pat rep, [(FParam rep, SubExp)], BodyT rep)
forall rep. Env rep -&gt; OptimiseLoop rep
</span><a href="Futhark.Optimise.DoubleBuffer.html#envOptimiseLoop"><span class="hs-identifier hs-var hs-var">envOptimiseLoop</span></a></span><span>
</span><span id="line-172"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684444747"><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684444747"><span class="hs-identifier hs-var">stms</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684444746"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684444746"><span class="hs-identifier hs-var">pat'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684444745"><span class="annot"><span class="annottext">[(FParam rep, SubExp)]
</span><a href="#local-6989586621684444745"><span class="hs-identifier hs-var">merge'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684444744"><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684444744"><span class="hs-identifier hs-var">body''</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Pat rep
-&gt; [(FParam rep, SubExp)]
-&gt; BodyT rep
-&gt; DoubleBufferM
     rep (Stms rep, Pat rep, [(FParam rep, SubExp)], BodyT rep)
</span><a href="#local-6989586621684444748"><span class="hs-identifier hs-var">opt_loop</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684444756"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">[(FParam rep, SubExp)]
</span><a href="#local-6989586621684444753"><span class="hs-identifier hs-var">merge</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684444750"><span class="hs-identifier hs-var">body'</span></a></span><span>
</span><span id="line-173"></span><span>  </span><span class="annot"><span class="annottext">Stms rep -&gt; DoubleBufferM rep (Stms rep)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Stms rep -&gt; DoubleBufferM rep (Stms rep))
-&gt; Stms rep -&gt; DoubleBufferM rep (Stms rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684444747"><span class="hs-identifier hs-var">stms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms rep -&gt; Stms rep -&gt; Stms rep
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; Stms rep
forall rep. Stm rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#oneStm"><span class="hs-identifier hs-var">oneStm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pat rep -&gt; StmAux (ExpDec rep) -&gt; ExpT rep -&gt; Stm rep
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684444746"><span class="hs-identifier hs-var">pat'</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><a href="#local-6989586621684444755"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">(ExpT rep -&gt; Stm rep) -&gt; ExpT rep -&gt; Stm rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(FParam rep, SubExp)] -&gt; LoopForm rep -&gt; BodyT rep -&gt; ExpT rep
forall rep.
[(FParam rep, SubExp)] -&gt; LoopForm rep -&gt; BodyT rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#DoLoop"><span class="hs-identifier hs-var">DoLoop</span></a></span><span> </span><span class="annot"><span class="annottext">[(FParam rep, SubExp)]
</span><a href="#local-6989586621684444745"><span class="hs-identifier hs-var">merge'</span></a></span><span> </span><span class="annot"><span class="annottext">LoopForm rep
</span><a href="#local-6989586621684444752"><span class="hs-identifier hs-var">form</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684444744"><span class="hs-identifier hs-var">body''</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-174"></span><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#optimiseStm"><span class="hs-identifier hs-var">optimiseStm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684444742"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684444742"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684444741"><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><a href="#local-6989586621684444741"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span id="local-6989586621684444740"><span class="annot"><span class="annottext">ExpT rep
</span><a href="#local-6989586621684444740"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-175"></span><span>  </span><span id="local-6989586621684444739"><span class="annot"><span class="annottext">Op rep -&gt; DoubleBufferM rep (Op rep)
</span><a href="#local-6989586621684444739"><span class="hs-identifier hs-var">onOp</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Env rep -&gt; Op rep -&gt; DoubleBufferM rep (Op rep))
-&gt; DoubleBufferM rep (Op rep -&gt; DoubleBufferM rep (Op rep))
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">Env rep -&gt; Op rep -&gt; DoubleBufferM rep (Op rep)
forall rep. Env rep -&gt; OptimiseOp rep
</span><a href="Futhark.Optimise.DoubleBuffer.html#envOptimiseOp"><span class="hs-identifier hs-var hs-var">envOptimiseOp</span></a></span><span>
</span><span id="line-176"></span><span>  </span><span class="annot"><span class="annottext">Stm rep -&gt; Stms rep
forall rep. Stm rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#oneStm"><span class="hs-identifier hs-var">oneStm</span></a></span><span> </span><span class="annot"><span class="annottext">(Stm rep -&gt; Stms rep)
-&gt; (ExpT rep -&gt; Stm rep) -&gt; ExpT rep -&gt; Stms rep
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Pat rep -&gt; StmAux (ExpDec rep) -&gt; ExpT rep -&gt; Stm rep
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684444742"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><a href="#local-6989586621684444741"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">(ExpT rep -&gt; Stms rep)
-&gt; DoubleBufferM rep (ExpT rep) -&gt; DoubleBufferM rep (Stms rep)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Mapper rep rep (DoubleBufferM rep)
-&gt; ExpT rep -&gt; DoubleBufferM rep (ExpT rep)
forall (m :: * -&gt; *) frep trep.
(Applicative m, Monad m) =&gt;
Mapper frep trep m -&gt; Exp frep -&gt; m (Exp trep)
</span><a href="Futhark.IR.Traversals.html#mapExpM"><span class="hs-identifier hs-var">mapExpM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Op rep -&gt; DoubleBufferM rep (Op rep))
-&gt; Mapper rep rep (DoubleBufferM rep)
</span><a href="#local-6989586621684444735"><span class="hs-identifier hs-var">optimise</span></a></span><span> </span><span class="annot"><span class="annottext">Op rep -&gt; DoubleBufferM rep (Op rep)
</span><a href="#local-6989586621684444739"><span class="hs-identifier hs-var">onOp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ExpT rep
</span><a href="#local-6989586621684444740"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-177"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-178"></span><span>    </span><span id="local-6989586621684444735"><span class="annot"><span class="annottext">optimise :: (Op rep -&gt; DoubleBufferM rep (Op rep))
-&gt; Mapper rep rep (DoubleBufferM rep)
</span><a href="#local-6989586621684444735"><span class="hs-identifier hs-var hs-var">optimise</span></a></span></span><span> </span><span id="local-6989586621684444734"><span class="annot"><span class="annottext">Op rep -&gt; DoubleBufferM rep (Op rep)
</span><a href="#local-6989586621684444734"><span class="hs-identifier hs-var">onOp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-179"></span><span>      </span><span class="annot"><span class="annottext">Mapper rep rep (DoubleBufferM rep)
forall (m :: * -&gt; *) rep. Monad m =&gt; Mapper rep rep m
</span><a href="Futhark.IR.Traversals.html#identityMapper"><span class="hs-identifier hs-var">identityMapper</span></a></span><span>
</span><span id="line-180"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">mapOnBody :: Scope rep -&gt; BodyT rep -&gt; DoubleBufferM rep (BodyT rep)
</span><a href="Futhark.IR.Traversals.html#mapOnBody"><span class="hs-identifier hs-var">mapOnBody</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">Scope rep
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684444731"><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684444731"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-181"></span><span>            </span><span class="annot"><span class="annottext">BodyT rep -&gt; DoubleBufferM rep (BodyT rep)
forall rep. ASTRep rep =&gt; Body rep -&gt; DoubleBufferM rep (Body rep)
</span><a href="Futhark.Optimise.DoubleBuffer.html#optimiseBody"><span class="hs-identifier hs-var">optimiseBody</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684444731"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#DoubleBufferM"><span class="hs-identifier hs-type">DoubleBufferM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445468"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445468"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-182"></span><span>          </span><span class="annot"><span class="annottext">mapOnOp :: Op rep -&gt; DoubleBufferM rep (Op rep)
</span><a href="Futhark.IR.Traversals.html#mapOnOp"><span class="hs-identifier hs-var">mapOnOp</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Op rep -&gt; DoubleBufferM rep (Op rep)
</span><a href="#local-6989586621684444734"><span class="hs-identifier hs-var">onOp</span></a></span><span>
</span><span id="line-183"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-184"></span><span>
</span><span id="line-185"></span><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#optimiseGPUOp"><span class="hs-identifier hs-type">optimiseGPUOp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#OptimiseOp"><span class="hs-identifier hs-type">OptimiseOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span>
</span><span id="line-186"></span><span id="optimiseGPUOp"><span class="annot"><span class="annottext">optimiseGPUOp :: OptimiseOp GPUMem
</span><a href="Futhark.Optimise.DoubleBuffer.html#optimiseGPUOp"><span class="hs-identifier hs-var hs-var">optimiseGPUOp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SegOp"><span class="hs-identifier hs-type">SegOp</span></a></span><span> </span><span id="local-6989586621684444727"><span class="annot"><span class="annottext">SegOp SegLevel GPUMem
</span><a href="#local-6989586621684444727"><span class="hs-identifier hs-var">op</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-187"></span><span>  </span><span class="annot"><span class="annottext">(Env GPUMem -&gt; Env GPUMem)
-&gt; DoubleBufferM GPUMem (MemOp (HostOp GPUMem ()))
-&gt; DoubleBufferM GPUMem (MemOp (HostOp GPUMem ()))
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; r) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">local</span></span><span> </span><span class="annot"><span class="annottext">Env GPUMem -&gt; Env GPUMem
forall {rep} {inner}.
(HasLetDecMem (LetDec rep), OpReturns inner, BuilderOps rep,
 FParamInfo rep ~ FParamMem, LParamInfo rep ~ LParamMem,
 LetDec rep ~ LParamMem, RetType rep ~ RetTypeMem, BodyDec rep ~ (),
 BranchType rep ~ BranchTypeMem, ExpDec rep ~ (),
 Op rep ~ MemOp inner) =&gt;
Env rep -&gt; Env rep
</span><a href="#local-6989586621684444726"><span class="hs-identifier hs-var">inSegOp</span></a></span><span> </span><span class="annot"><span class="annottext">(DoubleBufferM GPUMem (MemOp (HostOp GPUMem ()))
 -&gt; DoubleBufferM GPUMem (MemOp (HostOp GPUMem ())))
-&gt; DoubleBufferM GPUMem (MemOp (HostOp GPUMem ()))
-&gt; DoubleBufferM GPUMem (MemOp (HostOp GPUMem ()))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HostOp GPUMem () -&gt; MemOp (HostOp GPUMem ())
forall inner. inner -&gt; MemOp inner
</span><a href="Futhark.IR.Mem.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">(HostOp GPUMem () -&gt; MemOp (HostOp GPUMem ()))
-&gt; (SegOp SegLevel GPUMem -&gt; HostOp GPUMem ())
-&gt; SegOp SegLevel GPUMem
-&gt; MemOp (HostOp GPUMem ())
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SegOp SegLevel GPUMem -&gt; HostOp GPUMem ()
forall rep op. SegOp SegLevel rep -&gt; HostOp rep op
</span><a href="Futhark.IR.GPU.Op.html#SegOp"><span class="hs-identifier hs-var">SegOp</span></a></span><span> </span><span class="annot"><span class="annottext">(SegOp SegLevel GPUMem -&gt; MemOp (HostOp GPUMem ()))
-&gt; DoubleBufferM GPUMem (SegOp SegLevel GPUMem)
-&gt; DoubleBufferM GPUMem (MemOp (HostOp GPUMem ()))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">SegOpMapper SegLevel GPUMem GPUMem (DoubleBufferM GPUMem)
-&gt; SegOp SegLevel GPUMem
-&gt; DoubleBufferM GPUMem (SegOp SegLevel GPUMem)
forall (m :: * -&gt; *) lvl frep trep.
(Applicative m, Monad m) =&gt;
SegOpMapper lvl frep trep m -&gt; SegOp lvl frep -&gt; m (SegOp lvl trep)
</span><a href="Futhark.IR.SegOp.html#mapSegOpM"><span class="hs-identifier hs-var">mapSegOpM</span></a></span><span> </span><span class="annot"><span class="annottext">SegOpMapper SegLevel GPUMem GPUMem (DoubleBufferM GPUMem)
forall {lvl}. SegOpMapper lvl GPUMem GPUMem (DoubleBufferM GPUMem)
</span><a href="#local-6989586621684444724"><span class="hs-identifier hs-var">mapper</span></a></span><span> </span><span class="annot"><span class="annottext">SegOp SegLevel GPUMem
</span><a href="#local-6989586621684444727"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-188"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-189"></span><span>    </span><span id="local-6989586621684444724"><span class="annot"><span class="annottext">mapper :: SegOpMapper lvl GPUMem GPUMem (DoubleBufferM GPUMem)
</span><a href="#local-6989586621684444724"><span class="hs-identifier hs-var hs-var">mapper</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-190"></span><span>      </span><span class="annot"><span class="annottext">SegOpMapper lvl Any Any (DoubleBufferM GPUMem)
forall (m :: * -&gt; *) lvl rep. Monad m =&gt; SegOpMapper lvl rep rep m
</span><a href="Futhark.IR.SegOp.html#identitySegOpMapper"><span class="hs-identifier hs-var">identitySegOpMapper</span></a></span><span>
</span><span id="line-191"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">mapOnSegOpLambda :: Lambda GPUMem -&gt; DoubleBufferM GPUMem (Lambda GPUMem)
</span><a href="Futhark.IR.SegOp.html#mapOnSegOpLambda"><span class="hs-identifier hs-var">mapOnSegOpLambda</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem -&gt; DoubleBufferM GPUMem (Lambda GPUMem)
forall rep.
ASTRep rep =&gt;
Lambda rep -&gt; DoubleBufferM rep (Lambda rep)
</span><a href="Futhark.Optimise.DoubleBuffer.html#optimiseLambda"><span class="hs-identifier hs-var">optimiseLambda</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-192"></span><span>          </span><span class="annot"><span class="annottext">mapOnSegOpBody :: KernelBody GPUMem -&gt; DoubleBufferM GPUMem (KernelBody GPUMem)
</span><a href="Futhark.IR.SegOp.html#mapOnSegOpBody"><span class="hs-identifier hs-var">mapOnSegOpBody</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem -&gt; DoubleBufferM GPUMem (KernelBody GPUMem)
forall rep.
ASTRep rep =&gt;
KernelBody rep -&gt; DoubleBufferM rep (KernelBody rep)
</span><a href="Futhark.Optimise.DoubleBuffer.html#optimiseKernelBody"><span class="hs-identifier hs-var">optimiseKernelBody</span></a></span><span>
</span><span id="line-193"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-194"></span><span>    </span><span id="local-6989586621684444726"><span class="annot"><span class="annottext">inSegOp :: Env rep -&gt; Env rep
</span><a href="#local-6989586621684444726"><span class="hs-identifier hs-var hs-var">inSegOp</span></a></span></span><span> </span><span id="local-6989586621684444661"><span class="annot"><span class="annottext">Env rep
</span><a href="#local-6989586621684444661"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Env rep
</span><a href="#local-6989586621684444661"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">envOptimiseLoop :: OptimiseLoop rep
</span><a href="Futhark.Optimise.DoubleBuffer.html#envOptimiseLoop"><span class="hs-identifier hs-var">envOptimiseLoop</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OptimiseLoop rep
forall rep inner. Constraints rep inner =&gt; OptimiseLoop rep
</span><a href="Futhark.Optimise.DoubleBuffer.html#optimiseLoop"><span class="hs-identifier hs-var">optimiseLoop</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-195"></span><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#optimiseGPUOp"><span class="hs-identifier hs-var">optimiseGPUOp</span></a></span><span> </span><span id="local-6989586621684444659"><span class="annot"><span class="annottext">Op GPUMem
</span><a href="#local-6989586621684444659"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MemOp (HostOp GPUMem ())
-&gt; DoubleBufferM GPUMem (MemOp (HostOp GPUMem ()))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Op GPUMem
MemOp (HostOp GPUMem ())
</span><a href="#local-6989586621684444659"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-196"></span><span>
</span><span id="line-197"></span><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#optimiseMCOp"><span class="hs-identifier hs-type">optimiseMCOp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#OptimiseOp"><span class="hs-identifier hs-type">OptimiseOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span>
</span><span id="line-198"></span><span id="optimiseMCOp"><span class="annot"><span class="annottext">optimiseMCOp :: OptimiseOp MCMem
</span><a href="Futhark.Optimise.DoubleBuffer.html#optimiseMCOp"><span class="hs-identifier hs-var hs-var">optimiseMCOp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.MC.Op.html#ParOp"><span class="hs-identifier hs-type">ParOp</span></a></span><span> </span><span id="local-6989586621684444657"><span class="annot"><span class="annottext">Maybe (SegOp () MCMem)
</span><a href="#local-6989586621684444657"><span class="hs-identifier hs-var">par_op</span></a></span></span><span> </span><span id="local-6989586621684444656"><span class="annot"><span class="annottext">SegOp () MCMem
</span><a href="#local-6989586621684444656"><span class="hs-identifier hs-var">op</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-199"></span><span>  </span><span class="annot"><span class="annottext">(Env MCMem -&gt; Env MCMem)
-&gt; DoubleBufferM MCMem (MemOp (MCOp MCMem ()))
-&gt; DoubleBufferM MCMem (MemOp (MCOp MCMem ()))
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; r) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">local</span></span><span> </span><span class="annot"><span class="annottext">Env MCMem -&gt; Env MCMem
forall {rep} {inner}.
(HasLetDecMem (LetDec rep), OpReturns inner, BuilderOps rep,
 FParamInfo rep ~ FParamMem, LParamInfo rep ~ LParamMem,
 LetDec rep ~ LParamMem, RetType rep ~ RetTypeMem, BodyDec rep ~ (),
 BranchType rep ~ BranchTypeMem, ExpDec rep ~ (),
 Op rep ~ MemOp inner) =&gt;
Env rep -&gt; Env rep
</span><a href="#local-6989586621684444655"><span class="hs-identifier hs-var">inSegOp</span></a></span><span> </span><span class="annot"><span class="annottext">(DoubleBufferM MCMem (MemOp (MCOp MCMem ()))
 -&gt; DoubleBufferM MCMem (MemOp (MCOp MCMem ())))
-&gt; DoubleBufferM MCMem (MemOp (MCOp MCMem ()))
-&gt; DoubleBufferM MCMem (MemOp (MCOp MCMem ()))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-200"></span><span>    </span><span class="annot"><span class="annottext">MCOp MCMem () -&gt; MemOp (MCOp MCMem ())
forall inner. inner -&gt; MemOp inner
</span><a href="Futhark.IR.Mem.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span>
</span><span id="line-201"></span><span>      </span><span class="annot"><span class="annottext">(MCOp MCMem () -&gt; MemOp (MCOp MCMem ()))
-&gt; DoubleBufferM MCMem (MCOp MCMem ())
-&gt; DoubleBufferM MCMem (MemOp (MCOp MCMem ()))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (SegOp () MCMem) -&gt; SegOp () MCMem -&gt; MCOp MCMem ()
forall rep op. Maybe (SegOp () rep) -&gt; SegOp () rep -&gt; MCOp rep op
</span><a href="Futhark.IR.MC.Op.html#ParOp"><span class="hs-identifier hs-var">ParOp</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (SegOp () MCMem) -&gt; SegOp () MCMem -&gt; MCOp MCMem ())
-&gt; DoubleBufferM MCMem (Maybe (SegOp () MCMem))
-&gt; DoubleBufferM MCMem (SegOp () MCMem -&gt; MCOp MCMem ())
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(SegOp () MCMem -&gt; DoubleBufferM MCMem (SegOp () MCMem))
-&gt; Maybe (SegOp () MCMem)
-&gt; DoubleBufferM MCMem (Maybe (SegOp () MCMem))
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegOpMapper () MCMem MCMem (DoubleBufferM MCMem)
-&gt; SegOp () MCMem -&gt; DoubleBufferM MCMem (SegOp () MCMem)
forall (m :: * -&gt; *) lvl frep trep.
(Applicative m, Monad m) =&gt;
SegOpMapper lvl frep trep m -&gt; SegOp lvl frep -&gt; m (SegOp lvl trep)
</span><a href="Futhark.IR.SegOp.html#mapSegOpM"><span class="hs-identifier hs-var">mapSegOpM</span></a></span><span> </span><span class="annot"><span class="annottext">SegOpMapper () MCMem MCMem (DoubleBufferM MCMem)
forall {lvl}. SegOpMapper lvl MCMem MCMem (DoubleBufferM MCMem)
</span><a href="#local-6989586621684444653"><span class="hs-identifier hs-var">mapper</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe (SegOp () MCMem)
</span><a href="#local-6989586621684444657"><span class="hs-identifier hs-var">par_op</span></a></span><span> </span><span class="annot"><span class="annottext">DoubleBufferM MCMem (SegOp () MCMem -&gt; MCOp MCMem ())
-&gt; DoubleBufferM MCMem (SegOp () MCMem)
-&gt; DoubleBufferM MCMem (MCOp MCMem ())
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">SegOpMapper () MCMem MCMem (DoubleBufferM MCMem)
-&gt; SegOp () MCMem -&gt; DoubleBufferM MCMem (SegOp () MCMem)
forall (m :: * -&gt; *) lvl frep trep.
(Applicative m, Monad m) =&gt;
SegOpMapper lvl frep trep m -&gt; SegOp lvl frep -&gt; m (SegOp lvl trep)
</span><a href="Futhark.IR.SegOp.html#mapSegOpM"><span class="hs-identifier hs-var">mapSegOpM</span></a></span><span> </span><span class="annot"><span class="annottext">SegOpMapper () MCMem MCMem (DoubleBufferM MCMem)
forall {lvl}. SegOpMapper lvl MCMem MCMem (DoubleBufferM MCMem)
</span><a href="#local-6989586621684444653"><span class="hs-identifier hs-var">mapper</span></a></span><span> </span><span class="annot"><span class="annottext">SegOp () MCMem
</span><a href="#local-6989586621684444656"><span class="hs-identifier hs-var">op</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-202"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-203"></span><span>    </span><span id="local-6989586621684444653"><span class="annot"><span class="annottext">mapper :: SegOpMapper lvl MCMem MCMem (DoubleBufferM MCMem)
</span><a href="#local-6989586621684444653"><span class="hs-identifier hs-var hs-var">mapper</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-204"></span><span>      </span><span class="annot"><span class="annottext">SegOpMapper lvl Any Any (DoubleBufferM MCMem)
forall (m :: * -&gt; *) lvl rep. Monad m =&gt; SegOpMapper lvl rep rep m
</span><a href="Futhark.IR.SegOp.html#identitySegOpMapper"><span class="hs-identifier hs-var">identitySegOpMapper</span></a></span><span>
</span><span id="line-205"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">mapOnSegOpLambda :: Lambda MCMem -&gt; DoubleBufferM MCMem (Lambda MCMem)
</span><a href="Futhark.IR.SegOp.html#mapOnSegOpLambda"><span class="hs-identifier hs-var">mapOnSegOpLambda</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Lambda MCMem -&gt; DoubleBufferM MCMem (Lambda MCMem)
forall rep.
ASTRep rep =&gt;
Lambda rep -&gt; DoubleBufferM rep (Lambda rep)
</span><a href="Futhark.Optimise.DoubleBuffer.html#optimiseLambda"><span class="hs-identifier hs-var">optimiseLambda</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-206"></span><span>          </span><span class="annot"><span class="annottext">mapOnSegOpBody :: KernelBody MCMem -&gt; DoubleBufferM MCMem (KernelBody MCMem)
</span><a href="Futhark.IR.SegOp.html#mapOnSegOpBody"><span class="hs-identifier hs-var">mapOnSegOpBody</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">KernelBody MCMem -&gt; DoubleBufferM MCMem (KernelBody MCMem)
forall rep.
ASTRep rep =&gt;
KernelBody rep -&gt; DoubleBufferM rep (KernelBody rep)
</span><a href="Futhark.Optimise.DoubleBuffer.html#optimiseKernelBody"><span class="hs-identifier hs-var">optimiseKernelBody</span></a></span><span>
</span><span id="line-207"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-208"></span><span>    </span><span id="local-6989586621684444655"><span class="annot"><span class="annottext">inSegOp :: Env rep -&gt; Env rep
</span><a href="#local-6989586621684444655"><span class="hs-identifier hs-var hs-var">inSegOp</span></a></span></span><span> </span><span id="local-6989586621684444596"><span class="annot"><span class="annottext">Env rep
</span><a href="#local-6989586621684444596"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Env rep
</span><a href="#local-6989586621684444596"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">envOptimiseLoop :: OptimiseLoop rep
</span><a href="Futhark.Optimise.DoubleBuffer.html#envOptimiseLoop"><span class="hs-identifier hs-var">envOptimiseLoop</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OptimiseLoop rep
forall rep inner. Constraints rep inner =&gt; OptimiseLoop rep
</span><a href="Futhark.Optimise.DoubleBuffer.html#optimiseLoop"><span class="hs-identifier hs-var">optimiseLoop</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-209"></span><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#optimiseMCOp"><span class="hs-identifier hs-var">optimiseMCOp</span></a></span><span> </span><span id="local-6989586621684444595"><span class="annot"><span class="annottext">Op MCMem
</span><a href="#local-6989586621684444595"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MemOp (MCOp MCMem ())
-&gt; DoubleBufferM MCMem (MemOp (MCOp MCMem ()))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Op MCMem
MemOp (MCOp MCMem ())
</span><a href="#local-6989586621684444595"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-210"></span><span>
</span><span id="line-211"></span><span id="local-6989586621684445413"><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#optimiseKernelBody"><span class="hs-identifier hs-type">optimiseKernelBody</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-212"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.html#ASTRep"><span class="hs-identifier hs-type">ASTRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445413"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-213"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-type">KernelBody</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445413"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-214"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#DoubleBufferM"><span class="hs-identifier hs-type">DoubleBufferM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445413"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-type">KernelBody</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445413"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-215"></span><span id="optimiseKernelBody"><span class="annot"><span class="annottext">optimiseKernelBody :: forall rep.
ASTRep rep =&gt;
KernelBody rep -&gt; DoubleBufferM rep (KernelBody rep)
</span><a href="Futhark.Optimise.DoubleBuffer.html#optimiseKernelBody"><span class="hs-identifier hs-var hs-var">optimiseKernelBody</span></a></span></span><span> </span><span id="local-6989586621684444590"><span class="annot"><span class="annottext">KernelBody rep
</span><a href="#local-6989586621684444590"><span class="hs-identifier hs-var">kbody</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-216"></span><span>  </span><span id="local-6989586621684444589"><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684444589"><span class="hs-identifier hs-var">stms'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Stm rep] -&gt; DoubleBufferM rep (Stms rep)
forall rep. ASTRep rep =&gt; [Stm rep] -&gt; DoubleBufferM rep (Stms rep)
</span><a href="Futhark.Optimise.DoubleBuffer.html#optimiseStms"><span class="hs-identifier hs-var">optimiseStms</span></a></span><span> </span><span class="annot"><span class="annottext">([Stm rep] -&gt; DoubleBufferM rep (Stms rep))
-&gt; [Stm rep] -&gt; DoubleBufferM rep (Stms rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stms rep -&gt; [Stm rep]
forall rep. Stms rep -&gt; [Stm rep]
</span><a href="Futhark.IR.Syntax.html#stmsToList"><span class="hs-identifier hs-var">stmsToList</span></a></span><span> </span><span class="annot"><span class="annottext">(Stms rep -&gt; [Stm rep]) -&gt; Stms rep -&gt; [Stm rep]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KernelBody rep -&gt; Stms rep
forall rep. KernelBody rep -&gt; Stms rep
</span><a href="Futhark.IR.SegOp.html#kernelBodyStms"><span class="hs-identifier hs-var hs-var">kernelBodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody rep
</span><a href="#local-6989586621684444590"><span class="hs-identifier hs-var">kbody</span></a></span><span>
</span><span id="line-217"></span><span>  </span><span class="annot"><span class="annottext">KernelBody rep -&gt; DoubleBufferM rep (KernelBody rep)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(KernelBody rep -&gt; DoubleBufferM rep (KernelBody rep))
-&gt; KernelBody rep -&gt; DoubleBufferM rep (KernelBody rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KernelBody rep
</span><a href="#local-6989586621684444590"><span class="hs-identifier hs-var">kbody</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">kernelBodyStms :: Stms rep
</span><a href="Futhark.IR.SegOp.html#kernelBodyStms"><span class="hs-identifier hs-var">kernelBodyStms</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684444589"><span class="hs-identifier hs-var">stms'</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-218"></span><span>
</span><span id="line-219"></span><span id="local-6989586621684445415"><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#optimiseLambda"><span class="hs-identifier hs-type">optimiseLambda</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-220"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.html#ASTRep"><span class="hs-identifier hs-type">ASTRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445415"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-221"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445415"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-222"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#DoubleBufferM"><span class="hs-identifier hs-type">DoubleBufferM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445415"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445415"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-223"></span><span id="optimiseLambda"><span class="annot"><span class="annottext">optimiseLambda :: forall rep.
ASTRep rep =&gt;
Lambda rep -&gt; DoubleBufferM rep (Lambda rep)
</span><a href="Futhark.Optimise.DoubleBuffer.html#optimiseLambda"><span class="hs-identifier hs-var hs-var">optimiseLambda</span></a></span></span><span> </span><span id="local-6989586621684444572"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684444572"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-224"></span><span>  </span><span id="local-6989586621684444571"><span class="annot"><span class="annottext">Body rep
</span><a href="#local-6989586621684444571"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Scope rep
-&gt; DoubleBufferM rep (Body rep) -&gt; DoubleBufferM rep (Body rep)
forall rep (m :: * -&gt; *) a.
LocalScope rep m =&gt;
Scope rep -&gt; m a -&gt; m a
</span><a href="Futhark.IR.Prop.Scope.html#localScope"><span class="hs-identifier hs-var">localScope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Scope rep -&gt; Scope rep
forall fromrep torep.
SameScope fromrep torep =&gt;
Scope fromrep -&gt; Scope torep
</span><a href="Futhark.IR.Prop.Scope.html#castScope"><span class="hs-identifier hs-var">castScope</span></a></span><span> </span><span class="annot"><span class="annottext">(Scope rep -&gt; Scope rep) -&gt; Scope rep -&gt; Scope rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; Scope rep
forall rep a. Scoped rep a =&gt; a -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOf"><span class="hs-identifier hs-var">scopeOf</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684444572"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(DoubleBufferM rep (Body rep) -&gt; DoubleBufferM rep (Body rep))
-&gt; DoubleBufferM rep (Body rep) -&gt; DoubleBufferM rep (Body rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Body rep -&gt; DoubleBufferM rep (Body rep)
forall rep. ASTRep rep =&gt; Body rep -&gt; DoubleBufferM rep (Body rep)
</span><a href="Futhark.Optimise.DoubleBuffer.html#optimiseBody"><span class="hs-identifier hs-var">optimiseBody</span></a></span><span> </span><span class="annot"><span class="annottext">(Body rep -&gt; DoubleBufferM rep (Body rep))
-&gt; Body rep -&gt; DoubleBufferM rep (Body rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; Body rep
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684444572"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-225"></span><span>  </span><span class="annot"><span class="annottext">Lambda rep -&gt; DoubleBufferM rep (Lambda rep)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684444572"><span class="hs-identifier hs-var">lam</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">lambdaBody :: Body rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var">lambdaBody</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Body rep
</span><a href="#local-6989586621684444571"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-226"></span><span>
</span><span id="line-227"></span><span class="hs-keyword">type</span><span> </span><span id="Constraints"><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#Constraints"><span class="hs-identifier hs-var">Constraints</span></a></span></span><span> </span><span id="local-6989586621684444569"><span class="annot"><a href="#local-6989586621684444569"><span class="hs-identifier hs-type">rep</span></a></span></span><span> </span><span id="local-6989586621684444568"><span class="annot"><a href="#local-6989586621684444568"><span class="hs-identifier hs-type">inner</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-228"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#Mem"><span class="hs-identifier hs-type">Mem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684444569"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684444568"><span class="hs-identifier hs-type">inner</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-229"></span><span>    </span><span class="annot"><a href="Futhark.Builder.html#BuilderOps"><span class="hs-identifier hs-type">BuilderOps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684444569"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-230"></span><span>    </span><span class="annot"><a href="Futhark.IR.Rep.html#ExpDec"><span class="hs-identifier hs-type">ExpDec</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684444569"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">~</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-231"></span><span>    </span><span class="annot"><a href="Futhark.IR.Rep.html#BodyDec"><span class="hs-identifier hs-type">BodyDec</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684444569"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">~</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-232"></span><span>    </span><span class="annot"><a href="Futhark.IR.Rep.html#LetDec"><span class="hs-identifier hs-type">LetDec</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684444569"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">~</span></span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#LetDecMem"><span class="hs-identifier hs-type">LetDecMem</span></a></span><span>
</span><span id="line-233"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-234"></span><span>
</span><span id="line-235"></span><span id="local-6989586621684445392"><span id="local-6989586621684445393"><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#extractAllocOf"><span class="hs-identifier hs-type">extractAllocOf</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#Constraints"><span class="hs-identifier hs-type">Constraints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445393"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445392"><span class="hs-identifier hs-type">inner</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445393"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445393"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445393"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-236"></span><span id="extractAllocOf"><span class="annot"><span class="annottext">extractAllocOf :: forall rep inner.
Constraints rep inner =&gt;
Names -&gt; VName -&gt; Stms rep -&gt; Maybe (Stm rep, Stms rep)
</span><a href="Futhark.Optimise.DoubleBuffer.html#extractAllocOf"><span class="hs-identifier hs-var hs-var">extractAllocOf</span></a></span></span><span> </span><span id="local-6989586621684444498"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684444498"><span class="hs-identifier hs-var">bound</span></a></span></span><span> </span><span id="local-6989586621684444497"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684444497"><span class="hs-identifier hs-var">needle</span></a></span></span><span> </span><span id="local-6989586621684444496"><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684444496"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-237"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684444495"><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684444495"><span class="hs-identifier hs-var">stm</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684444494"><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684444494"><span class="hs-identifier hs-var">stms'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Stms rep -&gt; Maybe (Stm rep, Stms rep)
forall rep. Stms rep -&gt; Maybe (Stm rep, Stms rep)
</span><a href="Futhark.IR.Syntax.html#stmsHead"><span class="hs-identifier hs-var">stmsHead</span></a></span><span> </span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684444496"><span class="hs-identifier hs-var">stms</span></a></span><span>
</span><span id="line-238"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684444495"><span class="hs-identifier hs-var">stm</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-239"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621684444491"><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684444491"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#Alloc"><span class="hs-identifier hs-type">Alloc</span></a></span><span> </span><span id="local-6989586621684444488"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684444488"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span class="annot"><span class="annottext">Space
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-240"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep)
PatElemT LParamMem
</span><a href="#local-6989586621684444491"><span class="hs-identifier hs-var">pe</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; VName -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684444497"><span class="hs-identifier hs-var">needle</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-241"></span><span>        </span><span class="annot"><span class="annottext">SubExp -&gt; Bool
</span><a href="#local-6989586621684444486"><span class="hs-identifier hs-var">invariant</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684444488"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-242"></span><span>        </span><span class="annot"><span class="annottext">(Stm rep, Stms rep) -&gt; Maybe (Stm rep, Stms rep)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684444495"><span class="hs-identifier hs-var">stm</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684444494"><span class="hs-identifier hs-var">stms'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-243"></span><span>    </span><span class="annot"><span class="annottext">Stm rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-244"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684444485"><span class="annot"><span class="annottext">bound' :: Names
</span><a href="#local-6989586621684444485"><span class="hs-identifier hs-var hs-var">bound'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#namesFromList"><span class="hs-identifier hs-var">namesFromList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatT LParamMem -&gt; [VName]
forall dec. PatT dec -&gt; [VName]
</span><a href="Futhark.IR.Prop.Patterns.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stm rep -&gt; PatT (LetDec rep)
forall rep. Stm rep -&gt; Pat rep
</span><a href="Futhark.IR.Syntax.html#stmPat"><span class="hs-identifier hs-var hs-var">stmPat</span></a></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684444495"><span class="hs-identifier hs-var">stm</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684444498"><span class="hs-identifier hs-var">bound</span></a></span><span>
</span><span id="line-245"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">(Stms rep -&gt; Stms rep)
-&gt; (Stm rep, Stms rep) -&gt; (Stm rep, Stms rep)
forall (p :: * -&gt; * -&gt; *) b c a.
Bifunctor p =&gt;
(b -&gt; c) -&gt; p a b -&gt; p a c
</span><span class="hs-identifier hs-var">second</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stm rep -&gt; Stms rep
forall rep. Stm rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#oneStm"><span class="hs-identifier hs-var">oneStm</span></a></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684444495"><span class="hs-identifier hs-var">stm</span></a></span><span> </span><span class="annot"><span class="annottext">Stms rep -&gt; Stms rep -&gt; Stms rep
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Stm rep, Stms rep) -&gt; (Stm rep, Stms rep))
-&gt; Maybe (Stm rep, Stms rep) -&gt; Maybe (Stm rep, Stms rep)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Names -&gt; VName -&gt; Stms rep -&gt; Maybe (Stm rep, Stms rep)
forall rep inner.
Constraints rep inner =&gt;
Names -&gt; VName -&gt; Stms rep -&gt; Maybe (Stm rep, Stms rep)
</span><a href="Futhark.Optimise.DoubleBuffer.html#extractAllocOf"><span class="hs-identifier hs-var">extractAllocOf</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684444485"><span class="hs-identifier hs-var">bound'</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684444497"><span class="hs-identifier hs-var">needle</span></a></span><span> </span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684444494"><span class="hs-identifier hs-var">stms'</span></a></span><span>
</span><span id="line-246"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-247"></span><span>    </span><span id="local-6989586621684444486"><span class="annot"><span class="annottext">invariant :: SubExp -&gt; Bool
</span><a href="#local-6989586621684444486"><span class="hs-identifier hs-var hs-var">invariant</span></a></span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-248"></span><span>    </span><span class="annot"><a href="#local-6989586621684444486"><span class="hs-identifier hs-var">invariant</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684444478"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684444478"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684444478"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#nameIn"><span class="hs-operator hs-var">`nameIn`</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684444498"><span class="hs-identifier hs-var">bound</span></a></span><span>
</span><span id="line-249"></span><span>
</span><span id="line-250"></span><span id="local-6989586621684445409"><span id="local-6989586621684445410"><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#optimiseLoop"><span class="hs-identifier hs-type">optimiseLoop</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#Constraints"><span class="hs-identifier hs-type">Constraints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445410"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445409"><span class="hs-identifier hs-type">inner</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#OptimiseLoop"><span class="hs-identifier hs-type">OptimiseLoop</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445410"><span class="hs-identifier hs-type">rep</span></a></span></span></span><span>
</span><span id="line-251"></span><span id="optimiseLoop"><span class="annot"><span class="annottext">optimiseLoop :: forall rep inner. Constraints rep inner =&gt; OptimiseLoop rep
</span><a href="Futhark.Optimise.DoubleBuffer.html#optimiseLoop"><span class="hs-identifier hs-var hs-var">optimiseLoop</span></a></span></span><span> </span><span id="local-6989586621684444417"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684444417"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684444416"><span class="annot"><span class="annottext">[(FParam rep, SubExp)]
</span><a href="#local-6989586621684444416"><span class="hs-identifier hs-var">merge</span></a></span></span><span> </span><span id="local-6989586621684444415"><span class="annot"><span class="annottext">Body rep
</span><a href="#local-6989586621684444415"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-252"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684444414"><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684444414"><span class="hs-identifier hs-var">outer_stms_1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684444413"><span class="annot"><span class="annottext">PatT LParamMem
</span><a href="#local-6989586621684444413"><span class="hs-identifier hs-var">pat'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684444412"><span class="annot"><span class="annottext">[(Param FParamMem, SubExp)]
</span><a href="#local-6989586621684444412"><span class="hs-identifier hs-var">merge'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684444411"><span class="annot"><span class="annottext">Body rep
</span><a href="#local-6989586621684444411"><span class="hs-identifier hs-var">body'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-253"></span><span>    </span><span class="annot"><span class="annottext">OptimiseLoop rep
forall rep inner. Constraints rep inner =&gt; OptimiseLoop rep
</span><a href="Futhark.Optimise.DoubleBuffer.html#optimiseLoopBySwitching"><span class="hs-identifier hs-var">optimiseLoopBySwitching</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684444417"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">[(FParam rep, SubExp)]
</span><a href="#local-6989586621684444416"><span class="hs-identifier hs-var">merge</span></a></span><span> </span><span class="annot"><span class="annottext">Body rep
</span><a href="#local-6989586621684444415"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-254"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684444409"><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684444409"><span class="hs-identifier hs-var">outer_stms_2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684444408"><span class="annot"><span class="annottext">PatT LParamMem
</span><a href="#local-6989586621684444408"><span class="hs-identifier hs-var">pat''</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684444407"><span class="annot"><span class="annottext">[(Param FParamMem, SubExp)]
</span><a href="#local-6989586621684444407"><span class="hs-identifier hs-var">merge''</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684444406"><span class="annot"><span class="annottext">Body rep
</span><a href="#local-6989586621684444406"><span class="hs-identifier hs-var">body''</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-255"></span><span>    </span><span class="annot"><span class="annottext">Stms rep
-&gt; DoubleBufferM
     rep
     (Stms rep, PatT LParamMem, [(Param FParamMem, SubExp)], Body rep)
-&gt; DoubleBufferM
     rep
     (Stms rep, PatT LParamMem, [(Param FParamMem, SubExp)], Body rep)
forall rep a (m :: * -&gt; *) b.
(Scoped rep a, LocalScope rep m) =&gt;
a -&gt; m b -&gt; m b
</span><a href="Futhark.IR.Prop.Scope.html#inScopeOf"><span class="hs-identifier hs-var">inScopeOf</span></a></span><span> </span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684444414"><span class="hs-identifier hs-var">outer_stms_1</span></a></span><span> </span><span class="annot"><span class="annottext">(DoubleBufferM
   rep
   (Stms rep, PatT LParamMem, [(Param FParamMem, SubExp)], Body rep)
 -&gt; DoubleBufferM
      rep
      (Stms rep, PatT LParamMem, [(Param FParamMem, SubExp)], Body rep))
-&gt; DoubleBufferM
     rep
     (Stms rep, PatT LParamMem, [(Param FParamMem, SubExp)], Body rep)
-&gt; DoubleBufferM
     rep
     (Stms rep, PatT LParamMem, [(Param FParamMem, SubExp)], Body rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">OptimiseLoop rep
forall rep inner. Constraints rep inner =&gt; OptimiseLoop rep
</span><a href="Futhark.Optimise.DoubleBuffer.html#optimiseLoopByCopying"><span class="hs-identifier hs-var">optimiseLoopByCopying</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
PatT LParamMem
</span><a href="#local-6989586621684444413"><span class="hs-identifier hs-var">pat'</span></a></span><span> </span><span class="annot"><span class="annottext">[(FParam rep, SubExp)]
[(Param FParamMem, SubExp)]
</span><a href="#local-6989586621684444412"><span class="hs-identifier hs-var">merge'</span></a></span><span> </span><span class="annot"><span class="annottext">Body rep
</span><a href="#local-6989586621684444411"><span class="hs-identifier hs-var">body'</span></a></span><span>
</span><span id="line-256"></span><span>  </span><span class="annot"><span class="annottext">(Stms rep, PatT LParamMem, [(Param FParamMem, SubExp)], Body rep)
-&gt; DoubleBufferM
     rep
     (Stms rep, PatT LParamMem, [(Param FParamMem, SubExp)], Body rep)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684444414"><span class="hs-identifier hs-var">outer_stms_1</span></a></span><span> </span><span class="annot"><span class="annottext">Stms rep -&gt; Stms rep -&gt; Stms rep
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684444409"><span class="hs-identifier hs-var">outer_stms_2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PatT LParamMem
</span><a href="#local-6989586621684444408"><span class="hs-identifier hs-var">pat''</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(Param FParamMem, SubExp)]
</span><a href="#local-6989586621684444407"><span class="hs-identifier hs-var">merge''</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Body rep
</span><a href="#local-6989586621684444406"><span class="hs-identifier hs-var">body''</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-257"></span><span>
</span><span id="line-258"></span><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#isArrayIn"><span class="hs-identifier hs-type">isArrayIn</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Param"><span class="hs-identifier hs-type">Param</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#FParamMem"><span class="hs-identifier hs-type">FParamMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-259"></span><span id="isArrayIn"><span class="annot"><span class="annottext">isArrayIn :: VName -&gt; Param FParamMem -&gt; Bool
</span><a href="Futhark.Optimise.DoubleBuffer.html#isArrayIn"><span class="hs-identifier hs-var hs-var">isArrayIn</span></a></span></span><span> </span><span id="local-6989586621684444402"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684444402"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Param"><span class="hs-identifier hs-type">Param</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-type">MemArray</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ShapeBase SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#ArrayIn"><span class="hs-identifier hs-type">ArrayIn</span></a></span><span> </span><span id="local-6989586621684444398"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684444398"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span class="annot"><span class="annottext">IxFun
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684444402"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; VName -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684444398"><span class="hs-identifier hs-var">y</span></a></span><span>
</span><span id="line-260"></span><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#isArrayIn"><span class="hs-identifier hs-var">isArrayIn</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Param FParamMem
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-261"></span><span>
</span><span id="line-262"></span><span id="local-6989586621684444396"><span id="local-6989586621684444397"><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#optimiseLoopBySwitching"><span class="hs-identifier hs-type">optimiseLoopBySwitching</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#Constraints"><span class="hs-identifier hs-type">Constraints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684444397"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684444396"><span class="hs-identifier hs-type">inner</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#OptimiseLoop"><span class="hs-identifier hs-type">OptimiseLoop</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684444397"><span class="hs-identifier hs-type">rep</span></a></span></span></span><span>
</span><span id="line-263"></span><span id="optimiseLoopBySwitching"><span class="annot"><span class="annottext">optimiseLoopBySwitching :: forall rep inner. Constraints rep inner =&gt; OptimiseLoop rep
</span><a href="Futhark.Optimise.DoubleBuffer.html#optimiseLoopBySwitching"><span class="hs-identifier hs-var hs-var">optimiseLoopBySwitching</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span id="local-6989586621684444250"><span class="annot"><span class="annottext">[PatElemT (LetDec rep)]
</span><a href="#local-6989586621684444250"><span class="hs-identifier hs-var">pes</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684444249"><span class="annot"><span class="annottext">[(FParam rep, SubExp)]
</span><a href="#local-6989586621684444249"><span class="hs-identifier hs-var">merge</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><span class="annottext">BodyDec rep
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684444247"><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684444247"><span class="hs-identifier hs-var">body_stms</span></a></span></span><span> </span><span id="local-6989586621684444246"><span class="annot"><span class="annottext">[SubExpRes]
</span><a href="#local-6989586621684444246"><span class="hs-identifier hs-var">body_res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-264"></span><span>  </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621684444245"><span class="annot"><span class="annottext">PatT LParamMem
</span><a href="#local-6989586621684444245"><span class="hs-identifier hs-var">pat'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684444244"><span class="annot"><span class="annottext">[(Param FParamMem, SubExp)]
</span><a href="#local-6989586621684444244"><span class="hs-identifier hs-var">merge'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684444243"><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684444243"><span class="hs-identifier hs-var">body'</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621684444242"><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684444242"><span class="hs-identifier hs-var">outer_stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Builder
  rep (PatT LParamMem, [(Param FParamMem, SubExp)], BodyT rep)
-&gt; DoubleBufferM
     rep
     ((PatT LParamMem, [(Param FParamMem, SubExp)], BodyT rep),
      Stms rep)
forall (m :: * -&gt; *) somerep rep a.
(MonadFreshNames m, HasScope somerep m, SameScope somerep rep) =&gt;
Builder rep a -&gt; m (a, Stms rep)
</span><a href="Futhark.Builder.html#runBuilder"><span class="hs-identifier hs-var">runBuilder</span></a></span><span> </span><span class="annot"><span class="annottext">(Builder
   rep (PatT LParamMem, [(Param FParamMem, SubExp)], BodyT rep)
 -&gt; DoubleBufferM
      rep
      ((PatT LParamMem, [(Param FParamMem, SubExp)], BodyT rep),
       Stms rep))
-&gt; Builder
     rep (PatT LParamMem, [(Param FParamMem, SubExp)], BodyT rep)
-&gt; DoubleBufferM
     rep
     ((PatT LParamMem, [(Param FParamMem, SubExp)], BodyT rep),
      Stms rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-265"></span><span>    </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621684444240"><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684444240"><span class="hs-identifier hs-var">buffered</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684444239"><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684444239"><span class="hs-identifier hs-var">body_stms'</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684444238"><span class="annot"><span class="annottext">[[PatElemT LParamMem]]
</span><a href="#local-6989586621684444238"><span class="hs-identifier hs-var">pes'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684444237"><span class="annot"><span class="annottext">[[(Param FParamMem, SubExp)]]
</span><a href="#local-6989586621684444237"><span class="hs-identifier hs-var">merge'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684444236"><span class="annot"><span class="annottext">[[SubExpRes]]
</span><a href="#local-6989586621684444236"><span class="hs-identifier hs-var">body_res'</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-266"></span><span>      </span><span class="annot"><span class="annottext">([([PatElemT LParamMem], [(Param FParamMem, SubExp)], [SubExpRes])]
 -&gt; ([[PatElemT LParamMem]], [[(Param FParamMem, SubExp)]],
     [[SubExpRes]]))
-&gt; ((Map VName VName, Stms rep),
    [([PatElemT LParamMem], [(Param FParamMem, SubExp)], [SubExpRes])])
-&gt; ((Map VName VName, Stms rep),
    ([[PatElemT LParamMem]], [[(Param FParamMem, SubExp)]],
     [[SubExpRes]]))
forall (p :: * -&gt; * -&gt; *) b c a.
Bifunctor p =&gt;
(b -&gt; c) -&gt; p a b -&gt; p a c
</span><span class="hs-identifier hs-var">second</span></span><span> </span><span class="annot"><span class="annottext">[([PatElemT LParamMem], [(Param FParamMem, SubExp)], [SubExpRes])]
-&gt; ([[PatElemT LParamMem]], [[(Param FParamMem, SubExp)]],
    [[SubExpRes]])
forall a b c. [(a, b, c)] -&gt; ([a], [b], [c])
</span><span class="hs-identifier hs-var">unzip3</span></span><span> </span><span class="annot"><span class="annottext">(((Map VName VName, Stms rep),
  [([PatElemT LParamMem], [(Param FParamMem, SubExp)], [SubExpRes])])
 -&gt; ((Map VName VName, Stms rep),
     ([[PatElemT LParamMem]], [[(Param FParamMem, SubExp)]],
      [[SubExpRes]])))
-&gt; BuilderT
     rep
     (State VNameSource)
     ((Map VName VName, Stms rep),
      [([PatElemT LParamMem], [(Param FParamMem, SubExp)], [SubExpRes])])
-&gt; BuilderT
     rep
     (State VNameSource)
     ((Map VName VName, Stms rep),
      ([[PatElemT LParamMem]], [[(Param FParamMem, SubExp)]],
       [[SubExpRes]]))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">((Map VName VName, Stms rep)
 -&gt; (PatElemT LParamMem, (Param FParamMem, SubExp), SubExpRes)
 -&gt; BuilderT
      rep
      (State VNameSource)
      ((Map VName VName, Stms rep),
       ([PatElemT LParamMem], [(Param FParamMem, SubExp)], [SubExpRes])))
-&gt; (Map VName VName, Stms rep)
-&gt; [(PatElemT LParamMem, (Param FParamMem, SubExp), SubExpRes)]
-&gt; BuilderT
     rep
     (State VNameSource)
     ((Map VName VName, Stms rep),
      [([PatElemT LParamMem], [(Param FParamMem, SubExp)], [SubExpRes])])
forall (m :: * -&gt; *) acc x y.
Monad m =&gt;
(acc -&gt; x -&gt; m (acc, y)) -&gt; acc -&gt; [x] -&gt; m (acc, [y])
</span><a href="Futhark.Util.html#mapAccumLM"><span class="hs-identifier hs-var">mapAccumLM</span></a></span><span> </span><span class="annot"><span class="annottext">(Map VName VName, Stms rep)
-&gt; (PatElemT LParamMem, (Param FParamMem, SubExp), SubExpRes)
-&gt; BuilderT
     rep
     (State VNameSource)
     ((Map VName VName, Stms rep),
      ([PatElemT LParamMem], [(Param FParamMem, SubExp)], [SubExpRes]))
</span><a href="#local-6989586621684444234"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName VName
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684444247"><span class="hs-identifier hs-var">body_stms</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PatElemT LParamMem]
-&gt; [(Param FParamMem, SubExp)]
-&gt; [SubExpRes]
-&gt; [(PatElemT LParamMem, (Param FParamMem, SubExp), SubExpRes)]
forall a b c. [a] -&gt; [b] -&gt; [c] -&gt; [(a, b, c)]
</span><span class="hs-identifier hs-var">zip3</span></span><span> </span><span class="annot"><span class="annottext">[PatElemT (LetDec rep)]
[PatElemT LParamMem]
</span><a href="#local-6989586621684444250"><span class="hs-identifier hs-var">pes</span></a></span><span> </span><span class="annot"><span class="annottext">[(FParam rep, SubExp)]
[(Param FParamMem, SubExp)]
</span><a href="#local-6989586621684444249"><span class="hs-identifier hs-var">merge</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExpRes]
</span><a href="#local-6989586621684444246"><span class="hs-identifier hs-var">body_res</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-267"></span><span>    </span><span id="local-6989586621684444232"><span class="annot"><span class="annottext">[(Param FParamMem, SubExp)]
</span><a href="#local-6989586621684444232"><span class="hs-identifier hs-var">merge''</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((Param FParamMem, SubExp)
 -&gt; BuilderT rep (State VNameSource) (Param FParamMem, SubExp))
-&gt; [(Param FParamMem, SubExp)]
-&gt; BuilderT rep (State VNameSource) [(Param FParamMem, SubExp)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName VName
-&gt; (Param FParamMem, SubExp)
-&gt; BuilderT rep (State VNameSource) (Param FParamMem, SubExp)
forall {m :: * -&gt; *} {inner} {d}.
(MonadBuilder m, OpReturns inner, HasLetDecMem (LetDec (Rep m)),
 Op (Rep m) ~ MemOp inner, BranchType (Rep m) ~ BranchTypeMem,
 RetType (Rep m) ~ RetTypeMem, LetDec (Rep m) ~ LParamMem,
 LParamInfo (Rep m) ~ LParamMem, FParamInfo (Rep m) ~ FParamMem) =&gt;
Map VName VName
-&gt; (Param (MemInfo d Uniqueness MemBind), SubExp)
-&gt; m (Param (MemInfo d Uniqueness MemBind), SubExp)
</span><a href="#local-6989586621684444230"><span class="hs-identifier hs-var">maybeCopyInitial</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684444240"><span class="hs-identifier hs-var">buffered</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(Param FParamMem, SubExp)]
 -&gt; BuilderT rep (State VNameSource) [(Param FParamMem, SubExp)])
-&gt; [(Param FParamMem, SubExp)]
-&gt; BuilderT rep (State VNameSource) [(Param FParamMem, SubExp)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[[(Param FParamMem, SubExp)]] -&gt; [(Param FParamMem, SubExp)]
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">[[(Param FParamMem, SubExp)]]
</span><a href="#local-6989586621684444237"><span class="hs-identifier hs-var">merge'</span></a></span><span>
</span><span id="line-268"></span><span>    </span><span class="annot"><span class="annottext">(PatT LParamMem, [(Param FParamMem, SubExp)], BodyT rep)
-&gt; Builder
     rep (PatT LParamMem, [(Param FParamMem, SubExp)], BodyT rep)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PatElemT LParamMem] -&gt; PatT LParamMem
forall dec. [PatElemT dec] -&gt; PatT dec
</span><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-var">Pat</span></a></span><span> </span><span class="annot"><span class="annottext">([PatElemT LParamMem] -&gt; PatT LParamMem)
-&gt; [PatElemT LParamMem] -&gt; PatT LParamMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[[PatElemT LParamMem]] -&gt; [PatElemT LParamMem]
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">[[PatElemT LParamMem]]
</span><a href="#local-6989586621684444238"><span class="hs-identifier hs-var">pes'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(Param FParamMem, SubExp)]
</span><a href="#local-6989586621684444232"><span class="hs-identifier hs-var">merge''</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">BodyDec rep -&gt; Stms rep -&gt; [SubExpRes] -&gt; BodyT rep
forall rep. BodyDec rep -&gt; Stms rep -&gt; [SubExpRes] -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-var">Body</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684444239"><span class="hs-identifier hs-var">body_stms'</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExpRes] -&gt; BodyT rep) -&gt; [SubExpRes] -&gt; BodyT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[[SubExpRes]] -&gt; [SubExpRes]
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">[[SubExpRes]]
</span><a href="#local-6989586621684444236"><span class="hs-identifier hs-var">body_res'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-269"></span><span>  </span><span class="annot"><span class="annottext">(Stms rep, PatT LParamMem, [(Param FParamMem, SubExp)], BodyT rep)
-&gt; DoubleBufferM
     rep
     (Stms rep, PatT LParamMem, [(Param FParamMem, SubExp)], BodyT rep)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684444242"><span class="hs-identifier hs-var">outer_stms</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PatT LParamMem
</span><a href="#local-6989586621684444245"><span class="hs-identifier hs-var">pat'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(Param FParamMem, SubExp)]
</span><a href="#local-6989586621684444244"><span class="hs-identifier hs-var">merge'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684444243"><span class="hs-identifier hs-var">body'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-270"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-271"></span><span>    </span><span id="local-6989586621684444229"><span class="annot"><span class="annottext">merge_bound :: Names
</span><a href="#local-6989586621684444229"><span class="hs-identifier hs-var hs-var">merge_bound</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#namesFromList"><span class="hs-identifier hs-var">namesFromList</span></a></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; Names) -&gt; [VName] -&gt; Names
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((Param FParamMem, SubExp) -&gt; VName)
-&gt; [(Param FParamMem, SubExp)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param FParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">(Param FParamMem -&gt; VName)
-&gt; ((Param FParamMem, SubExp) -&gt; Param FParamMem)
-&gt; (Param FParamMem, SubExp)
-&gt; VName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Param FParamMem, SubExp) -&gt; Param FParamMem
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(FParam rep, SubExp)]
[(Param FParamMem, SubExp)]
</span><a href="#local-6989586621684444249"><span class="hs-identifier hs-var">merge</span></a></span><span>
</span><span id="line-272"></span><span>
</span><span id="line-273"></span><span>    </span><span id="local-6989586621684444234"><span class="annot"><span class="annottext">check :: (Map VName VName, Stms rep)
-&gt; (PatElemT LParamMem, (Param FParamMem, SubExp), SubExpRes)
-&gt; BuilderT
     rep
     (State VNameSource)
     ((Map VName VName, Stms rep),
      ([PatElemT LParamMem], [(Param FParamMem, SubExp)], [SubExpRes]))
</span><a href="#local-6989586621684444234"><span class="hs-identifier hs-var hs-var">check</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684444227"><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684444227"><span class="hs-identifier hs-var">buffered</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684444226"><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684444226"><span class="hs-identifier hs-var">body_stms'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684444225"><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684444225"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684444224"><span class="annot"><span class="annottext">Param FParamMem
</span><a href="#local-6989586621684444224"><span class="hs-identifier hs-var">param</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684444223"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684444223"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621684444222"><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684444222"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-274"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Mem"><span class="hs-identifier hs-type">Mem</span></a></span><span> </span><span id="local-6989586621684444220"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684444220"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Param FParamMem -&gt; Type
forall dec. Typed dec =&gt; Param dec -&gt; Type
</span><a href="Futhark.IR.Prop.Patterns.html#paramType"><span class="hs-identifier hs-var">paramType</span></a></span><span> </span><span class="annot"><span class="annottext">Param FParamMem
</span><a href="#local-6989586621684444224"><span class="hs-identifier hs-var">param</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-275"></span><span>        </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684444218"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684444218"><span class="hs-identifier hs-var">arg_v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684444223"><span class="hs-identifier hs-var">arg</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-276"></span><span>        </span><span class="hs-comment">-- XXX: what happens if there are multiple arrays in the same</span><span>
</span><span id="line-277"></span><span>        </span><span class="hs-comment">-- memory block?</span><span>
</span><span id="line-278"></span><span>        </span><span class="hs-special">[</span><span id="local-6989586621684444217"><span class="annot"><span class="annottext">Param FParamMem
</span><a href="#local-6989586621684444217"><span class="hs-identifier hs-var">arr_param</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Param FParamMem -&gt; Bool) -&gt; [Param FParamMem] -&gt; [Param FParamMem]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Param FParamMem -&gt; Bool
</span><a href="Futhark.Optimise.DoubleBuffer.html#isArrayIn"><span class="hs-identifier hs-var">isArrayIn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param FParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param FParamMem
</span><a href="#local-6989586621684444224"><span class="hs-identifier hs-var">param</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Param FParamMem] -&gt; [Param FParamMem])
-&gt; [Param FParamMem] -&gt; [Param FParamMem]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((Param FParamMem, SubExp) -&gt; Param FParamMem)
-&gt; [(Param FParamMem, SubExp)] -&gt; [Param FParamMem]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Param FParamMem, SubExp) -&gt; Param FParamMem
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(FParam rep, SubExp)]
[(Param FParamMem, SubExp)]
</span><a href="#local-6989586621684444249"><span class="hs-identifier hs-var">merge</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-279"></span><span>        </span><span class="annot"><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-type">MemArray</span></a></span><span> </span><span id="local-6989586621684444216"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684444216"><span class="hs-identifier hs-var">pt</span></a></span></span><span> </span><span class="annot"><span class="annottext">ShapeBase SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#ArrayIn"><span class="hs-identifier hs-type">ArrayIn</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684444215"><span class="annot"><span class="annottext">IxFun
</span><a href="#local-6989586621684444215"><span class="hs-identifier hs-var">ixfun</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Param FParamMem -&gt; FParamMem
forall dec. Param dec -&gt; dec
</span><a href="Futhark.IR.Syntax.Core.html#paramDec"><span class="hs-identifier hs-var hs-var">paramDec</span></a></span><span> </span><span class="annot"><span class="annottext">Param FParamMem
</span><a href="#local-6989586621684444217"><span class="hs-identifier hs-var">arr_param</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-280"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684444229"><span class="hs-identifier hs-var">merge_bound</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#namesIntersect"><span class="hs-operator hs-var">`namesIntersect`</span></a></span><span> </span><span class="annot"><span class="annottext">Shape (TPrimExp Int64 VName) -&gt; Names
forall a. FreeIn a =&gt; a -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#freeIn"><span class="hs-identifier hs-var">freeIn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IxFun -&gt; Shape (TPrimExp Int64 VName)
forall num. IxFun num -&gt; Shape num
</span><a href="Futhark.IR.Mem.IxFun.html#base"><span class="hs-identifier hs-var hs-var">IxFun.base</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun
</span><a href="#local-6989586621684444215"><span class="hs-identifier hs-var">ixfun</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-281"></span><span>        </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684444210"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684444210"><span class="hs-identifier hs-var">res_v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubExpRes -&gt; SubExp
</span><a href="Futhark.IR.Syntax.html#resSubExp"><span class="hs-identifier hs-var hs-var">resSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684444222"><span class="hs-identifier hs-var">res</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-282"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684444208"><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684444208"><span class="hs-identifier hs-var">res_v_alloc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684444207"><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684444207"><span class="hs-identifier hs-var">body_stms''</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Names -&gt; VName -&gt; Stms rep -&gt; Maybe (Stm rep, Stms rep)
forall rep inner.
Constraints rep inner =&gt;
Names -&gt; VName -&gt; Stms rep -&gt; Maybe (Stm rep, Stms rep)
</span><a href="Futhark.Optimise.DoubleBuffer.html#extractAllocOf"><span class="hs-identifier hs-var">extractAllocOf</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684444229"><span class="hs-identifier hs-var">merge_bound</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684444210"><span class="hs-identifier hs-var">res_v</span></a></span><span> </span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684444226"><span class="hs-identifier hs-var">body_stms'</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-283"></span><span>        </span><span id="local-6989586621684444206"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684444206"><span class="hs-identifier hs-var">num_bytes</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-284"></span><span>          </span><span class="annot"><span class="annottext">String
-&gt; Exp (Rep (BuilderT rep (State VNameSource)))
-&gt; BuilderT rep (State VNameSource) SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;num_bytes&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ExpT rep -&gt; BuilderT rep (State VNameSource) SubExp)
-&gt; BuilderT rep (State VNameSource) (ExpT rep)
-&gt; BuilderT rep (State VNameSource) SubExp
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; BuilderT
     rep
     (State VNameSource)
     (Exp (Rep (BuilderT rep (State VNameSource))))
forall a (m :: * -&gt; *).
(ToExp a, MonadBuilder m) =&gt;
a -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#toExp"><span class="hs-identifier hs-var">toExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Shape (TPrimExp Int64 VName) -&gt; TPrimExp Int64 VName
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">product</span></span><span> </span><span class="annot"><span class="annottext">(Shape (TPrimExp Int64 VName) -&gt; TPrimExp Int64 VName)
-&gt; Shape (TPrimExp Int64 VName) -&gt; TPrimExp Int64 VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; PrimType -&gt; a
</span><a href="Futhark.IR.Primitive.html#primByteSize"><span class="hs-identifier hs-var">primByteSize</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684444216"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; Shape (TPrimExp Int64 VName) -&gt; Shape (TPrimExp Int64 VName)
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">IxFun -&gt; Shape (TPrimExp Int64 VName)
forall num. IxFun num -&gt; Shape num
</span><a href="Futhark.IR.Mem.IxFun.html#base"><span class="hs-identifier hs-var hs-var">IxFun.base</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun
</span><a href="#local-6989586621684444215"><span class="hs-identifier hs-var">ixfun</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-285"></span><span>        </span><span id="local-6989586621684444200"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684444200"><span class="hs-identifier hs-var">arr_mem_in</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-286"></span><span>          </span><span class="annot"><span class="annottext">String
-&gt; Exp (Rep (BuilderT rep (State VNameSource)))
-&gt; BuilderT rep (State VNameSource) VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m VName
</span><a href="Futhark.Construct.html#letExp"><span class="hs-identifier hs-var">letExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; String
</span><a href="Language.Futhark.Core.html#baseString"><span class="hs-identifier hs-var">baseString</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684444218"><span class="hs-identifier hs-var">arg_v</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_in&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (BuilderT rep (State VNameSource)))
 -&gt; BuilderT rep (State VNameSource) VName)
-&gt; Exp (Rep (BuilderT rep (State VNameSource)))
-&gt; BuilderT rep (State VNameSource) VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Op rep -&gt; ExpT rep
forall rep. Op rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-var">Op</span></a></span><span> </span><span class="annot"><span class="annottext">(Op rep -&gt; ExpT rep) -&gt; Op rep -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Space -&gt; MemOp inner
forall inner. SubExp -&gt; Space -&gt; MemOp inner
</span><a href="Futhark.IR.Mem.html#Alloc"><span class="hs-identifier hs-var">Alloc</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684444206"><span class="hs-identifier hs-var">num_bytes</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684444220"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-287"></span><span>        </span><span id="local-6989586621684444197"><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684444197"><span class="hs-identifier hs-var">pe_unused</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-288"></span><span>          </span><span class="annot"><span class="annottext">VName -&gt; LParamMem -&gt; PatElemT LParamMem
forall dec. VName -&gt; dec -&gt; PatElemT dec
</span><a href="Futhark.IR.Syntax.Core.html#PatElem"><span class="hs-identifier hs-var">PatElem</span></a></span><span>
</span><span id="line-289"></span><span>            </span><span class="annot"><span class="annottext">(VName -&gt; LParamMem -&gt; PatElemT LParamMem)
-&gt; BuilderT rep (State VNameSource) VName
-&gt; BuilderT
     rep (State VNameSource) (LParamMem -&gt; PatElemT LParamMem)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; BuilderT rep (State VNameSource) VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; String -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; String
</span><a href="Language.Futhark.Core.html#baseString"><span class="hs-identifier hs-var">baseString</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684444225"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_unused&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-290"></span><span>            </span><span class="annot"><span class="annottext">BuilderT rep (State VNameSource) (LParamMem -&gt; PatElemT LParamMem)
-&gt; BuilderT rep (State VNameSource) LParamMem
-&gt; BuilderT rep (State VNameSource) (PatElemT LParamMem)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">LParamMem -&gt; BuilderT rep (State VNameSource) LParamMem
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Space -&gt; LParamMem
forall d u ret. Space -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemMem"><span class="hs-identifier hs-var">MemMem</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684444220"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-291"></span><span>        </span><span id="local-6989586621684444193"><span class="annot"><span class="annottext">Param FParamMem
</span><a href="#local-6989586621684444193"><span class="hs-identifier hs-var">param_out</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-292"></span><span>          </span><span class="annot"><span class="annottext">String
-&gt; FParamMem -&gt; BuilderT rep (State VNameSource) (Param FParamMem)
forall (m :: * -&gt; *) dec.
MonadFreshNames m =&gt;
String -&gt; dec -&gt; m (Param dec)
</span><a href="Futhark.MonadFreshNames.html#newParam"><span class="hs-identifier hs-var">newParam</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; String
</span><a href="Language.Futhark.Core.html#baseString"><span class="hs-identifier hs-var">baseString</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param FParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param FParamMem
</span><a href="#local-6989586621684444224"><span class="hs-identifier hs-var">param</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_out&quot;</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Space -&gt; FParamMem
forall d u ret. Space -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemMem"><span class="hs-identifier hs-var">MemMem</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684444220"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-293"></span><span>        </span><span class="annot"><span class="annottext">Stm (Rep (BuilderT rep (State VNameSource)))
-&gt; BuilderT rep (State VNameSource) ()
forall (m :: * -&gt; *). MonadBuilder m =&gt; Stm (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#addStm"><span class="hs-identifier hs-var">addStm</span></a></span><span> </span><span class="annot"><span class="annottext">Stm rep
Stm (Rep (BuilderT rep (State VNameSource)))
</span><a href="#local-6989586621684444208"><span class="hs-identifier hs-var">res_v_alloc</span></a></span><span>
</span><span id="line-294"></span><span>        </span><span class="annot"><span class="annottext">((Map VName VName, Stms rep),
 ([PatElemT LParamMem], [(Param FParamMem, SubExp)], [SubExpRes]))
-&gt; BuilderT
     rep
     (State VNameSource)
     ((Map VName VName, Stms rep),
      ([PatElemT LParamMem], [(Param FParamMem, SubExp)], [SubExpRes]))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span>
</span><span id="line-295"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">VName -&gt; VName -&gt; Map VName VName -&gt; Map VName VName
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param FParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param FParamMem
</span><a href="#local-6989586621684444224"><span class="hs-identifier hs-var">param</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684444200"><span class="hs-identifier hs-var">arr_mem_in</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684444227"><span class="hs-identifier hs-var">buffered</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-296"></span><span>              </span><span class="annot"><span class="annottext">Map VName VName -&gt; Stms rep -&gt; Stms rep
forall a. Substitute a =&gt; Map VName VName -&gt; a -&gt; a
</span><a href="Futhark.Transform.Substitute.html#substituteNames"><span class="hs-identifier hs-var">substituteNames</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; VName -&gt; Map VName VName
forall k a. k -&gt; a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.singleton</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684444210"><span class="hs-identifier hs-var">res_v</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param FParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param FParamMem
</span><a href="#local-6989586621684444193"><span class="hs-identifier hs-var">param_out</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684444207"><span class="hs-identifier hs-var">body_stms''</span></a></span><span>
</span><span id="line-297"></span><span>            </span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-298"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684444225"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684444197"><span class="hs-identifier hs-var">pe_unused</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><span id="line-299"></span><span>              </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param FParamMem
</span><a href="#local-6989586621684444224"><span class="hs-identifier hs-var">param</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684444200"><span class="hs-identifier hs-var">arr_mem_in</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param FParamMem
</span><a href="#local-6989586621684444193"><span class="hs-identifier hs-var">param_out</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SubExpRes -&gt; SubExp
</span><a href="Futhark.IR.Syntax.html#resSubExp"><span class="hs-identifier hs-var hs-var">resSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684444222"><span class="hs-identifier hs-var">res</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><span id="line-300"></span><span>              </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684444222"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">resSubExp :: SubExp
</span><a href="Futhark.IR.Syntax.html#resSubExp"><span class="hs-identifier hs-var">resSubExp</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SubExp) -&gt; VName -&gt; SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param FParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param FParamMem
</span><a href="#local-6989586621684444193"><span class="hs-identifier hs-var">param_out</span></a></span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><span id="line-301"></span><span>                </span><span class="annot"><span class="annottext">SubExp -&gt; SubExpRes
</span><a href="Futhark.IR.Syntax.html#subExpRes"><span class="hs-identifier hs-var">subExpRes</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; SubExpRes) -&gt; SubExp -&gt; SubExpRes
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SubExp) -&gt; VName -&gt; SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param FParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param FParamMem
</span><a href="#local-6989586621684444224"><span class="hs-identifier hs-var">param</span></a></span><span>
</span><span id="line-302"></span><span>              </span><span class="hs-special">]</span><span>
</span><span id="line-303"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-304"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-305"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-306"></span><span>        </span><span class="annot"><span class="annottext">((Map VName VName, Stms rep),
 ([PatElemT LParamMem], [(Param FParamMem, SubExp)], [SubExpRes]))
-&gt; BuilderT
     rep
     (State VNameSource)
     ((Map VName VName, Stms rep),
      ([PatElemT LParamMem], [(Param FParamMem, SubExp)], [SubExpRes]))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span>
</span><span id="line-307"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684444227"><span class="hs-identifier hs-var">buffered</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684444226"><span class="hs-identifier hs-var">body_stms'</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-308"></span><span>            </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684444225"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param FParamMem
</span><a href="#local-6989586621684444224"><span class="hs-identifier hs-var">param</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684444223"><span class="hs-identifier hs-var">arg</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684444222"><span class="hs-identifier hs-var">res</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-309"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-310"></span><span>
</span><span id="line-311"></span><span>    </span><span id="local-6989586621684444230"><span class="annot"><span class="annottext">maybeCopyInitial :: Map VName VName
-&gt; (Param (MemInfo d Uniqueness MemBind), SubExp)
-&gt; m (Param (MemInfo d Uniqueness MemBind), SubExp)
</span><a href="#local-6989586621684444230"><span class="hs-identifier hs-var hs-var">maybeCopyInitial</span></a></span></span><span> </span><span id="local-6989586621684444112"><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684444112"><span class="hs-identifier hs-var">buffered</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684444111"><span class="annot"><span class="annottext">param :: Param (MemInfo d Uniqueness MemBind)
</span><a href="#local-6989586621684444111"><span class="hs-identifier hs-var">param</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Param"><span class="hs-identifier hs-type">Param</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-type">MemArray</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ShapeBase d
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#ArrayIn"><span class="hs-identifier hs-type">ArrayIn</span></a></span><span> </span><span id="local-6989586621684444110"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684444110"><span class="hs-identifier hs-var">mem</span></a></span></span><span> </span><span class="annot"><span class="annottext">IxFun
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684444109"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684444109"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-312"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684444108"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684444108"><span class="hs-identifier hs-var">mem'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684444110"><span class="hs-identifier hs-var">mem</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Map VName VName -&gt; Maybe VName
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-operator hs-var">`M.lookup`</span></span><span> </span><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684444112"><span class="hs-identifier hs-var">buffered</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-313"></span><span>        </span><span id="local-6989586621684444106"><span class="annot"><span class="annottext">LParamMem
</span><a href="#local-6989586621684444106"><span class="hs-identifier hs-var">arg_info</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; m LParamMem
forall rep (m :: * -&gt; *) inner.
(HasScope rep m, Mem rep inner) =&gt;
VName -&gt; m LParamMem
</span><a href="Futhark.IR.Mem.html#lookupMemInfo"><span class="hs-identifier hs-var">lookupMemInfo</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684444109"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-314"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">LParamMem
</span><a href="#local-6989586621684444106"><span class="hs-identifier hs-var">arg_info</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-315"></span><span>          </span><span class="annot"><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-type">MemArray</span></a></span><span> </span><span id="local-6989586621684444104"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684444104"><span class="hs-identifier hs-var">pt</span></a></span></span><span> </span><span id="local-6989586621684444103"><span class="annot"><span class="annottext">ShapeBase SubExp
</span><a href="#local-6989586621684444103"><span class="hs-identifier hs-var">shape</span></a></span></span><span> </span><span id="local-6989586621684444102"><span class="annot"><span class="annottext">NoUniqueness
</span><a href="#local-6989586621684444102"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#ArrayIn"><span class="hs-identifier hs-type">ArrayIn</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684444101"><span class="annot"><span class="annottext">IxFun
</span><a href="#local-6989586621684444101"><span class="hs-identifier hs-var">arg_ixfun</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-316"></span><span>            </span><span id="local-6989586621684444100"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684444100"><span class="hs-identifier hs-var">arg_copy</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; m VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; String -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; String
</span><a href="Language.Futhark.Core.html#baseString"><span class="hs-identifier hs-var">baseString</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684444109"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_dbcopy&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-317"></span><span>            </span><span class="annot"><span class="annottext">Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PatElemT LParamMem] -&gt; PatT LParamMem
forall dec. [PatElemT dec] -&gt; PatT dec
</span><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-var">Pat</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">VName -&gt; LParamMem -&gt; PatElemT LParamMem
forall dec. VName -&gt; dec -&gt; PatElemT dec
</span><a href="Futhark.IR.Syntax.Core.html#PatElem"><span class="hs-identifier hs-var">PatElem</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684444100"><span class="hs-identifier hs-var">arg_copy</span></a></span><span> </span><span class="annot"><span class="annottext">(LParamMem -&gt; PatElemT LParamMem)
-&gt; LParamMem -&gt; PatElemT LParamMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType
-&gt; ShapeBase SubExp -&gt; NoUniqueness -&gt; MemBind -&gt; LParamMem
forall d u ret.
PrimType -&gt; ShapeBase d -&gt; u -&gt; ret -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-var">MemArray</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684444104"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">ShapeBase SubExp
</span><a href="#local-6989586621684444103"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">NoUniqueness
</span><a href="#local-6989586621684444102"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">(MemBind -&gt; LParamMem) -&gt; MemBind -&gt; LParamMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; IxFun -&gt; MemBind
</span><a href="Futhark.IR.Mem.html#ArrayIn"><span class="hs-identifier hs-var">ArrayIn</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684444108"><span class="hs-identifier hs-var">mem'</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun
</span><a href="#local-6989586621684444101"><span class="hs-identifier hs-var">arg_ixfun</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Exp (Rep m) -&gt; m ()) -&gt; Exp (Rep m) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-318"></span><span>              </span><span class="annot"><span class="annottext">BasicOp -&gt; Exp (Rep m)
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; Exp (Rep m)) -&gt; BasicOp -&gt; Exp (Rep m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Copy"><span class="hs-identifier hs-var">Copy</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684444109"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-319"></span><span>            </span><span class="hs-comment">-- We need to make this parameter unique to avoid invalid</span><span>
</span><span id="line-320"></span><span>            </span><span class="hs-comment">-- hoisting (see #1533), because we are invalidating the</span><span>
</span><span id="line-321"></span><span>            </span><span class="hs-comment">-- underlying memory.</span><span>
</span><span id="line-322"></span><span>            </span><span class="annot"><span class="annottext">(Param (MemInfo d Uniqueness MemBind), SubExp)
-&gt; m (Param (MemInfo d Uniqueness MemBind), SubExp)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(MemInfo d Uniqueness MemBind -&gt; MemInfo d Uniqueness MemBind)
-&gt; Param (MemInfo d Uniqueness MemBind)
-&gt; Param (MemInfo d Uniqueness MemBind)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">MemInfo d Uniqueness MemBind -&gt; MemInfo d Uniqueness MemBind
forall {d} {ret}.
MemInfo d Uniqueness ret -&gt; MemInfo d Uniqueness ret
</span><a href="#local-6989586621684444096"><span class="hs-identifier hs-var">mkUnique</span></a></span><span> </span><span class="annot"><span class="annottext">Param (MemInfo d Uniqueness MemBind)
</span><a href="#local-6989586621684444111"><span class="hs-identifier hs-var">param</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684444100"><span class="hs-identifier hs-var">arg_copy</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-323"></span><span>          </span><span class="annot"><span class="annottext">LParamMem
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Param (MemInfo d Uniqueness MemBind), SubExp)
-&gt; m (Param (MemInfo d Uniqueness MemBind), SubExp)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(MemInfo d Uniqueness MemBind -&gt; MemInfo d Uniqueness MemBind)
-&gt; Param (MemInfo d Uniqueness MemBind)
-&gt; Param (MemInfo d Uniqueness MemBind)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">MemInfo d Uniqueness MemBind -&gt; MemInfo d Uniqueness MemBind
forall {d} {ret}.
MemInfo d Uniqueness ret -&gt; MemInfo d Uniqueness ret
</span><a href="#local-6989586621684444096"><span class="hs-identifier hs-var">mkUnique</span></a></span><span> </span><span class="annot"><span class="annottext">Param (MemInfo d Uniqueness MemBind)
</span><a href="#local-6989586621684444111"><span class="hs-identifier hs-var">param</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684444109"><span class="hs-identifier hs-var">arg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-324"></span><span>    </span><span class="annot"><a href="#local-6989586621684444230"><span class="hs-identifier hs-var">maybeCopyInitial</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName VName
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684444095"><span class="annot"><span class="annottext">Param (MemInfo d Uniqueness MemBind)
</span><a href="#local-6989586621684444095"><span class="hs-identifier hs-var">param</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684444094"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684444094"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Param (MemInfo d Uniqueness MemBind), SubExp)
-&gt; m (Param (MemInfo d Uniqueness MemBind), SubExp)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param (MemInfo d Uniqueness MemBind)
</span><a href="#local-6989586621684444095"><span class="hs-identifier hs-var">param</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684444094"><span class="hs-identifier hs-var">arg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-325"></span><span>
</span><span id="line-326"></span><span>    </span><span id="local-6989586621684444096"><span class="annot"><span class="annottext">mkUnique :: MemInfo d Uniqueness ret -&gt; MemInfo d Uniqueness ret
</span><a href="#local-6989586621684444096"><span class="hs-identifier hs-var hs-var">mkUnique</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-type">MemArray</span></a></span><span> </span><span id="local-6989586621684444093"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684444093"><span class="hs-identifier hs-var">bt</span></a></span></span><span> </span><span id="local-6989586621684444092"><span class="annot"><span class="annottext">ShapeBase d
</span><a href="#local-6989586621684444092"><span class="hs-identifier hs-var">shape</span></a></span></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684444091"><span class="annot"><span class="annottext">ret
</span><a href="#local-6989586621684444091"><span class="hs-identifier hs-var">ret</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimType
-&gt; ShapeBase d -&gt; Uniqueness -&gt; ret -&gt; MemInfo d Uniqueness ret
forall d u ret.
PrimType -&gt; ShapeBase d -&gt; u -&gt; ret -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-var">MemArray</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684444093"><span class="hs-identifier hs-var">bt</span></a></span><span> </span><span class="annot"><span class="annottext">ShapeBase d
</span><a href="#local-6989586621684444092"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="Language.Futhark.Core.html#Unique"><span class="hs-identifier hs-var">Unique</span></a></span><span> </span><span class="annot"><span class="annottext">ret
</span><a href="#local-6989586621684444091"><span class="hs-identifier hs-var">ret</span></a></span><span>
</span><span id="line-327"></span><span>    </span><span class="annot"><a href="#local-6989586621684444096"><span class="hs-identifier hs-var">mkUnique</span></a></span><span> </span><span id="local-6989586621684444089"><span class="annot"><span class="annottext">MemInfo d Uniqueness ret
</span><a href="#local-6989586621684444089"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MemInfo d Uniqueness ret
</span><a href="#local-6989586621684444089"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-328"></span><span>
</span><span id="line-329"></span><span id="local-6989586621684444087"><span id="local-6989586621684444088"><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#optimiseLoopByCopying"><span class="hs-identifier hs-type">optimiseLoopByCopying</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#Constraints"><span class="hs-identifier hs-type">Constraints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684444088"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684444087"><span class="hs-identifier hs-type">inner</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#OptimiseLoop"><span class="hs-identifier hs-type">OptimiseLoop</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684444088"><span class="hs-identifier hs-type">rep</span></a></span></span></span><span>
</span><span id="line-330"></span><span id="optimiseLoopByCopying"><span class="annot"><span class="annottext">optimiseLoopByCopying :: forall rep inner. Constraints rep inner =&gt; OptimiseLoop rep
</span><a href="Futhark.Optimise.DoubleBuffer.html#optimiseLoopByCopying"><span class="hs-identifier hs-var hs-var">optimiseLoopByCopying</span></a></span></span><span> </span><span id="local-6989586621684444030"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684444030"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684444029"><span class="annot"><span class="annottext">[(FParam rep, SubExp)]
</span><a href="#local-6989586621684444029"><span class="hs-identifier hs-var">merge</span></a></span></span><span> </span><span id="local-6989586621684444028"><span class="annot"><span class="annottext">Body rep
</span><a href="#local-6989586621684444028"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-331"></span><span>  </span><span class="hs-comment">-- We start out by figuring out which of the merge variables should</span><span>
</span><span id="line-332"></span><span>  </span><span class="hs-comment">-- be double-buffered.</span><span>
</span><span id="line-333"></span><span>  </span><span id="local-6989586621684444027"><span class="annot"><span class="annottext">[DoubleBuffer]
</span><a href="#local-6989586621684444027"><span class="hs-identifier hs-var">buffered</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-334"></span><span>    </span><span class="annot"><span class="annottext">[(Param FParamMem, SubExpRes)]
-&gt; Names -&gt; DoubleBufferM rep [DoubleBuffer]
forall (m :: * -&gt; *).
MonadFreshNames m =&gt;
[(Param FParamMem, SubExpRes)] -&gt; Names -&gt; m [DoubleBuffer]
</span><a href="Futhark.Optimise.DoubleBuffer.html#doubleBufferMergeParams"><span class="hs-identifier hs-var">doubleBufferMergeParams</span></a></span><span>
</span><span id="line-335"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param FParamMem] -&gt; [SubExpRes] -&gt; [(Param FParamMem, SubExpRes)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Param FParamMem, SubExp) -&gt; Param FParamMem)
-&gt; [(Param FParamMem, SubExp)] -&gt; [Param FParamMem]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Param FParamMem, SubExp) -&gt; Param FParamMem
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(FParam rep, SubExp)]
[(Param FParamMem, SubExp)]
</span><a href="#local-6989586621684444029"><span class="hs-identifier hs-var">merge</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Body rep -&gt; [SubExpRes]
forall rep. BodyT rep -&gt; [SubExpRes]
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var hs-var">bodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">Body rep
</span><a href="#local-6989586621684444028"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-336"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Body rep -&gt; Names
forall rep. Body rep -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#boundInBody"><span class="hs-identifier hs-var">boundInBody</span></a></span><span> </span><span class="annot"><span class="annottext">Body rep
</span><a href="#local-6989586621684444028"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-337"></span><span>  </span><span class="hs-comment">-- Then create the allocations of the buffers and copies of the</span><span>
</span><span id="line-338"></span><span>  </span><span class="hs-comment">-- initial values.</span><span>
</span><span id="line-339"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684444023"><span class="annot"><span class="annottext">[(Param FParamMem, SubExp)]
</span><a href="#local-6989586621684444023"><span class="hs-identifier hs-var">merge'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684444022"><span class="annot"><span class="annottext">[Stm rep]
</span><a href="#local-6989586621684444022"><span class="hs-identifier hs-var">allocs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(FParam rep, SubExp)]
-&gt; [DoubleBuffer]
-&gt; DoubleBufferM rep ([(FParam rep, SubExp)], [Stm rep])
forall rep inner.
Constraints rep inner =&gt;
[(FParam rep, SubExp)]
-&gt; [DoubleBuffer]
-&gt; DoubleBufferM rep ([(FParam rep, SubExp)], [Stm rep])
</span><a href="Futhark.Optimise.DoubleBuffer.html#allocStms"><span class="hs-identifier hs-var">allocStms</span></a></span><span> </span><span class="annot"><span class="annottext">[(FParam rep, SubExp)]
</span><a href="#local-6989586621684444029"><span class="hs-identifier hs-var">merge</span></a></span><span> </span><span class="annot"><span class="annottext">[DoubleBuffer]
</span><a href="#local-6989586621684444027"><span class="hs-identifier hs-var">buffered</span></a></span><span>
</span><span id="line-340"></span><span>  </span><span class="hs-comment">-- Modify the loop body to copy buffered result arrays.</span><span>
</span><span id="line-341"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684444020"><span class="annot"><span class="annottext">body' :: Body rep
</span><a href="#local-6989586621684444020"><span class="hs-identifier hs-var hs-var">body'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[FParam rep] -&gt; [DoubleBuffer] -&gt; Body rep -&gt; Body rep
forall rep inner.
Constraints rep inner =&gt;
[FParam rep] -&gt; [DoubleBuffer] -&gt; Body rep -&gt; Body rep
</span><a href="Futhark.Optimise.DoubleBuffer.html#doubleBufferResult"><span class="hs-identifier hs-var">doubleBufferResult</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Param FParamMem, SubExp) -&gt; Param FParamMem)
-&gt; [(Param FParamMem, SubExp)] -&gt; [Param FParamMem]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Param FParamMem, SubExp) -&gt; Param FParamMem
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(FParam rep, SubExp)]
[(Param FParamMem, SubExp)]
</span><a href="#local-6989586621684444029"><span class="hs-identifier hs-var">merge</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DoubleBuffer]
</span><a href="#local-6989586621684444027"><span class="hs-identifier hs-var">buffered</span></a></span><span> </span><span class="annot"><span class="annottext">Body rep
</span><a href="#local-6989586621684444028"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-342"></span><span>  </span><span class="annot"><span class="annottext">(Stms rep, PatT LParamMem, [(Param FParamMem, SubExp)], Body rep)
-&gt; DoubleBufferM
     rep
     (Stms rep, PatT LParamMem, [(Param FParamMem, SubExp)], Body rep)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Stm rep] -&gt; Stms rep
forall rep. [Stm rep] -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#stmsFromList"><span class="hs-identifier hs-var">stmsFromList</span></a></span><span> </span><span class="annot"><span class="annottext">[Stm rep]
</span><a href="#local-6989586621684444022"><span class="hs-identifier hs-var">allocs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Pat rep
PatT LParamMem
</span><a href="#local-6989586621684444030"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(Param FParamMem, SubExp)]
</span><a href="#local-6989586621684444023"><span class="hs-identifier hs-var">merge'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Body rep
</span><a href="#local-6989586621684444020"><span class="hs-identifier hs-var">body'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-343"></span><span>
</span><span id="line-344"></span><span class="hs-comment">-- | The booleans indicate whether we should also play with the</span><span>
</span><span id="line-345"></span><span class="hs-comment">-- initial merge values.</span><span>
</span><span id="line-346"></span><span class="hs-keyword">data</span><span> </span><span id="DoubleBuffer"><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#DoubleBuffer"><span class="hs-identifier hs-var">DoubleBuffer</span></a></span></span><span>
</span><span id="line-347"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="BufferAlloc"><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#BufferAlloc"><span class="hs-identifier hs-var">BufferAlloc</span></a></span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.PrimExp.html#PrimExp"><span class="hs-identifier hs-type">PrimExp</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-348"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-comment">-- | First name is the memory block to copy to,</span><span>
</span><span id="line-349"></span><span>    </span><span class="hs-comment">-- second is the name of the array copy.</span><span>
</span><span id="line-350"></span><span>    </span><span id="BufferCopy"><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#BufferCopy"><span class="hs-identifier hs-var">BufferCopy</span></a></span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-351"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="NoBuffer"><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#NoBuffer"><span class="hs-identifier hs-var">NoBuffer</span></a></span></span><span>
</span><span id="line-352"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684443992"><span id="local-6989586621684443994"><span id="local-6989586621684444013"><span class="annot"><span class="annottext">Int -&gt; DoubleBuffer -&gt; String -&gt; String
[DoubleBuffer] -&gt; String -&gt; String
DoubleBuffer -&gt; String
(Int -&gt; DoubleBuffer -&gt; String -&gt; String)
-&gt; (DoubleBuffer -&gt; String)
-&gt; ([DoubleBuffer] -&gt; String -&gt; String)
-&gt; Show DoubleBuffer
forall a.
(Int -&gt; a -&gt; String -&gt; String)
-&gt; (a -&gt; String) -&gt; ([a] -&gt; String -&gt; String) -&gt; Show a
showList :: [DoubleBuffer] -&gt; String -&gt; String
$cshowList :: [DoubleBuffer] -&gt; String -&gt; String
show :: DoubleBuffer -&gt; String
$cshow :: DoubleBuffer -&gt; String
showsPrec :: Int -&gt; DoubleBuffer -&gt; String -&gt; String
$cshowsPrec :: Int -&gt; DoubleBuffer -&gt; String -&gt; String
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-353"></span><span>
</span><span id="line-354"></span><span id="local-6989586621684445254"><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#doubleBufferMergeParams"><span class="hs-identifier hs-type">doubleBufferMergeParams</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-355"></span><span>  </span><span class="annot"><a href="Futhark.MonadFreshNames.html#MonadFreshNames"><span class="hs-identifier hs-type">MonadFreshNames</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445254"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-356"></span><span>  </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Param"><span class="hs-identifier hs-type">Param</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#FParamMem"><span class="hs-identifier hs-type">FParamMem</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-type">SubExpRes</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-357"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-358"></span><span>  </span><span class="annot"><a href="#local-6989586621684445254"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#DoubleBuffer"><span class="hs-identifier hs-type">DoubleBuffer</span></a></span><span class="hs-special">]</span></span><span>
</span><span id="line-359"></span><span id="doubleBufferMergeParams"><span class="annot"><span class="annottext">doubleBufferMergeParams :: forall (m :: * -&gt; *).
MonadFreshNames m =&gt;
[(Param FParamMem, SubExpRes)] -&gt; Names -&gt; m [DoubleBuffer]
</span><a href="Futhark.Optimise.DoubleBuffer.html#doubleBufferMergeParams"><span class="hs-identifier hs-var hs-var">doubleBufferMergeParams</span></a></span></span><span> </span><span id="local-6989586621684443944"><span class="annot"><span class="annottext">[(Param FParamMem, SubExpRes)]
</span><a href="#local-6989586621684443944"><span class="hs-identifier hs-var">ctx_and_res</span></a></span></span><span> </span><span id="local-6989586621684443943"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684443943"><span class="hs-identifier hs-var">bound_in_loop</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-360"></span><span>  </span><span class="annot"><span class="annottext">StateT (Map VName (VName, Bool)) m [DoubleBuffer]
-&gt; Map VName (VName, Bool) -&gt; m [DoubleBuffer]
forall (m :: * -&gt; *) s a. Monad m =&gt; StateT s m a -&gt; s -&gt; m a
</span><span class="hs-identifier hs-var">evalStateT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Param FParamMem, SubExpRes)
 -&gt; StateT (Map VName (VName, Bool)) m DoubleBuffer)
-&gt; [(Param FParamMem, SubExpRes)]
-&gt; StateT (Map VName (VName, Bool)) m [DoubleBuffer]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">(Param FParamMem, SubExpRes)
-&gt; StateT (Map VName (VName, Bool)) m DoubleBuffer
</span><a href="#local-6989586621684443941"><span class="hs-identifier hs-var">buffer</span></a></span><span> </span><span class="annot"><span class="annottext">[(Param FParamMem, SubExpRes)]
</span><a href="#local-6989586621684443944"><span class="hs-identifier hs-var">ctx_and_res</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map VName (VName, Bool)
forall k a. Map k a
</span><span class="hs-identifier hs-var">M.empty</span></span><span>
</span><span id="line-361"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-362"></span><span>    </span><span id="local-6989586621684443939"><span class="annot"><span class="annottext">params :: [Param FParamMem]
</span><a href="#local-6989586621684443939"><span class="hs-identifier hs-var hs-var">params</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Param FParamMem, SubExpRes) -&gt; Param FParamMem)
-&gt; [(Param FParamMem, SubExpRes)] -&gt; [Param FParamMem]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Param FParamMem, SubExpRes) -&gt; Param FParamMem
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(Param FParamMem, SubExpRes)]
</span><a href="#local-6989586621684443944"><span class="hs-identifier hs-var">ctx_and_res</span></a></span><span>
</span><span id="line-363"></span><span>    </span><span id="local-6989586621684443938"><span class="annot"><span class="annottext">loopVariant :: VName -&gt; Bool
</span><a href="#local-6989586621684443938"><span class="hs-identifier hs-var hs-var">loopVariant</span></a></span></span><span> </span><span id="local-6989586621684443937"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684443937"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-364"></span><span>      </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684443937"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#nameIn"><span class="hs-operator hs-var">`nameIn`</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684443943"><span class="hs-identifier hs-var">bound_in_loop</span></a></span><span>
</span><span id="line-365"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684443937"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [VName] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">((Param FParamMem, SubExpRes) -&gt; VName)
-&gt; [(Param FParamMem, SubExpRes)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param FParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">(Param FParamMem -&gt; VName)
-&gt; ((Param FParamMem, SubExpRes) -&gt; Param FParamMem)
-&gt; (Param FParamMem, SubExpRes)
-&gt; VName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Param FParamMem, SubExpRes) -&gt; Param FParamMem
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Param FParamMem, SubExpRes)]
</span><a href="#local-6989586621684443944"><span class="hs-identifier hs-var">ctx_and_res</span></a></span><span>
</span><span id="line-366"></span><span>
</span><span id="line-367"></span><span>    </span><span id="local-6989586621684443934"><span class="annot"><span class="annottext">loopInvariantSize :: SubExp -&gt; Maybe (SubExp, Bool)
</span><a href="#local-6989586621684443934"><span class="hs-identifier hs-var hs-var">loopInvariantSize</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span> </span><span id="local-6989586621684443933"><span class="annot"><span class="annottext">PrimValue
</span><a href="#local-6989586621684443933"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-368"></span><span>      </span><span class="annot"><span class="annottext">(SubExp, Bool) -&gt; Maybe (SubExp, Bool)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimValue -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Constant"><span class="hs-identifier hs-var">Constant</span></a></span><span> </span><span class="annot"><span class="annottext">PrimValue
</span><a href="#local-6989586621684443933"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span>
</span><span id="line-369"></span><span>    </span><span class="annot"><a href="#local-6989586621684443934"><span class="hs-identifier hs-var">loopInvariantSize</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684443932"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684443932"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-370"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">((Param FParamMem, SubExpRes) -&gt; Bool)
-&gt; [(Param FParamMem, SubExpRes)]
-&gt; Maybe (Param FParamMem, SubExpRes)
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Maybe a
</span><span class="hs-identifier hs-var">find</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; VName -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684443932"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Bool)
-&gt; ((Param FParamMem, SubExpRes) -&gt; VName)
-&gt; (Param FParamMem, SubExpRes)
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Param FParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">(Param FParamMem -&gt; VName)
-&gt; ((Param FParamMem, SubExpRes) -&gt; Param FParamMem)
-&gt; (Param FParamMem, SubExpRes)
-&gt; VName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Param FParamMem, SubExpRes) -&gt; Param FParamMem
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Param FParamMem, SubExpRes)]
</span><a href="#local-6989586621684443944"><span class="hs-identifier hs-var">ctx_and_res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-371"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param FParamMem
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-type">SubExpRes</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span> </span><span id="local-6989586621684443930"><span class="annot"><span class="annottext">PrimValue
</span><a href="#local-6989586621684443930"><span class="hs-identifier hs-var">val</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-372"></span><span>          </span><span class="annot"><span class="annottext">(SubExp, Bool) -&gt; Maybe (SubExp, Bool)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimValue -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Constant"><span class="hs-identifier hs-var">Constant</span></a></span><span> </span><span class="annot"><span class="annottext">PrimValue
</span><a href="#local-6989586621684443930"><span class="hs-identifier hs-var">val</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span>
</span><span id="line-373"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param FParamMem
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-type">SubExpRes</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684443929"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684443929"><span class="hs-identifier hs-var">v'</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-374"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Bool
</span><a href="#local-6989586621684443938"><span class="hs-identifier hs-var">loopVariant</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684443929"><span class="hs-identifier hs-var">v'</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-375"></span><span>            </span><span class="annot"><span class="annottext">(SubExp, Bool) -&gt; Maybe (SubExp, Bool)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684443929"><span class="hs-identifier hs-var">v'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span>
</span><span id="line-376"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">(Param FParamMem, SubExpRes)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-377"></span><span>          </span><span class="annot"><span class="annottext">Maybe (SubExp, Bool)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-378"></span><span>        </span><span class="annot"><span class="annottext">Maybe (Param FParamMem, SubExpRes)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-379"></span><span>          </span><span class="annot"><span class="annottext">(SubExp, Bool) -&gt; Maybe (SubExp, Bool)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684443932"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span>
</span><span id="line-380"></span><span>
</span><span id="line-381"></span><span>    </span><span id="local-6989586621684443928"><span class="annot"><span class="annottext">sizeForMem :: VName -&gt; Maybe (PrimExp VName, Bool)
</span><a href="#local-6989586621684443928"><span class="hs-identifier hs-var hs-var">sizeForMem</span></a></span></span><span> </span><span id="local-6989586621684443927"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684443927"><span class="hs-identifier hs-var">mem</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(PrimExp VName, Bool)] -&gt; Maybe (PrimExp VName, Bool)
forall a. [a] -&gt; Maybe a
</span><a href="Futhark.Util.html#maybeHead"><span class="hs-identifier hs-var">maybeHead</span></a></span><span> </span><span class="annot"><span class="annottext">([(PrimExp VName, Bool)] -&gt; Maybe (PrimExp VName, Bool))
-&gt; [(PrimExp VName, Bool)] -&gt; Maybe (PrimExp VName, Bool)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Param FParamMem -&gt; Maybe (PrimExp VName, Bool))
-&gt; [Param FParamMem] -&gt; [(PrimExp VName, Bool)]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">mapMaybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FParamMem -&gt; Maybe (PrimExp VName, Bool)
</span><a href="#local-6989586621684443925"><span class="hs-identifier hs-var">arrayInMem</span></a></span><span> </span><span class="annot"><span class="annottext">(FParamMem -&gt; Maybe (PrimExp VName, Bool))
-&gt; (Param FParamMem -&gt; FParamMem)
-&gt; Param FParamMem
-&gt; Maybe (PrimExp VName, Bool)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Param FParamMem -&gt; FParamMem
forall dec. Param dec -&gt; dec
</span><a href="Futhark.IR.Syntax.Core.html#paramDec"><span class="hs-identifier hs-var hs-var">paramDec</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Param FParamMem]
</span><a href="#local-6989586621684443939"><span class="hs-identifier hs-var">params</span></a></span><span>
</span><span id="line-382"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-383"></span><span>        </span><span id="local-6989586621684443925"><span class="annot"><span class="annottext">arrayInMem :: FParamMem -&gt; Maybe (PrimExp VName, Bool)
</span><a href="#local-6989586621684443925"><span class="hs-identifier hs-var hs-var">arrayInMem</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-type">MemArray</span></a></span><span> </span><span id="local-6989586621684443924"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684443924"><span class="hs-identifier hs-var">pt</span></a></span></span><span> </span><span id="local-6989586621684443923"><span class="annot"><span class="annottext">ShapeBase SubExp
</span><a href="#local-6989586621684443923"><span class="hs-identifier hs-var">shape</span></a></span></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#ArrayIn"><span class="hs-identifier hs-type">ArrayIn</span></a></span><span> </span><span id="local-6989586621684443922"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684443922"><span class="hs-identifier hs-var">arraymem</span></a></span></span><span> </span><span id="local-6989586621684443921"><span class="annot"><span class="annottext">IxFun
</span><a href="#local-6989586621684443921"><span class="hs-identifier hs-var">ixfun</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-384"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">IxFun -&gt; Bool
forall num. (Eq num, IntegralExp num) =&gt; IxFun num -&gt; Bool
</span><a href="Futhark.IR.Mem.IxFun.html#isDirect"><span class="hs-identifier hs-var">IxFun.isDirect</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun
</span><a href="#local-6989586621684443921"><span class="hs-identifier hs-var">ixfun</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-385"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684443919"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684443919"><span class="hs-identifier hs-var">dims</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684443918"><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621684443918"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-386"></span><span>              </span><span class="annot"><span class="annottext">(SubExp -&gt; Maybe (SubExp, Bool))
-&gt; [SubExp] -&gt; Maybe ([SubExp], [Bool])
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; m (b, c)) -&gt; [a] -&gt; m ([b], [c])
</span><span class="hs-identifier hs-var">mapAndUnzipM</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Maybe (SubExp, Bool)
</span><a href="#local-6989586621684443934"><span class="hs-identifier hs-var">loopInvariantSize</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; Maybe ([SubExp], [Bool]))
-&gt; [SubExp] -&gt; Maybe ([SubExp], [Bool])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ShapeBase SubExp -&gt; [SubExp]
forall d. ShapeBase d -&gt; [d]
</span><a href="Futhark.IR.Syntax.Core.html#shapeDims"><span class="hs-identifier hs-var hs-var">shapeDims</span></a></span><span> </span><span class="annot"><span class="annottext">ShapeBase SubExp
</span><a href="#local-6989586621684443923"><span class="hs-identifier hs-var">shape</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-387"></span><span>            </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684443927"><span class="hs-identifier hs-var">mem</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; VName -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684443922"><span class="hs-identifier hs-var">arraymem</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-388"></span><span>            </span><span class="annot"><span class="annottext">(PrimExp VName, Bool) -&gt; Maybe (PrimExp VName, Bool)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span>
</span><span id="line-389"></span><span>              </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Type -&gt; PrimExp VName
</span><a href="Futhark.Pass.ExplicitAllocations.html#arraySizeInBytesExp"><span class="hs-identifier hs-var">arraySizeInBytesExp</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; PrimExp VName) -&gt; Type -&gt; PrimExp VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-390"></span><span>                  </span><span class="annot"><span class="annottext">PrimType -&gt; ShapeBase SubExp -&gt; NoUniqueness -&gt; Type
forall shape u. PrimType -&gt; shape -&gt; u -&gt; TypeBase shape u
</span><a href="Futhark.IR.Syntax.Core.html#Array"><span class="hs-identifier hs-var">Array</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684443924"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; ShapeBase SubExp
forall d. [d] -&gt; ShapeBase d
</span><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-var">Shape</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684443919"><span class="hs-identifier hs-var">dims</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">NoUniqueness
</span><a href="Futhark.IR.Syntax.Core.html#NoUniqueness"><span class="hs-identifier hs-var">NoUniqueness</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-391"></span><span>                </span><span class="annot"><span class="annottext">[Bool] -&gt; Bool
forall (t :: * -&gt; *). Foldable t =&gt; t Bool -&gt; Bool
</span><span class="hs-identifier hs-var">or</span></span><span> </span><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621684443918"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-392"></span><span>              </span><span class="hs-special">)</span><span>
</span><span id="line-393"></span><span>        </span><span class="annot"><a href="#local-6989586621684443925"><span class="hs-identifier hs-var">arrayInMem</span></a></span><span> </span><span class="annot"><span class="annottext">FParamMem
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (PrimExp VName, Bool)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-394"></span><span>
</span><span id="line-395"></span><span>    </span><span id="local-6989586621684443941"><span class="annot"><span class="annottext">buffer :: (Param FParamMem, SubExpRes)
-&gt; StateT (Map VName (VName, Bool)) m DoubleBuffer
</span><a href="#local-6989586621684443941"><span class="hs-identifier hs-var hs-var">buffer</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684443911"><span class="annot"><span class="annottext">Param FParamMem
</span><a href="#local-6989586621684443911"><span class="hs-identifier hs-var">fparam</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684443910"><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684443910"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Param FParamMem -&gt; Type
forall dec. Typed dec =&gt; Param dec -&gt; Type
</span><a href="Futhark.IR.Prop.Patterns.html#paramType"><span class="hs-identifier hs-var">paramType</span></a></span><span> </span><span class="annot"><span class="annottext">Param FParamMem
</span><a href="#local-6989586621684443911"><span class="hs-identifier hs-var">fparam</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-396"></span><span>      </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Mem"><span class="hs-identifier hs-type">Mem</span></a></span><span> </span><span id="local-6989586621684443909"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684443909"><span class="hs-identifier hs-var">space</span></a></span></span><span>
</span><span id="line-397"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684443908"><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684443908"><span class="hs-identifier hs-var">size</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684443907"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684443907"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Maybe (PrimExp VName, Bool)
</span><a href="#local-6989586621684443928"><span class="hs-identifier hs-var">sizeForMem</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Maybe (PrimExp VName, Bool))
-&gt; VName -&gt; Maybe (PrimExp VName, Bool)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param FParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param FParamMem
</span><a href="#local-6989586621684443911"><span class="hs-identifier hs-var">fparam</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-398"></span><span>          </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684443906"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684443906"><span class="hs-identifier hs-var">res_v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubExpRes -&gt; SubExp
</span><a href="Futhark.IR.Syntax.html#resSubExp"><span class="hs-identifier hs-var hs-var">resSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684443910"><span class="hs-identifier hs-var">res</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-399"></span><span>          </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684443906"><span class="hs-identifier hs-var">res_v</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#nameIn"><span class="hs-operator hs-var">`nameIn`</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684443943"><span class="hs-identifier hs-var">bound_in_loop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-400"></span><span>          </span><span class="hs-comment">-- Let us double buffer this!</span><span>
</span><span id="line-401"></span><span>          </span><span id="local-6989586621684443905"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684443905"><span class="hs-identifier hs-var">bufname</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m VName -&gt; StateT (Map VName (VName, Bool)) m VName
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(m VName -&gt; StateT (Map VName (VName, Bool)) m VName)
-&gt; m VName -&gt; StateT (Map VName (VName, Bool)) m VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; m VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; String -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;double_buffer_mem&quot;</span></span><span>
</span><span id="line-402"></span><span>          </span><span class="annot"><span class="annottext">(Map VName (VName, Bool) -&gt; Map VName (VName, Bool))
-&gt; StateT (Map VName (VName, Bool)) m ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((Map VName (VName, Bool) -&gt; Map VName (VName, Bool))
 -&gt; StateT (Map VName (VName, Bool)) m ())
-&gt; (Map VName (VName, Bool) -&gt; Map VName (VName, Bool))
-&gt; StateT (Map VName (VName, Bool)) m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName
-&gt; (VName, Bool)
-&gt; Map VName (VName, Bool)
-&gt; Map VName (VName, Bool)
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param FParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param FParamMem
</span><a href="#local-6989586621684443911"><span class="hs-identifier hs-var">fparam</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684443905"><span class="hs-identifier hs-var">bufname</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684443907"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-403"></span><span>          </span><span class="annot"><span class="annottext">DoubleBuffer -&gt; StateT (Map VName (VName, Bool)) m DoubleBuffer
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(DoubleBuffer -&gt; StateT (Map VName (VName, Bool)) m DoubleBuffer)
-&gt; DoubleBuffer -&gt; StateT (Map VName (VName, Bool)) m DoubleBuffer
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; PrimExp VName -&gt; Space -&gt; Bool -&gt; DoubleBuffer
</span><a href="Futhark.Optimise.DoubleBuffer.html#BufferAlloc"><span class="hs-identifier hs-var">BufferAlloc</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684443905"><span class="hs-identifier hs-var">bufname</span></a></span><span> </span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684443908"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684443909"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684443907"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-404"></span><span>      </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>
</span><span id="line-405"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-type">MemArray</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ShapeBase SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#ArrayIn"><span class="hs-identifier hs-type">ArrayIn</span></a></span><span> </span><span id="local-6989586621684443902"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684443902"><span class="hs-identifier hs-var">mem</span></a></span></span><span> </span><span id="local-6989586621684443901"><span class="annot"><span class="annottext">IxFun
</span><a href="#local-6989586621684443901"><span class="hs-identifier hs-var">ixfun</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Param FParamMem -&gt; FParamMem
forall dec. Param dec -&gt; dec
</span><a href="Futhark.IR.Syntax.Core.html#paramDec"><span class="hs-identifier hs-var hs-var">paramDec</span></a></span><span> </span><span class="annot"><span class="annottext">Param FParamMem
</span><a href="#local-6989586621684443911"><span class="hs-identifier hs-var">fparam</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-406"></span><span>          </span><span id="local-6989586621684443900"><span class="annot"><span class="annottext">Maybe (VName, Bool)
</span><a href="#local-6989586621684443900"><span class="hs-identifier hs-var">buffered</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Map VName (VName, Bool) -&gt; Maybe (VName, Bool))
-&gt; StateT (Map VName (VName, Bool)) m (Maybe (VName, Bool))
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">((Map VName (VName, Bool) -&gt; Maybe (VName, Bool))
 -&gt; StateT (Map VName (VName, Bool)) m (Maybe (VName, Bool)))
-&gt; (Map VName (VName, Bool) -&gt; Maybe (VName, Bool))
-&gt; StateT (Map VName (VName, Bool)) m (Maybe (VName, Bool))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Map VName (VName, Bool) -&gt; Maybe (VName, Bool)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684443902"><span class="hs-identifier hs-var">mem</span></a></span><span>
</span><span id="line-407"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (VName, Bool)
</span><a href="#local-6989586621684443900"><span class="hs-identifier hs-var">buffered</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-408"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684443898"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684443898"><span class="hs-identifier hs-var">bufname</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684443897"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684443897"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-409"></span><span>              </span><span id="local-6989586621684443896"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684443896"><span class="hs-identifier hs-var">copyname</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m VName -&gt; StateT (Map VName (VName, Bool)) m VName
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(m VName -&gt; StateT (Map VName (VName, Bool)) m VName)
-&gt; m VName -&gt; StateT (Map VName (VName, Bool)) m VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; m VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; String -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;double_buffer_array&quot;</span></span><span>
</span><span id="line-410"></span><span>              </span><span class="annot"><span class="annottext">DoubleBuffer -&gt; StateT (Map VName (VName, Bool)) m DoubleBuffer
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(DoubleBuffer -&gt; StateT (Map VName (VName, Bool)) m DoubleBuffer)
-&gt; DoubleBuffer -&gt; StateT (Map VName (VName, Bool)) m DoubleBuffer
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; IxFun -&gt; VName -&gt; Bool -&gt; DoubleBuffer
</span><a href="Futhark.Optimise.DoubleBuffer.html#BufferCopy"><span class="hs-identifier hs-var">BufferCopy</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684443898"><span class="hs-identifier hs-var">bufname</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun
</span><a href="#local-6989586621684443901"><span class="hs-identifier hs-var">ixfun</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684443896"><span class="hs-identifier hs-var">copyname</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684443897"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-411"></span><span>            </span><span class="annot"><span class="annottext">Maybe (VName, Bool)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-412"></span><span>              </span><span class="annot"><span class="annottext">DoubleBuffer -&gt; StateT (Map VName (VName, Bool)) m DoubleBuffer
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">DoubleBuffer
</span><a href="Futhark.Optimise.DoubleBuffer.html#NoBuffer"><span class="hs-identifier hs-var">NoBuffer</span></a></span><span>
</span><span id="line-413"></span><span>      </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DoubleBuffer -&gt; StateT (Map VName (VName, Bool)) m DoubleBuffer
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">DoubleBuffer
</span><a href="Futhark.Optimise.DoubleBuffer.html#NoBuffer"><span class="hs-identifier hs-var">NoBuffer</span></a></span><span>
</span><span id="line-414"></span><span>
</span><span id="line-415"></span><span id="local-6989586621684445249"><span id="local-6989586621684445250"><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#allocStms"><span class="hs-identifier hs-type">allocStms</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-416"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#Constraints"><span class="hs-identifier hs-type">Constraints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445250"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445249"><span class="hs-identifier hs-type">inner</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-417"></span><span>  </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#FParam"><span class="hs-identifier hs-type">FParam</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445250"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-418"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#DoubleBuffer"><span class="hs-identifier hs-type">DoubleBuffer</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-419"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#DoubleBufferM"><span class="hs-identifier hs-type">DoubleBufferM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445250"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#FParam"><span class="hs-identifier hs-type">FParam</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445250"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445250"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-420"></span><span id="allocStms"><span class="annot"><span class="annottext">allocStms :: forall rep inner.
Constraints rep inner =&gt;
[(FParam rep, SubExp)]
-&gt; [DoubleBuffer]
-&gt; DoubleBufferM rep ([(FParam rep, SubExp)], [Stm rep])
</span><a href="Futhark.Optimise.DoubleBuffer.html#allocStms"><span class="hs-identifier hs-var hs-var">allocStms</span></a></span></span><span> </span><span id="local-6989586621684443820"><span class="annot"><span class="annottext">[(FParam rep, SubExp)]
</span><a href="#local-6989586621684443820"><span class="hs-identifier hs-var">merge</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WriterT [Stm rep] (DoubleBufferM rep) [(Param FParamMem, SubExp)]
-&gt; DoubleBufferM rep ([(Param FParamMem, SubExp)], [Stm rep])
forall w (m :: * -&gt; *) a. WriterT w m a -&gt; m (a, w)
</span><span class="hs-identifier hs-var hs-var">runWriterT</span></span><span> </span><span class="annot"><span class="annottext">(WriterT [Stm rep] (DoubleBufferM rep) [(Param FParamMem, SubExp)]
 -&gt; DoubleBufferM rep ([(Param FParamMem, SubExp)], [Stm rep]))
-&gt; ([DoubleBuffer]
    -&gt; WriterT
         [Stm rep] (DoubleBufferM rep) [(Param FParamMem, SubExp)])
-&gt; [DoubleBuffer]
-&gt; DoubleBufferM rep ([(Param FParamMem, SubExp)], [Stm rep])
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">((Param FParamMem, SubExp)
 -&gt; DoubleBuffer
 -&gt; WriterT [Stm rep] (DoubleBufferM rep) (Param FParamMem, SubExp))
-&gt; [(Param FParamMem, SubExp)]
-&gt; [DoubleBuffer]
-&gt; WriterT
     [Stm rep] (DoubleBufferM rep) [(Param FParamMem, SubExp)]
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m [c]
</span><span class="hs-identifier hs-var">zipWithM</span></span><span> </span><span class="annot"><span class="annottext">(Param FParamMem, SubExp)
-&gt; DoubleBuffer
-&gt; WriterT [Stm rep] (DoubleBufferM rep) (Param FParamMem, SubExp)
forall {rep} {t :: (* -&gt; *) -&gt; * -&gt; *} {m :: * -&gt; *} {d} {ret}
       {rep} {inner} {inner}.
(MonadWriter [Stm rep] (t m), Typed (MemInfo d Uniqueness ret),
 HasLetDecMem (LetDec rep), MonadTrans t, MonadFreshNames m,
 OpReturns inner, HasScope rep m, ASTRep rep, BuilderOps rep,
 FParamInfo rep ~ FParamMem, FParamInfo rep ~ FParamInfo rep,
 LParamInfo rep ~ LParamMem, LParamInfo rep ~ LParamInfo rep,
 LetDec rep ~ LetDec rep, BranchType rep ~ BranchTypeMem,
 ExpDec rep ~ (), RetType rep ~ RetTypeMem, LetDec rep ~ LParamMem,
 Op rep ~ MemOp inner, Op rep ~ MemOp inner) =&gt;
(Param (MemInfo d Uniqueness ret), SubExp)
-&gt; DoubleBuffer -&gt; t m (Param (MemInfo d Uniqueness ret), SubExp)
</span><a href="#local-6989586621684443817"><span class="hs-identifier hs-var">allocation</span></a></span><span> </span><span class="annot"><span class="annottext">[(FParam rep, SubExp)]
[(Param FParamMem, SubExp)]
</span><a href="#local-6989586621684443820"><span class="hs-identifier hs-var">merge</span></a></span><span>
</span><span id="line-421"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-422"></span><span>    </span><span id="local-6989586621684443817"><span class="annot"><span class="annottext">allocation :: (Param (MemInfo d Uniqueness ret), SubExp)
-&gt; DoubleBuffer -&gt; t m (Param (MemInfo d Uniqueness ret), SubExp)
</span><a href="#local-6989586621684443817"><span class="hs-identifier hs-var hs-var">allocation</span></a></span></span><span> </span><span id="local-6989586621684443700"><span class="annot"><span class="annottext">m :: (Param (MemInfo d Uniqueness ret), SubExp)
</span><a href="#local-6989586621684443700"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Param"><span class="hs-identifier hs-type">Param</span></a></span><span> </span><span id="local-6989586621684443699"><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684443699"><span class="hs-identifier hs-var">attrs</span></a></span></span><span> </span><span id="local-6989586621684443698"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684443698"><span class="hs-identifier hs-var">pname</span></a></span></span><span> </span><span class="annot"><span class="annottext">MemInfo d Uniqueness ret
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#BufferAlloc"><span class="hs-identifier hs-type">BufferAlloc</span></a></span><span> </span><span id="local-6989586621684443697"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684443697"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621684443696"><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684443696"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span id="local-6989586621684443695"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684443695"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684443694"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684443694"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-423"></span><span>      </span><span id="local-6989586621684443693"><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684443693"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (Stms rep) -&gt; t m (Stms rep)
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(m (Stms rep) -&gt; t m (Stms rep)) -&gt; m (Stms rep) -&gt; t m (Stms rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-424"></span><span>        </span><span class="annot"><span class="annottext">Builder rep () -&gt; m (Stms rep)
forall (m :: * -&gt; *) somerep rep a.
(MonadFreshNames m, HasScope somerep m, SameScope somerep rep) =&gt;
Builder rep a -&gt; m (Stms rep)
</span><a href="Futhark.Builder.html#runBuilder_"><span class="hs-identifier hs-var">runBuilder_</span></a></span><span> </span><span class="annot"><span class="annottext">(Builder rep () -&gt; m (Stms rep)) -&gt; Builder rep () -&gt; m (Stms rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-425"></span><span>          </span><span id="local-6989586621684443691"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684443691"><span class="hs-identifier hs-var">size'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; PrimExp VName -&gt; BuilderT rep (State VNameSource) SubExp
forall (m :: * -&gt; *) a.
(MonadBuilder m, ToExp a) =&gt;
String -&gt; a -&gt; m SubExp
</span><a href="Futhark.Construct.html#toSubExp"><span class="hs-identifier hs-var">toSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;double_buffer_size&quot;</span></span><span> </span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684443696"><span class="hs-identifier hs-var">size</span></a></span><span>
</span><span id="line-426"></span><span>          </span><span class="annot"><span class="annottext">[VName]
-&gt; Exp (Rep (BuilderT rep (State VNameSource))) -&gt; Builder rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[VName] -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBindNames"><span class="hs-identifier hs-var">letBindNames</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684443697"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (BuilderT rep (State VNameSource))) -&gt; Builder rep ())
-&gt; Exp (Rep (BuilderT rep (State VNameSource))) -&gt; Builder rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Op rep -&gt; ExpT rep
forall rep. Op rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-var">Op</span></a></span><span> </span><span class="annot"><span class="annottext">(Op rep -&gt; ExpT rep) -&gt; Op rep -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Space -&gt; MemOp inner
forall inner. SubExp -&gt; Space -&gt; MemOp inner
</span><a href="Futhark.IR.Mem.html#Alloc"><span class="hs-identifier hs-var">Alloc</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684443691"><span class="hs-identifier hs-var">size'</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684443695"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-427"></span><span>      </span><span class="annot"><span class="annottext">[Stm rep] -&gt; t m ()
forall w (m :: * -&gt; *). MonadWriter w m =&gt; w -&gt; m ()
</span><span class="hs-identifier hs-var">tell</span></span><span> </span><span class="annot"><span class="annottext">([Stm rep] -&gt; t m ()) -&gt; [Stm rep] -&gt; t m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stms rep -&gt; [Stm rep]
forall rep. Stms rep -&gt; [Stm rep]
</span><a href="Futhark.IR.Syntax.html#stmsToList"><span class="hs-identifier hs-var">stmsToList</span></a></span><span> </span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684443693"><span class="hs-identifier hs-var">stms</span></a></span><span>
</span><span id="line-428"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684443694"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-429"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">(Param (MemInfo d Uniqueness ret), SubExp)
-&gt; t m (Param (MemInfo d Uniqueness ret), SubExp)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Attrs
-&gt; VName
-&gt; MemInfo d Uniqueness ret
-&gt; Param (MemInfo d Uniqueness ret)
forall dec. Attrs -&gt; VName -&gt; dec -&gt; Param dec
</span><a href="Futhark.IR.Syntax.Core.html#Param"><span class="hs-identifier hs-var">Param</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684443699"><span class="hs-identifier hs-var">attrs</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684443698"><span class="hs-identifier hs-var">pname</span></a></span><span> </span><span class="annot"><span class="annottext">(MemInfo d Uniqueness ret -&gt; Param (MemInfo d Uniqueness ret))
-&gt; MemInfo d Uniqueness ret -&gt; Param (MemInfo d Uniqueness ret)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Space -&gt; MemInfo d Uniqueness ret
forall d u ret. Space -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemMem"><span class="hs-identifier hs-var">MemMem</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684443695"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684443697"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-430"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">(Param (MemInfo d Uniqueness ret), SubExp)
-&gt; t m (Param (MemInfo d Uniqueness ret), SubExp)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Param (MemInfo d Uniqueness ret), SubExp)
</span><a href="#local-6989586621684443700"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-431"></span><span>    </span><span class="annot"><a href="#local-6989586621684443817"><span class="hs-identifier hs-var">allocation</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684443687"><span class="annot"><span class="annottext">Param (MemInfo d Uniqueness ret)
</span><a href="#local-6989586621684443687"><span class="hs-identifier hs-var">f</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684443686"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684443686"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#BufferCopy"><span class="hs-identifier hs-type">BufferCopy</span></a></span><span> </span><span id="local-6989586621684443685"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684443685"><span class="hs-identifier hs-var">mem</span></a></span></span><span> </span><span class="annot"><span class="annottext">IxFun
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684443684"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684443684"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684443684"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-432"></span><span>      </span><span id="local-6989586621684443683"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684443683"><span class="hs-identifier hs-var">v_copy</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m VName -&gt; t m VName
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(m VName -&gt; t m VName) -&gt; m VName -&gt; t m VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; m VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; String -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; m VName) -&gt; String -&gt; m VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; String
</span><a href="Language.Futhark.Core.html#baseString"><span class="hs-identifier hs-var">baseString</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684443686"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_double_buffer_copy&quot;</span></span><span>
</span><span id="line-433"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684443682"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684443682"><span class="hs-identifier hs-var">_v_mem</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684443681"><span class="annot"><span class="annottext">IxFun
</span><a href="#local-6989586621684443681"><span class="hs-identifier hs-var">v_ixfun</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (VName, IxFun) -&gt; t m (VName, IxFun)
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(m (VName, IxFun) -&gt; t m (VName, IxFun))
-&gt; m (VName, IxFun) -&gt; t m (VName, IxFun)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; m (VName, IxFun)
forall rep inner (m :: * -&gt; *).
(Mem rep inner, HasScope rep m, Monad m) =&gt;
VName -&gt; m (VName, IxFun)
</span><a href="Futhark.IR.Mem.html#lookupArraySummary"><span class="hs-identifier hs-var">lookupArraySummary</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684443686"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-434"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684443679"><span class="annot"><span class="annottext">bt :: PrimType
</span><a href="#local-6989586621684443679"><span class="hs-identifier hs-var hs-var">bt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; PrimType
forall shape u. TypeBase shape u -&gt; PrimType
</span><a href="Futhark.IR.Prop.Types.html#elemType"><span class="hs-identifier hs-var">elemType</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; PrimType) -&gt; Type -&gt; PrimType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param (MemInfo d Uniqueness ret) -&gt; Type
forall dec. Typed dec =&gt; Param dec -&gt; Type
</span><a href="Futhark.IR.Prop.Patterns.html#paramType"><span class="hs-identifier hs-var">paramType</span></a></span><span> </span><span class="annot"><span class="annottext">Param (MemInfo d Uniqueness ret)
</span><a href="#local-6989586621684443687"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-435"></span><span>          </span><span id="local-6989586621684443677"><span class="annot"><span class="annottext">shape :: ShapeBase SubExp
</span><a href="#local-6989586621684443677"><span class="hs-identifier hs-var hs-var">shape</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; ShapeBase SubExp
forall shape u. ArrayShape shape =&gt; TypeBase shape u -&gt; shape
</span><a href="Futhark.IR.Prop.Types.html#arrayShape"><span class="hs-identifier hs-var">arrayShape</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; ShapeBase SubExp) -&gt; Type -&gt; ShapeBase SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param (MemInfo d Uniqueness ret) -&gt; Type
forall dec. Typed dec =&gt; Param dec -&gt; Type
</span><a href="Futhark.IR.Prop.Patterns.html#paramType"><span class="hs-identifier hs-var">paramType</span></a></span><span> </span><span class="annot"><span class="annottext">Param (MemInfo d Uniqueness ret)
</span><a href="#local-6989586621684443687"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-436"></span><span>          </span><span id="local-6989586621684443675"><span class="annot"><span class="annottext">bound :: LParamMem
</span><a href="#local-6989586621684443675"><span class="hs-identifier hs-var hs-var">bound</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimType
-&gt; ShapeBase SubExp -&gt; NoUniqueness -&gt; MemBind -&gt; LParamMem
forall d u ret.
PrimType -&gt; ShapeBase d -&gt; u -&gt; ret -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-var">MemArray</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684443679"><span class="hs-identifier hs-var">bt</span></a></span><span> </span><span class="annot"><span class="annottext">ShapeBase SubExp
</span><a href="#local-6989586621684443677"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">NoUniqueness
</span><a href="Futhark.IR.Syntax.Core.html#NoUniqueness"><span class="hs-identifier hs-var">NoUniqueness</span></a></span><span> </span><span class="annot"><span class="annottext">(MemBind -&gt; LParamMem) -&gt; MemBind -&gt; LParamMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; IxFun -&gt; MemBind
</span><a href="Futhark.IR.Mem.html#ArrayIn"><span class="hs-identifier hs-var">ArrayIn</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684443685"><span class="hs-identifier hs-var">mem</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun
</span><a href="#local-6989586621684443681"><span class="hs-identifier hs-var">v_ixfun</span></a></span><span>
</span><span id="line-437"></span><span>      </span><span class="annot"><span class="annottext">[Stm rep] -&gt; t m ()
forall w (m :: * -&gt; *). MonadWriter w m =&gt; w -&gt; m ()
</span><span class="hs-identifier hs-var">tell</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Pat rep -&gt; StmAux (ExpDec rep) -&gt; ExpT rep -&gt; Stm rep
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PatElemT LParamMem] -&gt; PatT LParamMem
forall dec. [PatElemT dec] -&gt; PatT dec
</span><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-var">Pat</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">VName -&gt; LParamMem -&gt; PatElemT LParamMem
forall dec. VName -&gt; dec -&gt; PatElemT dec
</span><a href="Futhark.IR.Syntax.Core.html#PatElem"><span class="hs-identifier hs-var">PatElem</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684443683"><span class="hs-identifier hs-var">v_copy</span></a></span><span> </span><span class="annot"><span class="annottext">LParamMem
</span><a href="#local-6989586621684443675"><span class="hs-identifier hs-var">bound</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; StmAux ()
forall dec. dec -&gt; StmAux dec
</span><a href="Futhark.IR.Prop.html#defAux"><span class="hs-identifier hs-var">defAux</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ExpT rep -&gt; Stm rep) -&gt; ExpT rep -&gt; Stm rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Copy"><span class="hs-identifier hs-var">Copy</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684443686"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-438"></span><span>      </span><span class="hs-comment">-- It is important that we treat this as a consumption, to</span><span>
</span><span id="line-439"></span><span>      </span><span class="hs-comment">-- avoid the Copy from being hoisted out of any enclosing</span><span>
</span><span id="line-440"></span><span>      </span><span class="hs-comment">-- loops.  Since we re-use (=overwrite) memory in the loop,</span><span>
</span><span id="line-441"></span><span>      </span><span class="hs-comment">-- the copy is critical for initialisation.  See issue #816.</span><span>
</span><span id="line-442"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684443673"><span class="annot"><span class="annottext">uniqueMemInfo :: MemInfo d Uniqueness ret -&gt; MemInfo d Uniqueness ret
</span><a href="#local-6989586621684443673"><span class="hs-identifier hs-var hs-var">uniqueMemInfo</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-type">MemArray</span></a></span><span> </span><span id="local-6989586621684443672"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684443672"><span class="hs-identifier hs-var">pt</span></a></span></span><span> </span><span id="local-6989586621684443671"><span class="annot"><span class="annottext">ShapeBase d
</span><a href="#local-6989586621684443671"><span class="hs-identifier hs-var">pshape</span></a></span></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684443670"><span class="annot"><span class="annottext">ret
</span><a href="#local-6989586621684443670"><span class="hs-identifier hs-var">ret</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-443"></span><span>            </span><span class="annot"><span class="annottext">PrimType
-&gt; ShapeBase d -&gt; Uniqueness -&gt; ret -&gt; MemInfo d Uniqueness ret
forall d u ret.
PrimType -&gt; ShapeBase d -&gt; u -&gt; ret -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-var">MemArray</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684443672"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">ShapeBase d
</span><a href="#local-6989586621684443671"><span class="hs-identifier hs-var">pshape</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="Language.Futhark.Core.html#Unique"><span class="hs-identifier hs-var">Unique</span></a></span><span> </span><span class="annot"><span class="annottext">ret
</span><a href="#local-6989586621684443670"><span class="hs-identifier hs-var">ret</span></a></span><span>
</span><span id="line-444"></span><span>          </span><span class="annot"><a href="#local-6989586621684443673"><span class="hs-identifier hs-var">uniqueMemInfo</span></a></span><span> </span><span id="local-6989586621684443669"><span class="annot"><span class="annottext">MemInfo d Uniqueness ret
</span><a href="#local-6989586621684443669"><span class="hs-identifier hs-var">info</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MemInfo d Uniqueness ret
</span><a href="#local-6989586621684443669"><span class="hs-identifier hs-var">info</span></a></span><span>
</span><span id="line-445"></span><span>      </span><span class="annot"><span class="annottext">(Param (MemInfo d Uniqueness ret), SubExp)
-&gt; t m (Param (MemInfo d Uniqueness ret), SubExp)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MemInfo d Uniqueness ret -&gt; MemInfo d Uniqueness ret
forall {d} {ret}.
MemInfo d Uniqueness ret -&gt; MemInfo d Uniqueness ret
</span><a href="#local-6989586621684443673"><span class="hs-identifier hs-var">uniqueMemInfo</span></a></span><span> </span><span class="annot"><span class="annottext">(MemInfo d Uniqueness ret -&gt; MemInfo d Uniqueness ret)
-&gt; Param (MemInfo d Uniqueness ret)
-&gt; Param (MemInfo d Uniqueness ret)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Param (MemInfo d Uniqueness ret)
</span><a href="#local-6989586621684443687"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684443683"><span class="hs-identifier hs-var">v_copy</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-446"></span><span>    </span><span class="annot"><a href="#local-6989586621684443817"><span class="hs-identifier hs-var">allocation</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684443668"><span class="annot"><span class="annottext">Param (MemInfo d Uniqueness ret)
</span><a href="#local-6989586621684443668"><span class="hs-identifier hs-var">f</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684443667"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684443667"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DoubleBuffer
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-447"></span><span>      </span><span class="annot"><span class="annottext">(Param (MemInfo d Uniqueness ret), SubExp)
-&gt; t m (Param (MemInfo d Uniqueness ret), SubExp)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param (MemInfo d Uniqueness ret)
</span><a href="#local-6989586621684443668"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684443667"><span class="hs-identifier hs-var">se</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-448"></span><span>
</span><span id="line-449"></span><span id="local-6989586621684445247"><span id="local-6989586621684445248"><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#doubleBufferResult"><span class="hs-identifier hs-type">doubleBufferResult</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-450"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#Constraints"><span class="hs-identifier hs-type">Constraints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445248"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445247"><span class="hs-identifier hs-type">inner</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-451"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#FParam"><span class="hs-identifier hs-type">FParam</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445248"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-452"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#DoubleBuffer"><span class="hs-identifier hs-type">DoubleBuffer</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-453"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445248"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-454"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684445248"><span class="hs-identifier hs-type">rep</span></a></span></span></span><span>
</span><span id="line-455"></span><span id="doubleBufferResult"><span class="annot"><span class="annottext">doubleBufferResult :: forall rep inner.
Constraints rep inner =&gt;
[FParam rep] -&gt; [DoubleBuffer] -&gt; Body rep -&gt; Body rep
</span><a href="Futhark.Optimise.DoubleBuffer.html#doubleBufferResult"><span class="hs-identifier hs-var hs-var">doubleBufferResult</span></a></span></span><span> </span><span id="local-6989586621684443635"><span class="annot"><span class="annottext">[FParam rep]
</span><a href="#local-6989586621684443635"><span class="hs-identifier hs-var">valparams</span></a></span></span><span> </span><span id="local-6989586621684443634"><span class="annot"><span class="annottext">[DoubleBuffer]
</span><a href="#local-6989586621684443634"><span class="hs-identifier hs-var">buffered</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><span class="annottext">BodyDec rep
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684443633"><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684443633"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span id="local-6989586621684443632"><span class="annot"><span class="annottext">[SubExpRes]
</span><a href="#local-6989586621684443632"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-456"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684443631"><span class="annot"><span class="annottext">[SubExpRes]
</span><a href="#local-6989586621684443631"><span class="hs-identifier hs-var">ctx_res</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684443630"><span class="annot"><span class="annottext">[SubExpRes]
</span><a href="#local-6989586621684443630"><span class="hs-identifier hs-var">val_res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [SubExpRes] -&gt; ([SubExpRes], [SubExpRes])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExpRes] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExpRes]
</span><a href="#local-6989586621684443632"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">[Param FParamMem] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[FParam rep]
[Param FParamMem]
</span><a href="#local-6989586621684443635"><span class="hs-identifier hs-var">valparams</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SubExpRes]
</span><a href="#local-6989586621684443632"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-457"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684443627"><span class="annot"><span class="annottext">[Maybe (Stm rep)]
</span><a href="#local-6989586621684443627"><span class="hs-identifier hs-var">copystms</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684443626"><span class="annot"><span class="annottext">[SubExpRes]
</span><a href="#local-6989586621684443626"><span class="hs-identifier hs-var">val_res'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-458"></span><span>        </span><span class="annot"><span class="annottext">[(Maybe (Stm rep), SubExpRes)] -&gt; ([Maybe (Stm rep)], [SubExpRes])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(Maybe (Stm rep), SubExpRes)]
 -&gt; ([Maybe (Stm rep)], [SubExpRes]))
-&gt; [(Maybe (Stm rep), SubExpRes)]
-&gt; ([Maybe (Stm rep)], [SubExpRes])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Param FParamMem
 -&gt; DoubleBuffer -&gt; SubExpRes -&gt; (Maybe (Stm rep), SubExpRes))
-&gt; [Param FParamMem]
-&gt; [DoubleBuffer]
-&gt; [SubExpRes]
-&gt; [(Maybe (Stm rep), SubExpRes)]
forall a b c d. (a -&gt; b -&gt; c -&gt; d) -&gt; [a] -&gt; [b] -&gt; [c] -&gt; [d]
</span><span class="hs-identifier hs-var">zipWith3</span></span><span> </span><span class="annot"><span class="annottext">Param FParamMem
-&gt; DoubleBuffer -&gt; SubExpRes -&gt; (Maybe (Stm rep), SubExpRes)
</span><a href="#local-6989586621684443623"><span class="hs-identifier hs-var">buffer</span></a></span><span> </span><span class="annot"><span class="annottext">[FParam rep]
[Param FParamMem]
</span><a href="#local-6989586621684443635"><span class="hs-identifier hs-var">valparams</span></a></span><span> </span><span class="annot"><span class="annottext">[DoubleBuffer]
</span><a href="#local-6989586621684443634"><span class="hs-identifier hs-var">buffered</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExpRes]
</span><a href="#local-6989586621684443630"><span class="hs-identifier hs-var">val_res</span></a></span><span>
</span><span id="line-459"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">BodyDec rep -&gt; Stms rep -&gt; [SubExpRes] -&gt; BodyT rep
forall rep. BodyDec rep -&gt; Stms rep -&gt; [SubExpRes] -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-var">Body</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684443633"><span class="hs-identifier hs-var">stms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms rep -&gt; Stms rep -&gt; Stms rep
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Stm rep] -&gt; Stms rep
forall rep. [Stm rep] -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#stmsFromList"><span class="hs-identifier hs-var">stmsFromList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Maybe (Stm rep)] -&gt; [Stm rep]
forall a. [Maybe a] -&gt; [a]
</span><span class="hs-identifier hs-var">catMaybes</span></span><span> </span><span class="annot"><span class="annottext">[Maybe (Stm rep)]
</span><a href="#local-6989586621684443627"><span class="hs-identifier hs-var">copystms</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([SubExpRes] -&gt; BodyT rep) -&gt; [SubExpRes] -&gt; BodyT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[SubExpRes]
</span><a href="#local-6989586621684443631"><span class="hs-identifier hs-var">ctx_res</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExpRes] -&gt; [SubExpRes] -&gt; [SubExpRes]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[SubExpRes]
</span><a href="#local-6989586621684443626"><span class="hs-identifier hs-var">val_res'</span></a></span><span>
</span><span id="line-460"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-461"></span><span>    </span><span id="local-6989586621684443623"><span class="annot"><span class="annottext">buffer :: Param FParamMem
-&gt; DoubleBuffer -&gt; SubExpRes -&gt; (Maybe (Stm rep), SubExpRes)
</span><a href="#local-6989586621684443623"><span class="hs-identifier hs-var hs-var">buffer</span></a></span></span><span> </span><span class="annot"><span class="annottext">Param FParamMem
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#BufferAlloc"><span class="hs-identifier hs-type">BufferAlloc</span></a></span><span> </span><span id="local-6989586621684443621"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684443621"><span class="hs-identifier hs-var">bufname</span></a></span></span><span> </span><span class="annot"><span class="annottext">PrimExp VName
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Space
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684443620"><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684443620"><span class="hs-identifier hs-var">se</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-462"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (Stm rep)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684443620"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">resSubExp :: SubExp
</span><a href="Futhark.IR.Syntax.html#resSubExp"><span class="hs-identifier hs-var">resSubExp</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684443621"><span class="hs-identifier hs-var">bufname</span></a></span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-463"></span><span>    </span><span class="annot"><a href="#local-6989586621684443623"><span class="hs-identifier hs-var">buffer</span></a></span><span> </span><span id="local-6989586621684443619"><span class="annot"><span class="annottext">Param FParamMem
</span><a href="#local-6989586621684443619"><span class="hs-identifier hs-var">fparam</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.DoubleBuffer.html#BufferCopy"><span class="hs-identifier hs-type">BufferCopy</span></a></span><span> </span><span id="local-6989586621684443618"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684443618"><span class="hs-identifier hs-var">bufname</span></a></span></span><span> </span><span id="local-6989586621684443617"><span class="annot"><span class="annottext">IxFun
</span><a href="#local-6989586621684443617"><span class="hs-identifier hs-var">ixfun</span></a></span></span><span> </span><span id="local-6989586621684443616"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684443616"><span class="hs-identifier hs-var">copyname</span></a></span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-type">SubExpRes</span></a></span><span> </span><span id="local-6989586621684443615"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684443615"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684443614"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684443614"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-464"></span><span>      </span><span class="hs-comment">-- To construct the copy we will need to figure out its type</span><span>
</span><span id="line-465"></span><span>      </span><span class="hs-comment">-- based on the type of the function parameter.</span><span>
</span><span id="line-466"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684443613"><span class="annot"><span class="annottext">t :: Type
</span><a href="#local-6989586621684443613"><span class="hs-identifier hs-var hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
</span><a href="#local-6989586621684443612"><span class="hs-identifier hs-var">resultType</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Type) -&gt; Type -&gt; Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param FParamMem -&gt; Type
forall dec. Typed dec =&gt; Param dec -&gt; Type
</span><a href="Futhark.IR.Prop.Patterns.html#paramType"><span class="hs-identifier hs-var">paramType</span></a></span><span> </span><span class="annot"><span class="annottext">Param FParamMem
</span><a href="#local-6989586621684443619"><span class="hs-identifier hs-var">fparam</span></a></span><span>
</span><span id="line-467"></span><span>          </span><span id="local-6989586621684443611"><span class="annot"><span class="annottext">summary :: LParamMem
</span><a href="#local-6989586621684443611"><span class="hs-identifier hs-var hs-var">summary</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimType
-&gt; ShapeBase SubExp -&gt; NoUniqueness -&gt; MemBind -&gt; LParamMem
forall d u ret.
PrimType -&gt; ShapeBase d -&gt; u -&gt; ret -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-var">MemArray</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; PrimType
forall shape u. TypeBase shape u -&gt; PrimType
</span><a href="Futhark.IR.Prop.Types.html#elemType"><span class="hs-identifier hs-var">elemType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684443613"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; ShapeBase SubExp
forall shape u. ArrayShape shape =&gt; TypeBase shape u -&gt; shape
</span><a href="Futhark.IR.Prop.Types.html#arrayShape"><span class="hs-identifier hs-var">arrayShape</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684443613"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">NoUniqueness
</span><a href="Futhark.IR.Syntax.Core.html#NoUniqueness"><span class="hs-identifier hs-var">NoUniqueness</span></a></span><span> </span><span class="annot"><span class="annottext">(MemBind -&gt; LParamMem) -&gt; MemBind -&gt; LParamMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; IxFun -&gt; MemBind
</span><a href="Futhark.IR.Mem.html#ArrayIn"><span class="hs-identifier hs-var">ArrayIn</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684443618"><span class="hs-identifier hs-var">bufname</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun
</span><a href="#local-6989586621684443617"><span class="hs-identifier hs-var">ixfun</span></a></span><span>
</span><span id="line-468"></span><span>          </span><span id="local-6989586621684443610"><span class="annot"><span class="annottext">copystm :: Stm rep
</span><a href="#local-6989586621684443610"><span class="hs-identifier hs-var hs-var">copystm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-469"></span><span>            </span><span class="annot"><span class="annottext">Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PatElemT LParamMem] -&gt; PatT LParamMem
forall dec. [PatElemT dec] -&gt; PatT dec
</span><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-var">Pat</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">VName -&gt; LParamMem -&gt; PatElemT LParamMem
forall dec. VName -&gt; dec -&gt; PatElemT dec
</span><a href="Futhark.IR.Syntax.Core.html#PatElem"><span class="hs-identifier hs-var">PatElem</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684443616"><span class="hs-identifier hs-var">copyname</span></a></span><span> </span><span class="annot"><span class="annottext">LParamMem
</span><a href="#local-6989586621684443611"><span class="hs-identifier hs-var">summary</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; StmAux ()
forall dec. dec -&gt; StmAux dec
</span><a href="Futhark.IR.Prop.html#defAux"><span class="hs-identifier hs-var">defAux</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Exp rep -&gt; Stm rep) -&gt; Exp rep -&gt; Stm rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-470"></span><span>              </span><span class="annot"><span class="annottext">BasicOp -&gt; Exp rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; Exp rep) -&gt; BasicOp -&gt; Exp rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Copy"><span class="hs-identifier hs-var">Copy</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684443614"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-471"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stm rep -&gt; Maybe (Stm rep)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684443610"><span class="hs-identifier hs-var">copystm</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Certs -&gt; SubExp -&gt; SubExpRes
</span><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-var">SubExpRes</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684443615"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684443616"><span class="hs-identifier hs-var">copyname</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-472"></span><span>    </span><span class="annot"><a href="#local-6989586621684443623"><span class="hs-identifier hs-var">buffer</span></a></span><span> </span><span class="annot"><span class="annottext">Param FParamMem
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">DoubleBuffer
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684443609"><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684443609"><span class="hs-identifier hs-var">se</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-473"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (Stm rep)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684443609"><span class="hs-identifier hs-var">se</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-474"></span><span>
</span><span id="line-475"></span><span>    </span><span id="local-6989586621684443608"><span class="annot"><span class="annottext">parammap :: Map VName SubExp
</span><a href="#local-6989586621684443608"><span class="hs-identifier hs-var hs-var">parammap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VName, SubExp)] -&gt; Map VName SubExp
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="annot"><span class="annottext">([(VName, SubExp)] -&gt; Map VName SubExp)
-&gt; [(VName, SubExp)] -&gt; Map VName SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [SubExp] -&gt; [(VName, SubExp)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Param FParamMem -&gt; VName) -&gt; [Param FParamMem] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Param FParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">[FParam rep]
[Param FParamMem]
</span><a href="#local-6989586621684443635"><span class="hs-identifier hs-var">valparams</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [(VName, SubExp)]) -&gt; [SubExp] -&gt; [(VName, SubExp)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExpRes -&gt; SubExp) -&gt; [SubExpRes] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExpRes -&gt; SubExp
</span><a href="Futhark.IR.Syntax.html#resSubExp"><span class="hs-identifier hs-var hs-var">resSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExpRes]
</span><a href="#local-6989586621684443632"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-476"></span><span>
</span><span id="line-477"></span><span>    </span><span id="local-6989586621684443612"><span class="annot"><span class="annottext">resultType :: Type -&gt; Type
</span><a href="#local-6989586621684443612"><span class="hs-identifier hs-var hs-var">resultType</span></a></span></span><span> </span><span id="local-6989586621684443606"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684443606"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684443606"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; [SubExp] -&gt; Type
forall oldshape u.
TypeBase oldshape u -&gt; [SubExp] -&gt; TypeBase (ShapeBase SubExp) u
</span><a href="Futhark.IR.Prop.Types.html#setArrayDims"><span class="hs-operator hs-var">`setArrayDims`</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; SubExp) -&gt; [SubExp] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; SubExp
</span><a href="#local-6989586621684443604"><span class="hs-identifier hs-var">substitute</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; [SubExp]
forall u. TypeBase (ShapeBase SubExp) u -&gt; [SubExp]
</span><a href="Futhark.IR.Prop.Types.html#arrayDims"><span class="hs-identifier hs-var">arrayDims</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684443606"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-478"></span><span>
</span><span id="line-479"></span><span>    </span><span id="local-6989586621684443604"><span class="annot"><span class="annottext">substitute :: SubExp -&gt; SubExp
</span><a href="#local-6989586621684443604"><span class="hs-identifier hs-var hs-var">substitute</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684443602"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684443602"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-480"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684443601"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684443601"><span class="hs-identifier hs-var">replacement</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Map VName SubExp -&gt; Maybe SubExp
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684443602"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SubExp
</span><a href="#local-6989586621684443608"><span class="hs-identifier hs-var">parammap</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684443601"><span class="hs-identifier hs-var">replacement</span></a></span><span>
</span><span id="line-481"></span><span>    </span><span class="annot"><a href="#local-6989586621684443604"><span class="hs-identifier hs-var">substitute</span></a></span><span> </span><span id="local-6989586621684443600"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684443600"><span class="hs-identifier hs-var">se</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-482"></span><span>      </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684443600"><span class="hs-identifier hs-var">se</span></a></span><span>
</span><span id="line-483"></span></pre></body></html>