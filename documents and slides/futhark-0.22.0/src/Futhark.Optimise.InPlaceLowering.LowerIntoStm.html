<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-3"></span><span>
</span><span id="line-4"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Futhark.Optimise.InPlaceLowering.LowerIntoStm</span><span>
</span><span id="line-5"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#lowerUpdateGPU"><span class="hs-identifier">lowerUpdateGPU</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-6"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#lowerUpdate"><span class="hs-identifier">lowerUpdate</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-7"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#LowerUpdate"><span class="hs-identifier">LowerUpdate</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-8"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#DesiredUpdate"><span class="hs-identifier">DesiredUpdate</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-9"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-10"></span><span class="hs-keyword">where</span><span>
</span><span id="line-11"></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Writer</span></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Either</span></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">find</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">unzip4</span></span><span class="hs-special">)</span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">isNothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">mapMaybe</span></span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Analysis.PrimExp.Convert.html"><span class="hs-identifier">Futhark.Analysis.PrimExp.Convert</span></a></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Construct.html"><span class="hs-identifier">Futhark.Construct</span></a></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.Aliases.html"><span class="hs-identifier">Futhark.IR.Aliases</span></a></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html"><span class="hs-identifier">Futhark.IR.GPU</span></a></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.SubstituteIndices.html"><span class="hs-identifier">Futhark.Optimise.InPlaceLowering.SubstituteIndices</span></a></span><span>
</span><span id="line-22"></span><span>
</span><span id="line-23"></span><span class="hs-keyword">data</span><span> </span><span id="DesiredUpdate"><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#DesiredUpdate"><span class="hs-identifier hs-var">DesiredUpdate</span></a></span></span><span> </span><span id="local-6989586621684427710"><span class="annot"><a href="#local-6989586621684427710"><span class="hs-identifier hs-type">dec</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="DesiredUpdate"><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#DesiredUpdate"><span class="hs-identifier hs-var">DesiredUpdate</span></a></span></span><span>
</span><span id="line-24"></span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- | Name of result.</span><span>
</span><span id="line-25"></span><span>    </span><span id="updateName"><span class="annot"><span class="annottext">forall dec. DesiredUpdate dec -&gt; VName
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#updateName"><span class="hs-identifier hs-var hs-var">updateName</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-26"></span><span>    </span><span class="hs-comment">-- | Type of result.</span><span>
</span><span id="line-27"></span><span>    </span><span id="updateType"><span class="annot"><span class="annottext">forall dec. DesiredUpdate dec -&gt; dec
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#updateType"><span class="hs-identifier hs-var hs-var">updateType</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621684427710"><span class="hs-identifier hs-type">dec</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-28"></span><span>    </span><span id="updateCerts"><span class="annot"><span class="annottext">forall dec. DesiredUpdate dec -&gt; Certs
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#updateCerts"><span class="hs-identifier hs-var hs-var">updateCerts</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Certs"><span class="hs-identifier hs-type">Certs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-29"></span><span>    </span><span id="updateSource"><span class="annot"><span class="annottext">forall dec. DesiredUpdate dec -&gt; VName
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#updateSource"><span class="hs-identifier hs-var hs-var">updateSource</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-30"></span><span>    </span><span id="updateIndices"><span class="annot"><span class="annottext">forall dec. DesiredUpdate dec -&gt; Slice SubExp
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#updateIndices"><span class="hs-identifier hs-var hs-var">updateIndices</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-type">Slice</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-31"></span><span>    </span><span id="updateValue"><span class="annot"><span class="annottext">forall dec. DesiredUpdate dec -&gt; VName
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#updateValue"><span class="hs-identifier hs-var hs-var">updateValue</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span>
</span><span id="line-32"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-33"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684427347"><span id="local-6989586621684427349"><span id="local-6989586621684427363"><span class="annot"><span class="annottext">Int -&gt; DesiredUpdate dec -&gt; ShowS
[DesiredUpdate dec] -&gt; ShowS
DesiredUpdate dec -&gt; String
(Int -&gt; DesiredUpdate dec -&gt; ShowS)
-&gt; (DesiredUpdate dec -&gt; String)
-&gt; ([DesiredUpdate dec] -&gt; ShowS)
-&gt; Show (DesiredUpdate dec)
forall dec. Show dec =&gt; Int -&gt; DesiredUpdate dec -&gt; ShowS
forall dec. Show dec =&gt; [DesiredUpdate dec] -&gt; ShowS
forall dec. Show dec =&gt; DesiredUpdate dec -&gt; String
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [DesiredUpdate dec] -&gt; ShowS
$cshowList :: forall dec. Show dec =&gt; [DesiredUpdate dec] -&gt; ShowS
show :: DesiredUpdate dec -&gt; String
$cshow :: forall dec. Show dec =&gt; DesiredUpdate dec -&gt; String
showsPrec :: Int -&gt; DesiredUpdate dec -&gt; ShowS
$cshowsPrec :: forall dec. Show dec =&gt; Int -&gt; DesiredUpdate dec -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-34"></span><span>
</span><span id="line-35"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621684427342"><span class="annot"><span class="hs-identifier hs-type">Functor</span></span><span> </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#DesiredUpdate"><span class="hs-identifier hs-type">DesiredUpdate</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-36"></span><span>  </span><span id="local-6989586621684427340"><span class="annot"><span class="annottext">a -&gt; b
</span><a href="#local-6989586621684427340"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621684427339"><span class="annot"><span class="annottext">fmap :: forall a b. (a -&gt; b) -&gt; DesiredUpdate a -&gt; DesiredUpdate b
</span><span class="hs-operator hs-var hs-var hs-var hs-var">`fmap`</span></span></span><span> </span><span id="local-6989586621684427338"><span class="annot"><span class="annottext">DesiredUpdate a
</span><a href="#local-6989586621684427338"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DesiredUpdate a
</span><a href="#local-6989586621684427338"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">updateType :: b
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#updateType"><span class="hs-identifier hs-var">updateType</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; b
</span><a href="#local-6989586621684427340"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">(a -&gt; b) -&gt; a -&gt; b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DesiredUpdate a -&gt; a
forall dec. DesiredUpdate dec -&gt; dec
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#updateType"><span class="hs-identifier hs-var hs-var">updateType</span></a></span><span> </span><span class="annot"><span class="annottext">DesiredUpdate a
</span><a href="#local-6989586621684427338"><span class="hs-identifier hs-var">u</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-37"></span><span>
</span><span id="line-38"></span><span id="local-6989586621684427686"><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#updateHasValue"><span class="hs-identifier hs-type">updateHasValue</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#DesiredUpdate"><span class="hs-identifier hs-type">DesiredUpdate</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684427686"><span class="hs-identifier hs-type">dec</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span><span>
</span><span id="line-39"></span><span id="updateHasValue"><span class="annot"><span class="annottext">updateHasValue :: forall dec. VName -&gt; DesiredUpdate dec -&gt; Bool
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#updateHasValue"><span class="hs-identifier hs-var hs-var">updateHasValue</span></a></span></span><span> </span><span id="local-6989586621684427334"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684427334"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684427334"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; VName -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Bool)
-&gt; (DesiredUpdate dec -&gt; VName) -&gt; DesiredUpdate dec -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">DesiredUpdate dec -&gt; VName
forall dec. DesiredUpdate dec -&gt; VName
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#updateValue"><span class="hs-identifier hs-var hs-var">updateValue</span></a></span><span>
</span><span id="line-40"></span><span>
</span><span id="line-41"></span><span class="hs-keyword">type</span><span> </span><span id="LowerUpdate"><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#LowerUpdate"><span class="hs-identifier hs-var">LowerUpdate</span></a></span></span><span> </span><span id="local-6989586621684427332"><span class="annot"><a href="#local-6989586621684427332"><span class="hs-identifier hs-type">rep</span></a></span></span><span> </span><span id="local-6989586621684427331"><span class="annot"><a href="#local-6989586621684427331"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-42"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Aliases.html#Aliases"><span class="hs-identifier hs-type">Aliases</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684427332"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-43"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Aliases.html#Aliases"><span class="hs-identifier hs-type">Aliases</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684427332"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-44"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#DesiredUpdate"><span class="hs-identifier hs-type">DesiredUpdate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#LetDec"><span class="hs-identifier hs-type">LetDec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Aliases.html#Aliases"><span class="hs-identifier hs-type">Aliases</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684427332"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-45"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621684427331"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Aliases.html#Aliases"><span class="hs-identifier hs-type">Aliases</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684427332"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span>
</span><span id="line-47"></span><span id="local-6989586621684427678"><span id="local-6989586621684427680"><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#lowerUpdate"><span class="hs-identifier hs-type">lowerUpdate</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-48"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.MonadFreshNames.html#MonadFreshNames"><span class="hs-identifier hs-type">MonadFreshNames</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684427680"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-49"></span><span>    </span><span class="annot"><a href="Futhark.Builder.Class.html#Buildable"><span class="hs-identifier hs-type">Buildable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684427678"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-50"></span><span>    </span><span class="annot"><a href="Futhark.IR.Rep.html#LetDec"><span class="hs-identifier hs-type">LetDec</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684427678"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">~</span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-51"></span><span>    </span><span class="annot"><a href="Futhark.IR.Prop.Aliases.html#CanBeAliased"><span class="hs-identifier hs-type">CanBeAliased</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684427678"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-53"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#LowerUpdate"><span class="hs-identifier hs-type">LowerUpdate</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684427678"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684427680"><span class="hs-identifier hs-type">m</span></a></span></span></span><span>
</span><span id="line-54"></span><span id="lowerUpdate"><span class="annot"><span class="annottext">lowerUpdate :: forall (m :: * -&gt; *) rep.
(MonadFreshNames m, Buildable rep, LetDec rep ~ Type,
 CanBeAliased (Op rep)) =&gt;
LowerUpdate rep m
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#lowerUpdate"><span class="hs-identifier hs-var hs-var">lowerUpdate</span></a></span></span><span> </span><span id="local-6989586621684427270"><span class="annot"><span class="annottext">Scope (Aliases rep)
</span><a href="#local-6989586621684427270"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684427268"><span class="annot"><span class="annottext">Pat (Aliases rep)
</span><a href="#local-6989586621684427268"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684427267"><span class="annot"><span class="annottext">StmAux (ExpDec (Aliases rep))
</span><a href="#local-6989586621684427267"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#DoLoop"><span class="hs-identifier hs-type">DoLoop</span></a></span><span> </span><span id="local-6989586621684427265"><span class="annot"><span class="annottext">[(FParam (Aliases rep), SubExp)]
</span><a href="#local-6989586621684427265"><span class="hs-identifier hs-var">merge</span></a></span></span><span> </span><span id="local-6989586621684427264"><span class="annot"><span class="annottext">LoopForm (Aliases rep)
</span><a href="#local-6989586621684427264"><span class="hs-identifier hs-var">form</span></a></span></span><span> </span><span id="local-6989586621684427263"><span class="annot"><span class="annottext">BodyT (Aliases rep)
</span><a href="#local-6989586621684427263"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621684427262"><span class="annot"><span class="annottext">[DesiredUpdate (LetDec (Aliases rep))]
</span><a href="#local-6989586621684427262"><span class="hs-identifier hs-var">updates</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-55"></span><span>  </span><span id="local-6989586621684427261"><span class="annot"><span class="annottext">m ([Stm (Aliases rep)], [Stm (Aliases rep)], [Ident],
   [(Param DeclType, SubExp)], BodyT (Aliases rep))
</span><a href="#local-6989586621684427261"><span class="hs-identifier hs-var">canDo</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Scope (Aliases rep)
-&gt; [DesiredUpdate (LetDec (Aliases rep))]
-&gt; Pat (Aliases rep)
-&gt; [(FParam (Aliases rep), SubExp)]
-&gt; LoopForm (Aliases rep)
-&gt; BodyT (Aliases rep)
-&gt; Maybe
     (m ([Stm (Aliases rep)], [Stm (Aliases rep)], [Ident],
         [(FParam (Aliases rep), SubExp)], BodyT (Aliases rep)))
forall rep als (m :: * -&gt; *).
(Buildable rep, BuilderOps rep, Aliased rep,
 LetDec rep ~ (als, Type), MonadFreshNames m) =&gt;
Scope rep
-&gt; [DesiredUpdate (LetDec rep)]
-&gt; Pat rep
-&gt; [(FParam rep, SubExp)]
-&gt; LoopForm rep
-&gt; Body rep
-&gt; Maybe
     (m ([Stm rep], [Stm rep], [Ident], [(FParam rep, SubExp)],
         Body rep))
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#lowerUpdateIntoLoop"><span class="hs-identifier hs-var">lowerUpdateIntoLoop</span></a></span><span> </span><span class="annot"><span class="annottext">Scope (Aliases rep)
</span><a href="#local-6989586621684427270"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="annot"><span class="annottext">[DesiredUpdate (LetDec (Aliases rep))]
</span><a href="#local-6989586621684427262"><span class="hs-identifier hs-var">updates</span></a></span><span> </span><span class="annot"><span class="annottext">Pat (Aliases rep)
</span><a href="#local-6989586621684427268"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">[(FParam (Aliases rep), SubExp)]
</span><a href="#local-6989586621684427265"><span class="hs-identifier hs-var">merge</span></a></span><span> </span><span class="annot"><span class="annottext">LoopForm (Aliases rep)
</span><a href="#local-6989586621684427264"><span class="hs-identifier hs-var">form</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT (Aliases rep)
</span><a href="#local-6989586621684427263"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-56"></span><span>  </span><span class="annot"><span class="annottext">m [Stm (Aliases rep)] -&gt; Maybe (m [Stm (Aliases rep)])
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(m [Stm (Aliases rep)] -&gt; Maybe (m [Stm (Aliases rep)]))
-&gt; m [Stm (Aliases rep)] -&gt; Maybe (m [Stm (Aliases rep)])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-57"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684427259"><span class="annot"><span class="annottext">[Stm (Aliases rep)]
</span><a href="#local-6989586621684427259"><span class="hs-identifier hs-var">prestms</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684427258"><span class="annot"><span class="annottext">[Stm (Aliases rep)]
</span><a href="#local-6989586621684427258"><span class="hs-identifier hs-var">poststms</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684427257"><span class="annot"><span class="annottext">[Ident]
</span><a href="#local-6989586621684427257"><span class="hs-identifier hs-var">pat'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684427256"><span class="annot"><span class="annottext">[(Param DeclType, SubExp)]
</span><a href="#local-6989586621684427256"><span class="hs-identifier hs-var">merge'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684427255"><span class="annot"><span class="annottext">BodyT (Aliases rep)
</span><a href="#local-6989586621684427255"><span class="hs-identifier hs-var">body'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m ([Stm (Aliases rep)], [Stm (Aliases rep)], [Ident],
   [(Param DeclType, SubExp)], BodyT (Aliases rep))
</span><a href="#local-6989586621684427261"><span class="hs-identifier hs-var">canDo</span></a></span><span>
</span><span id="line-58"></span><span>    </span><span class="annot"><span class="annottext">[Stm (Aliases rep)] -&gt; m [Stm (Aliases rep)]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">([Stm (Aliases rep)] -&gt; m [Stm (Aliases rep)])
-&gt; [Stm (Aliases rep)] -&gt; m [Stm (Aliases rep)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-59"></span><span>      </span><span class="annot"><span class="annottext">[Stm (Aliases rep)]
</span><a href="#local-6989586621684427259"><span class="hs-identifier hs-var">prestms</span></a></span><span>
</span><span id="line-60"></span><span>        </span><span class="annot"><span class="annottext">[Stm (Aliases rep)] -&gt; [Stm (Aliases rep)] -&gt; [Stm (Aliases rep)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Certs -&gt; Stm (Aliases rep) -&gt; Stm (Aliases rep)
forall rep. Certs -&gt; Stm rep -&gt; Stm rep
</span><a href="Futhark.IR.Prop.html#certify"><span class="hs-identifier hs-var">certify</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StmAux (VarAliases, ExpDec rep) -&gt; Certs
forall dec. StmAux dec -&gt; Certs
</span><a href="Futhark.IR.Syntax.html#stmAuxCerts"><span class="hs-identifier hs-var hs-var">stmAuxCerts</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (VarAliases, ExpDec rep)
StmAux (ExpDec (Aliases rep))
</span><a href="#local-6989586621684427267"><span class="hs-identifier hs-var">aux</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Stm (Aliases rep) -&gt; Stm (Aliases rep))
-&gt; Stm (Aliases rep) -&gt; Stm (Aliases rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-61"></span><span>               </span><span class="annot"><span class="annottext">[Ident] -&gt; ExpT (Aliases rep) -&gt; Stm (Aliases rep)
forall rep. Buildable rep =&gt; [Ident] -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.Builder.Class.html#mkLet"><span class="hs-identifier hs-var">mkLet</span></a></span><span> </span><span class="annot"><span class="annottext">[Ident]
</span><a href="#local-6989586621684427257"><span class="hs-identifier hs-var">pat'</span></a></span><span> </span><span class="annot"><span class="annottext">(ExpT (Aliases rep) -&gt; Stm (Aliases rep))
-&gt; ExpT (Aliases rep) -&gt; Stm (Aliases rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(FParam (Aliases rep), SubExp)]
-&gt; LoopForm (Aliases rep)
-&gt; BodyT (Aliases rep)
-&gt; ExpT (Aliases rep)
forall rep.
[(FParam rep, SubExp)] -&gt; LoopForm rep -&gt; BodyT rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#DoLoop"><span class="hs-identifier hs-var">DoLoop</span></a></span><span> </span><span class="annot"><span class="annottext">[(Param DeclType, SubExp)]
[(FParam (Aliases rep), SubExp)]
</span><a href="#local-6989586621684427256"><span class="hs-identifier hs-var">merge'</span></a></span><span> </span><span class="annot"><span class="annottext">LoopForm (Aliases rep)
</span><a href="#local-6989586621684427264"><span class="hs-identifier hs-var">form</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT (Aliases rep)
</span><a href="#local-6989586621684427255"><span class="hs-identifier hs-var">body'</span></a></span><span>
</span><span id="line-62"></span><span>           </span><span class="hs-special">]</span><span>
</span><span id="line-63"></span><span>        </span><span class="annot"><span class="annottext">[Stm (Aliases rep)] -&gt; [Stm (Aliases rep)] -&gt; [Stm (Aliases rep)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Stm (Aliases rep)]
</span><a href="#local-6989586621684427258"><span class="hs-identifier hs-var">poststms</span></a></span><span>
</span><span id="line-64"></span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#lowerUpdate"><span class="hs-identifier hs-var">lowerUpdate</span></a></span><span>
</span><span id="line-65"></span><span>  </span><span class="annot"><span class="annottext">Scope (Aliases rep)
</span><span class="hs-identifier">_</span></span><span>
</span><span id="line-66"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684427251"><span class="annot"><span class="annottext">Pat (Aliases rep)
</span><a href="#local-6989586621684427251"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684427250"><span class="annot"><span class="annottext">StmAux (ExpDec (Aliases rep))
</span><a href="#local-6989586621684427250"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684427246"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684427246"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-67"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#DesiredUpdate"><span class="hs-identifier hs-type">DesiredUpdate</span></a></span><span> </span><span id="local-6989586621684427245"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684427245"><span class="hs-identifier hs-var">bindee_nm</span></a></span></span><span> </span><span id="local-6989586621684427244"><span class="annot"><span class="annottext">LetDec (Aliases rep)
</span><a href="#local-6989586621684427244"><span class="hs-identifier hs-var">bindee_dec</span></a></span></span><span> </span><span id="local-6989586621684427243"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684427243"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span id="local-6989586621684427242"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684427242"><span class="hs-identifier hs-var">src</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-type">Slice</span></a></span><span> </span><span id="local-6989586621684427240"><span class="annot"><span class="annottext">[DimIndex SubExp]
</span><a href="#local-6989586621684427240"><span class="hs-identifier hs-var">is</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684427239"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684427239"><span class="hs-identifier hs-var">val</span></a></span></span><span class="hs-special">]</span><span>
</span><span id="line-68"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">PatT (VarAliases, Type) -&gt; [VName]
forall dec. PatT dec -&gt; [VName]
</span><a href="Futhark.IR.Prop.Patterns.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="annot"><span class="annottext">PatT (VarAliases, Type)
Pat (Aliases rep)
</span><a href="#local-6989586621684427251"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684427242"><span class="hs-identifier hs-var">src</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-69"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684427237"><span class="annot"><span class="annottext">is' :: Slice SubExp
</span><a href="#local-6989586621684427237"><span class="hs-identifier hs-var hs-var">is'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; [DimIndex SubExp] -&gt; Slice SubExp
</span><a href="Futhark.Construct.html#fullSlice"><span class="hs-identifier hs-var">fullSlice</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(VarAliases, Type) -&gt; Type
forall t. Typed t =&gt; t -&gt; Type
</span><a href="Futhark.IR.Prop.Types.html#typeOf"><span class="hs-identifier hs-var">typeOf</span></a></span><span> </span><span class="annot"><span class="annottext">(VarAliases, Type)
LetDec (Aliases rep)
</span><a href="#local-6989586621684427244"><span class="hs-identifier hs-var">bindee_dec</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DimIndex SubExp]
</span><a href="#local-6989586621684427240"><span class="hs-identifier hs-var">is</span></a></span><span>
</span><span id="line-70"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">m [Stm (Aliases rep)] -&gt; Maybe (m [Stm (Aliases rep)])
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(m [Stm (Aliases rep)] -&gt; Maybe (m [Stm (Aliases rep)]))
-&gt; ([Stm (Aliases rep)] -&gt; m [Stm (Aliases rep)])
-&gt; [Stm (Aliases rep)]
-&gt; Maybe (m [Stm (Aliases rep)])
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[Stm (Aliases rep)] -&gt; m [Stm (Aliases rep)]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">([Stm (Aliases rep)] -&gt; Maybe (m [Stm (Aliases rep)]))
-&gt; [Stm (Aliases rep)] -&gt; Maybe (m [Stm (Aliases rep)])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-71"></span><span>            </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Certs -&gt; Stm (Aliases rep) -&gt; Stm (Aliases rep)
forall rep. Certs -&gt; Stm rep -&gt; Stm rep
</span><a href="Futhark.IR.Prop.html#certify"><span class="hs-identifier hs-var">certify</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StmAux (VarAliases, ExpDec rep) -&gt; Certs
forall dec. StmAux dec -&gt; Certs
</span><a href="Futhark.IR.Syntax.html#stmAuxCerts"><span class="hs-identifier hs-var hs-var">stmAuxCerts</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (VarAliases, ExpDec rep)
StmAux (ExpDec (Aliases rep))
</span><a href="#local-6989586621684427250"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">Certs -&gt; Certs -&gt; Certs
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684427243"><span class="hs-identifier hs-var">cs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Stm (Aliases rep) -&gt; Stm (Aliases rep))
-&gt; Stm (Aliases rep) -&gt; Stm (Aliases rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-72"></span><span>                </span><span class="annot"><span class="annottext">[Ident] -&gt; ExpT (Aliases rep) -&gt; Stm (Aliases rep)
forall rep. Buildable rep =&gt; [Ident] -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.Builder.Class.html#mkLet"><span class="hs-identifier hs-var">mkLet</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">VName -&gt; Type -&gt; Ident
</span><a href="Futhark.IR.Syntax.Core.html#Ident"><span class="hs-identifier hs-var">Ident</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684427245"><span class="hs-identifier hs-var">bindee_nm</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Ident) -&gt; Type -&gt; Ident
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(VarAliases, Type) -&gt; Type
forall t. Typed t =&gt; t -&gt; Type
</span><a href="Futhark.IR.Prop.Types.html#typeOf"><span class="hs-identifier hs-var">typeOf</span></a></span><span> </span><span class="annot"><span class="annottext">(VarAliases, Type)
LetDec (Aliases rep)
</span><a href="#local-6989586621684427244"><span class="hs-identifier hs-var">bindee_dec</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(ExpT (Aliases rep) -&gt; Stm (Aliases rep))
-&gt; ExpT (Aliases rep) -&gt; Stm (Aliases rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-73"></span><span>                  </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT (Aliases rep)
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT (Aliases rep)) -&gt; BasicOp -&gt; ExpT (Aliases rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Safety -&gt; VName -&gt; Slice SubExp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Update"><span class="hs-identifier hs-var">Update</span></a></span><span> </span><span class="annot"><span class="annottext">Safety
</span><a href="Futhark.IR.Primitive.html#Unsafe"><span class="hs-identifier hs-var">Unsafe</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684427246"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684427237"><span class="hs-identifier hs-var">is'</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; BasicOp) -&gt; SubExp -&gt; BasicOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684427239"><span class="hs-identifier hs-var">val</span></a></span><span>
</span><span id="line-74"></span><span>            </span><span class="hs-special">]</span><span>
</span><span id="line-75"></span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#lowerUpdate"><span class="hs-identifier hs-var">lowerUpdate</span></a></span><span> </span><span class="annot"><span class="annottext">Scope (Aliases rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Stm (Aliases rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[DesiredUpdate (LetDec (Aliases rep))]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-76"></span><span>  </span><span class="annot"><span class="annottext">Maybe (m [Stm (Aliases rep)])
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-77"></span><span>
</span><span id="line-78"></span><span id="local-6989586621684427615"><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#lowerUpdateGPU"><span class="hs-identifier hs-type">lowerUpdateGPU</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.MonadFreshNames.html#MonadFreshNames"><span class="hs-identifier hs-type">MonadFreshNames</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684427615"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#LowerUpdate"><span class="hs-identifier hs-type">LowerUpdate</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684427615"><span class="hs-identifier hs-type">m</span></a></span></span><span>
</span><span id="line-79"></span><span id="lowerUpdateGPU"><span class="annot"><span class="annottext">lowerUpdateGPU :: forall (m :: * -&gt; *). MonadFreshNames m =&gt; LowerUpdate GPU m
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#lowerUpdateGPU"><span class="hs-identifier hs-var hs-var">lowerUpdateGPU</span></a></span></span><span>
</span><span id="line-80"></span><span>  </span><span id="local-6989586621684427192"><span class="annot"><span class="annottext">Scope (Aliases GPU)
</span><a href="#local-6989586621684427192"><span class="hs-identifier hs-var">scope</span></a></span></span><span>
</span><span id="line-81"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684427191"><span class="annot"><span class="annottext">Pat (Aliases GPU)
</span><a href="#local-6989586621684427191"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684427190"><span class="annot"><span class="annottext">StmAux (ExpDec (Aliases GPU))
</span><a href="#local-6989586621684427190"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SegOp"><span class="hs-identifier hs-type">SegOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#SegMap"><span class="hs-identifier hs-type">SegMap</span></a></span><span> </span><span id="local-6989586621684427186"><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684427186"><span class="hs-identifier hs-var">lvl</span></a></span></span><span> </span><span id="local-6989586621684427185"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684427185"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684427184"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684427184"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span id="local-6989586621684427183"><span class="annot"><span class="annottext">KernelBody (Aliases GPU)
</span><a href="#local-6989586621684427183"><span class="hs-identifier hs-var">kbody</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-82"></span><span>  </span><span id="local-6989586621684427182"><span class="annot"><span class="annottext">[DesiredUpdate (LetDec (Aliases GPU))]
</span><a href="#local-6989586621684427182"><span class="hs-identifier hs-var">updates</span></a></span></span><span>
</span><span id="line-83"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">(DesiredUpdate (VarAliases, Type) -&gt; Bool)
-&gt; [DesiredUpdate (VarAliases, Type)] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; [VName] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">PatT (VarAliases, Type) -&gt; [VName]
forall dec. PatT dec -&gt; [VName]
</span><a href="Futhark.IR.Prop.Patterns.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="annot"><span class="annottext">PatT (VarAliases, Type)
Pat (Aliases GPU)
</span><a href="#local-6989586621684427191"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Bool)
-&gt; (DesiredUpdate (VarAliases, Type) -&gt; VName)
-&gt; DesiredUpdate (VarAliases, Type)
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">DesiredUpdate (VarAliases, Type) -&gt; VName
forall dec. DesiredUpdate dec -&gt; VName
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#updateValue"><span class="hs-identifier hs-var hs-var">updateValue</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DesiredUpdate (VarAliases, Type)]
[DesiredUpdate (LetDec (Aliases GPU))]
</span><a href="#local-6989586621684427182"><span class="hs-identifier hs-var">updates</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-84"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684427178"><span class="hs-identifier hs-var">source_used_in_kbody</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-85"></span><span>      </span><span id="local-6989586621684427177"><span class="annot"><span class="annottext">m (PatT (VarAliases, Type), KernelBody (Aliases GPU),
   Stms (Aliases GPU))
</span><a href="#local-6989586621684427177"><span class="hs-identifier hs-var">mk</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Scope (Aliases GPU)
-&gt; Pat (Aliases GPU)
-&gt; [DesiredUpdate (LetDec (Aliases GPU))]
-&gt; SegSpace
-&gt; KernelBody (Aliases GPU)
-&gt; Maybe
     (m (Pat (Aliases GPU), KernelBody (Aliases GPU),
         Stms (Aliases GPU)))
forall (m :: * -&gt; *).
MonadFreshNames m =&gt;
Scope (Aliases GPU)
-&gt; Pat (Aliases GPU)
-&gt; [DesiredUpdate (LetDec (Aliases GPU))]
-&gt; SegSpace
-&gt; KernelBody (Aliases GPU)
-&gt; Maybe
     (m (Pat (Aliases GPU), KernelBody (Aliases GPU),
         Stms (Aliases GPU)))
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#lowerUpdatesIntoSegMap"><span class="hs-identifier hs-var">lowerUpdatesIntoSegMap</span></a></span><span> </span><span class="annot"><span class="annottext">Scope (Aliases GPU)
</span><a href="#local-6989586621684427192"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="annot"><span class="annottext">Pat (Aliases GPU)
</span><a href="#local-6989586621684427191"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">[DesiredUpdate (LetDec (Aliases GPU))]
</span><a href="#local-6989586621684427182"><span class="hs-identifier hs-var">updates</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684427185"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody (Aliases GPU)
</span><a href="#local-6989586621684427183"><span class="hs-identifier hs-var">kbody</span></a></span><span>
</span><span id="line-86"></span><span>      </span><span class="annot"><span class="annottext">m [Stm (Aliases GPU)] -&gt; Maybe (m [Stm (Aliases GPU)])
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(m [Stm (Aliases GPU)] -&gt; Maybe (m [Stm (Aliases GPU)]))
-&gt; m [Stm (Aliases GPU)] -&gt; Maybe (m [Stm (Aliases GPU)])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-87"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621684427175"><span class="annot"><span class="annottext">PatT (VarAliases, Type)
</span><a href="#local-6989586621684427175"><span class="hs-identifier hs-var">pat'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684427174"><span class="annot"><span class="annottext">KernelBody (Aliases GPU)
</span><a href="#local-6989586621684427174"><span class="hs-identifier hs-var">kbody'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684427173"><span class="annot"><span class="annottext">Stms (Aliases GPU)
</span><a href="#local-6989586621684427173"><span class="hs-identifier hs-var">poststms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (PatT (VarAliases, Type), KernelBody (Aliases GPU),
   Stms (Aliases GPU))
</span><a href="#local-6989586621684427177"><span class="hs-identifier hs-var">mk</span></a></span><span>
</span><span id="line-88"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684427172"><span class="annot"><span class="annottext">cs :: Certs
</span><a href="#local-6989586621684427172"><span class="hs-identifier hs-var hs-var">cs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StmAux (VarAliases, ()) -&gt; Certs
forall dec. StmAux dec -&gt; Certs
</span><a href="Futhark.IR.Syntax.html#stmAuxCerts"><span class="hs-identifier hs-var hs-var">stmAuxCerts</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (VarAliases, ())
StmAux (ExpDec (Aliases GPU))
</span><a href="#local-6989586621684427190"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">Certs -&gt; Certs -&gt; Certs
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">(DesiredUpdate (VarAliases, Type) -&gt; Certs)
-&gt; [DesiredUpdate (VarAliases, Type)] -&gt; Certs
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">DesiredUpdate (VarAliases, Type) -&gt; Certs
forall dec. DesiredUpdate dec -&gt; Certs
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#updateCerts"><span class="hs-identifier hs-var hs-var">updateCerts</span></a></span><span> </span><span class="annot"><span class="annottext">[DesiredUpdate (VarAliases, Type)]
[DesiredUpdate (LetDec (Aliases GPU))]
</span><a href="#local-6989586621684427182"><span class="hs-identifier hs-var">updates</span></a></span><span>
</span><span id="line-89"></span><span>        </span><span class="annot"><span class="annottext">[Stm (Aliases GPU)] -&gt; m [Stm (Aliases GPU)]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">([Stm (Aliases GPU)] -&gt; m [Stm (Aliases GPU)])
-&gt; [Stm (Aliases GPU)] -&gt; m [Stm (Aliases GPU)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-90"></span><span>          </span><span class="annot"><span class="annottext">Certs -&gt; Stm (Aliases GPU) -&gt; Stm (Aliases GPU)
forall rep. Certs -&gt; Stm rep -&gt; Stm rep
</span><a href="Futhark.IR.Prop.html#certify"><span class="hs-identifier hs-var">certify</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684427172"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pat (Aliases GPU)
-&gt; StmAux (ExpDec (Aliases GPU))
-&gt; ExpT (Aliases GPU)
-&gt; Stm (Aliases GPU)
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">PatT (VarAliases, Type)
Pat (Aliases GPU)
</span><a href="#local-6989586621684427175"><span class="hs-identifier hs-var">pat'</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec (Aliases GPU))
</span><a href="#local-6989586621684427190"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">(ExpT (Aliases GPU) -&gt; Stm (Aliases GPU))
-&gt; ExpT (Aliases GPU) -&gt; Stm (Aliases GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Op (Aliases GPU) -&gt; ExpT (Aliases GPU)
forall rep. Op rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-var">Op</span></a></span><span> </span><span class="annot"><span class="annottext">(Op (Aliases GPU) -&gt; ExpT (Aliases GPU))
-&gt; Op (Aliases GPU) -&gt; ExpT (Aliases GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegOp SegLevel (Aliases GPU)
-&gt; HostOp (Aliases GPU) (SOAC (Aliases GPU))
forall rep op. SegOp SegLevel rep -&gt; HostOp rep op
</span><a href="Futhark.IR.GPU.Op.html#SegOp"><span class="hs-identifier hs-var">SegOp</span></a></span><span> </span><span class="annot"><span class="annottext">(SegOp SegLevel (Aliases GPU)
 -&gt; HostOp (Aliases GPU) (SOAC (Aliases GPU)))
-&gt; SegOp SegLevel (Aliases GPU)
-&gt; HostOp (Aliases GPU) (SOAC (Aliases GPU))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegLevel
-&gt; SegSpace
-&gt; [Type]
-&gt; KernelBody (Aliases GPU)
-&gt; SegOp SegLevel (Aliases GPU)
forall lvl rep.
lvl -&gt; SegSpace -&gt; [Type] -&gt; KernelBody rep -&gt; SegOp lvl rep
</span><a href="Futhark.IR.SegOp.html#SegMap"><span class="hs-identifier hs-var">SegMap</span></a></span><span> </span><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684427186"><span class="hs-identifier hs-var">lvl</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684427185"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684427184"><span class="hs-identifier hs-var">ts</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody (Aliases GPU)
</span><a href="#local-6989586621684427174"><span class="hs-identifier hs-var">kbody'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stm (Aliases GPU) -&gt; [Stm (Aliases GPU)] -&gt; [Stm (Aliases GPU)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span>
</span><span id="line-91"></span><span>          </span><span class="annot"><span class="annottext">Stms (Aliases GPU) -&gt; [Stm (Aliases GPU)]
forall rep. Stms rep -&gt; [Stm rep]
</span><a href="Futhark.IR.Syntax.html#stmsToList"><span class="hs-identifier hs-var">stmsToList</span></a></span><span> </span><span class="annot"><span class="annottext">Stms (Aliases GPU)
</span><a href="#local-6989586621684427173"><span class="hs-identifier hs-var">poststms</span></a></span><span>
</span><span id="line-92"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-93"></span><span>      </span><span class="hs-comment">-- This check is a bit more conservative than ideal.  In a perfect</span><span>
</span><span id="line-94"></span><span>      </span><span class="hs-comment">-- world, we would allow indexing a[i,j] if the update is also</span><span>
</span><span id="line-95"></span><span>      </span><span class="hs-comment">-- to exactly a[i,j], as that will not create cross-iteration</span><span>
</span><span id="line-96"></span><span>      </span><span class="hs-comment">-- dependencies.  (Although the type checker wouldn't be able to</span><span>
</span><span id="line-97"></span><span>      </span><span class="hs-comment">-- permit this anyway.)</span><span>
</span><span id="line-98"></span><span>      </span><span id="local-6989586621684427178"><span class="annot"><span class="annottext">source_used_in_kbody :: Bool
</span><a href="#local-6989586621684427178"><span class="hs-identifier hs-var hs-var">source_used_in_kbody</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-99"></span><span>        </span><span class="annot"><span class="annottext">[Names] -&gt; Names
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(VName -&gt; Names) -&gt; [VName] -&gt; [Names]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Scope (Aliases GPU) -&gt; Names
forall rep. AliasesOf (LetDec rep) =&gt; VName -&gt; Scope rep -&gt; Names
</span><a href="Futhark.IR.Prop.Aliases.html#lookupAliases"><span class="hs-operator hs-var">`lookupAliases`</span></a></span><span> </span><span class="annot"><span class="annottext">Scope (Aliases GPU)
</span><a href="#local-6989586621684427192"><span class="hs-identifier hs-var">scope</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Names -&gt; [VName]
</span><a href="Futhark.IR.Prop.Names.html#namesToList"><span class="hs-identifier hs-var">namesToList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelBody (Aliases GPU) -&gt; Names
forall a. FreeIn a =&gt; a -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#freeIn"><span class="hs-identifier hs-var">freeIn</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody (Aliases GPU)
</span><a href="#local-6989586621684427183"><span class="hs-identifier hs-var">kbody</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-100"></span><span>          </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#namesIntersect"><span class="hs-operator hs-var">`namesIntersect`</span></a></span><span> </span><span class="annot"><span class="annottext">[Names] -&gt; Names
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(DesiredUpdate (VarAliases, Type) -&gt; Names)
-&gt; [DesiredUpdate (VarAliases, Type)] -&gt; [Names]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Scope (Aliases GPU) -&gt; Names
forall rep. AliasesOf (LetDec rep) =&gt; VName -&gt; Scope rep -&gt; Names
</span><a href="Futhark.IR.Prop.Aliases.html#lookupAliases"><span class="hs-operator hs-var">`lookupAliases`</span></a></span><span> </span><span class="annot"><span class="annottext">Scope (Aliases GPU)
</span><a href="#local-6989586621684427192"><span class="hs-identifier hs-var">scope</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Names)
-&gt; (DesiredUpdate (VarAliases, Type) -&gt; VName)
-&gt; DesiredUpdate (VarAliases, Type)
-&gt; Names
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">DesiredUpdate (VarAliases, Type) -&gt; VName
forall dec. DesiredUpdate dec -&gt; VName
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#updateSource"><span class="hs-identifier hs-var hs-var">updateSource</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DesiredUpdate (VarAliases, Type)]
[DesiredUpdate (LetDec (Aliases GPU))]
</span><a href="#local-6989586621684427182"><span class="hs-identifier hs-var">updates</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-101"></span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#lowerUpdateGPU"><span class="hs-identifier hs-var">lowerUpdateGPU</span></a></span><span> </span><span id="local-6989586621684427165"><span class="annot"><span class="annottext">Scope (Aliases GPU)
</span><a href="#local-6989586621684427165"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span id="local-6989586621684427164"><span class="annot"><span class="annottext">Stm (Aliases GPU)
</span><a href="#local-6989586621684427164"><span class="hs-identifier hs-var">stm</span></a></span></span><span> </span><span id="local-6989586621684427163"><span class="annot"><span class="annottext">[DesiredUpdate (LetDec (Aliases GPU))]
</span><a href="#local-6989586621684427163"><span class="hs-identifier hs-var">updates</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LowerUpdate GPU m
forall (m :: * -&gt; *) rep.
(MonadFreshNames m, Buildable rep, LetDec rep ~ Type,
 CanBeAliased (Op rep)) =&gt;
LowerUpdate rep m
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#lowerUpdate"><span class="hs-identifier hs-var">lowerUpdate</span></a></span><span> </span><span class="annot"><span class="annottext">Scope (Aliases GPU)
</span><a href="#local-6989586621684427165"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="annot"><span class="annottext">Stm (Aliases GPU)
</span><a href="#local-6989586621684427164"><span class="hs-identifier hs-var">stm</span></a></span><span> </span><span class="annot"><span class="annottext">[DesiredUpdate (LetDec (Aliases GPU))]
</span><a href="#local-6989586621684427163"><span class="hs-identifier hs-var">updates</span></a></span><span>
</span><span id="line-102"></span><span>
</span><span id="line-103"></span><span id="local-6989586621684427593"><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#lowerUpdatesIntoSegMap"><span class="hs-identifier hs-type">lowerUpdatesIntoSegMap</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-104"></span><span>  </span><span class="annot"><a href="Futhark.MonadFreshNames.html#MonadFreshNames"><span class="hs-identifier hs-type">MonadFreshNames</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684427593"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-105"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Aliases.html#Aliases"><span class="hs-identifier hs-type">Aliases</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-106"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Aliases.html#Aliases"><span class="hs-identifier hs-type">Aliases</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-107"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#DesiredUpdate"><span class="hs-identifier hs-type">DesiredUpdate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#LetDec"><span class="hs-identifier hs-type">LetDec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Aliases.html#Aliases"><span class="hs-identifier hs-type">Aliases</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-108"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegSpace"><span class="hs-identifier hs-type">SegSpace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-109"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-type">KernelBody</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Aliases.html#Aliases"><span class="hs-identifier hs-type">Aliases</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-110"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span>
</span><span id="line-111"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="#local-6989586621684427593"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-112"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Aliases.html#Aliases"><span class="hs-identifier hs-type">Aliases</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-113"></span><span>          </span><span class="annot"><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-type">KernelBody</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Aliases.html#Aliases"><span class="hs-identifier hs-type">Aliases</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-114"></span><span>          </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Aliases.html#Aliases"><span class="hs-identifier hs-type">Aliases</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-115"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-116"></span><span>    </span><span class="hs-special">)</span></span><span>
</span><span id="line-117"></span><span id="lowerUpdatesIntoSegMap"><span class="annot"><span class="annottext">lowerUpdatesIntoSegMap :: forall (m :: * -&gt; *).
MonadFreshNames m =&gt;
Scope (Aliases GPU)
-&gt; Pat (Aliases GPU)
-&gt; [DesiredUpdate (LetDec (Aliases GPU))]
-&gt; SegSpace
-&gt; KernelBody (Aliases GPU)
-&gt; Maybe
     (m (Pat (Aliases GPU), KernelBody (Aliases GPU),
         Stms (Aliases GPU)))
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#lowerUpdatesIntoSegMap"><span class="hs-identifier hs-var hs-var">lowerUpdatesIntoSegMap</span></a></span></span><span> </span><span id="local-6989586621684427089"><span class="annot"><span class="annottext">Scope (Aliases GPU)
</span><a href="#local-6989586621684427089"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span id="local-6989586621684427088"><span class="annot"><span class="annottext">Pat (Aliases GPU)
</span><a href="#local-6989586621684427088"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684427087"><span class="annot"><span class="annottext">[DesiredUpdate (LetDec (Aliases GPU))]
</span><a href="#local-6989586621684427087"><span class="hs-identifier hs-var">updates</span></a></span></span><span> </span><span id="local-6989586621684427086"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684427086"><span class="hs-identifier hs-var">kspace</span></a></span></span><span> </span><span id="local-6989586621684427085"><span class="annot"><span class="annottext">KernelBody (Aliases GPU)
</span><a href="#local-6989586621684427085"><span class="hs-identifier hs-var">kbody</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-118"></span><span>  </span><span class="hs-comment">-- The updates are all-or-nothing.  Being more liberal would require</span><span>
</span><span id="line-119"></span><span>  </span><span class="hs-comment">-- changes to the in-place-lowering pass itself.</span><span>
</span><span id="line-120"></span><span>  </span><span id="local-6989586621684427084"><span class="annot"><span class="annottext">[m (PatElemT (VarAliases, Type), Stms (Aliases GPU), KernelResult,
    Stms (Aliases GPU))]
</span><a href="#local-6989586621684427084"><span class="hs-identifier hs-var">mk</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(PatElemT (VarAliases, Type)
 -&gt; KernelResult
 -&gt; Maybe
      (m (PatElemT (VarAliases, Type), Stms (Aliases GPU), KernelResult,
          Stms (Aliases GPU))))
-&gt; [PatElemT (VarAliases, Type)]
-&gt; [KernelResult]
-&gt; Maybe
     [m (PatElemT (VarAliases, Type), Stms (Aliases GPU), KernelResult,
         Stms (Aliases GPU))]
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m [c]
</span><span class="hs-identifier hs-var">zipWithM</span></span><span> </span><span class="annot"><span class="annottext">PatElemT (VarAliases, Type)
-&gt; KernelResult
-&gt; Maybe
     (m (PatElemT (VarAliases, Type), Stms (Aliases GPU), KernelResult,
         Stms (Aliases GPU)))
</span><a href="#local-6989586621684427082"><span class="hs-identifier hs-var">onRet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatT (VarAliases, Type) -&gt; [PatElemT (VarAliases, Type)]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span> </span><span class="annot"><span class="annottext">PatT (VarAliases, Type)
Pat (Aliases GPU)
</span><a href="#local-6989586621684427088"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelBody (Aliases GPU) -&gt; [KernelResult]
forall rep. KernelBody rep -&gt; [KernelResult]
</span><a href="Futhark.IR.SegOp.html#kernelBodyResult"><span class="hs-identifier hs-var hs-var">kernelBodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody (Aliases GPU)
</span><a href="#local-6989586621684427085"><span class="hs-identifier hs-var">kbody</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-121"></span><span>  </span><span class="annot"><span class="annottext">m (PatT (VarAliases, Type), KernelBody (Aliases GPU),
   Stms (Aliases GPU))
-&gt; Maybe
     (m (PatT (VarAliases, Type), KernelBody (Aliases GPU),
         Stms (Aliases GPU)))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(m (PatT (VarAliases, Type), KernelBody (Aliases GPU),
    Stms (Aliases GPU))
 -&gt; Maybe
      (m (PatT (VarAliases, Type), KernelBody (Aliases GPU),
          Stms (Aliases GPU))))
-&gt; m (PatT (VarAliases, Type), KernelBody (Aliases GPU),
      Stms (Aliases GPU))
-&gt; Maybe
     (m (PatT (VarAliases, Type), KernelBody (Aliases GPU),
         Stms (Aliases GPU)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-122"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684427079"><span class="annot"><span class="annottext">[PatElemT (VarAliases, Type)]
</span><a href="#local-6989586621684427079"><span class="hs-identifier hs-var">pes</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684427078"><span class="annot"><span class="annottext">[Stms (Aliases GPU)]
</span><a href="#local-6989586621684427078"><span class="hs-identifier hs-var">bodystms</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684427077"><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684427077"><span class="hs-identifier hs-var">krets</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684427076"><span class="annot"><span class="annottext">[Stms (Aliases GPU)]
</span><a href="#local-6989586621684427076"><span class="hs-identifier hs-var">poststms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(PatElemT (VarAliases, Type), Stms (Aliases GPU), KernelResult,
  Stms (Aliases GPU))]
-&gt; ([PatElemT (VarAliases, Type)], [Stms (Aliases GPU)],
    [KernelResult], [Stms (Aliases GPU)])
forall a b c d. [(a, b, c, d)] -&gt; ([a], [b], [c], [d])
</span><span class="hs-identifier hs-var">unzip4</span></span><span> </span><span class="annot"><span class="annottext">([(PatElemT (VarAliases, Type), Stms (Aliases GPU), KernelResult,
   Stms (Aliases GPU))]
 -&gt; ([PatElemT (VarAliases, Type)], [Stms (Aliases GPU)],
     [KernelResult], [Stms (Aliases GPU)]))
-&gt; m [(PatElemT (VarAliases, Type), Stms (Aliases GPU),
       KernelResult, Stms (Aliases GPU))]
-&gt; m ([PatElemT (VarAliases, Type)], [Stms (Aliases GPU)],
      [KernelResult], [Stms (Aliases GPU)])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[m (PatElemT (VarAliases, Type), Stms (Aliases GPU), KernelResult,
    Stms (Aliases GPU))]
-&gt; m [(PatElemT (VarAliases, Type), Stms (Aliases GPU),
       KernelResult, Stms (Aliases GPU))]
forall (t :: * -&gt; *) (m :: * -&gt; *) a.
(Traversable t, Monad m) =&gt;
t (m a) -&gt; m (t a)
</span><span class="hs-identifier hs-var">sequence</span></span><span> </span><span class="annot"><span class="annottext">[m (PatElemT (VarAliases, Type), Stms (Aliases GPU), KernelResult,
    Stms (Aliases GPU))]
</span><a href="#local-6989586621684427084"><span class="hs-identifier hs-var">mk</span></a></span><span>
</span><span id="line-123"></span><span>    </span><span class="annot"><span class="annottext">(PatT (VarAliases, Type), KernelBody (Aliases GPU),
 Stms (Aliases GPU))
-&gt; m (PatT (VarAliases, Type), KernelBody (Aliases GPU),
      Stms (Aliases GPU))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-124"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">[PatElemT (VarAliases, Type)] -&gt; PatT (VarAliases, Type)
forall dec. [PatElemT dec] -&gt; PatT dec
</span><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-var">Pat</span></a></span><span> </span><span class="annot"><span class="annottext">[PatElemT (VarAliases, Type)]
</span><a href="#local-6989586621684427079"><span class="hs-identifier hs-var">pes</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-125"></span><span>        </span><span class="annot"><span class="annottext">KernelBody (Aliases GPU)
</span><a href="#local-6989586621684427085"><span class="hs-identifier hs-var">kbody</span></a></span><span>
</span><span id="line-126"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">kernelBodyStms :: Stms (Aliases GPU)
</span><a href="Futhark.IR.SegOp.html#kernelBodyStms"><span class="hs-identifier hs-var">kernelBodyStms</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">KernelBody (Aliases GPU) -&gt; Stms (Aliases GPU)
forall rep. KernelBody rep -&gt; Stms rep
</span><a href="Futhark.IR.SegOp.html#kernelBodyStms"><span class="hs-identifier hs-var hs-var">kernelBodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody (Aliases GPU)
</span><a href="#local-6989586621684427085"><span class="hs-identifier hs-var">kbody</span></a></span><span> </span><span class="annot"><span class="annottext">Stms (Aliases GPU) -&gt; Stms (Aliases GPU) -&gt; Stms (Aliases GPU)
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Stms (Aliases GPU)] -&gt; Stms (Aliases GPU)
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">[Stms (Aliases GPU)]
</span><a href="#local-6989586621684427078"><span class="hs-identifier hs-var">bodystms</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-127"></span><span>            </span><span class="annot"><span class="annottext">kernelBodyResult :: [KernelResult]
</span><a href="Futhark.IR.SegOp.html#kernelBodyResult"><span class="hs-identifier hs-var">kernelBodyResult</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684427077"><span class="hs-identifier hs-var">krets</span></a></span><span>
</span><span id="line-128"></span><span>          </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><span id="line-129"></span><span>        </span><span class="annot"><span class="annottext">[Stms (Aliases GPU)] -&gt; Stms (Aliases GPU)
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">[Stms (Aliases GPU)]
</span><a href="#local-6989586621684427076"><span class="hs-identifier hs-var">poststms</span></a></span><span>
</span><span id="line-130"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-131"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-132"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684427071"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684427071"><span class="hs-identifier hs-var">gtids</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684427070"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684427070"><span class="hs-identifier hs-var">_dims</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VName, SubExp)] -&gt; ([VName], [SubExp])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(VName, SubExp)] -&gt; ([VName], [SubExp]))
-&gt; [(VName, SubExp)] -&gt; ([VName], [SubExp])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; [(VName, SubExp)]
</span><a href="Futhark.IR.SegOp.html#unSegSpace"><span class="hs-identifier hs-var hs-var">unSegSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684427086"><span class="hs-identifier hs-var">kspace</span></a></span><span>
</span><span id="line-133"></span><span>
</span><span id="line-134"></span><span>    </span><span id="local-6989586621684427082"><span class="annot"><span class="annottext">onRet :: PatElemT (VarAliases, Type)
-&gt; KernelResult
-&gt; Maybe
     (m (PatElemT (VarAliases, Type), Stms (Aliases GPU), KernelResult,
         Stms (Aliases GPU)))
</span><a href="#local-6989586621684427082"><span class="hs-identifier hs-var hs-var">onRet</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#PatElem"><span class="hs-identifier hs-type">PatElem</span></a></span><span> </span><span id="local-6989586621684427066"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684427066"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621684427065"><span class="annot"><span class="annottext">(VarAliases, Type)
</span><a href="#local-6989586621684427065"><span class="hs-identifier hs-var">v_dec</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684427064"><span class="annot"><span class="annottext">KernelResult
</span><a href="#local-6989586621684427064"><span class="hs-identifier hs-var">ret</span></a></span></span><span>
</span><span id="line-135"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#DesiredUpdate"><span class="hs-identifier hs-type">DesiredUpdate</span></a></span><span> </span><span id="local-6989586621684427063"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684427063"><span class="hs-identifier hs-var">bindee_nm</span></a></span></span><span> </span><span id="local-6989586621684427062"><span class="annot"><span class="annottext">(VarAliases, Type)
</span><a href="#local-6989586621684427062"><span class="hs-identifier hs-var">bindee_dec</span></a></span></span><span> </span><span id="local-6989586621684427061"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684427061"><span class="hs-identifier hs-var">_cs</span></a></span></span><span> </span><span id="local-6989586621684427060"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684427060"><span class="hs-identifier hs-var">src</span></a></span></span><span> </span><span id="local-6989586621684427059"><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684427059"><span class="hs-identifier hs-var">slice</span></a></span></span><span> </span><span id="local-6989586621684427058"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684427058"><span class="hs-identifier hs-var">_val</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-136"></span><span>          </span><span class="annot"><span class="annottext">(DesiredUpdate (VarAliases, Type) -&gt; Bool)
-&gt; [DesiredUpdate (VarAliases, Type)]
-&gt; Maybe (DesiredUpdate (VarAliases, Type))
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Maybe a
</span><span class="hs-identifier hs-var">find</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; VName -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684427066"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Bool)
-&gt; (DesiredUpdate (VarAliases, Type) -&gt; VName)
-&gt; DesiredUpdate (VarAliases, Type)
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">DesiredUpdate (VarAliases, Type) -&gt; VName
forall dec. DesiredUpdate dec -&gt; VName
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#updateValue"><span class="hs-identifier hs-var hs-var">updateValue</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DesiredUpdate (VarAliases, Type)]
[DesiredUpdate (LetDec (Aliases GPU))]
</span><a href="#local-6989586621684427087"><span class="hs-identifier hs-var">updates</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-137"></span><span>        </span><span class="annot"><a href="Futhark.IR.SegOp.html#Returns"><span class="hs-identifier hs-type">Returns</span></a></span><span> </span><span class="annot"><span class="annottext">ResultManifest
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684427056"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684427056"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span id="local-6989586621684427055"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684427055"><span class="hs-identifier hs-var">se</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">KernelResult -&gt; Maybe KernelResult
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">KernelResult
</span><a href="#local-6989586621684427064"><span class="hs-identifier hs-var">ret</span></a></span><span>
</span><span id="line-138"></span><span>
</span><span id="line-139"></span><span>        </span><span class="hs-comment">-- The slice we're writing per thread must fully cover the</span><span>
</span><span id="line-140"></span><span>        </span><span class="hs-comment">-- underlying dimensions.</span><span>
</span><span id="line-141"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; Maybe ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Maybe ()) -&gt; Bool -&gt; Maybe ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-142"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684427054"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684427054"><span class="hs-identifier hs-var">dims'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684427053"><span class="annot"><span class="annottext">[DimIndex SubExp]
</span><a href="#local-6989586621684427053"><span class="hs-identifier hs-var">slice'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-143"></span><span>                </span><span class="annot"><span class="annottext">[(SubExp, DimIndex SubExp)] -&gt; ([SubExp], [DimIndex SubExp])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(SubExp, DimIndex SubExp)] -&gt; ([SubExp], [DimIndex SubExp]))
-&gt; ([(SubExp, DimIndex SubExp)] -&gt; [(SubExp, DimIndex SubExp)])
-&gt; [(SubExp, DimIndex SubExp)]
-&gt; ([SubExp], [DimIndex SubExp])
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [(SubExp, DimIndex SubExp)] -&gt; [(SubExp, DimIndex SubExp)]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684427071"><span class="hs-identifier hs-var">gtids</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(SubExp, DimIndex SubExp)] -&gt; [(SubExp, DimIndex SubExp)])
-&gt; ([(SubExp, DimIndex SubExp)] -&gt; [(SubExp, DimIndex SubExp)])
-&gt; [(SubExp, DimIndex SubExp)]
-&gt; [(SubExp, DimIndex SubExp)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">((SubExp, DimIndex SubExp) -&gt; Bool)
-&gt; [(SubExp, DimIndex SubExp)] -&gt; [(SubExp, DimIndex SubExp)]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe SubExp -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isNothing</span></span><span> </span><span class="annot"><span class="annottext">(Maybe SubExp -&gt; Bool)
-&gt; ((SubExp, DimIndex SubExp) -&gt; Maybe SubExp)
-&gt; (SubExp, DimIndex SubExp)
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">DimIndex SubExp -&gt; Maybe SubExp
forall d. DimIndex d -&gt; Maybe d
</span><a href="Futhark.IR.Syntax.Core.html#dimFix"><span class="hs-identifier hs-var">dimFix</span></a></span><span> </span><span class="annot"><span class="annottext">(DimIndex SubExp -&gt; Maybe SubExp)
-&gt; ((SubExp, DimIndex SubExp) -&gt; DimIndex SubExp)
-&gt; (SubExp, DimIndex SubExp)
-&gt; Maybe SubExp
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(SubExp, DimIndex SubExp) -&gt; DimIndex SubExp
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(SubExp, DimIndex SubExp)] -&gt; ([SubExp], [DimIndex SubExp]))
-&gt; [(SubExp, DimIndex SubExp)] -&gt; ([SubExp], [DimIndex SubExp])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-144"></span><span>                  </span><span class="annot"><span class="annottext">[SubExp] -&gt; [DimIndex SubExp] -&gt; [(SubExp, DimIndex SubExp)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; [SubExp]
forall u. TypeBase Shape u -&gt; [SubExp]
</span><a href="Futhark.IR.Prop.Types.html#arrayDims"><span class="hs-identifier hs-var">arrayDims</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(VarAliases, Type) -&gt; Type
forall t. Typed t =&gt; t -&gt; Type
</span><a href="Futhark.IR.Prop.Types.html#typeOf"><span class="hs-identifier hs-var">typeOf</span></a></span><span> </span><span class="annot"><span class="annottext">(VarAliases, Type)
</span><a href="#local-6989586621684427062"><span class="hs-identifier hs-var">bindee_dec</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Slice SubExp -&gt; [DimIndex SubExp]
forall d. Slice d -&gt; [DimIndex d]
</span><a href="Futhark.IR.Syntax.Core.html#unSlice"><span class="hs-identifier hs-var hs-var">unSlice</span></a></span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684427059"><span class="hs-identifier hs-var">slice</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-145"></span><span>           </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Shape -&gt; Slice SubExp -&gt; Bool
</span><a href="Futhark.Construct.html#isFullSlice"><span class="hs-identifier hs-var">isFullSlice</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Shape
forall d. [d] -&gt; ShapeBase d
</span><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-var">Shape</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684427054"><span class="hs-identifier hs-var">dims'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DimIndex SubExp] -&gt; Slice SubExp
forall d. [DimIndex d] -&gt; Slice d
</span><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-var">Slice</span></a></span><span> </span><span class="annot"><span class="annottext">[DimIndex SubExp]
</span><a href="#local-6989586621684427053"><span class="hs-identifier hs-var">slice'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-146"></span><span>
</span><span id="line-147"></span><span>        </span><span class="annot"><span class="annottext">m (PatElemT (VarAliases, Type), Stms (Aliases GPU), KernelResult,
   Stms (Aliases GPU))
-&gt; Maybe
     (m (PatElemT (VarAliases, Type), Stms (Aliases GPU), KernelResult,
         Stms (Aliases GPU)))
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(m (PatElemT (VarAliases, Type), Stms (Aliases GPU), KernelResult,
    Stms (Aliases GPU))
 -&gt; Maybe
      (m (PatElemT (VarAliases, Type), Stms (Aliases GPU), KernelResult,
          Stms (Aliases GPU))))
-&gt; m (PatElemT (VarAliases, Type), Stms (Aliases GPU),
      KernelResult, Stms (Aliases GPU))
-&gt; Maybe
     (m (PatElemT (VarAliases, Type), Stms (Aliases GPU), KernelResult,
         Stms (Aliases GPU)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-148"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621684427045"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684427045"><span class="hs-identifier hs-var">slice'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684427044"><span class="annot"><span class="annottext">Stms (Aliases GPU)
</span><a href="#local-6989586621684427044"><span class="hs-identifier hs-var">bodystms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-149"></span><span>            </span><span class="annot"><span class="annottext">(BuilderT (Aliases GPU) m [SubExp]
 -&gt; Scope (Aliases GPU) -&gt; m ([SubExp], Stms (Aliases GPU)))
-&gt; Scope (Aliases GPU)
-&gt; BuilderT (Aliases GPU) m [SubExp]
-&gt; m ([SubExp], Stms (Aliases GPU))
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">BuilderT (Aliases GPU) m [SubExp]
-&gt; Scope (Aliases GPU) -&gt; m ([SubExp], Stms (Aliases GPU))
forall (m :: * -&gt; *) rep a.
MonadFreshNames m =&gt;
BuilderT rep m a -&gt; Scope rep -&gt; m (a, Stms rep)
</span><a href="Futhark.Builder.html#runBuilderT"><span class="hs-identifier hs-var">runBuilderT</span></a></span><span> </span><span class="annot"><span class="annottext">Scope (Aliases GPU)
</span><a href="#local-6989586621684427089"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="annot"><span class="annottext">(BuilderT (Aliases GPU) m [SubExp]
 -&gt; m ([SubExp], Stms (Aliases GPU)))
-&gt; BuilderT (Aliases GPU) m [SubExp]
-&gt; m ([SubExp], Stms (Aliases GPU))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-150"></span><span>              </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName -&gt; BuilderT (Aliases GPU) m SubExp)
-&gt; [TPrimExp Int64 VName] -&gt; BuilderT (Aliases GPU) m [SubExp]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; TPrimExp Int64 VName -&gt; BuilderT (Aliases GPU) m SubExp
forall (m :: * -&gt; *) a.
(MonadBuilder m, ToExp a) =&gt;
String -&gt; a -&gt; m SubExp
</span><a href="Futhark.Construct.html#toSubExp"><span class="hs-identifier hs-var">toSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;index&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([TPrimExp Int64 VName] -&gt; BuilderT (Aliases GPU) m [SubExp])
-&gt; [TPrimExp Int64 VName] -&gt; BuilderT (Aliases GPU) m [SubExp]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-151"></span><span>                </span><span class="annot"><span class="annottext">Slice (TPrimExp Int64 VName)
-&gt; [TPrimExp Int64 VName] -&gt; [TPrimExp Int64 VName]
forall d. Num d =&gt; Slice d -&gt; [d] -&gt; [d]
</span><a href="Futhark.IR.Syntax.Core.html#fixSlice"><span class="hs-identifier hs-var">fixSlice</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SubExp -&gt; TPrimExp Int64 VName)
-&gt; Slice SubExp -&gt; Slice (TPrimExp Int64 VName)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TPrimExp Int64 VName
</span><a href="Futhark.Analysis.PrimExp.Convert.html#pe64"><span class="hs-identifier hs-var">pe64</span></a></span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684427059"><span class="hs-identifier hs-var">slice</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([TPrimExp Int64 VName] -&gt; [TPrimExp Int64 VName])
-&gt; [TPrimExp Int64 VName] -&gt; [TPrimExp Int64 VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; TPrimExp Int64 VName)
-&gt; [VName] -&gt; [TPrimExp Int64 VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp -&gt; TPrimExp Int64 VName
</span><a href="Futhark.Analysis.PrimExp.Convert.html#pe64"><span class="hs-identifier hs-var">pe64</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TPrimExp Int64 VName)
-&gt; (VName -&gt; SubExp) -&gt; VName -&gt; TPrimExp Int64 VName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684427071"><span class="hs-identifier hs-var">gtids</span></a></span><span>
</span><span id="line-152"></span><span>
</span><span id="line-153"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684427037"><span class="annot"><span class="annottext">res_dims :: [SubExp]
</span><a href="#local-6989586621684427037"><span class="hs-identifier hs-var hs-var">res_dims</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [SubExp] -&gt; [SubExp]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">take</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684427045"><span class="hs-identifier hs-var">slice'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [SubExp]) -&gt; [SubExp] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; [SubExp]
forall u. TypeBase Shape u -&gt; [SubExp]
</span><a href="Futhark.IR.Prop.Types.html#arrayDims"><span class="hs-identifier hs-var">arrayDims</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; [SubExp]) -&gt; Type -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(VarAliases, Type) -&gt; Type
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">(VarAliases, Type)
</span><a href="#local-6989586621684427062"><span class="hs-identifier hs-var">bindee_dec</span></a></span><span>
</span><span id="line-154"></span><span>              </span><span id="local-6989586621684427035"><span class="annot"><span class="annottext">ret' :: KernelResult
</span><a href="#local-6989586621684427035"><span class="hs-identifier hs-var hs-var">ret'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Certs -&gt; Shape -&gt; VName -&gt; [(Slice SubExp, SubExp)] -&gt; KernelResult
</span><a href="Futhark.IR.SegOp.html#WriteReturns"><span class="hs-identifier hs-var">WriteReturns</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684427056"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Shape
forall d. [d] -&gt; ShapeBase d
</span><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-var">Shape</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684427037"><span class="hs-identifier hs-var">res_dims</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684427060"><span class="hs-identifier hs-var">src</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DimIndex SubExp] -&gt; Slice SubExp
forall d. [DimIndex d] -&gt; Slice d
</span><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-var">Slice</span></a></span><span> </span><span class="annot"><span class="annottext">([DimIndex SubExp] -&gt; Slice SubExp)
-&gt; [DimIndex SubExp] -&gt; Slice SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; DimIndex SubExp) -&gt; [SubExp] -&gt; [DimIndex SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; DimIndex SubExp
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684427045"><span class="hs-identifier hs-var">slice'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684427055"><span class="hs-identifier hs-var">se</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-155"></span><span>
</span><span id="line-156"></span><span>          </span><span id="local-6989586621684427032"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684427032"><span class="hs-identifier hs-var">v_aliased</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; m VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; VName -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newName"><span class="hs-identifier hs-var">newName</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684427066"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-157"></span><span>
</span><span id="line-158"></span><span>          </span><span class="annot"><span class="annottext">(PatElemT (VarAliases, Type), Stms (Aliases GPU), KernelResult,
 Stms (Aliases GPU))
-&gt; m (PatElemT (VarAliases, Type), Stms (Aliases GPU),
      KernelResult, Stms (Aliases GPU))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-159"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">VName -&gt; (VarAliases, Type) -&gt; PatElemT (VarAliases, Type)
forall dec. VName -&gt; dec -&gt; PatElemT dec
</span><a href="Futhark.IR.Syntax.Core.html#PatElem"><span class="hs-identifier hs-var">PatElem</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684427063"><span class="hs-identifier hs-var">bindee_nm</span></a></span><span> </span><span class="annot"><span class="annottext">(VarAliases, Type)
</span><a href="#local-6989586621684427062"><span class="hs-identifier hs-var">bindee_dec</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-160"></span><span>              </span><span class="annot"><span class="annottext">Stms (Aliases GPU)
</span><a href="#local-6989586621684427044"><span class="hs-identifier hs-var">bodystms</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-161"></span><span>              </span><span class="annot"><span class="annottext">KernelResult
</span><a href="#local-6989586621684427035"><span class="hs-identifier hs-var">ret'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-162"></span><span>              </span><span class="annot"><span class="annottext">[Stm (Aliases GPU)] -&gt; Stms (Aliases GPU)
forall rep. [Stm rep] -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#stmsFromList"><span class="hs-identifier hs-var">stmsFromList</span></a></span><span>
</span><span id="line-163"></span><span>                </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">[Ident] -&gt; ExpT (Aliases GPU) -&gt; Stm (Aliases GPU)
forall rep. Buildable rep =&gt; [Ident] -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.Builder.Class.html#mkLet"><span class="hs-identifier hs-var">mkLet</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">VName -&gt; Type -&gt; Ident
</span><a href="Futhark.IR.Syntax.Core.html#Ident"><span class="hs-identifier hs-var">Ident</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684427032"><span class="hs-identifier hs-var">v_aliased</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Ident) -&gt; Type -&gt; Ident
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(VarAliases, Type) -&gt; Type
forall t. Typed t =&gt; t -&gt; Type
</span><a href="Futhark.IR.Prop.Types.html#typeOf"><span class="hs-identifier hs-var">typeOf</span></a></span><span> </span><span class="annot"><span class="annottext">(VarAliases, Type)
</span><a href="#local-6989586621684427065"><span class="hs-identifier hs-var">v_dec</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(ExpT (Aliases GPU) -&gt; Stm (Aliases GPU))
-&gt; ExpT (Aliases GPU) -&gt; Stm (Aliases GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT (Aliases GPU)
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT (Aliases GPU)) -&gt; BasicOp -&gt; ExpT (Aliases GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Slice SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Index"><span class="hs-identifier hs-var">Index</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684427063"><span class="hs-identifier hs-var">bindee_nm</span></a></span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684427059"><span class="hs-identifier hs-var">slice</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-164"></span><span>                  </span><span class="annot"><span class="annottext">[Ident] -&gt; ExpT (Aliases GPU) -&gt; Stm (Aliases GPU)
forall rep. Buildable rep =&gt; [Ident] -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.Builder.Class.html#mkLet"><span class="hs-identifier hs-var">mkLet</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">VName -&gt; Type -&gt; Ident
</span><a href="Futhark.IR.Syntax.Core.html#Ident"><span class="hs-identifier hs-var">Ident</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684427066"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Ident) -&gt; Type -&gt; Ident
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(VarAliases, Type) -&gt; Type
forall t. Typed t =&gt; t -&gt; Type
</span><a href="Futhark.IR.Prop.Types.html#typeOf"><span class="hs-identifier hs-var">typeOf</span></a></span><span> </span><span class="annot"><span class="annottext">(VarAliases, Type)
</span><a href="#local-6989586621684427065"><span class="hs-identifier hs-var">v_dec</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(ExpT (Aliases GPU) -&gt; Stm (Aliases GPU))
-&gt; ExpT (Aliases GPU) -&gt; Stm (Aliases GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT (Aliases GPU)
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT (Aliases GPU)) -&gt; BasicOp -&gt; ExpT (Aliases GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Copy"><span class="hs-identifier hs-var">Copy</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684427032"><span class="hs-identifier hs-var">v_aliased</span></a></span><span>
</span><span id="line-165"></span><span>                </span><span class="hs-special">]</span><span>
</span><span id="line-166"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-167"></span><span>    </span><span class="annot"><a href="#local-6989586621684427082"><span class="hs-identifier hs-var">onRet</span></a></span><span> </span><span id="local-6989586621684427027"><span class="annot"><span class="annottext">PatElemT (VarAliases, Type)
</span><a href="#local-6989586621684427027"><span class="hs-identifier hs-var">pe</span></a></span></span><span> </span><span id="local-6989586621684427026"><span class="annot"><span class="annottext">KernelResult
</span><a href="#local-6989586621684427026"><span class="hs-identifier hs-var">ret</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-168"></span><span>      </span><span class="annot"><span class="annottext">m (PatElemT (VarAliases, Type), Stms (Aliases GPU), KernelResult,
   Stms (Aliases GPU))
-&gt; Maybe
     (m (PatElemT (VarAliases, Type), Stms (Aliases GPU), KernelResult,
         Stms (Aliases GPU)))
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(m (PatElemT (VarAliases, Type), Stms (Aliases GPU), KernelResult,
    Stms (Aliases GPU))
 -&gt; Maybe
      (m (PatElemT (VarAliases, Type), Stms (Aliases GPU), KernelResult,
          Stms (Aliases GPU))))
-&gt; m (PatElemT (VarAliases, Type), Stms (Aliases GPU),
      KernelResult, Stms (Aliases GPU))
-&gt; Maybe
     (m (PatElemT (VarAliases, Type), Stms (Aliases GPU), KernelResult,
         Stms (Aliases GPU)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(PatElemT (VarAliases, Type), Stms (Aliases GPU), KernelResult,
 Stms (Aliases GPU))
-&gt; m (PatElemT (VarAliases, Type), Stms (Aliases GPU),
      KernelResult, Stms (Aliases GPU))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT (VarAliases, Type)
</span><a href="#local-6989586621684427027"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stms (Aliases GPU)
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">KernelResult
</span><a href="#local-6989586621684427026"><span class="hs-identifier hs-var">ret</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stms (Aliases GPU)
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span>
</span><span id="line-169"></span><span>
</span><span id="line-170"></span><span id="local-6989586621684427635"><span id="local-6989586621684427636"><span id="local-6989586621684427637"><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#lowerUpdateIntoLoop"><span class="hs-identifier hs-type">lowerUpdateIntoLoop</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-171"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.Builder.Class.html#Buildable"><span class="hs-identifier hs-type">Buildable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684427637"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-172"></span><span>    </span><span class="annot"><a href="Futhark.Builder.html#BuilderOps"><span class="hs-identifier hs-type">BuilderOps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684427637"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-173"></span><span>    </span><span class="annot"><a href="Futhark.IR.Prop.Aliases.html#Aliased"><span class="hs-identifier hs-type">Aliased</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684427637"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-174"></span><span>    </span><span class="annot"><a href="Futhark.IR.Rep.html#LetDec"><span class="hs-identifier hs-type">LetDec</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684427637"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">~</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621684427636"><span class="hs-identifier hs-type">als</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-175"></span><span>    </span><span class="annot"><a href="Futhark.MonadFreshNames.html#MonadFreshNames"><span class="hs-identifier hs-type">MonadFreshNames</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684427635"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-176"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-177"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684427637"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-178"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#DesiredUpdate"><span class="hs-identifier hs-type">DesiredUpdate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#LetDec"><span class="hs-identifier hs-type">LetDec</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684427637"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-179"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684427637"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-180"></span><span>  </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#FParam"><span class="hs-identifier hs-type">FParam</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684427637"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-181"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#LoopForm"><span class="hs-identifier hs-type">LoopForm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684427637"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-182"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684427637"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-183"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span>
</span><span id="line-184"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="#local-6989586621684427635"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-185"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684427637"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><span id="line-186"></span><span>          </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684427637"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><span id="line-187"></span><span>          </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Ident"><span class="hs-identifier hs-type">Ident</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><span id="line-188"></span><span>          </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#FParam"><span class="hs-identifier hs-type">FParam</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684427637"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><span id="line-189"></span><span>          </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684427637"><span class="hs-identifier hs-type">rep</span></a></span><span>
</span><span id="line-190"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-191"></span><span>    </span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-192"></span><span id="lowerUpdateIntoLoop"><span class="annot"><span class="annottext">lowerUpdateIntoLoop :: forall rep als (m :: * -&gt; *).
(Buildable rep, BuilderOps rep, Aliased rep,
 LetDec rep ~ (als, Type), MonadFreshNames m) =&gt;
Scope rep
-&gt; [DesiredUpdate (LetDec rep)]
-&gt; Pat rep
-&gt; [(FParam rep, SubExp)]
-&gt; LoopForm rep
-&gt; Body rep
-&gt; Maybe
     (m ([Stm rep], [Stm rep], [Ident], [(FParam rep, SubExp)],
         Body rep))
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#lowerUpdateIntoLoop"><span class="hs-identifier hs-var hs-var">lowerUpdateIntoLoop</span></a></span></span><span> </span><span id="local-6989586621684426915"><span class="annot"><span class="annottext">Scope rep
</span><a href="#local-6989586621684426915"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span id="local-6989586621684426914"><span class="annot"><span class="annottext">[DesiredUpdate (LetDec rep)]
</span><a href="#local-6989586621684426914"><span class="hs-identifier hs-var">updates</span></a></span></span><span> </span><span id="local-6989586621684426913"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684426913"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684426912"><span class="annot"><span class="annottext">[(FParam rep, SubExp)]
</span><a href="#local-6989586621684426912"><span class="hs-identifier hs-var">val</span></a></span></span><span> </span><span id="local-6989586621684426911"><span class="annot"><span class="annottext">LoopForm rep
</span><a href="#local-6989586621684426911"><span class="hs-identifier hs-var">form</span></a></span></span><span> </span><span id="local-6989586621684426910"><span class="annot"><span class="annottext">Body rep
</span><a href="#local-6989586621684426910"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-193"></span><span>  </span><span class="hs-comment">-- Algorithm:</span><span>
</span><span id="line-194"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-195"></span><span>  </span><span class="hs-comment">--   0) Map each result of the loop body to a corresponding in-place</span><span>
</span><span id="line-196"></span><span>  </span><span class="hs-comment">--      update, if one exists.</span><span>
</span><span id="line-197"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-198"></span><span>  </span><span class="hs-comment">--   1) Create new merge variables corresponding to the arrays being</span><span>
</span><span id="line-199"></span><span>  </span><span class="hs-comment">--      updated; extend the pattern and the @res@ list with these,</span><span>
</span><span id="line-200"></span><span>  </span><span class="hs-comment">--      and remove the parts of the result list that have a</span><span>
</span><span id="line-201"></span><span>  </span><span class="hs-comment">--      corresponding in-place update.</span><span>
</span><span id="line-202"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-203"></span><span>  </span><span class="hs-comment">--      (The creation of the new merge variable identifiers is</span><span>
</span><span id="line-204"></span><span>  </span><span class="hs-comment">--      actually done at the same time as step (0)).</span><span>
</span><span id="line-205"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-206"></span><span>  </span><span class="hs-comment">--   2) Create in-place updates at the end of the loop body.</span><span>
</span><span id="line-207"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-208"></span><span>  </span><span class="hs-comment">--   3) Create index expressions that read back the values written</span><span>
</span><span id="line-209"></span><span>  </span><span class="hs-comment">--      in (2).  If the merge parameter corresponding to this value</span><span>
</span><span id="line-210"></span><span>  </span><span class="hs-comment">--      is unique, also @copy@ this value.</span><span>
</span><span id="line-211"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-212"></span><span>  </span><span class="hs-comment">--   4) Update the result of the loop body to properly pass the new</span><span>
</span><span id="line-213"></span><span>  </span><span class="hs-comment">--      arrays and indexed elements to the next iteration of the</span><span>
</span><span id="line-214"></span><span>  </span><span class="hs-comment">--      loop.</span><span>
</span><span id="line-215"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-216"></span><span>  </span><span class="hs-comment">-- We also check that the merge parameters we work with have</span><span>
</span><span id="line-217"></span><span>  </span><span class="hs-comment">-- loop-invariant shapes.</span><span>
</span><span id="line-218"></span><span>
</span><span id="line-219"></span><span>  </span><span class="hs-comment">-- Safety condition (8).</span><span>
</span><span id="line-220"></span><span>  </span><span class="annot"><span class="annottext">[((Param DeclType, SubExp), Names)]
-&gt; (((Param DeclType, SubExp), Names) -&gt; Maybe ()) -&gt; Maybe ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(Param DeclType, SubExp)]
-&gt; [Names] -&gt; [((Param DeclType, SubExp), Names)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[(Param DeclType, SubExp)]
[(FParam rep, SubExp)]
</span><a href="#local-6989586621684426912"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="annot"><span class="annottext">([Names] -&gt; [((Param DeclType, SubExp), Names)])
-&gt; [Names] -&gt; [((Param DeclType, SubExp), Names)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Body rep -&gt; [Names]
forall rep. Aliased rep =&gt; Body rep -&gt; [Names]
</span><a href="Futhark.IR.Prop.Aliases.html#bodyAliases"><span class="hs-identifier hs-var">bodyAliases</span></a></span><span> </span><span class="annot"><span class="annottext">Body rep
</span><a href="#local-6989586621684426910"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((((Param DeclType, SubExp), Names) -&gt; Maybe ()) -&gt; Maybe ())
-&gt; (((Param DeclType, SubExp), Names) -&gt; Maybe ()) -&gt; Maybe ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621684426907"><span class="annot"><span class="annottext">Param DeclType
</span><a href="#local-6989586621684426907"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621684426906"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684426906"><span class="hs-identifier hs-var">als</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-221"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; Maybe ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Maybe ()) -&gt; Bool -&gt; Maybe ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param DeclType -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param DeclType
</span><a href="#local-6989586621684426907"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#nameIn"><span class="hs-operator hs-var">`nameIn`</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684426906"><span class="hs-identifier hs-var">als</span></a></span><span>
</span><span id="line-222"></span><span>
</span><span id="line-223"></span><span>  </span><span id="local-6989586621684426903"><span class="annot"><span class="annottext">m [LoopResultSummary (als, Type)]
</span><a href="#local-6989586621684426903"><span class="hs-identifier hs-var">mk_in_place_map</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Scope rep
-&gt; [DesiredUpdate (als, Type)]
-&gt; Names
-&gt; [(SubExpRes, Ident)]
-&gt; [(Param DeclType, SubExp)]
-&gt; Maybe (m [LoopResultSummary (als, Type)])
forall rep (m :: * -&gt; *) als.
(Aliased rep, MonadFreshNames m) =&gt;
Scope rep
-&gt; [DesiredUpdate (als, Type)]
-&gt; Names
-&gt; [(SubExpRes, Ident)]
-&gt; [(Param DeclType, SubExp)]
-&gt; Maybe (m [LoopResultSummary (als, Type)])
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#summariseLoop"><span class="hs-identifier hs-var">summariseLoop</span></a></span><span> </span><span class="annot"><span class="annottext">Scope rep
</span><a href="#local-6989586621684426915"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="annot"><span class="annottext">[DesiredUpdate (als, Type)]
[DesiredUpdate (LetDec rep)]
</span><a href="#local-6989586621684426914"><span class="hs-identifier hs-var">updates</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684426901"><span class="hs-identifier hs-var">usedInBody</span></a></span><span> </span><span class="annot"><span class="annottext">[(SubExpRes, Ident)]
</span><a href="#local-6989586621684426900"><span class="hs-identifier hs-var">resmap</span></a></span><span> </span><span class="annot"><span class="annottext">[(Param DeclType, SubExp)]
[(FParam rep, SubExp)]
</span><a href="#local-6989586621684426912"><span class="hs-identifier hs-var">val</span></a></span><span>
</span><span id="line-224"></span><span>
</span><span id="line-225"></span><span>  </span><span class="annot"><span class="annottext">m ([Stm rep], [Stm rep], [Ident], [(Param DeclType, SubExp)],
   Body rep)
-&gt; Maybe
     (m ([Stm rep], [Stm rep], [Ident], [(Param DeclType, SubExp)],
         Body rep))
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(m ([Stm rep], [Stm rep], [Ident], [(Param DeclType, SubExp)],
    Body rep)
 -&gt; Maybe
      (m ([Stm rep], [Stm rep], [Ident], [(Param DeclType, SubExp)],
          Body rep)))
-&gt; m ([Stm rep], [Stm rep], [Ident], [(Param DeclType, SubExp)],
      Body rep)
-&gt; Maybe
     (m ([Stm rep], [Stm rep], [Ident], [(Param DeclType, SubExp)],
         Body rep))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-226"></span><span>    </span><span id="local-6989586621684426899"><span class="annot"><span class="annottext">[LoopResultSummary (als, Type)]
</span><a href="#local-6989586621684426899"><span class="hs-identifier hs-var">in_place_map</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m [LoopResultSummary (als, Type)]
</span><a href="#local-6989586621684426903"><span class="hs-identifier hs-var">mk_in_place_map</span></a></span><span>
</span><span id="line-227"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684426898"><span class="annot"><span class="annottext">[(Param DeclType, SubExp)]
</span><a href="#local-6989586621684426898"><span class="hs-identifier hs-var">val'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684426897"><span class="annot"><span class="annottext">[Stm rep]
</span><a href="#local-6989586621684426897"><span class="hs-identifier hs-var">prestms</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684426896"><span class="annot"><span class="annottext">[Stm rep]
</span><a href="#local-6989586621684426896"><span class="hs-identifier hs-var">poststms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[LoopResultSummary (als, Type)]
-&gt; m ([(Param DeclType, SubExp)], [Stm rep], [Stm rep])
forall (m :: * -&gt; *) rep als.
(MonadFreshNames m, Buildable rep) =&gt;
[LoopResultSummary (als, Type)]
-&gt; m ([(Param DeclType, SubExp)], [Stm rep], [Stm rep])
</span><a href="#local-6989586621684426895"><span class="hs-identifier hs-var">mkMerges</span></a></span><span> </span><span class="annot"><span class="annottext">[LoopResultSummary (als, Type)]
</span><a href="#local-6989586621684426899"><span class="hs-identifier hs-var">in_place_map</span></a></span><span>
</span><span id="line-228"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684426894"><span class="annot"><span class="annottext">valpat :: [Ident]
</span><a href="#local-6989586621684426894"><span class="hs-identifier hs-var hs-var">valpat</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[LoopResultSummary (als, Type)] -&gt; [Ident]
forall {a}. [LoopResultSummary (a, Type)] -&gt; [Ident]
</span><a href="#local-6989586621684426893"><span class="hs-identifier hs-var">mkResAndPat</span></a></span><span> </span><span class="annot"><span class="annottext">[LoopResultSummary (als, Type)]
</span><a href="#local-6989586621684426899"><span class="hs-identifier hs-var">in_place_map</span></a></span><span>
</span><span id="line-229"></span><span>        </span><span id="local-6989586621684426892"><span class="annot"><span class="annottext">idxsubsts :: IndexSubstitutions
</span><a href="#local-6989586621684426892"><span class="hs-identifier hs-var hs-var">idxsubsts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[LoopResultSummary (als, Type)] -&gt; IndexSubstitutions
forall dec.
Typed dec =&gt;
[LoopResultSummary dec] -&gt; IndexSubstitutions
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#indexSubstitutions"><span class="hs-identifier hs-var">indexSubstitutions</span></a></span><span> </span><span class="annot"><span class="annottext">[LoopResultSummary (als, Type)]
</span><a href="#local-6989586621684426899"><span class="hs-identifier hs-var">in_place_map</span></a></span><span>
</span><span id="line-230"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684426890"><span class="annot"><span class="annottext">IndexSubstitutions
</span><a href="#local-6989586621684426890"><span class="hs-identifier hs-var">idxsubsts'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684426889"><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684426889"><span class="hs-identifier hs-var">newstms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IndexSubstitutions -&gt; Stms rep -&gt; m (IndexSubstitutions, Stms rep)
forall (m :: * -&gt; *) rep.
(MonadFreshNames m, BuilderOps rep, Buildable rep, Aliased rep,
 LParamInfo rep ~ Type) =&gt;
IndexSubstitutions -&gt; Stms rep -&gt; m (IndexSubstitutions, Stms rep)
</span><a href="Futhark.Optimise.InPlaceLowering.SubstituteIndices.html#substituteIndices"><span class="hs-identifier hs-var">substituteIndices</span></a></span><span> </span><span class="annot"><span class="annottext">IndexSubstitutions
</span><a href="#local-6989586621684426892"><span class="hs-identifier hs-var">idxsubsts</span></a></span><span> </span><span class="annot"><span class="annottext">(Stms rep -&gt; m (IndexSubstitutions, Stms rep))
-&gt; Stms rep -&gt; m (IndexSubstitutions, Stms rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Body rep -&gt; Stms rep
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">Body rep
</span><a href="#local-6989586621684426910"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-231"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684426886"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684426886"><span class="hs-identifier hs-var">body_res</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684426885"><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684426885"><span class="hs-identifier hs-var">res_stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[LoopResultSummary (LetDec rep)]
-&gt; IndexSubstitutions -&gt; m (Result, Stms rep)
forall rep (m :: * -&gt; *).
(Buildable rep, MonadFreshNames m) =&gt;
[LoopResultSummary (LetDec rep)]
-&gt; IndexSubstitutions -&gt; m (Result, Stms rep)
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#manipulateResult"><span class="hs-identifier hs-var">manipulateResult</span></a></span><span> </span><span class="annot"><span class="annottext">[LoopResultSummary (als, Type)]
[LoopResultSummary (LetDec rep)]
</span><a href="#local-6989586621684426899"><span class="hs-identifier hs-var">in_place_map</span></a></span><span> </span><span class="annot"><span class="annottext">IndexSubstitutions
</span><a href="#local-6989586621684426890"><span class="hs-identifier hs-var">idxsubsts'</span></a></span><span>
</span><span id="line-232"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684426883"><span class="annot"><span class="annottext">body' :: Body rep
</span><a href="#local-6989586621684426883"><span class="hs-identifier hs-var hs-var">body'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stms rep -&gt; Result -&gt; Body rep
forall rep. Buildable rep =&gt; Stms rep -&gt; Result -&gt; Body rep
</span><a href="Futhark.Builder.Class.html#mkBody"><span class="hs-identifier hs-var">mkBody</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684426889"><span class="hs-identifier hs-var">newstms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms rep -&gt; Stms rep -&gt; Stms rep
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684426885"><span class="hs-identifier hs-var">res_stms</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684426886"><span class="hs-identifier hs-var">body_res</span></a></span><span>
</span><span id="line-233"></span><span>    </span><span class="annot"><span class="annottext">([Stm rep], [Stm rep], [Ident], [(Param DeclType, SubExp)],
 Body rep)
-&gt; m ([Stm rep], [Stm rep], [Ident], [(Param DeclType, SubExp)],
      Body rep)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Stm rep]
</span><a href="#local-6989586621684426897"><span class="hs-identifier hs-var">prestms</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Stm rep]
</span><a href="#local-6989586621684426896"><span class="hs-identifier hs-var">poststms</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Ident]
</span><a href="#local-6989586621684426894"><span class="hs-identifier hs-var">valpat</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(Param DeclType, SubExp)]
</span><a href="#local-6989586621684426898"><span class="hs-identifier hs-var">val'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Body rep
</span><a href="#local-6989586621684426883"><span class="hs-identifier hs-var">body'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-234"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-235"></span><span>    </span><span id="local-6989586621684426901"><span class="annot"><span class="annottext">usedInBody :: Names
</span><a href="#local-6989586621684426901"><span class="hs-identifier hs-var hs-var">usedInBody</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-236"></span><span>      </span><span class="annot"><span class="annottext">[Names] -&gt; Names
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">([Names] -&gt; Names) -&gt; [Names] -&gt; Names
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Names) -&gt; [VName] -&gt; [Names]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Scope rep -&gt; Names
forall rep. AliasesOf (LetDec rep) =&gt; VName -&gt; Scope rep -&gt; Names
</span><a href="Futhark.IR.Prop.Aliases.html#lookupAliases"><span class="hs-operator hs-var">`lookupAliases`</span></a></span><span> </span><span class="annot"><span class="annottext">Scope rep
</span><a href="#local-6989586621684426915"><span class="hs-identifier hs-var">scope</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; [Names]) -&gt; [VName] -&gt; [Names]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Names -&gt; [VName]
</span><a href="Futhark.IR.Prop.Names.html#namesToList"><span class="hs-identifier hs-var">namesToList</span></a></span><span> </span><span class="annot"><span class="annottext">(Names -&gt; [VName]) -&gt; Names -&gt; [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Body rep -&gt; Names
forall a. FreeIn a =&gt; a -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#freeIn"><span class="hs-identifier hs-var">freeIn</span></a></span><span> </span><span class="annot"><span class="annottext">Body rep
</span><a href="#local-6989586621684426910"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">LoopForm rep -&gt; Names
forall a. FreeIn a =&gt; a -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#freeIn"><span class="hs-identifier hs-var">freeIn</span></a></span><span> </span><span class="annot"><span class="annottext">LoopForm rep
</span><a href="#local-6989586621684426911"><span class="hs-identifier hs-var">form</span></a></span><span>
</span><span id="line-237"></span><span>    </span><span id="local-6989586621684426900"><span class="annot"><span class="annottext">resmap :: [(SubExpRes, Ident)]
</span><a href="#local-6989586621684426900"><span class="hs-identifier hs-var hs-var">resmap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Result -&gt; [Ident] -&gt; [(SubExpRes, Ident)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Body rep -&gt; Result
forall rep. BodyT rep -&gt; Result
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var hs-var">bodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">Body rep
</span><a href="#local-6989586621684426910"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Ident] -&gt; [(SubExpRes, Ident)])
-&gt; [Ident] -&gt; [(SubExpRes, Ident)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatT (als, Type) -&gt; [Ident]
forall dec. Typed dec =&gt; PatT dec -&gt; [Ident]
</span><a href="Futhark.IR.Prop.Patterns.html#patIdents"><span class="hs-identifier hs-var">patIdents</span></a></span><span> </span><span class="annot"><span class="annottext">PatT (als, Type)
Pat rep
</span><a href="#local-6989586621684426913"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-238"></span><span>
</span><span id="line-239"></span><span>    </span><span id="local-6989586621684427473"><span id="local-6989586621684427474"><span id="local-6989586621684427475"><span class="annot"><a href="#local-6989586621684426895"><span class="hs-identifier hs-type">mkMerges</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-240"></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.MonadFreshNames.html#MonadFreshNames"><span class="hs-identifier hs-type">MonadFreshNames</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684427475"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Builder.Class.html#Buildable"><span class="hs-identifier hs-type">Buildable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684427474"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-241"></span><span>      </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#LoopResultSummary"><span class="hs-identifier hs-type">LoopResultSummary</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621684427473"><span class="hs-identifier hs-type">als</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-242"></span><span>      </span><span class="annot"><a href="#local-6989586621684427475"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Param"><span class="hs-identifier hs-type">Param</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#DeclType"><span class="hs-identifier hs-type">DeclType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684427474"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684427474"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-243"></span><span>    </span><span id="local-6989586621684426895"><span class="annot"><span class="annottext">mkMerges :: forall (m :: * -&gt; *) rep als.
(MonadFreshNames m, Buildable rep) =&gt;
[LoopResultSummary (als, Type)]
-&gt; m ([(Param DeclType, SubExp)], [Stm rep], [Stm rep])
</span><a href="#local-6989586621684426895"><span class="hs-identifier hs-var hs-var">mkMerges</span></a></span></span><span> </span><span id="local-6989586621684426856"><span class="annot"><span class="annottext">[LoopResultSummary (als, Type)]
</span><a href="#local-6989586621684426856"><span class="hs-identifier hs-var">summaries</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-244"></span><span>      </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621684426855"><span class="annot"><span class="annottext">[(Param DeclType, SubExp)]
</span><a href="#local-6989586621684426855"><span class="hs-identifier hs-var">origmerge</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684426854"><span class="annot"><span class="annottext">[(Param DeclType, SubExp)]
</span><a href="#local-6989586621684426854"><span class="hs-identifier hs-var">extramerge</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684426853"><span class="annot"><span class="annottext">[Stm rep]
</span><a href="#local-6989586621684426853"><span class="hs-identifier hs-var">prestms</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684426852"><span class="annot"><span class="annottext">[Stm rep]
</span><a href="#local-6989586621684426852"><span class="hs-identifier hs-var">poststms</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-245"></span><span>        </span><span class="annot"><span class="annottext">WriterT
  ([Stm rep], [Stm rep])
  m
  ([(Param DeclType, SubExp)], [(Param DeclType, SubExp)])
-&gt; m (([(Param DeclType, SubExp)], [(Param DeclType, SubExp)]),
      ([Stm rep], [Stm rep]))
forall w (m :: * -&gt; *) a. WriterT w m a -&gt; m (a, w)
</span><span class="hs-identifier hs-var hs-var">runWriterT</span></span><span> </span><span class="annot"><span class="annottext">(WriterT
   ([Stm rep], [Stm rep])
   m
   ([(Param DeclType, SubExp)], [(Param DeclType, SubExp)])
 -&gt; m (([(Param DeclType, SubExp)], [(Param DeclType, SubExp)]),
       ([Stm rep], [Stm rep])))
-&gt; WriterT
     ([Stm rep], [Stm rep])
     m
     ([(Param DeclType, SubExp)], [(Param DeclType, SubExp)])
-&gt; m (([(Param DeclType, SubExp)], [(Param DeclType, SubExp)]),
      ([Stm rep], [Stm rep]))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Either (Param DeclType, SubExp) (Param DeclType, SubExp)]
-&gt; ([(Param DeclType, SubExp)], [(Param DeclType, SubExp)])
forall a b. [Either a b] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">partitionEithers</span></span><span> </span><span class="annot"><span class="annottext">([Either (Param DeclType, SubExp) (Param DeclType, SubExp)]
 -&gt; ([(Param DeclType, SubExp)], [(Param DeclType, SubExp)]))
-&gt; WriterT
     ([Stm rep], [Stm rep])
     m
     [Either (Param DeclType, SubExp) (Param DeclType, SubExp)]
-&gt; WriterT
     ([Stm rep], [Stm rep])
     m
     ([(Param DeclType, SubExp)], [(Param DeclType, SubExp)])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(LoopResultSummary (als, Type)
 -&gt; WriterT
      ([Stm rep], [Stm rep])
      m
      (Either (Param DeclType, SubExp) (Param DeclType, SubExp)))
-&gt; [LoopResultSummary (als, Type)]
-&gt; WriterT
     ([Stm rep], [Stm rep])
     m
     [Either (Param DeclType, SubExp) (Param DeclType, SubExp)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">LoopResultSummary (als, Type)
-&gt; WriterT
     ([Stm rep], [Stm rep])
     m
     (Either (Param DeclType, SubExp) (Param DeclType, SubExp))
forall {m :: * -&gt; *} {rep} {rep} {a}.
(MonadFreshNames m, MonadWriter ([Stm rep], [Stm rep]) m,
 Buildable rep, Buildable rep) =&gt;
LoopResultSummary (a, Type)
-&gt; m (Either (Param DeclType, SubExp) (Param DeclType, SubExp))
</span><a href="#local-6989586621684426848"><span class="hs-identifier hs-var">mkMerge</span></a></span><span> </span><span class="annot"><span class="annottext">[LoopResultSummary (als, Type)]
</span><a href="#local-6989586621684426856"><span class="hs-identifier hs-var">summaries</span></a></span><span>
</span><span id="line-246"></span><span>      </span><span class="annot"><span class="annottext">([(Param DeclType, SubExp)], [Stm rep], [Stm rep])
-&gt; m ([(Param DeclType, SubExp)], [Stm rep], [Stm rep])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(Param DeclType, SubExp)]
</span><a href="#local-6989586621684426855"><span class="hs-identifier hs-var">origmerge</span></a></span><span> </span><span class="annot"><span class="annottext">[(Param DeclType, SubExp)]
-&gt; [(Param DeclType, SubExp)] -&gt; [(Param DeclType, SubExp)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[(Param DeclType, SubExp)]
</span><a href="#local-6989586621684426854"><span class="hs-identifier hs-var">extramerge</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Stm rep]
</span><a href="#local-6989586621684426853"><span class="hs-identifier hs-var">prestms</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Stm rep]
</span><a href="#local-6989586621684426852"><span class="hs-identifier hs-var">poststms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-247"></span><span>
</span><span id="line-248"></span><span>    </span><span id="local-6989586621684426848"><span class="annot"><span class="annottext">mkMerge :: LoopResultSummary (a, Type)
-&gt; m (Either (Param DeclType, SubExp) (Param DeclType, SubExp))
</span><a href="#local-6989586621684426848"><span class="hs-identifier hs-var hs-var">mkMerge</span></a></span></span><span> </span><span id="local-6989586621684426830"><span class="annot"><span class="annottext">LoopResultSummary (a, Type)
</span><a href="#local-6989586621684426830"><span class="hs-identifier hs-var">summary</span></a></span></span><span>
</span><span id="line-249"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684426829"><span class="annot"><span class="annottext">DesiredUpdate (a, Type)
</span><a href="#local-6989586621684426829"><span class="hs-identifier hs-var">update</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684426828"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684426828"><span class="hs-identifier hs-var">mergename</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684426827"><span class="annot"><span class="annottext">(a, Type)
</span><a href="#local-6989586621684426827"><span class="hs-identifier hs-var">mergedec</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LoopResultSummary (a, Type)
-&gt; Maybe (DesiredUpdate (a, Type), VName, (a, Type))
forall dec.
LoopResultSummary dec -&gt; Maybe (DesiredUpdate dec, VName, dec)
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#relatedUpdate"><span class="hs-identifier hs-var hs-var">relatedUpdate</span></a></span><span> </span><span class="annot"><span class="annottext">LoopResultSummary (a, Type)
</span><a href="#local-6989586621684426830"><span class="hs-identifier hs-var">summary</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-250"></span><span>        </span><span id="local-6989586621684426825"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684426825"><span class="hs-identifier hs-var">source</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; m VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; String -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;modified_source&quot;</span></span><span>
</span><span id="line-251"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684426823"><span class="annot"><span class="annottext">source_t :: Type
</span><a href="#local-6989586621684426823"><span class="hs-identifier hs-var hs-var">source_t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(a, Type) -&gt; Type
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">((a, Type) -&gt; Type) -&gt; (a, Type) -&gt; Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DesiredUpdate (a, Type) -&gt; (a, Type)
forall dec. DesiredUpdate dec -&gt; dec
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#updateType"><span class="hs-identifier hs-var hs-var">updateType</span></a></span><span> </span><span class="annot"><span class="annottext">DesiredUpdate (a, Type)
</span><a href="#local-6989586621684426829"><span class="hs-identifier hs-var">update</span></a></span><span>
</span><span id="line-252"></span><span>            </span><span id="local-6989586621684426822"><span class="annot"><span class="annottext">elmident :: Ident
</span><a href="#local-6989586621684426822"><span class="hs-identifier hs-var hs-var">elmident</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-253"></span><span>              </span><span class="annot"><span class="annottext">VName -&gt; Type -&gt; Ident
</span><a href="Futhark.IR.Syntax.Core.html#Ident"><span class="hs-identifier hs-var">Ident</span></a></span><span>
</span><span id="line-254"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DesiredUpdate (a, Type) -&gt; VName
forall dec. DesiredUpdate dec -&gt; VName
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#updateValue"><span class="hs-identifier hs-var hs-var">updateValue</span></a></span><span> </span><span class="annot"><span class="annottext">DesiredUpdate (a, Type)
</span><a href="#local-6989586621684426829"><span class="hs-identifier hs-var">update</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-255"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684426823"><span class="hs-identifier hs-var">source_t</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; [SubExp] -&gt; Type
forall oldshape u.
TypeBase oldshape u -&gt; [SubExp] -&gt; TypeBase Shape u
</span><a href="Futhark.IR.Prop.Types.html#setArrayDims"><span class="hs-operator hs-var">`setArrayDims`</span></a></span><span> </span><span class="annot"><span class="annottext">Slice SubExp -&gt; [SubExp]
forall d. Slice d -&gt; [d]
</span><a href="Futhark.IR.Syntax.Core.html#sliceDims"><span class="hs-identifier hs-var">sliceDims</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DesiredUpdate (a, Type) -&gt; Slice SubExp
forall dec. DesiredUpdate dec -&gt; Slice SubExp
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#updateIndices"><span class="hs-identifier hs-var hs-var">updateIndices</span></a></span><span> </span><span class="annot"><span class="annottext">DesiredUpdate (a, Type)
</span><a href="#local-6989586621684426829"><span class="hs-identifier hs-var">update</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-256"></span><span>        </span><span class="annot"><span class="annottext">([Stm rep], [Stm rep]) -&gt; m ()
forall w (m :: * -&gt; *). MonadWriter w m =&gt; w -&gt; m ()
</span><span class="hs-identifier hs-var">tell</span></span><span>
</span><span id="line-257"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">[Ident] -&gt; Exp rep -&gt; Stm rep
forall rep. Buildable rep =&gt; [Ident] -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.Builder.Class.html#mkLet"><span class="hs-identifier hs-var">mkLet</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">VName -&gt; Type -&gt; Ident
</span><a href="Futhark.IR.Syntax.Core.html#Ident"><span class="hs-identifier hs-var">Ident</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684426825"><span class="hs-identifier hs-var">source</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684426823"><span class="hs-identifier hs-var">source_t</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(Exp rep -&gt; Stm rep) -&gt; (BasicOp -&gt; Exp rep) -&gt; BasicOp -&gt; Stm rep
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; Exp rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; Stm rep) -&gt; BasicOp -&gt; Stm rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-258"></span><span>                </span><span class="annot"><span class="annottext">Safety -&gt; VName -&gt; Slice SubExp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Update"><span class="hs-identifier hs-var">Update</span></a></span><span>
</span><span id="line-259"></span><span>                  </span><span class="annot"><span class="annottext">Safety
</span><a href="Futhark.IR.Primitive.html#Unsafe"><span class="hs-identifier hs-var">Unsafe</span></a></span><span>
</span><span id="line-260"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DesiredUpdate (a, Type) -&gt; VName
forall dec. DesiredUpdate dec -&gt; VName
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#updateSource"><span class="hs-identifier hs-var hs-var">updateSource</span></a></span><span> </span><span class="annot"><span class="annottext">DesiredUpdate (a, Type)
</span><a href="#local-6989586621684426829"><span class="hs-identifier hs-var">update</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-261"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; [DimIndex SubExp] -&gt; Slice SubExp
</span><a href="Futhark.Construct.html#fullSlice"><span class="hs-identifier hs-var">fullSlice</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684426823"><span class="hs-identifier hs-var">source_t</span></a></span><span> </span><span class="annot"><span class="annottext">([DimIndex SubExp] -&gt; Slice SubExp)
-&gt; [DimIndex SubExp] -&gt; Slice SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Slice SubExp -&gt; [DimIndex SubExp]
forall d. Slice d -&gt; [DimIndex d]
</span><a href="Futhark.IR.Syntax.Core.html#unSlice"><span class="hs-identifier hs-var hs-var">unSlice</span></a></span><span> </span><span class="annot"><span class="annottext">(Slice SubExp -&gt; [DimIndex SubExp])
-&gt; Slice SubExp -&gt; [DimIndex SubExp]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DesiredUpdate (a, Type) -&gt; Slice SubExp
forall dec. DesiredUpdate dec -&gt; Slice SubExp
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#updateIndices"><span class="hs-identifier hs-var hs-var">updateIndices</span></a></span><span> </span><span class="annot"><span class="annottext">DesiredUpdate (a, Type)
</span><a href="#local-6989586621684426829"><span class="hs-identifier hs-var">update</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-262"></span><span>                  </span><span class="annot"><span class="annottext">(SubExp -&gt; BasicOp) -&gt; SubExp -&gt; BasicOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Param DeclType, SubExp) -&gt; SubExp
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">((Param DeclType, SubExp) -&gt; SubExp)
-&gt; (Param DeclType, SubExp) -&gt; SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LoopResultSummary (a, Type) -&gt; (Param DeclType, SubExp)
forall dec. LoopResultSummary dec -&gt; (Param DeclType, SubExp)
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#mergeParam"><span class="hs-identifier hs-var hs-var">mergeParam</span></a></span><span> </span><span class="annot"><span class="annottext">LoopResultSummary (a, Type)
</span><a href="#local-6989586621684426830"><span class="hs-identifier hs-var">summary</span></a></span><span>
</span><span id="line-263"></span><span>            </span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><span id="line-264"></span><span>            </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">[Ident] -&gt; Exp rep -&gt; Stm rep
forall rep. Buildable rep =&gt; [Ident] -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.Builder.Class.html#mkLet"><span class="hs-identifier hs-var">mkLet</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Ident
</span><a href="#local-6989586621684426822"><span class="hs-identifier hs-var">elmident</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(Exp rep -&gt; Stm rep) -&gt; (BasicOp -&gt; Exp rep) -&gt; BasicOp -&gt; Stm rep
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; Exp rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; Stm rep) -&gt; BasicOp -&gt; Stm rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-265"></span><span>                </span><span class="annot"><span class="annottext">VName -&gt; Slice SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Index"><span class="hs-identifier hs-var">Index</span></a></span><span>
</span><span id="line-266"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DesiredUpdate (a, Type) -&gt; VName
forall dec. DesiredUpdate dec -&gt; VName
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#updateName"><span class="hs-identifier hs-var hs-var">updateName</span></a></span><span> </span><span class="annot"><span class="annottext">DesiredUpdate (a, Type)
</span><a href="#local-6989586621684426829"><span class="hs-identifier hs-var">update</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-267"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; [DimIndex SubExp] -&gt; Slice SubExp
</span><a href="Futhark.Construct.html#fullSlice"><span class="hs-identifier hs-var">fullSlice</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684426823"><span class="hs-identifier hs-var">source_t</span></a></span><span> </span><span class="annot"><span class="annottext">([DimIndex SubExp] -&gt; Slice SubExp)
-&gt; [DimIndex SubExp] -&gt; Slice SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Slice SubExp -&gt; [DimIndex SubExp]
forall d. Slice d -&gt; [DimIndex d]
</span><a href="Futhark.IR.Syntax.Core.html#unSlice"><span class="hs-identifier hs-var hs-var">unSlice</span></a></span><span> </span><span class="annot"><span class="annottext">(Slice SubExp -&gt; [DimIndex SubExp])
-&gt; Slice SubExp -&gt; [DimIndex SubExp]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DesiredUpdate (a, Type) -&gt; Slice SubExp
forall dec. DesiredUpdate dec -&gt; Slice SubExp
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#updateIndices"><span class="hs-identifier hs-var hs-var">updateIndices</span></a></span><span> </span><span class="annot"><span class="annottext">DesiredUpdate (a, Type)
</span><a href="#local-6989586621684426829"><span class="hs-identifier hs-var">update</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-268"></span><span>            </span><span class="hs-special">]</span><span>
</span><span id="line-269"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-270"></span><span>        </span><span class="annot"><span class="annottext">Either (Param DeclType, SubExp) (Param DeclType, SubExp)
-&gt; m (Either (Param DeclType, SubExp) (Param DeclType, SubExp))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Either (Param DeclType, SubExp) (Param DeclType, SubExp)
 -&gt; m (Either (Param DeclType, SubExp) (Param DeclType, SubExp)))
-&gt; Either (Param DeclType, SubExp) (Param DeclType, SubExp)
-&gt; m (Either (Param DeclType, SubExp) (Param DeclType, SubExp))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-271"></span><span>          </span><span class="annot"><span class="annottext">(Param DeclType, SubExp)
-&gt; Either (Param DeclType, SubExp) (Param DeclType, SubExp)
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span>
</span><span id="line-272"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Attrs -&gt; VName -&gt; DeclType -&gt; Param DeclType
forall dec. Attrs -&gt; VName -&gt; dec -&gt; Param dec
</span><a href="Futhark.IR.Syntax.Core.html#Param"><span class="hs-identifier hs-var">Param</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684426828"><span class="hs-identifier hs-var">mergename</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Uniqueness -&gt; DeclType
forall shape.
TypeBase shape NoUniqueness
-&gt; Uniqueness -&gt; TypeBase shape Uniqueness
</span><a href="Futhark.IR.Prop.Types.html#toDecl"><span class="hs-identifier hs-var">toDecl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(a, Type) -&gt; Type
forall t. Typed t =&gt; t -&gt; Type
</span><a href="Futhark.IR.Prop.Types.html#typeOf"><span class="hs-identifier hs-var">typeOf</span></a></span><span> </span><span class="annot"><span class="annottext">(a, Type)
</span><a href="#local-6989586621684426827"><span class="hs-identifier hs-var">mergedec</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="Language.Futhark.Core.html#Unique"><span class="hs-identifier hs-var">Unique</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-273"></span><span>              </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684426825"><span class="hs-identifier hs-var">source</span></a></span><span>
</span><span id="line-274"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-275"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Either (Param DeclType, SubExp) (Param DeclType, SubExp)
-&gt; m (Either (Param DeclType, SubExp) (Param DeclType, SubExp))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Either (Param DeclType, SubExp) (Param DeclType, SubExp)
 -&gt; m (Either (Param DeclType, SubExp) (Param DeclType, SubExp)))
-&gt; Either (Param DeclType, SubExp) (Param DeclType, SubExp)
-&gt; m (Either (Param DeclType, SubExp) (Param DeclType, SubExp))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Param DeclType, SubExp)
-&gt; Either (Param DeclType, SubExp) (Param DeclType, SubExp)
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">((Param DeclType, SubExp)
 -&gt; Either (Param DeclType, SubExp) (Param DeclType, SubExp))
-&gt; (Param DeclType, SubExp)
-&gt; Either (Param DeclType, SubExp) (Param DeclType, SubExp)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LoopResultSummary (a, Type) -&gt; (Param DeclType, SubExp)
forall dec. LoopResultSummary dec -&gt; (Param DeclType, SubExp)
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#mergeParam"><span class="hs-identifier hs-var hs-var">mergeParam</span></a></span><span> </span><span class="annot"><span class="annottext">LoopResultSummary (a, Type)
</span><a href="#local-6989586621684426830"><span class="hs-identifier hs-var">summary</span></a></span><span>
</span><span id="line-276"></span><span>
</span><span id="line-277"></span><span>    </span><span id="local-6989586621684426893"><span class="annot"><span class="annottext">mkResAndPat :: [LoopResultSummary (a, Type)] -&gt; [Ident]
</span><a href="#local-6989586621684426893"><span class="hs-identifier hs-var hs-var">mkResAndPat</span></a></span></span><span> </span><span id="local-6989586621684426814"><span class="annot"><span class="annottext">[LoopResultSummary (a, Type)]
</span><a href="#local-6989586621684426814"><span class="hs-identifier hs-var">summaries</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-278"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684426813"><span class="annot"><span class="annottext">[Ident]
</span><a href="#local-6989586621684426813"><span class="hs-identifier hs-var">origpat</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684426812"><span class="annot"><span class="annottext">[Ident]
</span><a href="#local-6989586621684426812"><span class="hs-identifier hs-var">extrapat</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Either Ident Ident] -&gt; ([Ident], [Ident])
forall a b. [Either a b] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">partitionEithers</span></span><span> </span><span class="annot"><span class="annottext">([Either Ident Ident] -&gt; ([Ident], [Ident]))
-&gt; [Either Ident Ident] -&gt; ([Ident], [Ident])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(LoopResultSummary (a, Type) -&gt; Either Ident Ident)
-&gt; [LoopResultSummary (a, Type)] -&gt; [Either Ident Ident]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">LoopResultSummary (a, Type) -&gt; Either Ident Ident
forall {a}. LoopResultSummary (a, Type) -&gt; Either Ident Ident
</span><a href="#local-6989586621684426811"><span class="hs-identifier hs-var">mkResAndPat'</span></a></span><span> </span><span class="annot"><span class="annottext">[LoopResultSummary (a, Type)]
</span><a href="#local-6989586621684426814"><span class="hs-identifier hs-var">summaries</span></a></span><span>
</span><span id="line-279"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">[Ident]
</span><a href="#local-6989586621684426813"><span class="hs-identifier hs-var">origpat</span></a></span><span> </span><span class="annot"><span class="annottext">[Ident] -&gt; [Ident] -&gt; [Ident]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Ident]
</span><a href="#local-6989586621684426812"><span class="hs-identifier hs-var">extrapat</span></a></span><span>
</span><span id="line-280"></span><span>
</span><span id="line-281"></span><span>    </span><span id="local-6989586621684426811"><span class="annot"><span class="annottext">mkResAndPat' :: LoopResultSummary (a, Type) -&gt; Either Ident Ident
</span><a href="#local-6989586621684426811"><span class="hs-identifier hs-var hs-var">mkResAndPat'</span></a></span></span><span> </span><span id="local-6989586621684426810"><span class="annot"><span class="annottext">LoopResultSummary (a, Type)
</span><a href="#local-6989586621684426810"><span class="hs-identifier hs-var">summary</span></a></span></span><span>
</span><span id="line-282"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684426809"><span class="annot"><span class="annottext">DesiredUpdate (a, Type)
</span><a href="#local-6989586621684426809"><span class="hs-identifier hs-var">update</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(a, Type)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LoopResultSummary (a, Type)
-&gt; Maybe (DesiredUpdate (a, Type), VName, (a, Type))
forall dec.
LoopResultSummary dec -&gt; Maybe (DesiredUpdate dec, VName, dec)
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#relatedUpdate"><span class="hs-identifier hs-var hs-var">relatedUpdate</span></a></span><span> </span><span class="annot"><span class="annottext">LoopResultSummary (a, Type)
</span><a href="#local-6989586621684426810"><span class="hs-identifier hs-var">summary</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-283"></span><span>        </span><span class="annot"><span class="annottext">Ident -&gt; Either Ident Ident
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Type -&gt; Ident
</span><a href="Futhark.IR.Syntax.Core.html#Ident"><span class="hs-identifier hs-var">Ident</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DesiredUpdate (a, Type) -&gt; VName
forall dec. DesiredUpdate dec -&gt; VName
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#updateName"><span class="hs-identifier hs-var hs-var">updateName</span></a></span><span> </span><span class="annot"><span class="annottext">DesiredUpdate (a, Type)
</span><a href="#local-6989586621684426809"><span class="hs-identifier hs-var">update</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(a, Type) -&gt; Type
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">((a, Type) -&gt; Type) -&gt; (a, Type) -&gt; Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DesiredUpdate (a, Type) -&gt; (a, Type)
forall dec. DesiredUpdate dec -&gt; dec
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#updateType"><span class="hs-identifier hs-var hs-var">updateType</span></a></span><span> </span><span class="annot"><span class="annottext">DesiredUpdate (a, Type)
</span><a href="#local-6989586621684426809"><span class="hs-identifier hs-var">update</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-284"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-285"></span><span>        </span><span class="annot"><span class="annottext">Ident -&gt; Either Ident Ident
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LoopResultSummary (a, Type) -&gt; Ident
forall dec. LoopResultSummary dec -&gt; Ident
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#inPatAs"><span class="hs-identifier hs-var hs-var">inPatAs</span></a></span><span> </span><span class="annot"><span class="annottext">LoopResultSummary (a, Type)
</span><a href="#local-6989586621684426810"><span class="hs-identifier hs-var">summary</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-286"></span><span>
</span><span id="line-287"></span><span id="local-6989586621684427476"><span id="local-6989586621684427477"><span id="local-6989586621684427478"><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#summariseLoop"><span class="hs-identifier hs-type">summariseLoop</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-288"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Aliases.html#Aliased"><span class="hs-identifier hs-type">Aliased</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684427478"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-289"></span><span>    </span><span class="annot"><a href="Futhark.MonadFreshNames.html#MonadFreshNames"><span class="hs-identifier hs-type">MonadFreshNames</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684427477"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-290"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-291"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684427478"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-292"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#DesiredUpdate"><span class="hs-identifier hs-type">DesiredUpdate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621684427476"><span class="hs-identifier hs-type">als</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-293"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-294"></span><span>  </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-type">SubExpRes</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Ident"><span class="hs-identifier hs-type">Ident</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-295"></span><span>  </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Param"><span class="hs-identifier hs-type">Param</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#DeclType"><span class="hs-identifier hs-type">DeclType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-296"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621684427477"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#LoopResultSummary"><span class="hs-identifier hs-type">LoopResultSummary</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621684427476"><span class="hs-identifier hs-type">als</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-297"></span><span id="summariseLoop"><span class="annot"><span class="annottext">summariseLoop :: forall rep (m :: * -&gt; *) als.
(Aliased rep, MonadFreshNames m) =&gt;
Scope rep
-&gt; [DesiredUpdate (als, Type)]
-&gt; Names
-&gt; [(SubExpRes, Ident)]
-&gt; [(Param DeclType, SubExp)]
-&gt; Maybe (m [LoopResultSummary (als, Type)])
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#summariseLoop"><span class="hs-identifier hs-var hs-var">summariseLoop</span></a></span></span><span> </span><span id="local-6989586621684426786"><span class="annot"><span class="annottext">Scope rep
</span><a href="#local-6989586621684426786"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span id="local-6989586621684426785"><span class="annot"><span class="annottext">[DesiredUpdate (als, Type)]
</span><a href="#local-6989586621684426785"><span class="hs-identifier hs-var">updates</span></a></span></span><span> </span><span id="local-6989586621684426784"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684426784"><span class="hs-identifier hs-var">usedInBody</span></a></span></span><span> </span><span id="local-6989586621684426783"><span class="annot"><span class="annottext">[(SubExpRes, Ident)]
</span><a href="#local-6989586621684426783"><span class="hs-identifier hs-var">resmap</span></a></span></span><span> </span><span id="local-6989586621684426782"><span class="annot"><span class="annottext">[(Param DeclType, SubExp)]
</span><a href="#local-6989586621684426782"><span class="hs-identifier hs-var">merge</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-298"></span><span>  </span><span class="annot"><span class="annottext">[m (LoopResultSummary (als, Type))]
-&gt; m [LoopResultSummary (als, Type)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a.
(Traversable t, Monad m) =&gt;
t (m a) -&gt; m (t a)
</span><span class="hs-identifier hs-var">sequence</span></span><span> </span><span class="annot"><span class="annottext">([m (LoopResultSummary (als, Type))]
 -&gt; m [LoopResultSummary (als, Type)])
-&gt; Maybe [m (LoopResultSummary (als, Type))]
-&gt; Maybe (m [LoopResultSummary (als, Type)])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">((SubExpRes, Ident)
 -&gt; (Param DeclType, SubExp)
 -&gt; Maybe (m (LoopResultSummary (als, Type))))
-&gt; [(SubExpRes, Ident)]
-&gt; [(Param DeclType, SubExp)]
-&gt; Maybe [m (LoopResultSummary (als, Type))]
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m [c]
</span><span class="hs-identifier hs-var">zipWithM</span></span><span> </span><span class="annot"><span class="annottext">(SubExpRes, Ident)
-&gt; (Param DeclType, SubExp)
-&gt; Maybe (m (LoopResultSummary (als, Type)))
</span><a href="#local-6989586621684426781"><span class="hs-identifier hs-var">summariseLoopResult</span></a></span><span> </span><span class="annot"><span class="annottext">[(SubExpRes, Ident)]
</span><a href="#local-6989586621684426783"><span class="hs-identifier hs-var">resmap</span></a></span><span> </span><span class="annot"><span class="annottext">[(Param DeclType, SubExp)]
</span><a href="#local-6989586621684426782"><span class="hs-identifier hs-var">merge</span></a></span><span>
</span><span id="line-299"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-300"></span><span>    </span><span id="local-6989586621684426781"><span class="annot"><span class="annottext">summariseLoopResult :: (SubExpRes, Ident)
-&gt; (Param DeclType, SubExp)
-&gt; Maybe (m (LoopResultSummary (als, Type)))
</span><a href="#local-6989586621684426781"><span class="hs-identifier hs-var hs-var">summariseLoopResult</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684426780"><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684426780"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684426779"><span class="annot"><span class="annottext">Ident
</span><a href="#local-6989586621684426779"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684426778"><span class="annot"><span class="annottext">Param DeclType
</span><a href="#local-6989586621684426778"><span class="hs-identifier hs-var">fparam</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684426777"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684426777"><span class="hs-identifier hs-var">mergeinit</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-301"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684426776"><span class="annot"><span class="annottext">DesiredUpdate (als, Type)
</span><a href="#local-6989586621684426776"><span class="hs-identifier hs-var">update</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(DesiredUpdate (als, Type) -&gt; Bool)
-&gt; [DesiredUpdate (als, Type)] -&gt; Maybe (DesiredUpdate (als, Type))
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Maybe a
</span><span class="hs-identifier hs-var">find</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; DesiredUpdate (als, Type) -&gt; Bool
forall dec. VName -&gt; DesiredUpdate dec -&gt; Bool
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#updateHasValue"><span class="hs-identifier hs-var">updateHasValue</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; DesiredUpdate (als, Type) -&gt; Bool)
-&gt; VName -&gt; DesiredUpdate (als, Type) -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Ident -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#identName"><span class="hs-identifier hs-var hs-var">identName</span></a></span><span> </span><span class="annot"><span class="annottext">Ident
</span><a href="#local-6989586621684426779"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DesiredUpdate (als, Type)]
</span><a href="#local-6989586621684426785"><span class="hs-identifier hs-var">updates</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-302"></span><span>        </span><span class="hs-comment">-- Safety condition (7)</span><span>
</span><span id="line-303"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684426784"><span class="hs-identifier hs-var">usedInBody</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#namesIntersect"><span class="hs-operator hs-var">`namesIntersect`</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Scope rep -&gt; Names
forall rep. AliasesOf (LetDec rep) =&gt; VName -&gt; Scope rep -&gt; Names
</span><a href="Futhark.IR.Prop.Aliases.html#lookupAliases"><span class="hs-identifier hs-var">lookupAliases</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DesiredUpdate (als, Type) -&gt; VName
forall dec. DesiredUpdate dec -&gt; VName
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#updateSource"><span class="hs-identifier hs-var hs-var">updateSource</span></a></span><span> </span><span class="annot"><span class="annottext">DesiredUpdate (als, Type)
</span><a href="#local-6989586621684426776"><span class="hs-identifier hs-var">update</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Scope rep
</span><a href="#local-6989586621684426786"><span class="hs-identifier hs-var">scope</span></a></span><span>
</span><span id="line-304"></span><span>          </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Maybe (m (LoopResultSummary (als, Type)))
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-305"></span><span>          </span><span class="hs-keyword">else</span><span>
</span><span id="line-306"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Param DeclType -&gt; Bool
</span><a href="#local-6989586621684426774"><span class="hs-identifier hs-var">hasLoopInvariantShape</span></a></span><span> </span><span class="annot"><span class="annottext">Param DeclType
</span><a href="#local-6989586621684426778"><span class="hs-identifier hs-var">fparam</span></a></span><span>
</span><span id="line-307"></span><span>              </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">m (LoopResultSummary (als, Type))
-&gt; Maybe (m (LoopResultSummary (als, Type)))
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(m (LoopResultSummary (als, Type))
 -&gt; Maybe (m (LoopResultSummary (als, Type))))
-&gt; m (LoopResultSummary (als, Type))
-&gt; Maybe (m (LoopResultSummary (als, Type)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-308"></span><span>                </span><span id="local-6989586621684426773"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684426773"><span class="hs-identifier hs-var">lowered_array</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; m VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; String -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;lowered_array&quot;</span></span><span>
</span><span id="line-309"></span><span>                </span><span class="annot"><span class="annottext">LoopResultSummary (als, Type) -&gt; m (LoopResultSummary (als, Type))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-310"></span><span>                  </span><span class="annot"><span class="annottext">LoopResultSummary :: forall dec.
SubExpRes
-&gt; Ident
-&gt; (Param DeclType, SubExp)
-&gt; Maybe (DesiredUpdate dec, VName, dec)
-&gt; LoopResultSummary dec
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#LoopResultSummary"><span class="hs-identifier hs-type">LoopResultSummary</span></a></span><span>
</span><span id="line-311"></span><span>                    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">resultSubExp :: SubExpRes
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#resultSubExp"><span class="hs-identifier hs-var">resultSubExp</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684426780"><span class="hs-identifier hs-var">se</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-312"></span><span>                      </span><span class="annot"><span class="annottext">inPatAs :: Ident
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#inPatAs"><span class="hs-identifier hs-var">inPatAs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ident
</span><a href="#local-6989586621684426779"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-313"></span><span>                      </span><span class="annot"><span class="annottext">mergeParam :: (Param DeclType, SubExp)
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#mergeParam"><span class="hs-identifier hs-var">mergeParam</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param DeclType
</span><a href="#local-6989586621684426778"><span class="hs-identifier hs-var">fparam</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684426777"><span class="hs-identifier hs-var">mergeinit</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-314"></span><span>                      </span><span class="annot"><span class="annottext">relatedUpdate :: Maybe (DesiredUpdate (als, Type), VName, (als, Type))
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#relatedUpdate"><span class="hs-identifier hs-var">relatedUpdate</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-315"></span><span>                        </span><span class="annot"><span class="annottext">(DesiredUpdate (als, Type), VName, (als, Type))
-&gt; Maybe (DesiredUpdate (als, Type), VName, (als, Type))
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span>
</span><span id="line-316"></span><span>                          </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">DesiredUpdate (als, Type)
</span><a href="#local-6989586621684426776"><span class="hs-identifier hs-var">update</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-317"></span><span>                            </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684426773"><span class="hs-identifier hs-var">lowered_array</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-318"></span><span>                            </span><span class="annot"><span class="annottext">DesiredUpdate (als, Type) -&gt; (als, Type)
forall dec. DesiredUpdate dec -&gt; dec
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#updateType"><span class="hs-identifier hs-var hs-var">updateType</span></a></span><span> </span><span class="annot"><span class="annottext">DesiredUpdate (als, Type)
</span><a href="#local-6989586621684426776"><span class="hs-identifier hs-var">update</span></a></span><span>
</span><span id="line-319"></span><span>                          </span><span class="hs-special">)</span><span>
</span><span id="line-320"></span><span>                    </span><span class="hs-special">}</span><span>
</span><span id="line-321"></span><span>              </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Maybe (m (LoopResultSummary (als, Type)))
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-322"></span><span>    </span><span class="annot"><a href="#local-6989586621684426781"><span class="hs-identifier hs-var">summariseLoopResult</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExpRes, Ident)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">(Param DeclType, SubExp)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-323"></span><span>      </span><span class="annot"><span class="annottext">Maybe (m (LoopResultSummary (als, Type)))
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-comment">-- XXX: conservative; but this entire pass is going away.</span><span>
</span><span id="line-324"></span><span>    </span><span id="local-6989586621684426774"><span class="annot"><span class="annottext">hasLoopInvariantShape :: Param DeclType -&gt; Bool
</span><a href="#local-6989586621684426774"><span class="hs-identifier hs-var hs-var">hasLoopInvariantShape</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; Bool) -&gt; [SubExp] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Bool
</span><a href="#local-6989586621684426770"><span class="hs-identifier hs-var">loopInvariant</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; Bool)
-&gt; (Param DeclType -&gt; [SubExp]) -&gt; Param DeclType -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; [SubExp]
forall u. TypeBase Shape u -&gt; [SubExp]
</span><a href="Futhark.IR.Prop.Types.html#arrayDims"><span class="hs-identifier hs-var">arrayDims</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; [SubExp])
-&gt; (Param DeclType -&gt; Type) -&gt; Param DeclType -&gt; [SubExp]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Param DeclType -&gt; Type
forall dec. Typed dec =&gt; Param dec -&gt; Type
</span><a href="Futhark.IR.Prop.Patterns.html#paramType"><span class="hs-identifier hs-var">paramType</span></a></span><span>
</span><span id="line-325"></span><span>
</span><span id="line-326"></span><span>    </span><span id="local-6989586621684426768"><span class="annot"><span class="annottext">merge_param_names :: [VName]
</span><a href="#local-6989586621684426768"><span class="hs-identifier hs-var hs-var">merge_param_names</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Param DeclType, SubExp) -&gt; VName)
-&gt; [(Param DeclType, SubExp)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param DeclType -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">(Param DeclType -&gt; VName)
-&gt; ((Param DeclType, SubExp) -&gt; Param DeclType)
-&gt; (Param DeclType, SubExp)
-&gt; VName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Param DeclType, SubExp) -&gt; Param DeclType
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Param DeclType, SubExp)]
</span><a href="#local-6989586621684426782"><span class="hs-identifier hs-var">merge</span></a></span><span>
</span><span id="line-327"></span><span>
</span><span id="line-328"></span><span>    </span><span id="local-6989586621684426770"><span class="annot"><span class="annottext">loopInvariant :: SubExp -&gt; Bool
</span><a href="#local-6989586621684426770"><span class="hs-identifier hs-var hs-var">loopInvariant</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684426767"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684426767"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684426767"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [VName] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`notElem`</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684426768"><span class="hs-identifier hs-var">merge_param_names</span></a></span><span>
</span><span id="line-329"></span><span>    </span><span class="annot"><a href="#local-6989586621684426770"><span class="hs-identifier hs-var">loopInvariant</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-330"></span><span>
</span><span id="line-331"></span><span class="hs-keyword">data</span><span> </span><span id="LoopResultSummary"><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#LoopResultSummary"><span class="hs-identifier hs-var">LoopResultSummary</span></a></span></span><span> </span><span id="local-6989586621684427433"><span class="annot"><a href="#local-6989586621684427433"><span class="hs-identifier hs-type">dec</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="LoopResultSummary"><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#LoopResultSummary"><span class="hs-identifier hs-var">LoopResultSummary</span></a></span></span><span>
</span><span id="line-332"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="resultSubExp"><span class="annot"><span class="annottext">forall dec. LoopResultSummary dec -&gt; SubExpRes
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#resultSubExp"><span class="hs-identifier hs-var hs-var">resultSubExp</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-type">SubExpRes</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-333"></span><span>    </span><span id="inPatAs"><span class="annot"><span class="annottext">forall dec. LoopResultSummary dec -&gt; Ident
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#inPatAs"><span class="hs-identifier hs-var hs-var">inPatAs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Ident"><span class="hs-identifier hs-type">Ident</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-334"></span><span>    </span><span id="mergeParam"><span class="annot"><span class="annottext">forall dec. LoopResultSummary dec -&gt; (Param DeclType, SubExp)
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#mergeParam"><span class="hs-identifier hs-var hs-var">mergeParam</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Param"><span class="hs-identifier hs-type">Param</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#DeclType"><span class="hs-identifier hs-type">DeclType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-335"></span><span>    </span><span id="relatedUpdate"><span class="annot"><span class="annottext">forall dec.
LoopResultSummary dec -&gt; Maybe (DesiredUpdate dec, VName, dec)
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#relatedUpdate"><span class="hs-identifier hs-var hs-var">relatedUpdate</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#DesiredUpdate"><span class="hs-identifier hs-type">DesiredUpdate</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684427433"><span class="hs-identifier hs-type">dec</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621684427433"><span class="hs-identifier hs-type">dec</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-336"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-337"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684426747"><span id="local-6989586621684426749"><span id="local-6989586621684426763"><span class="annot"><span class="annottext">Int -&gt; LoopResultSummary dec -&gt; ShowS
[LoopResultSummary dec] -&gt; ShowS
LoopResultSummary dec -&gt; String
(Int -&gt; LoopResultSummary dec -&gt; ShowS)
-&gt; (LoopResultSummary dec -&gt; String)
-&gt; ([LoopResultSummary dec] -&gt; ShowS)
-&gt; Show (LoopResultSummary dec)
forall dec. Show dec =&gt; Int -&gt; LoopResultSummary dec -&gt; ShowS
forall dec. Show dec =&gt; [LoopResultSummary dec] -&gt; ShowS
forall dec. Show dec =&gt; LoopResultSummary dec -&gt; String
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [LoopResultSummary dec] -&gt; ShowS
$cshowList :: forall dec. Show dec =&gt; [LoopResultSummary dec] -&gt; ShowS
show :: LoopResultSummary dec -&gt; String
$cshow :: forall dec. Show dec =&gt; LoopResultSummary dec -&gt; String
showsPrec :: Int -&gt; LoopResultSummary dec -&gt; ShowS
$cshowsPrec :: forall dec. Show dec =&gt; Int -&gt; LoopResultSummary dec -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-338"></span><span>
</span><span id="line-339"></span><span id="local-6989586621684427470"><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#indexSubstitutions"><span class="hs-identifier hs-type">indexSubstitutions</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Types.html#Typed"><span class="hs-identifier hs-type">Typed</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684427470"><span class="hs-identifier hs-type">dec</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#LoopResultSummary"><span class="hs-identifier hs-type">LoopResultSummary</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684427470"><span class="hs-identifier hs-type">dec</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.SubstituteIndices.html#IndexSubstitutions"><span class="hs-identifier hs-type">IndexSubstitutions</span></a></span></span><span>
</span><span id="line-340"></span><span id="indexSubstitutions"><span class="annot"><span class="annottext">indexSubstitutions :: forall dec.
Typed dec =&gt;
[LoopResultSummary dec] -&gt; IndexSubstitutions
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#indexSubstitutions"><span class="hs-identifier hs-var hs-var">indexSubstitutions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(LoopResultSummary dec
 -&gt; Maybe (VName, (Certs, VName, Type, Slice SubExp)))
-&gt; [LoopResultSummary dec] -&gt; IndexSubstitutions
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">mapMaybe</span></span><span> </span><span class="annot"><span class="annottext">LoopResultSummary dec
-&gt; Maybe (VName, (Certs, VName, Type, Slice SubExp))
forall {t}.
Typed t =&gt;
LoopResultSummary t
-&gt; Maybe (VName, (Certs, VName, Type, Slice SubExp))
</span><a href="#local-6989586621684426733"><span class="hs-identifier hs-var">getSubstitution</span></a></span><span>
</span><span id="line-341"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-342"></span><span>    </span><span id="local-6989586621684426733"><span class="annot"><span class="annottext">getSubstitution :: LoopResultSummary t
-&gt; Maybe (VName, (Certs, VName, Type, Slice SubExp))
</span><a href="#local-6989586621684426733"><span class="hs-identifier hs-var hs-var">getSubstitution</span></a></span></span><span> </span><span id="local-6989586621684426728"><span class="annot"><span class="annottext">LoopResultSummary t
</span><a href="#local-6989586621684426728"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-343"></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#DesiredUpdate"><span class="hs-identifier hs-type">DesiredUpdate</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">t
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684426727"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684426727"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684426726"><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684426726"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684426725"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684426725"><span class="hs-identifier hs-var">nm</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684426724"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621684426724"><span class="hs-identifier hs-var">dec</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LoopResultSummary t -&gt; Maybe (DesiredUpdate t, VName, t)
forall dec.
LoopResultSummary dec -&gt; Maybe (DesiredUpdate dec, VName, dec)
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#relatedUpdate"><span class="hs-identifier hs-var hs-var">relatedUpdate</span></a></span><span> </span><span class="annot"><span class="annottext">LoopResultSummary t
</span><a href="#local-6989586621684426728"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-344"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684426723"><span class="annot"><span class="annottext">name :: VName
</span><a href="#local-6989586621684426723"><span class="hs-identifier hs-var hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Param DeclType -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">(Param DeclType -&gt; VName) -&gt; Param DeclType -&gt; VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Param DeclType, SubExp) -&gt; Param DeclType
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">((Param DeclType, SubExp) -&gt; Param DeclType)
-&gt; (Param DeclType, SubExp) -&gt; Param DeclType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LoopResultSummary t -&gt; (Param DeclType, SubExp)
forall dec. LoopResultSummary dec -&gt; (Param DeclType, SubExp)
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#mergeParam"><span class="hs-identifier hs-var hs-var">mergeParam</span></a></span><span> </span><span class="annot"><span class="annottext">LoopResultSummary t
</span><a href="#local-6989586621684426728"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-345"></span><span>      </span><span class="annot"><span class="annottext">(VName, (Certs, VName, Type, Slice SubExp))
-&gt; Maybe (VName, (Certs, VName, Type, Slice SubExp))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684426723"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684426727"><span class="hs-identifier hs-var">cs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684426725"><span class="hs-identifier hs-var">nm</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">t -&gt; Type
forall t. Typed t =&gt; t -&gt; Type
</span><a href="Futhark.IR.Prop.Types.html#typeOf"><span class="hs-identifier hs-var">typeOf</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621684426724"><span class="hs-identifier hs-var">dec</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684426726"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-346"></span><span>
</span><span id="line-347"></span><span id="local-6989586621684427464"><span id="local-6989586621684427465"><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#manipulateResult"><span class="hs-identifier hs-type">manipulateResult</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-348"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Builder.Class.html#Buildable"><span class="hs-identifier hs-type">Buildable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684427465"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.MonadFreshNames.html#MonadFreshNames"><span class="hs-identifier hs-type">MonadFreshNames</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684427464"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-349"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#LoopResultSummary"><span class="hs-identifier hs-type">LoopResultSummary</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#LetDec"><span class="hs-identifier hs-type">LetDec</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684427465"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-350"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.SubstituteIndices.html#IndexSubstitutions"><span class="hs-identifier hs-type">IndexSubstitutions</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-351"></span><span>  </span><span class="annot"><a href="#local-6989586621684427464"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Result"><span class="hs-identifier hs-type">Result</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684427465"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-352"></span><span id="manipulateResult"><span class="annot"><span class="annottext">manipulateResult :: forall rep (m :: * -&gt; *).
(Buildable rep, MonadFreshNames m) =&gt;
[LoopResultSummary (LetDec rep)]
-&gt; IndexSubstitutions -&gt; m (Result, Stms rep)
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#manipulateResult"><span class="hs-identifier hs-var hs-var">manipulateResult</span></a></span></span><span> </span><span id="local-6989586621684426700"><span class="annot"><span class="annottext">[LoopResultSummary (LetDec rep)]
</span><a href="#local-6989586621684426700"><span class="hs-identifier hs-var">summaries</span></a></span></span><span> </span><span id="local-6989586621684426699"><span class="annot"><span class="annottext">IndexSubstitutions
</span><a href="#local-6989586621684426699"><span class="hs-identifier hs-var">substs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-353"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684426698"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684426698"><span class="hs-identifier hs-var">orig_ses</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684426697"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684426697"><span class="hs-identifier hs-var">updated_ses</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Either SubExpRes SubExpRes] -&gt; (Result, Result)
forall a b. [Either a b] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">partitionEithers</span></span><span> </span><span class="annot"><span class="annottext">([Either SubExpRes SubExpRes] -&gt; (Result, Result))
-&gt; [Either SubExpRes SubExpRes] -&gt; (Result, Result)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(LoopResultSummary (LetDec rep) -&gt; Either SubExpRes SubExpRes)
-&gt; [LoopResultSummary (LetDec rep)] -&gt; [Either SubExpRes SubExpRes]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">LoopResultSummary (LetDec rep) -&gt; Either SubExpRes SubExpRes
forall {dec}. LoopResultSummary dec -&gt; Either SubExpRes SubExpRes
</span><a href="#local-6989586621684426696"><span class="hs-identifier hs-var">unchangedRes</span></a></span><span> </span><span class="annot"><span class="annottext">[LoopResultSummary (LetDec rep)]
</span><a href="#local-6989586621684426700"><span class="hs-identifier hs-var">summaries</span></a></span><span>
</span><span id="line-354"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684426695"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684426695"><span class="hs-identifier hs-var">subst_ses</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684426694"><span class="annot"><span class="annottext">[Stm rep]
</span><a href="#local-6989586621684426694"><span class="hs-identifier hs-var">res_stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">WriterT [Stm rep] m Result -&gt; m (Result, [Stm rep])
forall w (m :: * -&gt; *) a. WriterT w m a -&gt; m (a, w)
</span><span class="hs-identifier hs-var hs-var">runWriterT</span></span><span> </span><span class="annot"><span class="annottext">(WriterT [Stm rep] m Result -&gt; m (Result, [Stm rep]))
-&gt; WriterT [Stm rep] m Result -&gt; m (Result, [Stm rep])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExpRes
 -&gt; (VName, (Certs, VName, Type, Slice SubExp))
 -&gt; WriterT [Stm rep] m SubExpRes)
-&gt; Result -&gt; IndexSubstitutions -&gt; WriterT [Stm rep] m Result
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m [c]
</span><span class="hs-identifier hs-var">zipWithM</span></span><span> </span><span class="annot"><span class="annottext">SubExpRes
-&gt; (VName, (Certs, VName, Type, Slice SubExp))
-&gt; WriterT [Stm rep] m SubExpRes
forall {f :: * -&gt; *} {rep} {t}.
(MonadFreshNames f, MonadWriter [Stm rep] f, Buildable rep,
 Typed t) =&gt;
SubExpRes
-&gt; (VName, (Certs, VName, t, Slice SubExp)) -&gt; f SubExpRes
</span><a href="#local-6989586621684426693"><span class="hs-identifier hs-var">substRes</span></a></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684426697"><span class="hs-identifier hs-var">updated_ses</span></a></span><span> </span><span class="annot"><span class="annottext">IndexSubstitutions
</span><a href="#local-6989586621684426699"><span class="hs-identifier hs-var">substs</span></a></span><span>
</span><span id="line-355"></span><span>  </span><span class="annot"><span class="annottext">(Result, Stms rep) -&gt; m (Result, Stms rep)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684426698"><span class="hs-identifier hs-var">orig_ses</span></a></span><span> </span><span class="annot"><span class="annottext">Result -&gt; Result -&gt; Result
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684426695"><span class="hs-identifier hs-var">subst_ses</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Stm rep] -&gt; Stms rep
forall rep. [Stm rep] -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#stmsFromList"><span class="hs-identifier hs-var">stmsFromList</span></a></span><span> </span><span class="annot"><span class="annottext">[Stm rep]
</span><a href="#local-6989586621684426694"><span class="hs-identifier hs-var">res_stms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-356"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-357"></span><span>    </span><span id="local-6989586621684426696"><span class="annot"><span class="annottext">unchangedRes :: LoopResultSummary dec -&gt; Either SubExpRes SubExpRes
</span><a href="#local-6989586621684426696"><span class="hs-identifier hs-var hs-var">unchangedRes</span></a></span></span><span> </span><span id="local-6989586621684426692"><span class="annot"><span class="annottext">LoopResultSummary dec
</span><a href="#local-6989586621684426692"><span class="hs-identifier hs-var">summary</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-358"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">LoopResultSummary dec -&gt; Maybe (DesiredUpdate dec, VName, dec)
forall dec.
LoopResultSummary dec -&gt; Maybe (DesiredUpdate dec, VName, dec)
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#relatedUpdate"><span class="hs-identifier hs-var hs-var">relatedUpdate</span></a></span><span> </span><span class="annot"><span class="annottext">LoopResultSummary dec
</span><a href="#local-6989586621684426692"><span class="hs-identifier hs-var">summary</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-359"></span><span>        </span><span class="annot"><span class="annottext">Maybe (DesiredUpdate dec, VName, dec)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SubExpRes -&gt; Either SubExpRes SubExpRes
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">(SubExpRes -&gt; Either SubExpRes SubExpRes)
-&gt; SubExpRes -&gt; Either SubExpRes SubExpRes
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LoopResultSummary dec -&gt; SubExpRes
forall dec. LoopResultSummary dec -&gt; SubExpRes
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#resultSubExp"><span class="hs-identifier hs-var hs-var">resultSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">LoopResultSummary dec
</span><a href="#local-6989586621684426692"><span class="hs-identifier hs-var">summary</span></a></span><span>
</span><span id="line-360"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">(DesiredUpdate dec, VName, dec)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SubExpRes -&gt; Either SubExpRes SubExpRes
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">(SubExpRes -&gt; Either SubExpRes SubExpRes)
-&gt; SubExpRes -&gt; Either SubExpRes SubExpRes
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LoopResultSummary dec -&gt; SubExpRes
forall dec. LoopResultSummary dec -&gt; SubExpRes
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#resultSubExp"><span class="hs-identifier hs-var hs-var">resultSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">LoopResultSummary dec
</span><a href="#local-6989586621684426692"><span class="hs-identifier hs-var">summary</span></a></span><span>
</span><span id="line-361"></span><span>    </span><span id="local-6989586621684426693"><span class="annot"><span class="annottext">substRes :: SubExpRes
-&gt; (VName, (Certs, VName, t, Slice SubExp)) -&gt; f SubExpRes
</span><a href="#local-6989586621684426693"><span class="hs-identifier hs-var hs-var">substRes</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-type">SubExpRes</span></a></span><span> </span><span id="local-6989586621684426673"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684426673"><span class="hs-identifier hs-var">res_cs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684426672"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684426672"><span class="hs-identifier hs-var">res_v</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684426671"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684426671"><span class="hs-identifier hs-var">subst_v</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Certs
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684426670"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684426670"><span class="hs-identifier hs-var">nm</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">t
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-362"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684426672"><span class="hs-identifier hs-var">res_v</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; VName -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684426671"><span class="hs-identifier hs-var">subst_v</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-363"></span><span>        </span><span class="annot"><span class="annottext">SubExpRes -&gt; f SubExpRes
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(SubExpRes -&gt; f SubExpRes) -&gt; SubExpRes -&gt; f SubExpRes
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Certs -&gt; SubExp -&gt; SubExpRes
</span><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-var">SubExpRes</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684426673"><span class="hs-identifier hs-var">res_cs</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; SubExpRes) -&gt; SubExp -&gt; SubExpRes
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684426670"><span class="hs-identifier hs-var">nm</span></a></span><span>
</span><span id="line-364"></span><span>    </span><span class="annot"><a href="#local-6989586621684426693"><span class="hs-identifier hs-var">substRes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-type">SubExpRes</span></a></span><span> </span><span id="local-6989586621684426669"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684426669"><span class="hs-identifier hs-var">res_cs</span></a></span></span><span> </span><span id="local-6989586621684426668"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684426668"><span class="hs-identifier hs-var">res_se</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684426667"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684426667"><span class="hs-identifier hs-var">cs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684426666"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684426666"><span class="hs-identifier hs-var">nm</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684426665"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621684426665"><span class="hs-identifier hs-var">dec</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-type">Slice</span></a></span><span> </span><span id="local-6989586621684426664"><span class="annot"><span class="annottext">[DimIndex SubExp]
</span><a href="#local-6989586621684426664"><span class="hs-identifier hs-var">is</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-365"></span><span>      </span><span id="local-6989586621684426663"><span class="annot"><span class="annottext">Ident
</span><a href="#local-6989586621684426663"><span class="hs-identifier hs-var">v'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ShowS -&gt; Ident -&gt; f Ident
forall (m :: * -&gt; *).
MonadFreshNames m =&gt;
ShowS -&gt; Ident -&gt; m Ident
</span><a href="Futhark.MonadFreshNames.html#newIdent%27"><span class="hs-identifier hs-var">newIdent'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_updated&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Ident -&gt; f Ident) -&gt; Ident -&gt; f Ident
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Type -&gt; Ident
</span><a href="Futhark.IR.Syntax.Core.html#Ident"><span class="hs-identifier hs-var">Ident</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684426666"><span class="hs-identifier hs-var">nm</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Ident) -&gt; Type -&gt; Ident
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">t -&gt; Type
forall t. Typed t =&gt; t -&gt; Type
</span><a href="Futhark.IR.Prop.Types.html#typeOf"><span class="hs-identifier hs-var">typeOf</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621684426665"><span class="hs-identifier hs-var">dec</span></a></span><span>
</span><span id="line-366"></span><span>      </span><span class="annot"><span class="annottext">[Stm rep] -&gt; f ()
forall w (m :: * -&gt; *). MonadWriter w m =&gt; w -&gt; m ()
</span><span class="hs-identifier hs-var">tell</span></span><span>
</span><span id="line-367"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Certs -&gt; Stm rep -&gt; Stm rep
forall rep. Certs -&gt; Stm rep -&gt; Stm rep
</span><a href="Futhark.IR.Prop.html#certify"><span class="hs-identifier hs-var">certify</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684426669"><span class="hs-identifier hs-var">res_cs</span></a></span><span> </span><span class="annot"><span class="annottext">Certs -&gt; Certs -&gt; Certs
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684426667"><span class="hs-identifier hs-var">cs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Stm rep -&gt; Stm rep) -&gt; (BasicOp -&gt; Stm rep) -&gt; BasicOp -&gt; Stm rep
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[Ident] -&gt; Exp rep -&gt; Stm rep
forall rep. Buildable rep =&gt; [Ident] -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.Builder.Class.html#mkLet"><span class="hs-identifier hs-var">mkLet</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Ident
</span><a href="#local-6989586621684426663"><span class="hs-identifier hs-var">v'</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(Exp rep -&gt; Stm rep) -&gt; (BasicOp -&gt; Exp rep) -&gt; BasicOp -&gt; Stm rep
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; Exp rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; Stm rep) -&gt; BasicOp -&gt; Stm rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-368"></span><span>            </span><span class="annot"><span class="annottext">Safety -&gt; VName -&gt; Slice SubExp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Update"><span class="hs-identifier hs-var">Update</span></a></span><span> </span><span class="annot"><span class="annottext">Safety
</span><a href="Futhark.IR.Primitive.html#Unsafe"><span class="hs-identifier hs-var">Unsafe</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684426666"><span class="hs-identifier hs-var">nm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; [DimIndex SubExp] -&gt; Slice SubExp
</span><a href="Futhark.Construct.html#fullSlice"><span class="hs-identifier hs-var">fullSlice</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">t -&gt; Type
forall t. Typed t =&gt; t -&gt; Type
</span><a href="Futhark.IR.Prop.Types.html#typeOf"><span class="hs-identifier hs-var">typeOf</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621684426665"><span class="hs-identifier hs-var">dec</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DimIndex SubExp]
</span><a href="#local-6989586621684426664"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684426668"><span class="hs-identifier hs-var">res_se</span></a></span><span>
</span><span id="line-369"></span><span>        </span><span class="hs-special">]</span><span>
</span><span id="line-370"></span><span>      </span><span class="annot"><span class="annottext">SubExpRes -&gt; f SubExpRes
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(SubExpRes -&gt; f SubExpRes) -&gt; SubExpRes -&gt; f SubExpRes
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExpRes
</span><a href="Futhark.IR.Syntax.html#varRes"><span class="hs-identifier hs-var">varRes</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SubExpRes) -&gt; VName -&gt; SubExpRes
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Ident -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#identName"><span class="hs-identifier hs-var hs-var">identName</span></a></span><span> </span><span class="annot"><span class="annottext">Ident
</span><a href="#local-6989586621684426663"><span class="hs-identifier hs-var">v'</span></a></span><span>
</span><span id="line-371"></span></pre></body></html>