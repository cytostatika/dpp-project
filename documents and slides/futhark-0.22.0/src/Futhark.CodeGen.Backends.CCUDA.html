<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE QuasiQuotes #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE TupleSections #-}</span><span>
</span><span id="line-4"></span><span>
</span><span id="line-5"></span><span class="hs-comment">-- | Code generation for CUDA.</span><span>
</span><span id="line-6"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Futhark.CodeGen.Backends.CCUDA</span><span>
</span><span id="line-7"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.CodeGen.Backends.CCUDA.html#compileProg"><span class="hs-identifier">compileProg</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-8"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.Backends.GenericC.html#CParts"><span class="hs-identifier">GC.CParts</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-9"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.Backends.GenericC.html#asLibrary"><span class="hs-identifier">GC.asLibrary</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-10"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.Backends.GenericC.html#asExecutable"><span class="hs-identifier">GC.asExecutable</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-11"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.Backends.GenericC.html#asServer"><span class="hs-identifier">GC.asServer</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-12"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-13"></span><span class="hs-keyword">where</span><span>
</span><span id="line-14"></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">catMaybes</span></span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">T</span></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.CodeGen.Backends.CCUDA.Boilerplate.html"><span class="hs-identifier">Futhark.CodeGen.Backends.CCUDA.Boilerplate</span></a></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.CodeGen.Backends.COpenCL.Boilerplate.html"><span class="hs-identifier">Futhark.CodeGen.Backends.COpenCL.Boilerplate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.Backends.COpenCL.Boilerplate.html#commonOptions"><span class="hs-identifier">commonOptions</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.CodeGen.Backends.COpenCL.Boilerplate.html#sizeLoggingCode"><span class="hs-identifier">sizeLoggingCode</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.CodeGen.Backends.GenericC.html"><span class="hs-identifier">Futhark.CodeGen.Backends.GenericC</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">GC</span></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.CodeGen.Backends.GenericC.Options.html"><span class="hs-identifier">Futhark.CodeGen.Backends.GenericC.Options</span></a></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.CodeGen.Backends.SimpleRep.html"><span class="hs-identifier">Futhark.CodeGen.Backends.SimpleRep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.Backends.SimpleRep.html#primStorageType"><span class="hs-identifier">primStorageType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.CodeGen.Backends.SimpleRep.html#toStorage"><span class="hs-identifier">toStorage</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.OpenCL.html"><span class="hs-identifier">Futhark.CodeGen.ImpCode.OpenCL</span></a></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.CUDA.html"><span class="hs-identifier">Futhark.CodeGen.ImpGen.CUDA</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">ImpGen</span></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html"><span class="hs-identifier">Futhark.IR.GPUMem</span></a></span><span> </span><span class="hs-keyword">hiding</span><span>
</span><span id="line-26"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.IR.GPU.Op.html#CmpSizeLe"><span class="hs-identifier">CmpSizeLe</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-27"></span><span>    </span><span class="annot"><a href="Futhark.IR.GPU.Op.html#GetSize"><span class="hs-identifier">GetSize</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-28"></span><span>    </span><span class="annot"><a href="Futhark.IR.GPU.Op.html#GetSizeMax"><span class="hs-identifier">GetSizeMax</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-29"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.MonadFreshNames.html"><span class="hs-identifier">Futhark.MonadFreshNames</span></a></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Language.C.Quote.OpenCL</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">C</span></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">NeatInterpolation</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">untrimming</span></span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span>
</span><span id="line-34"></span><span class="hs-comment">-- | Compile the program to C with calls to CUDA.</span><span>
</span><span id="line-35"></span><span id="local-6989586621684547571"><span class="annot"><a href="Futhark.CodeGen.Backends.CCUDA.html#compileProg"><span class="hs-identifier hs-type">compileProg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.MonadFreshNames.html#MonadFreshNames"><span class="hs-identifier hs-type">MonadFreshNames</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684547571"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Prog"><span class="hs-identifier hs-type">Prog</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684547571"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Warnings.html#Warnings"><span class="hs-identifier hs-type">ImpGen.Warnings</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.CodeGen.Backends.GenericC.html#CParts"><span class="hs-identifier hs-type">GC.CParts</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-36"></span><span id="compileProg"><span class="annot"><span class="annottext">compileProg :: forall (m :: * -&gt; *).
MonadFreshNames m =&gt;
Text -&gt; Prog GPUMem -&gt; m (Warnings, CParts)
</span><a href="Futhark.CodeGen.Backends.CCUDA.html#compileProg"><span class="hs-identifier hs-var hs-var">compileProg</span></a></span></span><span> </span><span id="local-6989586621684547197"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621684547197"><span class="hs-identifier hs-var">version</span></a></span></span><span> </span><span id="local-6989586621684547196"><span class="annot"><span class="annottext">Prog GPUMem
</span><a href="#local-6989586621684547196"><span class="hs-identifier hs-var">prog</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-37"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684547195"><span class="annot"><span class="annottext">Warnings
</span><a href="#local-6989586621684547195"><span class="hs-identifier hs-var">ws</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.OpenCL.html#Program"><span class="hs-identifier hs-type">Program</span></a></span><span> </span><span id="local-6989586621684547193"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621684547193"><span class="hs-identifier hs-var">cuda_code</span></a></span></span><span> </span><span id="local-6989586621684547192"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621684547192"><span class="hs-identifier hs-var">cuda_prelude</span></a></span></span><span> </span><span id="local-6989586621684547191"><span class="annot"><span class="annottext">Map Name KernelSafety
</span><a href="#local-6989586621684547191"><span class="hs-identifier hs-var">kernels</span></a></span></span><span> </span><span class="annot"><span class="annottext">[PrimType]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684547190"><span class="annot"><span class="annottext">Map Name SizeClass
</span><a href="#local-6989586621684547190"><span class="hs-identifier hs-var">sizes</span></a></span></span><span> </span><span id="local-6989586621684547189"><span class="annot"><span class="annottext">[FailureMsg]
</span><a href="#local-6989586621684547189"><span class="hs-identifier hs-var">failures</span></a></span></span><span> </span><span id="local-6989586621684547188"><span class="annot"><span class="annottext">Definitions OpenCL
</span><a href="#local-6989586621684547188"><span class="hs-identifier hs-var">prog'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-38"></span><span>    </span><span class="annot"><span class="annottext">Prog GPUMem -&gt; m (Warnings, Program)
forall (m :: * -&gt; *).
MonadFreshNames m =&gt;
Prog GPUMem -&gt; m (Warnings, Program)
</span><a href="Futhark.CodeGen.ImpGen.CUDA.html#compileProg"><span class="hs-identifier hs-var">ImpGen.compileProg</span></a></span><span> </span><span class="annot"><span class="annottext">Prog GPUMem
</span><a href="#local-6989586621684547196"><span class="hs-identifier hs-var">prog</span></a></span><span>
</span><span id="line-39"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684547186"><span class="annot"><span class="annottext">cost_centres :: [Name]
</span><a href="#local-6989586621684547186"><span class="hs-identifier hs-var hs-var">cost_centres</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-40"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="Futhark.CodeGen.Backends.COpenCL.Boilerplate.html#copyDevToDev"><span class="hs-identifier hs-var">copyDevToDev</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-41"></span><span>          </span><span class="annot"><span class="annottext">Name
</span><a href="Futhark.CodeGen.Backends.COpenCL.Boilerplate.html#copyDevToHost"><span class="hs-identifier hs-var">copyDevToHost</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-42"></span><span>          </span><span class="annot"><span class="annottext">Name
</span><a href="Futhark.CodeGen.Backends.COpenCL.Boilerplate.html#copyHostToDev"><span class="hs-identifier hs-var">copyHostToDev</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-43"></span><span>          </span><span class="annot"><span class="annottext">Name
</span><a href="Futhark.CodeGen.Backends.COpenCL.Boilerplate.html#copyScalarToDev"><span class="hs-identifier hs-var">copyScalarToDev</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-44"></span><span>          </span><span class="annot"><span class="annottext">Name
</span><a href="Futhark.CodeGen.Backends.COpenCL.Boilerplate.html#copyScalarFromDev"><span class="hs-identifier hs-var">copyScalarFromDev</span></a></span><span>
</span><span id="line-45"></span><span>        </span><span class="hs-special">]</span><span>
</span><span id="line-46"></span><span>      </span><span id="local-6989586621684547180"><span class="annot"><span class="annottext">extra :: CompilerM OpenCL () ()
</span><a href="#local-6989586621684547180"><span class="hs-identifier hs-var hs-var">extra</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-47"></span><span>        </span><span class="annot"><span class="annottext">Text
-&gt; Text
-&gt; [Name]
-&gt; Map Name KernelSafety
-&gt; Map Name SizeClass
-&gt; [FailureMsg]
-&gt; CompilerM OpenCL () ()
</span><a href="Futhark.CodeGen.Backends.CCUDA.Boilerplate.html#generateBoilerplate"><span class="hs-identifier hs-var">generateBoilerplate</span></a></span><span>
</span><span id="line-48"></span><span>          </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621684547193"><span class="hs-identifier hs-var">cuda_code</span></a></span><span>
</span><span id="line-49"></span><span>          </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621684547192"><span class="hs-identifier hs-var">cuda_prelude</span></a></span><span>
</span><span id="line-50"></span><span>          </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621684547186"><span class="hs-identifier hs-var">cost_centres</span></a></span><span>
</span><span id="line-51"></span><span>          </span><span class="annot"><span class="annottext">Map Name KernelSafety
</span><a href="#local-6989586621684547191"><span class="hs-identifier hs-var">kernels</span></a></span><span>
</span><span id="line-52"></span><span>          </span><span class="annot"><span class="annottext">Map Name SizeClass
</span><a href="#local-6989586621684547190"><span class="hs-identifier hs-var">sizes</span></a></span><span>
</span><span id="line-53"></span><span>          </span><span class="annot"><span class="annottext">[FailureMsg]
</span><a href="#local-6989586621684547189"><span class="hs-identifier hs-var">failures</span></a></span><span>
</span><span id="line-54"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Warnings
</span><a href="#local-6989586621684547195"><span class="hs-identifier hs-var">ws</span></a></span><span class="hs-special">,</span><span class="hs-special">)</span><span>
</span><span id="line-55"></span><span>    </span><span class="annot"><span class="annottext">(CParts -&gt; (Warnings, CParts)) -&gt; m CParts -&gt; m (Warnings, CParts)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
-&gt; Text
-&gt; Operations OpenCL ()
-&gt; CompilerM OpenCL () ()
-&gt; Text
-&gt; [Space]
-&gt; [Option]
-&gt; Definitions OpenCL
-&gt; m CParts
forall (m :: * -&gt; *) op.
MonadFreshNames m =&gt;
Text
-&gt; Text
-&gt; Operations op ()
-&gt; CompilerM op () ()
-&gt; Text
-&gt; [Space]
-&gt; [Option]
-&gt; Definitions op
-&gt; m CParts
</span><a href="Futhark.CodeGen.Backends.GenericC.html#compileProg"><span class="hs-identifier hs-var">GC.compileProg</span></a></span><span>
</span><span id="line-56"></span><span>      </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;cuda&quot;</span></span><span>
</span><span id="line-57"></span><span>      </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621684547197"><span class="hs-identifier hs-var">version</span></a></span><span>
</span><span id="line-58"></span><span>      </span><span class="annot"><span class="annottext">Operations OpenCL ()
</span><a href="#local-6989586621684547176"><span class="hs-identifier hs-var">operations</span></a></span><span>
</span><span id="line-59"></span><span>      </span><span class="annot"><span class="annottext">CompilerM OpenCL () ()
</span><a href="#local-6989586621684547180"><span class="hs-identifier hs-var">extra</span></a></span><span>
</span><span id="line-60"></span><span>      </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621684547175"><span class="hs-identifier hs-var">cuda_includes</span></a></span><span>
</span><span id="line-61"></span><span>      </span><span class="hs-special">[</span><span class="annot"><span class="annottext">[Char] -&gt; Space
</span><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-var">Space</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;device&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="Futhark.IR.Syntax.Core.html#DefaultSpace"><span class="hs-identifier hs-var">DefaultSpace</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-62"></span><span>      </span><span class="annot"><span class="annottext">[Option]
</span><a href="Futhark.CodeGen.Backends.CCUDA.html#cliOptions"><span class="hs-identifier hs-var">cliOptions</span></a></span><span>
</span><span id="line-63"></span><span>      </span><span class="annot"><span class="annottext">Definitions OpenCL
</span><a href="#local-6989586621684547188"><span class="hs-identifier hs-var">prog'</span></a></span><span>
</span><span id="line-64"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-65"></span><span>    </span><span class="annot"><a href="#local-6989586621684547176"><span class="hs-identifier hs-type">operations</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.Backends.GenericC.html#Operations"><span class="hs-identifier hs-type">GC.Operations</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.OpenCL.html#OpenCL"><span class="hs-identifier hs-type">OpenCL</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-66"></span><span>    </span><span id="local-6989586621684547176"><span class="annot"><span class="annottext">operations :: Operations OpenCL ()
</span><a href="#local-6989586621684547176"><span class="hs-identifier hs-var hs-var">operations</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-67"></span><span>      </span><span class="annot"><span class="annottext">Operations OpenCL ()
forall op s. Operations op s
</span><a href="Futhark.CodeGen.Backends.GenericC.html#defaultOperations"><span class="hs-identifier hs-var">GC.defaultOperations</span></a></span><span>
</span><span id="line-68"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">opsWriteScalar :: WriteScalar OpenCL ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#opsWriteScalar"><span class="hs-identifier hs-var">GC.opsWriteScalar</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WriteScalar OpenCL ()
</span><a href="Futhark.CodeGen.Backends.CCUDA.html#writeCUDAScalar"><span class="hs-identifier hs-var">writeCUDAScalar</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-69"></span><span>          </span><span class="annot"><span class="annottext">opsReadScalar :: ReadScalar OpenCL ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#opsReadScalar"><span class="hs-identifier hs-var">GC.opsReadScalar</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ReadScalar OpenCL ()
</span><a href="Futhark.CodeGen.Backends.CCUDA.html#readCUDAScalar"><span class="hs-identifier hs-var">readCUDAScalar</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-70"></span><span>          </span><span class="annot"><span class="annottext">opsAllocate :: Allocate OpenCL ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#opsAllocate"><span class="hs-identifier hs-var">GC.opsAllocate</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Allocate OpenCL ()
</span><a href="Futhark.CodeGen.Backends.CCUDA.html#allocateCUDABuffer"><span class="hs-identifier hs-var">allocateCUDABuffer</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-71"></span><span>          </span><span class="annot"><span class="annottext">opsDeallocate :: Deallocate OpenCL ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#opsDeallocate"><span class="hs-identifier hs-var">GC.opsDeallocate</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Deallocate OpenCL ()
</span><a href="Futhark.CodeGen.Backends.CCUDA.html#deallocateCUDABuffer"><span class="hs-identifier hs-var">deallocateCUDABuffer</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-72"></span><span>          </span><span class="annot"><span class="annottext">opsCopy :: Copy OpenCL ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#opsCopy"><span class="hs-identifier hs-var">GC.opsCopy</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Copy OpenCL ()
</span><a href="Futhark.CodeGen.Backends.CCUDA.html#copyCUDAMemory"><span class="hs-identifier hs-var">copyCUDAMemory</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-73"></span><span>          </span><span class="annot"><span class="annottext">opsStaticArray :: StaticArray OpenCL ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#opsStaticArray"><span class="hs-identifier hs-var">GC.opsStaticArray</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StaticArray OpenCL ()
</span><a href="Futhark.CodeGen.Backends.CCUDA.html#staticCUDAArray"><span class="hs-identifier hs-var">staticCUDAArray</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-74"></span><span>          </span><span class="annot"><span class="annottext">opsMemoryType :: MemoryType OpenCL ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#opsMemoryType"><span class="hs-identifier hs-var">GC.opsMemoryType</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MemoryType OpenCL ()
</span><a href="Futhark.CodeGen.Backends.CCUDA.html#cudaMemoryType"><span class="hs-identifier hs-var">cudaMemoryType</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-75"></span><span>          </span><span class="annot"><span class="annottext">opsCompiler :: OpCompiler OpenCL ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#opsCompiler"><span class="hs-identifier hs-var">GC.opsCompiler</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OpCompiler OpenCL ()
</span><a href="Futhark.CodeGen.Backends.CCUDA.html#callKernel"><span class="hs-identifier hs-var">callKernel</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-76"></span><span>          </span><span class="annot"><span class="annottext">opsFatMemory :: Bool
</span><a href="Futhark.CodeGen.Backends.GenericC.html#opsFatMemory"><span class="hs-identifier hs-var">GC.opsFatMemory</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span>
</span><span id="line-77"></span><span>          </span><span class="annot"><span class="annottext">opsCritical :: ([BlockItem], [BlockItem])
</span><a href="Futhark.CodeGen.Backends.GenericC.html#opsCritical"><span class="hs-identifier hs-var">GC.opsCritical</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-78"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="">[C.citems|CUDA_SUCCEED_FATAL(cuCtxPushCurrent(ctx-&gt;cuda.cu_ctx));|]</span></span><span class="hs-special">,</span><span>
</span><span id="line-79"></span><span>              </span><span class="annot"><span class="">[C.citems|CUDA_SUCCEED_FATAL(cuCtxPopCurrent(&amp;ctx-&gt;cuda.cu_ctx));|]</span></span><span>
</span><span id="line-80"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-81"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-82"></span><span>    </span><span id="local-6989586621684547175"><span class="annot"><span class="annottext">cuda_includes :: Text
</span><a href="#local-6989586621684547175"><span class="hs-identifier hs-var hs-var">cuda_includes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-83"></span><span>      </span><span class="annot"><span class="">[untrimming|
       #include &lt;cuda.h&gt;
       #include &lt;cuda_runtime.h&gt;
       #include &lt;nvrtc.h&gt;
      |]</span></span><span>
</span><span id="line-88"></span><span>
</span><span id="line-89"></span><span class="annot"><a href="Futhark.CodeGen.Backends.CCUDA.html#cliOptions"><span class="hs-identifier hs-type">cliOptions</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.CodeGen.Backends.GenericC.Options.html#Option"><span class="hs-identifier hs-type">Option</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-90"></span><span id="cliOptions"><span class="annot"><span class="annottext">cliOptions :: [Option]
</span><a href="Futhark.CodeGen.Backends.CCUDA.html#cliOptions"><span class="hs-identifier hs-var hs-var">cliOptions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-91"></span><span>  </span><span class="annot"><span class="annottext">[Option]
</span><a href="Futhark.CodeGen.Backends.COpenCL.Boilerplate.html#commonOptions"><span class="hs-identifier hs-var">commonOptions</span></a></span><span>
</span><span id="line-92"></span><span>    </span><span class="annot"><span class="annottext">[Option] -&gt; [Option] -&gt; [Option]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Option :: [Char] -&gt; Maybe Char -&gt; OptionArgument -&gt; [Char] -&gt; Stm -&gt; Option
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#Option"><span class="hs-identifier hs-type">Option</span></a></span><span>
</span><span id="line-93"></span><span>           </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">optionLongName :: [Char]
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#optionLongName"><span class="hs-identifier hs-var">optionLongName</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;dump-cuda&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-94"></span><span>             </span><span class="annot"><span class="annottext">optionShortName :: Maybe Char
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#optionShortName"><span class="hs-identifier hs-var">optionShortName</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Char
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span>
</span><span id="line-95"></span><span>             </span><span class="annot"><span class="annottext">optionArgument :: OptionArgument
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#optionArgument"><span class="hs-identifier hs-var">optionArgument</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; OptionArgument
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#RequiredArgument"><span class="hs-identifier hs-var">RequiredArgument</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;FILE&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-96"></span><span>             </span><span class="annot"><span class="annottext">optionDescription :: [Char]
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#optionDescription"><span class="hs-identifier hs-var">optionDescription</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Dump the embedded CUDA kernels to the indicated file.&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-97"></span><span>             </span><span class="annot"><span class="annottext">optionAction :: Stm
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#optionAction"><span class="hs-identifier hs-var">optionAction</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-98"></span><span>               </span><span class="annot"><span class="">[C.cstm|{futhark_context_config_dump_program_to(cfg, optarg);
                                     entry_point = NULL;}|]</span></span><span>
</span><span id="line-100"></span><span>           </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><span id="line-101"></span><span>         </span><span class="annot"><span class="annottext">Option :: [Char] -&gt; Maybe Char -&gt; OptionArgument -&gt; [Char] -&gt; Stm -&gt; Option
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#Option"><span class="hs-identifier hs-type">Option</span></a></span><span>
</span><span id="line-102"></span><span>           </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">optionLongName :: [Char]
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#optionLongName"><span class="hs-identifier hs-var">optionLongName</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;load-cuda&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-103"></span><span>             </span><span class="annot"><span class="annottext">optionShortName :: Maybe Char
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#optionShortName"><span class="hs-identifier hs-var">optionShortName</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Char
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span>
</span><span id="line-104"></span><span>             </span><span class="annot"><span class="annottext">optionArgument :: OptionArgument
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#optionArgument"><span class="hs-identifier hs-var">optionArgument</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; OptionArgument
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#RequiredArgument"><span class="hs-identifier hs-var">RequiredArgument</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;FILE&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-105"></span><span>             </span><span class="annot"><span class="annottext">optionDescription :: [Char]
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#optionDescription"><span class="hs-identifier hs-var">optionDescription</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Instead of using the embedded CUDA kernels, load them from the indicated file.&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-106"></span><span>             </span><span class="annot"><span class="annottext">optionAction :: Stm
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#optionAction"><span class="hs-identifier hs-var">optionAction</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="">[C.cstm|futhark_context_config_load_program_from(cfg, optarg);|]</span></span><span>
</span><span id="line-107"></span><span>           </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><span id="line-108"></span><span>         </span><span class="annot"><span class="annottext">Option :: [Char] -&gt; Maybe Char -&gt; OptionArgument -&gt; [Char] -&gt; Stm -&gt; Option
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#Option"><span class="hs-identifier hs-type">Option</span></a></span><span>
</span><span id="line-109"></span><span>           </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">optionLongName :: [Char]
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#optionLongName"><span class="hs-identifier hs-var">optionLongName</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;dump-ptx&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-110"></span><span>             </span><span class="annot"><span class="annottext">optionShortName :: Maybe Char
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#optionShortName"><span class="hs-identifier hs-var">optionShortName</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Char
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span>
</span><span id="line-111"></span><span>             </span><span class="annot"><span class="annottext">optionArgument :: OptionArgument
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#optionArgument"><span class="hs-identifier hs-var">optionArgument</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; OptionArgument
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#RequiredArgument"><span class="hs-identifier hs-var">RequiredArgument</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;FILE&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-112"></span><span>             </span><span class="annot"><span class="annottext">optionDescription :: [Char]
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#optionDescription"><span class="hs-identifier hs-var">optionDescription</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Dump the PTX-compiled version of the embedded kernels to the indicated file.&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-113"></span><span>             </span><span class="annot"><span class="annottext">optionAction :: Stm
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#optionAction"><span class="hs-identifier hs-var">optionAction</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-114"></span><span>               </span><span class="annot"><span class="">[C.cstm|{futhark_context_config_dump_ptx_to(cfg, optarg);
                                     entry_point = NULL;}|]</span></span><span>
</span><span id="line-116"></span><span>           </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><span id="line-117"></span><span>         </span><span class="annot"><span class="annottext">Option :: [Char] -&gt; Maybe Char -&gt; OptionArgument -&gt; [Char] -&gt; Stm -&gt; Option
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#Option"><span class="hs-identifier hs-type">Option</span></a></span><span>
</span><span id="line-118"></span><span>           </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">optionLongName :: [Char]
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#optionLongName"><span class="hs-identifier hs-var">optionLongName</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;load-ptx&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-119"></span><span>             </span><span class="annot"><span class="annottext">optionShortName :: Maybe Char
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#optionShortName"><span class="hs-identifier hs-var">optionShortName</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Char
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span>
</span><span id="line-120"></span><span>             </span><span class="annot"><span class="annottext">optionArgument :: OptionArgument
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#optionArgument"><span class="hs-identifier hs-var">optionArgument</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; OptionArgument
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#RequiredArgument"><span class="hs-identifier hs-var">RequiredArgument</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;FILE&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-121"></span><span>             </span><span class="annot"><span class="annottext">optionDescription :: [Char]
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#optionDescription"><span class="hs-identifier hs-var">optionDescription</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Load PTX code from the indicated file.&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-122"></span><span>             </span><span class="annot"><span class="annottext">optionAction :: Stm
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#optionAction"><span class="hs-identifier hs-var">optionAction</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="">[C.cstm|futhark_context_config_load_ptx_from(cfg, optarg);|]</span></span><span>
</span><span id="line-123"></span><span>           </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><span id="line-124"></span><span>         </span><span class="annot"><span class="annottext">Option :: [Char] -&gt; Maybe Char -&gt; OptionArgument -&gt; [Char] -&gt; Stm -&gt; Option
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#Option"><span class="hs-identifier hs-type">Option</span></a></span><span>
</span><span id="line-125"></span><span>           </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">optionLongName :: [Char]
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#optionLongName"><span class="hs-identifier hs-var">optionLongName</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;nvrtc-option&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-126"></span><span>             </span><span class="annot"><span class="annottext">optionShortName :: Maybe Char
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#optionShortName"><span class="hs-identifier hs-var">optionShortName</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Char
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span>
</span><span id="line-127"></span><span>             </span><span class="annot"><span class="annottext">optionArgument :: OptionArgument
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#optionArgument"><span class="hs-identifier hs-var">optionArgument</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; OptionArgument
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#RequiredArgument"><span class="hs-identifier hs-var">RequiredArgument</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;OPT&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-128"></span><span>             </span><span class="annot"><span class="annottext">optionDescription :: [Char]
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#optionDescription"><span class="hs-identifier hs-var">optionDescription</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Add an additional build option to the string passed to NVRTC.&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-129"></span><span>             </span><span class="annot"><span class="annottext">optionAction :: Stm
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#optionAction"><span class="hs-identifier hs-var">optionAction</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="">[C.cstm|futhark_context_config_add_nvrtc_option(cfg, optarg);|]</span></span><span>
</span><span id="line-130"></span><span>           </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><span id="line-131"></span><span>         </span><span class="annot"><span class="annottext">Option :: [Char] -&gt; Maybe Char -&gt; OptionArgument -&gt; [Char] -&gt; Stm -&gt; Option
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#Option"><span class="hs-identifier hs-type">Option</span></a></span><span>
</span><span id="line-132"></span><span>           </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">optionLongName :: [Char]
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#optionLongName"><span class="hs-identifier hs-var">optionLongName</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;profile&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-133"></span><span>             </span><span class="annot"><span class="annottext">optionShortName :: Maybe Char
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#optionShortName"><span class="hs-identifier hs-var">optionShortName</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Char -&gt; Maybe Char
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'P'</span></span><span class="hs-special">,</span><span>
</span><span id="line-134"></span><span>             </span><span class="annot"><span class="annottext">optionArgument :: OptionArgument
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#optionArgument"><span class="hs-identifier hs-var">optionArgument</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OptionArgument
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#NoArgument"><span class="hs-identifier hs-var">NoArgument</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-135"></span><span>             </span><span class="annot"><span class="annottext">optionDescription :: [Char]
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#optionDescription"><span class="hs-identifier hs-var">optionDescription</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Gather profiling data while executing and print out a summary at the end.&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-136"></span><span>             </span><span class="annot"><span class="annottext">optionAction :: Stm
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#optionAction"><span class="hs-identifier hs-var">optionAction</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="">[C.cstm|futhark_context_config_set_profiling(cfg, 1);|]</span></span><span>
</span><span id="line-137"></span><span>           </span><span class="hs-special">}</span><span>
</span><span id="line-138"></span><span>       </span><span class="hs-special">]</span><span>
</span><span id="line-139"></span><span>
</span><span id="line-140"></span><span class="annot"><a href="Futhark.CodeGen.Backends.CCUDA.html#writeCUDAScalar"><span class="hs-identifier hs-type">writeCUDAScalar</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.Backends.GenericC.html#WriteScalar"><span class="hs-identifier hs-type">GC.WriteScalar</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.OpenCL.html#OpenCL"><span class="hs-identifier hs-type">OpenCL</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-141"></span><span id="writeCUDAScalar"><span class="annot"><span class="annottext">writeCUDAScalar :: WriteScalar OpenCL ()
</span><a href="Futhark.CodeGen.Backends.CCUDA.html#writeCUDAScalar"><span class="hs-identifier hs-var hs-var">writeCUDAScalar</span></a></span></span><span> </span><span id="local-6989586621684547122"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684547122"><span class="hs-identifier hs-var">mem</span></a></span></span><span> </span><span id="local-6989586621684547121"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684547121"><span class="hs-identifier hs-var">idx</span></a></span></span><span> </span><span id="local-6989586621684547120"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684547120"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;device&quot;</span></span><span> </span><span class="annot"><span class="annottext">Volatility
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684547119"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684547119"><span class="hs-identifier hs-var">val</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-142"></span><span>  </span><span id="local-6989586621684547118"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684547118"><span class="hs-identifier hs-var">val'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; CompilerM OpenCL () VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; [Char] -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;write_tmp&quot;</span></span><span>
</span><span id="line-143"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684547116"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621684547116"><span class="hs-identifier hs-var">bef</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684547115"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621684547115"><span class="hs-identifier hs-var">aft</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; ([BlockItem], [BlockItem])
</span><a href="Futhark.CodeGen.Backends.CCUDA.Boilerplate.html#profilingEnclosure"><span class="hs-identifier hs-var">profilingEnclosure</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="Futhark.CodeGen.Backends.COpenCL.Boilerplate.html#copyScalarToDev"><span class="hs-identifier hs-var">copyScalarToDev</span></a></span><span>
</span><span id="line-144"></span><span>  </span><span class="annot"><span class="annottext">BlockItem -&gt; CompilerM OpenCL () ()
forall op s. BlockItem -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#item"><span class="hs-identifier hs-var">GC.item</span></a></span><span>
</span><span id="line-145"></span><span>    </span><span class="annot"><span class="">[C.citem|{$ty:t $id:val' = $exp:val;
                  $items:bef
                  CUDA_SUCCEED_OR_RETURN(
                    cuMemcpyHtoD($exp:mem + $exp:idx * sizeof($ty:t),
                                 &amp;$id:val',
                                 sizeof($ty:t)));
                  $items:aft
                 }|]</span></span><span>
</span><span id="line-153"></span><span class="annot"><a href="Futhark.CodeGen.Backends.CCUDA.html#writeCUDAScalar"><span class="hs-identifier hs-var">writeCUDAScalar</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Exp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684547095"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684547095"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span class="annot"><span class="annottext">Volatility
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Exp
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-154"></span><span>  </span><span class="annot"><span class="annottext">[Char] -&gt; CompilerM OpenCL () ()
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; CompilerM OpenCL () ())
-&gt; [Char] -&gt; CompilerM OpenCL () ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Cannot write to '&quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684547095"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;' memory space.&quot;</span></span><span>
</span><span id="line-155"></span><span>
</span><span id="line-156"></span><span class="annot"><a href="Futhark.CodeGen.Backends.CCUDA.html#readCUDAScalar"><span class="hs-identifier hs-type">readCUDAScalar</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.Backends.GenericC.html#ReadScalar"><span class="hs-identifier hs-type">GC.ReadScalar</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.OpenCL.html#OpenCL"><span class="hs-identifier hs-type">OpenCL</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-157"></span><span id="readCUDAScalar"><span class="annot"><span class="annottext">readCUDAScalar :: ReadScalar OpenCL ()
</span><a href="Futhark.CodeGen.Backends.CCUDA.html#readCUDAScalar"><span class="hs-identifier hs-var hs-var">readCUDAScalar</span></a></span></span><span> </span><span id="local-6989586621684547093"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684547093"><span class="hs-identifier hs-var">mem</span></a></span></span><span> </span><span id="local-6989586621684547092"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684547092"><span class="hs-identifier hs-var">idx</span></a></span></span><span> </span><span id="local-6989586621684547091"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684547091"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;device&quot;</span></span><span> </span><span class="annot"><span class="annottext">Volatility
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-158"></span><span>  </span><span id="local-6989586621684547090"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684547090"><span class="hs-identifier hs-var">val</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; CompilerM OpenCL () VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; [Char] -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;read_res&quot;</span></span><span>
</span><span id="line-159"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684547089"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621684547089"><span class="hs-identifier hs-var">bef</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684547088"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621684547088"><span class="hs-identifier hs-var">aft</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; ([BlockItem], [BlockItem])
</span><a href="Futhark.CodeGen.Backends.CCUDA.Boilerplate.html#profilingEnclosure"><span class="hs-identifier hs-var">profilingEnclosure</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="Futhark.CodeGen.Backends.COpenCL.Boilerplate.html#copyScalarFromDev"><span class="hs-identifier hs-var">copyScalarFromDev</span></a></span><span>
</span><span id="line-160"></span><span>  </span><span class="annot"><span class="annottext">(BlockItem -&gt; CompilerM OpenCL () ())
-&gt; [BlockItem] -&gt; CompilerM OpenCL () ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span>
</span><span id="line-161"></span><span>    </span><span class="annot"><span class="annottext">BlockItem -&gt; CompilerM OpenCL () ()
forall op s. BlockItem -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#item"><span class="hs-identifier hs-var">GC.item</span></a></span><span>
</span><span id="line-162"></span><span>    </span><span class="annot"><span class="">[C.citems|
       $ty:t $id:val;
       {
       $items:bef
       CUDA_SUCCEED_OR_RETURN(
          cuMemcpyDtoH(&amp;$id:val,
                       $exp:mem + $exp:idx * sizeof($ty:t),
                       sizeof($ty:t)));
        $items:aft
       }
       |]</span></span><span>
</span><span id="line-173"></span><span>  </span><span class="annot"><span class="annottext">Stm -&gt; CompilerM OpenCL () ()
forall op s. Stm -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#stm"><span class="hs-identifier hs-var">GC.stm</span></a></span><span> </span><span class="annot"><span class="">[C.cstm|if (futhark_context_sync(ctx) != 0) { return 1; }|]</span></span><span>
</span><span id="line-174"></span><span>  </span><span class="annot"><span class="annottext">Exp -&gt; CompilerM OpenCL () Exp
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="">[C.cexp|$id:val|]</span></span><span>
</span><span id="line-175"></span><span class="annot"><a href="Futhark.CodeGen.Backends.CCUDA.html#readCUDAScalar"><span class="hs-identifier hs-var">readCUDAScalar</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Exp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684547077"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684547077"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span class="annot"><span class="annottext">Volatility
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-176"></span><span>  </span><span class="annot"><span class="annottext">[Char] -&gt; CompilerM OpenCL () Exp
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; CompilerM OpenCL () Exp)
-&gt; [Char] -&gt; CompilerM OpenCL () Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Cannot write to '&quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684547077"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;' memory space.&quot;</span></span><span>
</span><span id="line-177"></span><span>
</span><span id="line-178"></span><span class="annot"><a href="Futhark.CodeGen.Backends.CCUDA.html#allocateCUDABuffer"><span class="hs-identifier hs-type">allocateCUDABuffer</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.Backends.GenericC.html#Allocate"><span class="hs-identifier hs-type">GC.Allocate</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.OpenCL.html#OpenCL"><span class="hs-identifier hs-type">OpenCL</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-179"></span><span id="allocateCUDABuffer"><span class="annot"><span class="annottext">allocateCUDABuffer :: Allocate OpenCL ()
</span><a href="Futhark.CodeGen.Backends.CCUDA.html#allocateCUDABuffer"><span class="hs-identifier hs-var hs-var">allocateCUDABuffer</span></a></span></span><span> </span><span id="local-6989586621684547076"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684547076"><span class="hs-identifier hs-var">mem</span></a></span></span><span> </span><span id="local-6989586621684547075"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684547075"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span id="local-6989586621684547074"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684547074"><span class="hs-identifier hs-var">tag</span></a></span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;device&quot;</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-180"></span><span>  </span><span class="annot"><span class="annottext">Stm -&gt; CompilerM OpenCL () ()
forall op s. Stm -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#stm"><span class="hs-identifier hs-var">GC.stm</span></a></span><span> </span><span class="annot"><span class="">[C.cstm|CUDA_SUCCEED_OR_RETURN(cuda_alloc(&amp;ctx-&gt;cuda, (size_t)$exp:size, $exp:tag, &amp;$exp:mem));|]</span></span><span>
</span><span id="line-181"></span><span class="annot"><a href="Futhark.CodeGen.Backends.CCUDA.html#allocateCUDABuffer"><span class="hs-identifier hs-var">allocateCUDABuffer</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Exp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Exp
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684547070"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684547070"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-182"></span><span>  </span><span class="annot"><span class="annottext">[Char] -&gt; CompilerM OpenCL () ()
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; CompilerM OpenCL () ())
-&gt; [Char] -&gt; CompilerM OpenCL () ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Cannot allocate in '&quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684547070"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;' memory space.&quot;</span></span><span>
</span><span id="line-183"></span><span>
</span><span id="line-184"></span><span class="annot"><a href="Futhark.CodeGen.Backends.CCUDA.html#deallocateCUDABuffer"><span class="hs-identifier hs-type">deallocateCUDABuffer</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.Backends.GenericC.html#Deallocate"><span class="hs-identifier hs-type">GC.Deallocate</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.OpenCL.html#OpenCL"><span class="hs-identifier hs-type">OpenCL</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-185"></span><span id="deallocateCUDABuffer"><span class="annot"><span class="annottext">deallocateCUDABuffer :: Deallocate OpenCL ()
</span><a href="Futhark.CodeGen.Backends.CCUDA.html#deallocateCUDABuffer"><span class="hs-identifier hs-var hs-var">deallocateCUDABuffer</span></a></span></span><span> </span><span id="local-6989586621684547069"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684547069"><span class="hs-identifier hs-var">mem</span></a></span></span><span> </span><span id="local-6989586621684547068"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684547068"><span class="hs-identifier hs-var">tag</span></a></span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;device&quot;</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-186"></span><span>  </span><span class="annot"><span class="annottext">Stm -&gt; CompilerM OpenCL () ()
forall op s. Stm -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#stm"><span class="hs-identifier hs-var">GC.stm</span></a></span><span> </span><span class="annot"><span class="">[C.cstm|CUDA_SUCCEED_OR_RETURN(cuda_free(&amp;ctx-&gt;cuda, $exp:mem, $exp:tag));|]</span></span><span>
</span><span id="line-187"></span><span class="annot"><a href="Futhark.CodeGen.Backends.CCUDA.html#deallocateCUDABuffer"><span class="hs-identifier hs-var">deallocateCUDABuffer</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Exp
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684547067"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684547067"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-188"></span><span>  </span><span class="annot"><span class="annottext">[Char] -&gt; CompilerM OpenCL () ()
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; CompilerM OpenCL () ())
-&gt; [Char] -&gt; CompilerM OpenCL () ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Cannot deallocate in '&quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684547067"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;' memory space.&quot;</span></span><span>
</span><span id="line-189"></span><span>
</span><span id="line-190"></span><span class="annot"><a href="Futhark.CodeGen.Backends.CCUDA.html#copyCUDAMemory"><span class="hs-identifier hs-type">copyCUDAMemory</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.Backends.GenericC.html#Copy"><span class="hs-identifier hs-type">GC.Copy</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.OpenCL.html#OpenCL"><span class="hs-identifier hs-type">OpenCL</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-191"></span><span id="copyCUDAMemory"><span class="annot"><span class="annottext">copyCUDAMemory :: Copy OpenCL ()
</span><a href="Futhark.CodeGen.Backends.CCUDA.html#copyCUDAMemory"><span class="hs-identifier hs-var hs-var">copyCUDAMemory</span></a></span></span><span> </span><span id="local-6989586621684547066"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684547066"><span class="hs-identifier hs-var">dstmem</span></a></span></span><span> </span><span id="local-6989586621684547065"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684547065"><span class="hs-identifier hs-var">dstidx</span></a></span></span><span> </span><span id="local-6989586621684547064"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684547064"><span class="hs-identifier hs-var">dstSpace</span></a></span></span><span> </span><span id="local-6989586621684547063"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684547063"><span class="hs-identifier hs-var">srcmem</span></a></span></span><span> </span><span id="local-6989586621684547062"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684547062"><span class="hs-identifier hs-var">srcidx</span></a></span></span><span> </span><span id="local-6989586621684547061"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684547061"><span class="hs-identifier hs-var">srcSpace</span></a></span></span><span> </span><span id="local-6989586621684547060"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684547060"><span class="hs-identifier hs-var">nbytes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-192"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684547059"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684547059"><span class="hs-identifier hs-var">fn</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684547058"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684547058"><span class="hs-identifier hs-var">prof</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Space -&gt; Space -&gt; ([Char], Name)
</span><a href="#local-6989586621684547057"><span class="hs-identifier hs-var">memcpyFun</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684547064"><span class="hs-identifier hs-var">dstSpace</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684547061"><span class="hs-identifier hs-var">srcSpace</span></a></span><span>
</span><span id="line-193"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684547056"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621684547056"><span class="hs-identifier hs-var">bef</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684547055"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621684547055"><span class="hs-identifier hs-var">aft</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; ([BlockItem], [BlockItem])
</span><a href="Futhark.CodeGen.Backends.CCUDA.Boilerplate.html#profilingEnclosure"><span class="hs-identifier hs-var">profilingEnclosure</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684547058"><span class="hs-identifier hs-var">prof</span></a></span><span>
</span><span id="line-194"></span><span>  </span><span class="annot"><span class="annottext">BlockItem -&gt; CompilerM OpenCL () ()
forall op s. BlockItem -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#item"><span class="hs-identifier hs-var">GC.item</span></a></span><span>
</span><span id="line-195"></span><span>    </span><span class="annot"><span class="">[C.citem|{
                $items:bef
                CUDA_SUCCEED_OR_RETURN(
                  $id:fn($exp:dstmem + $exp:dstidx,
                         $exp:srcmem + $exp:srcidx,
                         $exp:nbytes));
                $items:aft
                }
                |]</span></span><span>
</span><span id="line-204"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-205"></span><span>    </span><span id="local-6989586621684547057"><span class="annot"><span class="annottext">memcpyFun :: Space -&gt; Space -&gt; ([Char], Name)
</span><a href="#local-6989586621684547057"><span class="hs-identifier hs-var hs-var">memcpyFun</span></a></span></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="Futhark.IR.Syntax.Core.html#DefaultSpace"><span class="hs-identifier hs-var">DefaultSpace</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;device&quot;</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;cuMemcpyDtoH&quot;</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="Futhark.CodeGen.Backends.COpenCL.Boilerplate.html#copyDevToHost"><span class="hs-identifier hs-var">copyDevToHost</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-206"></span><span>    </span><span class="annot"><a href="#local-6989586621684547057"><span class="hs-identifier hs-var">memcpyFun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;device&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="Futhark.IR.Syntax.Core.html#DefaultSpace"><span class="hs-identifier hs-var">DefaultSpace</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;cuMemcpyHtoD&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="Futhark.CodeGen.Backends.COpenCL.Boilerplate.html#copyHostToDev"><span class="hs-identifier hs-var">copyHostToDev</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-207"></span><span>    </span><span class="annot"><a href="#local-6989586621684547057"><span class="hs-identifier hs-var">memcpyFun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;device&quot;</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;device&quot;</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;cuMemcpy&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="Futhark.CodeGen.Backends.COpenCL.Boilerplate.html#copyDevToDev"><span class="hs-identifier hs-var">copyDevToDev</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-208"></span><span>    </span><span class="annot"><a href="#local-6989586621684547057"><span class="hs-identifier hs-var">memcpyFun</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Space
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-209"></span><span>      </span><span class="annot"><span class="annottext">[Char] -&gt; ([Char], Name)
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; ([Char], Name)) -&gt; [Char] -&gt; ([Char], Name)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-210"></span><span>        </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Cannot copy to '&quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Space -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684547064"><span class="hs-identifier hs-var">dstSpace</span></a></span><span>
</span><span id="line-211"></span><span>          </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;' from '&quot;</span></span><span>
</span><span id="line-212"></span><span>          </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Space -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684547061"><span class="hs-identifier hs-var">srcSpace</span></a></span><span>
</span><span id="line-213"></span><span>          </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;'.&quot;</span></span><span>
</span><span id="line-214"></span><span>
</span><span id="line-215"></span><span class="annot"><a href="Futhark.CodeGen.Backends.CCUDA.html#staticCUDAArray"><span class="hs-identifier hs-type">staticCUDAArray</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.Backends.GenericC.html#StaticArray"><span class="hs-identifier hs-type">GC.StaticArray</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.OpenCL.html#OpenCL"><span class="hs-identifier hs-type">OpenCL</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-216"></span><span id="staticCUDAArray"><span class="annot"><span class="annottext">staticCUDAArray :: StaticArray OpenCL ()
</span><a href="Futhark.CodeGen.Backends.CCUDA.html#staticCUDAArray"><span class="hs-identifier hs-var hs-var">staticCUDAArray</span></a></span></span><span> </span><span id="local-6989586621684547033"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684547033"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;device&quot;</span></span><span> </span><span id="local-6989586621684547032"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684547032"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621684547031"><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621684547031"><span class="hs-identifier hs-var">vs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-217"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684547030"><span class="annot"><span class="annottext">ct :: Type
</span><a href="#local-6989586621684547030"><span class="hs-identifier hs-var hs-var">ct</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; Type
</span><a href="Futhark.CodeGen.Backends.SimpleRep.html#primTypeToCType"><span class="hs-identifier hs-var">GC.primTypeToCType</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684547032"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-218"></span><span>  </span><span id="local-6989586621684547028"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684547028"><span class="hs-identifier hs-var">name_realtype</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; CompilerM OpenCL () VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; [Char] -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; CompilerM OpenCL () VName)
-&gt; [Char] -&gt; CompilerM OpenCL () VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [Char]
</span><a href="Language.Futhark.Core.html#baseString"><span class="hs-identifier hs-var">baseString</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684547033"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;_realtype&quot;</span></span><span>
</span><span id="line-219"></span><span>  </span><span id="local-6989586621684547026"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684547026"><span class="hs-identifier hs-var">num_elems</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621684547031"><span class="hs-identifier hs-var">vs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-220"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#ArrayValues"><span class="hs-identifier hs-type">ArrayValues</span></a></span><span> </span><span id="local-6989586621684547024"><span class="annot"><span class="annottext">[PrimValue]
</span><a href="#local-6989586621684547024"><span class="hs-identifier hs-var">vs'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-221"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684547021"><span class="annot"><span class="annottext">vs'' :: [Initializer]
</span><a href="#local-6989586621684547021"><span class="hs-identifier hs-var hs-var">vs''</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="">[C.cinit|$exp:v|]</span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621684547020"><span class="annot"><span class="annottext">PrimValue
</span><a href="#local-6989586621684547020"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[PrimValue]
</span><a href="#local-6989586621684547024"><span class="hs-identifier hs-var">vs'</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-222"></span><span>      </span><span class="annot"><span class="annottext">Definition -&gt; CompilerM OpenCL () ()
forall op s. Definition -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#earlyDecl"><span class="hs-identifier hs-var">GC.earlyDecl</span></a></span><span> </span><span class="annot"><span class="">[C.cedecl|static $ty:ct $id:name_realtype[$int:(length vs'')] = {$inits:vs''};|]</span></span><span>
</span><span id="line-223"></span><span>      </span><span class="annot"><span class="annottext">Int -&gt; CompilerM OpenCL () Int
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; CompilerM OpenCL () Int) -&gt; Int -&gt; CompilerM OpenCL () Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Initializer] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Initializer]
</span><a href="#local-6989586621684547021"><span class="hs-identifier hs-var">vs''</span></a></span><span>
</span><span id="line-224"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#ArrayZeros"><span class="hs-identifier hs-type">ArrayZeros</span></a></span><span> </span><span id="local-6989586621684547005"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684547005"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-225"></span><span>      </span><span class="annot"><span class="annottext">Definition -&gt; CompilerM OpenCL () ()
forall op s. Definition -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#earlyDecl"><span class="hs-identifier hs-var">GC.earlyDecl</span></a></span><span> </span><span class="annot"><span class="">[C.cedecl|static $ty:ct $id:name_realtype[$int:n];|]</span></span><span>
</span><span id="line-226"></span><span>      </span><span class="annot"><span class="annottext">Int -&gt; CompilerM OpenCL () Int
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684547005"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-227"></span><span>  </span><span class="hs-comment">-- Fake a memory block.</span><span>
</span><span id="line-228"></span><span>  </span><span class="annot"><span class="annottext">Id -&gt; Type -&gt; Maybe Exp -&gt; CompilerM OpenCL () ()
forall op s. Id -&gt; Type -&gt; Maybe Exp -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#contextField"><span class="hs-identifier hs-var">GC.contextField</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SrcLoc -&gt; Id
forall a. ToIdent a =&gt; a -&gt; SrcLoc -&gt; Id
</span><span class="hs-identifier hs-var">C.toIdent</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684547033"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="">[C.cty|struct memblock_device|]</span></span><span> </span><span class="annot"><span class="annottext">Maybe Exp
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-229"></span><span>  </span><span class="hs-comment">-- During startup, copy the data to where we need it.</span><span>
</span><span id="line-230"></span><span>  </span><span class="annot"><span class="annottext">Stm -&gt; CompilerM OpenCL () ()
forall op s. Stm -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#atInit"><span class="hs-identifier hs-var">GC.atInit</span></a></span><span>
</span><span id="line-231"></span><span>    </span><span class="annot"><span class="">[C.cstm|{
    ctx-&gt;$id:name.references = NULL;
    ctx-&gt;$id:name.size = 0;
    CUDA_SUCCEED_FATAL(cuMemAlloc(&amp;ctx-&gt;$id:name.mem,
                            ($int:num_elems &gt; 0 ? $int:num_elems : 1)*sizeof($ty:ct)));
    if ($int:num_elems &gt; 0) {
      CUDA_SUCCEED_FATAL(cuMemcpyHtoD(ctx-&gt;$id:name.mem, $id:name_realtype,
                                $int:num_elems*sizeof($ty:ct)));
    }
  }|]</span></span><span>
</span><span id="line-241"></span><span>  </span><span class="annot"><span class="annottext">BlockItem -&gt; CompilerM OpenCL () ()
forall op s. BlockItem -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#item"><span class="hs-identifier hs-var">GC.item</span></a></span><span> </span><span class="annot"><span class="">[C.citem|struct memblock_device $id:name = ctx-&gt;$id:name;|]</span></span><span>
</span><span id="line-242"></span><span class="annot"><a href="Futhark.CodeGen.Backends.CCUDA.html#staticCUDAArray"><span class="hs-identifier hs-var">staticCUDAArray</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684546994"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684546994"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-243"></span><span>  </span><span class="annot"><span class="annottext">[Char] -&gt; CompilerM OpenCL () ()
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; CompilerM OpenCL () ())
-&gt; [Char] -&gt; CompilerM OpenCL () ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-244"></span><span>    </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;CUDA backend cannot create static array in '&quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684546994"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-245"></span><span>      </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;' memory space&quot;</span></span><span>
</span><span id="line-246"></span><span>
</span><span id="line-247"></span><span class="annot"><a href="Futhark.CodeGen.Backends.CCUDA.html#cudaMemoryType"><span class="hs-identifier hs-type">cudaMemoryType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.Backends.GenericC.html#MemoryType"><span class="hs-identifier hs-type">GC.MemoryType</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.OpenCL.html#OpenCL"><span class="hs-identifier hs-type">OpenCL</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-248"></span><span id="cudaMemoryType"><span class="annot"><span class="annottext">cudaMemoryType :: MemoryType OpenCL ()
</span><a href="Futhark.CodeGen.Backends.CCUDA.html#cudaMemoryType"><span class="hs-identifier hs-var hs-var">cudaMemoryType</span></a></span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;device&quot;</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; CompilerM OpenCL () Type
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="">[C.cty|typename CUdeviceptr|]</span></span><span>
</span><span id="line-249"></span><span class="annot"><a href="Futhark.CodeGen.Backends.CCUDA.html#cudaMemoryType"><span class="hs-identifier hs-var">cudaMemoryType</span></a></span><span> </span><span id="local-6989586621684546993"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684546993"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-250"></span><span>  </span><span class="annot"><span class="annottext">MemoryType OpenCL ()
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">MemoryType OpenCL () -&gt; MemoryType OpenCL ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;CUDA backend does not support '&quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684546993"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;' memory space.&quot;</span></span><span>
</span><span id="line-251"></span><span>
</span><span id="line-252"></span><span class="annot"><a href="Futhark.CodeGen.Backends.CCUDA.html#callKernel"><span class="hs-identifier hs-type">callKernel</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.Backends.GenericC.html#OpCompiler"><span class="hs-identifier hs-type">GC.OpCompiler</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.OpenCL.html#OpenCL"><span class="hs-identifier hs-type">OpenCL</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-253"></span><span id="callKernel"><span class="annot"><span class="annottext">callKernel :: OpCompiler OpenCL ()
</span><a href="Futhark.CodeGen.Backends.CCUDA.html#callKernel"><span class="hs-identifier hs-var hs-var">callKernel</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.OpenCL.html#GetSize"><span class="hs-identifier hs-type">GetSize</span></a></span><span> </span><span id="local-6989586621684546991"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684546991"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621684546990"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684546990"><span class="hs-identifier hs-var">key</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-254"></span><span>  </span><span class="annot"><span class="annottext">Stm -&gt; CompilerM OpenCL () ()
forall op s. Stm -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#stm"><span class="hs-identifier hs-var">GC.stm</span></a></span><span> </span><span class="annot"><span class="">[C.cstm|$id:v = *ctx-&gt;tuning_params.$id:key;|]</span></span><span>
</span><span id="line-255"></span><span class="annot"><a href="Futhark.CodeGen.Backends.CCUDA.html#callKernel"><span class="hs-identifier hs-var">callKernel</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.OpenCL.html#CmpSizeLe"><span class="hs-identifier hs-type">CmpSizeLe</span></a></span><span> </span><span id="local-6989586621684546987"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684546987"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621684546986"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684546986"><span class="hs-identifier hs-var">key</span></a></span></span><span> </span><span id="local-6989586621684546985"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684546985"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-256"></span><span>  </span><span id="local-6989586621684546984"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684546984"><span class="hs-identifier hs-var">x'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; CompilerM OpenCL () Exp
forall op s. Exp -&gt; CompilerM op s Exp
</span><a href="Futhark.CodeGen.Backends.GenericC.html#compileExp"><span class="hs-identifier hs-var">GC.compileExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684546985"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-257"></span><span>  </span><span class="annot"><span class="annottext">Stm -&gt; CompilerM OpenCL () ()
forall op s. Stm -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#stm"><span class="hs-identifier hs-var">GC.stm</span></a></span><span> </span><span class="annot"><span class="">[C.cstm|$id:v = *ctx-&gt;tuning_params.$id:key &lt;= $exp:x';|]</span></span><span>
</span><span id="line-258"></span><span>  </span><span class="annot"><span class="annottext">VName -&gt; Name -&gt; Exp -&gt; CompilerM OpenCL () ()
forall op. VName -&gt; Name -&gt; Exp -&gt; CompilerM op () ()
</span><a href="Futhark.CodeGen.Backends.COpenCL.Boilerplate.html#sizeLoggingCode"><span class="hs-identifier hs-var">sizeLoggingCode</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684546987"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684546986"><span class="hs-identifier hs-var">key</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684546984"><span class="hs-identifier hs-var">x'</span></a></span><span>
</span><span id="line-259"></span><span class="annot"><a href="Futhark.CodeGen.Backends.CCUDA.html#callKernel"><span class="hs-identifier hs-var">callKernel</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.OpenCL.html#GetSizeMax"><span class="hs-identifier hs-type">GetSizeMax</span></a></span><span> </span><span id="local-6989586621684546980"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684546980"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621684546979"><span class="annot"><span class="annottext">SizeClass
</span><a href="#local-6989586621684546979"><span class="hs-identifier hs-var">size_class</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-260"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684546976"><span class="annot"><span class="annottext">field :: [Char]
</span><a href="#local-6989586621684546976"><span class="hs-identifier hs-var hs-var">field</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;max_&quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">SizeClass -&gt; [Char]
</span><a href="#local-6989586621684546975"><span class="hs-identifier hs-var">cudaSizeClass</span></a></span><span> </span><span class="annot"><span class="annottext">SizeClass
</span><a href="#local-6989586621684546979"><span class="hs-identifier hs-var">size_class</span></a></span><span>
</span><span id="line-261"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Stm -&gt; CompilerM OpenCL () ()
forall op s. Stm -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#stm"><span class="hs-identifier hs-var">GC.stm</span></a></span><span> </span><span class="annot"><span class="">[C.cstm|$id:v = ctx-&gt;cuda.$id:field;|]</span></span><span>
</span><span id="line-262"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-263"></span><span>    </span><span id="local-6989586621684546975"><span class="annot"><span class="annottext">cudaSizeClass :: SizeClass -&gt; [Char]
</span><a href="#local-6989586621684546975"><span class="hs-identifier hs-var hs-var">cudaSizeClass</span></a></span></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#SizeThreshold"><span class="hs-identifier hs-type">SizeThreshold</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;threshold&quot;</span></span><span>
</span><span id="line-264"></span><span>    </span><span class="annot"><a href="#local-6989586621684546975"><span class="hs-identifier hs-var">cudaSizeClass</span></a></span><span> </span><span class="annot"><span class="annottext">SizeClass
</span><a href="Futhark.IR.GPU.Sizes.html#SizeGroup"><span class="hs-identifier hs-var">SizeGroup</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;block_size&quot;</span></span><span>
</span><span id="line-265"></span><span>    </span><span class="annot"><a href="#local-6989586621684546975"><span class="hs-identifier hs-var">cudaSizeClass</span></a></span><span> </span><span class="annot"><span class="annottext">SizeClass
</span><a href="Futhark.IR.GPU.Sizes.html#SizeNumGroups"><span class="hs-identifier hs-var">SizeNumGroups</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;grid_size&quot;</span></span><span>
</span><span id="line-266"></span><span>    </span><span class="annot"><a href="#local-6989586621684546975"><span class="hs-identifier hs-var">cudaSizeClass</span></a></span><span> </span><span class="annot"><span class="annottext">SizeClass
</span><a href="Futhark.IR.GPU.Sizes.html#SizeTile"><span class="hs-identifier hs-var">SizeTile</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;tile_size&quot;</span></span><span>
</span><span id="line-267"></span><span>    </span><span class="annot"><a href="#local-6989586621684546975"><span class="hs-identifier hs-var">cudaSizeClass</span></a></span><span> </span><span class="annot"><span class="annottext">SizeClass
</span><a href="Futhark.IR.GPU.Sizes.html#SizeRegTile"><span class="hs-identifier hs-var">SizeRegTile</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;reg_tile_size&quot;</span></span><span>
</span><span id="line-268"></span><span>    </span><span class="annot"><a href="#local-6989586621684546975"><span class="hs-identifier hs-var">cudaSizeClass</span></a></span><span> </span><span class="annot"><span class="annottext">SizeClass
</span><a href="Futhark.IR.GPU.Sizes.html#SizeLocalMemory"><span class="hs-identifier hs-var">SizeLocalMemory</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;shared_memory&quot;</span></span><span>
</span><span id="line-269"></span><span>    </span><span class="annot"><a href="#local-6989586621684546975"><span class="hs-identifier hs-var">cudaSizeClass</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#SizeBespoke"><span class="hs-identifier hs-type">SizeBespoke</span></a></span><span> </span><span id="local-6989586621684546959"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684546959"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int64
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; [Char]
forall a. Pretty a =&gt; a -&gt; [Char]
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684546959"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-270"></span><span class="annot"><a href="Futhark.CodeGen.Backends.CCUDA.html#callKernel"><span class="hs-identifier hs-var">callKernel</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.OpenCL.html#LaunchKernel"><span class="hs-identifier hs-type">LaunchKernel</span></a></span><span> </span><span id="local-6989586621684546956"><span class="annot"><span class="annottext">KernelSafety
</span><a href="#local-6989586621684546956"><span class="hs-identifier hs-var">safety</span></a></span></span><span> </span><span id="local-6989586621684546955"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684546955"><span class="hs-identifier hs-var">kernel_name</span></a></span></span><span> </span><span id="local-6989586621684546954"><span class="annot"><span class="annottext">[KernelArg]
</span><a href="#local-6989586621684546954"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621684546953"><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621684546953"><span class="hs-identifier hs-var">num_blocks</span></a></span></span><span> </span><span id="local-6989586621684546952"><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621684546952"><span class="hs-identifier hs-var">block_size</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-271"></span><span>  </span><span id="local-6989586621684546951"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684546951"><span class="hs-identifier hs-var">args_arr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; CompilerM OpenCL () VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; [Char] -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;kernel_args&quot;</span></span><span>
</span><span id="line-272"></span><span>  </span><span id="local-6989586621684546950"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684546950"><span class="hs-identifier hs-var">time_start</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; CompilerM OpenCL () VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; [Char] -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;time_start&quot;</span></span><span>
</span><span id="line-273"></span><span>  </span><span id="local-6989586621684546949"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684546949"><span class="hs-identifier hs-var">time_end</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; CompilerM OpenCL () VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; [Char] -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;time_end&quot;</span></span><span>
</span><span id="line-274"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684546948"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684546948"><span class="hs-identifier hs-var">args'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684546947"><span class="annot"><span class="annottext">[Maybe (VName, VName)]
</span><a href="#local-6989586621684546947"><span class="hs-identifier hs-var">shared_vars</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(VName, Maybe (VName, VName))]
-&gt; ([VName], [Maybe (VName, VName)])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(VName, Maybe (VName, VName))]
 -&gt; ([VName], [Maybe (VName, VName)]))
-&gt; CompilerM OpenCL () [(VName, Maybe (VName, VName))]
-&gt; CompilerM OpenCL () ([VName], [Maybe (VName, VName)])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(KernelArg -&gt; CompilerM OpenCL () (VName, Maybe (VName, VName)))
-&gt; [KernelArg]
-&gt; CompilerM OpenCL () [(VName, Maybe (VName, VName))]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">KernelArg -&gt; CompilerM OpenCL () (VName, Maybe (VName, VName))
forall {op} {s}.
KernelArg -&gt; CompilerM op s (VName, Maybe (VName, VName))
</span><a href="#local-6989586621684546944"><span class="hs-identifier hs-var">mkArgs</span></a></span><span> </span><span class="annot"><span class="annottext">[KernelArg]
</span><a href="#local-6989586621684546954"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-275"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684546943"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684546943"><span class="hs-identifier hs-var">shared_sizes</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684546942"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684546942"><span class="hs-identifier hs-var">shared_offsets</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VName, VName)] -&gt; ([VName], [VName])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(VName, VName)] -&gt; ([VName], [VName]))
-&gt; [(VName, VName)] -&gt; ([VName], [VName])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Maybe (VName, VName)] -&gt; [(VName, VName)]
forall a. [Maybe a] -&gt; [a]
</span><span class="hs-identifier hs-var">catMaybes</span></span><span> </span><span class="annot"><span class="annottext">[Maybe (VName, VName)]
</span><a href="#local-6989586621684546947"><span class="hs-identifier hs-var">shared_vars</span></a></span><span>
</span><span id="line-276"></span><span>      </span><span id="local-6989586621684546941"><span class="annot"><span class="annottext">shared_offsets_sc :: [Exp]
</span><a href="#local-6989586621684546941"><span class="hs-identifier hs-var hs-var">shared_offsets_sc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [Exp]
</span><a href="#local-6989586621684546940"><span class="hs-identifier hs-var">mkOffsets</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684546943"><span class="hs-identifier hs-var">shared_sizes</span></a></span><span>
</span><span id="line-277"></span><span>      </span><span id="local-6989586621684546939"><span class="annot"><span class="annottext">shared_args :: [(VName, Exp)]
</span><a href="#local-6989586621684546939"><span class="hs-identifier hs-var hs-var">shared_args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [Exp] -&gt; [(VName, Exp)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684546942"><span class="hs-identifier hs-var">shared_offsets</span></a></span><span> </span><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621684546941"><span class="hs-identifier hs-var">shared_offsets_sc</span></a></span><span>
</span><span id="line-278"></span><span>      </span><span id="local-6989586621684546938"><span class="annot"><span class="annottext">shared_tot :: Exp
</span><a href="#local-6989586621684546938"><span class="hs-identifier hs-var hs-var">shared_tot</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Exp] -&gt; Exp
forall a. [a] -&gt; a
</span><span class="hs-identifier hs-var">last</span></span><span> </span><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621684546941"><span class="hs-identifier hs-var">shared_offsets_sc</span></a></span><span>
</span><span id="line-279"></span><span>  </span><span class="annot"><span class="annottext">[(VName, Exp)]
-&gt; ((VName, Exp) -&gt; CompilerM OpenCL () ())
-&gt; CompilerM OpenCL () ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="annot"><span class="annottext">[(VName, Exp)]
</span><a href="#local-6989586621684546939"><span class="hs-identifier hs-var">shared_args</span></a></span><span> </span><span class="annot"><span class="annottext">(((VName, Exp) -&gt; CompilerM OpenCL () ())
 -&gt; CompilerM OpenCL () ())
-&gt; ((VName, Exp) -&gt; CompilerM OpenCL () ())
-&gt; CompilerM OpenCL () ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684546935"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684546935"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684546934"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684546934"><span class="hs-identifier hs-var">offset</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-280"></span><span>    </span><span class="annot"><span class="annottext">InitGroup -&gt; CompilerM OpenCL () ()
forall op s. InitGroup -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#decl"><span class="hs-identifier hs-var">GC.decl</span></a></span><span> </span><span class="annot"><span class="">[C.cdecl|unsigned int $id:arg = $exp:offset;|]</span></span><span>
</span><span id="line-281"></span><span>
</span><span id="line-282"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684546930"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684546930"><span class="hs-identifier hs-var">grid_x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684546929"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684546929"><span class="hs-identifier hs-var">grid_y</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684546928"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684546928"><span class="hs-identifier hs-var">grid_z</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Exp] -&gt; (Exp, Exp, Exp)
</span><a href="#local-6989586621684546927"><span class="hs-identifier hs-var">mkDims</span></a></span><span> </span><span class="annot"><span class="annottext">([Exp] -&gt; (Exp, Exp, Exp))
-&gt; CompilerM OpenCL () [Exp] -&gt; CompilerM OpenCL () (Exp, Exp, Exp)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; CompilerM OpenCL () Exp)
-&gt; [Exp] -&gt; CompilerM OpenCL () [Exp]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; CompilerM OpenCL () Exp
forall op s. Exp -&gt; CompilerM op s Exp
</span><a href="Futhark.CodeGen.Backends.GenericC.html#compileExp"><span class="hs-identifier hs-var">GC.compileExp</span></a></span><span> </span><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621684546953"><span class="hs-identifier hs-var">num_blocks</span></a></span><span>
</span><span id="line-283"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684546926"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684546926"><span class="hs-identifier hs-var">block_x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684546925"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684546925"><span class="hs-identifier hs-var">block_y</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684546924"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684546924"><span class="hs-identifier hs-var">block_z</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Exp] -&gt; (Exp, Exp, Exp)
</span><a href="#local-6989586621684546927"><span class="hs-identifier hs-var">mkDims</span></a></span><span> </span><span class="annot"><span class="annottext">([Exp] -&gt; (Exp, Exp, Exp))
-&gt; CompilerM OpenCL () [Exp] -&gt; CompilerM OpenCL () (Exp, Exp, Exp)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; CompilerM OpenCL () Exp)
-&gt; [Exp] -&gt; CompilerM OpenCL () [Exp]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; CompilerM OpenCL () Exp
forall op s. Exp -&gt; CompilerM op s Exp
</span><a href="Futhark.CodeGen.Backends.GenericC.html#compileExp"><span class="hs-identifier hs-var">GC.compileExp</span></a></span><span> </span><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621684546952"><span class="hs-identifier hs-var">block_size</span></a></span><span>
</span><span id="line-284"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684546918"><span class="annot"><span class="annottext">perm_args :: [Initializer]
</span><a href="#local-6989586621684546918"><span class="hs-identifier hs-var hs-var">perm_args</span></a></span></span><span>
</span><span id="line-285"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[Exp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621684546953"><span class="hs-identifier hs-var">num_blocks</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">3</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="">[C.cinit|&amp;perm[0]|]</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="">[C.cinit|&amp;perm[1]|]</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="">[C.cinit|&amp;perm[2]|]</span></span><span class="hs-special">]</span><span>
</span><span id="line-286"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-287"></span><span>      </span><span id="local-6989586621684546916"><span class="annot"><span class="annottext">failure_args :: [Initializer]
</span><a href="#local-6989586621684546916"><span class="hs-identifier hs-var hs-var">failure_args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-288"></span><span>        </span><span class="annot"><span class="annottext">Int -&gt; [Initializer] -&gt; [Initializer]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">take</span></span><span>
</span><span id="line-289"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelSafety -&gt; Int
</span><a href="Futhark.CodeGen.ImpCode.OpenCL.html#numFailureParams"><span class="hs-identifier hs-var">numFailureParams</span></a></span><span> </span><span class="annot"><span class="annottext">KernelSafety
</span><a href="#local-6989586621684546956"><span class="hs-identifier hs-var">safety</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-290"></span><span>          </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="">[C.cinit|&amp;ctx-&gt;global_failure|]</span></span><span class="hs-special">,</span><span>
</span><span id="line-291"></span><span>            </span><span class="annot"><span class="">[C.cinit|&amp;ctx-&gt;failure_is_an_option|]</span></span><span class="hs-special">,</span><span>
</span><span id="line-292"></span><span>            </span><span class="annot"><span class="">[C.cinit|&amp;ctx-&gt;global_failure_args|]</span></span><span>
</span><span id="line-293"></span><span>          </span><span class="hs-special">]</span><span>
</span><span id="line-294"></span><span>      </span><span id="local-6989586621684546912"><span class="annot"><span class="annottext">args'' :: [Initializer]
</span><a href="#local-6989586621684546912"><span class="hs-identifier hs-var hs-var">args''</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Initializer]
</span><a href="#local-6989586621684546918"><span class="hs-identifier hs-var">perm_args</span></a></span><span> </span><span class="annot"><span class="annottext">[Initializer] -&gt; [Initializer] -&gt; [Initializer]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Initializer]
</span><a href="#local-6989586621684546916"><span class="hs-identifier hs-var">failure_args</span></a></span><span> </span><span class="annot"><span class="annottext">[Initializer] -&gt; [Initializer] -&gt; [Initializer]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="">[C.cinit|&amp;$id:a|]</span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621684546911"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684546911"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684546948"><span class="hs-identifier hs-var">args'</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-295"></span><span>      </span><span id="local-6989586621684546910"><span class="annot"><span class="annottext">sizes_nonzero :: Exp
</span><a href="#local-6989586621684546910"><span class="hs-identifier hs-var hs-var">sizes_nonzero</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-296"></span><span>        </span><span class="annot"><span class="annottext">[Exp] -&gt; Exp
</span><a href="#local-6989586621684546909"><span class="hs-identifier hs-var">expsNotZero</span></a></span><span>
</span><span id="line-297"></span><span>          </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684546930"><span class="hs-identifier hs-var">grid_x</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-298"></span><span>            </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684546929"><span class="hs-identifier hs-var">grid_y</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-299"></span><span>            </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684546928"><span class="hs-identifier hs-var">grid_z</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-300"></span><span>            </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684546926"><span class="hs-identifier hs-var">block_x</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-301"></span><span>            </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684546925"><span class="hs-identifier hs-var">block_y</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-302"></span><span>            </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684546924"><span class="hs-identifier hs-var">block_z</span></a></span><span>
</span><span id="line-303"></span><span>          </span><span class="hs-special">]</span><span>
</span><span id="line-304"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684546908"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621684546908"><span class="hs-identifier hs-var">bef</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684546907"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621684546907"><span class="hs-identifier hs-var">aft</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; ([BlockItem], [BlockItem])
</span><a href="Futhark.CodeGen.Backends.CCUDA.Boilerplate.html#profilingEnclosure"><span class="hs-identifier hs-var">profilingEnclosure</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684546955"><span class="hs-identifier hs-var">kernel_name</span></a></span><span>
</span><span id="line-305"></span><span>
</span><span id="line-306"></span><span>  </span><span class="annot"><span class="annottext">Stm -&gt; CompilerM OpenCL () ()
forall op s. Stm -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#stm"><span class="hs-identifier hs-var">GC.stm</span></a></span><span>
</span><span id="line-307"></span><span>    </span><span class="annot"><span class="">[C.cstm|
    if ($exp:sizes_nonzero) {
      int perm[3] = { 0, 1, 2 };

      if ($exp:grid_y &gt;= (1&lt;&lt;16)) {
        perm[1] = perm[0];
        perm[0] = 1;
      }

      if ($exp:grid_z &gt;= (1&lt;&lt;16)) {
        perm[2] = perm[0];
        perm[0] = 2;
      }

      size_t grid[3];
      grid[perm[0]] = $exp:grid_x;
      grid[perm[1]] = $exp:grid_y;
      grid[perm[2]] = $exp:grid_z;

      void *$id:args_arr[] = { $inits:args'' };
      typename int64_t $id:time_start = 0, $id:time_end = 0;
      if (ctx-&gt;debugging) {
        fprintf(ctx-&gt;log, &quot;Launching %s with grid size [%ld, %ld, %ld] and block size [%ld, %ld, %ld]; shared memory: %d bytes.\n&quot;,
                $string:(pretty kernel_name),
                (long int)$exp:grid_x, (long int)$exp:grid_y, (long int)$exp:grid_z,
                (long int)$exp:block_x, (long int)$exp:block_y, (long int)$exp:block_z,
                (int)$exp:shared_tot);
        $id:time_start = get_wall_time();
      }
      $items:bef
      CUDA_SUCCEED_OR_RETURN(
        cuLaunchKernel(ctx-&gt;$id:kernel_name,
                       grid[0], grid[1], grid[2],
                       $exp:block_x, $exp:block_y, $exp:block_z,
                       $exp:shared_tot, NULL,
                       $id:args_arr, NULL));
      $items:aft
      if (ctx-&gt;debugging) {
        CUDA_SUCCEED_FATAL(cuCtxSynchronize());
        $id:time_end = get_wall_time();
        fprintf(ctx-&gt;log, &quot;Kernel %s runtime: %ldus\n&quot;,
                $string:(pretty kernel_name), $id:time_end - $id:time_start);
      }
    }|]</span></span><span>
</span><span id="line-351"></span><span>
</span><span id="line-352"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; CompilerM OpenCL () () -&gt; CompilerM OpenCL () ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelSafety
</span><a href="#local-6989586621684546956"><span class="hs-identifier hs-var">safety</span></a></span><span> </span><span class="annot"><span class="annottext">KernelSafety -&gt; KernelSafety -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">KernelSafety
</span><a href="Futhark.CodeGen.ImpCode.OpenCL.html#SafetyFull"><span class="hs-identifier hs-var">SafetyFull</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(CompilerM OpenCL () () -&gt; CompilerM OpenCL () ())
-&gt; CompilerM OpenCL () () -&gt; CompilerM OpenCL () ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-353"></span><span>    </span><span class="annot"><span class="annottext">Stm -&gt; CompilerM OpenCL () ()
forall op s. Stm -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#stm"><span class="hs-identifier hs-var">GC.stm</span></a></span><span> </span><span class="annot"><span class="">[C.cstm|ctx-&gt;failure_is_an_option = 1;|]</span></span><span>
</span><span id="line-354"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-355"></span><span>    </span><span id="local-6989586621684546927"><span class="annot"><span class="annottext">mkDims :: [Exp] -&gt; (Exp, Exp, Exp)
</span><a href="#local-6989586621684546927"><span class="hs-identifier hs-var hs-var">mkDims</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="">[C.cexp|0|]</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="">[C.cexp|0|]</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="">[C.cexp|0|]</span></span><span class="hs-special">)</span><span>
</span><span id="line-356"></span><span>    </span><span class="annot"><a href="#local-6989586621684546927"><span class="hs-identifier hs-var">mkDims</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621684546895"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684546895"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684546895"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="">[C.cexp|1|]</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="">[C.cexp|1|]</span></span><span class="hs-special">)</span><span>
</span><span id="line-357"></span><span>    </span><span class="annot"><a href="#local-6989586621684546927"><span class="hs-identifier hs-var">mkDims</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621684546894"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684546894"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684546893"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684546893"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684546894"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684546893"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="">[C.cexp|1|]</span></span><span class="hs-special">)</span><span>
</span><span id="line-358"></span><span>    </span><span class="annot"><a href="#local-6989586621684546927"><span class="hs-identifier hs-var">mkDims</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684546892"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684546892"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684546891"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684546891"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684546890"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684546890"><span class="hs-identifier hs-var">z</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><span class="annottext">[Exp]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684546892"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684546891"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684546890"><span class="hs-identifier hs-var">z</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-359"></span><span>    </span><span id="local-6989586621684546885"><span class="annot"><span class="annottext">addExp :: a -&gt; a -&gt; Exp
</span><a href="#local-6989586621684546885"><span class="hs-identifier hs-var hs-var">addExp</span></a></span></span><span> </span><span id="local-6989586621684546884"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684546884"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621684546883"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684546883"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="">[C.cexp|$exp:x + $exp:y|]</span></span><span>
</span><span id="line-360"></span><span>    </span><span id="local-6989586621684546879"><span class="annot"><span class="annottext">alignExp :: a -&gt; Exp
</span><a href="#local-6989586621684546879"><span class="hs-identifier hs-var hs-var">alignExp</span></a></span></span><span> </span><span id="local-6989586621684546878"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684546878"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="">[C.cexp|$exp:e + ((8 - ($exp:e % 8)) % 8)|]</span></span><span>
</span><span id="line-361"></span><span>    </span><span id="local-6989586621684546940"><span class="annot"><span class="annottext">mkOffsets :: [VName] -&gt; [Exp]
</span><a href="#local-6989586621684546940"><span class="hs-identifier hs-var hs-var">mkOffsets</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; VName -&gt; Exp) -&gt; Exp -&gt; [VName] -&gt; [Exp]
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">scanl</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621684546871"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684546871"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621684546870"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684546870"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684546871"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Exp -&gt; Exp
forall {a} {a}. (ToExp a, ToExp a) =&gt; a -&gt; a -&gt; Exp
</span><a href="#local-6989586621684546885"><span class="hs-operator hs-var">`addExp`</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Exp
forall {a}. ToExp a =&gt; a -&gt; Exp
</span><a href="#local-6989586621684546879"><span class="hs-identifier hs-var">alignExp</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684546870"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="">[C.cexp|0|]</span></span><span>
</span><span id="line-362"></span><span>    </span><span id="local-6989586621684546867"><span class="annot"><span class="annottext">expNotZero :: a -&gt; Exp
</span><a href="#local-6989586621684546867"><span class="hs-identifier hs-var hs-var">expNotZero</span></a></span></span><span> </span><span id="local-6989586621684546866"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684546866"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="">[C.cexp|$exp:e != 0|]</span></span><span>
</span><span id="line-363"></span><span>    </span><span id="local-6989586621684546861"><span class="annot"><span class="annottext">expAnd :: a -&gt; a -&gt; Exp
</span><a href="#local-6989586621684546861"><span class="hs-identifier hs-var hs-var">expAnd</span></a></span></span><span> </span><span id="local-6989586621684546860"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684546860"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621684546859"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684546859"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="">[C.cexp|$exp:a &amp;&amp; $exp:b|]</span></span><span>
</span><span id="line-364"></span><span>    </span><span id="local-6989586621684546909"><span class="annot"><span class="annottext">expsNotZero :: [Exp] -&gt; Exp
</span><a href="#local-6989586621684546909"><span class="hs-identifier hs-var hs-var">expsNotZero</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; Exp -&gt; Exp) -&gt; Exp -&gt; [Exp] -&gt; Exp
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Exp -&gt; Exp
forall {a} {a}. (ToExp a, ToExp a) =&gt; a -&gt; a -&gt; Exp
</span><a href="#local-6989586621684546861"><span class="hs-identifier hs-var">expAnd</span></a></span><span> </span><span class="annot"><span class="">[C.cexp|1|]</span></span><span> </span><span class="annot"><span class="annottext">([Exp] -&gt; Exp) -&gt; ([Exp] -&gt; [Exp]) -&gt; [Exp] -&gt; Exp
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; Exp) -&gt; [Exp] -&gt; [Exp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Exp
forall {a}. ToExp a =&gt; a -&gt; Exp
</span><a href="#local-6989586621684546867"><span class="hs-identifier hs-var">expNotZero</span></a></span><span>
</span><span id="line-365"></span><span>    </span><span id="local-6989586621684546944"><span class="annot"><span class="annottext">mkArgs :: KernelArg -&gt; CompilerM op s (VName, Maybe (VName, VName))
</span><a href="#local-6989586621684546944"><span class="hs-identifier hs-var hs-var">mkArgs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.OpenCL.html#ValueKArg"><span class="hs-identifier hs-type">ValueKArg</span></a></span><span> </span><span id="local-6989586621684546826"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684546826"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621684546825"><span class="annot"><span class="annottext">t :: PrimType
</span><a href="#local-6989586621684546825"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Primitive.html#FloatType"><span class="hs-identifier hs-type">FloatType</span></a></span><span> </span><span class="annot"><span class="annottext">FloatType
</span><a href="Futhark.IR.Primitive.html#Float16"><span class="hs-identifier hs-var">Float16</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-366"></span><span>      </span><span id="local-6989586621684546822"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684546822"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; CompilerM op s VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; [Char] -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;kernel_arg&quot;</span></span><span>
</span><span id="line-367"></span><span>      </span><span id="local-6989586621684546821"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684546821"><span class="hs-identifier hs-var">e'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; CompilerM op s Exp
forall op s. Exp -&gt; CompilerM op s Exp
</span><a href="Futhark.CodeGen.Backends.GenericC.html#compileExp"><span class="hs-identifier hs-var">GC.compileExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684546826"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-368"></span><span>      </span><span class="annot"><span class="annottext">BlockItem -&gt; CompilerM op s ()
forall op s. BlockItem -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#item"><span class="hs-identifier hs-var">GC.item</span></a></span><span> </span><span class="annot"><span class="">[C.citem|$ty:(primStorageType t) $id:arg = $exp:(toStorage t e');|]</span></span><span>
</span><span id="line-369"></span><span>      </span><span class="annot"><span class="annottext">(VName, Maybe (VName, VName))
-&gt; CompilerM op s (VName, Maybe (VName, VName))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684546822"><span class="hs-identifier hs-var">arg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (VName, VName)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-370"></span><span>    </span><span class="annot"><a href="#local-6989586621684546944"><span class="hs-identifier hs-var">mkArgs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.OpenCL.html#ValueKArg"><span class="hs-identifier hs-type">ValueKArg</span></a></span><span> </span><span id="local-6989586621684546815"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684546815"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621684546814"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684546814"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-371"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-special">,</span></span><span class="annot"><span class="annottext">Maybe (VName, VName)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; (VName, Maybe (VName, VName)))
-&gt; CompilerM op s VName
-&gt; CompilerM op s (VName, Maybe (VName, VName))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; PrimType -&gt; Exp -&gt; CompilerM op s VName
forall op s. [Char] -&gt; PrimType -&gt; Exp -&gt; CompilerM op s VName
</span><a href="Futhark.CodeGen.Backends.GenericC.html#compileExpToName"><span class="hs-identifier hs-var">GC.compileExpToName</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;kernel_arg&quot;</span></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684546814"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684546815"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-372"></span><span>    </span><span class="annot"><a href="#local-6989586621684546944"><span class="hs-identifier hs-var">mkArgs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.OpenCL.html#MemKArg"><span class="hs-identifier hs-type">MemKArg</span></a></span><span> </span><span id="local-6989586621684546811"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684546811"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-373"></span><span>      </span><span id="local-6989586621684546810"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684546810"><span class="hs-identifier hs-var">v'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; CompilerM op s Exp
forall op s. VName -&gt; CompilerM op s Exp
</span><a href="Futhark.CodeGen.Backends.GenericC.html#rawMem"><span class="hs-identifier hs-var">GC.rawMem</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684546811"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-374"></span><span>      </span><span id="local-6989586621684546808"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684546808"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; CompilerM op s VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; [Char] -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;kernel_arg&quot;</span></span><span>
</span><span id="line-375"></span><span>      </span><span class="annot"><span class="annottext">InitGroup -&gt; CompilerM op s ()
forall op s. InitGroup -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#decl"><span class="hs-identifier hs-var">GC.decl</span></a></span><span> </span><span class="annot"><span class="">[C.cdecl|typename CUdeviceptr $id:arg = $exp:v';|]</span></span><span>
</span><span id="line-376"></span><span>      </span><span class="annot"><span class="annottext">(VName, Maybe (VName, VName))
-&gt; CompilerM op s (VName, Maybe (VName, VName))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684546808"><span class="hs-identifier hs-var">arg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (VName, VName)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-377"></span><span>    </span><span class="annot"><a href="#local-6989586621684546944"><span class="hs-identifier hs-var">mkArgs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.OpenCL.html#SharedMemoryKArg"><span class="hs-identifier hs-type">SharedMemoryKArg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-type">Count</span></a></span><span> </span><span id="local-6989586621684546805"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684546805"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-378"></span><span>      </span><span id="local-6989586621684546804"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684546804"><span class="hs-identifier hs-var">num_bytes</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; CompilerM op s Exp
forall op s. Exp -&gt; CompilerM op s Exp
</span><a href="Futhark.CodeGen.Backends.GenericC.html#compileExp"><span class="hs-identifier hs-var">GC.compileExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684546805"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-379"></span><span>      </span><span id="local-6989586621684546803"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684546803"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; CompilerM op s VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; [Char] -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;shared_size&quot;</span></span><span>
</span><span id="line-380"></span><span>      </span><span id="local-6989586621684546802"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684546802"><span class="hs-identifier hs-var">offset</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; CompilerM op s VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; [Char] -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;shared_offset&quot;</span></span><span>
</span><span id="line-381"></span><span>      </span><span class="annot"><span class="annottext">InitGroup -&gt; CompilerM op s ()
forall op s. InitGroup -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#decl"><span class="hs-identifier hs-var">GC.decl</span></a></span><span> </span><span class="annot"><span class="">[C.cdecl|unsigned int $id:size = $exp:num_bytes;|]</span></span><span>
</span><span id="line-382"></span><span>      </span><span class="annot"><span class="annottext">(VName, Maybe (VName, VName))
-&gt; CompilerM op s (VName, Maybe (VName, VName))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684546802"><span class="hs-identifier hs-var">offset</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(VName, VName) -&gt; Maybe (VName, VName)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684546803"><span class="hs-identifier hs-var">size</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684546802"><span class="hs-identifier hs-var">offset</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-383"></span></pre></body></html>