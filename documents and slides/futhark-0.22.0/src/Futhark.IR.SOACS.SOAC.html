<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span id="local-6989586621684375908"><span id="local-6989586621684375909"><span id="local-6989586621684375910"></span></span></span><span class="hs-pragma">{-# LANGUAGE ConstraintKinds #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE FlexibleInstances #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE UndecidableInstances #-}</span><span>
</span><span id="line-7"></span><span>
</span><span id="line-8"></span><span class="hs-comment">-- | Definition of /Second-Order Array Combinators/ (SOACs), which are</span><span>
</span><span id="line-9"></span><span class="hs-comment">-- the main form of parallelism in the early stages of the compiler.</span><span>
</span><span id="line-10"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Futhark.IR.SOACS.SOAC</span><span>
</span><span id="line-11"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#SOAC"><span class="hs-identifier">SOAC</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-12"></span><span>    </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#StreamOrd"><span class="hs-identifier">StreamOrd</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-13"></span><span>    </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#StreamForm"><span class="hs-identifier">StreamForm</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-14"></span><span>    </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#ScremaForm"><span class="hs-identifier">ScremaForm</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-15"></span><span>    </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#HistOp"><span class="hs-identifier">HistOp</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-16"></span><span>    </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Scan"><span class="hs-identifier">Scan</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-17"></span><span>    </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#scanResults"><span class="hs-identifier">scanResults</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-18"></span><span>    </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#singleScan"><span class="hs-identifier">singleScan</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-19"></span><span>    </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Reduce"><span class="hs-identifier">Reduce</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-20"></span><span>    </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#redResults"><span class="hs-identifier">redResults</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-21"></span><span>    </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#singleReduce"><span class="hs-identifier">singleReduce</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-22"></span><span>
</span><span id="line-23"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Utility</span></span><span>
</span><span id="line-24"></span><span>    </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#scremaType"><span class="hs-identifier">scremaType</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-25"></span><span>    </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#soacType"><span class="hs-identifier">soacType</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-26"></span><span>    </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#typeCheckSOAC"><span class="hs-identifier">typeCheckSOAC</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-27"></span><span>    </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#mkIdentityLambda"><span class="hs-identifier">mkIdentityLambda</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-28"></span><span>    </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#isIdentityLambda"><span class="hs-identifier">isIdentityLambda</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-29"></span><span>    </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#nilFn"><span class="hs-identifier">nilFn</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-30"></span><span>    </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#scanomapSOAC"><span class="hs-identifier">scanomapSOAC</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-31"></span><span>    </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#redomapSOAC"><span class="hs-identifier">redomapSOAC</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-32"></span><span>    </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#scanSOAC"><span class="hs-identifier">scanSOAC</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-33"></span><span>    </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#reduceSOAC"><span class="hs-identifier">reduceSOAC</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-34"></span><span>    </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#mapSOAC"><span class="hs-identifier">mapSOAC</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-35"></span><span>    </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#isScanomapSOAC"><span class="hs-identifier">isScanomapSOAC</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-36"></span><span>    </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#isRedomapSOAC"><span class="hs-identifier">isRedomapSOAC</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-37"></span><span>    </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#isScanSOAC"><span class="hs-identifier">isScanSOAC</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-38"></span><span>    </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#isReduceSOAC"><span class="hs-identifier">isReduceSOAC</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-39"></span><span>    </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#isMapSOAC"><span class="hs-identifier">isMapSOAC</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-40"></span><span>    </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#scremaLambda"><span class="hs-identifier">scremaLambda</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-41"></span><span>    </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#ppScrema"><span class="hs-identifier">ppScrema</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-42"></span><span>    </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#ppHist"><span class="hs-identifier">ppHist</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-43"></span><span>    </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#groupScatterResults"><span class="hs-identifier">groupScatterResults</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-44"></span><span>    </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#groupScatterResults%27"><span class="hs-identifier">groupScatterResults'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-45"></span><span>    </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#splitScatterResults"><span class="hs-identifier">splitScatterResults</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-46"></span><span>
</span><span id="line-47"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Generic traversal</span></span><span>
</span><span id="line-48"></span><span>    </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#SOACMapper"><span class="hs-identifier">SOACMapper</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-49"></span><span>    </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#identitySOACMapper"><span class="hs-identifier">identitySOACMapper</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-50"></span><span>    </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#mapSOACM"><span class="hs-identifier">mapSOACM</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-51"></span><span>    </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#traverseSOACStms"><span class="hs-identifier">traverseSOACStms</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-52"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span class="hs-keyword">where</span><span>
</span><span id="line-54"></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Category</span></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Identity</span></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.State.Strict</span></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Writer</span></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Function</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-operator">(&amp;)</span></span><span class="hs-special">)</span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">intersperse</span></span><span class="hs-special">)</span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map.Strict</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.Analysis.Alias.html"><span class="hs-identifier">Futhark.Analysis.Alias</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Alias</span></span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Analysis.Metrics.html"><span class="hs-identifier">Futhark.Analysis.Metrics</span></a></span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Analysis.PrimExp.Convert.html"><span class="hs-identifier">Futhark.Analysis.PrimExp.Convert</span></a></span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.Analysis.SymbolTable.html"><span class="hs-identifier">Futhark.Analysis.SymbolTable</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">ST</span></span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Construct.html"><span class="hs-identifier">Futhark.Construct</span></a></span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.html"><span class="hs-identifier">Futhark.IR</span></a></span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.Aliases.html"><span class="hs-identifier">Futhark.IR.Aliases</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Aliases.html#Aliases"><span class="hs-identifier">Aliases</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Aliases.html#removeLambdaAliases"><span class="hs-identifier">removeLambdaAliases</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Aliases.html"><span class="hs-identifier">Futhark.IR.Prop.Aliases</span></a></span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.IR.TypeCheck.html"><span class="hs-identifier">Futhark.IR.TypeCheck</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TC</span></span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html"><span class="hs-identifier">Futhark.Optimise.Simplify.Rep</span></a></span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Transform.Rename.html"><span class="hs-identifier">Futhark.Transform.Rename</span></a></span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Transform.Substitute.html"><span class="hs-identifier">Futhark.Transform.Substitute</span></a></span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Util.html"><span class="hs-identifier">Futhark.Util</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Util.html#chunks"><span class="hs-identifier">chunks</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Util.html#maybeNth"><span class="hs-identifier">maybeNth</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Util.Pretty.html"><span class="hs-identifier">Futhark.Util.Pretty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Doc</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Pretty</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">comma</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">commasep</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">parens</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">ppr</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">text</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-operator">(&lt;+&gt;)</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-operator">(&lt;/&gt;)</span></span><span class="hs-special">)</span><span>
</span><span id="line-77"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.Util.Pretty.html"><span class="hs-identifier">Futhark.Util.Pretty</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">PP</span></span><span>
</span><span id="line-78"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Prelude</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">id</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-operator">(.)</span></span><span class="hs-special">)</span><span>
</span><span id="line-79"></span><span>
</span><span id="line-80"></span><span class="hs-comment">-- | A second-order array combinator (SOAC).</span><span>
</span><span id="line-81"></span><span class="hs-keyword">data</span><span> </span><span id="SOAC"><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#SOAC"><span class="hs-identifier hs-var">SOAC</span></a></span></span><span> </span><span id="local-6989586621684376490"><span class="annot"><a href="#local-6989586621684376490"><span class="hs-identifier hs-type">rep</span></a></span></span><span>
</span><span id="line-82"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="Stream"><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#StreamForm"><span class="hs-identifier hs-type">StreamForm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376490"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376490"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-83"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-comment">-- | @Scatter &lt;length&gt; &lt;lambda&gt; &lt;inputs&gt; &lt;outputs&gt;@</span><span>
</span><span id="line-84"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-85"></span><span>    </span><span class="hs-comment">-- Scatter maps values from a set of input arrays to indices and values of a</span><span>
</span><span id="line-86"></span><span>    </span><span class="hs-comment">-- set of output arrays. It is able to write multiple values to multiple</span><span>
</span><span id="line-87"></span><span>    </span><span class="hs-comment">-- outputs each of which may have multiple dimensions.</span><span>
</span><span id="line-88"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-89"></span><span>    </span><span class="hs-comment">-- &lt;inputs&gt; is a list of input arrays, all having size &lt;length&gt;, elements of</span><span>
</span><span id="line-90"></span><span>    </span><span class="hs-comment">-- which are applied to the &lt;lambda&gt; function. For instance, if there are</span><span>
</span><span id="line-91"></span><span>    </span><span class="hs-comment">-- two arrays, &lt;lambda&gt; will get two values as input, one from each array.</span><span>
</span><span id="line-92"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-93"></span><span>    </span><span class="hs-comment">-- &lt;outputs&gt; specifies the result of the &lt;lambda&gt; and which arrays to write</span><span>
</span><span id="line-94"></span><span>    </span><span class="hs-comment">-- to. Each element of the list consists of a &lt;VName&gt; specifying which array</span><span>
</span><span id="line-95"></span><span>    </span><span class="hs-comment">-- to scatter to, a &lt;Shape&gt; describing the shape of that array, and an &lt;Int&gt;</span><span>
</span><span id="line-96"></span><span>    </span><span class="hs-comment">-- describing how many elements should be written to that array for each</span><span>
</span><span id="line-97"></span><span>    </span><span class="hs-comment">-- invocation of the &lt;lambda&gt;.</span><span>
</span><span id="line-98"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-99"></span><span>    </span><span class="hs-comment">-- &lt;lambda&gt; is a function that takes inputs from &lt;inputs&gt; and returns values</span><span>
</span><span id="line-100"></span><span>    </span><span class="hs-comment">-- according to the output-specification in &lt;outputs&gt;. It returns values in</span><span>
</span><span id="line-101"></span><span>    </span><span class="hs-comment">-- the following manner:</span><span>
</span><span id="line-102"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-103"></span><span>    </span><span class="hs-comment">--     [index_0, index_1, ..., index_n, value_0, value_1, ..., value_m]</span><span>
</span><span id="line-104"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-105"></span><span>    </span><span class="hs-comment">-- For each output in &lt;outputs&gt;, &lt;lambda&gt; returns &lt;i&gt; * &lt;j&gt; index values and</span><span>
</span><span id="line-106"></span><span>    </span><span class="hs-comment">-- &lt;j&gt; output values, where &lt;i&gt; is the number of dimensions (rank) of the</span><span>
</span><span id="line-107"></span><span>    </span><span class="hs-comment">-- given output, and &lt;j&gt; is the number of output values written to the given</span><span>
</span><span id="line-108"></span><span>    </span><span class="hs-comment">-- output.</span><span>
</span><span id="line-109"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-110"></span><span>    </span><span class="hs-comment">-- For example, given the following output specification:</span><span>
</span><span id="line-111"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-112"></span><span>    </span><span class="hs-comment">--     [([x1, y1, z1], 2, arr1), ([x2, y2], 1, arr2)]</span><span>
</span><span id="line-113"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-114"></span><span>    </span><span class="hs-comment">-- &lt;lambda&gt; will produce 6 (3 * 2) index values and 2 output values for</span><span>
</span><span id="line-115"></span><span>    </span><span class="hs-comment">-- &lt;arr1&gt;, and 2 (2 * 1) index values and 1 output value for</span><span>
</span><span id="line-116"></span><span>    </span><span class="hs-comment">-- arr2. Additionally, the results are grouped, so the first 6 index values</span><span>
</span><span id="line-117"></span><span>    </span><span class="hs-comment">-- will correspond to the first two output values, and so on. For this</span><span>
</span><span id="line-118"></span><span>    </span><span class="hs-comment">-- example, &lt;lambda&gt; should return a total of 11 values, 8 index values and</span><span>
</span><span id="line-119"></span><span>    </span><span class="hs-comment">-- 3 output values.</span><span>
</span><span id="line-120"></span><span>    </span><span id="Scatter"><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Scatter"><span class="hs-identifier hs-var">Scatter</span></a></span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376490"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-type">Shape</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-121"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-comment">-- | @Hist &lt;length&gt; &lt;dest-arrays-and-ops&gt; &lt;bucket fun&gt; &lt;input arrays&gt;@</span><span>
</span><span id="line-122"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-123"></span><span>    </span><span class="hs-comment">-- The first SubExp is the length of the input arrays. The first</span><span>
</span><span id="line-124"></span><span>    </span><span class="hs-comment">-- list describes the operations to perform.  The t'Lambda' is the</span><span>
</span><span id="line-125"></span><span>    </span><span class="hs-comment">-- bucket function.  Finally comes the input images.</span><span>
</span><span id="line-126"></span><span>    </span><span id="Hist"><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Hist"><span class="hs-identifier hs-var">Hist</span></a></span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#HistOp"><span class="hs-identifier hs-type">HistOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376490"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376490"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-127"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-comment">-- FIXME: this should not be here</span><span>
</span><span id="line-128"></span><span>    </span><span id="JVP"><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#JVP"><span class="hs-identifier hs-var">JVP</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376490"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-129"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-comment">-- FIXME: this should not be here</span><span>
</span><span id="line-130"></span><span>    </span><span id="VJP"><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#VJP"><span class="hs-identifier hs-var">VJP</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376490"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-131"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-comment">-- | A combination of scan, reduction, and map.  The first</span><span>
</span><span id="line-132"></span><span>    </span><span class="hs-comment">-- t'SubExp' is the size of the input arrays.</span><span>
</span><span id="line-133"></span><span>    </span><span id="Screma"><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Screma"><span class="hs-identifier hs-var">Screma</span></a></span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#ScremaForm"><span class="hs-identifier hs-type">ScremaForm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376490"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-134"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684375823"><span id="local-6989586621684375853"><span class="annot"><span class="annottext">SOAC rep -&gt; SOAC rep -&gt; Bool
(SOAC rep -&gt; SOAC rep -&gt; Bool)
-&gt; (SOAC rep -&gt; SOAC rep -&gt; Bool) -&gt; Eq (SOAC rep)
forall rep. RepTypes rep =&gt; SOAC rep -&gt; SOAC rep -&gt; Bool
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: SOAC rep -&gt; SOAC rep -&gt; Bool
$c/= :: forall rep. RepTypes rep =&gt; SOAC rep -&gt; SOAC rep -&gt; Bool
== :: SOAC rep -&gt; SOAC rep -&gt; Bool
$c== :: forall rep. RepTypes rep =&gt; SOAC rep -&gt; SOAC rep -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684375773"><span id="local-6989586621684375775"><span id="local-6989586621684375777"><span id="local-6989586621684375779"><span id="local-6989586621684375781"><span id="local-6989586621684375783"><span id="local-6989586621684375812"><span class="annot"><span class="annottext">Eq (SOAC rep)
Eq (SOAC rep)
-&gt; (SOAC rep -&gt; SOAC rep -&gt; Ordering)
-&gt; (SOAC rep -&gt; SOAC rep -&gt; Bool)
-&gt; (SOAC rep -&gt; SOAC rep -&gt; Bool)
-&gt; (SOAC rep -&gt; SOAC rep -&gt; Bool)
-&gt; (SOAC rep -&gt; SOAC rep -&gt; Bool)
-&gt; (SOAC rep -&gt; SOAC rep -&gt; SOAC rep)
-&gt; (SOAC rep -&gt; SOAC rep -&gt; SOAC rep)
-&gt; Ord (SOAC rep)
SOAC rep -&gt; SOAC rep -&gt; Bool
SOAC rep -&gt; SOAC rep -&gt; Ordering
SOAC rep -&gt; SOAC rep -&gt; SOAC rep
forall a.
Eq a
-&gt; (a -&gt; a -&gt; Ordering)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; a)
-&gt; (a -&gt; a -&gt; a)
-&gt; Ord a
forall rep. RepTypes rep =&gt; Eq (SOAC rep)
forall rep. RepTypes rep =&gt; SOAC rep -&gt; SOAC rep -&gt; Bool
forall rep. RepTypes rep =&gt; SOAC rep -&gt; SOAC rep -&gt; Ordering
forall rep. RepTypes rep =&gt; SOAC rep -&gt; SOAC rep -&gt; SOAC rep
min :: SOAC rep -&gt; SOAC rep -&gt; SOAC rep
$cmin :: forall rep. RepTypes rep =&gt; SOAC rep -&gt; SOAC rep -&gt; SOAC rep
max :: SOAC rep -&gt; SOAC rep -&gt; SOAC rep
$cmax :: forall rep. RepTypes rep =&gt; SOAC rep -&gt; SOAC rep -&gt; SOAC rep
&gt;= :: SOAC rep -&gt; SOAC rep -&gt; Bool
$c&gt;= :: forall rep. RepTypes rep =&gt; SOAC rep -&gt; SOAC rep -&gt; Bool
&gt; :: SOAC rep -&gt; SOAC rep -&gt; Bool
$c&gt; :: forall rep. RepTypes rep =&gt; SOAC rep -&gt; SOAC rep -&gt; Bool
&lt;= :: SOAC rep -&gt; SOAC rep -&gt; Bool
$c&lt;= :: forall rep. RepTypes rep =&gt; SOAC rep -&gt; SOAC rep -&gt; Bool
&lt; :: SOAC rep -&gt; SOAC rep -&gt; Bool
$c&lt; :: forall rep. RepTypes rep =&gt; SOAC rep -&gt; SOAC rep -&gt; Bool
compare :: SOAC rep -&gt; SOAC rep -&gt; Ordering
$ccompare :: forall rep. RepTypes rep =&gt; SOAC rep -&gt; SOAC rep -&gt; Ordering
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Ord</span></span></span></span></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684375727"><span id="local-6989586621684375729"><span id="local-6989586621684375765"><span class="annot"><span class="annottext">Int -&gt; SOAC rep -&gt; ShowS
[SOAC rep] -&gt; ShowS
SOAC rep -&gt; String
(Int -&gt; SOAC rep -&gt; ShowS)
-&gt; (SOAC rep -&gt; String) -&gt; ([SOAC rep] -&gt; ShowS) -&gt; Show (SOAC rep)
forall rep. RepTypes rep =&gt; Int -&gt; SOAC rep -&gt; ShowS
forall rep. RepTypes rep =&gt; [SOAC rep] -&gt; ShowS
forall rep. RepTypes rep =&gt; SOAC rep -&gt; String
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [SOAC rep] -&gt; ShowS
$cshowList :: forall rep. RepTypes rep =&gt; [SOAC rep] -&gt; ShowS
show :: SOAC rep -&gt; String
$cshow :: forall rep. RepTypes rep =&gt; SOAC rep -&gt; String
showsPrec :: Int -&gt; SOAC rep -&gt; ShowS
$cshowsPrec :: forall rep. RepTypes rep =&gt; Int -&gt; SOAC rep -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-135"></span><span>
</span><span id="line-136"></span><span class="hs-comment">-- | Information about computing a single histogram.</span><span>
</span><span id="line-137"></span><span class="hs-keyword">data</span><span> </span><span id="HistOp"><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#HistOp"><span class="hs-identifier hs-var">HistOp</span></a></span></span><span> </span><span id="local-6989586621684376474"><span class="annot"><a href="#local-6989586621684376474"><span class="hs-identifier hs-type">rep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="HistOp"><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#HistOp"><span class="hs-identifier hs-var">HistOp</span></a></span></span><span>
</span><span id="line-138"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="histShape"><span class="annot"><span class="annottext">forall rep. HistOp rep -&gt; Shape
</span><a href="Futhark.IR.SOACS.SOAC.html#histShape"><span class="hs-identifier hs-var hs-var">histShape</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-type">Shape</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-139"></span><span>    </span><span class="hs-comment">-- | Race factor @RF@ means that only @1/RF@</span><span>
</span><span id="line-140"></span><span>    </span><span class="hs-comment">-- bins are used.</span><span>
</span><span id="line-141"></span><span>    </span><span id="histRaceFactor"><span class="annot"><span class="annottext">forall rep. HistOp rep -&gt; SubExp
</span><a href="Futhark.IR.SOACS.SOAC.html#histRaceFactor"><span class="hs-identifier hs-var hs-var">histRaceFactor</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-142"></span><span>    </span><span id="histDest"><span class="annot"><span class="annottext">forall rep. HistOp rep -&gt; [VName]
</span><a href="Futhark.IR.SOACS.SOAC.html#histDest"><span class="hs-identifier hs-var hs-var">histDest</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><span id="line-143"></span><span>    </span><span id="histNeutral"><span class="annot"><span class="annottext">forall rep. HistOp rep -&gt; [SubExp]
</span><a href="Futhark.IR.SOACS.SOAC.html#histNeutral"><span class="hs-identifier hs-var hs-var">histNeutral</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><span id="line-144"></span><span>    </span><span id="histOp"><span class="annot"><span class="annottext">forall rep. HistOp rep -&gt; Lambda rep
</span><a href="Futhark.IR.SOACS.SOAC.html#histOp"><span class="hs-identifier hs-var hs-var">histOp</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376474"><span class="hs-identifier hs-type">rep</span></a></span><span>
</span><span id="line-145"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-146"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684375703"><span id="local-6989586621684375712"><span class="annot"><span class="annottext">HistOp rep -&gt; HistOp rep -&gt; Bool
(HistOp rep -&gt; HistOp rep -&gt; Bool)
-&gt; (HistOp rep -&gt; HistOp rep -&gt; Bool) -&gt; Eq (HistOp rep)
forall rep. RepTypes rep =&gt; HistOp rep -&gt; HistOp rep -&gt; Bool
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: HistOp rep -&gt; HistOp rep -&gt; Bool
$c/= :: forall rep. RepTypes rep =&gt; HistOp rep -&gt; HistOp rep -&gt; Bool
== :: HistOp rep -&gt; HistOp rep -&gt; Bool
$c== :: forall rep. RepTypes rep =&gt; HistOp rep -&gt; HistOp rep -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684375672"><span id="local-6989586621684375674"><span id="local-6989586621684375677"><span id="local-6989586621684375680"><span id="local-6989586621684375683"><span id="local-6989586621684375691"><span id="local-6989586621684375699"><span class="annot"><span class="annottext">Eq (HistOp rep)
Eq (HistOp rep)
-&gt; (HistOp rep -&gt; HistOp rep -&gt; Ordering)
-&gt; (HistOp rep -&gt; HistOp rep -&gt; Bool)
-&gt; (HistOp rep -&gt; HistOp rep -&gt; Bool)
-&gt; (HistOp rep -&gt; HistOp rep -&gt; Bool)
-&gt; (HistOp rep -&gt; HistOp rep -&gt; Bool)
-&gt; (HistOp rep -&gt; HistOp rep -&gt; HistOp rep)
-&gt; (HistOp rep -&gt; HistOp rep -&gt; HistOp rep)
-&gt; Ord (HistOp rep)
HistOp rep -&gt; HistOp rep -&gt; Bool
HistOp rep -&gt; HistOp rep -&gt; Ordering
HistOp rep -&gt; HistOp rep -&gt; HistOp rep
forall a.
Eq a
-&gt; (a -&gt; a -&gt; Ordering)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; a)
-&gt; (a -&gt; a -&gt; a)
-&gt; Ord a
forall rep. RepTypes rep =&gt; Eq (HistOp rep)
forall rep. RepTypes rep =&gt; HistOp rep -&gt; HistOp rep -&gt; Bool
forall rep. RepTypes rep =&gt; HistOp rep -&gt; HistOp rep -&gt; Ordering
forall rep. RepTypes rep =&gt; HistOp rep -&gt; HistOp rep -&gt; HistOp rep
min :: HistOp rep -&gt; HistOp rep -&gt; HistOp rep
$cmin :: forall rep. RepTypes rep =&gt; HistOp rep -&gt; HistOp rep -&gt; HistOp rep
max :: HistOp rep -&gt; HistOp rep -&gt; HistOp rep
$cmax :: forall rep. RepTypes rep =&gt; HistOp rep -&gt; HistOp rep -&gt; HistOp rep
&gt;= :: HistOp rep -&gt; HistOp rep -&gt; Bool
$c&gt;= :: forall rep. RepTypes rep =&gt; HistOp rep -&gt; HistOp rep -&gt; Bool
&gt; :: HistOp rep -&gt; HistOp rep -&gt; Bool
$c&gt; :: forall rep. RepTypes rep =&gt; HistOp rep -&gt; HistOp rep -&gt; Bool
&lt;= :: HistOp rep -&gt; HistOp rep -&gt; Bool
$c&lt;= :: forall rep. RepTypes rep =&gt; HistOp rep -&gt; HistOp rep -&gt; Bool
&lt; :: HistOp rep -&gt; HistOp rep -&gt; Bool
$c&lt; :: forall rep. RepTypes rep =&gt; HistOp rep -&gt; HistOp rep -&gt; Bool
compare :: HistOp rep -&gt; HistOp rep -&gt; Ordering
$ccompare :: forall rep. RepTypes rep =&gt; HistOp rep -&gt; HistOp rep -&gt; Ordering
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Ord</span></span></span></span></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684375658"><span id="local-6989586621684375660"><span id="local-6989586621684375670"><span class="annot"><span class="annottext">Int -&gt; HistOp rep -&gt; ShowS
[HistOp rep] -&gt; ShowS
HistOp rep -&gt; String
(Int -&gt; HistOp rep -&gt; ShowS)
-&gt; (HistOp rep -&gt; String)
-&gt; ([HistOp rep] -&gt; ShowS)
-&gt; Show (HistOp rep)
forall rep. RepTypes rep =&gt; Int -&gt; HistOp rep -&gt; ShowS
forall rep. RepTypes rep =&gt; [HistOp rep] -&gt; ShowS
forall rep. RepTypes rep =&gt; HistOp rep -&gt; String
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [HistOp rep] -&gt; ShowS
$cshowList :: forall rep. RepTypes rep =&gt; [HistOp rep] -&gt; ShowS
show :: HistOp rep -&gt; String
$cshow :: forall rep. RepTypes rep =&gt; HistOp rep -&gt; String
showsPrec :: Int -&gt; HistOp rep -&gt; ShowS
$cshowsPrec :: forall rep. RepTypes rep =&gt; Int -&gt; HistOp rep -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-147"></span><span>
</span><span id="line-148"></span><span class="hs-comment">-- | Is the stream chunk required to correspond to a contiguous</span><span>
</span><span id="line-149"></span><span class="hs-comment">-- subsequence of the original input ('InOrder') or not?  'Disorder'</span><span>
</span><span id="line-150"></span><span class="hs-comment">-- streams can be more efficient, but not all algorithms work with</span><span>
</span><span id="line-151"></span><span class="hs-comment">-- this.</span><span>
</span><span id="line-152"></span><span class="hs-keyword">data</span><span> </span><span id="StreamOrd"><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#StreamOrd"><span class="hs-identifier hs-var">StreamOrd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="InOrder"><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#InOrder"><span class="hs-identifier hs-var">InOrder</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="Disorder"><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Disorder"><span class="hs-identifier hs-var">Disorder</span></a></span></span><span>
</span><span id="line-153"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684375652"><span id="local-6989586621684375654"><span class="annot"><span class="annottext">StreamOrd -&gt; StreamOrd -&gt; Bool
(StreamOrd -&gt; StreamOrd -&gt; Bool)
-&gt; (StreamOrd -&gt; StreamOrd -&gt; Bool) -&gt; Eq StreamOrd
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: StreamOrd -&gt; StreamOrd -&gt; Bool
$c/= :: StreamOrd -&gt; StreamOrd -&gt; Bool
== :: StreamOrd -&gt; StreamOrd -&gt; Bool
$c== :: StreamOrd -&gt; StreamOrd -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684375633"><span id="local-6989586621684375635"><span id="local-6989586621684375638"><span id="local-6989586621684375641"><span id="local-6989586621684375644"><span id="local-6989586621684375646"><span id="local-6989586621684375648"><span class="annot"><span class="annottext">Eq StreamOrd
Eq StreamOrd
-&gt; (StreamOrd -&gt; StreamOrd -&gt; Ordering)
-&gt; (StreamOrd -&gt; StreamOrd -&gt; Bool)
-&gt; (StreamOrd -&gt; StreamOrd -&gt; Bool)
-&gt; (StreamOrd -&gt; StreamOrd -&gt; Bool)
-&gt; (StreamOrd -&gt; StreamOrd -&gt; Bool)
-&gt; (StreamOrd -&gt; StreamOrd -&gt; StreamOrd)
-&gt; (StreamOrd -&gt; StreamOrd -&gt; StreamOrd)
-&gt; Ord StreamOrd
StreamOrd -&gt; StreamOrd -&gt; Bool
StreamOrd -&gt; StreamOrd -&gt; Ordering
StreamOrd -&gt; StreamOrd -&gt; StreamOrd
forall a.
Eq a
-&gt; (a -&gt; a -&gt; Ordering)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; a)
-&gt; (a -&gt; a -&gt; a)
-&gt; Ord a
min :: StreamOrd -&gt; StreamOrd -&gt; StreamOrd
$cmin :: StreamOrd -&gt; StreamOrd -&gt; StreamOrd
max :: StreamOrd -&gt; StreamOrd -&gt; StreamOrd
$cmax :: StreamOrd -&gt; StreamOrd -&gt; StreamOrd
&gt;= :: StreamOrd -&gt; StreamOrd -&gt; Bool
$c&gt;= :: StreamOrd -&gt; StreamOrd -&gt; Bool
&gt; :: StreamOrd -&gt; StreamOrd -&gt; Bool
$c&gt; :: StreamOrd -&gt; StreamOrd -&gt; Bool
&lt;= :: StreamOrd -&gt; StreamOrd -&gt; Bool
$c&lt;= :: StreamOrd -&gt; StreamOrd -&gt; Bool
&lt; :: StreamOrd -&gt; StreamOrd -&gt; Bool
$c&lt; :: StreamOrd -&gt; StreamOrd -&gt; Bool
compare :: StreamOrd -&gt; StreamOrd -&gt; Ordering
$ccompare :: StreamOrd -&gt; StreamOrd -&gt; Ordering
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Ord</span></span></span></span></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684375627"><span id="local-6989586621684375629"><span id="local-6989586621684375631"><span class="annot"><span class="annottext">Int -&gt; StreamOrd -&gt; ShowS
[StreamOrd] -&gt; ShowS
StreamOrd -&gt; String
(Int -&gt; StreamOrd -&gt; ShowS)
-&gt; (StreamOrd -&gt; String)
-&gt; ([StreamOrd] -&gt; ShowS)
-&gt; Show StreamOrd
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [StreamOrd] -&gt; ShowS
$cshowList :: [StreamOrd] -&gt; ShowS
show :: StreamOrd -&gt; String
$cshow :: StreamOrd -&gt; String
showsPrec :: Int -&gt; StreamOrd -&gt; ShowS
$cshowsPrec :: Int -&gt; StreamOrd -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-154"></span><span>
</span><span id="line-155"></span><span class="hs-comment">-- | What kind of stream is this?</span><span>
</span><span id="line-156"></span><span class="hs-keyword">data</span><span> </span><span id="StreamForm"><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#StreamForm"><span class="hs-identifier hs-var">StreamForm</span></a></span></span><span> </span><span id="local-6989586621684376491"><span class="annot"><a href="#local-6989586621684376491"><span class="hs-identifier hs-type">rep</span></a></span></span><span>
</span><span id="line-157"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="Parallel"><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Parallel"><span class="hs-identifier hs-var">Parallel</span></a></span></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#StreamOrd"><span class="hs-identifier hs-type">StreamOrd</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Commutativity"><span class="hs-identifier hs-type">Commutativity</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376491"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-158"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="Sequential"><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Sequential"><span class="hs-identifier hs-var">Sequential</span></a></span></span><span>
</span><span id="line-159"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684375617"><span id="local-6989586621684375623"><span class="annot"><span class="annottext">StreamForm rep -&gt; StreamForm rep -&gt; Bool
(StreamForm rep -&gt; StreamForm rep -&gt; Bool)
-&gt; (StreamForm rep -&gt; StreamForm rep -&gt; Bool)
-&gt; Eq (StreamForm rep)
forall rep.
RepTypes rep =&gt;
StreamForm rep -&gt; StreamForm rep -&gt; Bool
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: StreamForm rep -&gt; StreamForm rep -&gt; Bool
$c/= :: forall rep.
RepTypes rep =&gt;
StreamForm rep -&gt; StreamForm rep -&gt; Bool
== :: StreamForm rep -&gt; StreamForm rep -&gt; Bool
$c== :: forall rep.
RepTypes rep =&gt;
StreamForm rep -&gt; StreamForm rep -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684375591"><span id="local-6989586621684375593"><span id="local-6989586621684375596"><span id="local-6989586621684375599"><span id="local-6989586621684375602"><span id="local-6989586621684375607"><span id="local-6989586621684375613"><span class="annot"><span class="annottext">Eq (StreamForm rep)
Eq (StreamForm rep)
-&gt; (StreamForm rep -&gt; StreamForm rep -&gt; Ordering)
-&gt; (StreamForm rep -&gt; StreamForm rep -&gt; Bool)
-&gt; (StreamForm rep -&gt; StreamForm rep -&gt; Bool)
-&gt; (StreamForm rep -&gt; StreamForm rep -&gt; Bool)
-&gt; (StreamForm rep -&gt; StreamForm rep -&gt; Bool)
-&gt; (StreamForm rep -&gt; StreamForm rep -&gt; StreamForm rep)
-&gt; (StreamForm rep -&gt; StreamForm rep -&gt; StreamForm rep)
-&gt; Ord (StreamForm rep)
StreamForm rep -&gt; StreamForm rep -&gt; Bool
StreamForm rep -&gt; StreamForm rep -&gt; Ordering
StreamForm rep -&gt; StreamForm rep -&gt; StreamForm rep
forall a.
Eq a
-&gt; (a -&gt; a -&gt; Ordering)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; a)
-&gt; (a -&gt; a -&gt; a)
-&gt; Ord a
forall rep. RepTypes rep =&gt; Eq (StreamForm rep)
forall rep.
RepTypes rep =&gt;
StreamForm rep -&gt; StreamForm rep -&gt; Bool
forall rep.
RepTypes rep =&gt;
StreamForm rep -&gt; StreamForm rep -&gt; Ordering
forall rep.
RepTypes rep =&gt;
StreamForm rep -&gt; StreamForm rep -&gt; StreamForm rep
min :: StreamForm rep -&gt; StreamForm rep -&gt; StreamForm rep
$cmin :: forall rep.
RepTypes rep =&gt;
StreamForm rep -&gt; StreamForm rep -&gt; StreamForm rep
max :: StreamForm rep -&gt; StreamForm rep -&gt; StreamForm rep
$cmax :: forall rep.
RepTypes rep =&gt;
StreamForm rep -&gt; StreamForm rep -&gt; StreamForm rep
&gt;= :: StreamForm rep -&gt; StreamForm rep -&gt; Bool
$c&gt;= :: forall rep.
RepTypes rep =&gt;
StreamForm rep -&gt; StreamForm rep -&gt; Bool
&gt; :: StreamForm rep -&gt; StreamForm rep -&gt; Bool
$c&gt; :: forall rep.
RepTypes rep =&gt;
StreamForm rep -&gt; StreamForm rep -&gt; Bool
&lt;= :: StreamForm rep -&gt; StreamForm rep -&gt; Bool
$c&lt;= :: forall rep.
RepTypes rep =&gt;
StreamForm rep -&gt; StreamForm rep -&gt; Bool
&lt; :: StreamForm rep -&gt; StreamForm rep -&gt; Bool
$c&lt; :: forall rep.
RepTypes rep =&gt;
StreamForm rep -&gt; StreamForm rep -&gt; Bool
compare :: StreamForm rep -&gt; StreamForm rep -&gt; Ordering
$ccompare :: forall rep.
RepTypes rep =&gt;
StreamForm rep -&gt; StreamForm rep -&gt; Ordering
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Ord</span></span></span></span></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684375580"><span id="local-6989586621684375582"><span id="local-6989586621684375589"><span class="annot"><span class="annottext">Int -&gt; StreamForm rep -&gt; ShowS
[StreamForm rep] -&gt; ShowS
StreamForm rep -&gt; String
(Int -&gt; StreamForm rep -&gt; ShowS)
-&gt; (StreamForm rep -&gt; String)
-&gt; ([StreamForm rep] -&gt; ShowS)
-&gt; Show (StreamForm rep)
forall rep. RepTypes rep =&gt; Int -&gt; StreamForm rep -&gt; ShowS
forall rep. RepTypes rep =&gt; [StreamForm rep] -&gt; ShowS
forall rep. RepTypes rep =&gt; StreamForm rep -&gt; String
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [StreamForm rep] -&gt; ShowS
$cshowList :: forall rep. RepTypes rep =&gt; [StreamForm rep] -&gt; ShowS
show :: StreamForm rep -&gt; String
$cshow :: forall rep. RepTypes rep =&gt; StreamForm rep -&gt; String
showsPrec :: Int -&gt; StreamForm rep -&gt; ShowS
$cshowsPrec :: forall rep. RepTypes rep =&gt; Int -&gt; StreamForm rep -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-160"></span><span>
</span><span id="line-161"></span><span class="hs-comment">-- | The essential parts of a 'Screma' factored out (everything</span><span>
</span><span id="line-162"></span><span class="hs-comment">-- except the input arrays).</span><span>
</span><span id="line-163"></span><span class="hs-keyword">data</span><span> </span><span id="ScremaForm"><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#ScremaForm"><span class="hs-identifier hs-var">ScremaForm</span></a></span></span><span> </span><span id="local-6989586621684376475"><span class="annot"><a href="#local-6989586621684376475"><span class="hs-identifier hs-type">rep</span></a></span></span><span>
</span><span id="line-164"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="ScremaForm"><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#ScremaForm"><span class="hs-identifier hs-var">ScremaForm</span></a></span></span><span>
</span><span id="line-165"></span><span>      </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Scan"><span class="hs-identifier hs-type">Scan</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376475"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-166"></span><span>      </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Reduce"><span class="hs-identifier hs-type">Reduce</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376475"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-167"></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376475"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-168"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684375570"><span id="local-6989586621684375577"><span class="annot"><span class="annottext">ScremaForm rep -&gt; ScremaForm rep -&gt; Bool
(ScremaForm rep -&gt; ScremaForm rep -&gt; Bool)
-&gt; (ScremaForm rep -&gt; ScremaForm rep -&gt; Bool)
-&gt; Eq (ScremaForm rep)
forall rep.
RepTypes rep =&gt;
ScremaForm rep -&gt; ScremaForm rep -&gt; Bool
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: ScremaForm rep -&gt; ScremaForm rep -&gt; Bool
$c/= :: forall rep.
RepTypes rep =&gt;
ScremaForm rep -&gt; ScremaForm rep -&gt; Bool
== :: ScremaForm rep -&gt; ScremaForm rep -&gt; Bool
$c== :: forall rep.
RepTypes rep =&gt;
ScremaForm rep -&gt; ScremaForm rep -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684375541"><span id="local-6989586621684375543"><span id="local-6989586621684375546"><span id="local-6989586621684375549"><span id="local-6989586621684375552"><span id="local-6989586621684375559"><span id="local-6989586621684375566"><span class="annot"><span class="annottext">Eq (ScremaForm rep)
Eq (ScremaForm rep)
-&gt; (ScremaForm rep -&gt; ScremaForm rep -&gt; Ordering)
-&gt; (ScremaForm rep -&gt; ScremaForm rep -&gt; Bool)
-&gt; (ScremaForm rep -&gt; ScremaForm rep -&gt; Bool)
-&gt; (ScremaForm rep -&gt; ScremaForm rep -&gt; Bool)
-&gt; (ScremaForm rep -&gt; ScremaForm rep -&gt; Bool)
-&gt; (ScremaForm rep -&gt; ScremaForm rep -&gt; ScremaForm rep)
-&gt; (ScremaForm rep -&gt; ScremaForm rep -&gt; ScremaForm rep)
-&gt; Ord (ScremaForm rep)
ScremaForm rep -&gt; ScremaForm rep -&gt; Bool
ScremaForm rep -&gt; ScremaForm rep -&gt; Ordering
ScremaForm rep -&gt; ScremaForm rep -&gt; ScremaForm rep
forall a.
Eq a
-&gt; (a -&gt; a -&gt; Ordering)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; a)
-&gt; (a -&gt; a -&gt; a)
-&gt; Ord a
forall rep. RepTypes rep =&gt; Eq (ScremaForm rep)
forall rep.
RepTypes rep =&gt;
ScremaForm rep -&gt; ScremaForm rep -&gt; Bool
forall rep.
RepTypes rep =&gt;
ScremaForm rep -&gt; ScremaForm rep -&gt; Ordering
forall rep.
RepTypes rep =&gt;
ScremaForm rep -&gt; ScremaForm rep -&gt; ScremaForm rep
min :: ScremaForm rep -&gt; ScremaForm rep -&gt; ScremaForm rep
$cmin :: forall rep.
RepTypes rep =&gt;
ScremaForm rep -&gt; ScremaForm rep -&gt; ScremaForm rep
max :: ScremaForm rep -&gt; ScremaForm rep -&gt; ScremaForm rep
$cmax :: forall rep.
RepTypes rep =&gt;
ScremaForm rep -&gt; ScremaForm rep -&gt; ScremaForm rep
&gt;= :: ScremaForm rep -&gt; ScremaForm rep -&gt; Bool
$c&gt;= :: forall rep.
RepTypes rep =&gt;
ScremaForm rep -&gt; ScremaForm rep -&gt; Bool
&gt; :: ScremaForm rep -&gt; ScremaForm rep -&gt; Bool
$c&gt; :: forall rep.
RepTypes rep =&gt;
ScremaForm rep -&gt; ScremaForm rep -&gt; Bool
&lt;= :: ScremaForm rep -&gt; ScremaForm rep -&gt; Bool
$c&lt;= :: forall rep.
RepTypes rep =&gt;
ScremaForm rep -&gt; ScremaForm rep -&gt; Bool
&lt; :: ScremaForm rep -&gt; ScremaForm rep -&gt; Bool
$c&lt; :: forall rep.
RepTypes rep =&gt;
ScremaForm rep -&gt; ScremaForm rep -&gt; Bool
compare :: ScremaForm rep -&gt; ScremaForm rep -&gt; Ordering
$ccompare :: forall rep.
RepTypes rep =&gt;
ScremaForm rep -&gt; ScremaForm rep -&gt; Ordering
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Ord</span></span></span></span></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684375529"><span id="local-6989586621684375531"><span id="local-6989586621684375539"><span class="annot"><span class="annottext">Int -&gt; ScremaForm rep -&gt; ShowS
[ScremaForm rep] -&gt; ShowS
ScremaForm rep -&gt; String
(Int -&gt; ScremaForm rep -&gt; ShowS)
-&gt; (ScremaForm rep -&gt; String)
-&gt; ([ScremaForm rep] -&gt; ShowS)
-&gt; Show (ScremaForm rep)
forall rep. RepTypes rep =&gt; Int -&gt; ScremaForm rep -&gt; ShowS
forall rep. RepTypes rep =&gt; [ScremaForm rep] -&gt; ShowS
forall rep. RepTypes rep =&gt; ScremaForm rep -&gt; String
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [ScremaForm rep] -&gt; ShowS
$cshowList :: forall rep. RepTypes rep =&gt; [ScremaForm rep] -&gt; ShowS
show :: ScremaForm rep -&gt; String
$cshow :: forall rep. RepTypes rep =&gt; ScremaForm rep -&gt; String
showsPrec :: Int -&gt; ScremaForm rep -&gt; ShowS
$cshowsPrec :: forall rep. RepTypes rep =&gt; Int -&gt; ScremaForm rep -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-169"></span><span>
</span><span id="line-170"></span><span id="local-6989586621684376452"><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#singleBinOp"><span class="hs-identifier hs-type">singleBinOp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Builder.Class.html#Buildable"><span class="hs-identifier hs-type">Buildable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376452"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376452"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376452"><span class="hs-identifier hs-type">rep</span></a></span></span><span>
</span><span id="line-171"></span><span id="singleBinOp"><span class="annot"><span class="annottext">singleBinOp :: forall rep. Buildable rep =&gt; [Lambda rep] -&gt; Lambda rep
</span><a href="Futhark.IR.SOACS.SOAC.html#singleBinOp"><span class="hs-identifier hs-var hs-var">singleBinOp</span></a></span></span><span> </span><span id="local-6989586621684375510"><span class="annot"><span class="annottext">[Lambda rep]
</span><a href="#local-6989586621684375510"><span class="hs-identifier hs-var">lams</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-172"></span><span>  </span><span class="annot"><span class="annottext">Lambda :: forall rep. [LParam rep] -&gt; BodyT rep -&gt; [Type] -&gt; LambdaT rep
</span><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span>
</span><span id="line-173"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">lambdaParams :: [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var">lambdaParams</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Lambda rep -&gt; [Param Type]) -&gt; [Lambda rep] -&gt; [Param Type]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; [Param Type]
forall {rep}. LambdaT rep -&gt; [Param (LParamInfo rep)]
</span><a href="#local-6989586621684375506"><span class="hs-identifier hs-var">xParams</span></a></span><span> </span><span class="annot"><span class="annottext">[Lambda rep]
</span><a href="#local-6989586621684375510"><span class="hs-identifier hs-var">lams</span></a></span><span> </span><span class="annot"><span class="annottext">[Param Type] -&gt; [Param Type] -&gt; [Param Type]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">(Lambda rep -&gt; [Param Type]) -&gt; [Lambda rep] -&gt; [Param Type]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; [Param Type]
forall {rep}. LambdaT rep -&gt; [Param (LParamInfo rep)]
</span><a href="#local-6989586621684375505"><span class="hs-identifier hs-var">yParams</span></a></span><span> </span><span class="annot"><span class="annottext">[Lambda rep]
</span><a href="#local-6989586621684375510"><span class="hs-identifier hs-var">lams</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-174"></span><span>      </span><span class="annot"><span class="annottext">lambdaReturnType :: [Type]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var">lambdaReturnType</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Lambda rep -&gt; [Type]) -&gt; [Lambda rep] -&gt; [Type]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; [Type]
forall rep. LambdaT rep -&gt; [Type]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">[Lambda rep]
</span><a href="#local-6989586621684375510"><span class="hs-identifier hs-var">lams</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-175"></span><span>      </span><span class="annot"><span class="annottext">lambdaBody :: BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var">lambdaBody</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-176"></span><span>        </span><span class="annot"><span class="annottext">Stms rep -&gt; Result -&gt; BodyT rep
forall rep. Buildable rep =&gt; Stms rep -&gt; Result -&gt; Body rep
</span><a href="Futhark.Builder.Class.html#mkBody"><span class="hs-identifier hs-var">mkBody</span></a></span><span>
</span><span id="line-177"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Stms rep] -&gt; Stms rep
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Lambda rep -&gt; Stms rep) -&gt; [Lambda rep] -&gt; [Stms rep]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BodyT rep -&gt; Stms rep
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">(BodyT rep -&gt; Stms rep)
-&gt; (Lambda rep -&gt; BodyT rep) -&gt; Lambda rep -&gt; Stms rep
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; BodyT rep
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Lambda rep]
</span><a href="#local-6989586621684375510"><span class="hs-identifier hs-var">lams</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-178"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Lambda rep -&gt; Result) -&gt; [Lambda rep] -&gt; Result
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BodyT rep -&gt; Result
forall rep. BodyT rep -&gt; Result
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var hs-var">bodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">(BodyT rep -&gt; Result)
-&gt; (Lambda rep -&gt; BodyT rep) -&gt; Lambda rep -&gt; Result
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; BodyT rep
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Lambda rep]
</span><a href="#local-6989586621684375510"><span class="hs-identifier hs-var">lams</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-179"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-180"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-181"></span><span>    </span><span id="local-6989586621684375506"><span class="annot"><span class="annottext">xParams :: LambdaT rep -&gt; [Param (LParamInfo rep)]
</span><a href="#local-6989586621684375506"><span class="hs-identifier hs-var hs-var">xParams</span></a></span></span><span> </span><span id="local-6989586621684375497"><span class="annot"><span class="annottext">LambdaT rep
</span><a href="#local-6989586621684375497"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Param (LParamInfo rep)] -&gt; [Param (LParamInfo rep)]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">take</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Type] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LambdaT rep -&gt; [Type]
forall rep. LambdaT rep -&gt; [Type]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT rep
</span><a href="#local-6989586621684375497"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LambdaT rep -&gt; [Param (LParamInfo rep)]
forall {rep}. LambdaT rep -&gt; [Param (LParamInfo rep)]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT rep
</span><a href="#local-6989586621684375497"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-182"></span><span>    </span><span id="local-6989586621684375505"><span class="annot"><span class="annottext">yParams :: LambdaT rep -&gt; [Param (LParamInfo rep)]
</span><a href="#local-6989586621684375505"><span class="hs-identifier hs-var hs-var">yParams</span></a></span></span><span> </span><span id="local-6989586621684375493"><span class="annot"><span class="annottext">LambdaT rep
</span><a href="#local-6989586621684375493"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Param (LParamInfo rep)] -&gt; [Param (LParamInfo rep)]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Type] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LambdaT rep -&gt; [Type]
forall rep. LambdaT rep -&gt; [Type]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT rep
</span><a href="#local-6989586621684375493"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LambdaT rep -&gt; [Param (LParamInfo rep)]
forall {rep}. LambdaT rep -&gt; [Param (LParamInfo rep)]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT rep
</span><a href="#local-6989586621684375493"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-183"></span><span>
</span><span id="line-184"></span><span class="hs-comment">-- | How to compute a single scan result.</span><span>
</span><span id="line-185"></span><span class="hs-keyword">data</span><span> </span><span id="Scan"><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Scan"><span class="hs-identifier hs-var">Scan</span></a></span></span><span> </span><span id="local-6989586621684376453"><span class="annot"><a href="#local-6989586621684376453"><span class="hs-identifier hs-type">rep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Scan"><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Scan"><span class="hs-identifier hs-var">Scan</span></a></span></span><span>
</span><span id="line-186"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="scanLambda"><span class="annot"><span class="annottext">forall rep. Scan rep -&gt; Lambda rep
</span><a href="Futhark.IR.SOACS.SOAC.html#scanLambda"><span class="hs-identifier hs-var hs-var">scanLambda</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376453"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-187"></span><span>    </span><span id="scanNeutral"><span class="annot"><span class="annottext">forall rep. Scan rep -&gt; [SubExp]
</span><a href="Futhark.IR.SOACS.SOAC.html#scanNeutral"><span class="hs-identifier hs-var hs-var">scanNeutral</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-188"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-189"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684375482"><span id="local-6989586621684375487"><span class="annot"><span class="annottext">Scan rep -&gt; Scan rep -&gt; Bool
(Scan rep -&gt; Scan rep -&gt; Bool)
-&gt; (Scan rep -&gt; Scan rep -&gt; Bool) -&gt; Eq (Scan rep)
forall rep. RepTypes rep =&gt; Scan rep -&gt; Scan rep -&gt; Bool
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: Scan rep -&gt; Scan rep -&gt; Bool
$c/= :: forall rep. RepTypes rep =&gt; Scan rep -&gt; Scan rep -&gt; Bool
== :: Scan rep -&gt; Scan rep -&gt; Bool
$c== :: forall rep. RepTypes rep =&gt; Scan rep -&gt; Scan rep -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684375457"><span id="local-6989586621684375459"><span id="local-6989586621684375462"><span id="local-6989586621684375465"><span id="local-6989586621684375468"><span id="local-6989586621684375473"><span id="local-6989586621684375478"><span class="annot"><span class="annottext">Eq (Scan rep)
Eq (Scan rep)
-&gt; (Scan rep -&gt; Scan rep -&gt; Ordering)
-&gt; (Scan rep -&gt; Scan rep -&gt; Bool)
-&gt; (Scan rep -&gt; Scan rep -&gt; Bool)
-&gt; (Scan rep -&gt; Scan rep -&gt; Bool)
-&gt; (Scan rep -&gt; Scan rep -&gt; Bool)
-&gt; (Scan rep -&gt; Scan rep -&gt; Scan rep)
-&gt; (Scan rep -&gt; Scan rep -&gt; Scan rep)
-&gt; Ord (Scan rep)
Scan rep -&gt; Scan rep -&gt; Bool
Scan rep -&gt; Scan rep -&gt; Ordering
Scan rep -&gt; Scan rep -&gt; Scan rep
forall a.
Eq a
-&gt; (a -&gt; a -&gt; Ordering)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; a)
-&gt; (a -&gt; a -&gt; a)
-&gt; Ord a
forall rep. RepTypes rep =&gt; Eq (Scan rep)
forall rep. RepTypes rep =&gt; Scan rep -&gt; Scan rep -&gt; Bool
forall rep. RepTypes rep =&gt; Scan rep -&gt; Scan rep -&gt; Ordering
forall rep. RepTypes rep =&gt; Scan rep -&gt; Scan rep -&gt; Scan rep
min :: Scan rep -&gt; Scan rep -&gt; Scan rep
$cmin :: forall rep. RepTypes rep =&gt; Scan rep -&gt; Scan rep -&gt; Scan rep
max :: Scan rep -&gt; Scan rep -&gt; Scan rep
$cmax :: forall rep. RepTypes rep =&gt; Scan rep -&gt; Scan rep -&gt; Scan rep
&gt;= :: Scan rep -&gt; Scan rep -&gt; Bool
$c&gt;= :: forall rep. RepTypes rep =&gt; Scan rep -&gt; Scan rep -&gt; Bool
&gt; :: Scan rep -&gt; Scan rep -&gt; Bool
$c&gt; :: forall rep. RepTypes rep =&gt; Scan rep -&gt; Scan rep -&gt; Bool
&lt;= :: Scan rep -&gt; Scan rep -&gt; Bool
$c&lt;= :: forall rep. RepTypes rep =&gt; Scan rep -&gt; Scan rep -&gt; Bool
&lt; :: Scan rep -&gt; Scan rep -&gt; Bool
$c&lt; :: forall rep. RepTypes rep =&gt; Scan rep -&gt; Scan rep -&gt; Bool
compare :: Scan rep -&gt; Scan rep -&gt; Ordering
$ccompare :: forall rep. RepTypes rep =&gt; Scan rep -&gt; Scan rep -&gt; Ordering
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Ord</span></span></span></span></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684375447"><span id="local-6989586621684375449"><span id="local-6989586621684375455"><span class="annot"><span class="annottext">Int -&gt; Scan rep -&gt; ShowS
[Scan rep] -&gt; ShowS
Scan rep -&gt; String
(Int -&gt; Scan rep -&gt; ShowS)
-&gt; (Scan rep -&gt; String) -&gt; ([Scan rep] -&gt; ShowS) -&gt; Show (Scan rep)
forall rep. RepTypes rep =&gt; Int -&gt; Scan rep -&gt; ShowS
forall rep. RepTypes rep =&gt; [Scan rep] -&gt; ShowS
forall rep. RepTypes rep =&gt; Scan rep -&gt; String
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [Scan rep] -&gt; ShowS
$cshowList :: forall rep. RepTypes rep =&gt; [Scan rep] -&gt; ShowS
show :: Scan rep -&gt; String
$cshow :: forall rep. RepTypes rep =&gt; Scan rep -&gt; String
showsPrec :: Int -&gt; Scan rep -&gt; ShowS
$cshowsPrec :: forall rep. RepTypes rep =&gt; Int -&gt; Scan rep -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-190"></span><span>
</span><span id="line-191"></span><span class="hs-comment">-- | How many reduction results are produced by these 'Scan's?</span><span>
</span><span id="line-192"></span><span id="local-6989586621684376416"><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#scanResults"><span class="hs-identifier hs-type">scanResults</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Scan"><span class="hs-identifier hs-type">Scan</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376416"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span></span><span>
</span><span id="line-193"></span><span id="scanResults"><span class="annot"><span class="annottext">scanResults :: forall rep. [Scan rep] -&gt; Int
</span><a href="Futhark.IR.SOACS.SOAC.html#scanResults"><span class="hs-identifier hs-var hs-var">scanResults</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; Int
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">sum</span></span><span> </span><span class="annot"><span class="annottext">([Int] -&gt; Int) -&gt; ([Scan rep] -&gt; [Int]) -&gt; [Scan rep] -&gt; Int
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Scan rep -&gt; Int) -&gt; [Scan rep] -&gt; [Int]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; Int) -&gt; (Scan rep -&gt; [SubExp]) -&gt; Scan rep -&gt; Int
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Scan rep -&gt; [SubExp]
forall rep. Scan rep -&gt; [SubExp]
</span><a href="Futhark.IR.SOACS.SOAC.html#scanNeutral"><span class="hs-identifier hs-var hs-var">scanNeutral</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-194"></span><span>
</span><span id="line-195"></span><span class="hs-comment">-- | Combine multiple scan operators to a single operator.</span><span>
</span><span id="line-196"></span><span id="local-6989586621684376413"><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#singleScan"><span class="hs-identifier hs-type">singleScan</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Builder.Class.html#Buildable"><span class="hs-identifier hs-type">Buildable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376413"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Scan"><span class="hs-identifier hs-type">Scan</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376413"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Scan"><span class="hs-identifier hs-type">Scan</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376413"><span class="hs-identifier hs-type">rep</span></a></span></span><span>
</span><span id="line-197"></span><span id="singleScan"><span class="annot"><span class="annottext">singleScan :: forall rep. Buildable rep =&gt; [Scan rep] -&gt; Scan rep
</span><a href="Futhark.IR.SOACS.SOAC.html#singleScan"><span class="hs-identifier hs-var hs-var">singleScan</span></a></span></span><span> </span><span id="local-6989586621684375436"><span class="annot"><span class="annottext">[Scan rep]
</span><a href="#local-6989586621684375436"><span class="hs-identifier hs-var">scans</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-198"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684375435"><span class="annot"><span class="annottext">scan_nes :: [SubExp]
</span><a href="#local-6989586621684375435"><span class="hs-identifier hs-var hs-var">scan_nes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Scan rep -&gt; [SubExp]) -&gt; [Scan rep] -&gt; [SubExp]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="annot"><span class="annottext">Scan rep -&gt; [SubExp]
forall rep. Scan rep -&gt; [SubExp]
</span><a href="Futhark.IR.SOACS.SOAC.html#scanNeutral"><span class="hs-identifier hs-var hs-var">scanNeutral</span></a></span><span> </span><span class="annot"><span class="annottext">[Scan rep]
</span><a href="#local-6989586621684375436"><span class="hs-identifier hs-var">scans</span></a></span><span>
</span><span id="line-199"></span><span>      </span><span id="local-6989586621684375434"><span class="annot"><span class="annottext">scan_lam :: Lambda rep
</span><a href="#local-6989586621684375434"><span class="hs-identifier hs-var hs-var">scan_lam</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Lambda rep] -&gt; Lambda rep
forall rep. Buildable rep =&gt; [Lambda rep] -&gt; Lambda rep
</span><a href="Futhark.IR.SOACS.SOAC.html#singleBinOp"><span class="hs-identifier hs-var">singleBinOp</span></a></span><span> </span><span class="annot"><span class="annottext">([Lambda rep] -&gt; Lambda rep) -&gt; [Lambda rep] -&gt; Lambda rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Scan rep -&gt; Lambda rep) -&gt; [Scan rep] -&gt; [Lambda rep]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Scan rep -&gt; Lambda rep
forall rep. Scan rep -&gt; Lambda rep
</span><a href="Futhark.IR.SOACS.SOAC.html#scanLambda"><span class="hs-identifier hs-var hs-var">scanLambda</span></a></span><span> </span><span class="annot"><span class="annottext">[Scan rep]
</span><a href="#local-6989586621684375436"><span class="hs-identifier hs-var">scans</span></a></span><span>
</span><span id="line-200"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; [SubExp] -&gt; Scan rep
forall rep. Lambda rep -&gt; [SubExp] -&gt; Scan rep
</span><a href="Futhark.IR.SOACS.SOAC.html#Scan"><span class="hs-identifier hs-var">Scan</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684375434"><span class="hs-identifier hs-var">scan_lam</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684375435"><span class="hs-identifier hs-var">scan_nes</span></a></span><span>
</span><span id="line-201"></span><span>
</span><span id="line-202"></span><span class="hs-comment">-- | How to compute a single reduction result.</span><span>
</span><span id="line-203"></span><span class="hs-keyword">data</span><span> </span><span id="Reduce"><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Reduce"><span class="hs-identifier hs-var">Reduce</span></a></span></span><span> </span><span id="local-6989586621684376454"><span class="annot"><a href="#local-6989586621684376454"><span class="hs-identifier hs-type">rep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Reduce"><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Reduce"><span class="hs-identifier hs-var">Reduce</span></a></span></span><span>
</span><span id="line-204"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="redComm"><span class="annot"><span class="annottext">forall rep. Reduce rep -&gt; Commutativity
</span><a href="Futhark.IR.SOACS.SOAC.html#redComm"><span class="hs-identifier hs-var hs-var">redComm</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Commutativity"><span class="hs-identifier hs-type">Commutativity</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-205"></span><span>    </span><span id="redLambda"><span class="annot"><span class="annottext">forall rep. Reduce rep -&gt; Lambda rep
</span><a href="Futhark.IR.SOACS.SOAC.html#redLambda"><span class="hs-identifier hs-var hs-var">redLambda</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376454"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-206"></span><span>    </span><span id="redNeutral"><span class="annot"><span class="annottext">forall rep. Reduce rep -&gt; [SubExp]
</span><a href="Futhark.IR.SOACS.SOAC.html#redNeutral"><span class="hs-identifier hs-var hs-var">redNeutral</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-207"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-208"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684375422"><span id="local-6989586621684375428"><span class="annot"><span class="annottext">Reduce rep -&gt; Reduce rep -&gt; Bool
(Reduce rep -&gt; Reduce rep -&gt; Bool)
-&gt; (Reduce rep -&gt; Reduce rep -&gt; Bool) -&gt; Eq (Reduce rep)
forall rep. RepTypes rep =&gt; Reduce rep -&gt; Reduce rep -&gt; Bool
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: Reduce rep -&gt; Reduce rep -&gt; Bool
$c/= :: forall rep. RepTypes rep =&gt; Reduce rep -&gt; Reduce rep -&gt; Bool
== :: Reduce rep -&gt; Reduce rep -&gt; Bool
$c== :: forall rep. RepTypes rep =&gt; Reduce rep -&gt; Reduce rep -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684375395"><span id="local-6989586621684375397"><span id="local-6989586621684375400"><span id="local-6989586621684375403"><span id="local-6989586621684375406"><span id="local-6989586621684375412"><span id="local-6989586621684375418"><span class="annot"><span class="annottext">Eq (Reduce rep)
Eq (Reduce rep)
-&gt; (Reduce rep -&gt; Reduce rep -&gt; Ordering)
-&gt; (Reduce rep -&gt; Reduce rep -&gt; Bool)
-&gt; (Reduce rep -&gt; Reduce rep -&gt; Bool)
-&gt; (Reduce rep -&gt; Reduce rep -&gt; Bool)
-&gt; (Reduce rep -&gt; Reduce rep -&gt; Bool)
-&gt; (Reduce rep -&gt; Reduce rep -&gt; Reduce rep)
-&gt; (Reduce rep -&gt; Reduce rep -&gt; Reduce rep)
-&gt; Ord (Reduce rep)
Reduce rep -&gt; Reduce rep -&gt; Bool
Reduce rep -&gt; Reduce rep -&gt; Ordering
Reduce rep -&gt; Reduce rep -&gt; Reduce rep
forall a.
Eq a
-&gt; (a -&gt; a -&gt; Ordering)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; a)
-&gt; (a -&gt; a -&gt; a)
-&gt; Ord a
forall rep. RepTypes rep =&gt; Eq (Reduce rep)
forall rep. RepTypes rep =&gt; Reduce rep -&gt; Reduce rep -&gt; Bool
forall rep. RepTypes rep =&gt; Reduce rep -&gt; Reduce rep -&gt; Ordering
forall rep. RepTypes rep =&gt; Reduce rep -&gt; Reduce rep -&gt; Reduce rep
min :: Reduce rep -&gt; Reduce rep -&gt; Reduce rep
$cmin :: forall rep. RepTypes rep =&gt; Reduce rep -&gt; Reduce rep -&gt; Reduce rep
max :: Reduce rep -&gt; Reduce rep -&gt; Reduce rep
$cmax :: forall rep. RepTypes rep =&gt; Reduce rep -&gt; Reduce rep -&gt; Reduce rep
&gt;= :: Reduce rep -&gt; Reduce rep -&gt; Bool
$c&gt;= :: forall rep. RepTypes rep =&gt; Reduce rep -&gt; Reduce rep -&gt; Bool
&gt; :: Reduce rep -&gt; Reduce rep -&gt; Bool
$c&gt; :: forall rep. RepTypes rep =&gt; Reduce rep -&gt; Reduce rep -&gt; Bool
&lt;= :: Reduce rep -&gt; Reduce rep -&gt; Bool
$c&lt;= :: forall rep. RepTypes rep =&gt; Reduce rep -&gt; Reduce rep -&gt; Bool
&lt; :: Reduce rep -&gt; Reduce rep -&gt; Bool
$c&lt; :: forall rep. RepTypes rep =&gt; Reduce rep -&gt; Reduce rep -&gt; Bool
compare :: Reduce rep -&gt; Reduce rep -&gt; Ordering
$ccompare :: forall rep. RepTypes rep =&gt; Reduce rep -&gt; Reduce rep -&gt; Ordering
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Ord</span></span></span></span></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684375384"><span id="local-6989586621684375386"><span id="local-6989586621684375393"><span class="annot"><span class="annottext">Int -&gt; Reduce rep -&gt; ShowS
[Reduce rep] -&gt; ShowS
Reduce rep -&gt; String
(Int -&gt; Reduce rep -&gt; ShowS)
-&gt; (Reduce rep -&gt; String)
-&gt; ([Reduce rep] -&gt; ShowS)
-&gt; Show (Reduce rep)
forall rep. RepTypes rep =&gt; Int -&gt; Reduce rep -&gt; ShowS
forall rep. RepTypes rep =&gt; [Reduce rep] -&gt; ShowS
forall rep. RepTypes rep =&gt; Reduce rep -&gt; String
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [Reduce rep] -&gt; ShowS
$cshowList :: forall rep. RepTypes rep =&gt; [Reduce rep] -&gt; ShowS
show :: Reduce rep -&gt; String
$cshow :: forall rep. RepTypes rep =&gt; Reduce rep -&gt; String
showsPrec :: Int -&gt; Reduce rep -&gt; ShowS
$cshowsPrec :: forall rep. RepTypes rep =&gt; Int -&gt; Reduce rep -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-209"></span><span>
</span><span id="line-210"></span><span class="hs-comment">-- | How many reduction results are produced by these 'Reduce's?</span><span>
</span><span id="line-211"></span><span id="local-6989586621684376405"><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#redResults"><span class="hs-identifier hs-type">redResults</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Reduce"><span class="hs-identifier hs-type">Reduce</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376405"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span></span><span>
</span><span id="line-212"></span><span id="redResults"><span class="annot"><span class="annottext">redResults :: forall rep. [Reduce rep] -&gt; Int
</span><a href="Futhark.IR.SOACS.SOAC.html#redResults"><span class="hs-identifier hs-var hs-var">redResults</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; Int
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">sum</span></span><span> </span><span class="annot"><span class="annottext">([Int] -&gt; Int) -&gt; ([Reduce rep] -&gt; [Int]) -&gt; [Reduce rep] -&gt; Int
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Reduce rep -&gt; Int) -&gt; [Reduce rep] -&gt; [Int]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; Int) -&gt; (Reduce rep -&gt; [SubExp]) -&gt; Reduce rep -&gt; Int
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Reduce rep -&gt; [SubExp]
forall rep. Reduce rep -&gt; [SubExp]
</span><a href="Futhark.IR.SOACS.SOAC.html#redNeutral"><span class="hs-identifier hs-var hs-var">redNeutral</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-213"></span><span>
</span><span id="line-214"></span><span class="hs-comment">-- | Combine multiple reduction operators to a single operator.</span><span>
</span><span id="line-215"></span><span id="local-6989586621684376403"><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#singleReduce"><span class="hs-identifier hs-type">singleReduce</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Builder.Class.html#Buildable"><span class="hs-identifier hs-type">Buildable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376403"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Reduce"><span class="hs-identifier hs-type">Reduce</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376403"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Reduce"><span class="hs-identifier hs-type">Reduce</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376403"><span class="hs-identifier hs-type">rep</span></a></span></span><span>
</span><span id="line-216"></span><span id="singleReduce"><span class="annot"><span class="annottext">singleReduce :: forall rep. Buildable rep =&gt; [Reduce rep] -&gt; Reduce rep
</span><a href="Futhark.IR.SOACS.SOAC.html#singleReduce"><span class="hs-identifier hs-var hs-var">singleReduce</span></a></span></span><span> </span><span id="local-6989586621684375373"><span class="annot"><span class="annottext">[Reduce rep]
</span><a href="#local-6989586621684375373"><span class="hs-identifier hs-var">reds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-217"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684375372"><span class="annot"><span class="annottext">red_nes :: [SubExp]
</span><a href="#local-6989586621684375372"><span class="hs-identifier hs-var hs-var">red_nes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Reduce rep -&gt; [SubExp]) -&gt; [Reduce rep] -&gt; [SubExp]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="annot"><span class="annottext">Reduce rep -&gt; [SubExp]
forall rep. Reduce rep -&gt; [SubExp]
</span><a href="Futhark.IR.SOACS.SOAC.html#redNeutral"><span class="hs-identifier hs-var hs-var">redNeutral</span></a></span><span> </span><span class="annot"><span class="annottext">[Reduce rep]
</span><a href="#local-6989586621684375373"><span class="hs-identifier hs-var">reds</span></a></span><span>
</span><span id="line-218"></span><span>      </span><span id="local-6989586621684375371"><span class="annot"><span class="annottext">red_lam :: Lambda rep
</span><a href="#local-6989586621684375371"><span class="hs-identifier hs-var hs-var">red_lam</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Lambda rep] -&gt; Lambda rep
forall rep. Buildable rep =&gt; [Lambda rep] -&gt; Lambda rep
</span><a href="Futhark.IR.SOACS.SOAC.html#singleBinOp"><span class="hs-identifier hs-var">singleBinOp</span></a></span><span> </span><span class="annot"><span class="annottext">([Lambda rep] -&gt; Lambda rep) -&gt; [Lambda rep] -&gt; Lambda rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Reduce rep -&gt; Lambda rep) -&gt; [Reduce rep] -&gt; [Lambda rep]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Reduce rep -&gt; Lambda rep
forall rep. Reduce rep -&gt; Lambda rep
</span><a href="Futhark.IR.SOACS.SOAC.html#redLambda"><span class="hs-identifier hs-var hs-var">redLambda</span></a></span><span> </span><span class="annot"><span class="annottext">[Reduce rep]
</span><a href="#local-6989586621684375373"><span class="hs-identifier hs-var">reds</span></a></span><span>
</span><span id="line-219"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Commutativity -&gt; Lambda rep -&gt; [SubExp] -&gt; Reduce rep
forall rep. Commutativity -&gt; Lambda rep -&gt; [SubExp] -&gt; Reduce rep
</span><a href="Futhark.IR.SOACS.SOAC.html#Reduce"><span class="hs-identifier hs-var">Reduce</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Commutativity] -&gt; Commutativity
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Reduce rep -&gt; Commutativity) -&gt; [Reduce rep] -&gt; [Commutativity]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Reduce rep -&gt; Commutativity
forall rep. Reduce rep -&gt; Commutativity
</span><a href="Futhark.IR.SOACS.SOAC.html#redComm"><span class="hs-identifier hs-var hs-var">redComm</span></a></span><span> </span><span class="annot"><span class="annottext">[Reduce rep]
</span><a href="#local-6989586621684375373"><span class="hs-identifier hs-var">reds</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684375371"><span class="hs-identifier hs-var">red_lam</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684375372"><span class="hs-identifier hs-var">red_nes</span></a></span><span>
</span><span id="line-220"></span><span>
</span><span id="line-221"></span><span class="hs-comment">-- | The types produced by a single 'Screma', given the size of the</span><span>
</span><span id="line-222"></span><span class="hs-comment">-- input array.</span><span>
</span><span id="line-223"></span><span id="local-6989586621684376401"><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#scremaType"><span class="hs-identifier hs-type">scremaType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#ScremaForm"><span class="hs-identifier hs-type">ScremaForm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376401"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span></span><span>
</span><span id="line-224"></span><span id="scremaType"><span class="annot"><span class="annottext">scremaType :: forall rep. SubExp -&gt; ScremaForm rep -&gt; [Type]
</span><a href="Futhark.IR.SOACS.SOAC.html#scremaType"><span class="hs-identifier hs-var hs-var">scremaType</span></a></span></span><span> </span><span id="local-6989586621684375360"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684375360"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#ScremaForm"><span class="hs-identifier hs-type">ScremaForm</span></a></span><span> </span><span id="local-6989586621684375359"><span class="annot"><span class="annottext">[Scan rep]
</span><a href="#local-6989586621684375359"><span class="hs-identifier hs-var">scans</span></a></span></span><span> </span><span id="local-6989586621684375358"><span class="annot"><span class="annottext">[Reduce rep]
</span><a href="#local-6989586621684375358"><span class="hs-identifier hs-var">reds</span></a></span></span><span> </span><span id="local-6989586621684375357"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684375357"><span class="hs-identifier hs-var">map_lam</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-225"></span><span>  </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684375356"><span class="hs-identifier hs-var">scan_tps</span></a></span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; [Type] -&gt; [Type]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684375355"><span class="hs-identifier hs-var">red_tps</span></a></span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; [Type] -&gt; [Type]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Type) -&gt; [Type] -&gt; [Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; SubExp -&gt; Type
forall d.
ArrayShape (ShapeBase d) =&gt;
TypeBase (ShapeBase d) NoUniqueness
-&gt; d -&gt; TypeBase (ShapeBase d) NoUniqueness
</span><a href="Futhark.IR.Prop.Types.html#arrayOfRow"><span class="hs-operator hs-var">`arrayOfRow`</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684375360"><span class="hs-identifier hs-var">w</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684375353"><span class="hs-identifier hs-var">map_tps</span></a></span><span>
</span><span id="line-226"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-227"></span><span>    </span><span id="local-6989586621684375356"><span class="annot"><span class="annottext">scan_tps :: [Type]
</span><a href="#local-6989586621684375356"><span class="hs-identifier hs-var hs-var">scan_tps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-228"></span><span>      </span><span class="annot"><span class="annottext">(Type -&gt; Type) -&gt; [Type] -&gt; [Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; SubExp -&gt; Type
forall d.
ArrayShape (ShapeBase d) =&gt;
TypeBase (ShapeBase d) NoUniqueness
-&gt; d -&gt; TypeBase (ShapeBase d) NoUniqueness
</span><a href="Futhark.IR.Prop.Types.html#arrayOfRow"><span class="hs-operator hs-var">`arrayOfRow`</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684375360"><span class="hs-identifier hs-var">w</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Type] -&gt; [Type]) -&gt; [Type] -&gt; [Type]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-229"></span><span>        </span><span class="annot"><span class="annottext">(Scan rep -&gt; [Type]) -&gt; [Scan rep] -&gt; [Type]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda rep -&gt; [Type]
forall rep. LambdaT rep -&gt; [Type]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">(Lambda rep -&gt; [Type])
-&gt; (Scan rep -&gt; Lambda rep) -&gt; Scan rep -&gt; [Type]
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Scan rep -&gt; Lambda rep
forall rep. Scan rep -&gt; Lambda rep
</span><a href="Futhark.IR.SOACS.SOAC.html#scanLambda"><span class="hs-identifier hs-var hs-var">scanLambda</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Scan rep]
</span><a href="#local-6989586621684375359"><span class="hs-identifier hs-var">scans</span></a></span><span>
</span><span id="line-230"></span><span>    </span><span id="local-6989586621684375355"><span class="annot"><span class="annottext">red_tps :: [Type]
</span><a href="#local-6989586621684375355"><span class="hs-identifier hs-var hs-var">red_tps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Reduce rep -&gt; [Type]) -&gt; [Reduce rep] -&gt; [Type]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda rep -&gt; [Type]
forall rep. LambdaT rep -&gt; [Type]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">(Lambda rep -&gt; [Type])
-&gt; (Reduce rep -&gt; Lambda rep) -&gt; Reduce rep -&gt; [Type]
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Reduce rep -&gt; Lambda rep
forall rep. Reduce rep -&gt; Lambda rep
</span><a href="Futhark.IR.SOACS.SOAC.html#redLambda"><span class="hs-identifier hs-var hs-var">redLambda</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Reduce rep]
</span><a href="#local-6989586621684375358"><span class="hs-identifier hs-var">reds</span></a></span><span>
</span><span id="line-231"></span><span>    </span><span id="local-6989586621684375353"><span class="annot"><span class="annottext">map_tps :: [Type]
</span><a href="#local-6989586621684375353"><span class="hs-identifier hs-var hs-var">map_tps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Type] -&gt; [Type]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Type] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684375356"><span class="hs-identifier hs-var">scan_tps</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684375355"><span class="hs-identifier hs-var">red_tps</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Type] -&gt; [Type]) -&gt; [Type] -&gt; [Type]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; [Type]
forall rep. LambdaT rep -&gt; [Type]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684375357"><span class="hs-identifier hs-var">map_lam</span></a></span><span>
</span><span id="line-232"></span><span>
</span><span id="line-233"></span><span class="hs-comment">-- | Construct a lambda that takes parameters of the given types and</span><span>
</span><span id="line-234"></span><span class="hs-comment">-- simply returns them unchanged.</span><span>
</span><span id="line-235"></span><span id="local-6989586621684376393"><span id="local-6989586621684376394"><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#mkIdentityLambda"><span class="hs-identifier hs-type">mkIdentityLambda</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-236"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Builder.Class.html#Buildable"><span class="hs-identifier hs-type">Buildable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376394"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.MonadFreshNames.html#MonadFreshNames"><span class="hs-identifier hs-type">MonadFreshNames</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376393"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-237"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-238"></span><span>  </span><span class="annot"><a href="#local-6989586621684376393"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376394"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-239"></span><span id="mkIdentityLambda"><span class="annot"><span class="annottext">mkIdentityLambda :: forall rep (m :: * -&gt; *).
(Buildable rep, MonadFreshNames m) =&gt;
[Type] -&gt; m (Lambda rep)
</span><a href="Futhark.IR.SOACS.SOAC.html#mkIdentityLambda"><span class="hs-identifier hs-var hs-var">mkIdentityLambda</span></a></span></span><span> </span><span id="local-6989586621684375335"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684375335"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-240"></span><span>  </span><span id="local-6989586621684375334"><span class="annot"><span class="annottext">[Param Type]
</span><a href="#local-6989586621684375334"><span class="hs-identifier hs-var">params</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Type -&gt; m (Param Type)) -&gt; [Type] -&gt; m [Param Type]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Type -&gt; m (Param Type)
forall (m :: * -&gt; *) dec.
MonadFreshNames m =&gt;
String -&gt; dec -&gt; m (Param dec)
</span><a href="Futhark.MonadFreshNames.html#newParam"><span class="hs-identifier hs-var">newParam</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;x&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684375335"><span class="hs-identifier hs-var">ts</span></a></span><span>
</span><span id="line-241"></span><span>  </span><span class="annot"><span class="annottext">Lambda rep -&gt; m (Lambda rep)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-242"></span><span>    </span><span class="annot"><span class="annottext">Lambda :: forall rep. [LParam rep] -&gt; BodyT rep -&gt; [Type] -&gt; LambdaT rep
</span><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span>
</span><span id="line-243"></span><span>      </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">lambdaParams :: [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var">lambdaParams</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Param Type]
[LParam rep]
</span><a href="#local-6989586621684375334"><span class="hs-identifier hs-var">params</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-244"></span><span>        </span><span class="annot"><span class="annottext">lambdaBody :: BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var">lambdaBody</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stms rep -&gt; Result -&gt; BodyT rep
forall rep. Buildable rep =&gt; Stms rep -&gt; Result -&gt; Body rep
</span><a href="Futhark.Builder.Class.html#mkBody"><span class="hs-identifier hs-var">mkBody</span></a></span><span> </span><span class="annot"><span class="annottext">Stms rep
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">(Result -&gt; BodyT rep) -&gt; Result -&gt; BodyT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Result
</span><a href="Futhark.IR.Syntax.html#varsRes"><span class="hs-identifier hs-var">varsRes</span></a></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; Result) -&gt; [VName] -&gt; Result
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Param Type -&gt; VName) -&gt; [Param Type] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Param Type -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">[Param Type]
</span><a href="#local-6989586621684375334"><span class="hs-identifier hs-var">params</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-245"></span><span>        </span><span class="annot"><span class="annottext">lambdaReturnType :: [Type]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var">lambdaReturnType</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684375335"><span class="hs-identifier hs-var">ts</span></a></span><span>
</span><span id="line-246"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-247"></span><span>
</span><span id="line-248"></span><span class="hs-comment">-- | Is the given lambda an identity lambda?</span><span>
</span><span id="line-249"></span><span id="local-6989586621684376379"><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#isIdentityLambda"><span class="hs-identifier hs-type">isIdentityLambda</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376379"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span><span>
</span><span id="line-250"></span><span id="isIdentityLambda"><span class="annot"><span class="annottext">isIdentityLambda :: forall rep. Lambda rep -&gt; Bool
</span><a href="Futhark.IR.SOACS.SOAC.html#isIdentityLambda"><span class="hs-identifier hs-var hs-var">isIdentityLambda</span></a></span></span><span> </span><span id="local-6989586621684375326"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684375326"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-251"></span><span>  </span><span class="annot"><span class="annottext">(SubExpRes -&gt; SubExp) -&gt; Result -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExpRes -&gt; SubExp
</span><a href="Futhark.IR.Syntax.html#resSubExp"><span class="hs-identifier hs-var hs-var">resSubExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BodyT rep -&gt; Result
forall rep. BodyT rep -&gt; Result
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var hs-var">bodyResult</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda rep -&gt; BodyT rep
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684375326"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-252"></span><span>    </span><span class="annot"><span class="annottext">[SubExp] -&gt; [SubExp] -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">(Param (LParamInfo rep) -&gt; SubExp)
-&gt; [Param (LParamInfo rep)] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SubExp)
-&gt; (Param (LParamInfo rep) -&gt; VName)
-&gt; Param (LParamInfo rep)
-&gt; SubExp
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Param (LParamInfo rep) -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda rep -&gt; [Param (LParamInfo rep)]
forall {rep}. LambdaT rep -&gt; [Param (LParamInfo rep)]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684375326"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-253"></span><span>
</span><span id="line-254"></span><span class="hs-comment">-- | A lambda with no parameters that returns no values.</span><span>
</span><span id="line-255"></span><span id="local-6989586621684376376"><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#nilFn"><span class="hs-identifier hs-type">nilFn</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Builder.Class.html#Buildable"><span class="hs-identifier hs-type">Buildable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376376"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376376"><span class="hs-identifier hs-type">rep</span></a></span></span><span>
</span><span id="line-256"></span><span id="nilFn"><span class="annot"><span class="annottext">nilFn :: forall rep. Buildable rep =&gt; Lambda rep
</span><a href="Futhark.IR.SOACS.SOAC.html#nilFn"><span class="hs-identifier hs-var hs-var">nilFn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[LParam rep] -&gt; BodyT rep -&gt; [Type] -&gt; LambdaT rep
forall rep. [LParam rep] -&gt; BodyT rep -&gt; [Type] -&gt; LambdaT rep
</span><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-var">Lambda</span></a></span><span> </span><span class="annot"><span class="annottext">[LParam rep]
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms rep -&gt; Result -&gt; BodyT rep
forall rep. Buildable rep =&gt; Stms rep -&gt; Result -&gt; Body rep
</span><a href="Futhark.Builder.Class.html#mkBody"><span class="hs-identifier hs-var">mkBody</span></a></span><span> </span><span class="annot"><span class="annottext">Stms rep
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">Result
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Type]
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-257"></span><span>
</span><span id="line-258"></span><span class="hs-comment">-- | Construct a Screma with possibly multiple scans, and</span><span>
</span><span id="line-259"></span><span class="hs-comment">-- the given map function.</span><span>
</span><span id="line-260"></span><span id="local-6989586621684376373"><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#scanomapSOAC"><span class="hs-identifier hs-type">scanomapSOAC</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Scan"><span class="hs-identifier hs-type">Scan</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376373"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376373"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#ScremaForm"><span class="hs-identifier hs-type">ScremaForm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376373"><span class="hs-identifier hs-type">rep</span></a></span></span><span>
</span><span id="line-261"></span><span id="scanomapSOAC"><span class="annot"><span class="annottext">scanomapSOAC :: forall rep. [Scan rep] -&gt; Lambda rep -&gt; ScremaForm rep
</span><a href="Futhark.IR.SOACS.SOAC.html#scanomapSOAC"><span class="hs-identifier hs-var hs-var">scanomapSOAC</span></a></span></span><span> </span><span id="local-6989586621684375312"><span class="annot"><span class="annottext">[Scan rep]
</span><a href="#local-6989586621684375312"><span class="hs-identifier hs-var">scans</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Scan rep] -&gt; [Reduce rep] -&gt; Lambda rep -&gt; ScremaForm rep
forall rep.
[Scan rep] -&gt; [Reduce rep] -&gt; Lambda rep -&gt; ScremaForm rep
</span><a href="Futhark.IR.SOACS.SOAC.html#ScremaForm"><span class="hs-identifier hs-var">ScremaForm</span></a></span><span> </span><span class="annot"><span class="annottext">[Scan rep]
</span><a href="#local-6989586621684375312"><span class="hs-identifier hs-var">scans</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-262"></span><span>
</span><span id="line-263"></span><span class="hs-comment">-- | Construct a Screma with possibly multiple reductions, and</span><span>
</span><span id="line-264"></span><span class="hs-comment">-- the given map function.</span><span>
</span><span id="line-265"></span><span id="local-6989586621684376370"><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#redomapSOAC"><span class="hs-identifier hs-type">redomapSOAC</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Reduce"><span class="hs-identifier hs-type">Reduce</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376370"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376370"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#ScremaForm"><span class="hs-identifier hs-type">ScremaForm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376370"><span class="hs-identifier hs-type">rep</span></a></span></span><span>
</span><span id="line-266"></span><span id="redomapSOAC"><span class="annot"><span class="annottext">redomapSOAC :: forall rep. [Reduce rep] -&gt; Lambda rep -&gt; ScremaForm rep
</span><a href="Futhark.IR.SOACS.SOAC.html#redomapSOAC"><span class="hs-identifier hs-var hs-var">redomapSOAC</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Scan rep] -&gt; [Reduce rep] -&gt; Lambda rep -&gt; ScremaForm rep
forall rep.
[Scan rep] -&gt; [Reduce rep] -&gt; Lambda rep -&gt; ScremaForm rep
</span><a href="Futhark.IR.SOACS.SOAC.html#ScremaForm"><span class="hs-identifier hs-var">ScremaForm</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-267"></span><span>
</span><span id="line-268"></span><span class="hs-comment">-- | Construct a Screma with possibly multiple scans, and identity map</span><span>
</span><span id="line-269"></span><span class="hs-comment">-- function.</span><span>
</span><span id="line-270"></span><span id="local-6989586621684376367"><span id="local-6989586621684376368"><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#scanSOAC"><span class="hs-identifier hs-type">scanSOAC</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-271"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Builder.Class.html#Buildable"><span class="hs-identifier hs-type">Buildable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376368"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.MonadFreshNames.html#MonadFreshNames"><span class="hs-identifier hs-type">MonadFreshNames</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376367"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-272"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Scan"><span class="hs-identifier hs-type">Scan</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376368"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-273"></span><span>  </span><span class="annot"><a href="#local-6989586621684376367"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#ScremaForm"><span class="hs-identifier hs-type">ScremaForm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376368"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-274"></span><span id="scanSOAC"><span class="annot"><span class="annottext">scanSOAC :: forall rep (m :: * -&gt; *).
(Buildable rep, MonadFreshNames m) =&gt;
[Scan rep] -&gt; m (ScremaForm rep)
</span><a href="Futhark.IR.SOACS.SOAC.html#scanSOAC"><span class="hs-identifier hs-var hs-var">scanSOAC</span></a></span></span><span> </span><span id="local-6989586621684375300"><span class="annot"><span class="annottext">[Scan rep]
</span><a href="#local-6989586621684375300"><span class="hs-identifier hs-var">scans</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Scan rep] -&gt; Lambda rep -&gt; ScremaForm rep
forall rep. [Scan rep] -&gt; Lambda rep -&gt; ScremaForm rep
</span><a href="Futhark.IR.SOACS.SOAC.html#scanomapSOAC"><span class="hs-identifier hs-var">scanomapSOAC</span></a></span><span> </span><span class="annot"><span class="annottext">[Scan rep]
</span><a href="#local-6989586621684375300"><span class="hs-identifier hs-var">scans</span></a></span><span> </span><span class="annot"><span class="annottext">(Lambda rep -&gt; ScremaForm rep)
-&gt; m (Lambda rep) -&gt; m (ScremaForm rep)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; m (Lambda rep)
forall rep (m :: * -&gt; *).
(Buildable rep, MonadFreshNames m) =&gt;
[Type] -&gt; m (Lambda rep)
</span><a href="Futhark.IR.SOACS.SOAC.html#mkIdentityLambda"><span class="hs-identifier hs-var">mkIdentityLambda</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684375298"><span class="hs-identifier hs-var">ts</span></a></span><span>
</span><span id="line-275"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-276"></span><span>    </span><span id="local-6989586621684375298"><span class="annot"><span class="annottext">ts :: [Type]
</span><a href="#local-6989586621684375298"><span class="hs-identifier hs-var hs-var">ts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Scan rep -&gt; [Type]) -&gt; [Scan rep] -&gt; [Type]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda rep -&gt; [Type]
forall rep. LambdaT rep -&gt; [Type]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">(Lambda rep -&gt; [Type])
-&gt; (Scan rep -&gt; Lambda rep) -&gt; Scan rep -&gt; [Type]
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Scan rep -&gt; Lambda rep
forall rep. Scan rep -&gt; Lambda rep
</span><a href="Futhark.IR.SOACS.SOAC.html#scanLambda"><span class="hs-identifier hs-var hs-var">scanLambda</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Scan rep]
</span><a href="#local-6989586621684375300"><span class="hs-identifier hs-var">scans</span></a></span><span>
</span><span id="line-277"></span><span>
</span><span id="line-278"></span><span class="hs-comment">-- | Construct a Screma with possibly multiple reductions, and</span><span>
</span><span id="line-279"></span><span class="hs-comment">-- identity map function.</span><span>
</span><span id="line-280"></span><span id="local-6989586621684376359"><span id="local-6989586621684376360"><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#reduceSOAC"><span class="hs-identifier hs-type">reduceSOAC</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-281"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Builder.Class.html#Buildable"><span class="hs-identifier hs-type">Buildable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376360"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.MonadFreshNames.html#MonadFreshNames"><span class="hs-identifier hs-type">MonadFreshNames</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376359"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-282"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Reduce"><span class="hs-identifier hs-type">Reduce</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376360"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-283"></span><span>  </span><span class="annot"><a href="#local-6989586621684376359"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#ScremaForm"><span class="hs-identifier hs-type">ScremaForm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376360"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-284"></span><span id="reduceSOAC"><span class="annot"><span class="annottext">reduceSOAC :: forall rep (m :: * -&gt; *).
(Buildable rep, MonadFreshNames m) =&gt;
[Reduce rep] -&gt; m (ScremaForm rep)
</span><a href="Futhark.IR.SOACS.SOAC.html#reduceSOAC"><span class="hs-identifier hs-var hs-var">reduceSOAC</span></a></span></span><span> </span><span id="local-6989586621684375288"><span class="annot"><span class="annottext">[Reduce rep]
</span><a href="#local-6989586621684375288"><span class="hs-identifier hs-var">reds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Reduce rep] -&gt; Lambda rep -&gt; ScremaForm rep
forall rep. [Reduce rep] -&gt; Lambda rep -&gt; ScremaForm rep
</span><a href="Futhark.IR.SOACS.SOAC.html#redomapSOAC"><span class="hs-identifier hs-var">redomapSOAC</span></a></span><span> </span><span class="annot"><span class="annottext">[Reduce rep]
</span><a href="#local-6989586621684375288"><span class="hs-identifier hs-var">reds</span></a></span><span> </span><span class="annot"><span class="annottext">(Lambda rep -&gt; ScremaForm rep)
-&gt; m (Lambda rep) -&gt; m (ScremaForm rep)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; m (Lambda rep)
forall rep (m :: * -&gt; *).
(Buildable rep, MonadFreshNames m) =&gt;
[Type] -&gt; m (Lambda rep)
</span><a href="Futhark.IR.SOACS.SOAC.html#mkIdentityLambda"><span class="hs-identifier hs-var">mkIdentityLambda</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684375287"><span class="hs-identifier hs-var">ts</span></a></span><span>
</span><span id="line-285"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-286"></span><span>    </span><span id="local-6989586621684375287"><span class="annot"><span class="annottext">ts :: [Type]
</span><a href="#local-6989586621684375287"><span class="hs-identifier hs-var hs-var">ts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Reduce rep -&gt; [Type]) -&gt; [Reduce rep] -&gt; [Type]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda rep -&gt; [Type]
forall rep. LambdaT rep -&gt; [Type]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">(Lambda rep -&gt; [Type])
-&gt; (Reduce rep -&gt; Lambda rep) -&gt; Reduce rep -&gt; [Type]
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Reduce rep -&gt; Lambda rep
forall rep. Reduce rep -&gt; Lambda rep
</span><a href="Futhark.IR.SOACS.SOAC.html#redLambda"><span class="hs-identifier hs-var hs-var">redLambda</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Reduce rep]
</span><a href="#local-6989586621684375288"><span class="hs-identifier hs-var">reds</span></a></span><span>
</span><span id="line-287"></span><span>
</span><span id="line-288"></span><span class="hs-comment">-- | Construct a Screma corresponding to a map.</span><span>
</span><span id="line-289"></span><span id="local-6989586621684376356"><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#mapSOAC"><span class="hs-identifier hs-type">mapSOAC</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376356"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#ScremaForm"><span class="hs-identifier hs-type">ScremaForm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376356"><span class="hs-identifier hs-type">rep</span></a></span></span><span>
</span><span id="line-290"></span><span id="mapSOAC"><span class="annot"><span class="annottext">mapSOAC :: forall rep. Lambda rep -&gt; ScremaForm rep
</span><a href="Futhark.IR.SOACS.SOAC.html#mapSOAC"><span class="hs-identifier hs-var hs-var">mapSOAC</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Scan rep] -&gt; [Reduce rep] -&gt; Lambda rep -&gt; ScremaForm rep
forall rep.
[Scan rep] -&gt; [Reduce rep] -&gt; Lambda rep -&gt; ScremaForm rep
</span><a href="Futhark.IR.SOACS.SOAC.html#ScremaForm"><span class="hs-identifier hs-var">ScremaForm</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-291"></span><span>
</span><span id="line-292"></span><span class="hs-comment">-- | Does this Screma correspond to a scan-map composition?</span><span>
</span><span id="line-293"></span><span id="local-6989586621684376354"><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#isScanomapSOAC"><span class="hs-identifier hs-type">isScanomapSOAC</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#ScremaForm"><span class="hs-identifier hs-type">ScremaForm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376354"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Scan"><span class="hs-identifier hs-type">Scan</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376354"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376354"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-294"></span><span id="isScanomapSOAC"><span class="annot"><span class="annottext">isScanomapSOAC :: forall rep. ScremaForm rep -&gt; Maybe ([Scan rep], Lambda rep)
</span><a href="Futhark.IR.SOACS.SOAC.html#isScanomapSOAC"><span class="hs-identifier hs-var hs-var">isScanomapSOAC</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#ScremaForm"><span class="hs-identifier hs-type">ScremaForm</span></a></span><span> </span><span id="local-6989586621684375277"><span class="annot"><span class="annottext">[Scan rep]
</span><a href="#local-6989586621684375277"><span class="hs-identifier hs-var">scans</span></a></span></span><span> </span><span id="local-6989586621684375276"><span class="annot"><span class="annottext">[Reduce rep]
</span><a href="#local-6989586621684375276"><span class="hs-identifier hs-var">reds</span></a></span></span><span> </span><span id="local-6989586621684375275"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684375275"><span class="hs-identifier hs-var">map_lam</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-295"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; Maybe ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Maybe ()) -&gt; Bool -&gt; Maybe ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Reduce rep] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[Reduce rep]
</span><a href="#local-6989586621684375276"><span class="hs-identifier hs-var">reds</span></a></span><span>
</span><span id="line-296"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; Maybe ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Maybe ()) -&gt; Bool -&gt; Maybe ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Scan rep] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[Scan rep]
</span><a href="#local-6989586621684375277"><span class="hs-identifier hs-var">scans</span></a></span><span>
</span><span id="line-297"></span><span>  </span><span class="annot"><span class="annottext">([Scan rep], Lambda rep) -&gt; Maybe ([Scan rep], Lambda rep)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Scan rep]
</span><a href="#local-6989586621684375277"><span class="hs-identifier hs-var">scans</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684375275"><span class="hs-identifier hs-var">map_lam</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-298"></span><span>
</span><span id="line-299"></span><span class="hs-comment">-- | Does this Screma correspond to pure scan?</span><span>
</span><span id="line-300"></span><span id="local-6989586621684376349"><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#isScanSOAC"><span class="hs-identifier hs-type">isScanSOAC</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#ScremaForm"><span class="hs-identifier hs-type">ScremaForm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376349"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Scan"><span class="hs-identifier hs-type">Scan</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376349"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">]</span></span><span>
</span><span id="line-301"></span><span id="isScanSOAC"><span class="annot"><span class="annottext">isScanSOAC :: forall rep. ScremaForm rep -&gt; Maybe [Scan rep]
</span><a href="Futhark.IR.SOACS.SOAC.html#isScanSOAC"><span class="hs-identifier hs-var hs-var">isScanSOAC</span></a></span></span><span> </span><span id="local-6989586621684375268"><span class="annot"><span class="annottext">ScremaForm rep
</span><a href="#local-6989586621684375268"><span class="hs-identifier hs-var">form</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-302"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684375267"><span class="annot"><span class="annottext">[Scan rep]
</span><a href="#local-6989586621684375267"><span class="hs-identifier hs-var">scans</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684375266"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684375266"><span class="hs-identifier hs-var">map_lam</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ScremaForm rep -&gt; Maybe ([Scan rep], Lambda rep)
forall rep. ScremaForm rep -&gt; Maybe ([Scan rep], Lambda rep)
</span><a href="Futhark.IR.SOACS.SOAC.html#isScanomapSOAC"><span class="hs-identifier hs-var">isScanomapSOAC</span></a></span><span> </span><span class="annot"><span class="annottext">ScremaForm rep
</span><a href="#local-6989586621684375268"><span class="hs-identifier hs-var">form</span></a></span><span>
</span><span id="line-303"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; Maybe ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Maybe ()) -&gt; Bool -&gt; Maybe ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; Bool
forall rep. Lambda rep -&gt; Bool
</span><a href="Futhark.IR.SOACS.SOAC.html#isIdentityLambda"><span class="hs-identifier hs-var">isIdentityLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684375266"><span class="hs-identifier hs-var">map_lam</span></a></span><span>
</span><span id="line-304"></span><span>  </span><span class="annot"><span class="annottext">[Scan rep] -&gt; Maybe [Scan rep]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">[Scan rep]
</span><a href="#local-6989586621684375267"><span class="hs-identifier hs-var">scans</span></a></span><span>
</span><span id="line-305"></span><span>
</span><span id="line-306"></span><span class="hs-comment">-- | Does this Screma correspond to a reduce-map composition?</span><span>
</span><span id="line-307"></span><span id="local-6989586621684376347"><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#isRedomapSOAC"><span class="hs-identifier hs-type">isRedomapSOAC</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#ScremaForm"><span class="hs-identifier hs-type">ScremaForm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376347"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Reduce"><span class="hs-identifier hs-type">Reduce</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376347"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376347"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-308"></span><span id="isRedomapSOAC"><span class="annot"><span class="annottext">isRedomapSOAC :: forall rep. ScremaForm rep -&gt; Maybe ([Reduce rep], Lambda rep)
</span><a href="Futhark.IR.SOACS.SOAC.html#isRedomapSOAC"><span class="hs-identifier hs-var hs-var">isRedomapSOAC</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#ScremaForm"><span class="hs-identifier hs-type">ScremaForm</span></a></span><span> </span><span id="local-6989586621684375258"><span class="annot"><span class="annottext">[Scan rep]
</span><a href="#local-6989586621684375258"><span class="hs-identifier hs-var">scans</span></a></span></span><span> </span><span id="local-6989586621684375257"><span class="annot"><span class="annottext">[Reduce rep]
</span><a href="#local-6989586621684375257"><span class="hs-identifier hs-var">reds</span></a></span></span><span> </span><span id="local-6989586621684375256"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684375256"><span class="hs-identifier hs-var">map_lam</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-309"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; Maybe ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Maybe ()) -&gt; Bool -&gt; Maybe ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Scan rep] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[Scan rep]
</span><a href="#local-6989586621684375258"><span class="hs-identifier hs-var">scans</span></a></span><span>
</span><span id="line-310"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; Maybe ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Maybe ()) -&gt; Bool -&gt; Maybe ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Reduce rep] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[Reduce rep]
</span><a href="#local-6989586621684375257"><span class="hs-identifier hs-var">reds</span></a></span><span>
</span><span id="line-311"></span><span>  </span><span class="annot"><span class="annottext">([Reduce rep], Lambda rep) -&gt; Maybe ([Reduce rep], Lambda rep)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Reduce rep]
</span><a href="#local-6989586621684375257"><span class="hs-identifier hs-var">reds</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684375256"><span class="hs-identifier hs-var">map_lam</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-312"></span><span>
</span><span id="line-313"></span><span class="hs-comment">-- | Does this Screma correspond to a pure reduce?</span><span>
</span><span id="line-314"></span><span id="local-6989586621684376345"><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#isReduceSOAC"><span class="hs-identifier hs-type">isReduceSOAC</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#ScremaForm"><span class="hs-identifier hs-type">ScremaForm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376345"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Reduce"><span class="hs-identifier hs-type">Reduce</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376345"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">]</span></span><span>
</span><span id="line-315"></span><span id="isReduceSOAC"><span class="annot"><span class="annottext">isReduceSOAC :: forall rep. ScremaForm rep -&gt; Maybe [Reduce rep]
</span><a href="Futhark.IR.SOACS.SOAC.html#isReduceSOAC"><span class="hs-identifier hs-var hs-var">isReduceSOAC</span></a></span></span><span> </span><span id="local-6989586621684375251"><span class="annot"><span class="annottext">ScremaForm rep
</span><a href="#local-6989586621684375251"><span class="hs-identifier hs-var">form</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-316"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684375250"><span class="annot"><span class="annottext">[Reduce rep]
</span><a href="#local-6989586621684375250"><span class="hs-identifier hs-var">reds</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684375249"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684375249"><span class="hs-identifier hs-var">map_lam</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ScremaForm rep -&gt; Maybe ([Reduce rep], Lambda rep)
forall rep. ScremaForm rep -&gt; Maybe ([Reduce rep], Lambda rep)
</span><a href="Futhark.IR.SOACS.SOAC.html#isRedomapSOAC"><span class="hs-identifier hs-var">isRedomapSOAC</span></a></span><span> </span><span class="annot"><span class="annottext">ScremaForm rep
</span><a href="#local-6989586621684375251"><span class="hs-identifier hs-var">form</span></a></span><span>
</span><span id="line-317"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; Maybe ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Maybe ()) -&gt; Bool -&gt; Maybe ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; Bool
forall rep. Lambda rep -&gt; Bool
</span><a href="Futhark.IR.SOACS.SOAC.html#isIdentityLambda"><span class="hs-identifier hs-var">isIdentityLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684375249"><span class="hs-identifier hs-var">map_lam</span></a></span><span>
</span><span id="line-318"></span><span>  </span><span class="annot"><span class="annottext">[Reduce rep] -&gt; Maybe [Reduce rep]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">[Reduce rep]
</span><a href="#local-6989586621684375250"><span class="hs-identifier hs-var">reds</span></a></span><span>
</span><span id="line-319"></span><span>
</span><span id="line-320"></span><span class="hs-comment">-- | Does this Screma correspond to a simple map, without any</span><span>
</span><span id="line-321"></span><span class="hs-comment">-- reduction or scan results?</span><span>
</span><span id="line-322"></span><span id="local-6989586621684376343"><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#isMapSOAC"><span class="hs-identifier hs-type">isMapSOAC</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#ScremaForm"><span class="hs-identifier hs-type">ScremaForm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376343"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376343"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-323"></span><span id="isMapSOAC"><span class="annot"><span class="annottext">isMapSOAC :: forall rep. ScremaForm rep -&gt; Maybe (Lambda rep)
</span><a href="Futhark.IR.SOACS.SOAC.html#isMapSOAC"><span class="hs-identifier hs-var hs-var">isMapSOAC</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#ScremaForm"><span class="hs-identifier hs-type">ScremaForm</span></a></span><span> </span><span id="local-6989586621684375241"><span class="annot"><span class="annottext">[Scan rep]
</span><a href="#local-6989586621684375241"><span class="hs-identifier hs-var">scans</span></a></span></span><span> </span><span id="local-6989586621684375240"><span class="annot"><span class="annottext">[Reduce rep]
</span><a href="#local-6989586621684375240"><span class="hs-identifier hs-var">reds</span></a></span></span><span> </span><span id="local-6989586621684375239"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684375239"><span class="hs-identifier hs-var">map_lam</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-324"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; Maybe ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Maybe ()) -&gt; Bool -&gt; Maybe ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Scan rep] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[Scan rep]
</span><a href="#local-6989586621684375241"><span class="hs-identifier hs-var">scans</span></a></span><span>
</span><span id="line-325"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; Maybe ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Maybe ()) -&gt; Bool -&gt; Maybe ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Reduce rep] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[Reduce rep]
</span><a href="#local-6989586621684375240"><span class="hs-identifier hs-var">reds</span></a></span><span>
</span><span id="line-326"></span><span>  </span><span class="annot"><span class="annottext">Lambda rep -&gt; Maybe (Lambda rep)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684375239"><span class="hs-identifier hs-var">map_lam</span></a></span><span>
</span><span id="line-327"></span><span>
</span><span id="line-328"></span><span class="hs-comment">-- | Return the &quot;main&quot; lambda of the Screma.  For a map, this is</span><span>
</span><span id="line-329"></span><span class="hs-comment">-- equivalent to 'isMapSOAC'.  Note that the meaning of the return</span><span>
</span><span id="line-330"></span><span class="hs-comment">-- value of this lambda depends crucially on exactly which Screma this</span><span>
</span><span id="line-331"></span><span class="hs-comment">-- is.  The parameters will correspond exactly to elements of the</span><span>
</span><span id="line-332"></span><span class="hs-comment">-- input arrays, however.</span><span>
</span><span id="line-333"></span><span id="local-6989586621684376341"><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#scremaLambda"><span class="hs-identifier hs-type">scremaLambda</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#ScremaForm"><span class="hs-identifier hs-type">ScremaForm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376341"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376341"><span class="hs-identifier hs-type">rep</span></a></span></span><span>
</span><span id="line-334"></span><span id="scremaLambda"><span class="annot"><span class="annottext">scremaLambda :: forall rep. ScremaForm rep -&gt; Lambda rep
</span><a href="Futhark.IR.SOACS.SOAC.html#scremaLambda"><span class="hs-identifier hs-var hs-var">scremaLambda</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#ScremaForm"><span class="hs-identifier hs-type">ScremaForm</span></a></span><span> </span><span class="annot"><span class="annottext">[Scan rep]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[Reduce rep]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684375238"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684375238"><span class="hs-identifier hs-var">map_lam</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684375238"><span class="hs-identifier hs-var">map_lam</span></a></span><span>
</span><span id="line-335"></span><span>
</span><span id="line-336"></span><span class="hs-comment">-- | @groupScatterResults &lt;output specification&gt; &lt;results&gt;@</span><span>
</span><span id="line-337"></span><span class="hs-comment">--</span><span>
</span><span id="line-338"></span><span class="hs-comment">-- Groups the index values and result values of &lt;results&gt; according to the</span><span>
</span><span id="line-339"></span><span class="hs-comment">-- &lt;output specification&gt;.</span><span>
</span><span id="line-340"></span><span class="hs-comment">--</span><span>
</span><span id="line-341"></span><span class="hs-comment">-- This function is used for extracting and grouping the results of a</span><span>
</span><span id="line-342"></span><span class="hs-comment">-- scatter. In the SOAC representation, the lambda inside a 'Scatter' returns</span><span>
</span><span id="line-343"></span><span class="hs-comment">-- all indices and values as one big list. This function groups each value with</span><span>
</span><span id="line-344"></span><span class="hs-comment">-- its corresponding indices (as determined by the t'Shape' of the output array).</span><span>
</span><span id="line-345"></span><span class="hs-comment">--</span><span>
</span><span id="line-346"></span><span class="hs-comment">-- The elements of the resulting list correspond to the shape and name of the</span><span>
</span><span id="line-347"></span><span class="hs-comment">-- output parameters, in addition to a list of values written to that output</span><span>
</span><span id="line-348"></span><span class="hs-comment">-- parameter, along with the array indices marking where to write them to.</span><span>
</span><span id="line-349"></span><span class="hs-comment">--</span><span>
</span><span id="line-350"></span><span class="hs-comment">-- See 'Scatter' for more information.</span><span>
</span><span id="line-351"></span><span id="local-6989586621684376338"><span id="local-6989586621684376339"><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#groupScatterResults"><span class="hs-identifier hs-type">groupScatterResults</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-type">Shape</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621684376339"><span class="hs-identifier hs-type">array</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621684376338"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-type">Shape</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621684376339"><span class="hs-identifier hs-type">array</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621684376338"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621684376338"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span></span></span><span>
</span><span id="line-352"></span><span id="groupScatterResults"><span class="annot"><span class="annottext">groupScatterResults :: forall array a.
[(Shape, Int, array)] -&gt; [a] -&gt; [(Shape, array, [([a], a)])]
</span><a href="Futhark.IR.SOACS.SOAC.html#groupScatterResults"><span class="hs-identifier hs-var hs-var">groupScatterResults</span></a></span></span><span> </span><span id="local-6989586621684375237"><span class="annot"><span class="annottext">[(Shape, Int, array)]
</span><a href="#local-6989586621684375237"><span class="hs-identifier hs-var">output_spec</span></a></span></span><span> </span><span id="local-6989586621684375236"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684375236"><span class="hs-identifier hs-var">results</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-353"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684375235"><span class="annot"><span class="annottext">[Shape]
</span><a href="#local-6989586621684375235"><span class="hs-identifier hs-var">shapes</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684375234"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684375234"><span class="hs-identifier hs-var">ns</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684375233"><span class="annot"><span class="annottext">[array]
</span><a href="#local-6989586621684375233"><span class="hs-identifier hs-var">arrays</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Shape, Int, array)] -&gt; ([Shape], [Int], [array])
forall a b c. [(a, b, c)] -&gt; ([a], [b], [c])
</span><span class="hs-identifier hs-var">unzip3</span></span><span> </span><span class="annot"><span class="annottext">[(Shape, Int, array)]
</span><a href="#local-6989586621684375237"><span class="hs-identifier hs-var">output_spec</span></a></span><span>
</span><span id="line-354"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">[(Shape, Int, array)] -&gt; [a] -&gt; [([a], a)]
forall array a. [(Shape, Int, array)] -&gt; [a] -&gt; [([a], a)]
</span><a href="Futhark.IR.SOACS.SOAC.html#groupScatterResults%27"><span class="hs-identifier hs-var">groupScatterResults'</span></a></span><span> </span><span class="annot"><span class="annottext">[(Shape, Int, array)]
</span><a href="#local-6989586621684375237"><span class="hs-identifier hs-var">output_spec</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684375236"><span class="hs-identifier hs-var">results</span></a></span><span>
</span><span id="line-355"></span><span>        </span><span class="annot"><span class="annottext">[([a], a)] -&gt; ([([a], a)] -&gt; [[([a], a)]]) -&gt; [[([a], a)]]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; [([a], a)] -&gt; [[([a], a)]]
forall a. [Int] -&gt; [a] -&gt; [[a]]
</span><a href="Futhark.Util.html#chunks"><span class="hs-identifier hs-var">chunks</span></a></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684375234"><span class="hs-identifier hs-var">ns</span></a></span><span>
</span><span id="line-356"></span><span>        </span><span class="annot"><span class="annottext">[[([a], a)]]
-&gt; ([[([a], a)]] -&gt; [(Shape, array, [([a], a)])])
-&gt; [(Shape, array, [([a], a)])]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">[Shape] -&gt; [array] -&gt; [[([a], a)]] -&gt; [(Shape, array, [([a], a)])]
forall a b c. [a] -&gt; [b] -&gt; [c] -&gt; [(a, b, c)]
</span><span class="hs-identifier hs-var">zip3</span></span><span> </span><span class="annot"><span class="annottext">[Shape]
</span><a href="#local-6989586621684375235"><span class="hs-identifier hs-var">shapes</span></a></span><span> </span><span class="annot"><span class="annottext">[array]
</span><a href="#local-6989586621684375233"><span class="hs-identifier hs-var">arrays</span></a></span><span>
</span><span id="line-357"></span><span>
</span><span id="line-358"></span><span class="hs-comment">-- | @groupScatterResults' &lt;output specification&gt; &lt;results&gt;@</span><span>
</span><span id="line-359"></span><span class="hs-comment">--</span><span>
</span><span id="line-360"></span><span class="hs-comment">-- Groups the index values and result values of &lt;results&gt; according to the</span><span>
</span><span id="line-361"></span><span class="hs-comment">-- output specification. This is the simpler version of @groupScatterResults@,</span><span>
</span><span id="line-362"></span><span class="hs-comment">-- which doesn't return any information about shapes or output arrays.</span><span>
</span><span id="line-363"></span><span class="hs-comment">--</span><span>
</span><span id="line-364"></span><span class="hs-comment">-- See 'groupScatterResults' for more information,</span><span>
</span><span id="line-365"></span><span id="local-6989586621684376331"><span id="local-6989586621684376332"><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#groupScatterResults%27"><span class="hs-identifier hs-type">groupScatterResults'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-type">Shape</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621684376332"><span class="hs-identifier hs-type">array</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621684376331"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621684376331"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621684376331"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span></span></span><span>
</span><span id="line-366"></span><span id="groupScatterResults%27"><span class="annot"><span class="annottext">groupScatterResults' :: forall array a. [(Shape, Int, array)] -&gt; [a] -&gt; [([a], a)]
</span><a href="Futhark.IR.SOACS.SOAC.html#groupScatterResults%27"><span class="hs-identifier hs-var hs-var">groupScatterResults'</span></a></span></span><span> </span><span id="local-6989586621684375227"><span class="annot"><span class="annottext">[(Shape, Int, array)]
</span><a href="#local-6989586621684375227"><span class="hs-identifier hs-var">output_spec</span></a></span></span><span> </span><span id="local-6989586621684375226"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684375226"><span class="hs-identifier hs-var">results</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-367"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684375225"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684375225"><span class="hs-identifier hs-var">indices</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684375224"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684375224"><span class="hs-identifier hs-var">values</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Shape, Int, array)] -&gt; [a] -&gt; ([a], [a])
forall array a. [(Shape, Int, array)] -&gt; [a] -&gt; ([a], [a])
</span><a href="Futhark.IR.SOACS.SOAC.html#splitScatterResults"><span class="hs-identifier hs-var">splitScatterResults</span></a></span><span> </span><span class="annot"><span class="annottext">[(Shape, Int, array)]
</span><a href="#local-6989586621684375227"><span class="hs-identifier hs-var">output_spec</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684375226"><span class="hs-identifier hs-var">results</span></a></span><span>
</span><span id="line-368"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684375223"><span class="annot"><span class="annottext">[Shape]
</span><a href="#local-6989586621684375223"><span class="hs-identifier hs-var">shapes</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684375222"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684375222"><span class="hs-identifier hs-var">ns</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[array]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Shape, Int, array)] -&gt; ([Shape], [Int], [array])
forall a b c. [(a, b, c)] -&gt; ([a], [b], [c])
</span><span class="hs-identifier hs-var">unzip3</span></span><span> </span><span class="annot"><span class="annottext">[(Shape, Int, array)]
</span><a href="#local-6989586621684375227"><span class="hs-identifier hs-var">output_spec</span></a></span><span>
</span><span id="line-369"></span><span>      </span><span id="local-6989586621684375221"><span class="annot"><span class="annottext">chunk_sizes :: [Int]
</span><a href="#local-6989586621684375221"><span class="hs-identifier hs-var hs-var">chunk_sizes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-370"></span><span>        </span><span class="annot"><span class="annottext">[[Int]] -&gt; [Int]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span> </span><span class="annot"><span class="annottext">([[Int]] -&gt; [Int]) -&gt; [[Int]] -&gt; [Int]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Shape -&gt; Int -&gt; [Int]) -&gt; [Shape] -&gt; [Int] -&gt; [[Int]]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621684375218"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684375218"><span class="hs-identifier hs-var">shp</span></a></span></span><span> </span><span id="local-6989586621684375217"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684375217"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; [Int]
forall a. Int -&gt; a -&gt; [a]
</span><span class="hs-identifier hs-var">replicate</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684375217"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; [Int]) -&gt; Int -&gt; [Int]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Shape -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684375218"><span class="hs-identifier hs-var">shp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Shape]
</span><a href="#local-6989586621684375223"><span class="hs-identifier hs-var">shapes</span></a></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684375222"><span class="hs-identifier hs-var">ns</span></a></span><span>
</span><span id="line-371"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">[[a]] -&gt; [a] -&gt; [([a], a)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Int] -&gt; [a] -&gt; [[a]]
forall a. [Int] -&gt; [a] -&gt; [[a]]
</span><a href="Futhark.Util.html#chunks"><span class="hs-identifier hs-var">chunks</span></a></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684375221"><span class="hs-identifier hs-var">chunk_sizes</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684375225"><span class="hs-identifier hs-var">indices</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684375224"><span class="hs-identifier hs-var">values</span></a></span><span>
</span><span id="line-372"></span><span>
</span><span id="line-373"></span><span class="hs-comment">-- | @splitScatterResults &lt;output specification&gt; &lt;results&gt;@</span><span>
</span><span id="line-374"></span><span class="hs-comment">--</span><span>
</span><span id="line-375"></span><span class="hs-comment">-- Splits the results array into indices and values according to the output</span><span>
</span><span id="line-376"></span><span class="hs-comment">-- specification.</span><span>
</span><span id="line-377"></span><span class="hs-comment">--</span><span>
</span><span id="line-378"></span><span class="hs-comment">-- See 'groupScatterResults' for more information.</span><span>
</span><span id="line-379"></span><span id="local-6989586621684376321"><span id="local-6989586621684376322"><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#splitScatterResults"><span class="hs-identifier hs-type">splitScatterResults</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-type">Shape</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621684376322"><span class="hs-identifier hs-type">array</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621684376321"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621684376321"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621684376321"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-380"></span><span id="splitScatterResults"><span class="annot"><span class="annottext">splitScatterResults :: forall array a. [(Shape, Int, array)] -&gt; [a] -&gt; ([a], [a])
</span><a href="Futhark.IR.SOACS.SOAC.html#splitScatterResults"><span class="hs-identifier hs-var hs-var">splitScatterResults</span></a></span></span><span> </span><span id="local-6989586621684375211"><span class="annot"><span class="annottext">[(Shape, Int, array)]
</span><a href="#local-6989586621684375211"><span class="hs-identifier hs-var">output_spec</span></a></span></span><span> </span><span id="local-6989586621684375210"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684375210"><span class="hs-identifier hs-var">results</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-381"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684375209"><span class="annot"><span class="annottext">[Shape]
</span><a href="#local-6989586621684375209"><span class="hs-identifier hs-var">shapes</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684375208"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684375208"><span class="hs-identifier hs-var">ns</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[array]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Shape, Int, array)] -&gt; ([Shape], [Int], [array])
forall a b c. [(a, b, c)] -&gt; ([a], [b], [c])
</span><span class="hs-identifier hs-var">unzip3</span></span><span> </span><span class="annot"><span class="annottext">[(Shape, Int, array)]
</span><a href="#local-6989586621684375211"><span class="hs-identifier hs-var">output_spec</span></a></span><span>
</span><span id="line-382"></span><span>      </span><span id="local-6989586621684375207"><span class="annot"><span class="annottext">num_indices :: Int
</span><a href="#local-6989586621684375207"><span class="hs-identifier hs-var hs-var">num_indices</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; Int
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">sum</span></span><span> </span><span class="annot"><span class="annottext">([Int] -&gt; Int) -&gt; [Int] -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Int -&gt; Int) -&gt; [Int] -&gt; [Int] -&gt; [Int]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">(*)</span></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684375208"><span class="hs-identifier hs-var">ns</span></a></span><span> </span><span class="annot"><span class="annottext">([Int] -&gt; [Int]) -&gt; [Int] -&gt; [Int]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Shape -&gt; Int) -&gt; [Shape] -&gt; [Int]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Shape -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Shape]
</span><a href="#local-6989586621684375209"><span class="hs-identifier hs-var">shapes</span></a></span><span>
</span><span id="line-383"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [a] -&gt; ([a], [a])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684375207"><span class="hs-identifier hs-var">num_indices</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684375210"><span class="hs-identifier hs-var">results</span></a></span><span>
</span><span id="line-384"></span><span>
</span><span id="line-385"></span><span class="hs-comment">-- | Like 'Mapper', but just for 'SOAC's.</span><span>
</span><span id="line-386"></span><span class="hs-keyword">data</span><span> </span><span id="SOACMapper"><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#SOACMapper"><span class="hs-identifier hs-var">SOACMapper</span></a></span></span><span> </span><span id="local-6989586621684376309"><span class="annot"><a href="#local-6989586621684376309"><span class="hs-identifier hs-type">frep</span></a></span></span><span> </span><span id="local-6989586621684376308"><span class="annot"><a href="#local-6989586621684376308"><span class="hs-identifier hs-type">trep</span></a></span></span><span> </span><span id="local-6989586621684376307"><span class="annot"><a href="#local-6989586621684376307"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="SOACMapper"><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#SOACMapper"><span class="hs-identifier hs-var">SOACMapper</span></a></span></span><span>
</span><span id="line-387"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="mapOnSOACSubExp"><span class="annot"><span class="annottext">forall frep trep (m :: * -&gt; *).
SOACMapper frep trep m -&gt; SubExp -&gt; m SubExp
</span><a href="Futhark.IR.SOACS.SOAC.html#mapOnSOACSubExp"><span class="hs-identifier hs-var hs-var">mapOnSOACSubExp</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684376307"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-388"></span><span>    </span><span id="mapOnSOACLambda"><span class="annot"><span class="annottext">forall frep trep (m :: * -&gt; *).
SOACMapper frep trep m -&gt; Lambda frep -&gt; m (Lambda trep)
</span><a href="Futhark.IR.SOACS.SOAC.html#mapOnSOACLambda"><span class="hs-identifier hs-var hs-var">mapOnSOACLambda</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376309"><span class="hs-identifier hs-type">frep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684376307"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376308"><span class="hs-identifier hs-type">trep</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-389"></span><span>    </span><span id="mapOnSOACVName"><span class="annot"><span class="annottext">forall frep trep (m :: * -&gt; *).
SOACMapper frep trep m -&gt; VName -&gt; m VName
</span><a href="Futhark.IR.SOACS.SOAC.html#mapOnSOACVName"><span class="hs-identifier hs-var hs-var">mapOnSOACVName</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684376307"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span>
</span><span id="line-390"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-391"></span><span>
</span><span id="line-392"></span><span class="hs-comment">-- | A mapper that simply returns the SOAC verbatim.</span><span>
</span><span id="line-393"></span><span id="local-6989586621684376295"><span id="local-6989586621684376296"><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#identitySOACMapper"><span class="hs-identifier hs-type">identitySOACMapper</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621684376296"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#SOACMapper"><span class="hs-identifier hs-type">SOACMapper</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376295"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376295"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376296"><span class="hs-identifier hs-type">m</span></a></span></span></span><span>
</span><span id="line-394"></span><span id="identitySOACMapper"><span class="annot"><span class="annottext">identitySOACMapper :: forall (m :: * -&gt; *) rep. Monad m =&gt; SOACMapper rep rep m
</span><a href="Futhark.IR.SOACS.SOAC.html#identitySOACMapper"><span class="hs-identifier hs-var hs-var">identitySOACMapper</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-395"></span><span>  </span><span class="annot"><span class="annottext">SOACMapper :: forall frep trep (m :: * -&gt; *).
(SubExp -&gt; m SubExp)
-&gt; (Lambda frep -&gt; m (Lambda trep))
-&gt; (VName -&gt; m VName)
-&gt; SOACMapper frep trep m
</span><a href="Futhark.IR.SOACS.SOAC.html#SOACMapper"><span class="hs-identifier hs-type">SOACMapper</span></a></span><span>
</span><span id="line-396"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">mapOnSOACSubExp :: SubExp -&gt; m SubExp
</span><a href="Futhark.IR.SOACS.SOAC.html#mapOnSOACSubExp"><span class="hs-identifier hs-var">mapOnSOACSubExp</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; m SubExp
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span class="hs-special">,</span><span>
</span><span id="line-397"></span><span>      </span><span class="annot"><span class="annottext">mapOnSOACLambda :: Lambda rep -&gt; m (Lambda rep)
</span><a href="Futhark.IR.SOACS.SOAC.html#mapOnSOACLambda"><span class="hs-identifier hs-var">mapOnSOACLambda</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; m (Lambda rep)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span class="hs-special">,</span><span>
</span><span id="line-398"></span><span>      </span><span class="annot"><span class="annottext">mapOnSOACVName :: VName -&gt; m VName
</span><a href="Futhark.IR.SOACS.SOAC.html#mapOnSOACVName"><span class="hs-identifier hs-var">mapOnSOACVName</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; m VName
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-399"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-400"></span><span>
</span><span id="line-401"></span><span class="hs-comment">-- | Map a monadic action across the immediate children of a</span><span>
</span><span id="line-402"></span><span class="hs-comment">-- SOAC.  The mapping does not descend recursively into subexpressions</span><span>
</span><span id="line-403"></span><span class="hs-comment">-- and is done left-to-right.</span><span>
</span><span id="line-404"></span><span id="local-6989586621684376290"><span id="local-6989586621684376291"><span id="local-6989586621684376292"><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#mapSOACM"><span class="hs-identifier hs-type">mapSOACM</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-405"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Applicative</span></span><span> </span><span class="annot"><a href="#local-6989586621684376292"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621684376292"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-406"></span><span>  </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#SOACMapper"><span class="hs-identifier hs-type">SOACMapper</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376291"><span class="hs-identifier hs-type">frep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376290"><span class="hs-identifier hs-type">trep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376292"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-407"></span><span>  </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#SOAC"><span class="hs-identifier hs-type">SOAC</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376291"><span class="hs-identifier hs-type">frep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-408"></span><span>  </span><span class="annot"><a href="#local-6989586621684376292"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#SOAC"><span class="hs-identifier hs-type">SOAC</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376290"><span class="hs-identifier hs-type">trep</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-409"></span><span id="mapSOACM"><span class="annot"><span class="annottext">mapSOACM :: forall (m :: * -&gt; *) frep trep.
(Applicative m, Monad m) =&gt;
SOACMapper frep trep m -&gt; SOAC frep -&gt; m (SOAC trep)
</span><a href="Futhark.IR.SOACS.SOAC.html#mapSOACM"><span class="hs-identifier hs-var hs-var">mapSOACM</span></a></span></span><span> </span><span id="local-6989586621684375112"><span class="annot"><span class="annottext">SOACMapper frep trep m
</span><a href="#local-6989586621684375112"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#JVP"><span class="hs-identifier hs-type">JVP</span></a></span><span> </span><span id="local-6989586621684375111"><span class="annot"><span class="annottext">Lambda frep
</span><a href="#local-6989586621684375111"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span id="local-6989586621684375110"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684375110"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621684375109"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684375109"><span class="hs-identifier hs-var">vec</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-410"></span><span>  </span><span class="annot"><span class="annottext">Lambda trep -&gt; [SubExp] -&gt; [SubExp] -&gt; SOAC trep
forall rep. Lambda rep -&gt; [SubExp] -&gt; [SubExp] -&gt; SOAC rep
</span><a href="Futhark.IR.SOACS.SOAC.html#JVP"><span class="hs-identifier hs-var">JVP</span></a></span><span> </span><span class="annot"><span class="annottext">(Lambda trep -&gt; [SubExp] -&gt; [SubExp] -&gt; SOAC trep)
-&gt; m (Lambda trep) -&gt; m ([SubExp] -&gt; [SubExp] -&gt; SOAC trep)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">SOACMapper frep trep m -&gt; Lambda frep -&gt; m (Lambda trep)
forall frep trep (m :: * -&gt; *).
SOACMapper frep trep m -&gt; Lambda frep -&gt; m (Lambda trep)
</span><a href="Futhark.IR.SOACS.SOAC.html#mapOnSOACLambda"><span class="hs-identifier hs-var hs-var">mapOnSOACLambda</span></a></span><span> </span><span class="annot"><span class="annottext">SOACMapper frep trep m
</span><a href="#local-6989586621684375112"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda frep
</span><a href="#local-6989586621684375111"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-411"></span><span>    </span><span class="annot"><span class="annottext">m ([SubExp] -&gt; [SubExp] -&gt; SOAC trep)
-&gt; m [SubExp] -&gt; m ([SubExp] -&gt; SOAC trep)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; m SubExp) -&gt; [SubExp] -&gt; m [SubExp]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SOACMapper frep trep m -&gt; SubExp -&gt; m SubExp
forall frep trep (m :: * -&gt; *).
SOACMapper frep trep m -&gt; SubExp -&gt; m SubExp
</span><a href="Futhark.IR.SOACS.SOAC.html#mapOnSOACSubExp"><span class="hs-identifier hs-var hs-var">mapOnSOACSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">SOACMapper frep trep m
</span><a href="#local-6989586621684375112"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684375110"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-412"></span><span>    </span><span class="annot"><span class="annottext">m ([SubExp] -&gt; SOAC trep) -&gt; m [SubExp] -&gt; m (SOAC trep)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; m SubExp) -&gt; [SubExp] -&gt; m [SubExp]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SOACMapper frep trep m -&gt; SubExp -&gt; m SubExp
forall frep trep (m :: * -&gt; *).
SOACMapper frep trep m -&gt; SubExp -&gt; m SubExp
</span><a href="Futhark.IR.SOACS.SOAC.html#mapOnSOACSubExp"><span class="hs-identifier hs-var hs-var">mapOnSOACSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">SOACMapper frep trep m
</span><a href="#local-6989586621684375112"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684375109"><span class="hs-identifier hs-var">vec</span></a></span><span>
</span><span id="line-413"></span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#mapSOACM"><span class="hs-identifier hs-var">mapSOACM</span></a></span><span> </span><span id="local-6989586621684375108"><span class="annot"><span class="annottext">SOACMapper frep trep m
</span><a href="#local-6989586621684375108"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#VJP"><span class="hs-identifier hs-type">VJP</span></a></span><span> </span><span id="local-6989586621684375107"><span class="annot"><span class="annottext">Lambda frep
</span><a href="#local-6989586621684375107"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span id="local-6989586621684375106"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684375106"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621684375105"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684375105"><span class="hs-identifier hs-var">vec</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-414"></span><span>  </span><span class="annot"><span class="annottext">Lambda trep -&gt; [SubExp] -&gt; [SubExp] -&gt; SOAC trep
forall rep. Lambda rep -&gt; [SubExp] -&gt; [SubExp] -&gt; SOAC rep
</span><a href="Futhark.IR.SOACS.SOAC.html#VJP"><span class="hs-identifier hs-var">VJP</span></a></span><span> </span><span class="annot"><span class="annottext">(Lambda trep -&gt; [SubExp] -&gt; [SubExp] -&gt; SOAC trep)
-&gt; m (Lambda trep) -&gt; m ([SubExp] -&gt; [SubExp] -&gt; SOAC trep)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">SOACMapper frep trep m -&gt; Lambda frep -&gt; m (Lambda trep)
forall frep trep (m :: * -&gt; *).
SOACMapper frep trep m -&gt; Lambda frep -&gt; m (Lambda trep)
</span><a href="Futhark.IR.SOACS.SOAC.html#mapOnSOACLambda"><span class="hs-identifier hs-var hs-var">mapOnSOACLambda</span></a></span><span> </span><span class="annot"><span class="annottext">SOACMapper frep trep m
</span><a href="#local-6989586621684375108"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda frep
</span><a href="#local-6989586621684375107"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-415"></span><span>    </span><span class="annot"><span class="annottext">m ([SubExp] -&gt; [SubExp] -&gt; SOAC trep)
-&gt; m [SubExp] -&gt; m ([SubExp] -&gt; SOAC trep)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; m SubExp) -&gt; [SubExp] -&gt; m [SubExp]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SOACMapper frep trep m -&gt; SubExp -&gt; m SubExp
forall frep trep (m :: * -&gt; *).
SOACMapper frep trep m -&gt; SubExp -&gt; m SubExp
</span><a href="Futhark.IR.SOACS.SOAC.html#mapOnSOACSubExp"><span class="hs-identifier hs-var hs-var">mapOnSOACSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">SOACMapper frep trep m
</span><a href="#local-6989586621684375108"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684375106"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-416"></span><span>    </span><span class="annot"><span class="annottext">m ([SubExp] -&gt; SOAC trep) -&gt; m [SubExp] -&gt; m (SOAC trep)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; m SubExp) -&gt; [SubExp] -&gt; m [SubExp]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SOACMapper frep trep m -&gt; SubExp -&gt; m SubExp
forall frep trep (m :: * -&gt; *).
SOACMapper frep trep m -&gt; SubExp -&gt; m SubExp
</span><a href="Futhark.IR.SOACS.SOAC.html#mapOnSOACSubExp"><span class="hs-identifier hs-var hs-var">mapOnSOACSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">SOACMapper frep trep m
</span><a href="#local-6989586621684375108"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684375105"><span class="hs-identifier hs-var">vec</span></a></span><span>
</span><span id="line-417"></span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#mapSOACM"><span class="hs-identifier hs-var">mapSOACM</span></a></span><span> </span><span id="local-6989586621684375104"><span class="annot"><span class="annottext">SOACMapper frep trep m
</span><a href="#local-6989586621684375104"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621684375103"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684375103"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span id="local-6989586621684375102"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684375102"><span class="hs-identifier hs-var">arrs</span></a></span></span><span> </span><span id="local-6989586621684375101"><span class="annot"><span class="annottext">StreamForm frep
</span><a href="#local-6989586621684375101"><span class="hs-identifier hs-var">form</span></a></span></span><span> </span><span id="local-6989586621684375100"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684375100"><span class="hs-identifier hs-var">accs</span></a></span></span><span> </span><span id="local-6989586621684375099"><span class="annot"><span class="annottext">Lambda frep
</span><a href="#local-6989586621684375099"><span class="hs-identifier hs-var">lam</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-418"></span><span>  </span><span class="annot"><span class="annottext">SubExp
-&gt; [VName]
-&gt; StreamForm trep
-&gt; [SubExp]
-&gt; Lambda trep
-&gt; SOAC trep
forall rep.
SubExp
-&gt; [VName] -&gt; StreamForm rep -&gt; [SubExp] -&gt; Lambda rep -&gt; SOAC rep
</span><a href="Futhark.IR.SOACS.SOAC.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp
 -&gt; [VName]
 -&gt; StreamForm trep
 -&gt; [SubExp]
 -&gt; Lambda trep
 -&gt; SOAC trep)
-&gt; m SubExp
-&gt; m ([VName]
      -&gt; StreamForm trep -&gt; [SubExp] -&gt; Lambda trep -&gt; SOAC trep)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">SOACMapper frep trep m -&gt; SubExp -&gt; m SubExp
forall frep trep (m :: * -&gt; *).
SOACMapper frep trep m -&gt; SubExp -&gt; m SubExp
</span><a href="Futhark.IR.SOACS.SOAC.html#mapOnSOACSubExp"><span class="hs-identifier hs-var hs-var">mapOnSOACSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">SOACMapper frep trep m
</span><a href="#local-6989586621684375104"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684375103"><span class="hs-identifier hs-var">size</span></a></span><span>
</span><span id="line-419"></span><span>    </span><span class="annot"><span class="annottext">m ([VName]
   -&gt; StreamForm trep -&gt; [SubExp] -&gt; Lambda trep -&gt; SOAC trep)
-&gt; m [VName]
-&gt; m (StreamForm trep -&gt; [SubExp] -&gt; Lambda trep -&gt; SOAC trep)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; m VName) -&gt; [VName] -&gt; m [VName]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SOACMapper frep trep m -&gt; VName -&gt; m VName
forall frep trep (m :: * -&gt; *).
SOACMapper frep trep m -&gt; VName -&gt; m VName
</span><a href="Futhark.IR.SOACS.SOAC.html#mapOnSOACVName"><span class="hs-identifier hs-var hs-var">mapOnSOACVName</span></a></span><span> </span><span class="annot"><span class="annottext">SOACMapper frep trep m
</span><a href="#local-6989586621684375104"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684375102"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-420"></span><span>    </span><span class="annot"><span class="annottext">m (StreamForm trep -&gt; [SubExp] -&gt; Lambda trep -&gt; SOAC trep)
-&gt; m (StreamForm trep) -&gt; m ([SubExp] -&gt; Lambda trep -&gt; SOAC trep)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">StreamForm frep -&gt; m (StreamForm trep)
</span><a href="#local-6989586621684375098"><span class="hs-identifier hs-var">mapOnStreamForm</span></a></span><span> </span><span class="annot"><span class="annottext">StreamForm frep
</span><a href="#local-6989586621684375101"><span class="hs-identifier hs-var">form</span></a></span><span>
</span><span id="line-421"></span><span>    </span><span class="annot"><span class="annottext">m ([SubExp] -&gt; Lambda trep -&gt; SOAC trep)
-&gt; m [SubExp] -&gt; m (Lambda trep -&gt; SOAC trep)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; m SubExp) -&gt; [SubExp] -&gt; m [SubExp]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SOACMapper frep trep m -&gt; SubExp -&gt; m SubExp
forall frep trep (m :: * -&gt; *).
SOACMapper frep trep m -&gt; SubExp -&gt; m SubExp
</span><a href="Futhark.IR.SOACS.SOAC.html#mapOnSOACSubExp"><span class="hs-identifier hs-var hs-var">mapOnSOACSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">SOACMapper frep trep m
</span><a href="#local-6989586621684375104"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684375100"><span class="hs-identifier hs-var">accs</span></a></span><span>
</span><span id="line-422"></span><span>    </span><span class="annot"><span class="annottext">m (Lambda trep -&gt; SOAC trep) -&gt; m (Lambda trep) -&gt; m (SOAC trep)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">SOACMapper frep trep m -&gt; Lambda frep -&gt; m (Lambda trep)
forall frep trep (m :: * -&gt; *).
SOACMapper frep trep m -&gt; Lambda frep -&gt; m (Lambda trep)
</span><a href="Futhark.IR.SOACS.SOAC.html#mapOnSOACLambda"><span class="hs-identifier hs-var hs-var">mapOnSOACLambda</span></a></span><span> </span><span class="annot"><span class="annottext">SOACMapper frep trep m
</span><a href="#local-6989586621684375104"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda frep
</span><a href="#local-6989586621684375099"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-423"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-424"></span><span>    </span><span id="local-6989586621684375098"><span class="annot"><span class="annottext">mapOnStreamForm :: StreamForm frep -&gt; m (StreamForm trep)
</span><a href="#local-6989586621684375098"><span class="hs-identifier hs-var hs-var">mapOnStreamForm</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Parallel"><span class="hs-identifier hs-type">Parallel</span></a></span><span> </span><span id="local-6989586621684375097"><span class="annot"><span class="annottext">StreamOrd
</span><a href="#local-6989586621684375097"><span class="hs-identifier hs-var">o</span></a></span></span><span> </span><span id="local-6989586621684375096"><span class="annot"><span class="annottext">Commutativity
</span><a href="#local-6989586621684375096"><span class="hs-identifier hs-var">comm</span></a></span></span><span> </span><span id="local-6989586621684375095"><span class="annot"><span class="annottext">Lambda frep
</span><a href="#local-6989586621684375095"><span class="hs-identifier hs-var">lam0</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-425"></span><span>      </span><span class="annot"><span class="annottext">StreamOrd -&gt; Commutativity -&gt; Lambda trep -&gt; StreamForm trep
forall rep.
StreamOrd -&gt; Commutativity -&gt; Lambda rep -&gt; StreamForm rep
</span><a href="Futhark.IR.SOACS.SOAC.html#Parallel"><span class="hs-identifier hs-var">Parallel</span></a></span><span> </span><span class="annot"><span class="annottext">StreamOrd
</span><a href="#local-6989586621684375097"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="annot"><span class="annottext">Commutativity
</span><a href="#local-6989586621684375096"><span class="hs-identifier hs-var">comm</span></a></span><span> </span><span class="annot"><span class="annottext">(Lambda trep -&gt; StreamForm trep)
-&gt; m (Lambda trep) -&gt; m (StreamForm trep)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">SOACMapper frep trep m -&gt; Lambda frep -&gt; m (Lambda trep)
forall frep trep (m :: * -&gt; *).
SOACMapper frep trep m -&gt; Lambda frep -&gt; m (Lambda trep)
</span><a href="Futhark.IR.SOACS.SOAC.html#mapOnSOACLambda"><span class="hs-identifier hs-var hs-var">mapOnSOACLambda</span></a></span><span> </span><span class="annot"><span class="annottext">SOACMapper frep trep m
</span><a href="#local-6989586621684375104"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda frep
</span><a href="#local-6989586621684375095"><span class="hs-identifier hs-var">lam0</span></a></span><span>
</span><span id="line-426"></span><span>    </span><span class="annot"><a href="#local-6989586621684375098"><span class="hs-identifier hs-var">mapOnStreamForm</span></a></span><span> </span><span class="annot"><span class="annottext">StreamForm frep
</span><a href="Futhark.IR.SOACS.SOAC.html#Sequential"><span class="hs-identifier hs-var">Sequential</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-427"></span><span>      </span><span class="annot"><span class="annottext">StreamForm trep -&gt; m (StreamForm trep)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">StreamForm trep
forall rep. StreamForm rep
</span><a href="Futhark.IR.SOACS.SOAC.html#Sequential"><span class="hs-identifier hs-var">Sequential</span></a></span><span>
</span><span id="line-428"></span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#mapSOACM"><span class="hs-identifier hs-var">mapSOACM</span></a></span><span> </span><span id="local-6989586621684375094"><span class="annot"><span class="annottext">SOACMapper frep trep m
</span><a href="#local-6989586621684375094"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Scatter"><span class="hs-identifier hs-type">Scatter</span></a></span><span> </span><span id="local-6989586621684375093"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684375093"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684375092"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684375092"><span class="hs-identifier hs-var">ivs</span></a></span></span><span> </span><span id="local-6989586621684375091"><span class="annot"><span class="annottext">Lambda frep
</span><a href="#local-6989586621684375091"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span id="local-6989586621684375090"><span class="annot"><span class="annottext">[(Shape, Int, VName)]
</span><a href="#local-6989586621684375090"><span class="hs-keyword hs-var">as</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-429"></span><span>  </span><span class="annot"><span class="annottext">SubExp
-&gt; [VName] -&gt; Lambda trep -&gt; [(Shape, Int, VName)] -&gt; SOAC trep
forall rep.
SubExp
-&gt; [VName] -&gt; Lambda rep -&gt; [(Shape, Int, VName)] -&gt; SOAC rep
</span><a href="Futhark.IR.SOACS.SOAC.html#Scatter"><span class="hs-identifier hs-var">Scatter</span></a></span><span>
</span><span id="line-430"></span><span>    </span><span class="annot"><span class="annottext">(SubExp
 -&gt; [VName] -&gt; Lambda trep -&gt; [(Shape, Int, VName)] -&gt; SOAC trep)
-&gt; m SubExp
-&gt; m ([VName] -&gt; Lambda trep -&gt; [(Shape, Int, VName)] -&gt; SOAC trep)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">SOACMapper frep trep m -&gt; SubExp -&gt; m SubExp
forall frep trep (m :: * -&gt; *).
SOACMapper frep trep m -&gt; SubExp -&gt; m SubExp
</span><a href="Futhark.IR.SOACS.SOAC.html#mapOnSOACSubExp"><span class="hs-identifier hs-var hs-var">mapOnSOACSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">SOACMapper frep trep m
</span><a href="#local-6989586621684375094"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684375093"><span class="hs-identifier hs-var">w</span></a></span><span>
</span><span id="line-431"></span><span>    </span><span class="annot"><span class="annottext">m ([VName] -&gt; Lambda trep -&gt; [(Shape, Int, VName)] -&gt; SOAC trep)
-&gt; m [VName]
-&gt; m (Lambda trep -&gt; [(Shape, Int, VName)] -&gt; SOAC trep)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; m VName) -&gt; [VName] -&gt; m [VName]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SOACMapper frep trep m -&gt; VName -&gt; m VName
forall frep trep (m :: * -&gt; *).
SOACMapper frep trep m -&gt; VName -&gt; m VName
</span><a href="Futhark.IR.SOACS.SOAC.html#mapOnSOACVName"><span class="hs-identifier hs-var hs-var">mapOnSOACVName</span></a></span><span> </span><span class="annot"><span class="annottext">SOACMapper frep trep m
</span><a href="#local-6989586621684375094"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684375092"><span class="hs-identifier hs-var">ivs</span></a></span><span>
</span><span id="line-432"></span><span>    </span><span class="annot"><span class="annottext">m (Lambda trep -&gt; [(Shape, Int, VName)] -&gt; SOAC trep)
-&gt; m (Lambda trep) -&gt; m ([(Shape, Int, VName)] -&gt; SOAC trep)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">SOACMapper frep trep m -&gt; Lambda frep -&gt; m (Lambda trep)
forall frep trep (m :: * -&gt; *).
SOACMapper frep trep m -&gt; Lambda frep -&gt; m (Lambda trep)
</span><a href="Futhark.IR.SOACS.SOAC.html#mapOnSOACLambda"><span class="hs-identifier hs-var hs-var">mapOnSOACLambda</span></a></span><span> </span><span class="annot"><span class="annottext">SOACMapper frep trep m
</span><a href="#local-6989586621684375094"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda frep
</span><a href="#local-6989586621684375091"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-433"></span><span>    </span><span class="annot"><span class="annottext">m ([(Shape, Int, VName)] -&gt; SOAC trep)
-&gt; m [(Shape, Int, VName)] -&gt; m (SOAC trep)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">((Shape, Int, VName) -&gt; m (Shape, Int, VName))
-&gt; [(Shape, Int, VName)] -&gt; m [(Shape, Int, VName)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span>
</span><span id="line-434"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684375089"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684375089"><span class="hs-identifier hs-var">aw</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684375088"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684375088"><span class="hs-identifier hs-var">an</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684375087"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684375087"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-435"></span><span>          </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Shape -&gt; Int -&gt; VName -&gt; (Shape, Int, VName))
-&gt; m Shape -&gt; m (Int -&gt; VName -&gt; (Shape, Int, VName))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; m SubExp) -&gt; Shape -&gt; m Shape
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SOACMapper frep trep m -&gt; SubExp -&gt; m SubExp
forall frep trep (m :: * -&gt; *).
SOACMapper frep trep m -&gt; SubExp -&gt; m SubExp
</span><a href="Futhark.IR.SOACS.SOAC.html#mapOnSOACSubExp"><span class="hs-identifier hs-var hs-var">mapOnSOACSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">SOACMapper frep trep m
</span><a href="#local-6989586621684375094"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684375089"><span class="hs-identifier hs-var">aw</span></a></span><span>
</span><span id="line-436"></span><span>            </span><span class="annot"><span class="annottext">m (Int -&gt; VName -&gt; (Shape, Int, VName))
-&gt; m Int -&gt; m (VName -&gt; (Shape, Int, VName))
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; m Int
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684375088"><span class="hs-identifier hs-var">an</span></a></span><span>
</span><span id="line-437"></span><span>            </span><span class="annot"><span class="annottext">m (VName -&gt; (Shape, Int, VName))
-&gt; m VName -&gt; m (Shape, Int, VName)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">SOACMapper frep trep m -&gt; VName -&gt; m VName
forall frep trep (m :: * -&gt; *).
SOACMapper frep trep m -&gt; VName -&gt; m VName
</span><a href="Futhark.IR.SOACS.SOAC.html#mapOnSOACVName"><span class="hs-identifier hs-var hs-var">mapOnSOACVName</span></a></span><span> </span><span class="annot"><span class="annottext">SOACMapper frep trep m
</span><a href="#local-6989586621684375094"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684375087"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-438"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-439"></span><span>      </span><span class="annot"><span class="annottext">[(Shape, Int, VName)]
</span><a href="#local-6989586621684375090"><span class="hs-keyword hs-var">as</span></a></span><span>
</span><span id="line-440"></span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#mapSOACM"><span class="hs-identifier hs-var">mapSOACM</span></a></span><span> </span><span id="local-6989586621684375086"><span class="annot"><span class="annottext">SOACMapper frep trep m
</span><a href="#local-6989586621684375086"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Hist"><span class="hs-identifier hs-type">Hist</span></a></span><span> </span><span id="local-6989586621684375085"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684375085"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684375084"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684375084"><span class="hs-identifier hs-var">arrs</span></a></span></span><span> </span><span id="local-6989586621684375083"><span class="annot"><span class="annottext">[HistOp frep]
</span><a href="#local-6989586621684375083"><span class="hs-identifier hs-var">ops</span></a></span></span><span> </span><span id="local-6989586621684375082"><span class="annot"><span class="annottext">Lambda frep
</span><a href="#local-6989586621684375082"><span class="hs-identifier hs-var">bucket_fun</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-441"></span><span>  </span><span class="annot"><span class="annottext">SubExp -&gt; [VName] -&gt; [HistOp trep] -&gt; Lambda trep -&gt; SOAC trep
forall rep.
SubExp -&gt; [VName] -&gt; [HistOp rep] -&gt; Lambda rep -&gt; SOAC rep
</span><a href="Futhark.IR.SOACS.SOAC.html#Hist"><span class="hs-identifier hs-var">Hist</span></a></span><span>
</span><span id="line-442"></span><span>    </span><span class="annot"><span class="annottext">(SubExp -&gt; [VName] -&gt; [HistOp trep] -&gt; Lambda trep -&gt; SOAC trep)
-&gt; m SubExp
-&gt; m ([VName] -&gt; [HistOp trep] -&gt; Lambda trep -&gt; SOAC trep)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">SOACMapper frep trep m -&gt; SubExp -&gt; m SubExp
forall frep trep (m :: * -&gt; *).
SOACMapper frep trep m -&gt; SubExp -&gt; m SubExp
</span><a href="Futhark.IR.SOACS.SOAC.html#mapOnSOACSubExp"><span class="hs-identifier hs-var hs-var">mapOnSOACSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">SOACMapper frep trep m
</span><a href="#local-6989586621684375086"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684375085"><span class="hs-identifier hs-var">w</span></a></span><span>
</span><span id="line-443"></span><span>    </span><span class="annot"><span class="annottext">m ([VName] -&gt; [HistOp trep] -&gt; Lambda trep -&gt; SOAC trep)
-&gt; m [VName] -&gt; m ([HistOp trep] -&gt; Lambda trep -&gt; SOAC trep)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; m VName) -&gt; [VName] -&gt; m [VName]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SOACMapper frep trep m -&gt; VName -&gt; m VName
forall frep trep (m :: * -&gt; *).
SOACMapper frep trep m -&gt; VName -&gt; m VName
</span><a href="Futhark.IR.SOACS.SOAC.html#mapOnSOACVName"><span class="hs-identifier hs-var hs-var">mapOnSOACVName</span></a></span><span> </span><span class="annot"><span class="annottext">SOACMapper frep trep m
</span><a href="#local-6989586621684375086"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684375084"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-444"></span><span>    </span><span class="annot"><span class="annottext">m ([HistOp trep] -&gt; Lambda trep -&gt; SOAC trep)
-&gt; m [HistOp trep] -&gt; m (Lambda trep -&gt; SOAC trep)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">(HistOp frep -&gt; m (HistOp trep))
-&gt; [HistOp frep] -&gt; m [HistOp trep]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span>
</span><span id="line-445"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#HistOp"><span class="hs-identifier hs-type">HistOp</span></a></span><span> </span><span id="local-6989586621684375081"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684375081"><span class="hs-identifier hs-var">shape</span></a></span></span><span> </span><span id="local-6989586621684375080"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684375080"><span class="hs-identifier hs-var">rf</span></a></span></span><span> </span><span id="local-6989586621684375079"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684375079"><span class="hs-identifier hs-var">op_arrs</span></a></span></span><span> </span><span id="local-6989586621684375078"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684375078"><span class="hs-identifier hs-var">nes</span></a></span></span><span> </span><span id="local-6989586621684375077"><span class="annot"><span class="annottext">Lambda frep
</span><a href="#local-6989586621684375077"><span class="hs-identifier hs-var">op</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-446"></span><span>          </span><span class="annot"><span class="annottext">Shape
-&gt; SubExp -&gt; [VName] -&gt; [SubExp] -&gt; Lambda trep -&gt; HistOp trep
forall rep.
Shape -&gt; SubExp -&gt; [VName] -&gt; [SubExp] -&gt; Lambda rep -&gt; HistOp rep
</span><a href="Futhark.IR.SOACS.SOAC.html#HistOp"><span class="hs-identifier hs-var">HistOp</span></a></span><span> </span><span class="annot"><span class="annottext">(Shape
 -&gt; SubExp -&gt; [VName] -&gt; [SubExp] -&gt; Lambda trep -&gt; HistOp trep)
-&gt; m Shape
-&gt; m (SubExp -&gt; [VName] -&gt; [SubExp] -&gt; Lambda trep -&gt; HistOp trep)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; m SubExp) -&gt; Shape -&gt; m Shape
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SOACMapper frep trep m -&gt; SubExp -&gt; m SubExp
forall frep trep (m :: * -&gt; *).
SOACMapper frep trep m -&gt; SubExp -&gt; m SubExp
</span><a href="Futhark.IR.SOACS.SOAC.html#mapOnSOACSubExp"><span class="hs-identifier hs-var hs-var">mapOnSOACSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">SOACMapper frep trep m
</span><a href="#local-6989586621684375086"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684375081"><span class="hs-identifier hs-var">shape</span></a></span><span>
</span><span id="line-447"></span><span>            </span><span class="annot"><span class="annottext">m (SubExp -&gt; [VName] -&gt; [SubExp] -&gt; Lambda trep -&gt; HistOp trep)
-&gt; m SubExp
-&gt; m ([VName] -&gt; [SubExp] -&gt; Lambda trep -&gt; HistOp trep)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">SOACMapper frep trep m -&gt; SubExp -&gt; m SubExp
forall frep trep (m :: * -&gt; *).
SOACMapper frep trep m -&gt; SubExp -&gt; m SubExp
</span><a href="Futhark.IR.SOACS.SOAC.html#mapOnSOACSubExp"><span class="hs-identifier hs-var hs-var">mapOnSOACSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">SOACMapper frep trep m
</span><a href="#local-6989586621684375086"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684375080"><span class="hs-identifier hs-var">rf</span></a></span><span>
</span><span id="line-448"></span><span>            </span><span class="annot"><span class="annottext">m ([VName] -&gt; [SubExp] -&gt; Lambda trep -&gt; HistOp trep)
-&gt; m [VName] -&gt; m ([SubExp] -&gt; Lambda trep -&gt; HistOp trep)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; m VName) -&gt; [VName] -&gt; m [VName]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SOACMapper frep trep m -&gt; VName -&gt; m VName
forall frep trep (m :: * -&gt; *).
SOACMapper frep trep m -&gt; VName -&gt; m VName
</span><a href="Futhark.IR.SOACS.SOAC.html#mapOnSOACVName"><span class="hs-identifier hs-var hs-var">mapOnSOACVName</span></a></span><span> </span><span class="annot"><span class="annottext">SOACMapper frep trep m
</span><a href="#local-6989586621684375086"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684375079"><span class="hs-identifier hs-var">op_arrs</span></a></span><span>
</span><span id="line-449"></span><span>            </span><span class="annot"><span class="annottext">m ([SubExp] -&gt; Lambda trep -&gt; HistOp trep)
-&gt; m [SubExp] -&gt; m (Lambda trep -&gt; HistOp trep)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; m SubExp) -&gt; [SubExp] -&gt; m [SubExp]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SOACMapper frep trep m -&gt; SubExp -&gt; m SubExp
forall frep trep (m :: * -&gt; *).
SOACMapper frep trep m -&gt; SubExp -&gt; m SubExp
</span><a href="Futhark.IR.SOACS.SOAC.html#mapOnSOACSubExp"><span class="hs-identifier hs-var hs-var">mapOnSOACSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">SOACMapper frep trep m
</span><a href="#local-6989586621684375086"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684375078"><span class="hs-identifier hs-var">nes</span></a></span><span>
</span><span id="line-450"></span><span>            </span><span class="annot"><span class="annottext">m (Lambda trep -&gt; HistOp trep)
-&gt; m (Lambda trep) -&gt; m (HistOp trep)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">SOACMapper frep trep m -&gt; Lambda frep -&gt; m (Lambda trep)
forall frep trep (m :: * -&gt; *).
SOACMapper frep trep m -&gt; Lambda frep -&gt; m (Lambda trep)
</span><a href="Futhark.IR.SOACS.SOAC.html#mapOnSOACLambda"><span class="hs-identifier hs-var hs-var">mapOnSOACLambda</span></a></span><span> </span><span class="annot"><span class="annottext">SOACMapper frep trep m
</span><a href="#local-6989586621684375086"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda frep
</span><a href="#local-6989586621684375077"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-451"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-452"></span><span>      </span><span class="annot"><span class="annottext">[HistOp frep]
</span><a href="#local-6989586621684375083"><span class="hs-identifier hs-var">ops</span></a></span><span>
</span><span id="line-453"></span><span>    </span><span class="annot"><span class="annottext">m (Lambda trep -&gt; SOAC trep) -&gt; m (Lambda trep) -&gt; m (SOAC trep)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">SOACMapper frep trep m -&gt; Lambda frep -&gt; m (Lambda trep)
forall frep trep (m :: * -&gt; *).
SOACMapper frep trep m -&gt; Lambda frep -&gt; m (Lambda trep)
</span><a href="Futhark.IR.SOACS.SOAC.html#mapOnSOACLambda"><span class="hs-identifier hs-var hs-var">mapOnSOACLambda</span></a></span><span> </span><span class="annot"><span class="annottext">SOACMapper frep trep m
</span><a href="#local-6989586621684375086"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda frep
</span><a href="#local-6989586621684375082"><span class="hs-identifier hs-var">bucket_fun</span></a></span><span>
</span><span id="line-454"></span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#mapSOACM"><span class="hs-identifier hs-var">mapSOACM</span></a></span><span> </span><span id="local-6989586621684375076"><span class="annot"><span class="annottext">SOACMapper frep trep m
</span><a href="#local-6989586621684375076"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Screma"><span class="hs-identifier hs-type">Screma</span></a></span><span> </span><span id="local-6989586621684375075"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684375075"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684375074"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684375074"><span class="hs-identifier hs-var">arrs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#ScremaForm"><span class="hs-identifier hs-type">ScremaForm</span></a></span><span> </span><span id="local-6989586621684375073"><span class="annot"><span class="annottext">[Scan frep]
</span><a href="#local-6989586621684375073"><span class="hs-identifier hs-var">scans</span></a></span></span><span> </span><span id="local-6989586621684375072"><span class="annot"><span class="annottext">[Reduce frep]
</span><a href="#local-6989586621684375072"><span class="hs-identifier hs-var">reds</span></a></span></span><span> </span><span id="local-6989586621684375071"><span class="annot"><span class="annottext">Lambda frep
</span><a href="#local-6989586621684375071"><span class="hs-identifier hs-var">map_lam</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-455"></span><span>  </span><span class="annot"><span class="annottext">SubExp -&gt; [VName] -&gt; ScremaForm trep -&gt; SOAC trep
forall rep. SubExp -&gt; [VName] -&gt; ScremaForm rep -&gt; SOAC rep
</span><a href="Futhark.IR.SOACS.SOAC.html#Screma"><span class="hs-identifier hs-var">Screma</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; [VName] -&gt; ScremaForm trep -&gt; SOAC trep)
-&gt; m SubExp -&gt; m ([VName] -&gt; ScremaForm trep -&gt; SOAC trep)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">SOACMapper frep trep m -&gt; SubExp -&gt; m SubExp
forall frep trep (m :: * -&gt; *).
SOACMapper frep trep m -&gt; SubExp -&gt; m SubExp
</span><a href="Futhark.IR.SOACS.SOAC.html#mapOnSOACSubExp"><span class="hs-identifier hs-var hs-var">mapOnSOACSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">SOACMapper frep trep m
</span><a href="#local-6989586621684375076"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684375075"><span class="hs-identifier hs-var">w</span></a></span><span>
</span><span id="line-456"></span><span>    </span><span class="annot"><span class="annottext">m ([VName] -&gt; ScremaForm trep -&gt; SOAC trep)
-&gt; m [VName] -&gt; m (ScremaForm trep -&gt; SOAC trep)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; m VName) -&gt; [VName] -&gt; m [VName]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SOACMapper frep trep m -&gt; VName -&gt; m VName
forall frep trep (m :: * -&gt; *).
SOACMapper frep trep m -&gt; VName -&gt; m VName
</span><a href="Futhark.IR.SOACS.SOAC.html#mapOnSOACVName"><span class="hs-identifier hs-var hs-var">mapOnSOACVName</span></a></span><span> </span><span class="annot"><span class="annottext">SOACMapper frep trep m
</span><a href="#local-6989586621684375076"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684375074"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-457"></span><span>    </span><span class="annot"><span class="annottext">m (ScremaForm trep -&gt; SOAC trep)
-&gt; m (ScremaForm trep) -&gt; m (SOAC trep)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">[Scan trep] -&gt; [Reduce trep] -&gt; Lambda trep -&gt; ScremaForm trep
forall rep.
[Scan rep] -&gt; [Reduce rep] -&gt; Lambda rep -&gt; ScremaForm rep
</span><a href="Futhark.IR.SOACS.SOAC.html#ScremaForm"><span class="hs-identifier hs-var">ScremaForm</span></a></span><span>
</span><span id="line-458"></span><span>            </span><span class="annot"><span class="annottext">([Scan trep] -&gt; [Reduce trep] -&gt; Lambda trep -&gt; ScremaForm trep)
-&gt; m [Scan trep]
-&gt; m ([Reduce trep] -&gt; Lambda trep -&gt; ScremaForm trep)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Scan frep] -&gt; (Scan frep -&gt; m (Scan trep)) -&gt; m [Scan trep]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span>
</span><span id="line-459"></span><span>              </span><span class="annot"><span class="annottext">[Scan frep]
</span><a href="#local-6989586621684375073"><span class="hs-identifier hs-var">scans</span></a></span><span>
</span><span id="line-460"></span><span>              </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Scan"><span class="hs-identifier hs-type">Scan</span></a></span><span> </span><span id="local-6989586621684375069"><span class="annot"><span class="annottext">Lambda frep
</span><a href="#local-6989586621684375069"><span class="hs-identifier hs-var">red_lam</span></a></span></span><span> </span><span id="local-6989586621684375068"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684375068"><span class="hs-identifier hs-var">red_nes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-461"></span><span>                  </span><span class="annot"><span class="annottext">Lambda trep -&gt; [SubExp] -&gt; Scan trep
forall rep. Lambda rep -&gt; [SubExp] -&gt; Scan rep
</span><a href="Futhark.IR.SOACS.SOAC.html#Scan"><span class="hs-identifier hs-var">Scan</span></a></span><span> </span><span class="annot"><span class="annottext">(Lambda trep -&gt; [SubExp] -&gt; Scan trep)
-&gt; m (Lambda trep) -&gt; m ([SubExp] -&gt; Scan trep)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">SOACMapper frep trep m -&gt; Lambda frep -&gt; m (Lambda trep)
forall frep trep (m :: * -&gt; *).
SOACMapper frep trep m -&gt; Lambda frep -&gt; m (Lambda trep)
</span><a href="Futhark.IR.SOACS.SOAC.html#mapOnSOACLambda"><span class="hs-identifier hs-var hs-var">mapOnSOACLambda</span></a></span><span> </span><span class="annot"><span class="annottext">SOACMapper frep trep m
</span><a href="#local-6989586621684375076"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda frep
</span><a href="#local-6989586621684375069"><span class="hs-identifier hs-var">red_lam</span></a></span><span>
</span><span id="line-462"></span><span>                    </span><span class="annot"><span class="annottext">m ([SubExp] -&gt; Scan trep) -&gt; m [SubExp] -&gt; m (Scan trep)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; m SubExp) -&gt; [SubExp] -&gt; m [SubExp]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SOACMapper frep trep m -&gt; SubExp -&gt; m SubExp
forall frep trep (m :: * -&gt; *).
SOACMapper frep trep m -&gt; SubExp -&gt; m SubExp
</span><a href="Futhark.IR.SOACS.SOAC.html#mapOnSOACSubExp"><span class="hs-identifier hs-var hs-var">mapOnSOACSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">SOACMapper frep trep m
</span><a href="#local-6989586621684375076"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684375068"><span class="hs-identifier hs-var">red_nes</span></a></span><span>
</span><span id="line-463"></span><span>              </span><span class="hs-special">)</span><span>
</span><span id="line-464"></span><span>            </span><span class="annot"><span class="annottext">m ([Reduce trep] -&gt; Lambda trep -&gt; ScremaForm trep)
-&gt; m [Reduce trep] -&gt; m (Lambda trep -&gt; ScremaForm trep)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Reduce frep]
-&gt; (Reduce frep -&gt; m (Reduce trep)) -&gt; m [Reduce trep]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span>
</span><span id="line-465"></span><span>              </span><span class="annot"><span class="annottext">[Reduce frep]
</span><a href="#local-6989586621684375072"><span class="hs-identifier hs-var">reds</span></a></span><span>
</span><span id="line-466"></span><span>              </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Reduce"><span class="hs-identifier hs-type">Reduce</span></a></span><span> </span><span id="local-6989586621684375067"><span class="annot"><span class="annottext">Commutativity
</span><a href="#local-6989586621684375067"><span class="hs-identifier hs-var">comm</span></a></span></span><span> </span><span id="local-6989586621684375066"><span class="annot"><span class="annottext">Lambda frep
</span><a href="#local-6989586621684375066"><span class="hs-identifier hs-var">red_lam</span></a></span></span><span> </span><span id="local-6989586621684375065"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684375065"><span class="hs-identifier hs-var">red_nes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-467"></span><span>                  </span><span class="annot"><span class="annottext">Commutativity -&gt; Lambda trep -&gt; [SubExp] -&gt; Reduce trep
forall rep. Commutativity -&gt; Lambda rep -&gt; [SubExp] -&gt; Reduce rep
</span><a href="Futhark.IR.SOACS.SOAC.html#Reduce"><span class="hs-identifier hs-var">Reduce</span></a></span><span> </span><span class="annot"><span class="annottext">Commutativity
</span><a href="#local-6989586621684375067"><span class="hs-identifier hs-var">comm</span></a></span><span> </span><span class="annot"><span class="annottext">(Lambda trep -&gt; [SubExp] -&gt; Reduce trep)
-&gt; m (Lambda trep) -&gt; m ([SubExp] -&gt; Reduce trep)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">SOACMapper frep trep m -&gt; Lambda frep -&gt; m (Lambda trep)
forall frep trep (m :: * -&gt; *).
SOACMapper frep trep m -&gt; Lambda frep -&gt; m (Lambda trep)
</span><a href="Futhark.IR.SOACS.SOAC.html#mapOnSOACLambda"><span class="hs-identifier hs-var hs-var">mapOnSOACLambda</span></a></span><span> </span><span class="annot"><span class="annottext">SOACMapper frep trep m
</span><a href="#local-6989586621684375076"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda frep
</span><a href="#local-6989586621684375066"><span class="hs-identifier hs-var">red_lam</span></a></span><span>
</span><span id="line-468"></span><span>                    </span><span class="annot"><span class="annottext">m ([SubExp] -&gt; Reduce trep) -&gt; m [SubExp] -&gt; m (Reduce trep)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; m SubExp) -&gt; [SubExp] -&gt; m [SubExp]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SOACMapper frep trep m -&gt; SubExp -&gt; m SubExp
forall frep trep (m :: * -&gt; *).
SOACMapper frep trep m -&gt; SubExp -&gt; m SubExp
</span><a href="Futhark.IR.SOACS.SOAC.html#mapOnSOACSubExp"><span class="hs-identifier hs-var hs-var">mapOnSOACSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">SOACMapper frep trep m
</span><a href="#local-6989586621684375076"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684375065"><span class="hs-identifier hs-var">red_nes</span></a></span><span>
</span><span id="line-469"></span><span>              </span><span class="hs-special">)</span><span>
</span><span id="line-470"></span><span>            </span><span class="annot"><span class="annottext">m (Lambda trep -&gt; ScremaForm trep)
-&gt; m (Lambda trep) -&gt; m (ScremaForm trep)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">SOACMapper frep trep m -&gt; Lambda frep -&gt; m (Lambda trep)
forall frep trep (m :: * -&gt; *).
SOACMapper frep trep m -&gt; Lambda frep -&gt; m (Lambda trep)
</span><a href="Futhark.IR.SOACS.SOAC.html#mapOnSOACLambda"><span class="hs-identifier hs-var hs-var">mapOnSOACLambda</span></a></span><span> </span><span class="annot"><span class="annottext">SOACMapper frep trep m
</span><a href="#local-6989586621684375076"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda frep
</span><a href="#local-6989586621684375071"><span class="hs-identifier hs-var">map_lam</span></a></span><span>
</span><span id="line-471"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-472"></span><span>
</span><span id="line-473"></span><span class="hs-comment">-- | A helper for defining 'TraverseOpStms'.</span><span>
</span><span id="line-474"></span><span id="local-6989586621684376276"><span id="local-6989586621684376277"><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#traverseSOACStms"><span class="hs-identifier hs-type">traverseSOACStms</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621684376277"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Traversals.html#OpStmsTraverser"><span class="hs-identifier hs-type">OpStmsTraverser</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376277"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#SOAC"><span class="hs-identifier hs-type">SOAC</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376276"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621684376276"><span class="hs-identifier hs-type">rep</span></a></span></span></span><span>
</span><span id="line-475"></span><span id="traverseSOACStms"><span class="annot"><span class="annottext">traverseSOACStms :: forall (m :: * -&gt; *) rep.
Monad m =&gt;
OpStmsTraverser m (SOAC rep) rep
</span><a href="Futhark.IR.SOACS.SOAC.html#traverseSOACStms"><span class="hs-identifier hs-var hs-var">traverseSOACStms</span></a></span></span><span> </span><span id="local-6989586621684375058"><span class="annot"><span class="annottext">Scope rep -&gt; Stms rep -&gt; m (Stms rep)
</span><a href="#local-6989586621684375058"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SOACMapper rep rep m -&gt; SOAC rep -&gt; m (SOAC rep)
forall (m :: * -&gt; *) frep trep.
(Applicative m, Monad m) =&gt;
SOACMapper frep trep m -&gt; SOAC frep -&gt; m (SOAC trep)
</span><a href="Futhark.IR.SOACS.SOAC.html#mapSOACM"><span class="hs-identifier hs-var">mapSOACM</span></a></span><span> </span><span class="annot"><span class="annottext">SOACMapper rep rep m
</span><a href="#local-6989586621684375057"><span class="hs-identifier hs-var">mapper</span></a></span><span>
</span><span id="line-476"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-477"></span><span>    </span><span id="local-6989586621684375057"><span class="annot"><span class="annottext">mapper :: SOACMapper rep rep m
</span><a href="#local-6989586621684375057"><span class="hs-identifier hs-var hs-var">mapper</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SOACMapper Any Any m
forall (m :: * -&gt; *) rep. Monad m =&gt; SOACMapper rep rep m
</span><a href="Futhark.IR.SOACS.SOAC.html#identitySOACMapper"><span class="hs-identifier hs-var">identitySOACMapper</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">mapOnSOACLambda :: Lambda rep -&gt; m (Lambda rep)
</span><a href="Futhark.IR.SOACS.SOAC.html#mapOnSOACLambda"><span class="hs-identifier hs-var">mapOnSOACLambda</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OpStmsTraverser m (Lambda rep) rep
forall (m :: * -&gt; *) rep.
Monad m =&gt;
OpStmsTraverser m (Lambda rep) rep
</span><a href="Futhark.IR.Traversals.html#traverseLambdaStms"><span class="hs-identifier hs-var">traverseLambdaStms</span></a></span><span> </span><span class="annot"><span class="annottext">Scope rep -&gt; Stms rep -&gt; m (Stms rep)
</span><a href="#local-6989586621684375058"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-478"></span><span>
</span><span id="line-479"></span><span id="local-6989586621684376264"><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.html#ASTRep"><span class="hs-identifier hs-type">ASTRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376264"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#FreeIn"><span class="hs-identifier hs-type">FreeIn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#SOAC"><span class="hs-identifier hs-type">SOAC</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376264"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-480"></span><span>  </span><span id="local-6989586621684375004"><span class="annot"><span class="annottext">freeIn' :: SOAC rep -&gt; FV
</span><a href="Futhark.IR.Prop.Names.html#freeIn%27"><span class="hs-identifier hs-var hs-var hs-var hs-var">freeIn'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State FV (SOAC rep) -&gt; FV -&gt; FV)
-&gt; FV -&gt; State FV (SOAC rep) -&gt; FV
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">State FV (SOAC rep) -&gt; FV -&gt; FV
forall s a. State s a -&gt; s -&gt; s
</span><span class="hs-identifier hs-var">execState</span></span><span> </span><span class="annot"><span class="annottext">FV
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">(State FV (SOAC rep) -&gt; FV)
-&gt; (SOAC rep -&gt; State FV (SOAC rep)) -&gt; SOAC rep -&gt; FV
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SOACMapper rep rep (StateT FV Identity)
-&gt; SOAC rep -&gt; State FV (SOAC rep)
forall (m :: * -&gt; *) frep trep.
(Applicative m, Monad m) =&gt;
SOACMapper frep trep m -&gt; SOAC frep -&gt; m (SOAC trep)
</span><a href="Futhark.IR.SOACS.SOAC.html#mapSOACM"><span class="hs-identifier hs-var">mapSOACM</span></a></span><span> </span><span class="annot"><span class="annottext">SOACMapper rep rep (StateT FV Identity)
</span><a href="#local-6989586621684375000"><span class="hs-identifier hs-var">free</span></a></span><span>
</span><span id="line-481"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-482"></span><span>      </span><span id="local-6989586621684374991"><span class="annot"><span class="annottext">walk :: (b -&gt; s) -&gt; b -&gt; m b
</span><a href="#local-6989586621684374991"><span class="hs-identifier hs-var hs-var">walk</span></a></span></span><span> </span><span id="local-6989586621684374990"><span class="annot"><span class="annottext">b -&gt; s
</span><a href="#local-6989586621684374990"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621684374989"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684374989"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(s -&gt; s) -&gt; m ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; s -&gt; s
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">b -&gt; s
</span><a href="#local-6989586621684374990"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684374989"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">m () -&gt; m b -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">b -&gt; m b
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684374989"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-483"></span><span>      </span><span id="local-6989586621684375000"><span class="annot"><span class="annottext">free :: SOACMapper rep rep (StateT FV Identity)
</span><a href="#local-6989586621684375000"><span class="hs-identifier hs-var hs-var">free</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-484"></span><span>        </span><span class="annot"><span class="annottext">SOACMapper :: forall frep trep (m :: * -&gt; *).
(SubExp -&gt; m SubExp)
-&gt; (Lambda frep -&gt; m (Lambda trep))
-&gt; (VName -&gt; m VName)
-&gt; SOACMapper frep trep m
</span><a href="Futhark.IR.SOACS.SOAC.html#SOACMapper"><span class="hs-identifier hs-type">SOACMapper</span></a></span><span>
</span><span id="line-485"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">mapOnSOACSubExp :: SubExp -&gt; StateT FV Identity SubExp
</span><a href="Futhark.IR.SOACS.SOAC.html#mapOnSOACSubExp"><span class="hs-identifier hs-var">mapOnSOACSubExp</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; FV) -&gt; SubExp -&gt; StateT FV Identity SubExp
forall {m :: * -&gt; *} {s} {b}.
(MonadState s m, Semigroup s) =&gt;
(b -&gt; s) -&gt; b -&gt; m b
</span><a href="#local-6989586621684374991"><span class="hs-identifier hs-var">walk</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; FV
forall a. FreeIn a =&gt; a -&gt; FV
</span><a href="Futhark.IR.Prop.Names.html#freeIn%27"><span class="hs-identifier hs-var">freeIn'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-486"></span><span>            </span><span class="annot"><span class="annottext">mapOnSOACLambda :: Lambda rep -&gt; StateT FV Identity (Lambda rep)
</span><a href="Futhark.IR.SOACS.SOAC.html#mapOnSOACLambda"><span class="hs-identifier hs-var">mapOnSOACLambda</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Lambda rep -&gt; FV) -&gt; Lambda rep -&gt; StateT FV Identity (Lambda rep)
forall {m :: * -&gt; *} {s} {b}.
(MonadState s m, Semigroup s) =&gt;
(b -&gt; s) -&gt; b -&gt; m b
</span><a href="#local-6989586621684374991"><span class="hs-identifier hs-var">walk</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; FV
forall a. FreeIn a =&gt; a -&gt; FV
</span><a href="Futhark.IR.Prop.Names.html#freeIn%27"><span class="hs-identifier hs-var">freeIn'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-487"></span><span>            </span><span class="annot"><span class="annottext">mapOnSOACVName :: VName -&gt; StateT FV Identity VName
</span><a href="Futhark.IR.SOACS.SOAC.html#mapOnSOACVName"><span class="hs-identifier hs-var">mapOnSOACVName</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; FV) -&gt; VName -&gt; StateT FV Identity VName
forall {m :: * -&gt; *} {s} {b}.
(MonadState s m, Semigroup s) =&gt;
(b -&gt; s) -&gt; b -&gt; m b
</span><a href="#local-6989586621684374991"><span class="hs-identifier hs-var">walk</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; FV
forall a. FreeIn a =&gt; a -&gt; FV
</span><a href="Futhark.IR.Prop.Names.html#freeIn%27"><span class="hs-identifier hs-var">freeIn'</span></a></span><span>
</span><span id="line-488"></span><span>          </span><span class="hs-special">}</span></span><span>
</span><span id="line-489"></span><span>
</span><span id="line-490"></span><span id="local-6989586621684376214"><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.html#ASTRep"><span class="hs-identifier hs-type">ASTRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376214"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Transform.Substitute.html#Substitute"><span class="hs-identifier hs-type">Substitute</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#SOAC"><span class="hs-identifier hs-type">SOAC</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376214"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-491"></span><span>  </span><span id="local-6989586621684374917"><span class="annot"><span class="annottext">substituteNames :: Map VName VName -&gt; SOAC rep -&gt; SOAC rep
</span><a href="Futhark.Transform.Substitute.html#substituteNames"><span class="hs-identifier hs-var hs-var hs-var hs-var">substituteNames</span></a></span></span><span> </span><span id="local-6989586621684374915"><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684374915"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-492"></span><span>    </span><span class="annot"><span class="annottext">Identity (SOAC rep) -&gt; SOAC rep
forall a. Identity a -&gt; a
</span><span class="hs-identifier hs-var hs-var">runIdentity</span></span><span> </span><span class="annot"><span class="annottext">(Identity (SOAC rep) -&gt; SOAC rep)
-&gt; (SOAC rep -&gt; Identity (SOAC rep)) -&gt; SOAC rep -&gt; SOAC rep
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SOACMapper rep rep Identity -&gt; SOAC rep -&gt; Identity (SOAC rep)
forall (m :: * -&gt; *) frep trep.
(Applicative m, Monad m) =&gt;
SOACMapper frep trep m -&gt; SOAC frep -&gt; m (SOAC trep)
</span><a href="Futhark.IR.SOACS.SOAC.html#mapSOACM"><span class="hs-identifier hs-var">mapSOACM</span></a></span><span> </span><span class="annot"><span class="annottext">SOACMapper rep rep Identity
</span><a href="#local-6989586621684374913"><span class="hs-identifier hs-var">substitute</span></a></span><span>
</span><span id="line-493"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-494"></span><span>      </span><span id="local-6989586621684374913"><span class="annot"><span class="annottext">substitute :: SOACMapper rep rep Identity
</span><a href="#local-6989586621684374913"><span class="hs-identifier hs-var hs-var">substitute</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-495"></span><span>        </span><span class="annot"><span class="annottext">SOACMapper :: forall frep trep (m :: * -&gt; *).
(SubExp -&gt; m SubExp)
-&gt; (Lambda frep -&gt; m (Lambda trep))
-&gt; (VName -&gt; m VName)
-&gt; SOACMapper frep trep m
</span><a href="Futhark.IR.SOACS.SOAC.html#SOACMapper"><span class="hs-identifier hs-type">SOACMapper</span></a></span><span>
</span><span id="line-496"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">mapOnSOACSubExp :: SubExp -&gt; Identity SubExp
</span><a href="Futhark.IR.SOACS.SOAC.html#mapOnSOACSubExp"><span class="hs-identifier hs-var">mapOnSOACSubExp</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Identity SubExp
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; Identity SubExp)
-&gt; (SubExp -&gt; SubExp) -&gt; SubExp -&gt; Identity SubExp
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Map VName VName -&gt; SubExp -&gt; SubExp
forall a. Substitute a =&gt; Map VName VName -&gt; a -&gt; a
</span><a href="Futhark.Transform.Substitute.html#substituteNames"><span class="hs-identifier hs-var">substituteNames</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684374915"><span class="hs-identifier hs-var">subst</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-497"></span><span>            </span><span class="annot"><span class="annottext">mapOnSOACLambda :: Lambda rep -&gt; Identity (Lambda rep)
</span><a href="Futhark.IR.SOACS.SOAC.html#mapOnSOACLambda"><span class="hs-identifier hs-var">mapOnSOACLambda</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; Identity (Lambda rep)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Lambda rep -&gt; Identity (Lambda rep))
-&gt; (Lambda rep -&gt; Lambda rep)
-&gt; Lambda rep
-&gt; Identity (Lambda rep)
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Map VName VName -&gt; Lambda rep -&gt; Lambda rep
forall a. Substitute a =&gt; Map VName VName -&gt; a -&gt; a
</span><a href="Futhark.Transform.Substitute.html#substituteNames"><span class="hs-identifier hs-var">substituteNames</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684374915"><span class="hs-identifier hs-var">subst</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-498"></span><span>            </span><span class="annot"><span class="annottext">mapOnSOACVName :: VName -&gt; Identity VName
</span><a href="Futhark.IR.SOACS.SOAC.html#mapOnSOACVName"><span class="hs-identifier hs-var">mapOnSOACVName</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Identity VName
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Identity VName)
-&gt; (VName -&gt; VName) -&gt; VName -&gt; Identity VName
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Map VName VName -&gt; VName -&gt; VName
forall a. Substitute a =&gt; Map VName VName -&gt; a -&gt; a
</span><a href="Futhark.Transform.Substitute.html#substituteNames"><span class="hs-identifier hs-var">substituteNames</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684374915"><span class="hs-identifier hs-var">subst</span></a></span><span>
</span><span id="line-499"></span><span>          </span><span class="hs-special">}</span></span><span>
</span><span id="line-500"></span><span>
</span><span id="line-501"></span><span id="local-6989586621684376206"><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.html#ASTRep"><span class="hs-identifier hs-type">ASTRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376206"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Transform.Rename.html#Rename"><span class="hs-identifier hs-type">Rename</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#SOAC"><span class="hs-identifier hs-type">SOAC</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376206"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-502"></span><span>  </span><span id="local-6989586621684374870"><span class="annot"><span class="annottext">rename :: SOAC rep -&gt; RenameM (SOAC rep)
</span><a href="Futhark.Transform.Rename.html#rename"><span class="hs-identifier hs-var hs-var hs-var hs-var">rename</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SOACMapper rep rep RenameM -&gt; SOAC rep -&gt; RenameM (SOAC rep)
forall (m :: * -&gt; *) frep trep.
(Applicative m, Monad m) =&gt;
SOACMapper frep trep m -&gt; SOAC frep -&gt; m (SOAC trep)
</span><a href="Futhark.IR.SOACS.SOAC.html#mapSOACM"><span class="hs-identifier hs-var">mapSOACM</span></a></span><span> </span><span class="annot"><span class="annottext">SOACMapper rep rep RenameM
</span><a href="#local-6989586621684374868"><span class="hs-identifier hs-var">renamer</span></a></span><span>
</span><span id="line-503"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-504"></span><span>      </span><span id="local-6989586621684374868"><span class="annot"><span class="annottext">renamer :: SOACMapper rep rep RenameM
</span><a href="#local-6989586621684374868"><span class="hs-identifier hs-var hs-var">renamer</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; RenameM SubExp)
-&gt; (Lambda rep -&gt; RenameM (Lambda rep))
-&gt; (VName -&gt; RenameM VName)
-&gt; SOACMapper rep rep RenameM
forall frep trep (m :: * -&gt; *).
(SubExp -&gt; m SubExp)
-&gt; (Lambda frep -&gt; m (Lambda trep))
-&gt; (VName -&gt; m VName)
-&gt; SOACMapper frep trep m
</span><a href="Futhark.IR.SOACS.SOAC.html#SOACMapper"><span class="hs-identifier hs-var">SOACMapper</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; RenameM SubExp
forall a. Rename a =&gt; a -&gt; RenameM a
</span><a href="Futhark.Transform.Rename.html#rename"><span class="hs-identifier hs-var">rename</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; RenameM (Lambda rep)
forall a. Rename a =&gt; a -&gt; RenameM a
</span><a href="Futhark.Transform.Rename.html#rename"><span class="hs-identifier hs-var">rename</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; RenameM VName
forall a. Rename a =&gt; a -&gt; RenameM a
</span><a href="Futhark.Transform.Rename.html#rename"><span class="hs-identifier hs-var">rename</span></a></span></span><span>
</span><span id="line-505"></span><span>
</span><span id="line-506"></span><span class="hs-comment">-- | The type of a SOAC.</span><span>
</span><span id="line-507"></span><span id="local-6989586621684376195"><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#soacType"><span class="hs-identifier hs-type">soacType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Types.html#Typed"><span class="hs-identifier hs-type">Typed</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#LParamInfo"><span class="hs-identifier hs-type">LParamInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376195"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#SOAC"><span class="hs-identifier hs-type">SOAC</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376195"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span></span><span>
</span><span id="line-508"></span><span id="soacType"><span class="annot"><span class="annottext">soacType :: forall rep. Typed (LParamInfo rep) =&gt; SOAC rep -&gt; [Type]
</span><a href="Futhark.IR.SOACS.SOAC.html#soacType"><span class="hs-identifier hs-var hs-var">soacType</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#JVP"><span class="hs-identifier hs-type">JVP</span></a></span><span> </span><span id="local-6989586621684374838"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684374838"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-509"></span><span>  </span><span class="annot"><span class="annottext">Lambda rep -&gt; [Type]
forall rep. LambdaT rep -&gt; [Type]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684374838"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-510"></span><span>    </span><span class="annot"><span class="annottext">[Type] -&gt; [Type] -&gt; [Type]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; [Type]
forall rep. LambdaT rep -&gt; [Type]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684374838"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-511"></span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#soacType"><span class="hs-identifier hs-var">soacType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#VJP"><span class="hs-identifier hs-type">VJP</span></a></span><span> </span><span id="local-6989586621684374837"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684374837"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-512"></span><span>  </span><span class="annot"><span class="annottext">Lambda rep -&gt; [Type]
forall rep. LambdaT rep -&gt; [Type]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684374837"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-513"></span><span>    </span><span class="annot"><span class="annottext">[Type] -&gt; [Type] -&gt; [Type]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">(Param (LParamInfo rep) -&gt; Type)
-&gt; [Param (LParamInfo rep)] -&gt; [Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Param (LParamInfo rep) -&gt; Type
forall dec. Typed dec =&gt; Param dec -&gt; Type
</span><a href="Futhark.IR.Prop.Patterns.html#paramType"><span class="hs-identifier hs-var">paramType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda rep -&gt; [Param (LParamInfo rep)]
forall {rep}. LambdaT rep -&gt; [Param (LParamInfo rep)]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684374837"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-514"></span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#soacType"><span class="hs-identifier hs-var">soacType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621684374835"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684374835"><span class="hs-identifier hs-var">outersize</span></a></span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StreamForm rep
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684374834"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684374834"><span class="hs-identifier hs-var">accs</span></a></span></span><span> </span><span id="local-6989586621684374833"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684374833"><span class="hs-identifier hs-var">lam</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-515"></span><span>  </span><span class="annot"><span class="annottext">(Type -&gt; Type) -&gt; [Type] -&gt; [Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName SubExp -&gt; Type -&gt; Type
</span><a href="Futhark.IR.SOACS.SOAC.html#substNamesInType"><span class="hs-identifier hs-var">substNamesInType</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SubExp
</span><a href="#local-6989586621684374831"><span class="hs-identifier hs-var">substs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684374830"><span class="hs-identifier hs-var">rtp</span></a></span><span>
</span><span id="line-516"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-517"></span><span>    </span><span id="local-6989586621684374829"><span class="annot"><span class="annottext">nms :: [VName]
</span><a href="#local-6989586621684374829"><span class="hs-identifier hs-var hs-var">nms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Param (LParamInfo rep) -&gt; VName)
-&gt; [Param (LParamInfo rep)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Param (LParamInfo rep) -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">([Param (LParamInfo rep)] -&gt; [VName])
-&gt; [Param (LParamInfo rep)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Param (LParamInfo rep)] -&gt; [Param (LParamInfo rep)]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">take</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684374834"><span class="hs-identifier hs-var">accs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Param (LParamInfo rep)]
</span><a href="#local-6989586621684374828"><span class="hs-identifier hs-var">params</span></a></span><span>
</span><span id="line-518"></span><span>    </span><span id="local-6989586621684374831"><span class="annot"><span class="annottext">substs :: Map VName SubExp
</span><a href="#local-6989586621684374831"><span class="hs-identifier hs-var hs-var">substs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VName, SubExp)] -&gt; Map VName SubExp
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="annot"><span class="annottext">([(VName, SubExp)] -&gt; Map VName SubExp)
-&gt; [(VName, SubExp)] -&gt; Map VName SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [SubExp] -&gt; [(VName, SubExp)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684374829"><span class="hs-identifier hs-var">nms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684374835"><span class="hs-identifier hs-var">outersize</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; [SubExp] -&gt; [SubExp]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684374834"><span class="hs-identifier hs-var">accs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-519"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span id="local-6989586621684374828"><span class="annot"><span class="annottext">[Param (LParamInfo rep)]
</span><a href="#local-6989586621684374828"><span class="hs-identifier hs-var">params</span></a></span></span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684374830"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684374830"><span class="hs-identifier hs-var">rtp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684374833"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-520"></span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#soacType"><span class="hs-identifier hs-var">soacType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Scatter"><span class="hs-identifier hs-type">Scatter</span></a></span><span> </span><span id="local-6989586621684374826"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684374826"><span class="hs-identifier hs-var">_w</span></a></span></span><span> </span><span id="local-6989586621684374825"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684374825"><span class="hs-identifier hs-var">_ivs</span></a></span></span><span> </span><span id="local-6989586621684374824"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684374824"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span id="local-6989586621684374823"><span class="annot"><span class="annottext">[(Shape, Int, VName)]
</span><a href="#local-6989586621684374823"><span class="hs-identifier hs-var">dests</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-521"></span><span>  </span><span class="annot"><span class="annottext">(Type -&gt; Shape -&gt; Type) -&gt; [Type] -&gt; [Shape] -&gt; [Type]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Shape -&gt; Type
</span><a href="Futhark.IR.Prop.Types.html#arrayOfShape"><span class="hs-identifier hs-var">arrayOfShape</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684374821"><span class="hs-identifier hs-var">val_ts</span></a></span><span> </span><span class="annot"><span class="annottext">[Shape]
</span><a href="#local-6989586621684374820"><span class="hs-identifier hs-var">ws</span></a></span><span>
</span><span id="line-522"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-523"></span><span>    </span><span id="local-6989586621684374819"><span class="annot"><span class="annottext">indexes :: Int
</span><a href="#local-6989586621684374819"><span class="hs-identifier hs-var hs-var">indexes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; Int
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">sum</span></span><span> </span><span class="annot"><span class="annottext">([Int] -&gt; Int) -&gt; [Int] -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Int -&gt; Int) -&gt; [Int] -&gt; [Int] -&gt; [Int]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">(*)</span></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684374818"><span class="hs-identifier hs-var">ns</span></a></span><span> </span><span class="annot"><span class="annottext">([Int] -&gt; [Int]) -&gt; [Int] -&gt; [Int]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Shape -&gt; Int) -&gt; [Shape] -&gt; [Int]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Shape -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Shape]
</span><a href="#local-6989586621684374820"><span class="hs-identifier hs-var">ws</span></a></span><span>
</span><span id="line-524"></span><span>    </span><span id="local-6989586621684374821"><span class="annot"><span class="annottext">val_ts :: [Type]
</span><a href="#local-6989586621684374821"><span class="hs-identifier hs-var hs-var">val_ts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Type] -&gt; [Type]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684374819"><span class="hs-identifier hs-var">indexes</span></a></span><span> </span><span class="annot"><span class="annottext">([Type] -&gt; [Type]) -&gt; [Type] -&gt; [Type]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; [Type]
forall rep. LambdaT rep -&gt; [Type]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684374824"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-525"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684374820"><span class="annot"><span class="annottext">[Shape]
</span><a href="#local-6989586621684374820"><span class="hs-identifier hs-var">ws</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684374818"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684374818"><span class="hs-identifier hs-var">ns</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Shape, Int, VName)] -&gt; ([Shape], [Int], [VName])
forall a b c. [(a, b, c)] -&gt; ([a], [b], [c])
</span><span class="hs-identifier hs-var">unzip3</span></span><span> </span><span class="annot"><span class="annottext">[(Shape, Int, VName)]
</span><a href="#local-6989586621684374823"><span class="hs-identifier hs-var">dests</span></a></span><span>
</span><span id="line-526"></span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#soacType"><span class="hs-identifier hs-var">soacType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Hist"><span class="hs-identifier hs-type">Hist</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684374817"><span class="annot"><span class="annottext">[HistOp rep]
</span><a href="#local-6989586621684374817"><span class="hs-identifier hs-var">ops</span></a></span></span><span> </span><span id="local-6989586621684374816"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684374816"><span class="hs-identifier hs-var">_bucket_fun</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-527"></span><span>  </span><span id="local-6989586621684374815"><span class="annot"><span class="annottext">HistOp rep
</span><a href="#local-6989586621684374815"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[HistOp rep]
</span><a href="#local-6989586621684374817"><span class="hs-identifier hs-var">ops</span></a></span><span>
</span><span id="line-528"></span><span>  </span><span class="annot"><span class="annottext">(Type -&gt; Type) -&gt; [Type] -&gt; [Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Shape -&gt; Type
</span><a href="Futhark.IR.Prop.Types.html#arrayOfShape"><span class="hs-operator hs-var">`arrayOfShape`</span></a></span><span> </span><span class="annot"><span class="annottext">HistOp rep -&gt; Shape
forall rep. HistOp rep -&gt; Shape
</span><a href="Futhark.IR.SOACS.SOAC.html#histShape"><span class="hs-identifier hs-var hs-var">histShape</span></a></span><span> </span><span class="annot"><span class="annottext">HistOp rep
</span><a href="#local-6989586621684374815"><span class="hs-identifier hs-var">op</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda rep -&gt; [Type]
forall rep. LambdaT rep -&gt; [Type]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">(Lambda rep -&gt; [Type]) -&gt; Lambda rep -&gt; [Type]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HistOp rep -&gt; Lambda rep
forall rep. HistOp rep -&gt; Lambda rep
</span><a href="Futhark.IR.SOACS.SOAC.html#histOp"><span class="hs-identifier hs-var hs-var">histOp</span></a></span><span> </span><span class="annot"><span class="annottext">HistOp rep
</span><a href="#local-6989586621684374815"><span class="hs-identifier hs-var">op</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-529"></span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#soacType"><span class="hs-identifier hs-var">soacType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Screma"><span class="hs-identifier hs-type">Screma</span></a></span><span> </span><span id="local-6989586621684374814"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684374814"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684374813"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684374813"><span class="hs-identifier hs-var">_arrs</span></a></span></span><span> </span><span id="local-6989586621684374812"><span class="annot"><span class="annottext">ScremaForm rep
</span><a href="#local-6989586621684374812"><span class="hs-identifier hs-var">form</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-530"></span><span>  </span><span class="annot"><span class="annottext">SubExp -&gt; ScremaForm rep -&gt; [Type]
forall rep. SubExp -&gt; ScremaForm rep -&gt; [Type]
</span><a href="Futhark.IR.SOACS.SOAC.html#scremaType"><span class="hs-identifier hs-var">scremaType</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684374814"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">ScremaForm rep
</span><a href="#local-6989586621684374812"><span class="hs-identifier hs-var">form</span></a></span><span>
</span><span id="line-531"></span><span>
</span><span id="line-532"></span><span id="local-6989586621684376182"><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.html#ASTRep"><span class="hs-identifier hs-type">ASTRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376182"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.TypeOf.html#TypedOp"><span class="hs-identifier hs-type">TypedOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#SOAC"><span class="hs-identifier hs-type">SOAC</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376182"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-533"></span><span>  </span><span id="local-6989586621684374794"><span class="annot"><span class="annottext">opType :: forall t (m :: * -&gt; *). HasScope t m =&gt; SOAC rep -&gt; m [ExtType]
</span><a href="Futhark.IR.Prop.TypeOf.html#opType"><span class="hs-identifier hs-var hs-var hs-var hs-var">opType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ExtType] -&gt; m [ExtType]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">([ExtType] -&gt; m [ExtType])
-&gt; (SOAC rep -&gt; [ExtType]) -&gt; SOAC rep -&gt; m [ExtType]
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; [ExtType]
forall u. [TypeBase Shape u] -&gt; [TypeBase ExtShape u]
</span><a href="Futhark.IR.Prop.Types.html#staticShapes"><span class="hs-identifier hs-var">staticShapes</span></a></span><span> </span><span class="annot"><span class="annottext">([Type] -&gt; [ExtType])
-&gt; (SOAC rep -&gt; [Type]) -&gt; SOAC rep -&gt; [ExtType]
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SOAC rep -&gt; [Type]
forall rep. Typed (LParamInfo rep) =&gt; SOAC rep -&gt; [Type]
</span><a href="Futhark.IR.SOACS.SOAC.html#soacType"><span class="hs-identifier hs-var">soacType</span></a></span></span><span>
</span><span id="line-534"></span><span>
</span><span id="line-535"></span><span id="local-6989586621684376168"><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Prop.html#ASTRep"><span class="hs-identifier hs-type">ASTRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376168"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Aliases.html#Aliased"><span class="hs-identifier hs-type">Aliased</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376168"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Aliases.html#AliasedOp"><span class="hs-identifier hs-type">AliasedOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#SOAC"><span class="hs-identifier hs-type">SOAC</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376168"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-536"></span><span>  </span><span id="local-6989586621684374774"><span class="annot"><span class="annottext">opAliases :: SOAC rep -&gt; [Names]
</span><a href="Futhark.IR.Prop.Aliases.html#opAliases"><span class="hs-identifier hs-var hs-var hs-var hs-var">opAliases</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Names) -&gt; [Type] -&gt; [Names]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Names -&gt; Type -&gt; Names
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Type] -&gt; [Names]) -&gt; (SOAC rep -&gt; [Type]) -&gt; SOAC rep -&gt; [Names]
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SOAC rep -&gt; [Type]
forall rep. Typed (LParamInfo rep) =&gt; SOAC rep -&gt; [Type]
</span><a href="Futhark.IR.SOACS.SOAC.html#soacType"><span class="hs-identifier hs-var">soacType</span></a></span><span>
</span><span id="line-537"></span><span>
</span><span id="line-538"></span><span>  </span><span id="local-6989586621684374763"><span class="annot"><span class="annottext">consumedInOp :: SOAC rep -&gt; Names
</span><a href="Futhark.IR.Prop.Aliases.html#consumedInOp"><span class="hs-identifier hs-var hs-var hs-var hs-var">consumedInOp</span></a></span></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#JVP"><span class="hs-identifier hs-type">JVP</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-539"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Aliases.html#consumedInOp"><span class="hs-identifier hs-var">consumedInOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#VJP"><span class="hs-identifier hs-type">VJP</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-540"></span><span>  </span><span class="hs-comment">-- Only map functions can consume anything.  The operands to scan</span><span>
</span><span id="line-541"></span><span>  </span><span class="hs-comment">-- and reduce functions are always considered &quot;fresh&quot;.</span><span>
</span><span id="line-542"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Aliases.html#consumedInOp"><span class="hs-identifier hs-var">consumedInOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Screma"><span class="hs-identifier hs-type">Screma</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684374761"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684374761"><span class="hs-identifier hs-var">arrs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#ScremaForm"><span class="hs-identifier hs-type">ScremaForm</span></a></span><span> </span><span class="annot"><span class="annottext">[Scan rep]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[Reduce rep]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684374760"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684374760"><span class="hs-identifier hs-var">map_lam</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-543"></span><span>    </span><span class="annot"><span class="annottext">(VName -&gt; VName) -&gt; Names -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#mapNames"><span class="hs-identifier hs-var">mapNames</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; VName
</span><a href="#local-6989586621684374758"><span class="hs-identifier hs-var">consumedArray</span></a></span><span> </span><span class="annot"><span class="annottext">(Names -&gt; Names) -&gt; Names -&gt; Names
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; Names
forall rep. Aliased rep =&gt; Lambda rep -&gt; Names
</span><a href="Futhark.IR.Prop.Aliases.html#consumedByLambda"><span class="hs-identifier hs-var">consumedByLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684374760"><span class="hs-identifier hs-var">map_lam</span></a></span><span>
</span><span id="line-544"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-545"></span><span>      </span><span id="local-6989586621684374758"><span class="annot"><span class="annottext">consumedArray :: VName -&gt; VName
</span><a href="#local-6989586621684374758"><span class="hs-identifier hs-var hs-var">consumedArray</span></a></span></span><span> </span><span id="local-6989586621684374756"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684374756"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Maybe VName -&gt; VName
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684374756"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe VName -&gt; VName) -&gt; Maybe VName -&gt; VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [(VName, VName)] -&gt; Maybe VName
forall a b. Eq a =&gt; a -&gt; [(a, b)] -&gt; Maybe b
</span><span class="hs-identifier hs-var">lookup</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684374756"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">[(VName, VName)]
</span><a href="#local-6989586621684374753"><span class="hs-identifier hs-var">params_to_arrs</span></a></span><span>
</span><span id="line-546"></span><span>      </span><span id="local-6989586621684374753"><span class="annot"><span class="annottext">params_to_arrs :: [(VName, VName)]
</span><a href="#local-6989586621684374753"><span class="hs-identifier hs-var hs-var">params_to_arrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [(VName, VName)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Param (LParamInfo rep) -&gt; VName)
-&gt; [Param (LParamInfo rep)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Param (LParamInfo rep) -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">([Param (LParamInfo rep)] -&gt; [VName])
-&gt; [Param (LParamInfo rep)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; [Param (LParamInfo rep)]
forall {rep}. LambdaT rep -&gt; [Param (LParamInfo rep)]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684374760"><span class="hs-identifier hs-var">map_lam</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684374761"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-547"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Aliases.html#consumedInOp"><span class="hs-identifier hs-var">consumedInOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684374752"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684374752"><span class="hs-identifier hs-var">arrs</span></a></span></span><span> </span><span id="local-6989586621684374751"><span class="annot"><span class="annottext">StreamForm rep
</span><a href="#local-6989586621684374751"><span class="hs-identifier hs-var">form</span></a></span></span><span> </span><span id="local-6989586621684374750"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684374750"><span class="hs-identifier hs-var">accs</span></a></span></span><span> </span><span id="local-6989586621684374749"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684374749"><span class="hs-identifier hs-var">lam</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-548"></span><span>    </span><span class="annot"><span class="annottext">[VName] -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#namesFromList"><span class="hs-identifier hs-var">namesFromList</span></a></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; Names) -&gt; [VName] -&gt; Names
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-549"></span><span>      </span><span class="annot"><span class="annottext">[SubExp] -&gt; [VName]
</span><a href="Futhark.IR.Prop.html#subExpVars"><span class="hs-identifier hs-var">subExpVars</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [VName]) -&gt; [SubExp] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-550"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">StreamForm rep
</span><a href="#local-6989586621684374751"><span class="hs-identifier hs-var">form</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-551"></span><span>          </span><span class="annot"><span class="annottext">StreamForm rep
</span><a href="Futhark.IR.SOACS.SOAC.html#Sequential"><span class="hs-identifier hs-var">Sequential</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-552"></span><span>            </span><span class="annot"><span class="annottext">(VName -&gt; SubExp) -&gt; [VName] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="#local-6989586621684374746"><span class="hs-identifier hs-var">consumedArray</span></a></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; [SubExp]) -&gt; [VName] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Names -&gt; [VName]
</span><a href="Futhark.IR.Prop.Names.html#namesToList"><span class="hs-identifier hs-var">namesToList</span></a></span><span> </span><span class="annot"><span class="annottext">(Names -&gt; [VName]) -&gt; Names -&gt; [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; Names
forall rep. Aliased rep =&gt; Lambda rep -&gt; Names
</span><a href="Futhark.IR.Prop.Aliases.html#consumedByLambda"><span class="hs-identifier hs-var">consumedByLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684374749"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-553"></span><span>          </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Parallel"><span class="hs-identifier hs-type">Parallel</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-554"></span><span>            </span><span class="annot"><span class="annottext">(VName -&gt; SubExp) -&gt; [VName] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="#local-6989586621684374746"><span class="hs-identifier hs-var">consumedArray</span></a></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; [SubExp]) -&gt; [VName] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Names -&gt; [VName]
</span><a href="Futhark.IR.Prop.Names.html#namesToList"><span class="hs-identifier hs-var">namesToList</span></a></span><span> </span><span class="annot"><span class="annottext">(Names -&gt; [VName]) -&gt; Names -&gt; [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; Names
forall rep. Aliased rep =&gt; Lambda rep -&gt; Names
</span><a href="Futhark.IR.Prop.Aliases.html#consumedByLambda"><span class="hs-identifier hs-var">consumedByLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684374749"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-555"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-556"></span><span>      </span><span id="local-6989586621684374746"><span class="annot"><span class="annottext">consumedArray :: VName -&gt; SubExp
</span><a href="#local-6989586621684374746"><span class="hs-identifier hs-var hs-var">consumedArray</span></a></span></span><span> </span><span id="local-6989586621684374744"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684374744"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Maybe SubExp -&gt; SubExp
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684374744"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe SubExp -&gt; SubExp) -&gt; Maybe SubExp -&gt; SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [(VName, SubExp)] -&gt; Maybe SubExp
forall a b. Eq a =&gt; a -&gt; [(a, b)] -&gt; Maybe b
</span><span class="hs-identifier hs-var">lookup</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684374744"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">[(VName, SubExp)]
</span><a href="#local-6989586621684374743"><span class="hs-identifier hs-var">paramsToInput</span></a></span><span>
</span><span id="line-557"></span><span>      </span><span class="hs-comment">-- Drop the chunk parameter, which cannot alias anything.</span><span>
</span><span id="line-558"></span><span>      </span><span id="local-6989586621684374743"><span class="annot"><span class="annottext">paramsToInput :: [(VName, SubExp)]
</span><a href="#local-6989586621684374743"><span class="hs-identifier hs-var hs-var">paramsToInput</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-559"></span><span>        </span><span class="annot"><span class="annottext">[VName] -&gt; [SubExp] -&gt; [(VName, SubExp)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Param (LParamInfo rep) -&gt; VName)
-&gt; [Param (LParamInfo rep)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Param (LParamInfo rep) -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">([Param (LParamInfo rep)] -&gt; [VName])
-&gt; [Param (LParamInfo rep)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Param (LParamInfo rep)] -&gt; [Param (LParamInfo rep)]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">([Param (LParamInfo rep)] -&gt; [Param (LParamInfo rep)])
-&gt; [Param (LParamInfo rep)] -&gt; [Param (LParamInfo rep)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; [Param (LParamInfo rep)]
forall {rep}. LambdaT rep -&gt; [Param (LParamInfo rep)]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684374749"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684374750"><span class="hs-identifier hs-var">accs</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; [SubExp] -&gt; [SubExp]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SubExp) -&gt; [VName] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684374752"><span class="hs-identifier hs-var">arrs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-560"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Aliases.html#consumedInOp"><span class="hs-identifier hs-var">consumedInOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Scatter"><span class="hs-identifier hs-type">Scatter</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684374742"><span class="annot"><span class="annottext">[(Shape, Int, VName)]
</span><a href="#local-6989586621684374742"><span class="hs-keyword hs-var">as</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-561"></span><span>    </span><span class="annot"><span class="annottext">[VName] -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#namesFromList"><span class="hs-identifier hs-var">namesFromList</span></a></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; Names) -&gt; [VName] -&gt; Names
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((Shape, Int, VName) -&gt; VName) -&gt; [(Shape, Int, VName)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Shape
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684374741"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684374741"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684374741"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Shape, Int, VName)]
</span><a href="#local-6989586621684374742"><span class="hs-keyword hs-var">as</span></a></span><span>
</span><span id="line-562"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Aliases.html#consumedInOp"><span class="hs-identifier hs-var">consumedInOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Hist"><span class="hs-identifier hs-type">Hist</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684374740"><span class="annot"><span class="annottext">[HistOp rep]
</span><a href="#local-6989586621684374740"><span class="hs-identifier hs-var">ops</span></a></span></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-563"></span><span>    </span><span class="annot"><span class="annottext">[VName] -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#namesFromList"><span class="hs-identifier hs-var">namesFromList</span></a></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; Names) -&gt; [VName] -&gt; Names
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(HistOp rep -&gt; [VName]) -&gt; [HistOp rep] -&gt; [VName]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="annot"><span class="annottext">HistOp rep -&gt; [VName]
forall rep. HistOp rep -&gt; [VName]
</span><a href="Futhark.IR.SOACS.SOAC.html#histDest"><span class="hs-identifier hs-var hs-var">histDest</span></a></span><span> </span><span class="annot"><span class="annottext">[HistOp rep]
</span><a href="#local-6989586621684374740"><span class="hs-identifier hs-var">ops</span></a></span></span><span>
</span><span id="line-564"></span><span>
</span><span id="line-565"></span><span id="local-6989586621684376160"><span id="local-6989586621684376161"><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#mapHistOp"><span class="hs-identifier hs-type">mapHistOp</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-566"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376161"><span class="hs-identifier hs-type">frep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376160"><span class="hs-identifier hs-type">trep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-567"></span><span>  </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#HistOp"><span class="hs-identifier hs-type">HistOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376161"><span class="hs-identifier hs-type">frep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-568"></span><span>  </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#HistOp"><span class="hs-identifier hs-type">HistOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376160"><span class="hs-identifier hs-type">trep</span></a></span></span></span><span>
</span><span id="line-569"></span><span id="mapHistOp"><span class="annot"><span class="annottext">mapHistOp :: forall frep trep.
(Lambda frep -&gt; Lambda trep) -&gt; HistOp frep -&gt; HistOp trep
</span><a href="Futhark.IR.SOACS.SOAC.html#mapHistOp"><span class="hs-identifier hs-var hs-var">mapHistOp</span></a></span></span><span> </span><span id="local-6989586621684374738"><span class="annot"><span class="annottext">Lambda frep -&gt; Lambda trep
</span><a href="#local-6989586621684374738"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#HistOp"><span class="hs-identifier hs-type">HistOp</span></a></span><span> </span><span id="local-6989586621684374737"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684374737"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684374736"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684374736"><span class="hs-identifier hs-var">rf</span></a></span></span><span> </span><span id="local-6989586621684374735"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684374735"><span class="hs-identifier hs-var">dests</span></a></span></span><span> </span><span id="local-6989586621684374734"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684374734"><span class="hs-identifier hs-var">nes</span></a></span></span><span> </span><span id="local-6989586621684374733"><span class="annot"><span class="annottext">Lambda frep
</span><a href="#local-6989586621684374733"><span class="hs-identifier hs-var">lam</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-570"></span><span>  </span><span class="annot"><span class="annottext">Shape
-&gt; SubExp -&gt; [VName] -&gt; [SubExp] -&gt; Lambda trep -&gt; HistOp trep
forall rep.
Shape -&gt; SubExp -&gt; [VName] -&gt; [SubExp] -&gt; Lambda rep -&gt; HistOp rep
</span><a href="Futhark.IR.SOACS.SOAC.html#HistOp"><span class="hs-identifier hs-var">HistOp</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684374737"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684374736"><span class="hs-identifier hs-var">rf</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684374735"><span class="hs-identifier hs-var">dests</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684374734"><span class="hs-identifier hs-var">nes</span></a></span><span> </span><span class="annot"><span class="annottext">(Lambda trep -&gt; HistOp trep) -&gt; Lambda trep -&gt; HistOp trep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda frep -&gt; Lambda trep
</span><a href="#local-6989586621684374738"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda frep
</span><a href="#local-6989586621684374733"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-571"></span><span>
</span><span id="line-572"></span><span id="local-6989586621684376150"><span class="hs-keyword">instance</span><span>
</span><span id="line-573"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.html#ASTRep"><span class="hs-identifier hs-type">ASTRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376150"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-574"></span><span>    </span><span class="annot"><a href="Futhark.IR.Prop.html#ASTRep"><span class="hs-identifier hs-type">ASTRep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Aliases.html#Aliases"><span class="hs-identifier hs-type">Aliases</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376150"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-575"></span><span>    </span><span class="annot"><a href="Futhark.IR.Prop.Aliases.html#CanBeAliased"><span class="hs-identifier hs-type">CanBeAliased</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376150"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-576"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-577"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Aliases.html#CanBeAliased"><span class="hs-identifier hs-type">CanBeAliased</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#SOAC"><span class="hs-identifier hs-type">SOAC</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376150"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-578"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-579"></span><span>  </span><span class="hs-keyword">type</span><span> </span><span id="OpWithAliases"><span class="annot"><a href="Futhark.IR.Prop.Aliases.html#OpWithAliases"><span class="hs-identifier hs-var">OpWithAliases</span></a></span></span><span> </span><span id="local-6989586621684376150"><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#SOAC"><span class="hs-identifier hs-type">SOAC</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376150"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#SOAC"><span class="hs-identifier hs-type">SOAC</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Aliases.html#Aliases"><span class="hs-identifier hs-type">Aliases</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376150"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-580"></span><span>
</span><span id="line-581"></span><span>  </span><span id="local-6989586621684374697"><span class="annot"><span class="annottext">addOpAliases :: AliasTable -&gt; SOAC rep -&gt; OpWithAliases (SOAC rep)
</span><a href="Futhark.IR.Prop.Aliases.html#addOpAliases"><span class="hs-identifier hs-var hs-var hs-var hs-var">addOpAliases</span></a></span></span><span> </span><span id="local-6989586621684374695"><span class="annot"><span class="annottext">AliasTable
</span><a href="#local-6989586621684374695"><span class="hs-identifier hs-var">aliases</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#JVP"><span class="hs-identifier hs-type">JVP</span></a></span><span> </span><span id="local-6989586621684374694"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684374694"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span id="local-6989586621684374693"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684374693"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621684374692"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684374692"><span class="hs-identifier hs-var">vec</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-582"></span><span>    </span><span class="annot"><span class="annottext">Lambda (Aliases rep) -&gt; [SubExp] -&gt; [SubExp] -&gt; SOAC (Aliases rep)
forall rep. Lambda rep -&gt; [SubExp] -&gt; [SubExp] -&gt; SOAC rep
</span><a href="Futhark.IR.SOACS.SOAC.html#JVP"><span class="hs-identifier hs-var">JVP</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AliasTable -&gt; Lambda rep -&gt; Lambda (Aliases rep)
forall rep.
(ASTRep rep, CanBeAliased (Op rep)) =&gt;
AliasTable -&gt; Lambda rep -&gt; Lambda (Aliases rep)
</span><a href="Futhark.Analysis.Alias.html#analyseLambda"><span class="hs-identifier hs-var">Alias.analyseLambda</span></a></span><span> </span><span class="annot"><span class="annottext">AliasTable
</span><a href="#local-6989586621684374695"><span class="hs-identifier hs-var">aliases</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684374694"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684374693"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684374692"><span class="hs-identifier hs-var">vec</span></a></span><span>
</span><span id="line-583"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Aliases.html#addOpAliases"><span class="hs-identifier hs-var">addOpAliases</span></a></span><span> </span><span id="local-6989586621684374690"><span class="annot"><span class="annottext">AliasTable
</span><a href="#local-6989586621684374690"><span class="hs-identifier hs-var">aliases</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#VJP"><span class="hs-identifier hs-type">VJP</span></a></span><span> </span><span id="local-6989586621684374689"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684374689"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span id="local-6989586621684374688"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684374688"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621684374687"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684374687"><span class="hs-identifier hs-var">vec</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-584"></span><span>    </span><span class="annot"><span class="annottext">Lambda (Aliases rep) -&gt; [SubExp] -&gt; [SubExp] -&gt; SOAC (Aliases rep)
forall rep. Lambda rep -&gt; [SubExp] -&gt; [SubExp] -&gt; SOAC rep
</span><a href="Futhark.IR.SOACS.SOAC.html#VJP"><span class="hs-identifier hs-var">VJP</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AliasTable -&gt; Lambda rep -&gt; Lambda (Aliases rep)
forall rep.
(ASTRep rep, CanBeAliased (Op rep)) =&gt;
AliasTable -&gt; Lambda rep -&gt; Lambda (Aliases rep)
</span><a href="Futhark.Analysis.Alias.html#analyseLambda"><span class="hs-identifier hs-var">Alias.analyseLambda</span></a></span><span> </span><span class="annot"><span class="annottext">AliasTable
</span><a href="#local-6989586621684374690"><span class="hs-identifier hs-var">aliases</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684374689"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684374688"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684374687"><span class="hs-identifier hs-var">vec</span></a></span><span>
</span><span id="line-585"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Aliases.html#addOpAliases"><span class="hs-identifier hs-var">addOpAliases</span></a></span><span> </span><span id="local-6989586621684374686"><span class="annot"><span class="annottext">AliasTable
</span><a href="#local-6989586621684374686"><span class="hs-identifier hs-var">aliases</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621684374685"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684374685"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span id="local-6989586621684374684"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684374684"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span id="local-6989586621684374683"><span class="annot"><span class="annottext">StreamForm rep
</span><a href="#local-6989586621684374683"><span class="hs-identifier hs-var">form</span></a></span></span><span> </span><span id="local-6989586621684374682"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684374682"><span class="hs-identifier hs-var">accs</span></a></span></span><span> </span><span id="local-6989586621684374681"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684374681"><span class="hs-identifier hs-var">lam</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-586"></span><span>    </span><span class="annot"><span class="annottext">SubExp
-&gt; [VName]
-&gt; StreamForm (Aliases rep)
-&gt; [SubExp]
-&gt; Lambda (Aliases rep)
-&gt; SOAC (Aliases rep)
forall rep.
SubExp
-&gt; [VName] -&gt; StreamForm rep -&gt; [SubExp] -&gt; Lambda rep -&gt; SOAC rep
</span><a href="Futhark.IR.SOACS.SOAC.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684374685"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684374684"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StreamForm rep -&gt; StreamForm (Aliases rep)
</span><a href="#local-6989586621684374680"><span class="hs-identifier hs-var">analyseStreamForm</span></a></span><span> </span><span class="annot"><span class="annottext">StreamForm rep
</span><a href="#local-6989586621684374683"><span class="hs-identifier hs-var">form</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684374682"><span class="hs-identifier hs-var">accs</span></a></span><span> </span><span class="annot"><span class="annottext">(Lambda (Aliases rep) -&gt; SOAC (Aliases rep))
-&gt; Lambda (Aliases rep) -&gt; SOAC (Aliases rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-587"></span><span>      </span><span class="annot"><span class="annottext">AliasTable -&gt; Lambda rep -&gt; Lambda (Aliases rep)
forall rep.
(ASTRep rep, CanBeAliased (Op rep)) =&gt;
AliasTable -&gt; Lambda rep -&gt; Lambda (Aliases rep)
</span><a href="Futhark.Analysis.Alias.html#analyseLambda"><span class="hs-identifier hs-var">Alias.analyseLambda</span></a></span><span> </span><span class="annot"><span class="annottext">AliasTable
</span><a href="#local-6989586621684374686"><span class="hs-identifier hs-var">aliases</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684374681"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-588"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-589"></span><span>      </span><span id="local-6989586621684374680"><span class="annot"><span class="annottext">analyseStreamForm :: StreamForm rep -&gt; StreamForm (Aliases rep)
</span><a href="#local-6989586621684374680"><span class="hs-identifier hs-var hs-var">analyseStreamForm</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Parallel"><span class="hs-identifier hs-type">Parallel</span></a></span><span> </span><span id="local-6989586621684374679"><span class="annot"><span class="annottext">StreamOrd
</span><a href="#local-6989586621684374679"><span class="hs-identifier hs-var">o</span></a></span></span><span> </span><span id="local-6989586621684374678"><span class="annot"><span class="annottext">Commutativity
</span><a href="#local-6989586621684374678"><span class="hs-identifier hs-var">comm</span></a></span></span><span> </span><span id="local-6989586621684374677"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684374677"><span class="hs-identifier hs-var">lam0</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-590"></span><span>        </span><span class="annot"><span class="annottext">StreamOrd
-&gt; Commutativity
-&gt; Lambda (Aliases rep)
-&gt; StreamForm (Aliases rep)
forall rep.
StreamOrd -&gt; Commutativity -&gt; Lambda rep -&gt; StreamForm rep
</span><a href="Futhark.IR.SOACS.SOAC.html#Parallel"><span class="hs-identifier hs-var">Parallel</span></a></span><span> </span><span class="annot"><span class="annottext">StreamOrd
</span><a href="#local-6989586621684374679"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="annot"><span class="annottext">Commutativity
</span><a href="#local-6989586621684374678"><span class="hs-identifier hs-var">comm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AliasTable -&gt; Lambda rep -&gt; Lambda (Aliases rep)
forall rep.
(ASTRep rep, CanBeAliased (Op rep)) =&gt;
AliasTable -&gt; Lambda rep -&gt; Lambda (Aliases rep)
</span><a href="Futhark.Analysis.Alias.html#analyseLambda"><span class="hs-identifier hs-var">Alias.analyseLambda</span></a></span><span> </span><span class="annot"><span class="annottext">AliasTable
</span><a href="#local-6989586621684374686"><span class="hs-identifier hs-var">aliases</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684374677"><span class="hs-identifier hs-var">lam0</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-591"></span><span>      </span><span class="annot"><a href="#local-6989586621684374680"><span class="hs-identifier hs-var">analyseStreamForm</span></a></span><span> </span><span class="annot"><span class="annottext">StreamForm rep
</span><a href="Futhark.IR.SOACS.SOAC.html#Sequential"><span class="hs-identifier hs-var">Sequential</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StreamForm (Aliases rep)
forall rep. StreamForm rep
</span><a href="Futhark.IR.SOACS.SOAC.html#Sequential"><span class="hs-identifier hs-var">Sequential</span></a></span><span>
</span><span id="line-592"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Aliases.html#addOpAliases"><span class="hs-identifier hs-var">addOpAliases</span></a></span><span> </span><span id="local-6989586621684374676"><span class="annot"><span class="annottext">AliasTable
</span><a href="#local-6989586621684374676"><span class="hs-identifier hs-var">aliases</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Scatter"><span class="hs-identifier hs-type">Scatter</span></a></span><span> </span><span id="local-6989586621684374675"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684374675"><span class="hs-identifier hs-var">len</span></a></span></span><span> </span><span id="local-6989586621684374674"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684374674"><span class="hs-identifier hs-var">arrs</span></a></span></span><span> </span><span id="local-6989586621684374673"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684374673"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span id="local-6989586621684374672"><span class="annot"><span class="annottext">[(Shape, Int, VName)]
</span><a href="#local-6989586621684374672"><span class="hs-identifier hs-var">dests</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-593"></span><span>    </span><span class="annot"><span class="annottext">SubExp
-&gt; [VName]
-&gt; Lambda (Aliases rep)
-&gt; [(Shape, Int, VName)]
-&gt; SOAC (Aliases rep)
forall rep.
SubExp
-&gt; [VName] -&gt; Lambda rep -&gt; [(Shape, Int, VName)] -&gt; SOAC rep
</span><a href="Futhark.IR.SOACS.SOAC.html#Scatter"><span class="hs-identifier hs-var">Scatter</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684374675"><span class="hs-identifier hs-var">len</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684374674"><span class="hs-identifier hs-var">arrs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AliasTable -&gt; Lambda rep -&gt; Lambda (Aliases rep)
forall rep.
(ASTRep rep, CanBeAliased (Op rep)) =&gt;
AliasTable -&gt; Lambda rep -&gt; Lambda (Aliases rep)
</span><a href="Futhark.Analysis.Alias.html#analyseLambda"><span class="hs-identifier hs-var">Alias.analyseLambda</span></a></span><span> </span><span class="annot"><span class="annottext">AliasTable
</span><a href="#local-6989586621684374676"><span class="hs-identifier hs-var">aliases</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684374673"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Shape, Int, VName)]
</span><a href="#local-6989586621684374672"><span class="hs-identifier hs-var">dests</span></a></span><span>
</span><span id="line-594"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Aliases.html#addOpAliases"><span class="hs-identifier hs-var">addOpAliases</span></a></span><span> </span><span id="local-6989586621684374671"><span class="annot"><span class="annottext">AliasTable
</span><a href="#local-6989586621684374671"><span class="hs-identifier hs-var">aliases</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Hist"><span class="hs-identifier hs-type">Hist</span></a></span><span> </span><span id="local-6989586621684374670"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684374670"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684374669"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684374669"><span class="hs-identifier hs-var">arrs</span></a></span></span><span> </span><span id="local-6989586621684374668"><span class="annot"><span class="annottext">[HistOp rep]
</span><a href="#local-6989586621684374668"><span class="hs-identifier hs-var">ops</span></a></span></span><span> </span><span id="local-6989586621684374667"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684374667"><span class="hs-identifier hs-var">bucket_fun</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-595"></span><span>    </span><span class="annot"><span class="annottext">SubExp
-&gt; [VName]
-&gt; [HistOp (Aliases rep)]
-&gt; Lambda (Aliases rep)
-&gt; SOAC (Aliases rep)
forall rep.
SubExp -&gt; [VName] -&gt; [HistOp rep] -&gt; Lambda rep -&gt; SOAC rep
</span><a href="Futhark.IR.SOACS.SOAC.html#Hist"><span class="hs-identifier hs-var">Hist</span></a></span><span>
</span><span id="line-596"></span><span>      </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684374670"><span class="hs-identifier hs-var">w</span></a></span><span>
</span><span id="line-597"></span><span>      </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684374669"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-598"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(HistOp rep -&gt; HistOp (Aliases rep))
-&gt; [HistOp rep] -&gt; [HistOp (Aliases rep)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Lambda rep -&gt; Lambda (Aliases rep))
-&gt; HistOp rep -&gt; HistOp (Aliases rep)
forall frep trep.
(Lambda frep -&gt; Lambda trep) -&gt; HistOp frep -&gt; HistOp trep
</span><a href="Futhark.IR.SOACS.SOAC.html#mapHistOp"><span class="hs-identifier hs-var">mapHistOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AliasTable -&gt; Lambda rep -&gt; Lambda (Aliases rep)
forall rep.
(ASTRep rep, CanBeAliased (Op rep)) =&gt;
AliasTable -&gt; Lambda rep -&gt; Lambda (Aliases rep)
</span><a href="Futhark.Analysis.Alias.html#analyseLambda"><span class="hs-identifier hs-var">Alias.analyseLambda</span></a></span><span> </span><span class="annot"><span class="annottext">AliasTable
</span><a href="#local-6989586621684374671"><span class="hs-identifier hs-var">aliases</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[HistOp rep]
</span><a href="#local-6989586621684374668"><span class="hs-identifier hs-var">ops</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-599"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AliasTable -&gt; Lambda rep -&gt; Lambda (Aliases rep)
forall rep.
(ASTRep rep, CanBeAliased (Op rep)) =&gt;
AliasTable -&gt; Lambda rep -&gt; Lambda (Aliases rep)
</span><a href="Futhark.Analysis.Alias.html#analyseLambda"><span class="hs-identifier hs-var">Alias.analyseLambda</span></a></span><span> </span><span class="annot"><span class="annottext">AliasTable
</span><a href="#local-6989586621684374671"><span class="hs-identifier hs-var">aliases</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684374667"><span class="hs-identifier hs-var">bucket_fun</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-600"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Aliases.html#addOpAliases"><span class="hs-identifier hs-var">addOpAliases</span></a></span><span> </span><span id="local-6989586621684374666"><span class="annot"><span class="annottext">AliasTable
</span><a href="#local-6989586621684374666"><span class="hs-identifier hs-var">aliases</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Screma"><span class="hs-identifier hs-type">Screma</span></a></span><span> </span><span id="local-6989586621684374665"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684374665"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684374664"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684374664"><span class="hs-identifier hs-var">arrs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#ScremaForm"><span class="hs-identifier hs-type">ScremaForm</span></a></span><span> </span><span id="local-6989586621684374663"><span class="annot"><span class="annottext">[Scan rep]
</span><a href="#local-6989586621684374663"><span class="hs-identifier hs-var">scans</span></a></span></span><span> </span><span id="local-6989586621684374662"><span class="annot"><span class="annottext">[Reduce rep]
</span><a href="#local-6989586621684374662"><span class="hs-identifier hs-var">reds</span></a></span></span><span> </span><span id="local-6989586621684374661"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684374661"><span class="hs-identifier hs-var">map_lam</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-601"></span><span>    </span><span class="annot"><span class="annottext">SubExp -&gt; [VName] -&gt; ScremaForm (Aliases rep) -&gt; SOAC (Aliases rep)
forall rep. SubExp -&gt; [VName] -&gt; ScremaForm rep -&gt; SOAC rep
</span><a href="Futhark.IR.SOACS.SOAC.html#Screma"><span class="hs-identifier hs-var">Screma</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684374665"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684374664"><span class="hs-identifier hs-var">arrs</span></a></span><span> </span><span class="annot"><span class="annottext">(ScremaForm (Aliases rep) -&gt; SOAC (Aliases rep))
-&gt; ScremaForm (Aliases rep) -&gt; SOAC (Aliases rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-602"></span><span>      </span><span class="annot"><span class="annottext">[Scan (Aliases rep)]
-&gt; [Reduce (Aliases rep)]
-&gt; Lambda (Aliases rep)
-&gt; ScremaForm (Aliases rep)
forall rep.
[Scan rep] -&gt; [Reduce rep] -&gt; Lambda rep -&gt; ScremaForm rep
</span><a href="Futhark.IR.SOACS.SOAC.html#ScremaForm"><span class="hs-identifier hs-var">ScremaForm</span></a></span><span>
</span><span id="line-603"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Scan rep -&gt; Scan (Aliases rep))
-&gt; [Scan rep] -&gt; [Scan (Aliases rep)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Scan rep -&gt; Scan (Aliases rep)
</span><a href="#local-6989586621684374660"><span class="hs-identifier hs-var">onScan</span></a></span><span> </span><span class="annot"><span class="annottext">[Scan rep]
</span><a href="#local-6989586621684374663"><span class="hs-identifier hs-var">scans</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-604"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Reduce rep -&gt; Reduce (Aliases rep))
-&gt; [Reduce rep] -&gt; [Reduce (Aliases rep)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Reduce rep -&gt; Reduce (Aliases rep)
</span><a href="#local-6989586621684374659"><span class="hs-identifier hs-var">onRed</span></a></span><span> </span><span class="annot"><span class="annottext">[Reduce rep]
</span><a href="#local-6989586621684374662"><span class="hs-identifier hs-var">reds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-605"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AliasTable -&gt; Lambda rep -&gt; Lambda (Aliases rep)
forall rep.
(ASTRep rep, CanBeAliased (Op rep)) =&gt;
AliasTable -&gt; Lambda rep -&gt; Lambda (Aliases rep)
</span><a href="Futhark.Analysis.Alias.html#analyseLambda"><span class="hs-identifier hs-var">Alias.analyseLambda</span></a></span><span> </span><span class="annot"><span class="annottext">AliasTable
</span><a href="#local-6989586621684374666"><span class="hs-identifier hs-var">aliases</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684374661"><span class="hs-identifier hs-var">map_lam</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-606"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-607"></span><span>      </span><span id="local-6989586621684374659"><span class="annot"><span class="annottext">onRed :: Reduce rep -&gt; Reduce (Aliases rep)
</span><a href="#local-6989586621684374659"><span class="hs-identifier hs-var hs-var">onRed</span></a></span></span><span> </span><span id="local-6989586621684374658"><span class="annot"><span class="annottext">Reduce rep
</span><a href="#local-6989586621684374658"><span class="hs-identifier hs-var">red</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Reduce rep
</span><a href="#local-6989586621684374658"><span class="hs-identifier hs-var">red</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">redLambda :: Lambda (Aliases rep)
</span><a href="Futhark.IR.SOACS.SOAC.html#redLambda"><span class="hs-identifier hs-var">redLambda</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AliasTable -&gt; Lambda rep -&gt; Lambda (Aliases rep)
forall rep.
(ASTRep rep, CanBeAliased (Op rep)) =&gt;
AliasTable -&gt; Lambda rep -&gt; Lambda (Aliases rep)
</span><a href="Futhark.Analysis.Alias.html#analyseLambda"><span class="hs-identifier hs-var">Alias.analyseLambda</span></a></span><span> </span><span class="annot"><span class="annottext">AliasTable
</span><a href="#local-6989586621684374666"><span class="hs-identifier hs-var">aliases</span></a></span><span> </span><span class="annot"><span class="annottext">(Lambda rep -&gt; Lambda (Aliases rep))
-&gt; Lambda rep -&gt; Lambda (Aliases rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Reduce rep -&gt; Lambda rep
forall rep. Reduce rep -&gt; Lambda rep
</span><a href="Futhark.IR.SOACS.SOAC.html#redLambda"><span class="hs-identifier hs-var hs-var">redLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Reduce rep
</span><a href="#local-6989586621684374658"><span class="hs-identifier hs-var">red</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-608"></span><span>      </span><span id="local-6989586621684374660"><span class="annot"><span class="annottext">onScan :: Scan rep -&gt; Scan (Aliases rep)
</span><a href="#local-6989586621684374660"><span class="hs-identifier hs-var hs-var">onScan</span></a></span></span><span> </span><span id="local-6989586621684374657"><span class="annot"><span class="annottext">Scan rep
</span><a href="#local-6989586621684374657"><span class="hs-identifier hs-var">scan</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Scan rep
</span><a href="#local-6989586621684374657"><span class="hs-identifier hs-var">scan</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">scanLambda :: Lambda (Aliases rep)
</span><a href="Futhark.IR.SOACS.SOAC.html#scanLambda"><span class="hs-identifier hs-var">scanLambda</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AliasTable -&gt; Lambda rep -&gt; Lambda (Aliases rep)
forall rep.
(ASTRep rep, CanBeAliased (Op rep)) =&gt;
AliasTable -&gt; Lambda rep -&gt; Lambda (Aliases rep)
</span><a href="Futhark.Analysis.Alias.html#analyseLambda"><span class="hs-identifier hs-var">Alias.analyseLambda</span></a></span><span> </span><span class="annot"><span class="annottext">AliasTable
</span><a href="#local-6989586621684374666"><span class="hs-identifier hs-var">aliases</span></a></span><span> </span><span class="annot"><span class="annottext">(Lambda rep -&gt; Lambda (Aliases rep))
-&gt; Lambda rep -&gt; Lambda (Aliases rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Scan rep -&gt; Lambda rep
forall rep. Scan rep -&gt; Lambda rep
</span><a href="Futhark.IR.SOACS.SOAC.html#scanLambda"><span class="hs-identifier hs-var hs-var">scanLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Scan rep
</span><a href="#local-6989586621684374657"><span class="hs-identifier hs-var">scan</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-609"></span><span>
</span><span id="line-610"></span><span>  </span><span id="local-6989586621684374653"><span class="annot"><span class="annottext">removeOpAliases :: OpWithAliases (SOAC rep) -&gt; SOAC rep
</span><a href="Futhark.IR.Prop.Aliases.html#removeOpAliases"><span class="hs-identifier hs-var hs-var hs-var hs-var">removeOpAliases</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Identity (SOAC rep) -&gt; SOAC rep
forall a. Identity a -&gt; a
</span><span class="hs-identifier hs-var hs-var">runIdentity</span></span><span> </span><span class="annot"><span class="annottext">(Identity (SOAC rep) -&gt; SOAC rep)
-&gt; (SOAC (Aliases rep) -&gt; Identity (SOAC rep))
-&gt; SOAC (Aliases rep)
-&gt; SOAC rep
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SOACMapper (Aliases rep) rep Identity
-&gt; SOAC (Aliases rep) -&gt; Identity (SOAC rep)
forall (m :: * -&gt; *) frep trep.
(Applicative m, Monad m) =&gt;
SOACMapper frep trep m -&gt; SOAC frep -&gt; m (SOAC trep)
</span><a href="Futhark.IR.SOACS.SOAC.html#mapSOACM"><span class="hs-identifier hs-var">mapSOACM</span></a></span><span> </span><span class="annot"><span class="annottext">SOACMapper (Aliases rep) rep Identity
</span><a href="#local-6989586621684374651"><span class="hs-identifier hs-var">remove</span></a></span><span>
</span><span id="line-611"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-612"></span><span>      </span><span id="local-6989586621684374651"><span class="annot"><span class="annottext">remove :: SOACMapper (Aliases rep) rep Identity
</span><a href="#local-6989586621684374651"><span class="hs-identifier hs-var hs-var">remove</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; Identity SubExp)
-&gt; (Lambda (Aliases rep) -&gt; Identity (Lambda rep))
-&gt; (VName -&gt; Identity VName)
-&gt; SOACMapper (Aliases rep) rep Identity
forall frep trep (m :: * -&gt; *).
(SubExp -&gt; m SubExp)
-&gt; (Lambda frep -&gt; m (Lambda trep))
-&gt; (VName -&gt; m VName)
-&gt; SOACMapper frep trep m
</span><a href="Futhark.IR.SOACS.SOAC.html#SOACMapper"><span class="hs-identifier hs-var">SOACMapper</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Identity SubExp
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda rep -&gt; Identity (Lambda rep)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Lambda rep -&gt; Identity (Lambda rep))
-&gt; (Lambda (Aliases rep) -&gt; Lambda rep)
-&gt; Lambda (Aliases rep)
-&gt; Identity (Lambda rep)
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Lambda (Aliases rep) -&gt; Lambda rep
forall rep.
CanBeAliased (Op rep) =&gt;
Lambda (Aliases rep) -&gt; Lambda rep
</span><a href="Futhark.IR.Aliases.html#removeLambdaAliases"><span class="hs-identifier hs-var">removeLambdaAliases</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Identity VName
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span></span><span>
</span><span id="line-613"></span><span>
</span><span id="line-614"></span><span id="local-6989586621684376169"><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.html#ASTRep"><span class="hs-identifier hs-type">ASTRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376169"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.html#IsOp"><span class="hs-identifier hs-type">IsOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#SOAC"><span class="hs-identifier hs-type">SOAC</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376169"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-615"></span><span>  </span><span id="local-6989586621684374624"><span class="annot"><span class="annottext">safeOp :: SOAC rep -&gt; Bool
</span><a href="Futhark.IR.Prop.html#safeOp"><span class="hs-identifier hs-var hs-var hs-var hs-var">safeOp</span></a></span></span><span> </span><span class="annot"><span class="annottext">SOAC rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-616"></span><span>  </span><span id="local-6989586621684374622"><span class="annot"><span class="annottext">cheapOp :: SOAC rep -&gt; Bool
</span><a href="Futhark.IR.Prop.html#cheapOp"><span class="hs-identifier hs-var hs-var hs-var hs-var">cheapOp</span></a></span></span><span> </span><span class="annot"><span class="annottext">SOAC rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span></span><span>
</span><span id="line-617"></span><span>
</span><span id="line-618"></span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#substNamesInType"><span class="hs-identifier hs-type">substNamesInType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>
</span><span id="line-619"></span><span id="substNamesInType"><span class="annot"><span class="annottext">substNamesInType :: Map VName SubExp -&gt; Type -&gt; Type
</span><a href="Futhark.IR.SOACS.SOAC.html#substNamesInType"><span class="hs-identifier hs-var hs-var">substNamesInType</span></a></span></span><span> </span><span class="annot"><span class="annottext">Map VName SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684374620"><span class="annot"><span class="annottext">t :: Type
</span><a href="#local-6989586621684374620"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-type">Prim</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684374620"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-620"></span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#substNamesInType"><span class="hs-identifier hs-var">substNamesInType</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684374618"><span class="annot"><span class="annottext">t :: Type
</span><a href="#local-6989586621684374618"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Acc"><span class="hs-identifier hs-type">Acc</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684374618"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-621"></span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#substNamesInType"><span class="hs-identifier hs-var">substNamesInType</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Mem"><span class="hs-identifier hs-type">Mem</span></a></span><span> </span><span id="local-6989586621684374615"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684374615"><span class="hs-identifier hs-var">space</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Space -&gt; Type
forall shape u. Space -&gt; TypeBase shape u
</span><a href="Futhark.IR.Syntax.Core.html#Mem"><span class="hs-identifier hs-var">Mem</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684374615"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-622"></span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#substNamesInType"><span class="hs-identifier hs-var">substNamesInType</span></a></span><span> </span><span id="local-6989586621684374614"><span class="annot"><span class="annottext">Map VName SubExp
</span><a href="#local-6989586621684374614"><span class="hs-identifier hs-var">subs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span id="local-6989586621684374612"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684374612"><span class="hs-identifier hs-var">btp</span></a></span></span><span> </span><span id="local-6989586621684374611"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684374611"><span class="hs-identifier hs-var">shp</span></a></span></span><span> </span><span id="local-6989586621684374610"><span class="annot"><span class="annottext">NoUniqueness
</span><a href="#local-6989586621684374610"><span class="hs-identifier hs-var">u</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-623"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684374609"><span class="annot"><span class="annottext">shp' :: Shape
</span><a href="#local-6989586621684374609"><span class="hs-identifier hs-var hs-var">shp'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; Shape
forall d. [d] -&gt; ShapeBase d
</span><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-var">Shape</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; Shape) -&gt; [SubExp] -&gt; Shape
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; SubExp) -&gt; [SubExp] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName SubExp -&gt; SubExp -&gt; SubExp
</span><a href="Futhark.IR.SOACS.SOAC.html#substNamesInSubExp"><span class="hs-identifier hs-var">substNamesInSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SubExp
</span><a href="#local-6989586621684374614"><span class="hs-identifier hs-var">subs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Shape -&gt; [SubExp]
forall d. ShapeBase d -&gt; [d]
</span><a href="Futhark.IR.Syntax.Core.html#shapeDims"><span class="hs-identifier hs-var hs-var">shapeDims</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684374611"><span class="hs-identifier hs-var">shp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-624"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; Shape -&gt; NoUniqueness -&gt; Type
forall shape u. PrimType -&gt; shape -&gt; u -&gt; TypeBase shape u
</span><a href="Futhark.IR.Syntax.Core.html#Array"><span class="hs-identifier hs-var">Array</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684374612"><span class="hs-identifier hs-var">btp</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684374609"><span class="hs-identifier hs-var">shp'</span></a></span><span> </span><span class="annot"><span class="annottext">NoUniqueness
</span><a href="#local-6989586621684374610"><span class="hs-identifier hs-var">u</span></a></span><span>
</span><span id="line-625"></span><span>
</span><span id="line-626"></span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#substNamesInSubExp"><span class="hs-identifier hs-type">substNamesInSubExp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span>
</span><span id="line-627"></span><span id="substNamesInSubExp"><span class="annot"><span class="annottext">substNamesInSubExp :: Map VName SubExp -&gt; SubExp -&gt; SubExp
</span><a href="Futhark.IR.SOACS.SOAC.html#substNamesInSubExp"><span class="hs-identifier hs-var hs-var">substNamesInSubExp</span></a></span></span><span> </span><span class="annot"><span class="annottext">Map VName SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684374605"><span class="annot"><span class="annottext">e :: SubExp
</span><a href="#local-6989586621684374605"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span> </span><span class="annot"><span class="annottext">PrimValue
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684374605"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-628"></span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#substNamesInSubExp"><span class="hs-identifier hs-var">substNamesInSubExp</span></a></span><span> </span><span id="local-6989586621684374603"><span class="annot"><span class="annottext">Map VName SubExp
</span><a href="#local-6989586621684374603"><span class="hs-identifier hs-var">subs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684374602"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684374602"><span class="hs-identifier hs-var">idd</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-629"></span><span>  </span><span class="annot"><span class="annottext">SubExp -&gt; VName -&gt; Map VName SubExp -&gt; SubExp
forall k a. Ord k =&gt; a -&gt; k -&gt; Map k a -&gt; a
</span><span class="hs-identifier hs-var">M.findWithDefault</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684374602"><span class="hs-identifier hs-var">idd</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684374602"><span class="hs-identifier hs-var">idd</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SubExp
</span><a href="#local-6989586621684374603"><span class="hs-identifier hs-var">subs</span></a></span><span>
</span><span id="line-630"></span><span>
</span><span id="line-631"></span><span id="local-6989586621684376131"><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Prop.html#ASTRep"><span class="hs-identifier hs-type">ASTRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376131"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#CanBeWise"><span class="hs-identifier hs-type">CanBeWise</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376131"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#CanBeWise"><span class="hs-identifier hs-type">CanBeWise</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#SOAC"><span class="hs-identifier hs-type">SOAC</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376131"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-632"></span><span>  </span><span class="hs-keyword">type</span><span> </span><span id="OpWithWisdom"><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#OpWithWisdom"><span class="hs-identifier hs-var">OpWithWisdom</span></a></span></span><span> </span><span id="local-6989586621684376131"><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#SOAC"><span class="hs-identifier hs-type">SOAC</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376131"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#SOAC"><span class="hs-identifier hs-type">SOAC</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376131"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-633"></span><span>
</span><span id="line-634"></span><span>  </span><span id="local-6989586621684374570"><span class="annot"><span class="annottext">removeOpWisdom :: OpWithWisdom (SOAC rep) -&gt; SOAC rep
</span><a href="Futhark.Optimise.Simplify.Rep.html#removeOpWisdom"><span class="hs-identifier hs-var hs-var hs-var hs-var">removeOpWisdom</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Identity (SOAC rep) -&gt; SOAC rep
forall a. Identity a -&gt; a
</span><span class="hs-identifier hs-var hs-var">runIdentity</span></span><span> </span><span class="annot"><span class="annottext">(Identity (SOAC rep) -&gt; SOAC rep)
-&gt; (SOAC (Wise rep) -&gt; Identity (SOAC rep))
-&gt; SOAC (Wise rep)
-&gt; SOAC rep
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SOACMapper (Wise rep) rep Identity
-&gt; SOAC (Wise rep) -&gt; Identity (SOAC rep)
forall (m :: * -&gt; *) frep trep.
(Applicative m, Monad m) =&gt;
SOACMapper frep trep m -&gt; SOAC frep -&gt; m (SOAC trep)
</span><a href="Futhark.IR.SOACS.SOAC.html#mapSOACM"><span class="hs-identifier hs-var">mapSOACM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SubExp -&gt; Identity SubExp)
-&gt; (Lambda (Wise rep) -&gt; Identity (Lambda rep))
-&gt; (VName -&gt; Identity VName)
-&gt; SOACMapper (Wise rep) rep Identity
forall frep trep (m :: * -&gt; *).
(SubExp -&gt; m SubExp)
-&gt; (Lambda frep -&gt; m (Lambda trep))
-&gt; (VName -&gt; m VName)
-&gt; SOACMapper frep trep m
</span><a href="Futhark.IR.SOACS.SOAC.html#SOACMapper"><span class="hs-identifier hs-var">SOACMapper</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Identity SubExp
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda rep -&gt; Identity (Lambda rep)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Lambda rep -&gt; Identity (Lambda rep))
-&gt; (Lambda (Wise rep) -&gt; Lambda rep)
-&gt; Lambda (Wise rep)
-&gt; Identity (Lambda rep)
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Lambda (Wise rep) -&gt; Lambda rep
forall rep. CanBeWise (Op rep) =&gt; Lambda (Wise rep) -&gt; Lambda rep
</span><a href="Futhark.Optimise.Simplify.Rep.html#removeLambdaWisdom"><span class="hs-identifier hs-var">removeLambdaWisdom</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Identity VName
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span class="hs-special">)</span><span>
</span><span id="line-635"></span><span>  </span><span id="local-6989586621684374558"><span class="annot"><span class="annottext">addOpWisdom :: SOAC rep -&gt; OpWithWisdom (SOAC rep)
</span><a href="Futhark.Optimise.Simplify.Rep.html#addOpWisdom"><span class="hs-identifier hs-var hs-var hs-var hs-var">addOpWisdom</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Identity (SOAC (Wise rep)) -&gt; SOAC (Wise rep)
forall a. Identity a -&gt; a
</span><span class="hs-identifier hs-var hs-var">runIdentity</span></span><span> </span><span class="annot"><span class="annottext">(Identity (SOAC (Wise rep)) -&gt; SOAC (Wise rep))
-&gt; (SOAC rep -&gt; Identity (SOAC (Wise rep)))
-&gt; SOAC rep
-&gt; SOAC (Wise rep)
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SOACMapper rep (Wise rep) Identity
-&gt; SOAC rep -&gt; Identity (SOAC (Wise rep))
forall (m :: * -&gt; *) frep trep.
(Applicative m, Monad m) =&gt;
SOACMapper frep trep m -&gt; SOAC frep -&gt; m (SOAC trep)
</span><a href="Futhark.IR.SOACS.SOAC.html#mapSOACM"><span class="hs-identifier hs-var">mapSOACM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SubExp -&gt; Identity SubExp)
-&gt; (Lambda rep -&gt; Identity (Lambda (Wise rep)))
-&gt; (VName -&gt; Identity VName)
-&gt; SOACMapper rep (Wise rep) Identity
forall frep trep (m :: * -&gt; *).
(SubExp -&gt; m SubExp)
-&gt; (Lambda frep -&gt; m (Lambda trep))
-&gt; (VName -&gt; m VName)
-&gt; SOACMapper frep trep m
</span><a href="Futhark.IR.SOACS.SOAC.html#SOACMapper"><span class="hs-identifier hs-var">SOACMapper</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Identity SubExp
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda (Wise rep) -&gt; Identity (Lambda (Wise rep))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Lambda (Wise rep) -&gt; Identity (Lambda (Wise rep)))
-&gt; (Lambda rep -&gt; Lambda (Wise rep))
-&gt; Lambda rep
-&gt; Identity (Lambda (Wise rep))
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; Lambda (Wise rep)
forall rep. Informing rep =&gt; Lambda rep -&gt; Lambda (Wise rep)
</span><a href="Futhark.Optimise.Simplify.Rep.html#informLambda"><span class="hs-identifier hs-var">informLambda</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Identity VName
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span class="hs-special">)</span></span><span>
</span><span id="line-636"></span><span>
</span><span id="line-637"></span><span id="local-6989586621684376120"><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Futhark.IR.Rep.html#RepTypes"><span class="hs-identifier hs-type">RepTypes</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376120"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Analysis.SymbolTable.html#IndexOp"><span class="hs-identifier hs-type">ST.IndexOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#SOAC"><span class="hs-identifier hs-type">SOAC</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376120"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-638"></span><span>  </span><span id="local-6989586621684374508"><span class="annot"><span class="annottext">indexOp :: forall rep.
(ASTRep rep, IndexOp (Op rep)) =&gt;
SymbolTable rep
-&gt; Int -&gt; SOAC rep -&gt; [TPrimExp Int64 VName] -&gt; Maybe Indexed
</span><a href="Futhark.Analysis.SymbolTable.html#indexOp"><span class="hs-identifier hs-var hs-var hs-var hs-var">indexOp</span></a></span></span><span> </span><span id="local-6989586621684374506"><span class="annot"><span class="annottext">SymbolTable rep
</span><a href="#local-6989586621684374506"><span class="hs-identifier hs-var">vtable</span></a></span></span><span> </span><span id="local-6989586621684374505"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684374505"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span id="local-6989586621684374504"><span class="annot"><span class="annottext">SOAC rep
</span><a href="#local-6989586621684374504"><span class="hs-identifier hs-var">soac</span></a></span></span><span> </span><span class="hs-special">[</span><span id="local-6989586621684374503"><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684374503"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-639"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684374502"><span class="annot"><span class="annottext">LambdaT rep
</span><a href="#local-6989586621684374502"><span class="hs-identifier hs-var">lam</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684374501"><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684374501"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684374500"><span class="annot"><span class="annottext">[Param (LParamInfo rep)]
</span><a href="#local-6989586621684374500"><span class="hs-identifier hs-var">arr_params</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684374499"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684374499"><span class="hs-identifier hs-var">arrs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SOAC rep
-&gt; Maybe
     (LambdaT rep, SubExpRes, [Param (LParamInfo rep)], [VName])
</span><a href="#local-6989586621684374498"><span class="hs-identifier hs-var">lambdaAndSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">SOAC rep
</span><a href="#local-6989586621684374504"><span class="hs-identifier hs-var">soac</span></a></span><span>
</span><span id="line-640"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684374497"><span class="annot"><span class="annottext">arr_indexes :: Map VName (PrimExp VName, Certs)
</span><a href="#local-6989586621684374497"><span class="hs-identifier hs-var hs-var">arr_indexes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VName, (PrimExp VName, Certs))]
-&gt; Map VName (PrimExp VName, Certs)
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="annot"><span class="annottext">([(VName, (PrimExp VName, Certs))]
 -&gt; Map VName (PrimExp VName, Certs))
-&gt; [(VName, (PrimExp VName, Certs))]
-&gt; Map VName (PrimExp VName, Certs)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Maybe (VName, (PrimExp VName, Certs))]
-&gt; [(VName, (PrimExp VName, Certs))]
forall a. [Maybe a] -&gt; [a]
</span><span class="hs-identifier hs-var">catMaybes</span></span><span> </span><span class="annot"><span class="annottext">([Maybe (VName, (PrimExp VName, Certs))]
 -&gt; [(VName, (PrimExp VName, Certs))])
-&gt; [Maybe (VName, (PrimExp VName, Certs))]
-&gt; [(VName, (PrimExp VName, Certs))]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Param (LParamInfo rep)
 -&gt; VName -&gt; Maybe (VName, (PrimExp VName, Certs)))
-&gt; [Param (LParamInfo rep)]
-&gt; [VName]
-&gt; [Maybe (VName, (PrimExp VName, Certs))]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">Param (LParamInfo rep)
-&gt; VName -&gt; Maybe (VName, (PrimExp VName, Certs))
</span><a href="#local-6989586621684374495"><span class="hs-identifier hs-var">arrIndex</span></a></span><span> </span><span class="annot"><span class="annottext">[Param (LParamInfo rep)]
</span><a href="#local-6989586621684374500"><span class="hs-identifier hs-var">arr_params</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684374499"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-641"></span><span>        </span><span id="local-6989586621684374494"><span class="annot"><span class="annottext">arr_indexes' :: Map VName (PrimExp VName, Certs)
</span><a href="#local-6989586621684374494"><span class="hs-identifier hs-var hs-var">arr_indexes'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Map VName (PrimExp VName, Certs)
 -&gt; Stm rep -&gt; Map VName (PrimExp VName, Certs))
-&gt; Map VName (PrimExp VName, Certs)
-&gt; Seq (Stm rep)
-&gt; Map VName (PrimExp VName, Certs)
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl</span></span><span> </span><span class="annot"><span class="annottext">Map VName (PrimExp VName, Certs)
-&gt; Stm rep -&gt; Map VName (PrimExp VName, Certs)
</span><a href="#local-6989586621684374492"><span class="hs-identifier hs-var">expandPrimExpTable</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName (PrimExp VName, Certs)
</span><a href="#local-6989586621684374497"><span class="hs-identifier hs-var">arr_indexes</span></a></span><span> </span><span class="annot"><span class="annottext">(Seq (Stm rep) -&gt; Map VName (PrimExp VName, Certs))
-&gt; Seq (Stm rep) -&gt; Map VName (PrimExp VName, Certs)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BodyT rep -&gt; Seq (Stm rep)
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">(BodyT rep -&gt; Seq (Stm rep)) -&gt; BodyT rep -&gt; Seq (Stm rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LambdaT rep -&gt; BodyT rep
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT rep
</span><a href="#local-6989586621684374502"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-642"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684374501"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-643"></span><span>      </span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-type">SubExpRes</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684374490"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684374490"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(PrimExp VName -&gt; Certs -&gt; Indexed)
-&gt; (PrimExp VName, Certs) -&gt; Indexed
forall a b c. (a -&gt; b -&gt; c) -&gt; (a, b) -&gt; c
</span><span class="hs-identifier hs-var">uncurry</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Certs -&gt; PrimExp VName -&gt; Indexed)
-&gt; PrimExp VName -&gt; Certs -&gt; Indexed
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">Certs -&gt; PrimExp VName -&gt; Indexed
</span><a href="Futhark.Analysis.SymbolTable.html#Indexed"><span class="hs-identifier hs-var">ST.Indexed</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((PrimExp VName, Certs) -&gt; Indexed)
-&gt; Maybe (PrimExp VName, Certs) -&gt; Maybe Indexed
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">VName
-&gt; Map VName (PrimExp VName, Certs) -&gt; Maybe (PrimExp VName, Certs)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684374490"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName (PrimExp VName, Certs)
</span><a href="#local-6989586621684374494"><span class="hs-identifier hs-var">arr_indexes'</span></a></span><span>
</span><span id="line-644"></span><span>      </span><span class="annot"><span class="annottext">SubExpRes
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe Indexed
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-645"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-646"></span><span>      </span><span id="local-6989586621684374498"><span class="annot"><span class="annottext">lambdaAndSubExp :: SOAC rep
-&gt; Maybe
     (LambdaT rep, SubExpRes, [Param (LParamInfo rep)], [VName])
</span><a href="#local-6989586621684374498"><span class="hs-identifier hs-var hs-var">lambdaAndSubExp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Screma"><span class="hs-identifier hs-type">Screma</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684374486"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684374486"><span class="hs-identifier hs-var">arrs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#ScremaForm"><span class="hs-identifier hs-type">ScremaForm</span></a></span><span> </span><span id="local-6989586621684374485"><span class="annot"><span class="annottext">[Scan rep]
</span><a href="#local-6989586621684374485"><span class="hs-identifier hs-var">scans</span></a></span></span><span> </span><span id="local-6989586621684374484"><span class="annot"><span class="annottext">[Reduce rep]
</span><a href="#local-6989586621684374484"><span class="hs-identifier hs-var">reds</span></a></span></span><span> </span><span id="local-6989586621684374483"><span class="annot"><span class="annottext">LambdaT rep
</span><a href="#local-6989586621684374483"><span class="hs-identifier hs-var">map_lam</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-647"></span><span>        </span><span class="annot"><span class="annottext">Int
-&gt; LambdaT rep
-&gt; [VName]
-&gt; Maybe
     (LambdaT rep, SubExpRes, [Param (LParamInfo rep)], [VName])
</span><a href="#local-6989586621684374482"><span class="hs-identifier hs-var">nthMapOut</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Scan rep] -&gt; Int
forall rep. [Scan rep] -&gt; Int
</span><a href="Futhark.IR.SOACS.SOAC.html#scanResults"><span class="hs-identifier hs-var">scanResults</span></a></span><span> </span><span class="annot"><span class="annottext">[Scan rep]
</span><a href="#local-6989586621684374485"><span class="hs-identifier hs-var">scans</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">[Reduce rep] -&gt; Int
forall rep. [Reduce rep] -&gt; Int
</span><a href="Futhark.IR.SOACS.SOAC.html#redResults"><span class="hs-identifier hs-var">redResults</span></a></span><span> </span><span class="annot"><span class="annottext">[Reduce rep]
</span><a href="#local-6989586621684374484"><span class="hs-identifier hs-var">reds</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LambdaT rep
</span><a href="#local-6989586621684374483"><span class="hs-identifier hs-var">map_lam</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684374486"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-648"></span><span>      </span><span class="annot"><a href="#local-6989586621684374498"><span class="hs-identifier hs-var">lambdaAndSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">SOAC rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-649"></span><span>        </span><span class="annot"><span class="annottext">Maybe (LambdaT rep, SubExpRes, [Param (LParamInfo rep)], [VName])
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-650"></span><span>
</span><span id="line-651"></span><span>      </span><span id="local-6989586621684374482"><span class="annot"><span class="annottext">nthMapOut :: Int
-&gt; LambdaT rep
-&gt; [VName]
-&gt; Maybe
     (LambdaT rep, SubExpRes, [Param (LParamInfo rep)], [VName])
</span><a href="#local-6989586621684374482"><span class="hs-identifier hs-var hs-var">nthMapOut</span></a></span></span><span> </span><span id="local-6989586621684374481"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684374481"><span class="hs-identifier hs-var">num_accs</span></a></span></span><span> </span><span id="local-6989586621684374480"><span class="annot"><span class="annottext">LambdaT rep
</span><a href="#local-6989586621684374480"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span id="local-6989586621684374479"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684374479"><span class="hs-identifier hs-var">arrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-652"></span><span>        </span><span id="local-6989586621684374478"><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684374478"><span class="hs-identifier hs-var">se</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Result -&gt; Maybe SubExpRes
forall int a. Integral int =&gt; int -&gt; [a] -&gt; Maybe a
</span><a href="Futhark.Util.html#maybeNth"><span class="hs-identifier hs-var">maybeNth</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684374481"><span class="hs-identifier hs-var">num_accs</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684374505"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Result -&gt; Maybe SubExpRes) -&gt; Result -&gt; Maybe SubExpRes
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BodyT rep -&gt; Result
forall rep. BodyT rep -&gt; Result
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var hs-var">bodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">(BodyT rep -&gt; Result) -&gt; BodyT rep -&gt; Result
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LambdaT rep -&gt; BodyT rep
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT rep
</span><a href="#local-6989586621684374480"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-653"></span><span>        </span><span class="annot"><span class="annottext">(LambdaT rep, SubExpRes, [Param (LParamInfo rep)], [VName])
-&gt; Maybe
     (LambdaT rep, SubExpRes, [Param (LParamInfo rep)], [VName])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LambdaT rep
</span><a href="#local-6989586621684374480"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684374478"><span class="hs-identifier hs-var">se</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Param (LParamInfo rep)] -&gt; [Param (LParamInfo rep)]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684374481"><span class="hs-identifier hs-var">num_accs</span></a></span><span> </span><span class="annot"><span class="annottext">([Param (LParamInfo rep)] -&gt; [Param (LParamInfo rep)])
-&gt; [Param (LParamInfo rep)] -&gt; [Param (LParamInfo rep)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LambdaT rep -&gt; [Param (LParamInfo rep)]
forall {rep}. LambdaT rep -&gt; [Param (LParamInfo rep)]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT rep
</span><a href="#local-6989586621684374480"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684374479"><span class="hs-identifier hs-var">arrs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-654"></span><span>
</span><span id="line-655"></span><span>      </span><span id="local-6989586621684374495"><span class="annot"><span class="annottext">arrIndex :: Param (LParamInfo rep)
-&gt; VName -&gt; Maybe (VName, (PrimExp VName, Certs))
</span><a href="#local-6989586621684374495"><span class="hs-identifier hs-var hs-var">arrIndex</span></a></span></span><span> </span><span id="local-6989586621684374477"><span class="annot"><span class="annottext">Param (LParamInfo rep)
</span><a href="#local-6989586621684374477"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621684374476"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684374476"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-656"></span><span>        </span><span class="annot"><a href="Futhark.Analysis.SymbolTable.html#Indexed"><span class="hs-identifier hs-type">ST.Indexed</span></a></span><span> </span><span id="local-6989586621684374475"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684374475"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span id="local-6989586621684374474"><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684374474"><span class="hs-identifier hs-var">pe</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; [TPrimExp Int64 VName] -&gt; SymbolTable rep -&gt; Maybe Indexed
forall rep.
VName -&gt; [TPrimExp Int64 VName] -&gt; SymbolTable rep -&gt; Maybe Indexed
</span><a href="Futhark.Analysis.SymbolTable.html#index%27"><span class="hs-identifier hs-var">ST.index'</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684374476"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684374503"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">SymbolTable rep
</span><a href="#local-6989586621684374506"><span class="hs-identifier hs-var">vtable</span></a></span><span>
</span><span id="line-657"></span><span>        </span><span class="annot"><span class="annottext">(VName, (PrimExp VName, Certs))
-&gt; Maybe (VName, (PrimExp VName, Certs))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param (LParamInfo rep) -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param (LParamInfo rep)
</span><a href="#local-6989586621684374477"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684374474"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684374475"><span class="hs-identifier hs-var">cs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-658"></span><span>
</span><span id="line-659"></span><span>      </span><span id="local-6989586621684374492"><span class="annot"><span class="annottext">expandPrimExpTable :: Map VName (PrimExp VName, Certs)
-&gt; Stm rep -&gt; Map VName (PrimExp VName, Certs)
</span><a href="#local-6989586621684374492"><span class="hs-identifier hs-var hs-var">expandPrimExpTable</span></a></span></span><span> </span><span id="local-6989586621684374472"><span class="annot"><span class="annottext">Map VName (PrimExp VName, Certs)
</span><a href="#local-6989586621684374472"><span class="hs-identifier hs-var">table</span></a></span></span><span> </span><span id="local-6989586621684374471"><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684374471"><span class="hs-identifier hs-var">stm</span></a></span></span><span>
</span><span id="line-660"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">[</span><span id="local-6989586621684374470"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684374470"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PatT (LetDec rep) -&gt; [VName]
forall dec. PatT dec -&gt; [VName]
</span><a href="Futhark.IR.Prop.Patterns.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="annot"><span class="annottext">(PatT (LetDec rep) -&gt; [VName]) -&gt; PatT (LetDec rep) -&gt; [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; PatT (LetDec rep)
forall rep. Stm rep -&gt; Pat rep
</span><a href="Futhark.IR.Syntax.html#stmPat"><span class="hs-identifier hs-var hs-var">stmPat</span></a></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684374471"><span class="hs-identifier hs-var">stm</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-661"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684374467"><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684374467"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684374466"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684374466"><span class="hs-identifier hs-var">cs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-662"></span><span>            </span><span class="annot"><span class="annottext">WriterT Certs Maybe (PrimExp VName) -&gt; Maybe (PrimExp VName, Certs)
forall w (m :: * -&gt; *) a. WriterT w m a -&gt; m (a, w)
</span><span class="hs-identifier hs-var hs-var">runWriterT</span></span><span> </span><span class="annot"><span class="annottext">(WriterT Certs Maybe (PrimExp VName)
 -&gt; Maybe (PrimExp VName, Certs))
-&gt; WriterT Certs Maybe (PrimExp VName)
-&gt; Maybe (PrimExp VName, Certs)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; WriterT Certs Maybe (PrimExp VName))
-&gt; Exp rep -&gt; WriterT Certs Maybe (PrimExp VName)
forall (m :: * -&gt; *) rep v.
(MonadFail m, RepTypes rep) =&gt;
(VName -&gt; m (PrimExp v)) -&gt; Exp rep -&gt; m (PrimExp v)
</span><a href="Futhark.Analysis.PrimExp.Convert.html#primExpFromExp"><span class="hs-identifier hs-var">primExpFromExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName (PrimExp VName, Certs)
-&gt; VName -&gt; WriterT Certs Maybe (PrimExp VName)
</span><a href="#local-6989586621684374463"><span class="hs-identifier hs-var">asPrimExp</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName (PrimExp VName, Certs)
</span><a href="#local-6989586621684374472"><span class="hs-identifier hs-var">table</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Exp rep -&gt; WriterT Certs Maybe (PrimExp VName))
-&gt; Exp rep -&gt; WriterT Certs Maybe (PrimExp VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; Exp rep
forall rep. Stm rep -&gt; Exp rep
</span><a href="Futhark.IR.Syntax.html#stmExp"><span class="hs-identifier hs-var hs-var">stmExp</span></a></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684374471"><span class="hs-identifier hs-var">stm</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-663"></span><span>          </span><span class="annot"><span class="annottext">(VName -&gt; Bool) -&gt; [VName] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SymbolTable rep -&gt; Bool
forall rep. VName -&gt; SymbolTable rep -&gt; Bool
</span><a href="Futhark.Analysis.SymbolTable.html#elem"><span class="hs-operator hs-var">`ST.elem`</span></a></span><span> </span><span class="annot"><span class="annottext">SymbolTable rep
</span><a href="#local-6989586621684374506"><span class="hs-identifier hs-var">vtable</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Certs -&gt; [VName]
</span><a href="Futhark.IR.Syntax.Core.html#unCerts"><span class="hs-identifier hs-var hs-var">unCerts</span></a></span><span> </span><span class="annot"><span class="annottext">(Certs -&gt; [VName]) -&gt; Certs -&gt; [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; Certs
forall rep. Stm rep -&gt; Certs
</span><a href="Futhark.IR.Prop.html#stmCerts"><span class="hs-identifier hs-var">stmCerts</span></a></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684374471"><span class="hs-identifier hs-var">stm</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-664"></span><span>          </span><span class="annot"><span class="annottext">VName
-&gt; (PrimExp VName, Certs)
-&gt; Map VName (PrimExp VName, Certs)
-&gt; Map VName (PrimExp VName, Certs)
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684374470"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684374467"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; Certs
forall rep. Stm rep -&gt; Certs
</span><a href="Futhark.IR.Prop.html#stmCerts"><span class="hs-identifier hs-var">stmCerts</span></a></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684374471"><span class="hs-identifier hs-var">stm</span></a></span><span> </span><span class="annot"><span class="annottext">Certs -&gt; Certs -&gt; Certs
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684374466"><span class="hs-identifier hs-var">cs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map VName (PrimExp VName, Certs)
</span><a href="#local-6989586621684374472"><span class="hs-identifier hs-var">table</span></a></span><span>
</span><span id="line-665"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-666"></span><span>          </span><span class="annot"><span class="annottext">Map VName (PrimExp VName, Certs)
</span><a href="#local-6989586621684374472"><span class="hs-identifier hs-var">table</span></a></span><span>
</span><span id="line-667"></span><span>
</span><span id="line-668"></span><span>      </span><span id="local-6989586621684374463"><span class="annot"><span class="annottext">asPrimExp :: Map VName (PrimExp VName, Certs)
-&gt; VName -&gt; WriterT Certs Maybe (PrimExp VName)
</span><a href="#local-6989586621684374463"><span class="hs-identifier hs-var hs-var">asPrimExp</span></a></span></span><span> </span><span id="local-6989586621684374456"><span class="annot"><span class="annottext">Map VName (PrimExp VName, Certs)
</span><a href="#local-6989586621684374456"><span class="hs-identifier hs-var">table</span></a></span></span><span> </span><span id="local-6989586621684374455"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684374455"><span class="hs-identifier hs-var">v</span></a></span></span><span>
</span><span id="line-669"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684374454"><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684374454"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684374453"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684374453"><span class="hs-identifier hs-var">cs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName
-&gt; Map VName (PrimExp VName, Certs) -&gt; Maybe (PrimExp VName, Certs)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684374455"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName (PrimExp VName, Certs)
</span><a href="#local-6989586621684374456"><span class="hs-identifier hs-var">table</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Certs -&gt; WriterT Certs Maybe ()
forall w (m :: * -&gt; *). MonadWriter w m =&gt; w -&gt; m ()
</span><span class="hs-identifier hs-var">tell</span></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684374453"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">WriterT Certs Maybe ()
-&gt; WriterT Certs Maybe (PrimExp VName)
-&gt; WriterT Certs Maybe (PrimExp VName)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">PrimExp VName -&gt; WriterT Certs Maybe (PrimExp VName)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684374454"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-670"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-type">Prim</span></a></span><span> </span><span id="local-6989586621684374451"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684374451"><span class="hs-identifier hs-var">pt</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; SymbolTable rep -&gt; Maybe Type
forall rep. ASTRep rep =&gt; VName -&gt; SymbolTable rep -&gt; Maybe Type
</span><a href="Futhark.Analysis.SymbolTable.html#lookupType"><span class="hs-identifier hs-var">ST.lookupType</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684374455"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">SymbolTable rep
</span><a href="#local-6989586621684374506"><span class="hs-identifier hs-var">vtable</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-671"></span><span>          </span><span class="annot"><span class="annottext">PrimExp VName -&gt; WriterT Certs Maybe (PrimExp VName)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(PrimExp VName -&gt; WriterT Certs Maybe (PrimExp VName))
-&gt; PrimExp VName -&gt; WriterT Certs Maybe (PrimExp VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; PrimExp VName
forall v. v -&gt; PrimType -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#LeafExp"><span class="hs-identifier hs-var">LeafExp</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684374455"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684374451"><span class="hs-identifier hs-var">pt</span></a></span><span>
</span><span id="line-672"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (PrimExp VName) -&gt; WriterT Certs Maybe (PrimExp VName)
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">Maybe (PrimExp VName)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-673"></span><span>  </span><span class="annot"><a href="Futhark.Analysis.SymbolTable.html#indexOp"><span class="hs-identifier hs-var">indexOp</span></a></span><span> </span><span class="annot"><span class="annottext">SymbolTable rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SOAC rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Indexed
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span></span><span>
</span><span id="line-674"></span><span>
</span><span id="line-675"></span><span class="hs-comment">-- | Type-check a SOAC.</span><span>
</span><span id="line-676"></span><span id="local-6989586621684376070"><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#typeCheckSOAC"><span class="hs-identifier hs-type">typeCheckSOAC</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.TypeCheck.html#Checkable"><span class="hs-identifier hs-type">TC.Checkable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376070"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#SOAC"><span class="hs-identifier hs-type">SOAC</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Aliases.html#Aliases"><span class="hs-identifier hs-type">Aliases</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376070"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.TypeCheck.html#TypeM"><span class="hs-identifier hs-type">TC.TypeM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376070"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-677"></span><span id="typeCheckSOAC"><span class="annot"><span class="annottext">typeCheckSOAC :: forall rep. Checkable rep =&gt; SOAC (Aliases rep) -&gt; TypeM rep ()
</span><a href="Futhark.IR.SOACS.SOAC.html#typeCheckSOAC"><span class="hs-identifier hs-var hs-var">typeCheckSOAC</span></a></span></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#JVP"><span class="hs-identifier hs-type">JVP</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; TypeM rep ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-678"></span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#typeCheckSOAC"><span class="hs-identifier hs-var">typeCheckSOAC</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#VJP"><span class="hs-identifier hs-type">VJP</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; TypeM rep ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-679"></span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#typeCheckSOAC"><span class="hs-identifier hs-var">typeCheckSOAC</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621684374252"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684374252"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span id="local-6989586621684374251"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684374251"><span class="hs-identifier hs-var">arrexps</span></a></span></span><span> </span><span id="local-6989586621684374250"><span class="annot"><span class="annottext">StreamForm (Aliases rep)
</span><a href="#local-6989586621684374250"><span class="hs-identifier hs-var">form</span></a></span></span><span> </span><span id="local-6989586621684374249"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684374249"><span class="hs-identifier hs-var">accexps</span></a></span></span><span> </span><span id="local-6989586621684374248"><span class="annot"><span class="annottext">Lambda (Aliases rep)
</span><a href="#local-6989586621684374248"><span class="hs-identifier hs-var">lam</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-680"></span><span>  </span><span class="annot"><span class="annottext">[Type] -&gt; SubExp -&gt; TypeM rep ()
forall rep. Checkable rep =&gt; [Type] -&gt; SubExp -&gt; TypeM rep ()
</span><a href="Futhark.IR.TypeCheck.html#require"><span class="hs-identifier hs-var">TC.require</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">PrimType -&gt; Type
forall shape u. PrimType -&gt; TypeBase shape u
</span><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int64"><span class="hs-identifier hs-var">int64</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684374252"><span class="hs-identifier hs-var">size</span></a></span><span>
</span><span id="line-681"></span><span>  </span><span id="local-6989586621684374245"><span class="annot"><span class="annottext">[Arg]
</span><a href="#local-6989586621684374245"><span class="hs-identifier hs-var">accargs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TypeM rep Arg) -&gt; [SubExp] -&gt; TypeM rep [Arg]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TypeM rep Arg
forall rep. Checkable rep =&gt; SubExp -&gt; TypeM rep Arg
</span><a href="Futhark.IR.TypeCheck.html#checkArg"><span class="hs-identifier hs-var">TC.checkArg</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684374249"><span class="hs-identifier hs-var">accexps</span></a></span><span>
</span><span id="line-682"></span><span>  </span><span id="local-6989586621684374243"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684374243"><span class="hs-identifier hs-var">arrargs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; TypeM rep Type) -&gt; [VName] -&gt; TypeM rep [Type]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TypeM rep Type
forall rep (m :: * -&gt; *). HasScope rep m =&gt; VName -&gt; m Type
</span><a href="Futhark.IR.Prop.Scope.html#lookupType"><span class="hs-identifier hs-var">lookupType</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684374251"><span class="hs-identifier hs-var">arrexps</span></a></span><span>
</span><span id="line-683"></span><span>  </span><span class="annot"><span class="annottext">[Arg]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; [VName] -&gt; TypeM rep [Arg]
forall rep. Checkable rep =&gt; SubExp -&gt; [VName] -&gt; TypeM rep [Arg]
</span><a href="Futhark.IR.TypeCheck.html#checkSOACArrayArgs"><span class="hs-identifier hs-var">TC.checkSOACArrayArgs</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684374252"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684374251"><span class="hs-identifier hs-var">arrexps</span></a></span><span>
</span><span id="line-684"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684374240"><span class="annot"><span class="annottext">chunk :: Param (LParamInfo rep)
</span><a href="#local-6989586621684374240"><span class="hs-identifier hs-var hs-var">chunk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Param (LParamInfo rep)] -&gt; Param (LParamInfo rep)
forall a. [a] -&gt; a
</span><span class="hs-identifier hs-var">head</span></span><span> </span><span class="annot"><span class="annottext">([Param (LParamInfo rep)] -&gt; Param (LParamInfo rep))
-&gt; [Param (LParamInfo rep)] -&gt; Param (LParamInfo rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda (Aliases rep) -&gt; [LParam (Aliases rep)]
forall {rep}. LambdaT rep -&gt; [Param (LParamInfo rep)]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda (Aliases rep)
</span><a href="#local-6989586621684374248"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-685"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684374236"><span class="annot"><span class="annottext">asArg :: a -&gt; (a, b)
</span><a href="#local-6989586621684374236"><span class="hs-identifier hs-var hs-var">asArg</span></a></span></span><span> </span><span id="local-6989586621684374235"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684374235"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684374235"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span>
</span><span id="line-686"></span><span>      </span><span id="local-6989586621684374234"><span class="annot"><span class="annottext">inttp :: TypeBase shape u
</span><a href="#local-6989586621684374234"><span class="hs-identifier hs-var hs-var">inttp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; TypeBase shape u
forall shape u. PrimType -&gt; TypeBase shape u
</span><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int64"><span class="hs-identifier hs-var">int64</span></a></span><span>
</span><span id="line-687"></span><span>      </span><span id="local-6989586621684374233"><span class="annot"><span class="annottext">lamarrs' :: [Type]
</span><a href="#local-6989586621684374233"><span class="hs-identifier hs-var hs-var">lamarrs'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Type) -&gt; [Type] -&gt; [Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; SubExp -&gt; Type
forall d u.
ArrayShape (ShapeBase d) =&gt;
TypeBase (ShapeBase d) u -&gt; d -&gt; TypeBase (ShapeBase d) u
</span><a href="Futhark.IR.Prop.Types.html#setOuterSize"><span class="hs-operator hs-var">`setOuterSize`</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param (LParamInfo rep) -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param (LParamInfo rep)
</span><a href="#local-6989586621684374240"><span class="hs-identifier hs-var">chunk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684374243"><span class="hs-identifier hs-var">arrargs</span></a></span><span>
</span><span id="line-688"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684374231"><span class="annot"><span class="annottext">acc_len :: Int
</span><a href="#local-6989586621684374231"><span class="hs-identifier hs-var hs-var">acc_len</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684374249"><span class="hs-identifier hs-var">accexps</span></a></span><span>
</span><span id="line-689"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684374230"><span class="annot"><span class="annottext">lamrtp :: [Type]
</span><a href="#local-6989586621684374230"><span class="hs-identifier hs-var hs-var">lamrtp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Type] -&gt; [Type]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">take</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684374231"><span class="hs-identifier hs-var">acc_len</span></a></span><span> </span><span class="annot"><span class="annottext">([Type] -&gt; [Type]) -&gt; [Type] -&gt; [Type]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda (Aliases rep) -&gt; [Type]
forall rep. LambdaT rep -&gt; [Type]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda (Aliases rep)
</span><a href="#local-6989586621684374248"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-690"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; TypeM rep () -&gt; TypeM rep ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Arg -&gt; Type) -&gt; [Arg] -&gt; [Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Arg -&gt; Type
</span><a href="Futhark.IR.TypeCheck.html#argType"><span class="hs-identifier hs-var">TC.argType</span></a></span><span> </span><span class="annot"><span class="annottext">[Arg]
</span><a href="#local-6989586621684374245"><span class="hs-identifier hs-var">accargs</span></a></span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; [Type] -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684374230"><span class="hs-identifier hs-var">lamrtp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TypeM rep () -&gt; TypeM rep ()) -&gt; TypeM rep () -&gt; TypeM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-691"></span><span>    </span><span class="annot"><span class="annottext">ErrorCase rep -&gt; TypeM rep ()
forall rep a. ErrorCase rep -&gt; TypeM rep a
</span><a href="Futhark.IR.TypeCheck.html#bad"><span class="hs-identifier hs-var">TC.bad</span></a></span><span> </span><span class="annot"><span class="annottext">(ErrorCase rep -&gt; TypeM rep ()) -&gt; ErrorCase rep -&gt; TypeM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ErrorCase rep
forall rep. String -&gt; ErrorCase rep
</span><a href="Futhark.IR.TypeCheck.html#TypeError"><span class="hs-identifier hs-var">TC.TypeError</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Stream with inconsistent accumulator type in lambda.&quot;</span></span><span>
</span><span id="line-692"></span><span>  </span><span class="hs-comment">-- check reduce's lambda, if any</span><span>
</span><span id="line-693"></span><span>  </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">StreamForm (Aliases rep)
</span><a href="#local-6989586621684374250"><span class="hs-identifier hs-var">form</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-694"></span><span>    </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Parallel"><span class="hs-identifier hs-type">Parallel</span></a></span><span> </span><span class="annot"><span class="annottext">StreamOrd
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Commutativity
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684374225"><span class="annot"><span class="annottext">Lambda (Aliases rep)
</span><a href="#local-6989586621684374225"><span class="hs-identifier hs-var">lam0</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-695"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684374224"><span class="annot"><span class="annottext">acct :: [Type]
</span><a href="#local-6989586621684374224"><span class="hs-identifier hs-var hs-var">acct</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Arg -&gt; Type) -&gt; [Arg] -&gt; [Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Arg -&gt; Type
</span><a href="Futhark.IR.TypeCheck.html#argType"><span class="hs-identifier hs-var">TC.argType</span></a></span><span> </span><span class="annot"><span class="annottext">[Arg]
</span><a href="#local-6989586621684374245"><span class="hs-identifier hs-var">accargs</span></a></span><span>
</span><span id="line-696"></span><span>          </span><span id="local-6989586621684374223"><span class="annot"><span class="annottext">outerRetType :: [Type]
</span><a href="#local-6989586621684374223"><span class="hs-identifier hs-var hs-var">outerRetType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Lambda (Aliases rep) -&gt; [Type]
forall rep. LambdaT rep -&gt; [Type]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda (Aliases rep)
</span><a href="#local-6989586621684374225"><span class="hs-identifier hs-var">lam0</span></a></span><span>
</span><span id="line-697"></span><span>      </span><span class="annot"><span class="annottext">Lambda (Aliases rep) -&gt; [Arg] -&gt; TypeM rep ()
forall rep.
Checkable rep =&gt;
Lambda (Aliases rep) -&gt; [Arg] -&gt; TypeM rep ()
</span><a href="Futhark.IR.TypeCheck.html#checkLambda"><span class="hs-identifier hs-var">TC.checkLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda (Aliases rep)
</span><a href="#local-6989586621684374225"><span class="hs-identifier hs-var">lam0</span></a></span><span> </span><span class="annot"><span class="annottext">([Arg] -&gt; TypeM rep ()) -&gt; [Arg] -&gt; TypeM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Arg -&gt; Arg) -&gt; [Arg] -&gt; [Arg]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Arg -&gt; Arg
</span><a href="Futhark.IR.TypeCheck.html#noArgAliases"><span class="hs-identifier hs-var">TC.noArgAliases</span></a></span><span> </span><span class="annot"><span class="annottext">([Arg] -&gt; [Arg]) -&gt; [Arg] -&gt; [Arg]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Arg]
</span><a href="#local-6989586621684374245"><span class="hs-identifier hs-var">accargs</span></a></span><span> </span><span class="annot"><span class="annottext">[Arg] -&gt; [Arg] -&gt; [Arg]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Arg]
</span><a href="#local-6989586621684374245"><span class="hs-identifier hs-var">accargs</span></a></span><span>
</span><span id="line-698"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; TypeM rep () -&gt; TypeM rep ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684374224"><span class="hs-identifier hs-var">acct</span></a></span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; [Type] -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684374223"><span class="hs-identifier hs-var">outerRetType</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TypeM rep () -&gt; TypeM rep ()) -&gt; TypeM rep () -&gt; TypeM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-699"></span><span>        </span><span class="annot"><span class="annottext">ErrorCase rep -&gt; TypeM rep ()
forall rep a. ErrorCase rep -&gt; TypeM rep a
</span><a href="Futhark.IR.TypeCheck.html#bad"><span class="hs-identifier hs-var">TC.bad</span></a></span><span> </span><span class="annot"><span class="annottext">(ErrorCase rep -&gt; TypeM rep ()) -&gt; ErrorCase rep -&gt; TypeM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-700"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; ErrorCase rep
forall rep. String -&gt; ErrorCase rep
</span><a href="Futhark.IR.TypeCheck.html#TypeError"><span class="hs-identifier hs-var">TC.TypeError</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; ErrorCase rep) -&gt; String -&gt; ErrorCase rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-701"></span><span>            </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Initial value is of type &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; String
forall a. Pretty a =&gt; [a] -&gt; String
</span><a href="Futhark.Util.Pretty.html#prettyTuple"><span class="hs-identifier hs-var">prettyTuple</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684374224"><span class="hs-identifier hs-var">acct</span></a></span><span>
</span><span id="line-702"></span><span>              </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;, but stream's reduce lambda returns type &quot;</span></span><span>
</span><span id="line-703"></span><span>              </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; String
forall a. Pretty a =&gt; [a] -&gt; String
</span><a href="Futhark.Util.Pretty.html#prettyTuple"><span class="hs-identifier hs-var">prettyTuple</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684374223"><span class="hs-identifier hs-var">outerRetType</span></a></span><span>
</span><span id="line-704"></span><span>              </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;.&quot;</span></span><span>
</span><span id="line-705"></span><span>    </span><span class="annot"><span class="annottext">StreamForm (Aliases rep)
</span><a href="Futhark.IR.SOACS.SOAC.html#Sequential"><span class="hs-identifier hs-var">Sequential</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; TypeM rep ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-706"></span><span>  </span><span class="hs-comment">-- just get the dflow of lambda on the fakearg, which does not alias</span><span>
</span><span id="line-707"></span><span>  </span><span class="hs-comment">-- arr, so we can later check that aliases of arr are not used inside lam.</span><span>
</span><span id="line-708"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684374219"><span class="annot"><span class="annottext">fake_lamarrs' :: [Arg]
</span><a href="#local-6989586621684374219"><span class="hs-identifier hs-var hs-var">fake_lamarrs'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Arg) -&gt; [Type] -&gt; [Arg]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Arg
forall {b} {a}. Monoid b =&gt; a -&gt; (a, b)
</span><a href="#local-6989586621684374236"><span class="hs-identifier hs-var">asArg</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684374233"><span class="hs-identifier hs-var">lamarrs'</span></a></span><span>
</span><span id="line-709"></span><span>  </span><span class="annot"><span class="annottext">Lambda (Aliases rep) -&gt; [Arg] -&gt; TypeM rep ()
forall rep.
Checkable rep =&gt;
Lambda (Aliases rep) -&gt; [Arg] -&gt; TypeM rep ()
</span><a href="Futhark.IR.TypeCheck.html#checkLambda"><span class="hs-identifier hs-var">TC.checkLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda (Aliases rep)
</span><a href="#local-6989586621684374248"><span class="hs-identifier hs-var">lam</span></a></span><span> </span><span class="annot"><span class="annottext">([Arg] -&gt; TypeM rep ()) -&gt; [Arg] -&gt; TypeM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Arg
forall {b} {a}. Monoid b =&gt; a -&gt; (a, b)
</span><a href="#local-6989586621684374236"><span class="hs-identifier hs-var">asArg</span></a></span><span> </span><span class="annot"><span class="annottext">Type
forall {shape} {u}. TypeBase shape u
</span><a href="#local-6989586621684374234"><span class="hs-identifier hs-var">inttp</span></a></span><span> </span><span class="annot"><span class="annottext">Arg -&gt; [Arg] -&gt; [Arg]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Arg]
</span><a href="#local-6989586621684374245"><span class="hs-identifier hs-var">accargs</span></a></span><span> </span><span class="annot"><span class="annottext">[Arg] -&gt; [Arg] -&gt; [Arg]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Arg]
</span><a href="#local-6989586621684374219"><span class="hs-identifier hs-var">fake_lamarrs'</span></a></span><span>
</span><span id="line-710"></span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#typeCheckSOAC"><span class="hs-identifier hs-var">typeCheckSOAC</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Scatter"><span class="hs-identifier hs-type">Scatter</span></a></span><span> </span><span id="local-6989586621684374218"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684374218"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684374217"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684374217"><span class="hs-identifier hs-var">arrs</span></a></span></span><span> </span><span id="local-6989586621684374216"><span class="annot"><span class="annottext">Lambda (Aliases rep)
</span><a href="#local-6989586621684374216"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span id="local-6989586621684374215"><span class="annot"><span class="annottext">[(Shape, Int, VName)]
</span><a href="#local-6989586621684374215"><span class="hs-keyword hs-var">as</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-711"></span><span>  </span><span class="hs-comment">-- Requirements:</span><span>
</span><span id="line-712"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-713"></span><span>  </span><span class="hs-comment">--   0. @lambdaReturnType@ of @lam@ must be a list</span><span>
</span><span id="line-714"></span><span>  </span><span class="hs-comment">--      [index types..., value types, ...].</span><span>
</span><span id="line-715"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-716"></span><span>  </span><span class="hs-comment">--   1. The number of index types and value types must be equal to the number</span><span>
</span><span id="line-717"></span><span>  </span><span class="hs-comment">--      of return values from @lam@.</span><span>
</span><span id="line-718"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-719"></span><span>  </span><span class="hs-comment">--   2. Each index type must have the type i64.</span><span>
</span><span id="line-720"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-721"></span><span>  </span><span class="hs-comment">--   3. Each array in @as@ and the value types must have the same type</span><span>
</span><span id="line-722"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-723"></span><span>  </span><span class="hs-comment">--   4. Each array in @as@ is consumed.  This is not really a check, but more</span><span>
</span><span id="line-724"></span><span>  </span><span class="hs-comment">--      of a requirement, so that e.g. the source is not hoisted out of a</span><span>
</span><span id="line-725"></span><span>  </span><span class="hs-comment">--      loop, which will mean it cannot be consumed.</span><span>
</span><span id="line-726"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-727"></span><span>  </span><span class="hs-comment">--   5. Each of arrs must be an array matching a corresponding lambda</span><span>
</span><span id="line-728"></span><span>  </span><span class="hs-comment">--      parameters.</span><span>
</span><span id="line-729"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-730"></span><span>  </span><span class="hs-comment">-- Code:</span><span>
</span><span id="line-731"></span><span>
</span><span id="line-732"></span><span>  </span><span class="hs-comment">-- First check the input size.</span><span>
</span><span id="line-733"></span><span>  </span><span class="annot"><span class="annottext">[Type] -&gt; SubExp -&gt; TypeM rep ()
forall rep. Checkable rep =&gt; [Type] -&gt; SubExp -&gt; TypeM rep ()
</span><a href="Futhark.IR.TypeCheck.html#require"><span class="hs-identifier hs-var">TC.require</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">PrimType -&gt; Type
forall shape u. PrimType -&gt; TypeBase shape u
</span><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int64"><span class="hs-identifier hs-var">int64</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684374218"><span class="hs-identifier hs-var">w</span></a></span><span>
</span><span id="line-734"></span><span>
</span><span id="line-735"></span><span>  </span><span class="hs-comment">-- 0.</span><span>
</span><span id="line-736"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684374214"><span class="annot"><span class="annottext">[Shape]
</span><a href="#local-6989586621684374214"><span class="hs-identifier hs-var">as_ws</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684374213"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684374213"><span class="hs-identifier hs-var">as_ns</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684374212"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684374212"><span class="hs-identifier hs-var">_as_vs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Shape, Int, VName)] -&gt; ([Shape], [Int], [VName])
forall a b c. [(a, b, c)] -&gt; ([a], [b], [c])
</span><span class="hs-identifier hs-var">unzip3</span></span><span> </span><span class="annot"><span class="annottext">[(Shape, Int, VName)]
</span><a href="#local-6989586621684374215"><span class="hs-keyword hs-var">as</span></a></span><span>
</span><span id="line-737"></span><span>      </span><span id="local-6989586621684374211"><span class="annot"><span class="annottext">indexes :: Int
</span><a href="#local-6989586621684374211"><span class="hs-identifier hs-var hs-var">indexes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; Int
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">sum</span></span><span> </span><span class="annot"><span class="annottext">([Int] -&gt; Int) -&gt; [Int] -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Int -&gt; Int) -&gt; [Int] -&gt; [Int] -&gt; [Int]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">(*)</span></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684374213"><span class="hs-identifier hs-var">as_ns</span></a></span><span> </span><span class="annot"><span class="annottext">([Int] -&gt; [Int]) -&gt; [Int] -&gt; [Int]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Shape -&gt; Int) -&gt; [Shape] -&gt; [Int]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Shape -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Shape]
</span><a href="#local-6989586621684374214"><span class="hs-identifier hs-var">as_ws</span></a></span><span>
</span><span id="line-738"></span><span>      </span><span id="local-6989586621684374210"><span class="annot"><span class="annottext">rts :: [Type]
</span><a href="#local-6989586621684374210"><span class="hs-identifier hs-var hs-var">rts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Lambda (Aliases rep) -&gt; [Type]
forall rep. LambdaT rep -&gt; [Type]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda (Aliases rep)
</span><a href="#local-6989586621684374216"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-739"></span><span>      </span><span id="local-6989586621684374209"><span class="annot"><span class="annottext">rtsI :: [Type]
</span><a href="#local-6989586621684374209"><span class="hs-identifier hs-var hs-var">rtsI</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Type] -&gt; [Type]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">take</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684374211"><span class="hs-identifier hs-var">indexes</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684374210"><span class="hs-identifier hs-var">rts</span></a></span><span>
</span><span id="line-740"></span><span>      </span><span id="local-6989586621684374208"><span class="annot"><span class="annottext">rtsV :: [Type]
</span><a href="#local-6989586621684374208"><span class="hs-identifier hs-var hs-var">rtsV</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Type] -&gt; [Type]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684374211"><span class="hs-identifier hs-var">indexes</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684374210"><span class="hs-identifier hs-var">rts</span></a></span><span>
</span><span id="line-741"></span><span>
</span><span id="line-742"></span><span>  </span><span class="hs-comment">-- 1.</span><span>
</span><span id="line-743"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; TypeM rep () -&gt; TypeM rep ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Type] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684374210"><span class="hs-identifier hs-var">rts</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; Int
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">sum</span></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684374213"><span class="hs-identifier hs-var">as_ns</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; Int
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">sum</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Int -&gt; Int -&gt; Int) -&gt; [Int] -&gt; [Int] -&gt; [Int]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">(*)</span></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684374213"><span class="hs-identifier hs-var">as_ns</span></a></span><span> </span><span class="annot"><span class="annottext">([Int] -&gt; [Int]) -&gt; [Int] -&gt; [Int]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Shape -&gt; Int) -&gt; [Shape] -&gt; [Int]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Shape -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Shape]
</span><a href="#local-6989586621684374214"><span class="hs-identifier hs-var">as_ws</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TypeM rep () -&gt; TypeM rep ()) -&gt; TypeM rep () -&gt; TypeM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-744"></span><span>    </span><span class="annot"><span class="annottext">ErrorCase rep -&gt; TypeM rep ()
forall rep a. ErrorCase rep -&gt; TypeM rep a
</span><a href="Futhark.IR.TypeCheck.html#bad"><span class="hs-identifier hs-var">TC.bad</span></a></span><span> </span><span class="annot"><span class="annottext">(ErrorCase rep -&gt; TypeM rep ()) -&gt; ErrorCase rep -&gt; TypeM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ErrorCase rep
forall rep. String -&gt; ErrorCase rep
</span><a href="Futhark.IR.TypeCheck.html#TypeError"><span class="hs-identifier hs-var">TC.TypeError</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Scatter: number of index types, value types and array outputs do not match.&quot;</span></span><span>
</span><span id="line-745"></span><span>
</span><span id="line-746"></span><span>  </span><span class="hs-comment">-- 2.</span><span>
</span><span id="line-747"></span><span>  </span><span class="annot"><span class="annottext">[Type] -&gt; (Type -&gt; TypeM rep ()) -&gt; TypeM rep ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684374209"><span class="hs-identifier hs-var">rtsI</span></a></span><span> </span><span class="annot"><span class="annottext">((Type -&gt; TypeM rep ()) -&gt; TypeM rep ())
-&gt; (Type -&gt; TypeM rep ()) -&gt; TypeM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684374206"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684374206"><span class="hs-identifier hs-var">rtI</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-748"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; TypeM rep () -&gt; TypeM rep ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimType -&gt; Type
forall shape u. PrimType -&gt; TypeBase shape u
</span><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int64"><span class="hs-identifier hs-var">int64</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684374206"><span class="hs-identifier hs-var">rtI</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TypeM rep () -&gt; TypeM rep ()) -&gt; TypeM rep () -&gt; TypeM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-749"></span><span>      </span><span class="annot"><span class="annottext">ErrorCase rep -&gt; TypeM rep ()
forall rep a. ErrorCase rep -&gt; TypeM rep a
</span><a href="Futhark.IR.TypeCheck.html#bad"><span class="hs-identifier hs-var">TC.bad</span></a></span><span> </span><span class="annot"><span class="annottext">(ErrorCase rep -&gt; TypeM rep ()) -&gt; ErrorCase rep -&gt; TypeM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ErrorCase rep
forall rep. String -&gt; ErrorCase rep
</span><a href="Futhark.IR.TypeCheck.html#TypeError"><span class="hs-identifier hs-var">TC.TypeError</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Scatter: Index return type must be i64.&quot;</span></span><span>
</span><span id="line-750"></span><span>
</span><span id="line-751"></span><span>  </span><span class="annot"><span class="annottext">[([Type], (Shape, Int, VName))]
-&gt; (([Type], (Shape, Int, VName)) -&gt; TypeM rep ()) -&gt; TypeM rep ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[[Type]]
-&gt; [(Shape, Int, VName)] -&gt; [([Type], (Shape, Int, VName))]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Int] -&gt; [Type] -&gt; [[Type]]
forall a. [Int] -&gt; [a] -&gt; [[a]]
</span><a href="Futhark.Util.html#chunks"><span class="hs-identifier hs-var">chunks</span></a></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684374213"><span class="hs-identifier hs-var">as_ns</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684374208"><span class="hs-identifier hs-var">rtsV</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Shape, Int, VName)]
</span><a href="#local-6989586621684374215"><span class="hs-keyword hs-var">as</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((([Type], (Shape, Int, VName)) -&gt; TypeM rep ()) -&gt; TypeM rep ())
-&gt; (([Type], (Shape, Int, VName)) -&gt; TypeM rep ()) -&gt; TypeM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684374205"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684374205"><span class="hs-identifier hs-var">rtVs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684374204"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684374204"><span class="hs-identifier hs-var">aw</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684374203"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684374203"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-752"></span><span>    </span><span class="hs-comment">-- All lengths must have type i64.</span><span>
</span><span id="line-753"></span><span>    </span><span class="annot"><span class="annottext">(SubExp -&gt; TypeM rep ()) -&gt; Shape -&gt; TypeM rep ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Type] -&gt; SubExp -&gt; TypeM rep ()
forall rep. Checkable rep =&gt; [Type] -&gt; SubExp -&gt; TypeM rep ()
</span><a href="Futhark.IR.TypeCheck.html#require"><span class="hs-identifier hs-var">TC.require</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">PrimType -&gt; Type
forall shape u. PrimType -&gt; TypeBase shape u
</span><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int64"><span class="hs-identifier hs-var">int64</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684374204"><span class="hs-identifier hs-var">aw</span></a></span><span>
</span><span id="line-754"></span><span>
</span><span id="line-755"></span><span>    </span><span class="hs-comment">-- 3.</span><span>
</span><span id="line-756"></span><span>    </span><span class="annot"><span class="annottext">[Type] -&gt; (Type -&gt; TypeM rep ()) -&gt; TypeM rep ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684374205"><span class="hs-identifier hs-var">rtVs</span></a></span><span> </span><span class="annot"><span class="annottext">((Type -&gt; TypeM rep ()) -&gt; TypeM rep ())
-&gt; (Type -&gt; TypeM rep ()) -&gt; TypeM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684374201"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684374201"><span class="hs-identifier hs-var">rtV</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; VName -&gt; TypeM rep ()
forall rep. Checkable rep =&gt; [Type] -&gt; VName -&gt; TypeM rep ()
</span><a href="Futhark.IR.TypeCheck.html#requireI"><span class="hs-identifier hs-var">TC.requireI</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type -&gt; Shape -&gt; Type
</span><a href="Futhark.IR.Prop.Types.html#arrayOfShape"><span class="hs-identifier hs-var">arrayOfShape</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684374201"><span class="hs-identifier hs-var">rtV</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684374204"><span class="hs-identifier hs-var">aw</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684374203"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-757"></span><span>
</span><span id="line-758"></span><span>    </span><span class="hs-comment">-- 4.</span><span>
</span><span id="line-759"></span><span>    </span><span class="annot"><span class="annottext">Names -&gt; TypeM rep ()
forall rep. Checkable rep =&gt; Names -&gt; TypeM rep ()
</span><a href="Futhark.IR.TypeCheck.html#consume"><span class="hs-identifier hs-var">TC.consume</span></a></span><span> </span><span class="annot"><span class="annottext">(Names -&gt; TypeM rep ()) -&gt; TypeM rep Names -&gt; TypeM rep ()
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TypeM rep Names
forall rep. Checkable rep =&gt; VName -&gt; TypeM rep Names
</span><a href="Futhark.IR.TypeCheck.html#lookupAliases"><span class="hs-identifier hs-var">TC.lookupAliases</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684374203"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-760"></span><span>
</span><span id="line-761"></span><span>  </span><span class="hs-comment">-- 5.</span><span>
</span><span id="line-762"></span><span>  </span><span id="local-6989586621684374196"><span class="annot"><span class="annottext">[Arg]
</span><a href="#local-6989586621684374196"><span class="hs-identifier hs-var">arrargs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; [VName] -&gt; TypeM rep [Arg]
forall rep. Checkable rep =&gt; SubExp -&gt; [VName] -&gt; TypeM rep [Arg]
</span><a href="Futhark.IR.TypeCheck.html#checkSOACArrayArgs"><span class="hs-identifier hs-var">TC.checkSOACArrayArgs</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684374218"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684374217"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-763"></span><span>  </span><span class="annot"><span class="annottext">Lambda (Aliases rep) -&gt; [Arg] -&gt; TypeM rep ()
forall rep.
Checkable rep =&gt;
Lambda (Aliases rep) -&gt; [Arg] -&gt; TypeM rep ()
</span><a href="Futhark.IR.TypeCheck.html#checkLambda"><span class="hs-identifier hs-var">TC.checkLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda (Aliases rep)
</span><a href="#local-6989586621684374216"><span class="hs-identifier hs-var">lam</span></a></span><span> </span><span class="annot"><span class="annottext">[Arg]
</span><a href="#local-6989586621684374196"><span class="hs-identifier hs-var">arrargs</span></a></span><span>
</span><span id="line-764"></span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#typeCheckSOAC"><span class="hs-identifier hs-var">typeCheckSOAC</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Hist"><span class="hs-identifier hs-type">Hist</span></a></span><span> </span><span id="local-6989586621684374195"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684374195"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684374194"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684374194"><span class="hs-identifier hs-var">arrs</span></a></span></span><span> </span><span id="local-6989586621684374193"><span class="annot"><span class="annottext">[HistOp (Aliases rep)]
</span><a href="#local-6989586621684374193"><span class="hs-identifier hs-var">ops</span></a></span></span><span> </span><span id="local-6989586621684374192"><span class="annot"><span class="annottext">Lambda (Aliases rep)
</span><a href="#local-6989586621684374192"><span class="hs-identifier hs-var">bucket_fun</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-765"></span><span>  </span><span class="annot"><span class="annottext">[Type] -&gt; SubExp -&gt; TypeM rep ()
forall rep. Checkable rep =&gt; [Type] -&gt; SubExp -&gt; TypeM rep ()
</span><a href="Futhark.IR.TypeCheck.html#require"><span class="hs-identifier hs-var">TC.require</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">PrimType -&gt; Type
forall shape u. PrimType -&gt; TypeBase shape u
</span><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int64"><span class="hs-identifier hs-var">int64</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684374195"><span class="hs-identifier hs-var">w</span></a></span><span>
</span><span id="line-766"></span><span>
</span><span id="line-767"></span><span>  </span><span class="hs-comment">-- Check the operators.</span><span>
</span><span id="line-768"></span><span>  </span><span class="annot"><span class="annottext">[HistOp (Aliases rep)]
-&gt; (HistOp (Aliases rep) -&gt; TypeM rep ()) -&gt; TypeM rep ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="annot"><span class="annottext">[HistOp (Aliases rep)]
</span><a href="#local-6989586621684374193"><span class="hs-identifier hs-var">ops</span></a></span><span> </span><span class="annot"><span class="annottext">((HistOp (Aliases rep) -&gt; TypeM rep ()) -&gt; TypeM rep ())
-&gt; (HistOp (Aliases rep) -&gt; TypeM rep ()) -&gt; TypeM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#HistOp"><span class="hs-identifier hs-type">HistOp</span></a></span><span> </span><span id="local-6989586621684374191"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684374191"><span class="hs-identifier hs-var">dest_shape</span></a></span></span><span> </span><span id="local-6989586621684374190"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684374190"><span class="hs-identifier hs-var">rf</span></a></span></span><span> </span><span id="local-6989586621684374189"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684374189"><span class="hs-identifier hs-var">dests</span></a></span></span><span> </span><span id="local-6989586621684374188"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684374188"><span class="hs-identifier hs-var">nes</span></a></span></span><span> </span><span id="local-6989586621684374187"><span class="annot"><span class="annottext">Lambda (Aliases rep)
</span><a href="#local-6989586621684374187"><span class="hs-identifier hs-var">op</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-769"></span><span>    </span><span id="local-6989586621684374186"><span class="annot"><span class="annottext">[Arg]
</span><a href="#local-6989586621684374186"><span class="hs-identifier hs-var">nes'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TypeM rep Arg) -&gt; [SubExp] -&gt; TypeM rep [Arg]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TypeM rep Arg
forall rep. Checkable rep =&gt; SubExp -&gt; TypeM rep Arg
</span><a href="Futhark.IR.TypeCheck.html#checkArg"><span class="hs-identifier hs-var">TC.checkArg</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684374188"><span class="hs-identifier hs-var">nes</span></a></span><span>
</span><span id="line-770"></span><span>    </span><span class="annot"><span class="annottext">(SubExp -&gt; TypeM rep ()) -&gt; Shape -&gt; TypeM rep ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Type] -&gt; SubExp -&gt; TypeM rep ()
forall rep. Checkable rep =&gt; [Type] -&gt; SubExp -&gt; TypeM rep ()
</span><a href="Futhark.IR.TypeCheck.html#require"><span class="hs-identifier hs-var">TC.require</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">PrimType -&gt; Type
forall shape u. PrimType -&gt; TypeBase shape u
</span><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int64"><span class="hs-identifier hs-var">int64</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684374191"><span class="hs-identifier hs-var">dest_shape</span></a></span><span>
</span><span id="line-771"></span><span>    </span><span class="annot"><span class="annottext">[Type] -&gt; SubExp -&gt; TypeM rep ()
forall rep. Checkable rep =&gt; [Type] -&gt; SubExp -&gt; TypeM rep ()
</span><a href="Futhark.IR.TypeCheck.html#require"><span class="hs-identifier hs-var">TC.require</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">PrimType -&gt; Type
forall shape u. PrimType -&gt; TypeBase shape u
</span><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int64"><span class="hs-identifier hs-var">int64</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684374190"><span class="hs-identifier hs-var">rf</span></a></span><span>
</span><span id="line-772"></span><span>
</span><span id="line-773"></span><span>    </span><span class="hs-comment">-- Operator type must match the type of neutral elements.</span><span>
</span><span id="line-774"></span><span>    </span><span class="annot"><span class="annottext">Lambda (Aliases rep) -&gt; [Arg] -&gt; TypeM rep ()
forall rep.
Checkable rep =&gt;
Lambda (Aliases rep) -&gt; [Arg] -&gt; TypeM rep ()
</span><a href="Futhark.IR.TypeCheck.html#checkLambda"><span class="hs-identifier hs-var">TC.checkLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda (Aliases rep)
</span><a href="#local-6989586621684374187"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="annot"><span class="annottext">([Arg] -&gt; TypeM rep ()) -&gt; [Arg] -&gt; TypeM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Arg -&gt; Arg) -&gt; [Arg] -&gt; [Arg]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Arg -&gt; Arg
</span><a href="Futhark.IR.TypeCheck.html#noArgAliases"><span class="hs-identifier hs-var">TC.noArgAliases</span></a></span><span> </span><span class="annot"><span class="annottext">([Arg] -&gt; [Arg]) -&gt; [Arg] -&gt; [Arg]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Arg]
</span><a href="#local-6989586621684374186"><span class="hs-identifier hs-var">nes'</span></a></span><span> </span><span class="annot"><span class="annottext">[Arg] -&gt; [Arg] -&gt; [Arg]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Arg]
</span><a href="#local-6989586621684374186"><span class="hs-identifier hs-var">nes'</span></a></span><span>
</span><span id="line-775"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684374185"><span class="annot"><span class="annottext">nes_t :: [Type]
</span><a href="#local-6989586621684374185"><span class="hs-identifier hs-var hs-var">nes_t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Arg -&gt; Type) -&gt; [Arg] -&gt; [Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Arg -&gt; Type
</span><a href="Futhark.IR.TypeCheck.html#argType"><span class="hs-identifier hs-var">TC.argType</span></a></span><span> </span><span class="annot"><span class="annottext">[Arg]
</span><a href="#local-6989586621684374186"><span class="hs-identifier hs-var">nes'</span></a></span><span>
</span><span id="line-776"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; TypeM rep () -&gt; TypeM rep ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684374185"><span class="hs-identifier hs-var">nes_t</span></a></span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; [Type] -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Lambda (Aliases rep) -&gt; [Type]
forall rep. LambdaT rep -&gt; [Type]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda (Aliases rep)
</span><a href="#local-6989586621684374187"><span class="hs-identifier hs-var">op</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TypeM rep () -&gt; TypeM rep ()) -&gt; TypeM rep () -&gt; TypeM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-777"></span><span>      </span><span class="annot"><span class="annottext">ErrorCase rep -&gt; TypeM rep ()
forall rep a. ErrorCase rep -&gt; TypeM rep a
</span><a href="Futhark.IR.TypeCheck.html#bad"><span class="hs-identifier hs-var">TC.bad</span></a></span><span> </span><span class="annot"><span class="annottext">(ErrorCase rep -&gt; TypeM rep ()) -&gt; ErrorCase rep -&gt; TypeM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-778"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; ErrorCase rep
forall rep. String -&gt; ErrorCase rep
</span><a href="Futhark.IR.TypeCheck.html#TypeError"><span class="hs-identifier hs-var">TC.TypeError</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; ErrorCase rep) -&gt; String -&gt; ErrorCase rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-779"></span><span>          </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Operator has return type &quot;</span></span><span>
</span><span id="line-780"></span><span>            </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; String
forall a. Pretty a =&gt; [a] -&gt; String
</span><a href="Futhark.Util.Pretty.html#prettyTuple"><span class="hs-identifier hs-var">prettyTuple</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda (Aliases rep) -&gt; [Type]
forall rep. LambdaT rep -&gt; [Type]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda (Aliases rep)
</span><a href="#local-6989586621684374187"><span class="hs-identifier hs-var">op</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-781"></span><span>            </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; but neutral element has type &quot;</span></span><span>
</span><span id="line-782"></span><span>            </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; String
forall a. Pretty a =&gt; [a] -&gt; String
</span><a href="Futhark.Util.Pretty.html#prettyTuple"><span class="hs-identifier hs-var">prettyTuple</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684374185"><span class="hs-identifier hs-var">nes_t</span></a></span><span>
</span><span id="line-783"></span><span>
</span><span id="line-784"></span><span>    </span><span class="hs-comment">-- Arrays must have proper type.</span><span>
</span><span id="line-785"></span><span>    </span><span class="annot"><span class="annottext">[(Type, VName)] -&gt; ((Type, VName) -&gt; TypeM rep ()) -&gt; TypeM rep ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Type] -&gt; [VName] -&gt; [(Type, VName)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684374185"><span class="hs-identifier hs-var">nes_t</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684374189"><span class="hs-identifier hs-var">dests</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Type, VName) -&gt; TypeM rep ()) -&gt; TypeM rep ())
-&gt; ((Type, VName) -&gt; TypeM rep ()) -&gt; TypeM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684374184"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684374184"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684374183"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684374183"><span class="hs-identifier hs-var">dest</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-786"></span><span>      </span><span class="annot"><span class="annottext">[Type] -&gt; VName -&gt; TypeM rep ()
forall rep. Checkable rep =&gt; [Type] -&gt; VName -&gt; TypeM rep ()
</span><a href="Futhark.IR.TypeCheck.html#requireI"><span class="hs-identifier hs-var">TC.requireI</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684374184"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Shape -&gt; Type
</span><a href="Futhark.IR.Prop.Types.html#arrayOfShape"><span class="hs-operator hs-var">`arrayOfShape`</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684374191"><span class="hs-identifier hs-var">dest_shape</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684374183"><span class="hs-identifier hs-var">dest</span></a></span><span>
</span><span id="line-787"></span><span>      </span><span class="annot"><span class="annottext">Names -&gt; TypeM rep ()
forall rep. Checkable rep =&gt; Names -&gt; TypeM rep ()
</span><a href="Futhark.IR.TypeCheck.html#consume"><span class="hs-identifier hs-var">TC.consume</span></a></span><span> </span><span class="annot"><span class="annottext">(Names -&gt; TypeM rep ()) -&gt; TypeM rep Names -&gt; TypeM rep ()
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TypeM rep Names
forall rep. Checkable rep =&gt; VName -&gt; TypeM rep Names
</span><a href="Futhark.IR.TypeCheck.html#lookupAliases"><span class="hs-identifier hs-var">TC.lookupAliases</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684374183"><span class="hs-identifier hs-var">dest</span></a></span><span>
</span><span id="line-788"></span><span>
</span><span id="line-789"></span><span>  </span><span class="hs-comment">-- Types of input arrays must equal parameter types for bucket function.</span><span>
</span><span id="line-790"></span><span>  </span><span id="local-6989586621684374182"><span class="annot"><span class="annottext">[Arg]
</span><a href="#local-6989586621684374182"><span class="hs-identifier hs-var">img'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; [VName] -&gt; TypeM rep [Arg]
forall rep. Checkable rep =&gt; SubExp -&gt; [VName] -&gt; TypeM rep [Arg]
</span><a href="Futhark.IR.TypeCheck.html#checkSOACArrayArgs"><span class="hs-identifier hs-var">TC.checkSOACArrayArgs</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684374195"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684374194"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-791"></span><span>  </span><span class="annot"><span class="annottext">Lambda (Aliases rep) -&gt; [Arg] -&gt; TypeM rep ()
forall rep.
Checkable rep =&gt;
Lambda (Aliases rep) -&gt; [Arg] -&gt; TypeM rep ()
</span><a href="Futhark.IR.TypeCheck.html#checkLambda"><span class="hs-identifier hs-var">TC.checkLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda (Aliases rep)
</span><a href="#local-6989586621684374192"><span class="hs-identifier hs-var">bucket_fun</span></a></span><span> </span><span class="annot"><span class="annottext">[Arg]
</span><a href="#local-6989586621684374182"><span class="hs-identifier hs-var">img'</span></a></span><span>
</span><span id="line-792"></span><span>
</span><span id="line-793"></span><span>  </span><span class="hs-comment">-- Return type of bucket function must be an index for each</span><span>
</span><span id="line-794"></span><span>  </span><span class="hs-comment">-- operation followed by the values to write.</span><span>
</span><span id="line-795"></span><span>  </span><span id="local-6989586621684374181"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684374181"><span class="hs-identifier hs-var">nes_ts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[[Type]] -&gt; [Type]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span> </span><span class="annot"><span class="annottext">([[Type]] -&gt; [Type]) -&gt; TypeM rep [[Type]] -&gt; TypeM rep [Type]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(HistOp (Aliases rep) -&gt; TypeM rep [Type])
-&gt; [HistOp (Aliases rep)] -&gt; TypeM rep [[Type]]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SubExp -&gt; TypeM rep Type) -&gt; [SubExp] -&gt; TypeM rep [Type]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TypeM rep Type
forall t (m :: * -&gt; *). HasScope t m =&gt; SubExp -&gt; m Type
</span><a href="Futhark.IR.Prop.TypeOf.html#subExpType"><span class="hs-identifier hs-var">subExpType</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; TypeM rep [Type])
-&gt; (HistOp (Aliases rep) -&gt; [SubExp])
-&gt; HistOp (Aliases rep)
-&gt; TypeM rep [Type]
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">HistOp (Aliases rep) -&gt; [SubExp]
forall rep. HistOp rep -&gt; [SubExp]
</span><a href="Futhark.IR.SOACS.SOAC.html#histNeutral"><span class="hs-identifier hs-var hs-var">histNeutral</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[HistOp (Aliases rep)]
</span><a href="#local-6989586621684374193"><span class="hs-identifier hs-var">ops</span></a></span><span>
</span><span id="line-796"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684374179"><span class="annot"><span class="annottext">bucket_ret_t :: [Type]
</span><a href="#local-6989586621684374179"><span class="hs-identifier hs-var hs-var">bucket_ret_t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-797"></span><span>        </span><span class="annot"><span class="annottext">(HistOp (Aliases rep) -&gt; [Type])
-&gt; [HistOp (Aliases rep)] -&gt; [Type]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Type -&gt; [Type]
forall a. Int -&gt; a -&gt; [a]
</span><span class="hs-operator hs-var">`replicate`</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; Type
forall shape u. PrimType -&gt; TypeBase shape u
</span><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int64"><span class="hs-identifier hs-var">int64</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Int -&gt; [Type])
-&gt; (HistOp (Aliases rep) -&gt; Int) -&gt; HistOp (Aliases rep) -&gt; [Type]
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Shape -&gt; Int
forall a. ArrayShape a =&gt; a -&gt; Int
</span><a href="Futhark.IR.Syntax.Core.html#shapeRank"><span class="hs-identifier hs-var">shapeRank</span></a></span><span> </span><span class="annot"><span class="annottext">(Shape -&gt; Int)
-&gt; (HistOp (Aliases rep) -&gt; Shape) -&gt; HistOp (Aliases rep) -&gt; Int
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">HistOp (Aliases rep) -&gt; Shape
forall rep. HistOp rep -&gt; Shape
</span><a href="Futhark.IR.SOACS.SOAC.html#histShape"><span class="hs-identifier hs-var hs-var">histShape</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[HistOp (Aliases rep)]
</span><a href="#local-6989586621684374193"><span class="hs-identifier hs-var">ops</span></a></span><span>
</span><span id="line-798"></span><span>          </span><span class="annot"><span class="annottext">[Type] -&gt; [Type] -&gt; [Type]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684374181"><span class="hs-identifier hs-var">nes_ts</span></a></span><span>
</span><span id="line-799"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; TypeM rep () -&gt; TypeM rep ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684374179"><span class="hs-identifier hs-var">bucket_ret_t</span></a></span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; [Type] -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Lambda (Aliases rep) -&gt; [Type]
forall rep. LambdaT rep -&gt; [Type]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda (Aliases rep)
</span><a href="#local-6989586621684374192"><span class="hs-identifier hs-var">bucket_fun</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TypeM rep () -&gt; TypeM rep ()) -&gt; TypeM rep () -&gt; TypeM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-800"></span><span>    </span><span class="annot"><span class="annottext">ErrorCase rep -&gt; TypeM rep ()
forall rep a. ErrorCase rep -&gt; TypeM rep a
</span><a href="Futhark.IR.TypeCheck.html#bad"><span class="hs-identifier hs-var">TC.bad</span></a></span><span> </span><span class="annot"><span class="annottext">(ErrorCase rep -&gt; TypeM rep ()) -&gt; ErrorCase rep -&gt; TypeM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-801"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; ErrorCase rep
forall rep. String -&gt; ErrorCase rep
</span><a href="Futhark.IR.TypeCheck.html#TypeError"><span class="hs-identifier hs-var">TC.TypeError</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; ErrorCase rep) -&gt; String -&gt; ErrorCase rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-802"></span><span>        </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Bucket function has return type &quot;</span></span><span>
</span><span id="line-803"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; String
forall a. Pretty a =&gt; [a] -&gt; String
</span><a href="Futhark.Util.Pretty.html#prettyTuple"><span class="hs-identifier hs-var">prettyTuple</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda (Aliases rep) -&gt; [Type]
forall rep. LambdaT rep -&gt; [Type]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda (Aliases rep)
</span><a href="#local-6989586621684374192"><span class="hs-identifier hs-var">bucket_fun</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-804"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; but should have type &quot;</span></span><span>
</span><span id="line-805"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; String
forall a. Pretty a =&gt; [a] -&gt; String
</span><a href="Futhark.Util.Pretty.html#prettyTuple"><span class="hs-identifier hs-var">prettyTuple</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684374179"><span class="hs-identifier hs-var">bucket_ret_t</span></a></span><span>
</span><span id="line-806"></span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#typeCheckSOAC"><span class="hs-identifier hs-var">typeCheckSOAC</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Screma"><span class="hs-identifier hs-type">Screma</span></a></span><span> </span><span id="local-6989586621684374177"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684374177"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684374176"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684374176"><span class="hs-identifier hs-var">arrs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#ScremaForm"><span class="hs-identifier hs-type">ScremaForm</span></a></span><span> </span><span id="local-6989586621684374175"><span class="annot"><span class="annottext">[Scan (Aliases rep)]
</span><a href="#local-6989586621684374175"><span class="hs-identifier hs-var">scans</span></a></span></span><span> </span><span id="local-6989586621684374174"><span class="annot"><span class="annottext">[Reduce (Aliases rep)]
</span><a href="#local-6989586621684374174"><span class="hs-identifier hs-var">reds</span></a></span></span><span> </span><span id="local-6989586621684374173"><span class="annot"><span class="annottext">Lambda (Aliases rep)
</span><a href="#local-6989586621684374173"><span class="hs-identifier hs-var">map_lam</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-807"></span><span>  </span><span class="annot"><span class="annottext">[Type] -&gt; SubExp -&gt; TypeM rep ()
forall rep. Checkable rep =&gt; [Type] -&gt; SubExp -&gt; TypeM rep ()
</span><a href="Futhark.IR.TypeCheck.html#require"><span class="hs-identifier hs-var">TC.require</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">PrimType -&gt; Type
forall shape u. PrimType -&gt; TypeBase shape u
</span><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int64"><span class="hs-identifier hs-var">int64</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684374177"><span class="hs-identifier hs-var">w</span></a></span><span>
</span><span id="line-808"></span><span>  </span><span id="local-6989586621684374172"><span class="annot"><span class="annottext">[Arg]
</span><a href="#local-6989586621684374172"><span class="hs-identifier hs-var">arrs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; [VName] -&gt; TypeM rep [Arg]
forall rep. Checkable rep =&gt; SubExp -&gt; [VName] -&gt; TypeM rep [Arg]
</span><a href="Futhark.IR.TypeCheck.html#checkSOACArrayArgs"><span class="hs-identifier hs-var">TC.checkSOACArrayArgs</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684374177"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684374176"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-809"></span><span>  </span><span class="annot"><span class="annottext">Lambda (Aliases rep) -&gt; [Arg] -&gt; TypeM rep ()
forall rep.
Checkable rep =&gt;
Lambda (Aliases rep) -&gt; [Arg] -&gt; TypeM rep ()
</span><a href="Futhark.IR.TypeCheck.html#checkLambda"><span class="hs-identifier hs-var">TC.checkLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda (Aliases rep)
</span><a href="#local-6989586621684374173"><span class="hs-identifier hs-var">map_lam</span></a></span><span> </span><span class="annot"><span class="annottext">[Arg]
</span><a href="#local-6989586621684374172"><span class="hs-identifier hs-var">arrs'</span></a></span><span>
</span><span id="line-810"></span><span>
</span><span id="line-811"></span><span>  </span><span id="local-6989586621684374171"><span class="annot"><span class="annottext">[Arg]
</span><a href="#local-6989586621684374171"><span class="hs-identifier hs-var">scan_nes'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">([[Arg]] -&gt; [Arg]) -&gt; TypeM rep [[Arg]] -&gt; TypeM rep [Arg]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">[[Arg]] -&gt; [Arg]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span> </span><span class="annot"><span class="annottext">(TypeM rep [[Arg]] -&gt; TypeM rep [Arg])
-&gt; TypeM rep [[Arg]] -&gt; TypeM rep [Arg]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-812"></span><span>    </span><span class="annot"><span class="annottext">[Scan (Aliases rep)]
-&gt; (Scan (Aliases rep) -&gt; TypeM rep [Arg]) -&gt; TypeM rep [[Arg]]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="annot"><span class="annottext">[Scan (Aliases rep)]
</span><a href="#local-6989586621684374175"><span class="hs-identifier hs-var">scans</span></a></span><span> </span><span class="annot"><span class="annottext">((Scan (Aliases rep) -&gt; TypeM rep [Arg]) -&gt; TypeM rep [[Arg]])
-&gt; (Scan (Aliases rep) -&gt; TypeM rep [Arg]) -&gt; TypeM rep [[Arg]]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Scan"><span class="hs-identifier hs-type">Scan</span></a></span><span> </span><span id="local-6989586621684374170"><span class="annot"><span class="annottext">Lambda (Aliases rep)
</span><a href="#local-6989586621684374170"><span class="hs-identifier hs-var">scan_lam</span></a></span></span><span> </span><span id="local-6989586621684374169"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684374169"><span class="hs-identifier hs-var">scan_nes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-813"></span><span>      </span><span id="local-6989586621684374168"><span class="annot"><span class="annottext">[Arg]
</span><a href="#local-6989586621684374168"><span class="hs-identifier hs-var">scan_nes'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TypeM rep Arg) -&gt; [SubExp] -&gt; TypeM rep [Arg]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TypeM rep Arg
forall rep. Checkable rep =&gt; SubExp -&gt; TypeM rep Arg
</span><a href="Futhark.IR.TypeCheck.html#checkArg"><span class="hs-identifier hs-var">TC.checkArg</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684374169"><span class="hs-identifier hs-var">scan_nes</span></a></span><span>
</span><span id="line-814"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684374167"><span class="annot"><span class="annottext">scan_t :: [Type]
</span><a href="#local-6989586621684374167"><span class="hs-identifier hs-var hs-var">scan_t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Arg -&gt; Type) -&gt; [Arg] -&gt; [Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Arg -&gt; Type
</span><a href="Futhark.IR.TypeCheck.html#argType"><span class="hs-identifier hs-var">TC.argType</span></a></span><span> </span><span class="annot"><span class="annottext">[Arg]
</span><a href="#local-6989586621684374168"><span class="hs-identifier hs-var">scan_nes'</span></a></span><span>
</span><span id="line-815"></span><span>      </span><span class="annot"><span class="annottext">Lambda (Aliases rep) -&gt; [Arg] -&gt; TypeM rep ()
forall rep.
Checkable rep =&gt;
Lambda (Aliases rep) -&gt; [Arg] -&gt; TypeM rep ()
</span><a href="Futhark.IR.TypeCheck.html#checkLambda"><span class="hs-identifier hs-var">TC.checkLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda (Aliases rep)
</span><a href="#local-6989586621684374170"><span class="hs-identifier hs-var">scan_lam</span></a></span><span> </span><span class="annot"><span class="annottext">([Arg] -&gt; TypeM rep ()) -&gt; [Arg] -&gt; TypeM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Arg -&gt; Arg) -&gt; [Arg] -&gt; [Arg]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Arg -&gt; Arg
</span><a href="Futhark.IR.TypeCheck.html#noArgAliases"><span class="hs-identifier hs-var">TC.noArgAliases</span></a></span><span> </span><span class="annot"><span class="annottext">([Arg] -&gt; [Arg]) -&gt; [Arg] -&gt; [Arg]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Arg]
</span><a href="#local-6989586621684374168"><span class="hs-identifier hs-var">scan_nes'</span></a></span><span> </span><span class="annot"><span class="annottext">[Arg] -&gt; [Arg] -&gt; [Arg]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Arg]
</span><a href="#local-6989586621684374168"><span class="hs-identifier hs-var">scan_nes'</span></a></span><span>
</span><span id="line-816"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; TypeM rep () -&gt; TypeM rep ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684374167"><span class="hs-identifier hs-var">scan_t</span></a></span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; [Type] -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Lambda (Aliases rep) -&gt; [Type]
forall rep. LambdaT rep -&gt; [Type]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda (Aliases rep)
</span><a href="#local-6989586621684374170"><span class="hs-identifier hs-var">scan_lam</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TypeM rep () -&gt; TypeM rep ()) -&gt; TypeM rep () -&gt; TypeM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-817"></span><span>        </span><span class="annot"><span class="annottext">ErrorCase rep -&gt; TypeM rep ()
forall rep a. ErrorCase rep -&gt; TypeM rep a
</span><a href="Futhark.IR.TypeCheck.html#bad"><span class="hs-identifier hs-var">TC.bad</span></a></span><span> </span><span class="annot"><span class="annottext">(ErrorCase rep -&gt; TypeM rep ()) -&gt; ErrorCase rep -&gt; TypeM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-818"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; ErrorCase rep
forall rep. String -&gt; ErrorCase rep
</span><a href="Futhark.IR.TypeCheck.html#TypeError"><span class="hs-identifier hs-var">TC.TypeError</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; ErrorCase rep) -&gt; String -&gt; ErrorCase rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-819"></span><span>            </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Scan function returns type &quot;</span></span><span>
</span><span id="line-820"></span><span>              </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; String
forall a. Pretty a =&gt; [a] -&gt; String
</span><a href="Futhark.Util.Pretty.html#prettyTuple"><span class="hs-identifier hs-var">prettyTuple</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda (Aliases rep) -&gt; [Type]
forall rep. LambdaT rep -&gt; [Type]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda (Aliases rep)
</span><a href="#local-6989586621684374170"><span class="hs-identifier hs-var">scan_lam</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-821"></span><span>              </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; but neutral element has type &quot;</span></span><span>
</span><span id="line-822"></span><span>              </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; String
forall a. Pretty a =&gt; [a] -&gt; String
</span><a href="Futhark.Util.Pretty.html#prettyTuple"><span class="hs-identifier hs-var">prettyTuple</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684374167"><span class="hs-identifier hs-var">scan_t</span></a></span><span>
</span><span id="line-823"></span><span>      </span><span class="annot"><span class="annottext">[Arg] -&gt; TypeM rep [Arg]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">[Arg]
</span><a href="#local-6989586621684374168"><span class="hs-identifier hs-var">scan_nes'</span></a></span><span>
</span><span id="line-824"></span><span>
</span><span id="line-825"></span><span>  </span><span id="local-6989586621684374166"><span class="annot"><span class="annottext">[Arg]
</span><a href="#local-6989586621684374166"><span class="hs-identifier hs-var">red_nes'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">([[Arg]] -&gt; [Arg]) -&gt; TypeM rep [[Arg]] -&gt; TypeM rep [Arg]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">[[Arg]] -&gt; [Arg]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span> </span><span class="annot"><span class="annottext">(TypeM rep [[Arg]] -&gt; TypeM rep [Arg])
-&gt; TypeM rep [[Arg]] -&gt; TypeM rep [Arg]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-826"></span><span>    </span><span class="annot"><span class="annottext">[Reduce (Aliases rep)]
-&gt; (Reduce (Aliases rep) -&gt; TypeM rep [Arg]) -&gt; TypeM rep [[Arg]]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="annot"><span class="annottext">[Reduce (Aliases rep)]
</span><a href="#local-6989586621684374174"><span class="hs-identifier hs-var">reds</span></a></span><span> </span><span class="annot"><span class="annottext">((Reduce (Aliases rep) -&gt; TypeM rep [Arg]) -&gt; TypeM rep [[Arg]])
-&gt; (Reduce (Aliases rep) -&gt; TypeM rep [Arg]) -&gt; TypeM rep [[Arg]]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Reduce"><span class="hs-identifier hs-type">Reduce</span></a></span><span> </span><span class="annot"><span class="annottext">Commutativity
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684374165"><span class="annot"><span class="annottext">Lambda (Aliases rep)
</span><a href="#local-6989586621684374165"><span class="hs-identifier hs-var">red_lam</span></a></span></span><span> </span><span id="local-6989586621684374164"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684374164"><span class="hs-identifier hs-var">red_nes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-827"></span><span>      </span><span id="local-6989586621684374163"><span class="annot"><span class="annottext">[Arg]
</span><a href="#local-6989586621684374163"><span class="hs-identifier hs-var">red_nes'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TypeM rep Arg) -&gt; [SubExp] -&gt; TypeM rep [Arg]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TypeM rep Arg
forall rep. Checkable rep =&gt; SubExp -&gt; TypeM rep Arg
</span><a href="Futhark.IR.TypeCheck.html#checkArg"><span class="hs-identifier hs-var">TC.checkArg</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684374164"><span class="hs-identifier hs-var">red_nes</span></a></span><span>
</span><span id="line-828"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684374162"><span class="annot"><span class="annottext">red_t :: [Type]
</span><a href="#local-6989586621684374162"><span class="hs-identifier hs-var hs-var">red_t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Arg -&gt; Type) -&gt; [Arg] -&gt; [Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Arg -&gt; Type
</span><a href="Futhark.IR.TypeCheck.html#argType"><span class="hs-identifier hs-var">TC.argType</span></a></span><span> </span><span class="annot"><span class="annottext">[Arg]
</span><a href="#local-6989586621684374163"><span class="hs-identifier hs-var">red_nes'</span></a></span><span>
</span><span id="line-829"></span><span>      </span><span class="annot"><span class="annottext">Lambda (Aliases rep) -&gt; [Arg] -&gt; TypeM rep ()
forall rep.
Checkable rep =&gt;
Lambda (Aliases rep) -&gt; [Arg] -&gt; TypeM rep ()
</span><a href="Futhark.IR.TypeCheck.html#checkLambda"><span class="hs-identifier hs-var">TC.checkLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda (Aliases rep)
</span><a href="#local-6989586621684374165"><span class="hs-identifier hs-var">red_lam</span></a></span><span> </span><span class="annot"><span class="annottext">([Arg] -&gt; TypeM rep ()) -&gt; [Arg] -&gt; TypeM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Arg -&gt; Arg) -&gt; [Arg] -&gt; [Arg]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Arg -&gt; Arg
</span><a href="Futhark.IR.TypeCheck.html#noArgAliases"><span class="hs-identifier hs-var">TC.noArgAliases</span></a></span><span> </span><span class="annot"><span class="annottext">([Arg] -&gt; [Arg]) -&gt; [Arg] -&gt; [Arg]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Arg]
</span><a href="#local-6989586621684374163"><span class="hs-identifier hs-var">red_nes'</span></a></span><span> </span><span class="annot"><span class="annottext">[Arg] -&gt; [Arg] -&gt; [Arg]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Arg]
</span><a href="#local-6989586621684374163"><span class="hs-identifier hs-var">red_nes'</span></a></span><span>
</span><span id="line-830"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; TypeM rep () -&gt; TypeM rep ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684374162"><span class="hs-identifier hs-var">red_t</span></a></span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; [Type] -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Lambda (Aliases rep) -&gt; [Type]
forall rep. LambdaT rep -&gt; [Type]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda (Aliases rep)
</span><a href="#local-6989586621684374165"><span class="hs-identifier hs-var">red_lam</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TypeM rep () -&gt; TypeM rep ()) -&gt; TypeM rep () -&gt; TypeM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-831"></span><span>        </span><span class="annot"><span class="annottext">ErrorCase rep -&gt; TypeM rep ()
forall rep a. ErrorCase rep -&gt; TypeM rep a
</span><a href="Futhark.IR.TypeCheck.html#bad"><span class="hs-identifier hs-var">TC.bad</span></a></span><span> </span><span class="annot"><span class="annottext">(ErrorCase rep -&gt; TypeM rep ()) -&gt; ErrorCase rep -&gt; TypeM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-832"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; ErrorCase rep
forall rep. String -&gt; ErrorCase rep
</span><a href="Futhark.IR.TypeCheck.html#TypeError"><span class="hs-identifier hs-var">TC.TypeError</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; ErrorCase rep) -&gt; String -&gt; ErrorCase rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-833"></span><span>            </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Reduce function returns type &quot;</span></span><span>
</span><span id="line-834"></span><span>              </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; String
forall a. Pretty a =&gt; [a] -&gt; String
</span><a href="Futhark.Util.Pretty.html#prettyTuple"><span class="hs-identifier hs-var">prettyTuple</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda (Aliases rep) -&gt; [Type]
forall rep. LambdaT rep -&gt; [Type]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda (Aliases rep)
</span><a href="#local-6989586621684374165"><span class="hs-identifier hs-var">red_lam</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-835"></span><span>              </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; but neutral element has type &quot;</span></span><span>
</span><span id="line-836"></span><span>              </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; String
forall a. Pretty a =&gt; [a] -&gt; String
</span><a href="Futhark.Util.Pretty.html#prettyTuple"><span class="hs-identifier hs-var">prettyTuple</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684374162"><span class="hs-identifier hs-var">red_t</span></a></span><span>
</span><span id="line-837"></span><span>      </span><span class="annot"><span class="annottext">[Arg] -&gt; TypeM rep [Arg]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">[Arg]
</span><a href="#local-6989586621684374163"><span class="hs-identifier hs-var">red_nes'</span></a></span><span>
</span><span id="line-838"></span><span>
</span><span id="line-839"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684374161"><span class="annot"><span class="annottext">map_lam_ts :: [Type]
</span><a href="#local-6989586621684374161"><span class="hs-identifier hs-var hs-var">map_lam_ts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Lambda (Aliases rep) -&gt; [Type]
forall rep. LambdaT rep -&gt; [Type]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda (Aliases rep)
</span><a href="#local-6989586621684374173"><span class="hs-identifier hs-var">map_lam</span></a></span><span>
</span><span id="line-840"></span><span>
</span><span id="line-841"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; TypeM rep () -&gt; TypeM rep ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span>
</span><span id="line-842"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Type] -&gt; [Type]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">take</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Arg] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Arg]
</span><a href="#local-6989586621684374171"><span class="hs-identifier hs-var">scan_nes'</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">[Arg] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Arg]
</span><a href="#local-6989586621684374166"><span class="hs-identifier hs-var">red_nes'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684374161"><span class="hs-identifier hs-var">map_lam_ts</span></a></span><span>
</span><span id="line-843"></span><span>        </span><span class="annot"><span class="annottext">[Type] -&gt; [Type] -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">(Arg -&gt; Type) -&gt; [Arg] -&gt; [Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Arg -&gt; Type
</span><a href="Futhark.IR.TypeCheck.html#argType"><span class="hs-identifier hs-var">TC.argType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Arg]
</span><a href="#local-6989586621684374171"><span class="hs-identifier hs-var">scan_nes'</span></a></span><span> </span><span class="annot"><span class="annottext">[Arg] -&gt; [Arg] -&gt; [Arg]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Arg]
</span><a href="#local-6989586621684374166"><span class="hs-identifier hs-var">red_nes'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-844"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-845"></span><span>    </span><span class="annot"><span class="annottext">(TypeM rep () -&gt; TypeM rep ()) -&gt; TypeM rep () -&gt; TypeM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ErrorCase rep -&gt; TypeM rep ()
forall rep a. ErrorCase rep -&gt; TypeM rep a
</span><a href="Futhark.IR.TypeCheck.html#bad"><span class="hs-identifier hs-var">TC.bad</span></a></span><span> </span><span class="annot"><span class="annottext">(ErrorCase rep -&gt; TypeM rep ()) -&gt; ErrorCase rep -&gt; TypeM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-846"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; ErrorCase rep
forall rep. String -&gt; ErrorCase rep
</span><a href="Futhark.IR.TypeCheck.html#TypeError"><span class="hs-identifier hs-var">TC.TypeError</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; ErrorCase rep) -&gt; String -&gt; ErrorCase rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-847"></span><span>        </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Map function return type &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; String
forall a. Pretty a =&gt; [a] -&gt; String
</span><a href="Futhark.Util.Pretty.html#prettyTuple"><span class="hs-identifier hs-var">prettyTuple</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684374161"><span class="hs-identifier hs-var">map_lam_ts</span></a></span><span>
</span><span id="line-848"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; wrong for given scan and reduction functions.&quot;</span></span><span>
</span><span id="line-849"></span><span>
</span><span id="line-850"></span><span id="local-6989586621684376020"><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Futhark.Analysis.Metrics.html#OpMetrics"><span class="hs-identifier hs-type">OpMetrics</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376020"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Analysis.Metrics.html#OpMetrics"><span class="hs-identifier hs-type">OpMetrics</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#SOAC"><span class="hs-identifier hs-type">SOAC</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376020"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-851"></span><span>  </span><span id="local-6989586621684374126"><span class="annot"><span class="annottext">opMetrics :: SOAC rep -&gt; MetricsM ()
</span><a href="Futhark.Analysis.Metrics.html#opMetrics"><span class="hs-identifier hs-var hs-var hs-var hs-var">opMetrics</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#VJP"><span class="hs-identifier hs-type">VJP</span></a></span><span> </span><span id="local-6989586621684374124"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684374124"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-852"></span><span>    </span><span class="annot"><span class="annottext">Text -&gt; MetricsM () -&gt; MetricsM ()
</span><a href="Futhark.Analysis.Metrics.html#inside"><span class="hs-identifier hs-var">inside</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;VJP&quot;</span></span><span> </span><span class="annot"><span class="annottext">(MetricsM () -&gt; MetricsM ()) -&gt; MetricsM () -&gt; MetricsM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; MetricsM ()
forall rep. OpMetrics (Op rep) =&gt; Lambda rep -&gt; MetricsM ()
</span><a href="Futhark.Analysis.Metrics.html#lambdaMetrics"><span class="hs-identifier hs-var">lambdaMetrics</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684374124"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-853"></span><span>  </span><span class="annot"><a href="Futhark.Analysis.Metrics.html#opMetrics"><span class="hs-identifier hs-var">opMetrics</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#JVP"><span class="hs-identifier hs-type">JVP</span></a></span><span> </span><span id="local-6989586621684374121"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684374121"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-854"></span><span>    </span><span class="annot"><span class="annottext">Text -&gt; MetricsM () -&gt; MetricsM ()
</span><a href="Futhark.Analysis.Metrics.html#inside"><span class="hs-identifier hs-var">inside</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;JVP&quot;</span></span><span> </span><span class="annot"><span class="annottext">(MetricsM () -&gt; MetricsM ()) -&gt; MetricsM () -&gt; MetricsM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; MetricsM ()
forall rep. OpMetrics (Op rep) =&gt; Lambda rep -&gt; MetricsM ()
</span><a href="Futhark.Analysis.Metrics.html#lambdaMetrics"><span class="hs-identifier hs-var">lambdaMetrics</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684374121"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-855"></span><span>  </span><span class="annot"><a href="Futhark.Analysis.Metrics.html#opMetrics"><span class="hs-identifier hs-var">opMetrics</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StreamForm rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684374120"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684374120"><span class="hs-identifier hs-var">lam</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-856"></span><span>    </span><span class="annot"><span class="annottext">Text -&gt; MetricsM () -&gt; MetricsM ()
</span><a href="Futhark.Analysis.Metrics.html#inside"><span class="hs-identifier hs-var">inside</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Stream&quot;</span></span><span> </span><span class="annot"><span class="annottext">(MetricsM () -&gt; MetricsM ()) -&gt; MetricsM () -&gt; MetricsM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; MetricsM ()
forall rep. OpMetrics (Op rep) =&gt; Lambda rep -&gt; MetricsM ()
</span><a href="Futhark.Analysis.Metrics.html#lambdaMetrics"><span class="hs-identifier hs-var">lambdaMetrics</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684374120"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-857"></span><span>  </span><span class="annot"><a href="Futhark.Analysis.Metrics.html#opMetrics"><span class="hs-identifier hs-var">opMetrics</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Scatter"><span class="hs-identifier hs-type">Scatter</span></a></span><span> </span><span id="local-6989586621684374119"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684374119"><span class="hs-identifier hs-var">_len</span></a></span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684374118"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684374118"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span class="annot"><span class="annottext">[(Shape, Int, VName)]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-858"></span><span>    </span><span class="annot"><span class="annottext">Text -&gt; MetricsM () -&gt; MetricsM ()
</span><a href="Futhark.Analysis.Metrics.html#inside"><span class="hs-identifier hs-var">inside</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Scatter&quot;</span></span><span> </span><span class="annot"><span class="annottext">(MetricsM () -&gt; MetricsM ()) -&gt; MetricsM () -&gt; MetricsM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; MetricsM ()
forall rep. OpMetrics (Op rep) =&gt; Lambda rep -&gt; MetricsM ()
</span><a href="Futhark.Analysis.Metrics.html#lambdaMetrics"><span class="hs-identifier hs-var">lambdaMetrics</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684374118"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-859"></span><span>  </span><span class="annot"><a href="Futhark.Analysis.Metrics.html#opMetrics"><span class="hs-identifier hs-var">opMetrics</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Hist"><span class="hs-identifier hs-type">Hist</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684374117"><span class="annot"><span class="annottext">[HistOp rep]
</span><a href="#local-6989586621684374117"><span class="hs-identifier hs-var">ops</span></a></span></span><span> </span><span id="local-6989586621684374116"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684374116"><span class="hs-identifier hs-var">bucket_fun</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-860"></span><span>    </span><span class="annot"><span class="annottext">Text -&gt; MetricsM () -&gt; MetricsM ()
</span><a href="Futhark.Analysis.Metrics.html#inside"><span class="hs-identifier hs-var">inside</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Hist&quot;</span></span><span> </span><span class="annot"><span class="annottext">(MetricsM () -&gt; MetricsM ()) -&gt; MetricsM () -&gt; MetricsM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(HistOp rep -&gt; MetricsM ()) -&gt; [HistOp rep] -&gt; MetricsM ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda rep -&gt; MetricsM ()
forall rep. OpMetrics (Op rep) =&gt; Lambda rep -&gt; MetricsM ()
</span><a href="Futhark.Analysis.Metrics.html#lambdaMetrics"><span class="hs-identifier hs-var">lambdaMetrics</span></a></span><span> </span><span class="annot"><span class="annottext">(Lambda rep -&gt; MetricsM ())
-&gt; (HistOp rep -&gt; Lambda rep) -&gt; HistOp rep -&gt; MetricsM ()
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">HistOp rep -&gt; Lambda rep
forall rep. HistOp rep -&gt; Lambda rep
</span><a href="Futhark.IR.SOACS.SOAC.html#histOp"><span class="hs-identifier hs-var hs-var">histOp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[HistOp rep]
</span><a href="#local-6989586621684374117"><span class="hs-identifier hs-var">ops</span></a></span><span> </span><span class="annot"><span class="annottext">MetricsM () -&gt; MetricsM () -&gt; MetricsM ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; MetricsM ()
forall rep. OpMetrics (Op rep) =&gt; Lambda rep -&gt; MetricsM ()
</span><a href="Futhark.Analysis.Metrics.html#lambdaMetrics"><span class="hs-identifier hs-var">lambdaMetrics</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684374116"><span class="hs-identifier hs-var">bucket_fun</span></a></span><span>
</span><span id="line-861"></span><span>  </span><span class="annot"><a href="Futhark.Analysis.Metrics.html#opMetrics"><span class="hs-identifier hs-var">opMetrics</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Screma"><span class="hs-identifier hs-type">Screma</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#ScremaForm"><span class="hs-identifier hs-type">ScremaForm</span></a></span><span> </span><span id="local-6989586621684374115"><span class="annot"><span class="annottext">[Scan rep]
</span><a href="#local-6989586621684374115"><span class="hs-identifier hs-var">scans</span></a></span></span><span> </span><span id="local-6989586621684374114"><span class="annot"><span class="annottext">[Reduce rep]
</span><a href="#local-6989586621684374114"><span class="hs-identifier hs-var">reds</span></a></span></span><span> </span><span id="local-6989586621684374113"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684374113"><span class="hs-identifier hs-var">map_lam</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-862"></span><span>    </span><span class="annot"><span class="annottext">Text -&gt; MetricsM () -&gt; MetricsM ()
</span><a href="Futhark.Analysis.Metrics.html#inside"><span class="hs-identifier hs-var">inside</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Screma&quot;</span></span><span> </span><span class="annot"><span class="annottext">(MetricsM () -&gt; MetricsM ()) -&gt; MetricsM () -&gt; MetricsM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-863"></span><span>      </span><span class="annot"><span class="annottext">(Scan rep -&gt; MetricsM ()) -&gt; [Scan rep] -&gt; MetricsM ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda rep -&gt; MetricsM ()
forall rep. OpMetrics (Op rep) =&gt; Lambda rep -&gt; MetricsM ()
</span><a href="Futhark.Analysis.Metrics.html#lambdaMetrics"><span class="hs-identifier hs-var">lambdaMetrics</span></a></span><span> </span><span class="annot"><span class="annottext">(Lambda rep -&gt; MetricsM ())
-&gt; (Scan rep -&gt; Lambda rep) -&gt; Scan rep -&gt; MetricsM ()
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Scan rep -&gt; Lambda rep
forall rep. Scan rep -&gt; Lambda rep
</span><a href="Futhark.IR.SOACS.SOAC.html#scanLambda"><span class="hs-identifier hs-var hs-var">scanLambda</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Scan rep]
</span><a href="#local-6989586621684374115"><span class="hs-identifier hs-var">scans</span></a></span><span>
</span><span id="line-864"></span><span>      </span><span class="annot"><span class="annottext">(Reduce rep -&gt; MetricsM ()) -&gt; [Reduce rep] -&gt; MetricsM ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda rep -&gt; MetricsM ()
forall rep. OpMetrics (Op rep) =&gt; Lambda rep -&gt; MetricsM ()
</span><a href="Futhark.Analysis.Metrics.html#lambdaMetrics"><span class="hs-identifier hs-var">lambdaMetrics</span></a></span><span> </span><span class="annot"><span class="annottext">(Lambda rep -&gt; MetricsM ())
-&gt; (Reduce rep -&gt; Lambda rep) -&gt; Reduce rep -&gt; MetricsM ()
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Reduce rep -&gt; Lambda rep
forall rep. Reduce rep -&gt; Lambda rep
</span><a href="Futhark.IR.SOACS.SOAC.html#redLambda"><span class="hs-identifier hs-var hs-var">redLambda</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Reduce rep]
</span><a href="#local-6989586621684374114"><span class="hs-identifier hs-var">reds</span></a></span><span>
</span><span id="line-865"></span><span>      </span><span class="annot"><span class="annottext">Lambda rep -&gt; MetricsM ()
forall rep. OpMetrics (Op rep) =&gt; Lambda rep -&gt; MetricsM ()
</span><a href="Futhark.Analysis.Metrics.html#lambdaMetrics"><span class="hs-identifier hs-var">lambdaMetrics</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684374113"><span class="hs-identifier hs-var">map_lam</span></a></span></span><span>
</span><span id="line-866"></span><span>
</span><span id="line-867"></span><span id="local-6989586621684376146"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621684374108"><span id="local-6989586621684374110"><span class="annot"><a href="Futhark.IR.Pretty.html#PrettyRep"><span class="hs-identifier hs-type">PrettyRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376146"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">PP.Pretty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#SOAC"><span class="hs-identifier hs-type">SOAC</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376146"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-868"></span><span>  </span><span id="local-6989586621684374016"><span class="annot"><span class="annottext">ppr :: SOAC rep -&gt; Doc
</span><a href="#local-6989586621684374016"><span class="hs-identifier hs-var hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#VJP"><span class="hs-identifier hs-type">VJP</span></a></span><span> </span><span id="local-6989586621684374015"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684374015"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span id="local-6989586621684374014"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684374014"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621684374013"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684374013"><span class="hs-identifier hs-var">vec</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-869"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; Doc
</span><span class="hs-identifier hs-var">text</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;vjp&quot;</span></span><span>
</span><span id="line-870"></span><span>      </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><span class="hs-identifier hs-var">parens</span></span><span>
</span><span id="line-871"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><span class="hs-identifier hs-var">PP.align</span></span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; Doc) -&gt; Doc -&gt; Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-872"></span><span>            </span><span class="annot"><span class="annottext">Lambda rep -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684374015"><span class="hs-identifier hs-var">lam</span></a></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-identifier hs-var">comma</span></span><span>
</span><span id="line-873"></span><span>              </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><span class="hs-identifier hs-var">PP.braces</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Doc] -&gt; Doc
</span><span class="hs-identifier hs-var">commasep</span></span><span> </span><span class="annot"><span class="annottext">([Doc] -&gt; Doc) -&gt; [Doc] -&gt; Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; Doc) -&gt; [SubExp] -&gt; [Doc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684374014"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-identifier hs-var">comma</span></span><span>
</span><span id="line-874"></span><span>              </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><span class="hs-identifier hs-var">PP.braces</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Doc] -&gt; Doc
</span><span class="hs-identifier hs-var">commasep</span></span><span> </span><span class="annot"><span class="annottext">([Doc] -&gt; Doc) -&gt; [Doc] -&gt; Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; Doc) -&gt; [SubExp] -&gt; [Doc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684374013"><span class="hs-identifier hs-var">vec</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-875"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-876"></span><span>  </span><span class="annot"><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#JVP"><span class="hs-identifier hs-type">JVP</span></a></span><span> </span><span id="local-6989586621684374010"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684374010"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span id="local-6989586621684374009"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684374009"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621684374008"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684374008"><span class="hs-identifier hs-var">vec</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-877"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; Doc
</span><span class="hs-identifier hs-var">text</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;jvp&quot;</span></span><span>
</span><span id="line-878"></span><span>      </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><span class="hs-identifier hs-var">parens</span></span><span>
</span><span id="line-879"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><span class="hs-identifier hs-var">PP.align</span></span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; Doc) -&gt; Doc -&gt; Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-880"></span><span>            </span><span class="annot"><span class="annottext">Lambda rep -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684374010"><span class="hs-identifier hs-var">lam</span></a></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-identifier hs-var">comma</span></span><span>
</span><span id="line-881"></span><span>              </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><span class="hs-identifier hs-var">PP.braces</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Doc] -&gt; Doc
</span><span class="hs-identifier hs-var">commasep</span></span><span> </span><span class="annot"><span class="annottext">([Doc] -&gt; Doc) -&gt; [Doc] -&gt; Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; Doc) -&gt; [SubExp] -&gt; [Doc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684374009"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-identifier hs-var">comma</span></span><span>
</span><span id="line-882"></span><span>              </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><span class="hs-identifier hs-var">PP.braces</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Doc] -&gt; Doc
</span><span class="hs-identifier hs-var">commasep</span></span><span> </span><span class="annot"><span class="annottext">([Doc] -&gt; Doc) -&gt; [Doc] -&gt; Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; Doc) -&gt; [SubExp] -&gt; [Doc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684374008"><span class="hs-identifier hs-var">vec</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-883"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-884"></span><span>  </span><span class="annot"><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621684374007"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684374007"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span id="local-6989586621684374006"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684374006"><span class="hs-identifier hs-var">arrs</span></a></span></span><span> </span><span id="local-6989586621684374005"><span class="annot"><span class="annottext">StreamForm rep
</span><a href="#local-6989586621684374005"><span class="hs-identifier hs-var">form</span></a></span></span><span> </span><span id="local-6989586621684374004"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684374004"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621684374003"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684374003"><span class="hs-identifier hs-var">lam</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-885"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">StreamForm rep
</span><a href="#local-6989586621684374005"><span class="hs-identifier hs-var">form</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-886"></span><span>      </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Parallel"><span class="hs-identifier hs-type">Parallel</span></a></span><span> </span><span id="local-6989586621684374002"><span class="annot"><span class="annottext">StreamOrd
</span><a href="#local-6989586621684374002"><span class="hs-identifier hs-var">o</span></a></span></span><span> </span><span id="local-6989586621684374001"><span class="annot"><span class="annottext">Commutativity
</span><a href="#local-6989586621684374001"><span class="hs-identifier hs-var">comm</span></a></span></span><span> </span><span id="local-6989586621684374000"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684374000"><span class="hs-identifier hs-var">lam0</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-887"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684373999"><span class="annot"><span class="annottext">ord_str :: String
</span><a href="#local-6989586621684373999"><span class="hs-identifier hs-var hs-var">ord_str</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">StreamOrd
</span><a href="#local-6989586621684374002"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="annot"><span class="annottext">StreamOrd -&gt; StreamOrd -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">StreamOrd
</span><a href="Futhark.IR.SOACS.SOAC.html#Disorder"><span class="hs-identifier hs-var">Disorder</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Per&quot;</span></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;&quot;</span></span><span>
</span><span id="line-888"></span><span>            </span><span id="local-6989586621684373998"><span class="annot"><span class="annottext">comm_str :: String
</span><a href="#local-6989586621684373998"><span class="hs-identifier hs-var hs-var">comm_str</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Commutativity
</span><a href="#local-6989586621684374001"><span class="hs-identifier hs-var">comm</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-889"></span><span>              </span><span class="annot"><span class="annottext">Commutativity
</span><a href="Futhark.IR.Syntax.Core.html#Commutative"><span class="hs-identifier hs-var">Commutative</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Comm&quot;</span></span><span>
</span><span id="line-890"></span><span>              </span><span class="annot"><span class="annottext">Commutativity
</span><a href="Futhark.IR.Syntax.Core.html#Noncommutative"><span class="hs-identifier hs-var">Noncommutative</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;&quot;</span></span><span>
</span><span id="line-891"></span><span>         </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">String -&gt; Doc
</span><span class="hs-identifier hs-var">text</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;streamPar&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621684373999"><span class="hs-identifier hs-var">ord_str</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621684373998"><span class="hs-identifier hs-var">comm_str</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-892"></span><span>              </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><span class="hs-identifier hs-var">parens</span></span><span>
</span><span id="line-893"></span><span>                </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684374007"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-identifier hs-var">comma</span></span><span>
</span><span id="line-894"></span><span>                    </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Doc
forall a. Pretty a =&gt; [a] -&gt; Doc
</span><a href="Futhark.IR.Pretty.html#ppTuple%27"><span class="hs-identifier hs-var">ppTuple'</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684374006"><span class="hs-identifier hs-var">arrs</span></a></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-identifier hs-var">comma</span></span><span>
</span><span id="line-895"></span><span>                    </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684374000"><span class="hs-identifier hs-var">lam0</span></a></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-identifier hs-var">comma</span></span><span>
</span><span id="line-896"></span><span>                    </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; Doc
forall a. Pretty a =&gt; [a] -&gt; Doc
</span><a href="Futhark.IR.Pretty.html#ppTuple%27"><span class="hs-identifier hs-var">ppTuple'</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684374004"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-identifier hs-var">comma</span></span><span>
</span><span id="line-897"></span><span>                    </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684374003"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-898"></span><span>                </span><span class="hs-special">)</span><span>
</span><span id="line-899"></span><span>      </span><span class="annot"><span class="annottext">StreamForm rep
</span><a href="Futhark.IR.SOACS.SOAC.html#Sequential"><span class="hs-identifier hs-var">Sequential</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-900"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; Doc
</span><span class="hs-identifier hs-var">text</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;streamSeq&quot;</span></span><span>
</span><span id="line-901"></span><span>          </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><span class="hs-identifier hs-var">parens</span></span><span>
</span><span id="line-902"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684374007"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-identifier hs-var">comma</span></span><span>
</span><span id="line-903"></span><span>                </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Doc
forall a. Pretty a =&gt; [a] -&gt; Doc
</span><a href="Futhark.IR.Pretty.html#ppTuple%27"><span class="hs-identifier hs-var">ppTuple'</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684374006"><span class="hs-identifier hs-var">arrs</span></a></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-identifier hs-var">comma</span></span><span>
</span><span id="line-904"></span><span>                </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; Doc
forall a. Pretty a =&gt; [a] -&gt; Doc
</span><a href="Futhark.IR.Pretty.html#ppTuple%27"><span class="hs-identifier hs-var">ppTuple'</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684374004"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-identifier hs-var">comma</span></span><span>
</span><span id="line-905"></span><span>                </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684374003"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-906"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-907"></span><span>  </span><span class="annot"><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Scatter"><span class="hs-identifier hs-type">Scatter</span></a></span><span> </span><span id="local-6989586621684373994"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684373994"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684373993"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684373993"><span class="hs-identifier hs-var">arrs</span></a></span></span><span> </span><span id="local-6989586621684373992"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684373992"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span id="local-6989586621684373991"><span class="annot"><span class="annottext">[(Shape, Int, VName)]
</span><a href="#local-6989586621684373991"><span class="hs-identifier hs-var">dests</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-908"></span><span>    </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;scatter&quot;</span></span><span>
</span><span id="line-909"></span><span>      </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><span class="hs-identifier hs-var">parens</span></span><span>
</span><span id="line-910"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684373994"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-identifier hs-var">comma</span></span><span>
</span><span id="line-911"></span><span>            </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Doc
forall a. Pretty a =&gt; [a] -&gt; Doc
</span><a href="Futhark.IR.Pretty.html#ppTuple%27"><span class="hs-identifier hs-var">ppTuple'</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684373993"><span class="hs-identifier hs-var">arrs</span></a></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-identifier hs-var">comma</span></span><span>
</span><span id="line-912"></span><span>            </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684373992"><span class="hs-identifier hs-var">lam</span></a></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-identifier hs-var">comma</span></span><span>
</span><span id="line-913"></span><span>            </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Doc] -&gt; Doc
</span><span class="hs-identifier hs-var">commasep</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Shape, Int, VName) -&gt; Doc) -&gt; [(Shape, Int, VName)] -&gt; [Doc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Shape, Int, VName) -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">[(Shape, Int, VName)]
</span><a href="#local-6989586621684373991"><span class="hs-identifier hs-var">dests</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-914"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-915"></span><span>  </span><span class="annot"><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Hist"><span class="hs-identifier hs-type">Hist</span></a></span><span> </span><span id="local-6989586621684373990"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684373990"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684373989"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684373989"><span class="hs-identifier hs-var">arrs</span></a></span></span><span> </span><span id="local-6989586621684373988"><span class="annot"><span class="annottext">[HistOp rep]
</span><a href="#local-6989586621684373988"><span class="hs-identifier hs-var">ops</span></a></span></span><span> </span><span id="local-6989586621684373987"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684373987"><span class="hs-identifier hs-var">bucket_fun</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-916"></span><span>    </span><span class="annot"><span class="annottext">SubExp -&gt; [VName] -&gt; [HistOp rep] -&gt; Lambda rep -&gt; Doc
forall rep inp.
(PrettyRep rep, Pretty inp) =&gt;
SubExp -&gt; [inp] -&gt; [HistOp rep] -&gt; Lambda rep -&gt; Doc
</span><a href="Futhark.IR.SOACS.SOAC.html#ppHist"><span class="hs-identifier hs-var">ppHist</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684373990"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684373989"><span class="hs-identifier hs-var">arrs</span></a></span><span> </span><span class="annot"><span class="annottext">[HistOp rep]
</span><a href="#local-6989586621684373988"><span class="hs-identifier hs-var">ops</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684373987"><span class="hs-identifier hs-var">bucket_fun</span></a></span><span>
</span><span id="line-917"></span><span>  </span><span class="annot"><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Screma"><span class="hs-identifier hs-type">Screma</span></a></span><span> </span><span id="local-6989586621684373986"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684373986"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684373985"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684373985"><span class="hs-identifier hs-var">arrs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#ScremaForm"><span class="hs-identifier hs-type">ScremaForm</span></a></span><span> </span><span id="local-6989586621684373984"><span class="annot"><span class="annottext">[Scan rep]
</span><a href="#local-6989586621684373984"><span class="hs-identifier hs-var">scans</span></a></span></span><span> </span><span id="local-6989586621684373983"><span class="annot"><span class="annottext">[Reduce rep]
</span><a href="#local-6989586621684373983"><span class="hs-identifier hs-var">reds</span></a></span></span><span> </span><span id="local-6989586621684373982"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684373982"><span class="hs-identifier hs-var">map_lam</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-918"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[Scan rep] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[Scan rep]
</span><a href="#local-6989586621684373984"><span class="hs-identifier hs-var">scans</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-919"></span><span>      </span><span class="annot"><span class="annottext">[Reduce rep] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[Reduce rep]
</span><a href="#local-6989586621684373983"><span class="hs-identifier hs-var">reds</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-920"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; Doc
</span><span class="hs-identifier hs-var">text</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;map&quot;</span></span><span>
</span><span id="line-921"></span><span>        </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><span class="hs-identifier hs-var">parens</span></span><span>
</span><span id="line-922"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684373986"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-identifier hs-var">comma</span></span><span>
</span><span id="line-923"></span><span>              </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Doc
forall a. Pretty a =&gt; [a] -&gt; Doc
</span><a href="Futhark.IR.Pretty.html#ppTuple%27"><span class="hs-identifier hs-var">ppTuple'</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684373985"><span class="hs-identifier hs-var">arrs</span></a></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-identifier hs-var">comma</span></span><span>
</span><span id="line-924"></span><span>              </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684373982"><span class="hs-identifier hs-var">map_lam</span></a></span><span>
</span><span id="line-925"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-926"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[Scan rep] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[Scan rep]
</span><a href="#local-6989586621684373984"><span class="hs-identifier hs-var">scans</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-927"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; Doc
</span><span class="hs-identifier hs-var">text</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;redomap&quot;</span></span><span>
</span><span id="line-928"></span><span>        </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><span class="hs-identifier hs-var">parens</span></span><span>
</span><span id="line-929"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684373986"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-identifier hs-var">comma</span></span><span>
</span><span id="line-930"></span><span>              </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Doc
forall a. Pretty a =&gt; [a] -&gt; Doc
</span><a href="Futhark.IR.Pretty.html#ppTuple%27"><span class="hs-identifier hs-var">ppTuple'</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684373985"><span class="hs-identifier hs-var">arrs</span></a></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-identifier hs-var">comma</span></span><span>
</span><span id="line-931"></span><span>              </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><span class="hs-identifier hs-var">PP.braces</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Doc] -&gt; Doc
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">([Doc] -&gt; Doc) -&gt; [Doc] -&gt; Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; [Doc] -&gt; [Doc]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">intersperse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Doc
</span><span class="hs-identifier hs-var">comma</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-identifier hs-var">PP.line</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Doc] -&gt; [Doc]) -&gt; [Doc] -&gt; [Doc]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Reduce rep -&gt; Doc) -&gt; [Reduce rep] -&gt; [Doc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Reduce rep -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">[Reduce rep]
</span><a href="#local-6989586621684373983"><span class="hs-identifier hs-var">reds</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-identifier hs-var">comma</span></span><span>
</span><span id="line-932"></span><span>              </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684373982"><span class="hs-identifier hs-var">map_lam</span></a></span><span>
</span><span id="line-933"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-934"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[Reduce rep] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[Reduce rep]
</span><a href="#local-6989586621684373983"><span class="hs-identifier hs-var">reds</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-935"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; Doc
</span><span class="hs-identifier hs-var">text</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;scanomap&quot;</span></span><span>
</span><span id="line-936"></span><span>        </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><span class="hs-identifier hs-var">parens</span></span><span>
</span><span id="line-937"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684373986"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-identifier hs-var">comma</span></span><span>
</span><span id="line-938"></span><span>              </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Doc
forall a. Pretty a =&gt; [a] -&gt; Doc
</span><a href="Futhark.IR.Pretty.html#ppTuple%27"><span class="hs-identifier hs-var">ppTuple'</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684373985"><span class="hs-identifier hs-var">arrs</span></a></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-identifier hs-var">comma</span></span><span>
</span><span id="line-939"></span><span>              </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><span class="hs-identifier hs-var">PP.braces</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Doc] -&gt; Doc
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">([Doc] -&gt; Doc) -&gt; [Doc] -&gt; Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; [Doc] -&gt; [Doc]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">intersperse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Doc
</span><span class="hs-identifier hs-var">comma</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-identifier hs-var">PP.line</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Doc] -&gt; [Doc]) -&gt; [Doc] -&gt; [Doc]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Scan rep -&gt; Doc) -&gt; [Scan rep] -&gt; [Doc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Scan rep -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">[Scan rep]
</span><a href="#local-6989586621684373984"><span class="hs-identifier hs-var">scans</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-identifier hs-var">comma</span></span><span>
</span><span id="line-940"></span><span>              </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684373982"><span class="hs-identifier hs-var">map_lam</span></a></span><span>
</span><span id="line-941"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-942"></span><span>  </span><span class="annot"><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Screma"><span class="hs-identifier hs-type">Screma</span></a></span><span> </span><span id="local-6989586621684373980"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684373980"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684373979"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684373979"><span class="hs-identifier hs-var">arrs</span></a></span></span><span> </span><span id="local-6989586621684373978"><span class="annot"><span class="annottext">ScremaForm rep
</span><a href="#local-6989586621684373978"><span class="hs-identifier hs-var">form</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; [VName] -&gt; ScremaForm rep -&gt; Doc
forall rep inp.
(PrettyRep rep, Pretty inp) =&gt;
SubExp -&gt; [inp] -&gt; ScremaForm rep -&gt; Doc
</span><a href="Futhark.IR.SOACS.SOAC.html#ppScrema"><span class="hs-identifier hs-var">ppScrema</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684373980"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684373979"><span class="hs-identifier hs-var">arrs</span></a></span><span> </span><span class="annot"><span class="annottext">ScremaForm rep
</span><a href="#local-6989586621684373978"><span class="hs-identifier hs-var">form</span></a></span></span><span>
</span><span id="line-943"></span><span>
</span><span id="line-944"></span><span class="hs-comment">-- | Prettyprint the given Screma.</span><span>
</span><span id="line-945"></span><span id="local-6989586621684376006"><span id="local-6989586621684376007"><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#ppScrema"><span class="hs-identifier hs-type">ppScrema</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-946"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Pretty.html#PrettyRep"><span class="hs-identifier hs-type">PrettyRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376007"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Pretty</span></span><span> </span><span class="annot"><a href="#local-6989586621684376006"><span class="hs-identifier hs-type">inp</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621684376006"><span class="hs-identifier hs-type">inp</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#ScremaForm"><span class="hs-identifier hs-type">ScremaForm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376007"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Doc</span></span></span></span><span>
</span><span id="line-947"></span><span id="ppScrema"><span class="annot"><span class="annottext">ppScrema :: forall rep inp.
(PrettyRep rep, Pretty inp) =&gt;
SubExp -&gt; [inp] -&gt; ScremaForm rep -&gt; Doc
</span><a href="Futhark.IR.SOACS.SOAC.html#ppScrema"><span class="hs-identifier hs-var hs-var">ppScrema</span></a></span></span><span> </span><span id="local-6989586621684373961"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684373961"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684373960"><span class="annot"><span class="annottext">[inp]
</span><a href="#local-6989586621684373960"><span class="hs-identifier hs-var">arrs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#ScremaForm"><span class="hs-identifier hs-type">ScremaForm</span></a></span><span> </span><span id="local-6989586621684373959"><span class="annot"><span class="annottext">[Scan rep]
</span><a href="#local-6989586621684373959"><span class="hs-identifier hs-var">scans</span></a></span></span><span> </span><span id="local-6989586621684373958"><span class="annot"><span class="annottext">[Reduce rep]
</span><a href="#local-6989586621684373958"><span class="hs-identifier hs-var">reds</span></a></span></span><span> </span><span id="local-6989586621684373957"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684373957"><span class="hs-identifier hs-var">map_lam</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-948"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; Doc
</span><span class="hs-identifier hs-var">text</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;screma&quot;</span></span><span>
</span><span id="line-949"></span><span>    </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><span class="hs-identifier hs-var">parens</span></span><span>
</span><span id="line-950"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684373961"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-identifier hs-var">comma</span></span><span>
</span><span id="line-951"></span><span>          </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">[inp] -&gt; Doc
forall a. Pretty a =&gt; [a] -&gt; Doc
</span><a href="Futhark.IR.Pretty.html#ppTuple%27"><span class="hs-identifier hs-var">ppTuple'</span></a></span><span> </span><span class="annot"><span class="annottext">[inp]
</span><a href="#local-6989586621684373960"><span class="hs-identifier hs-var">arrs</span></a></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-identifier hs-var">comma</span></span><span>
</span><span id="line-952"></span><span>          </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><span class="hs-identifier hs-var">PP.braces</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Doc] -&gt; Doc
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">([Doc] -&gt; Doc) -&gt; [Doc] -&gt; Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; [Doc] -&gt; [Doc]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">intersperse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Doc
</span><span class="hs-identifier hs-var">comma</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-identifier hs-var">PP.line</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Doc] -&gt; [Doc]) -&gt; [Doc] -&gt; [Doc]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Scan rep -&gt; Doc) -&gt; [Scan rep] -&gt; [Doc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Scan rep -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">[Scan rep]
</span><a href="#local-6989586621684373959"><span class="hs-identifier hs-var">scans</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-identifier hs-var">comma</span></span><span>
</span><span id="line-953"></span><span>          </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><span class="hs-identifier hs-var">PP.braces</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Doc] -&gt; Doc
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">([Doc] -&gt; Doc) -&gt; [Doc] -&gt; Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; [Doc] -&gt; [Doc]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">intersperse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Doc
</span><span class="hs-identifier hs-var">comma</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-identifier hs-var">PP.line</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Doc] -&gt; [Doc]) -&gt; [Doc] -&gt; [Doc]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Reduce rep -&gt; Doc) -&gt; [Reduce rep] -&gt; [Doc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Reduce rep -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">[Reduce rep]
</span><a href="#local-6989586621684373958"><span class="hs-identifier hs-var">reds</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-identifier hs-var">comma</span></span><span>
</span><span id="line-954"></span><span>          </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684373957"><span class="hs-identifier hs-var">map_lam</span></a></span><span>
</span><span id="line-955"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-956"></span><span>
</span><span id="line-957"></span><span id="local-6989586621684376012"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621684373952"><span id="local-6989586621684373954"><span class="annot"><a href="Futhark.IR.Pretty.html#PrettyRep"><span class="hs-identifier hs-type">PrettyRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376012"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Pretty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Scan"><span class="hs-identifier hs-type">Scan</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376012"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-958"></span><span>  </span><span id="local-6989586621684373948"><span class="annot"><span class="annottext">ppr :: Scan rep -&gt; Doc
</span><a href="#local-6989586621684373948"><span class="hs-identifier hs-var hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Scan"><span class="hs-identifier hs-type">Scan</span></a></span><span> </span><span id="local-6989586621684373947"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684373947"><span class="hs-identifier hs-var">scan_lam</span></a></span></span><span> </span><span id="local-6989586621684373946"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684373946"><span class="hs-identifier hs-var">scan_nes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-959"></span><span>    </span><span class="annot"><span class="annottext">Lambda rep -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684373947"><span class="hs-identifier hs-var">scan_lam</span></a></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-identifier hs-var">comma</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><span class="hs-identifier hs-var">PP.braces</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Doc] -&gt; Doc
</span><span class="hs-identifier hs-var">commasep</span></span><span> </span><span class="annot"><span class="annottext">([Doc] -&gt; Doc) -&gt; [Doc] -&gt; Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; Doc) -&gt; [SubExp] -&gt; [Doc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684373946"><span class="hs-identifier hs-var">scan_nes</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-960"></span><span>
</span><span id="line-961"></span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#ppComm"><span class="hs-identifier hs-type">ppComm</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Commutativity"><span class="hs-identifier hs-type">Commutativity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Doc</span></span><span>
</span><span id="line-962"></span><span id="ppComm"><span class="annot"><span class="annottext">ppComm :: Commutativity -&gt; Doc
</span><a href="Futhark.IR.SOACS.SOAC.html#ppComm"><span class="hs-identifier hs-var hs-var">ppComm</span></a></span></span><span> </span><span class="annot"><span class="annottext">Commutativity
</span><a href="Futhark.IR.Syntax.Core.html#Noncommutative"><span class="hs-identifier hs-var">Noncommutative</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Doc
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-963"></span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#ppComm"><span class="hs-identifier hs-var">ppComm</span></a></span><span> </span><span class="annot"><span class="annottext">Commutativity
</span><a href="Futhark.IR.Syntax.Core.html#Commutative"><span class="hs-identifier hs-var">Commutative</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Doc
</span><span class="hs-identifier hs-var">text</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;commutative &quot;</span></span><span>
</span><span id="line-964"></span><span>
</span><span id="line-965"></span><span id="local-6989586621684376011"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621684373940"><span id="local-6989586621684373942"><span class="annot"><a href="Futhark.IR.Pretty.html#PrettyRep"><span class="hs-identifier hs-type">PrettyRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376011"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Pretty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Reduce"><span class="hs-identifier hs-type">Reduce</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376011"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-966"></span><span>  </span><span id="local-6989586621684373935"><span class="annot"><span class="annottext">ppr :: Reduce rep -&gt; Doc
</span><a href="#local-6989586621684373935"><span class="hs-identifier hs-var hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Reduce"><span class="hs-identifier hs-type">Reduce</span></a></span><span> </span><span id="local-6989586621684373934"><span class="annot"><span class="annottext">Commutativity
</span><a href="#local-6989586621684373934"><span class="hs-identifier hs-var">comm</span></a></span></span><span> </span><span id="local-6989586621684373933"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684373933"><span class="hs-identifier hs-var">red_lam</span></a></span></span><span> </span><span id="local-6989586621684373932"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684373932"><span class="hs-identifier hs-var">red_nes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-967"></span><span>    </span><span class="annot"><span class="annottext">Commutativity -&gt; Doc
</span><a href="Futhark.IR.SOACS.SOAC.html#ppComm"><span class="hs-identifier hs-var">ppComm</span></a></span><span> </span><span class="annot"><span class="annottext">Commutativity
</span><a href="#local-6989586621684373934"><span class="hs-identifier hs-var">comm</span></a></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684373933"><span class="hs-identifier hs-var">red_lam</span></a></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-identifier hs-var">comma</span></span><span>
</span><span id="line-968"></span><span>      </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><span class="hs-identifier hs-var">PP.braces</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Doc] -&gt; Doc
</span><span class="hs-identifier hs-var">commasep</span></span><span> </span><span class="annot"><span class="annottext">([Doc] -&gt; Doc) -&gt; [Doc] -&gt; Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; Doc) -&gt; [SubExp] -&gt; [Doc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684373932"><span class="hs-identifier hs-var">red_nes</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-969"></span><span>
</span><span id="line-970"></span><span class="hs-comment">-- | Prettyprint the given histogram operation.</span><span>
</span><span id="line-971"></span><span id="local-6989586621684376008"><span id="local-6989586621684376009"><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#ppHist"><span class="hs-identifier hs-type">ppHist</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-972"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Pretty.html#PrettyRep"><span class="hs-identifier hs-type">PrettyRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376009"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Pretty</span></span><span> </span><span class="annot"><a href="#local-6989586621684376008"><span class="hs-identifier hs-type">inp</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-973"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-974"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621684376008"><span class="hs-identifier hs-type">inp</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-975"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#HistOp"><span class="hs-identifier hs-type">HistOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376009"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-976"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684376009"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-977"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Doc</span></span></span></span><span>
</span><span id="line-978"></span><span id="ppHist"><span class="annot"><span class="annottext">ppHist :: forall rep inp.
(PrettyRep rep, Pretty inp) =&gt;
SubExp -&gt; [inp] -&gt; [HistOp rep] -&gt; Lambda rep -&gt; Doc
</span><a href="Futhark.IR.SOACS.SOAC.html#ppHist"><span class="hs-identifier hs-var hs-var">ppHist</span></a></span></span><span> </span><span id="local-6989586621684373919"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684373919"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684373918"><span class="annot"><span class="annottext">[inp]
</span><a href="#local-6989586621684373918"><span class="hs-identifier hs-var">arrs</span></a></span></span><span> </span><span id="local-6989586621684373917"><span class="annot"><span class="annottext">[HistOp rep]
</span><a href="#local-6989586621684373917"><span class="hs-identifier hs-var">ops</span></a></span></span><span> </span><span id="local-6989586621684373916"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684373916"><span class="hs-identifier hs-var">bucket_fun</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-979"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; Doc
</span><span class="hs-identifier hs-var">text</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;hist&quot;</span></span><span>
</span><span id="line-980"></span><span>    </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><span class="hs-identifier hs-var">parens</span></span><span>
</span><span id="line-981"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684373919"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-identifier hs-var">comma</span></span><span>
</span><span id="line-982"></span><span>          </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">[inp] -&gt; Doc
forall a. Pretty a =&gt; [a] -&gt; Doc
</span><a href="Futhark.IR.Pretty.html#ppTuple%27"><span class="hs-identifier hs-var">ppTuple'</span></a></span><span> </span><span class="annot"><span class="annottext">[inp]
</span><a href="#local-6989586621684373918"><span class="hs-identifier hs-var">arrs</span></a></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-identifier hs-var">comma</span></span><span>
</span><span id="line-983"></span><span>          </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><span class="hs-identifier hs-var">PP.braces</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Doc] -&gt; Doc
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">([Doc] -&gt; Doc) -&gt; [Doc] -&gt; Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; [Doc] -&gt; [Doc]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">intersperse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Doc
</span><span class="hs-identifier hs-var">comma</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-identifier hs-var">PP.line</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Doc] -&gt; [Doc]) -&gt; [Doc] -&gt; [Doc]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(HistOp rep -&gt; Doc) -&gt; [HistOp rep] -&gt; [Doc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">HistOp rep -&gt; Doc
forall {rep}. PrettyRep rep =&gt; HistOp rep -&gt; Doc
</span><a href="#local-6989586621684373915"><span class="hs-identifier hs-var">ppOp</span></a></span><span> </span><span class="annot"><span class="annottext">[HistOp rep]
</span><a href="#local-6989586621684373917"><span class="hs-identifier hs-var">ops</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-identifier hs-var">comma</span></span><span>
</span><span id="line-984"></span><span>          </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684373916"><span class="hs-identifier hs-var">bucket_fun</span></a></span><span>
</span><span id="line-985"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-986"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-987"></span><span>    </span><span id="local-6989586621684373915"><span class="annot"><span class="annottext">ppOp :: HistOp rep -&gt; Doc
</span><a href="#local-6989586621684373915"><span class="hs-identifier hs-var hs-var">ppOp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#HistOp"><span class="hs-identifier hs-type">HistOp</span></a></span><span> </span><span id="local-6989586621684373903"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684373903"><span class="hs-identifier hs-var">dest_w</span></a></span></span><span> </span><span id="local-6989586621684373902"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684373902"><span class="hs-identifier hs-var">rf</span></a></span></span><span> </span><span id="local-6989586621684373901"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684373901"><span class="hs-identifier hs-var">dests</span></a></span></span><span> </span><span id="local-6989586621684373900"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684373900"><span class="hs-identifier hs-var">nes</span></a></span></span><span> </span><span id="local-6989586621684373899"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684373899"><span class="hs-identifier hs-var">op</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-988"></span><span>      </span><span class="annot"><span class="annottext">Shape -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684373903"><span class="hs-identifier hs-var">dest_w</span></a></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-identifier hs-var">comma</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684373902"><span class="hs-identifier hs-var">rf</span></a></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-identifier hs-var">comma</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><span class="hs-identifier hs-var">PP.braces</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Doc] -&gt; Doc
</span><span class="hs-identifier hs-var">commasep</span></span><span> </span><span class="annot"><span class="annottext">([Doc] -&gt; Doc) -&gt; [Doc] -&gt; Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Doc) -&gt; [VName] -&gt; [Doc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684373901"><span class="hs-identifier hs-var">dests</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-identifier hs-var">comma</span></span><span>
</span><span id="line-989"></span><span>        </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; Doc
forall a. Pretty a =&gt; [a] -&gt; Doc
</span><a href="Futhark.IR.Pretty.html#ppTuple%27"><span class="hs-identifier hs-var">ppTuple'</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684373900"><span class="hs-identifier hs-var">nes</span></a></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-identifier hs-var">comma</span></span><span>
</span><span id="line-990"></span><span>        </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684373899"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-991"></span></pre></body></html>