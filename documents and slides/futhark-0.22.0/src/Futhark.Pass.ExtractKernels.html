<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE FlexibleInstances #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE MultiParamTypeClasses #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-10"></span><span>
</span><span id="line-11"></span><span class="hs-comment">-- | Kernel extraction.</span><span>
</span><span id="line-12"></span><span class="hs-comment">--</span><span>
</span><span id="line-13"></span><span class="hs-comment">-- In the following, I will use the term &quot;width&quot; to denote the amount</span><span>
</span><span id="line-14"></span><span class="hs-comment">-- of immediate parallelism in a map - that is, the outer size of the</span><span>
</span><span id="line-15"></span><span class="hs-comment">-- array(s) being used as input.</span><span>
</span><span id="line-16"></span><span class="hs-comment">--</span><span>
</span><span id="line-17"></span><span class="hs-comment">-- = Basic Idea</span><span>
</span><span id="line-18"></span><span class="hs-comment">--</span><span>
</span><span id="line-19"></span><span class="hs-comment">-- If we have:</span><span>
</span><span id="line-20"></span><span class="hs-comment">--</span><span>
</span><span id="line-21"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-22"></span><span class="hs-comment">--   map</span><span>
</span><span id="line-23"></span><span class="hs-comment">--     map(f)</span><span>
</span><span id="line-24"></span><span class="hs-comment">--     stms_a...</span><span>
</span><span id="line-25"></span><span class="hs-comment">--     map(g)</span><span>
</span><span id="line-26"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-27"></span><span class="hs-comment">--</span><span>
</span><span id="line-28"></span><span class="hs-comment">-- Then we want to distribute to:</span><span>
</span><span id="line-29"></span><span class="hs-comment">--</span><span>
</span><span id="line-30"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-31"></span><span class="hs-comment">--   map</span><span>
</span><span id="line-32"></span><span class="hs-comment">--     map(f)</span><span>
</span><span id="line-33"></span><span class="hs-comment">--   map</span><span>
</span><span id="line-34"></span><span class="hs-comment">--     stms_a</span><span>
</span><span id="line-35"></span><span class="hs-comment">--   map</span><span>
</span><span id="line-36"></span><span class="hs-comment">--     map(g)</span><span>
</span><span id="line-37"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-38"></span><span class="hs-comment">--</span><span>
</span><span id="line-39"></span><span class="hs-comment">-- But for now only if</span><span>
</span><span id="line-40"></span><span class="hs-comment">--</span><span>
</span><span id="line-41"></span><span class="hs-comment">--  (0) it can be done without creating irregular arrays.</span><span>
</span><span id="line-42"></span><span class="hs-comment">--      Specifically, the size of the arrays created by @map(f)@, by</span><span>
</span><span id="line-43"></span><span class="hs-comment">--      @map(g)@ and whatever is created by @stms_a@ that is also used</span><span>
</span><span id="line-44"></span><span class="hs-comment">--      in @map(g)@, must be invariant to the outermost loop.</span><span>
</span><span id="line-45"></span><span class="hs-comment">--</span><span>
</span><span id="line-46"></span><span class="hs-comment">--  (1) the maps are _balanced_.  That is, the functions @f@ and @g@</span><span>
</span><span id="line-47"></span><span class="hs-comment">--      must do the same amount of work for every iteration.</span><span>
</span><span id="line-48"></span><span class="hs-comment">--</span><span>
</span><span id="line-49"></span><span class="hs-comment">-- The advantage is that the map-nests containing @map(f)@ and</span><span>
</span><span id="line-50"></span><span class="hs-comment">-- @map(g)@ can now be trivially flattened at no cost, thus exposing</span><span>
</span><span id="line-51"></span><span class="hs-comment">-- more parallelism.  Note that the @stms_a@ map constitutes array</span><span>
</span><span id="line-52"></span><span class="hs-comment">-- expansion, which requires additional storage.</span><span>
</span><span id="line-53"></span><span class="hs-comment">--</span><span>
</span><span id="line-54"></span><span class="hs-comment">-- = Distributing Sequential Loops</span><span>
</span><span id="line-55"></span><span class="hs-comment">--</span><span>
</span><span id="line-56"></span><span class="hs-comment">-- As a starting point, sequential loops are treated like scalar</span><span>
</span><span id="line-57"></span><span class="hs-comment">-- expressions.  That is, not distributed.  However, sometimes it can</span><span>
</span><span id="line-58"></span><span class="hs-comment">-- be worthwhile to distribute if they contain a map:</span><span>
</span><span id="line-59"></span><span class="hs-comment">--</span><span>
</span><span id="line-60"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-61"></span><span class="hs-comment">--   map</span><span>
</span><span id="line-62"></span><span class="hs-comment">--     loop</span><span>
</span><span id="line-63"></span><span class="hs-comment">--       map</span><span>
</span><span id="line-64"></span><span class="hs-comment">--     map</span><span>
</span><span id="line-65"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-66"></span><span class="hs-comment">--</span><span>
</span><span id="line-67"></span><span class="hs-comment">-- If we distribute the loop and interchange the outer map into the</span><span>
</span><span id="line-68"></span><span class="hs-comment">-- loop, we get this:</span><span>
</span><span id="line-69"></span><span class="hs-comment">--</span><span>
</span><span id="line-70"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-71"></span><span class="hs-comment">--   loop</span><span>
</span><span id="line-72"></span><span class="hs-comment">--     map</span><span>
</span><span id="line-73"></span><span class="hs-comment">--       map</span><span>
</span><span id="line-74"></span><span class="hs-comment">--   map</span><span>
</span><span id="line-75"></span><span class="hs-comment">--     map</span><span>
</span><span id="line-76"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-77"></span><span class="hs-comment">--</span><span>
</span><span id="line-78"></span><span class="hs-comment">-- Now more parallelism may be available.</span><span>
</span><span id="line-79"></span><span class="hs-comment">--</span><span>
</span><span id="line-80"></span><span class="hs-comment">-- = Unbalanced Maps</span><span>
</span><span id="line-81"></span><span class="hs-comment">--</span><span>
</span><span id="line-82"></span><span class="hs-comment">-- Unbalanced maps will as a rule be sequentialised, but sometimes,</span><span>
</span><span id="line-83"></span><span class="hs-comment">-- there is another way.  Assume we find this:</span><span>
</span><span id="line-84"></span><span class="hs-comment">--</span><span>
</span><span id="line-85"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-86"></span><span class="hs-comment">--   map</span><span>
</span><span id="line-87"></span><span class="hs-comment">--     map(f)</span><span>
</span><span id="line-88"></span><span class="hs-comment">--       map(g)</span><span>
</span><span id="line-89"></span><span class="hs-comment">--     map</span><span>
</span><span id="line-90"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-91"></span><span class="hs-comment">--</span><span>
</span><span id="line-92"></span><span class="hs-comment">-- Presume that @map(f)@ is unbalanced.  By the simple rule above, we</span><span>
</span><span id="line-93"></span><span class="hs-comment">-- would then fully sequentialise it, resulting in this:</span><span>
</span><span id="line-94"></span><span class="hs-comment">--</span><span>
</span><span id="line-95"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-96"></span><span class="hs-comment">--   map</span><span>
</span><span id="line-97"></span><span class="hs-comment">--     loop</span><span>
</span><span id="line-98"></span><span class="hs-comment">--   map</span><span>
</span><span id="line-99"></span><span class="hs-comment">--     map</span><span>
</span><span id="line-100"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-101"></span><span class="hs-comment">--</span><span>
</span><span id="line-102"></span><span class="hs-comment">-- == Balancing by Loop Interchange</span><span>
</span><span id="line-103"></span><span class="hs-comment">--</span><span>
</span><span id="line-104"></span><span class="hs-comment">-- The above is not ideal, as we cannot flatten the @map-loop@ nest,</span><span>
</span><span id="line-105"></span><span class="hs-comment">-- and we are thus limited in the amount of parallelism available.</span><span>
</span><span id="line-106"></span><span class="hs-comment">--</span><span>
</span><span id="line-107"></span><span class="hs-comment">-- But assume now that the width of @map(g)@ is invariant to the outer</span><span>
</span><span id="line-108"></span><span class="hs-comment">-- loop.  Then if possible, we can interchange @map(f)@ and @map(g)@,</span><span>
</span><span id="line-109"></span><span class="hs-comment">-- sequentialise @map(f)@ and distribute, interchanging the outer</span><span>
</span><span id="line-110"></span><span class="hs-comment">-- parallel loop into the sequential loop:</span><span>
</span><span id="line-111"></span><span class="hs-comment">--</span><span>
</span><span id="line-112"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-113"></span><span class="hs-comment">--   loop(f)</span><span>
</span><span id="line-114"></span><span class="hs-comment">--     map</span><span>
</span><span id="line-115"></span><span class="hs-comment">--       map(g)</span><span>
</span><span id="line-116"></span><span class="hs-comment">--   map</span><span>
</span><span id="line-117"></span><span class="hs-comment">--     map</span><span>
</span><span id="line-118"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-119"></span><span class="hs-comment">--</span><span>
</span><span id="line-120"></span><span class="hs-comment">-- After flattening the two nests we can obtain more parallelism.</span><span>
</span><span id="line-121"></span><span class="hs-comment">--</span><span>
</span><span id="line-122"></span><span class="hs-comment">-- When distributing a map, we also need to distribute everything that</span><span>
</span><span id="line-123"></span><span class="hs-comment">-- the map depends on - possibly as its own map.  When distributing a</span><span>
</span><span id="line-124"></span><span class="hs-comment">-- set of scalar bindings, we will need to know which of the binding</span><span>
</span><span id="line-125"></span><span class="hs-comment">-- results are used afterwards.  Hence, we will need to compute usage</span><span>
</span><span id="line-126"></span><span class="hs-comment">-- information.</span><span>
</span><span id="line-127"></span><span class="hs-comment">--</span><span>
</span><span id="line-128"></span><span class="hs-comment">-- = Redomap</span><span>
</span><span id="line-129"></span><span class="hs-comment">--</span><span>
</span><span id="line-130"></span><span class="hs-comment">-- Redomap can be handled much like map.  Distributed loops are</span><span>
</span><span id="line-131"></span><span class="hs-comment">-- distributed as maps, with the parameters corresponding to the</span><span>
</span><span id="line-132"></span><span class="hs-comment">-- neutral elements added to their bodies.  The remaining loop will</span><span>
</span><span id="line-133"></span><span class="hs-comment">-- remain a redomap.  Example:</span><span>
</span><span id="line-134"></span><span class="hs-comment">--</span><span>
</span><span id="line-135"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-136"></span><span class="hs-comment">-- redomap(op,</span><span>
</span><span id="line-137"></span><span class="hs-comment">--         fn (v) =&gt;</span><span>
</span><span id="line-138"></span><span class="hs-comment">--           map(f)</span><span>
</span><span id="line-139"></span><span class="hs-comment">--           map(g),</span><span>
</span><span id="line-140"></span><span class="hs-comment">--         e,a)</span><span>
</span><span id="line-141"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-142"></span><span class="hs-comment">--</span><span>
</span><span id="line-143"></span><span class="hs-comment">-- distributes to</span><span>
</span><span id="line-144"></span><span class="hs-comment">--</span><span>
</span><span id="line-145"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-146"></span><span class="hs-comment">-- let b = map(fn v =&gt;</span><span>
</span><span id="line-147"></span><span class="hs-comment">--               let acc = e</span><span>
</span><span id="line-148"></span><span class="hs-comment">--               map(f),</span><span>
</span><span id="line-149"></span><span class="hs-comment">--               a)</span><span>
</span><span id="line-150"></span><span class="hs-comment">-- redomap(op,</span><span>
</span><span id="line-151"></span><span class="hs-comment">--         fn (v,dist) =&gt;</span><span>
</span><span id="line-152"></span><span class="hs-comment">--           map(g),</span><span>
</span><span id="line-153"></span><span class="hs-comment">--         e,a,b)</span><span>
</span><span id="line-154"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-155"></span><span class="hs-comment">--</span><span>
</span><span id="line-156"></span><span class="hs-comment">-- Note that there may be further kernel extraction opportunities</span><span>
</span><span id="line-157"></span><span class="hs-comment">-- inside the @map(f)@.  The downside of this approach is that the</span><span>
</span><span id="line-158"></span><span class="hs-comment">-- intermediate array (@b@ above) must be written to main memory.  An</span><span>
</span><span id="line-159"></span><span class="hs-comment">-- often better approach is to just turn the entire @redomap@ into a</span><span>
</span><span id="line-160"></span><span class="hs-comment">-- single kernel.</span><span>
</span><span id="line-161"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Futhark.Pass.ExtractKernels</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#extractKernels"><span class="hs-identifier">extractKernels</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-162"></span><span>
</span><span id="line-163"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Identity</span></span><span>
</span><span id="line-164"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.RWS.Strict</span></span><span>
</span><span id="line-165"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Reader</span></span><span>
</span><span id="line-166"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Bifunctor</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">first</span></span><span class="hs-special">)</span><span>
</span><span id="line-167"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span>
</span><span id="line-168"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html"><span class="hs-identifier">Futhark.IR.GPU</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Out</span></span><span>
</span><span id="line-169"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.GPU.Op.html"><span class="hs-identifier">Futhark.IR.GPU.Op</span></a></span><span>
</span><span id="line-170"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html"><span class="hs-identifier">Futhark.IR.SOACS</span></a></span><span>
</span><span id="line-171"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.Simplify.html"><span class="hs-identifier">Futhark.IR.SOACS.Simplify</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.Simplify.html#simplifyStms"><span class="hs-identifier">simplifyStms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-172"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.MonadFreshNames.html"><span class="hs-identifier">Futhark.MonadFreshNames</span></a></span><span>
</span><span id="line-173"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Pass.html"><span class="hs-identifier">Futhark.Pass</span></a></span><span>
</span><span id="line-174"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.BlockedKernel.html"><span class="hs-identifier">Futhark.Pass.ExtractKernels.BlockedKernel</span></a></span><span>
</span><span id="line-175"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.DistributeNests.html"><span class="hs-identifier">Futhark.Pass.ExtractKernels.DistributeNests</span></a></span><span>
</span><span id="line-176"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html"><span class="hs-identifier">Futhark.Pass.ExtractKernels.Distribution</span></a></span><span>
</span><span id="line-177"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.ISRWIM.html"><span class="hs-identifier">Futhark.Pass.ExtractKernels.ISRWIM</span></a></span><span>
</span><span id="line-178"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Intragroup.html"><span class="hs-identifier">Futhark.Pass.ExtractKernels.Intragroup</span></a></span><span>
</span><span id="line-179"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.StreamKernel.html"><span class="hs-identifier">Futhark.Pass.ExtractKernels.StreamKernel</span></a></span><span>
</span><span id="line-180"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.ToGPU.html"><span class="hs-identifier">Futhark.Pass.ExtractKernels.ToGPU</span></a></span><span>
</span><span id="line-181"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Tools.html"><span class="hs-identifier">Futhark.Tools</span></a></span><span>
</span><span id="line-182"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.Transform.FirstOrderTransform.html"><span class="hs-identifier">Futhark.Transform.FirstOrderTransform</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">FOT</span></span><span>
</span><span id="line-183"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Transform.Rename.html"><span class="hs-identifier">Futhark.Transform.Rename</span></a></span><span>
</span><span id="line-184"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Util.Log.html"><span class="hs-identifier">Futhark.Util.Log</span></a></span><span>
</span><span id="line-185"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Prelude</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">log</span></span><span class="hs-special">)</span><span>
</span><span id="line-186"></span><span>
</span><span id="line-187"></span><span class="hs-comment">-- | Transform a program using SOACs to a program using explicit</span><span>
</span><span id="line-188"></span><span class="hs-comment">-- kernels, using the kernel extraction transformation.</span><span>
</span><span id="line-189"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#extractKernels"><span class="hs-identifier hs-type">extractKernels</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Pass.html#Pass"><span class="hs-identifier hs-type">Pass</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">Out.GPU</span></a></span><span>
</span><span id="line-190"></span><span id="extractKernels"><span class="annot"><span class="annottext">extractKernels :: Pass SOACS GPU
</span><a href="Futhark.Pass.ExtractKernels.html#extractKernels"><span class="hs-identifier hs-var hs-var">extractKernels</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-191"></span><span>  </span><span class="annot"><span class="annottext">Pass :: forall fromrep torep.
[Char]
-&gt; [Char]
-&gt; (Prog fromrep -&gt; PassM (Prog torep))
-&gt; Pass fromrep torep
</span><a href="Futhark.Pass.html#Pass"><span class="hs-identifier hs-type">Pass</span></a></span><span>
</span><span id="line-192"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">passName :: [Char]
</span><a href="Futhark.Pass.html#passName"><span class="hs-identifier hs-var">passName</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;extract kernels&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-193"></span><span>      </span><span class="annot"><span class="annottext">passDescription :: [Char]
</span><a href="Futhark.Pass.html#passDescription"><span class="hs-identifier hs-var">passDescription</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Perform kernel extraction&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-194"></span><span>      </span><span class="annot"><span class="annottext">passFunction :: Prog SOACS -&gt; PassM (Prog GPU)
</span><a href="Futhark.Pass.html#passFunction"><span class="hs-identifier hs-var">passFunction</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Prog SOACS -&gt; PassM (Prog GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#transformProg"><span class="hs-identifier hs-var">transformProg</span></a></span><span>
</span><span id="line-195"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-196"></span><span>
</span><span id="line-197"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#transformProg"><span class="hs-identifier hs-type">transformProg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Prog"><span class="hs-identifier hs-type">Prog</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.html#PassM"><span class="hs-identifier hs-type">PassM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Prog"><span class="hs-identifier hs-type">Prog</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">Out.GPU</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-198"></span><span id="transformProg"><span class="annot"><span class="annottext">transformProg :: Prog SOACS -&gt; PassM (Prog GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#transformProg"><span class="hs-identifier hs-var hs-var">transformProg</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Prog"><span class="hs-identifier hs-type">Prog</span></a></span><span> </span><span id="local-6989586621684423333"><span class="annot"><span class="annottext">Stms SOACS
</span><a href="#local-6989586621684423333"><span class="hs-identifier hs-var">consts</span></a></span></span><span> </span><span id="local-6989586621684423332"><span class="annot"><span class="annottext">[FunDef SOACS]
</span><a href="#local-6989586621684423332"><span class="hs-identifier hs-var">funs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-199"></span><span>  </span><span id="local-6989586621684423331"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684423331"><span class="hs-identifier hs-var">consts'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DistribM (Stms GPU) -&gt; PassM (Stms GPU)
forall (m :: * -&gt; *) a.
(MonadLogger m, MonadFreshNames m) =&gt;
DistribM a -&gt; m a
</span><a href="Futhark.Pass.ExtractKernels.html#runDistribM"><span class="hs-identifier hs-var">runDistribM</span></a></span><span> </span><span class="annot"><span class="annottext">(DistribM (Stms GPU) -&gt; PassM (Stms GPU))
-&gt; DistribM (Stms GPU) -&gt; PassM (Stms GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KernelPath -&gt; [Stm SOACS] -&gt; DistribM (Stms GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#transformStms"><span class="hs-identifier hs-var">transformStms</span></a></span><span> </span><span class="annot"><span class="annottext">KernelPath
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">([Stm SOACS] -&gt; DistribM (Stms GPU))
-&gt; [Stm SOACS] -&gt; DistribM (Stms GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stms SOACS -&gt; [Stm SOACS]
forall rep. Stms rep -&gt; [Stm rep]
</span><a href="Futhark.IR.Syntax.html#stmsToList"><span class="hs-identifier hs-var">stmsToList</span></a></span><span> </span><span class="annot"><span class="annottext">Stms SOACS
</span><a href="#local-6989586621684423333"><span class="hs-identifier hs-var">consts</span></a></span><span>
</span><span id="line-200"></span><span>  </span><span id="local-6989586621684423327"><span class="annot"><span class="annottext">[FunDef GPU]
</span><a href="#local-6989586621684423327"><span class="hs-identifier hs-var">funs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(FunDef SOACS -&gt; PassM (FunDef GPU))
-&gt; [FunDef SOACS] -&gt; PassM [FunDef GPU]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Scope GPU -&gt; FunDef SOACS -&gt; PassM (FunDef GPU)
forall (m :: * -&gt; *).
(MonadFreshNames m, MonadLogger m) =&gt;
Scope GPU -&gt; FunDef SOACS -&gt; m (FunDef GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#transformFunDef"><span class="hs-identifier hs-var">transformFunDef</span></a></span><span> </span><span class="annot"><span class="annottext">(Scope GPU -&gt; FunDef SOACS -&gt; PassM (FunDef GPU))
-&gt; Scope GPU -&gt; FunDef SOACS -&gt; PassM (FunDef GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stms GPU -&gt; Scope GPU
forall rep a. Scoped rep a =&gt; a -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOf"><span class="hs-identifier hs-var">scopeOf</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684423331"><span class="hs-identifier hs-var">consts'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[FunDef SOACS]
</span><a href="#local-6989586621684423332"><span class="hs-identifier hs-var">funs</span></a></span><span>
</span><span id="line-201"></span><span>  </span><span class="annot"><span class="annottext">Prog GPU -&gt; PassM (Prog GPU)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Prog GPU -&gt; PassM (Prog GPU)) -&gt; Prog GPU -&gt; PassM (Prog GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stms GPU -&gt; [FunDef GPU] -&gt; Prog GPU
forall rep. Stms rep -&gt; [FunDef rep] -&gt; Prog rep
</span><a href="Futhark.IR.Syntax.html#Prog"><span class="hs-identifier hs-var">Prog</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684423331"><span class="hs-identifier hs-var">consts'</span></a></span><span> </span><span class="annot"><span class="annottext">[FunDef GPU]
</span><a href="#local-6989586621684423327"><span class="hs-identifier hs-var">funs'</span></a></span><span>
</span><span id="line-202"></span><span>
</span><span id="line-203"></span><span class="hs-comment">-- In order to generate more stable threshold names, we keep track of</span><span>
</span><span id="line-204"></span><span class="hs-comment">-- the numbers used for thresholds separately from the ordinary name</span><span>
</span><span id="line-205"></span><span class="hs-comment">-- source,</span><span>
</span><span id="line-206"></span><span class="hs-keyword">data</span><span> </span><span id="State"><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#State"><span class="hs-identifier hs-var">State</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="State"><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#State"><span class="hs-identifier hs-var">State</span></a></span></span><span>
</span><span id="line-207"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="stateNameSource"><span class="annot"><span class="annottext">State -&gt; VNameSource
</span><a href="Futhark.Pass.ExtractKernels.html#stateNameSource"><span class="hs-identifier hs-var hs-var">stateNameSource</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.FreshNames.html#VNameSource"><span class="hs-identifier hs-type">VNameSource</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-208"></span><span>    </span><span id="stateThresholdCounter"><span class="annot"><span class="annottext">State -&gt; Int
</span><a href="Futhark.Pass.ExtractKernels.html#stateThresholdCounter"><span class="hs-identifier hs-var hs-var">stateThresholdCounter</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-209"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-210"></span><span>
</span><span id="line-211"></span><span class="hs-keyword">newtype</span><span> </span><span id="DistribM"><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#DistribM"><span class="hs-identifier hs-var">DistribM</span></a></span></span><span> </span><span id="local-6989586621684423320"><span class="annot"><a href="#local-6989586621684423320"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="DistribM"><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#DistribM"><span class="hs-identifier hs-var">DistribM</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">RWS</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">Out.GPU</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Futhark.Util.Log.html#Log"><span class="hs-identifier hs-type">Log</span></a></span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684423320"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-212"></span><span>  </span><span class="hs-keyword">deriving</span><span>
</span><span id="line-213"></span><span>    </span><span class="hs-special">(</span><span> </span><span id="local-6989586621684423311"><span id="local-6989586621684423317"><span class="annot"><span class="annottext">(forall a b. (a -&gt; b) -&gt; DistribM a -&gt; DistribM b)
-&gt; (forall a b. a -&gt; DistribM b -&gt; DistribM a) -&gt; Functor DistribM
forall a b. a -&gt; DistribM b -&gt; DistribM a
forall a b. (a -&gt; b) -&gt; DistribM a -&gt; DistribM b
forall (f :: * -&gt; *).
(forall a b. (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b. a -&gt; f b -&gt; f a) -&gt; Functor f
&lt;$ :: forall a b. a -&gt; DistribM b -&gt; DistribM a
$c&lt;$ :: forall a b. a -&gt; DistribM b -&gt; DistribM a
fmap :: forall a b. (a -&gt; b) -&gt; DistribM a -&gt; DistribM b
$cfmap :: forall a b. (a -&gt; b) -&gt; DistribM a -&gt; DistribM b
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Functor</span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-214"></span><span>      </span><span id="local-6989586621684423277"><span id="local-6989586621684423283"><span id="local-6989586621684423289"><span id="local-6989586621684423295"><span id="local-6989586621684423302"><span class="annot"><span class="annottext">Functor DistribM
Functor DistribM
-&gt; (forall a. a -&gt; DistribM a)
-&gt; (forall a b. DistribM (a -&gt; b) -&gt; DistribM a -&gt; DistribM b)
-&gt; (forall a b c.
    (a -&gt; b -&gt; c) -&gt; DistribM a -&gt; DistribM b -&gt; DistribM c)
-&gt; (forall a b. DistribM a -&gt; DistribM b -&gt; DistribM b)
-&gt; (forall a b. DistribM a -&gt; DistribM b -&gt; DistribM a)
-&gt; Applicative DistribM
forall a. a -&gt; DistribM a
forall a b. DistribM a -&gt; DistribM b -&gt; DistribM a
forall a b. DistribM a -&gt; DistribM b -&gt; DistribM b
forall a b. DistribM (a -&gt; b) -&gt; DistribM a -&gt; DistribM b
forall a b c.
(a -&gt; b -&gt; c) -&gt; DistribM a -&gt; DistribM b -&gt; DistribM c
forall (f :: * -&gt; *).
Functor f
-&gt; (forall a. a -&gt; f a)
-&gt; (forall a b. f (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b c. (a -&gt; b -&gt; c) -&gt; f a -&gt; f b -&gt; f c)
-&gt; (forall a b. f a -&gt; f b -&gt; f b)
-&gt; (forall a b. f a -&gt; f b -&gt; f a)
-&gt; Applicative f
&lt;* :: forall a b. DistribM a -&gt; DistribM b -&gt; DistribM a
$c&lt;* :: forall a b. DistribM a -&gt; DistribM b -&gt; DistribM a
*&gt; :: forall a b. DistribM a -&gt; DistribM b -&gt; DistribM b
$c*&gt; :: forall a b. DistribM a -&gt; DistribM b -&gt; DistribM b
liftA2 :: forall a b c.
(a -&gt; b -&gt; c) -&gt; DistribM a -&gt; DistribM b -&gt; DistribM c
$cliftA2 :: forall a b c.
(a -&gt; b -&gt; c) -&gt; DistribM a -&gt; DistribM b -&gt; DistribM c
&lt;*&gt; :: forall a b. DistribM (a -&gt; b) -&gt; DistribM a -&gt; DistribM b
$c&lt;*&gt; :: forall a b. DistribM (a -&gt; b) -&gt; DistribM a -&gt; DistribM b
pure :: forall a. a -&gt; DistribM a
$cpure :: forall a. a -&gt; DistribM a
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Applicative</span></span></span></span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-215"></span><span>      </span><span id="local-6989586621684423256"><span id="local-6989586621684423261"><span id="local-6989586621684423267"><span class="annot"><span class="annottext">Applicative DistribM
Applicative DistribM
-&gt; (forall a b. DistribM a -&gt; (a -&gt; DistribM b) -&gt; DistribM b)
-&gt; (forall a b. DistribM a -&gt; DistribM b -&gt; DistribM b)
-&gt; (forall a. a -&gt; DistribM a)
-&gt; Monad DistribM
forall a. a -&gt; DistribM a
forall a b. DistribM a -&gt; DistribM b -&gt; DistribM b
forall a b. DistribM a -&gt; (a -&gt; DistribM b) -&gt; DistribM b
forall (m :: * -&gt; *).
Applicative m
-&gt; (forall a b. m a -&gt; (a -&gt; m b) -&gt; m b)
-&gt; (forall a b. m a -&gt; m b -&gt; m b)
-&gt; (forall a. a -&gt; m a)
-&gt; Monad m
return :: forall a. a -&gt; DistribM a
$creturn :: forall a. a -&gt; DistribM a
&gt;&gt; :: forall a b. DistribM a -&gt; DistribM b -&gt; DistribM b
$c&gt;&gt; :: forall a b. DistribM a -&gt; DistribM b -&gt; DistribM b
&gt;&gt;= :: forall a b. DistribM a -&gt; (a -&gt; DistribM b) -&gt; DistribM b
$c&gt;&gt;= :: forall a b. DistribM a -&gt; (a -&gt; DistribM b) -&gt; DistribM b
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Monad</span></span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-216"></span><span>      </span><span id="local-6989586621684423230"><span id="local-6989586621684423235"><span id="local-6989586621684423240"><span id="local-6989586621684423246"><span class="annot"><a href="Futhark.IR.Prop.Scope.html#HasScope"><span class="hs-identifier hs-type">HasScope</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">Out.GPU</span></a></span></span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-217"></span><span>      </span><span id="local-6989586621684423220"><span class="annot"><a href="Futhark.IR.Prop.Scope.html#LocalScope"><span class="hs-identifier hs-type">LocalScope</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">Out.GPU</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-218"></span><span>      </span><span id="local-6989586621684423200"><span id="local-6989586621684423205"><span id="local-6989586621684423211"><span class="annot"><span class="hs-identifier hs-type">MonadState</span></span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#State"><span class="hs-identifier hs-type">State</span></a></span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-219"></span><span>      </span><span id="local-6989586621684423181"><span id="local-6989586621684423188"><span class="annot"><span class="annottext">Monad DistribM
Applicative DistribM
Applicative DistribM
-&gt; Monad DistribM
-&gt; (forall a. ToLog a =&gt; a -&gt; DistribM ())
-&gt; (Log -&gt; DistribM ())
-&gt; MonadLogger DistribM
Log -&gt; DistribM ()
forall a. ToLog a =&gt; a -&gt; DistribM ()
forall (m :: * -&gt; *).
Applicative m
-&gt; Monad m
-&gt; (forall a. ToLog a =&gt; a -&gt; m ())
-&gt; (Log -&gt; m ())
-&gt; MonadLogger m
addLog :: Log -&gt; DistribM ()
$caddLog :: Log -&gt; DistribM ()
logMsg :: forall a. ToLog a =&gt; a -&gt; DistribM ()
$clogMsg :: forall a. ToLog a =&gt; a -&gt; DistribM ()
</span><a href="Futhark.Util.Log.html#C%3AMonadLogger"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">MonadLogger</span></a></span></span></span><span>
</span><span id="line-220"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-221"></span><span>
</span><span id="line-222"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Futhark.MonadFreshNames.html#MonadFreshNames"><span class="hs-identifier hs-type">MonadFreshNames</span></a></span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#DistribM"><span class="hs-identifier hs-type">DistribM</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-223"></span><span>  </span><span id="local-6989586621684423169"><span class="annot"><span class="annottext">getNameSource :: DistribM VNameSource
</span><a href="Futhark.MonadFreshNames.html#getNameSource"><span class="hs-identifier hs-var hs-var hs-var hs-var">getNameSource</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State -&gt; VNameSource) -&gt; DistribM VNameSource
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">State -&gt; VNameSource
</span><a href="Futhark.Pass.ExtractKernels.html#stateNameSource"><span class="hs-identifier hs-var hs-var">stateNameSource</span></a></span><span>
</span><span id="line-224"></span><span>  </span><span id="local-6989586621684423165"><span class="annot"><span class="annottext">putNameSource :: VNameSource -&gt; DistribM ()
</span><a href="Futhark.MonadFreshNames.html#putNameSource"><span class="hs-identifier hs-var hs-var hs-var hs-var">putNameSource</span></a></span></span><span> </span><span id="local-6989586621684423163"><span class="annot"><span class="annottext">VNameSource
</span><a href="#local-6989586621684423163"><span class="hs-identifier hs-var">src</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State -&gt; State) -&gt; DistribM ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((State -&gt; State) -&gt; DistribM ())
-&gt; (State -&gt; State) -&gt; DistribM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684423161"><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621684423161"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621684423161"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">stateNameSource :: VNameSource
</span><a href="Futhark.Pass.ExtractKernels.html#stateNameSource"><span class="hs-identifier hs-var">stateNameSource</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VNameSource
</span><a href="#local-6989586621684423163"><span class="hs-identifier hs-var">src</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-225"></span><span>
</span><span id="line-226"></span><span id="local-6989586621684424369"><span id="local-6989586621684424370"><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#runDistribM"><span class="hs-identifier hs-type">runDistribM</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-227"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Util.Log.html#MonadLogger"><span class="hs-identifier hs-type">MonadLogger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684424370"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.MonadFreshNames.html#MonadFreshNames"><span class="hs-identifier hs-type">MonadFreshNames</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684424370"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-228"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#DistribM"><span class="hs-identifier hs-type">DistribM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684424369"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-229"></span><span>  </span><span class="annot"><a href="#local-6989586621684424370"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684424369"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-230"></span><span id="runDistribM"><span class="annot"><span class="annottext">runDistribM :: forall (m :: * -&gt; *) a.
(MonadLogger m, MonadFreshNames m) =&gt;
DistribM a -&gt; m a
</span><a href="Futhark.Pass.ExtractKernels.html#runDistribM"><span class="hs-identifier hs-var hs-var">runDistribM</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#DistribM"><span class="hs-identifier hs-type">DistribM</span></a></span><span> </span><span id="local-6989586621684423149"><span class="annot"><span class="annottext">RWS (Scope GPU) Log State a
</span><a href="#local-6989586621684423149"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-231"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684423148"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684423148"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684423147"><span class="annot"><span class="annottext">Log
</span><a href="#local-6989586621684423147"><span class="hs-identifier hs-var">msgs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(VNameSource -&gt; ((a, Log), VNameSource)) -&gt; m (a, Log)
forall (m :: * -&gt; *) a.
MonadFreshNames m =&gt;
(VNameSource -&gt; (a, VNameSource)) -&gt; m a
</span><a href="Futhark.MonadFreshNames.html#modifyNameSource"><span class="hs-identifier hs-var">modifyNameSource</span></a></span><span> </span><span class="annot"><span class="annottext">((VNameSource -&gt; ((a, Log), VNameSource)) -&gt; m (a, Log))
-&gt; (VNameSource -&gt; ((a, Log), VNameSource)) -&gt; m (a, Log)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684423145"><span class="annot"><span class="annottext">VNameSource
</span><a href="#local-6989586621684423145"><span class="hs-identifier hs-var">src</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-232"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684423144"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684423144"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684423143"><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621684423143"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684423142"><span class="annot"><span class="annottext">Log
</span><a href="#local-6989586621684423142"><span class="hs-identifier hs-var">msgs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RWS (Scope GPU) Log State a
-&gt; Scope GPU -&gt; State -&gt; (a, State, Log)
forall r w s a. RWS r w s a -&gt; r -&gt; s -&gt; (a, s, w)
</span><span class="hs-identifier hs-var">runRWS</span></span><span> </span><span class="annot"><span class="annottext">RWS (Scope GPU) Log State a
</span><a href="#local-6989586621684423149"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">Scope GPU
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VNameSource -&gt; Int -&gt; State
</span><a href="Futhark.Pass.ExtractKernels.html#State"><span class="hs-identifier hs-var">State</span></a></span><span> </span><span class="annot"><span class="annottext">VNameSource
</span><a href="#local-6989586621684423145"><span class="hs-identifier hs-var">src</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-233"></span><span>     </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684423144"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Log
</span><a href="#local-6989586621684423142"><span class="hs-identifier hs-var">msgs</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">State -&gt; VNameSource
</span><a href="Futhark.Pass.ExtractKernels.html#stateNameSource"><span class="hs-identifier hs-var hs-var">stateNameSource</span></a></span><span> </span><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621684423143"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-234"></span><span>  </span><span class="annot"><span class="annottext">Log -&gt; m ()
forall (m :: * -&gt; *). MonadLogger m =&gt; Log -&gt; m ()
</span><a href="Futhark.Util.Log.html#addLog"><span class="hs-identifier hs-var">addLog</span></a></span><span> </span><span class="annot"><span class="annottext">Log
</span><a href="#local-6989586621684423147"><span class="hs-identifier hs-var">msgs</span></a></span><span>
</span><span id="line-235"></span><span>  </span><span class="annot"><span class="annottext">a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684423148"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-236"></span><span>
</span><span id="line-237"></span><span id="local-6989586621684424359"><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#transformFunDef"><span class="hs-identifier hs-type">transformFunDef</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-238"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.MonadFreshNames.html#MonadFreshNames"><span class="hs-identifier hs-type">MonadFreshNames</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684424359"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Util.Log.html#MonadLogger"><span class="hs-identifier hs-type">MonadLogger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684424359"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-239"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">Out.GPU</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-240"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#FunDef"><span class="hs-identifier hs-type">FunDef</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-241"></span><span>  </span><span class="annot"><a href="#local-6989586621684424359"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#FunDef"><span class="hs-identifier hs-type">Out.FunDef</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">Out.GPU</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-242"></span><span id="transformFunDef"><span class="annot"><span class="annottext">transformFunDef :: forall (m :: * -&gt; *).
(MonadFreshNames m, MonadLogger m) =&gt;
Scope GPU -&gt; FunDef SOACS -&gt; m (FunDef GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#transformFunDef"><span class="hs-identifier hs-var hs-var">transformFunDef</span></a></span></span><span> </span><span id="local-6989586621684423128"><span class="annot"><span class="annottext">Scope GPU
</span><a href="#local-6989586621684423128"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#FunDef"><span class="hs-identifier hs-type">FunDef</span></a></span><span> </span><span id="local-6989586621684423126"><span class="annot"><span class="annottext">Maybe EntryPoint
</span><a href="#local-6989586621684423126"><span class="hs-identifier hs-var">entry</span></a></span></span><span> </span><span id="local-6989586621684423125"><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684423125"><span class="hs-identifier hs-var">attrs</span></a></span></span><span> </span><span id="local-6989586621684423124"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684423124"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621684423123"><span class="annot"><span class="annottext">[RetType SOACS]
</span><a href="#local-6989586621684423123"><span class="hs-identifier hs-var">rettype</span></a></span></span><span> </span><span id="local-6989586621684423122"><span class="annot"><span class="annottext">[FParam SOACS]
</span><a href="#local-6989586621684423122"><span class="hs-identifier hs-var">params</span></a></span></span><span> </span><span id="local-6989586621684423121"><span class="annot"><span class="annottext">BodyT SOACS
</span><a href="#local-6989586621684423121"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DistribM (FunDef GPU) -&gt; m (FunDef GPU)
forall (m :: * -&gt; *) a.
(MonadLogger m, MonadFreshNames m) =&gt;
DistribM a -&gt; m a
</span><a href="Futhark.Pass.ExtractKernels.html#runDistribM"><span class="hs-identifier hs-var">runDistribM</span></a></span><span> </span><span class="annot"><span class="annottext">(DistribM (FunDef GPU) -&gt; m (FunDef GPU))
-&gt; DistribM (FunDef GPU) -&gt; m (FunDef GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-243"></span><span>  </span><span id="local-6989586621684423120"><span class="annot"><span class="annottext">Body GPU
</span><a href="#local-6989586621684423120"><span class="hs-identifier hs-var">body'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-244"></span><span>    </span><span class="annot"><span class="annottext">Scope GPU -&gt; DistribM (Body GPU) -&gt; DistribM (Body GPU)
forall rep (m :: * -&gt; *) a.
LocalScope rep m =&gt;
Scope rep -&gt; m a -&gt; m a
</span><a href="Futhark.IR.Prop.Scope.html#localScope"><span class="hs-identifier hs-var">localScope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Scope GPU
</span><a href="#local-6989586621684423128"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="annot"><span class="annottext">Scope GPU -&gt; Scope GPU -&gt; Scope GPU
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Param DeclType] -&gt; Scope GPU
forall rep dec. (FParamInfo rep ~ dec) =&gt; [Param dec] -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOfFParams"><span class="hs-identifier hs-var">scopeOfFParams</span></a></span><span> </span><span class="annot"><span class="annottext">[Param DeclType]
[FParam SOACS]
</span><a href="#local-6989586621684423122"><span class="hs-identifier hs-var">params</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(DistribM (Body GPU) -&gt; DistribM (Body GPU))
-&gt; DistribM (Body GPU) -&gt; DistribM (Body GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-245"></span><span>      </span><span class="annot"><span class="annottext">KernelPath -&gt; BodyT SOACS -&gt; DistribM (Body GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#transformBody"><span class="hs-identifier hs-var">transformBody</span></a></span><span> </span><span class="annot"><span class="annottext">KernelPath
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">BodyT SOACS
</span><a href="#local-6989586621684423121"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-246"></span><span>  </span><span class="annot"><span class="annottext">FunDef GPU -&gt; DistribM (FunDef GPU)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(FunDef GPU -&gt; DistribM (FunDef GPU))
-&gt; FunDef GPU -&gt; DistribM (FunDef GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe EntryPoint
-&gt; Attrs
-&gt; Name
-&gt; [RetType GPU]
-&gt; [FParam GPU]
-&gt; Body GPU
-&gt; FunDef GPU
forall rep.
Maybe EntryPoint
-&gt; Attrs
-&gt; Name
-&gt; [RetType rep]
-&gt; [FParam rep]
-&gt; BodyT rep
-&gt; FunDef rep
</span><a href="Futhark.IR.Syntax.html#FunDef"><span class="hs-identifier hs-var">FunDef</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe EntryPoint
</span><a href="#local-6989586621684423126"><span class="hs-identifier hs-var">entry</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684423125"><span class="hs-identifier hs-var">attrs</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684423124"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">[RetType SOACS]
[RetType GPU]
</span><a href="#local-6989586621684423123"><span class="hs-identifier hs-var">rettype</span></a></span><span> </span><span class="annot"><span class="annottext">[FParam SOACS]
[FParam GPU]
</span><a href="#local-6989586621684423122"><span class="hs-identifier hs-var">params</span></a></span><span> </span><span class="annot"><span class="annottext">Body GPU
</span><a href="#local-6989586621684423120"><span class="hs-identifier hs-var">body'</span></a></span><span>
</span><span id="line-247"></span><span>
</span><span id="line-248"></span><span class="hs-keyword">type</span><span> </span><span id="GPUStms"><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#GPUStms"><span class="hs-identifier hs-var">GPUStms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">Out.GPU</span></a></span><span>
</span><span id="line-249"></span><span>
</span><span id="line-250"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#transformBody"><span class="hs-identifier hs-type">transformBody</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#KernelPath"><span class="hs-identifier hs-type">KernelPath</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#DistribM"><span class="hs-identifier hs-type">DistribM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Out.Body</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">Out.GPU</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-251"></span><span id="transformBody"><span class="annot"><span class="annottext">transformBody :: KernelPath -&gt; BodyT SOACS -&gt; DistribM (Body GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#transformBody"><span class="hs-identifier hs-var hs-var">transformBody</span></a></span></span><span> </span><span id="local-6989586621684423114"><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684423114"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span id="local-6989586621684423113"><span class="annot"><span class="annottext">BodyT SOACS
</span><a href="#local-6989586621684423113"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-252"></span><span>  </span><span id="local-6989586621684423112"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684423112"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">KernelPath -&gt; [Stm SOACS] -&gt; DistribM (Stms GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#transformStms"><span class="hs-identifier hs-var">transformStms</span></a></span><span> </span><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684423114"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="annot"><span class="annottext">([Stm SOACS] -&gt; DistribM (Stms GPU))
-&gt; [Stm SOACS] -&gt; DistribM (Stms GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stms SOACS -&gt; [Stm SOACS]
forall rep. Stms rep -&gt; [Stm rep]
</span><a href="Futhark.IR.Syntax.html#stmsToList"><span class="hs-identifier hs-var">stmsToList</span></a></span><span> </span><span class="annot"><span class="annottext">(Stms SOACS -&gt; [Stm SOACS]) -&gt; Stms SOACS -&gt; [Stm SOACS]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BodyT SOACS -&gt; Stms SOACS
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT SOACS
</span><a href="#local-6989586621684423113"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-253"></span><span>  </span><span class="annot"><span class="annottext">Body GPU -&gt; DistribM (Body GPU)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Body GPU -&gt; DistribM (Body GPU))
-&gt; Body GPU -&gt; DistribM (Body GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stms GPU -&gt; Result -&gt; Body GPU
forall rep. Buildable rep =&gt; Stms rep -&gt; Result -&gt; Body rep
</span><a href="Futhark.Builder.Class.html#mkBody"><span class="hs-identifier hs-var">mkBody</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684423112"><span class="hs-identifier hs-var">stms</span></a></span><span> </span><span class="annot"><span class="annottext">(Result -&gt; Body GPU) -&gt; Result -&gt; Body GPU
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BodyT SOACS -&gt; Result
forall rep. BodyT rep -&gt; Result
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var hs-var">bodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT SOACS
</span><a href="#local-6989586621684423113"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-254"></span><span>
</span><span id="line-255"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#transformStms"><span class="hs-identifier hs-type">transformStms</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#KernelPath"><span class="hs-identifier hs-type">KernelPath</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.SOACS.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#DistribM"><span class="hs-identifier hs-type">DistribM</span></a></span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#GPUStms"><span class="hs-identifier hs-type">GPUStms</span></a></span><span>
</span><span id="line-256"></span><span id="transformStms"><span class="annot"><span class="annottext">transformStms :: KernelPath -&gt; [Stm SOACS] -&gt; DistribM (Stms GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#transformStms"><span class="hs-identifier hs-var hs-var">transformStms</span></a></span></span><span> </span><span class="annot"><span class="annottext">KernelPath
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-257"></span><span>  </span><span class="annot"><span class="annottext">Stms GPU -&gt; DistribM (Stms GPU)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Stms GPU
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-258"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#transformStms"><span class="hs-identifier hs-var">transformStms</span></a></span><span> </span><span id="local-6989586621684423107"><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684423107"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684423106"><span class="annot"><span class="annottext">Stm SOACS
</span><a href="#local-6989586621684423106"><span class="hs-identifier hs-var">stm</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684423105"><span class="annot"><span class="annottext">[Stm SOACS]
</span><a href="#local-6989586621684423105"><span class="hs-identifier hs-var">stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-259"></span><span>  </span><span class="annot"><span class="annottext">Stm SOACS -&gt; DistribM (Maybe (Stms SOACS))
</span><a href="Futhark.Pass.ExtractKernels.html#sequentialisedUnbalancedStm"><span class="hs-identifier hs-var">sequentialisedUnbalancedStm</span></a></span><span> </span><span class="annot"><span class="annottext">Stm SOACS
</span><a href="#local-6989586621684423106"><span class="hs-identifier hs-var">stm</span></a></span><span> </span><span class="annot"><span class="annottext">DistribM (Maybe (Stms SOACS))
-&gt; (Maybe (Stms SOACS) -&gt; DistribM (Stms GPU))
-&gt; DistribM (Stms GPU)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-260"></span><span>    </span><span class="annot"><span class="annottext">Maybe (Stms SOACS)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-261"></span><span>      </span><span id="local-6989586621684423103"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684423103"><span class="hs-identifier hs-var">stm'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">KernelPath -&gt; Stm SOACS -&gt; DistribM (Stms GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#transformStm"><span class="hs-identifier hs-var">transformStm</span></a></span><span> </span><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684423107"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="annot"><span class="annottext">Stm SOACS
</span><a href="#local-6989586621684423106"><span class="hs-identifier hs-var">stm</span></a></span><span>
</span><span id="line-262"></span><span>      </span><span class="annot"><span class="annottext">Stms GPU -&gt; DistribM (Stms GPU) -&gt; DistribM (Stms GPU)
forall rep a (m :: * -&gt; *) b.
(Scoped rep a, LocalScope rep m) =&gt;
a -&gt; m b -&gt; m b
</span><a href="Futhark.IR.Prop.Scope.html#inScopeOf"><span class="hs-identifier hs-var">inScopeOf</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684423103"><span class="hs-identifier hs-var">stm'</span></a></span><span> </span><span class="annot"><span class="annottext">(DistribM (Stms GPU) -&gt; DistribM (Stms GPU))
-&gt; DistribM (Stms GPU) -&gt; DistribM (Stms GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-263"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684423103"><span class="hs-identifier hs-var">stm'</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPU -&gt; Stms GPU -&gt; Stms GPU
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Stms GPU -&gt; Stms GPU)
-&gt; DistribM (Stms GPU) -&gt; DistribM (Stms GPU)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">KernelPath -&gt; [Stm SOACS] -&gt; DistribM (Stms GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#transformStms"><span class="hs-identifier hs-var">transformStms</span></a></span><span> </span><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684423107"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="annot"><span class="annottext">[Stm SOACS]
</span><a href="#local-6989586621684423105"><span class="hs-identifier hs-var">stms</span></a></span><span>
</span><span id="line-264"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684423099"><span class="annot"><span class="annottext">Stms SOACS
</span><a href="#local-6989586621684423099"><span class="hs-identifier hs-var">stms'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-265"></span><span>      </span><span class="annot"><span class="annottext">KernelPath -&gt; [Stm SOACS] -&gt; DistribM (Stms GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#transformStms"><span class="hs-identifier hs-var">transformStms</span></a></span><span> </span><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684423107"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="annot"><span class="annottext">([Stm SOACS] -&gt; DistribM (Stms GPU))
-&gt; [Stm SOACS] -&gt; DistribM (Stms GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stms SOACS -&gt; [Stm SOACS]
forall rep. Stms rep -&gt; [Stm rep]
</span><a href="Futhark.IR.Syntax.html#stmsToList"><span class="hs-identifier hs-var">stmsToList</span></a></span><span> </span><span class="annot"><span class="annottext">Stms SOACS
</span><a href="#local-6989586621684423099"><span class="hs-identifier hs-var">stms'</span></a></span><span> </span><span class="annot"><span class="annottext">[Stm SOACS] -&gt; [Stm SOACS] -&gt; [Stm SOACS]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Stm SOACS]
</span><a href="#local-6989586621684423105"><span class="hs-identifier hs-var">stms</span></a></span><span>
</span><span id="line-266"></span><span>
</span><span id="line-267"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#unbalancedLambda"><span class="hs-identifier hs-type">unbalancedLambda</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-268"></span><span id="unbalancedLambda"><span class="annot"><span class="annottext">unbalancedLambda :: Lambda -&gt; Bool
</span><a href="Futhark.Pass.ExtractKernels.html#unbalancedLambda"><span class="hs-identifier hs-var hs-var">unbalancedLambda</span></a></span></span><span> </span><span id="local-6989586621684423097"><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684423097"><span class="hs-identifier hs-var">orig_lam</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-269"></span><span>  </span><span class="annot"><span class="annottext">Names -&gt; BodyT SOACS -&gt; Bool
forall {rep} {rep}.
(Op rep ~ SOAC rep) =&gt;
Names -&gt; BodyT rep -&gt; Bool
</span><a href="#local-6989586621684423096"><span class="hs-identifier hs-var">unbalancedBody</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#namesFromList"><span class="hs-identifier hs-var">namesFromList</span></a></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; Names) -&gt; [VName] -&gt; Names
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Param Type -&gt; VName) -&gt; [Param Type] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Param Type -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">([Param Type] -&gt; [VName]) -&gt; [Param Type] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda -&gt; [LParam SOACS]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684423097"><span class="hs-identifier hs-var">orig_lam</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(BodyT SOACS -&gt; Bool) -&gt; BodyT SOACS -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-270"></span><span>    </span><span class="annot"><span class="annottext">Lambda -&gt; BodyT SOACS
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684423097"><span class="hs-identifier hs-var">orig_lam</span></a></span><span>
</span><span id="line-271"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-272"></span><span>    </span><span id="local-6989586621684423091"><span class="annot"><span class="annottext">subExpBound :: SubExp -&gt; Names -&gt; Bool
</span><a href="#local-6989586621684423091"><span class="hs-identifier hs-var hs-var">subExpBound</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684423089"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684423089"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684423088"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684423088"><span class="hs-identifier hs-var">bound</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684423089"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#nameIn"><span class="hs-operator hs-var">`nameIn`</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684423088"><span class="hs-identifier hs-var">bound</span></a></span><span>
</span><span id="line-273"></span><span>    </span><span class="annot"><a href="#local-6989586621684423091"><span class="hs-identifier hs-var">subExpBound</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span> </span><span class="annot"><span class="annottext">PrimValue
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Names
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-274"></span><span>
</span><span id="line-275"></span><span>    </span><span id="local-6989586621684423096"><span class="annot"><span class="annottext">unbalancedBody :: Names -&gt; BodyT rep -&gt; Bool
</span><a href="#local-6989586621684423096"><span class="hs-identifier hs-var hs-var">unbalancedBody</span></a></span></span><span> </span><span id="local-6989586621684423077"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684423077"><span class="hs-identifier hs-var">bound</span></a></span></span><span> </span><span id="local-6989586621684423076"><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684423076"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-276"></span><span>      </span><span class="annot"><span class="annottext">(Stm rep -&gt; Bool) -&gt; Seq (Stm rep) -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Names -&gt; ExpT rep -&gt; Bool
</span><a href="#local-6989586621684423074"><span class="hs-identifier hs-var">unbalancedStm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684423077"><span class="hs-identifier hs-var">bound</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">BodyT rep -&gt; Names
forall rep. Body rep -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#boundInBody"><span class="hs-identifier hs-var">boundInBody</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684423076"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ExpT rep -&gt; Bool) -&gt; (Stm rep -&gt; ExpT rep) -&gt; Stm rep -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; ExpT rep
forall rep. Stm rep -&gt; Exp rep
</span><a href="Futhark.IR.Syntax.html#stmExp"><span class="hs-identifier hs-var hs-var">stmExp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Seq (Stm rep) -&gt; Bool) -&gt; Seq (Stm rep) -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-277"></span><span>        </span><span class="annot"><span class="annottext">BodyT rep -&gt; Seq (Stm rep)
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684423076"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-278"></span><span>
</span><span id="line-279"></span><span>    </span><span class="hs-comment">-- XXX - our notion of balancing is probably still too naive.</span><span>
</span><span id="line-280"></span><span>    </span><span id="local-6989586621684423074"><span class="annot"><span class="annottext">unbalancedStm :: Names -&gt; ExpT rep -&gt; Bool
</span><a href="#local-6989586621684423074"><span class="hs-identifier hs-var hs-var">unbalancedStm</span></a></span></span><span> </span><span id="local-6989586621684423070"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684423070"><span class="hs-identifier hs-var">bound</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621684423067"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684423067"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StreamForm rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-281"></span><span>      </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684423067"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Names -&gt; Bool
</span><a href="#local-6989586621684423091"><span class="hs-operator hs-var">`subExpBound`</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684423070"><span class="hs-identifier hs-var">bound</span></a></span><span>
</span><span id="line-282"></span><span>    </span><span class="annot"><a href="#local-6989586621684423074"><span class="hs-identifier hs-var">unbalancedStm</span></a></span><span> </span><span id="local-6989586621684423066"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684423066"><span class="hs-identifier hs-var">bound</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Screma"><span class="hs-identifier hs-type">Screma</span></a></span><span> </span><span id="local-6989586621684423064"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684423064"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ScremaForm rep
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-283"></span><span>      </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684423064"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Names -&gt; Bool
</span><a href="#local-6989586621684423091"><span class="hs-operator hs-var">`subExpBound`</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684423066"><span class="hs-identifier hs-var">bound</span></a></span><span>
</span><span id="line-284"></span><span>    </span><span class="annot"><a href="#local-6989586621684423074"><span class="hs-identifier hs-var">unbalancedStm</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-285"></span><span>      </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-286"></span><span>    </span><span class="annot"><a href="#local-6989586621684423074"><span class="hs-identifier hs-var">unbalancedStm</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#DoLoop"><span class="hs-identifier hs-type">DoLoop</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-287"></span><span>    </span><span class="annot"><a href="#local-6989586621684423074"><span class="hs-identifier hs-var">unbalancedStm</span></a></span><span> </span><span id="local-6989586621684423062"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684423062"><span class="hs-identifier hs-var">bound</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#WithAcc"><span class="hs-identifier hs-type">WithAcc</span></a></span><span> </span><span class="annot"><span class="annottext">[WithAccInput rep]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684423060"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684423060"><span class="hs-identifier hs-var">lam</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-288"></span><span>      </span><span class="annot"><span class="annottext">Names -&gt; BodyT rep -&gt; Bool
</span><a href="#local-6989586621684423096"><span class="hs-identifier hs-var">unbalancedBody</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684423062"><span class="hs-identifier hs-var">bound</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda rep -&gt; BodyT rep
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684423060"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-289"></span><span>    </span><span class="annot"><a href="#local-6989586621684423074"><span class="hs-identifier hs-var">unbalancedStm</span></a></span><span> </span><span id="local-6989586621684423059"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684423059"><span class="hs-identifier hs-var">bound</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#If"><span class="hs-identifier hs-type">If</span></a></span><span> </span><span id="local-6989586621684423057"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684423057"><span class="hs-identifier hs-var">cond</span></a></span></span><span> </span><span id="local-6989586621684423056"><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684423056"><span class="hs-identifier hs-var">tbranch</span></a></span></span><span> </span><span id="local-6989586621684423055"><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684423055"><span class="hs-identifier hs-var">fbranch</span></a></span></span><span> </span><span class="annot"><span class="annottext">IfDec (BranchType rep)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-290"></span><span>      </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684423057"><span class="hs-identifier hs-var">cond</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Names -&gt; Bool
</span><a href="#local-6989586621684423091"><span class="hs-operator hs-var">`subExpBound`</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684423059"><span class="hs-identifier hs-var">bound</span></a></span><span>
</span><span id="line-291"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Names -&gt; BodyT rep -&gt; Bool
</span><a href="#local-6989586621684423096"><span class="hs-identifier hs-var">unbalancedBody</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684423059"><span class="hs-identifier hs-var">bound</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684423056"><span class="hs-identifier hs-var">tbranch</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Names -&gt; BodyT rep -&gt; Bool
</span><a href="#local-6989586621684423096"><span class="hs-identifier hs-var">unbalancedBody</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684423059"><span class="hs-identifier hs-var">bound</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684423055"><span class="hs-identifier hs-var">fbranch</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-292"></span><span>    </span><span class="annot"><a href="#local-6989586621684423074"><span class="hs-identifier hs-var">unbalancedStm</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">BasicOp
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-293"></span><span>      </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-294"></span><span>    </span><span class="annot"><a href="#local-6989586621684423074"><span class="hs-identifier hs-var">unbalancedStm</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Apply"><span class="hs-identifier hs-type">Apply</span></a></span><span> </span><span id="local-6989586621684423050"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684423050"><span class="hs-identifier hs-var">fname</span></a></span></span><span> </span><span class="annot"><span class="annottext">[(SubExp, Diet)]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[RetType rep]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">(Safety, SrcLoc, [SrcLoc])
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-295"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Bool
</span><a href="Futhark.IR.Prop.html#isBuiltInFunction"><span class="hs-identifier hs-var">isBuiltInFunction</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684423050"><span class="hs-identifier hs-var">fname</span></a></span><span>
</span><span id="line-296"></span><span>
</span><span id="line-297"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#sequentialisedUnbalancedStm"><span class="hs-identifier hs-type">sequentialisedUnbalancedStm</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#DistribM"><span class="hs-identifier hs-type">DistribM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-298"></span><span id="sequentialisedUnbalancedStm"><span class="annot"><span class="annottext">sequentialisedUnbalancedStm :: Stm SOACS -&gt; DistribM (Maybe (Stms SOACS))
</span><a href="Futhark.Pass.ExtractKernels.html#sequentialisedUnbalancedStm"><span class="hs-identifier hs-var hs-var">sequentialisedUnbalancedStm</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684423046"><span class="annot"><span class="annottext">Pat SOACS
</span><a href="#local-6989586621684423046"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec SOACS)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span id="local-6989586621684423045"><span class="annot"><span class="annottext">soac :: Op SOACS
</span><a href="#local-6989586621684423045"><span class="hs-identifier hs-var">soac</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Screma"><span class="hs-identifier hs-type">Screma</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684423044"><span class="annot"><span class="annottext">ScremaForm SOACS
</span><a href="#local-6989586621684423044"><span class="hs-identifier hs-var">form</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-299"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Reduce SOACS]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684423043"><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684423043"><span class="hs-identifier hs-var">lam2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ScremaForm SOACS -&gt; Maybe ([Reduce SOACS], Lambda)
forall rep. ScremaForm rep -&gt; Maybe ([Reduce rep], Lambda rep)
</span><a href="Futhark.IR.SOACS.SOAC.html#isRedomapSOAC"><span class="hs-identifier hs-var">isRedomapSOAC</span></a></span><span> </span><span class="annot"><span class="annottext">ScremaForm SOACS
</span><a href="#local-6989586621684423044"><span class="hs-identifier hs-var">form</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-300"></span><span>    </span><span class="annot"><span class="annottext">Lambda -&gt; Bool
</span><a href="Futhark.Pass.ExtractKernels.html#unbalancedLambda"><span class="hs-identifier hs-var">unbalancedLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684423043"><span class="hs-identifier hs-var">lam2</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-301"></span><span>    </span><span class="annot"><span class="annottext">Lambda -&gt; Bool
</span><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#lambdaContainsParallelism"><span class="hs-identifier hs-var">lambdaContainsParallelism</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684423043"><span class="hs-identifier hs-var">lam2</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-302"></span><span>    </span><span id="local-6989586621684423040"><span class="annot"><span class="annottext">Scope SOACS
</span><a href="#local-6989586621684423040"><span class="hs-identifier hs-var">types</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Scope GPU -&gt; Scope SOACS) -&gt; DistribM (Scope SOACS)
forall rep (m :: * -&gt; *) a.
HasScope rep m =&gt;
(Scope rep -&gt; a) -&gt; m a
</span><a href="Futhark.IR.Prop.Scope.html#asksScope"><span class="hs-identifier hs-var">asksScope</span></a></span><span> </span><span class="annot"><span class="annottext">Scope GPU -&gt; Scope SOACS
</span><a href="Futhark.Pass.ExtractKernels.ToGPU.html#scopeForSOACs"><span class="hs-identifier hs-var">scopeForSOACs</span></a></span><span>
</span><span id="line-303"></span><span>    </span><span class="annot"><span class="annottext">Stms SOACS -&gt; Maybe (Stms SOACS)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Stms SOACS -&gt; Maybe (Stms SOACS))
-&gt; (((), Stms SOACS) -&gt; Stms SOACS)
-&gt; ((), Stms SOACS)
-&gt; Maybe (Stms SOACS)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">((), Stms SOACS) -&gt; Stms SOACS
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">(((), Stms SOACS) -&gt; Maybe (Stms SOACS))
-&gt; DistribM ((), Stms SOACS) -&gt; DistribM (Maybe (Stms SOACS))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">BuilderT SOACS DistribM ()
-&gt; Scope SOACS -&gt; DistribM ((), Stms SOACS)
forall (m :: * -&gt; *) rep a.
MonadFreshNames m =&gt;
BuilderT rep m a -&gt; Scope rep -&gt; m (a, Stms rep)
</span><a href="Futhark.Builder.html#runBuilderT"><span class="hs-identifier hs-var">runBuilderT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pat (Rep (BuilderT SOACS DistribM))
-&gt; SOAC (Rep (BuilderT SOACS DistribM))
-&gt; BuilderT SOACS DistribM ()
forall (m :: * -&gt; *).
Transformer m =&gt;
Pat (Rep m) -&gt; SOAC (Rep m) -&gt; m ()
</span><a href="Futhark.Transform.FirstOrderTransform.html#transformSOAC"><span class="hs-identifier hs-var">FOT.transformSOAC</span></a></span><span> </span><span class="annot"><span class="annottext">Pat (Rep (BuilderT SOACS DistribM))
Pat SOACS
</span><a href="#local-6989586621684423046"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">Op SOACS
SOAC (Rep (BuilderT SOACS DistribM))
</span><a href="#local-6989586621684423045"><span class="hs-identifier hs-var">soac</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Scope SOACS
</span><a href="#local-6989586621684423040"><span class="hs-identifier hs-var">types</span></a></span><span>
</span><span id="line-304"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#sequentialisedUnbalancedStm"><span class="hs-identifier hs-var">sequentialisedUnbalancedStm</span></a></span><span> </span><span class="annot"><span class="annottext">Stm SOACS
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-305"></span><span>  </span><span class="annot"><span class="annottext">Maybe (Stms SOACS) -&gt; DistribM (Maybe (Stms SOACS))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Stms SOACS)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-306"></span><span>
</span><span id="line-307"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#cmpSizeLe"><span class="hs-identifier hs-type">cmpSizeLe</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-308"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-309"></span><span>  </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#SizeClass"><span class="hs-identifier hs-type">Out.SizeClass</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-310"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-311"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#DistribM"><span class="hs-identifier hs-type">DistribM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Out.Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">Out.GPU</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-312"></span><span id="cmpSizeLe"><span class="annot"><span class="annottext">cmpSizeLe :: [Char]
-&gt; SizeClass -&gt; [SubExp] -&gt; DistribM ((SubExp, Name), Stms GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#cmpSizeLe"><span class="hs-identifier hs-var hs-var">cmpSizeLe</span></a></span></span><span> </span><span id="local-6989586621684423034"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684423034"><span class="hs-identifier hs-var">desc</span></a></span></span><span> </span><span id="local-6989586621684423033"><span class="annot"><span class="annottext">SizeClass
</span><a href="#local-6989586621684423033"><span class="hs-identifier hs-var">size_class</span></a></span></span><span> </span><span id="local-6989586621684423032"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684423032"><span class="hs-identifier hs-var">to_what</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-313"></span><span>  </span><span id="local-6989586621684423031"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684423031"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(State -&gt; Int) -&gt; DistribM Int
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">State -&gt; Int
</span><a href="Futhark.Pass.ExtractKernels.html#stateThresholdCounter"><span class="hs-identifier hs-var hs-var">stateThresholdCounter</span></a></span><span>
</span><span id="line-314"></span><span>  </span><span class="annot"><span class="annottext">(State -&gt; State) -&gt; DistribM ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((State -&gt; State) -&gt; DistribM ())
-&gt; (State -&gt; State) -&gt; DistribM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684423030"><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621684423030"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621684423030"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">stateThresholdCounter :: Int
</span><a href="Futhark.Pass.ExtractKernels.html#stateThresholdCounter"><span class="hs-identifier hs-var">stateThresholdCounter</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684423031"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">}</span><span>
</span><span id="line-315"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684423028"><span class="annot"><span class="annottext">size_key :: Name
</span><a href="#local-6989586621684423028"><span class="hs-identifier hs-var hs-var">size_key</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Name
</span><a href="Language.Futhark.Core.html#nameFromString"><span class="hs-identifier hs-var">nameFromString</span></a></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; Name) -&gt; [Char] -&gt; Name
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684423034"><span class="hs-identifier hs-var">desc</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;_&quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684423031"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-316"></span><span>  </span><span class="annot"><span class="annottext">Builder GPU (SubExp, Name) -&gt; DistribM ((SubExp, Name), Stms GPU)
forall (m :: * -&gt; *) somerep rep a.
(MonadFreshNames m, HasScope somerep m, SameScope somerep rep) =&gt;
Builder rep a -&gt; m (a, Stms rep)
</span><a href="Futhark.Builder.html#runBuilder"><span class="hs-identifier hs-var">runBuilder</span></a></span><span> </span><span class="annot"><span class="annottext">(Builder GPU (SubExp, Name) -&gt; DistribM ((SubExp, Name), Stms GPU))
-&gt; Builder GPU (SubExp, Name)
-&gt; DistribM ((SubExp, Name), Stms GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-317"></span><span>    </span><span id="local-6989586621684423024"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684423024"><span class="hs-identifier hs-var">to_what'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-318"></span><span>      </span><span class="annot"><span class="annottext">[Char]
-&gt; Exp (Rep (BuilderT GPU (State VNameSource)))
-&gt; BuilderT GPU (State VNameSource) SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[Char] -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;comparatee&quot;</span></span><span>
</span><span id="line-319"></span><span>        </span><span class="annot"><span class="annottext">(ExpT GPU -&gt; BuilderT GPU (State VNameSource) SubExp)
-&gt; BuilderT GPU (State VNameSource) (ExpT GPU)
-&gt; BuilderT GPU (State VNameSource) SubExp
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">BinOp
-&gt; SubExp
-&gt; [SubExp]
-&gt; BuilderT
     GPU
     (State VNameSource)
     (Exp (Rep (BuilderT GPU (State VNameSource))))
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
BinOp -&gt; SubExp -&gt; [SubExp] -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#foldBinOp"><span class="hs-identifier hs-var">foldBinOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Overflow -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#Mul"><span class="hs-identifier hs-var">Mul</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Overflow
</span><a href="Futhark.IR.Primitive.html#OverflowUndef"><span class="hs-identifier hs-var">OverflowUndef</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Integer -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#intConst"><span class="hs-identifier hs-var">intConst</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684423032"><span class="hs-identifier hs-var">to_what</span></a></span><span>
</span><span id="line-320"></span><span>    </span><span id="local-6989586621684423016"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684423016"><span class="hs-identifier hs-var">cmp_res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Char]
-&gt; Exp (Rep (BuilderT GPU (State VNameSource)))
-&gt; BuilderT GPU (State VNameSource) SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[Char] -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684423034"><span class="hs-identifier hs-var">desc</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (BuilderT GPU (State VNameSource)))
 -&gt; BuilderT GPU (State VNameSource) SubExp)
-&gt; Exp (Rep (BuilderT GPU (State VNameSource)))
-&gt; BuilderT GPU (State VNameSource) SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Op GPU -&gt; ExpT GPU
forall rep. Op rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-var">Op</span></a></span><span> </span><span class="annot"><span class="annottext">(Op GPU -&gt; ExpT GPU) -&gt; Op GPU -&gt; ExpT GPU
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SizeOp -&gt; HostOp GPU (SOAC GPU)
forall rep op. SizeOp -&gt; HostOp rep op
</span><a href="Futhark.IR.GPU.Op.html#SizeOp"><span class="hs-identifier hs-var">SizeOp</span></a></span><span> </span><span class="annot"><span class="annottext">(SizeOp -&gt; HostOp GPU (SOAC GPU))
-&gt; SizeOp -&gt; HostOp GPU (SOAC GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; SizeClass -&gt; SubExp -&gt; SizeOp
</span><a href="Futhark.IR.GPU.Op.html#CmpSizeLe"><span class="hs-identifier hs-var">CmpSizeLe</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684423028"><span class="hs-identifier hs-var">size_key</span></a></span><span> </span><span class="annot"><span class="annottext">SizeClass
</span><a href="#local-6989586621684423033"><span class="hs-identifier hs-var">size_class</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684423024"><span class="hs-identifier hs-var">to_what'</span></a></span><span>
</span><span id="line-321"></span><span>    </span><span class="annot"><span class="annottext">(SubExp, Name) -&gt; Builder GPU (SubExp, Name)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684423016"><span class="hs-identifier hs-var">cmp_res</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684423028"><span class="hs-identifier hs-var">size_key</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-322"></span><span>
</span><span id="line-323"></span><span id="local-6989586621684424170"><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#kernelAlternatives"><span class="hs-identifier hs-type">kernelAlternatives</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-324"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.MonadFreshNames.html#MonadFreshNames"><span class="hs-identifier hs-type">MonadFreshNames</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684424170"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#HasScope"><span class="hs-identifier hs-type">HasScope</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">Out.GPU</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684424170"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-325"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Out.Pat</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">Out.GPU</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-326"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Out.Body</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">Out.GPU</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-327"></span><span>  </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Out.Body</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">Out.GPU</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-328"></span><span>  </span><span class="annot"><a href="#local-6989586621684424170"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Out.Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">Out.GPU</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-329"></span><span id="kernelAlternatives"><span class="annot"><span class="annottext">kernelAlternatives :: forall (m :: * -&gt; *).
(MonadFreshNames m, HasScope GPU m) =&gt;
Pat GPU -&gt; Body GPU -&gt; [(SubExp, Body GPU)] -&gt; m (Stms GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#kernelAlternatives"><span class="hs-identifier hs-var hs-var">kernelAlternatives</span></a></span></span><span> </span><span id="local-6989586621684422976"><span class="annot"><span class="annottext">Pat GPU
</span><a href="#local-6989586621684422976"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684422975"><span class="annot"><span class="annottext">Body GPU
</span><a href="#local-6989586621684422975"><span class="hs-identifier hs-var">default_body</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Builder GPU () -&gt; m (Stms GPU)
forall (m :: * -&gt; *) somerep rep a.
(MonadFreshNames m, HasScope somerep m, SameScope somerep rep) =&gt;
Builder rep a -&gt; m (Stms rep)
</span><a href="Futhark.Builder.html#runBuilder_"><span class="hs-identifier hs-var">runBuilder_</span></a></span><span> </span><span class="annot"><span class="annottext">(Builder GPU () -&gt; m (Stms GPU)) -&gt; Builder GPU () -&gt; m (Stms GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-330"></span><span>  </span><span id="local-6989586621684422973"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684422973"><span class="hs-identifier hs-var">ses</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Body (Rep (BuilderT GPU (State VNameSource)))
-&gt; BuilderT GPU (State VNameSource) Result
forall (m :: * -&gt; *). MonadBuilder m =&gt; Body (Rep m) -&gt; m Result
</span><a href="Futhark.Builder.Class.html#bodyBind"><span class="hs-identifier hs-var">bodyBind</span></a></span><span> </span><span class="annot"><span class="annottext">Body (Rep (BuilderT GPU (State VNameSource)))
Body GPU
</span><a href="#local-6989586621684422975"><span class="hs-identifier hs-var">default_body</span></a></span><span>
</span><span id="line-331"></span><span>  </span><span class="annot"><span class="annottext">[(VName, SubExpRes)]
-&gt; ((VName, SubExpRes) -&gt; Builder GPU ()) -&gt; Builder GPU ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; Result -&gt; [(VName, SubExpRes)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatT Type -&gt; [VName]
forall dec. PatT dec -&gt; [VName]
</span><a href="Futhark.IR.Prop.Patterns.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="annot"><span class="annottext">PatT Type
Pat GPU
</span><a href="#local-6989586621684422976"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684422973"><span class="hs-identifier hs-var">ses</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((VName, SubExpRes) -&gt; Builder GPU ()) -&gt; Builder GPU ())
-&gt; ((VName, SubExpRes) -&gt; Builder GPU ()) -&gt; Builder GPU ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684422969"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684422969"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-type">SubExpRes</span></a></span><span> </span><span id="local-6989586621684422967"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684422967"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span id="local-6989586621684422966"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422966"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-332"></span><span>    </span><span class="annot"><span class="annottext">Certs -&gt; Builder GPU () -&gt; Builder GPU ()
forall (m :: * -&gt; *) a. MonadBuilder m =&gt; Certs -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#certifying"><span class="hs-identifier hs-var">certifying</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684422967"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">(Builder GPU () -&gt; Builder GPU ())
-&gt; Builder GPU () -&gt; Builder GPU ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName]
-&gt; Exp (Rep (BuilderT GPU (State VNameSource))) -&gt; Builder GPU ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[VName] -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBindNames"><span class="hs-identifier hs-var">letBindNames</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684422969"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (BuilderT GPU (State VNameSource))) -&gt; Builder GPU ())
-&gt; Exp (Rep (BuilderT GPU (State VNameSource))) -&gt; Builder GPU ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT GPU
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT GPU) -&gt; BasicOp -&gt; ExpT GPU
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#SubExp"><span class="hs-identifier hs-var">SubExp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422966"><span class="hs-identifier hs-var">se</span></a></span><span>
</span><span id="line-333"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#kernelAlternatives"><span class="hs-identifier hs-var">kernelAlternatives</span></a></span><span> </span><span id="local-6989586621684422962"><span class="annot"><span class="annottext">Pat GPU
</span><a href="#local-6989586621684422962"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684422961"><span class="annot"><span class="annottext">Body GPU
</span><a href="#local-6989586621684422961"><span class="hs-identifier hs-var">default_body</span></a></span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621684422960"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422960"><span class="hs-identifier hs-var">cond</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684422959"><span class="annot"><span class="annottext">Body GPU
</span><a href="#local-6989586621684422959"><span class="hs-identifier hs-var">alt</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684422958"><span class="annot"><span class="annottext">[(SubExp, Body GPU)]
</span><a href="#local-6989586621684422958"><span class="hs-identifier hs-var">alts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Builder GPU () -&gt; m (Stms GPU)
forall (m :: * -&gt; *) somerep rep a.
(MonadFreshNames m, HasScope somerep m, SameScope somerep rep) =&gt;
Builder rep a -&gt; m (Stms rep)
</span><a href="Futhark.Builder.html#runBuilder_"><span class="hs-identifier hs-var">runBuilder_</span></a></span><span> </span><span class="annot"><span class="annottext">(Builder GPU () -&gt; m (Stms GPU)) -&gt; Builder GPU () -&gt; m (Stms GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-334"></span><span>  </span><span id="local-6989586621684422957"><span class="annot"><span class="annottext">PatT Type
</span><a href="#local-6989586621684422957"><span class="hs-identifier hs-var">alts_pat</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">([PatElemT Type] -&gt; PatT Type)
-&gt; BuilderT GPU (State VNameSource) [PatElemT Type]
-&gt; BuilderT GPU (State VNameSource) (PatT Type)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">[PatElemT Type] -&gt; PatT Type
forall dec. [PatElemT dec] -&gt; PatT dec
</span><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-var">Pat</span></a></span><span> </span><span class="annot"><span class="annottext">(BuilderT GPU (State VNameSource) [PatElemT Type]
 -&gt; BuilderT GPU (State VNameSource) (PatT Type))
-&gt; ((PatElemT Type
     -&gt; BuilderT GPU (State VNameSource) (PatElemT Type))
    -&gt; BuilderT GPU (State VNameSource) [PatElemT Type])
-&gt; (PatElemT Type
    -&gt; BuilderT GPU (State VNameSource) (PatElemT Type))
-&gt; BuilderT GPU (State VNameSource) (PatT Type)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[PatElemT Type]
-&gt; (PatElemT Type
    -&gt; BuilderT GPU (State VNameSource) (PatElemT Type))
-&gt; BuilderT GPU (State VNameSource) [PatElemT Type]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatT Type -&gt; [PatElemT Type]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span> </span><span class="annot"><span class="annottext">PatT Type
Pat GPU
</span><a href="#local-6989586621684422962"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((PatElemT Type
  -&gt; BuilderT GPU (State VNameSource) (PatElemT Type))
 -&gt; BuilderT GPU (State VNameSource) (PatT Type))
-&gt; (PatElemT Type
    -&gt; BuilderT GPU (State VNameSource) (PatElemT Type))
-&gt; BuilderT GPU (State VNameSource) (PatT Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684422953"><span class="annot"><span class="annottext">PatElemT Type
</span><a href="#local-6989586621684422953"><span class="hs-identifier hs-var">pe</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-335"></span><span>    </span><span id="local-6989586621684422952"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684422952"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; BuilderT GPU (State VNameSource) VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; [Char] -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; BuilderT GPU (State VNameSource) VName)
-&gt; [Char] -&gt; BuilderT GPU (State VNameSource) VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [Char]
</span><a href="Language.Futhark.Core.html#baseString"><span class="hs-identifier hs-var">baseString</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; [Char]) -&gt; VName -&gt; [Char]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatElemT Type -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT Type
</span><a href="#local-6989586621684422953"><span class="hs-identifier hs-var">pe</span></a></span><span>
</span><span id="line-336"></span><span>    </span><span class="annot"><span class="annottext">PatElemT Type -&gt; BuilderT GPU (State VNameSource) (PatElemT Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">PatElemT Type
</span><a href="#local-6989586621684422953"><span class="hs-identifier hs-var">pe</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">patElemName :: VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var">patElemName</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684422952"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-337"></span><span>
</span><span id="line-338"></span><span>  </span><span id="local-6989586621684422948"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684422948"><span class="hs-identifier hs-var">alt_stms</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Pat GPU
-&gt; Body GPU
-&gt; [(SubExp, Body GPU)]
-&gt; BuilderT GPU (State VNameSource) (Stms GPU)
forall (m :: * -&gt; *).
(MonadFreshNames m, HasScope GPU m) =&gt;
Pat GPU -&gt; Body GPU -&gt; [(SubExp, Body GPU)] -&gt; m (Stms GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#kernelAlternatives"><span class="hs-identifier hs-var">kernelAlternatives</span></a></span><span> </span><span class="annot"><span class="annottext">PatT Type
Pat GPU
</span><a href="#local-6989586621684422957"><span class="hs-identifier hs-var">alts_pat</span></a></span><span> </span><span class="annot"><span class="annottext">Body GPU
</span><a href="#local-6989586621684422961"><span class="hs-identifier hs-var">default_body</span></a></span><span> </span><span class="annot"><span class="annottext">[(SubExp, Body GPU)]
</span><a href="#local-6989586621684422958"><span class="hs-identifier hs-var">alts</span></a></span><span>
</span><span id="line-339"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684422947"><span class="annot"><span class="annottext">alt_body :: Body GPU
</span><a href="#local-6989586621684422947"><span class="hs-identifier hs-var hs-var">alt_body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stms GPU -&gt; Result -&gt; Body GPU
forall rep. Buildable rep =&gt; Stms rep -&gt; Result -&gt; Body rep
</span><a href="Futhark.Builder.Class.html#mkBody"><span class="hs-identifier hs-var">mkBody</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684422948"><span class="hs-identifier hs-var">alt_stms</span></a></span><span> </span><span class="annot"><span class="annottext">(Result -&gt; Body GPU) -&gt; Result -&gt; Body GPU
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Result
</span><a href="Futhark.IR.Syntax.html#varsRes"><span class="hs-identifier hs-var">varsRes</span></a></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; Result) -&gt; [VName] -&gt; Result
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatT Type -&gt; [VName]
forall dec. PatT dec -&gt; [VName]
</span><a href="Futhark.IR.Prop.Patterns.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="annot"><span class="annottext">PatT Type
</span><a href="#local-6989586621684422957"><span class="hs-identifier hs-var">alts_pat</span></a></span><span>
</span><span id="line-340"></span><span>
</span><span id="line-341"></span><span>  </span><span class="annot"><span class="annottext">Pat (Rep (BuilderT GPU (State VNameSource)))
-&gt; Exp (Rep (BuilderT GPU (State VNameSource))) -&gt; Builder GPU ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">Pat (Rep (BuilderT GPU (State VNameSource)))
Pat GPU
</span><a href="#local-6989586621684422962"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (BuilderT GPU (State VNameSource))) -&gt; Builder GPU ())
-&gt; Exp (Rep (BuilderT GPU (State VNameSource))) -&gt; Builder GPU ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-342"></span><span>    </span><span class="annot"><span class="annottext">SubExp
-&gt; Body GPU -&gt; Body GPU -&gt; IfDec (BranchType GPU) -&gt; ExpT GPU
forall rep.
SubExp
-&gt; BodyT rep -&gt; BodyT rep -&gt; IfDec (BranchType rep) -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#If"><span class="hs-identifier hs-var">If</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422960"><span class="hs-identifier hs-var">cond</span></a></span><span> </span><span class="annot"><span class="annottext">Body GPU
</span><a href="#local-6989586621684422959"><span class="hs-identifier hs-var">alt</span></a></span><span> </span><span class="annot"><span class="annottext">Body GPU
</span><a href="#local-6989586621684422947"><span class="hs-identifier hs-var">alt_body</span></a></span><span> </span><span class="annot"><span class="annottext">(IfDec (BranchType GPU) -&gt; ExpT GPU)
-&gt; IfDec (BranchType GPU) -&gt; ExpT GPU
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-343"></span><span>      </span><span class="annot"><span class="annottext">[ExtType] -&gt; IfSort -&gt; IfDec ExtType
forall rt. [rt] -&gt; IfSort -&gt; IfDec rt
</span><a href="Futhark.IR.Syntax.html#IfDec"><span class="hs-identifier hs-var">IfDec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Type] -&gt; [ExtType]
forall u.
[TypeBase (ShapeBase SubExp) u] -&gt; [TypeBase (ShapeBase ExtSize) u]
</span><a href="Futhark.IR.Prop.Types.html#staticShapes"><span class="hs-identifier hs-var">staticShapes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatT Type -&gt; [Type]
forall dec. Typed dec =&gt; PatT dec -&gt; [Type]
</span><a href="Futhark.IR.Prop.Patterns.html#patTypes"><span class="hs-identifier hs-var">patTypes</span></a></span><span> </span><span class="annot"><span class="annottext">PatT Type
Pat GPU
</span><a href="#local-6989586621684422962"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IfSort
</span><a href="Futhark.IR.Syntax.html#IfEquiv"><span class="hs-identifier hs-var">IfEquiv</span></a></span><span>
</span><span id="line-344"></span><span>
</span><span id="line-345"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#transformLambda"><span class="hs-identifier hs-type">transformLambda</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#KernelPath"><span class="hs-identifier hs-type">KernelPath</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#DistribM"><span class="hs-identifier hs-type">DistribM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Out.Lambda</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">Out.GPU</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-346"></span><span id="transformLambda"><span class="annot"><span class="annottext">transformLambda :: KernelPath -&gt; Lambda -&gt; DistribM (Lambda GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#transformLambda"><span class="hs-identifier hs-var hs-var">transformLambda</span></a></span></span><span> </span><span id="local-6989586621684422939"><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422939"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span id="local-6989586621684422937"><span class="annot"><span class="annottext">[LParam SOACS]
</span><a href="#local-6989586621684422937"><span class="hs-identifier hs-var">params</span></a></span></span><span> </span><span id="local-6989586621684422936"><span class="annot"><span class="annottext">BodyT SOACS
</span><a href="#local-6989586621684422936"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span id="local-6989586621684422935"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684422935"><span class="hs-identifier hs-var">ret</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-347"></span><span>  </span><span class="annot"><span class="annottext">[LParam GPU] -&gt; Body GPU -&gt; [Type] -&gt; Lambda GPU
forall rep. [LParam rep] -&gt; BodyT rep -&gt; [Type] -&gt; LambdaT rep
</span><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-var">Lambda</span></a></span><span> </span><span class="annot"><span class="annottext">[LParam SOACS]
[LParam GPU]
</span><a href="#local-6989586621684422937"><span class="hs-identifier hs-var">params</span></a></span><span>
</span><span id="line-348"></span><span>    </span><span class="annot"><span class="annottext">(Body GPU -&gt; [Type] -&gt; Lambda GPU)
-&gt; DistribM (Body GPU) -&gt; DistribM ([Type] -&gt; Lambda GPU)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Scope GPU -&gt; DistribM (Body GPU) -&gt; DistribM (Body GPU)
forall rep (m :: * -&gt; *) a.
LocalScope rep m =&gt;
Scope rep -&gt; m a -&gt; m a
</span><a href="Futhark.IR.Prop.Scope.html#localScope"><span class="hs-identifier hs-var">localScope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param Type] -&gt; Scope GPU
forall rep dec. (LParamInfo rep ~ dec) =&gt; [Param dec] -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOfLParams"><span class="hs-identifier hs-var">scopeOfLParams</span></a></span><span> </span><span class="annot"><span class="annottext">[Param Type]
[LParam SOACS]
</span><a href="#local-6989586621684422937"><span class="hs-identifier hs-var">params</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelPath -&gt; BodyT SOACS -&gt; DistribM (Body GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#transformBody"><span class="hs-identifier hs-var">transformBody</span></a></span><span> </span><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422939"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT SOACS
</span><a href="#local-6989586621684422936"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-349"></span><span>    </span><span class="annot"><span class="annottext">DistribM ([Type] -&gt; Lambda GPU)
-&gt; DistribM [Type] -&gt; DistribM (Lambda GPU)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; DistribM [Type]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684422935"><span class="hs-identifier hs-var">ret</span></a></span><span>
</span><span id="line-350"></span><span>
</span><span id="line-351"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#transformStm"><span class="hs-identifier hs-type">transformStm</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#KernelPath"><span class="hs-identifier hs-type">KernelPath</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#DistribM"><span class="hs-identifier hs-type">DistribM</span></a></span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#GPUStms"><span class="hs-identifier hs-type">GPUStms</span></a></span><span>
</span><span id="line-352"></span><span id="transformStm"><span class="annot"><span class="annottext">transformStm :: KernelPath -&gt; Stm SOACS -&gt; DistribM (Stms GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#transformStm"><span class="hs-identifier hs-var hs-var">transformStm</span></a></span></span><span> </span><span class="annot"><span class="annottext">KernelPath
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684422933"><span class="annot"><span class="annottext">Stm SOACS
</span><a href="#local-6989586621684422933"><span class="hs-identifier hs-var">stm</span></a></span></span><span>
</span><span id="line-353"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Attr
</span><span class="hs-string">&quot;sequential&quot;</span></span><span> </span><span class="annot"><span class="annottext">Attr -&gt; Attrs -&gt; Bool
</span><a href="Futhark.IR.Syntax.Core.html#inAttrs"><span class="hs-operator hs-var">`inAttrs`</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux () -&gt; Attrs
forall dec. StmAux dec -&gt; Attrs
</span><a href="Futhark.IR.Syntax.html#stmAuxAttrs"><span class="hs-identifier hs-var hs-var">stmAuxAttrs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stm SOACS -&gt; StmAux (ExpDec SOACS)
forall rep. Stm rep -&gt; StmAux (ExpDec rep)
</span><a href="Futhark.IR.Syntax.html#stmAux"><span class="hs-identifier hs-var hs-var">stmAux</span></a></span><span> </span><span class="annot"><span class="annottext">Stm SOACS
</span><a href="#local-6989586621684422933"><span class="hs-identifier hs-var">stm</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-354"></span><span>    </span><span class="annot"><span class="annottext">Builder GPU () -&gt; DistribM (Stms GPU)
forall (m :: * -&gt; *) somerep rep a.
(MonadFreshNames m, HasScope somerep m, SameScope somerep rep) =&gt;
Builder rep a -&gt; m (Stms rep)
</span><a href="Futhark.Builder.html#runBuilder_"><span class="hs-identifier hs-var">runBuilder_</span></a></span><span> </span><span class="annot"><span class="annottext">(Builder GPU () -&gt; DistribM (Stms GPU))
-&gt; Builder GPU () -&gt; DistribM (Stms GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stm SOACS -&gt; Builder GPU ()
forall (m :: * -&gt; *).
(Transformer m, LetDec (Rep m) ~ LetDec SOACS) =&gt;
Stm SOACS -&gt; m ()
</span><a href="Futhark.Transform.FirstOrderTransform.html#transformStmRecursively"><span class="hs-identifier hs-var">FOT.transformStmRecursively</span></a></span><span> </span><span class="annot"><span class="annottext">Stm SOACS
</span><a href="#local-6989586621684422933"><span class="hs-identifier hs-var">stm</span></a></span><span>
</span><span id="line-355"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#transformStm"><span class="hs-identifier hs-var">transformStm</span></a></span><span> </span><span id="local-6989586621684422928"><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422928"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684422927"><span class="annot"><span class="annottext">Pat SOACS
</span><a href="#local-6989586621684422927"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684422926"><span class="annot"><span class="annottext">StmAux (ExpDec SOACS)
</span><a href="#local-6989586621684422926"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span id="local-6989586621684422925"><span class="annot"><span class="annottext">Op SOACS
</span><a href="#local-6989586621684422925"><span class="hs-identifier hs-var">soac</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-356"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Attr
</span><span class="hs-string">&quot;sequential_outer&quot;</span></span><span> </span><span class="annot"><span class="annottext">Attr -&gt; Attrs -&gt; Bool
</span><a href="Futhark.IR.Syntax.Core.html#inAttrs"><span class="hs-operator hs-var">`inAttrs`</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux () -&gt; Attrs
forall dec. StmAux dec -&gt; Attrs
</span><a href="Futhark.IR.Syntax.html#stmAuxAttrs"><span class="hs-identifier hs-var hs-var">stmAuxAttrs</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux ()
StmAux (ExpDec SOACS)
</span><a href="#local-6989586621684422926"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-357"></span><span>    </span><span class="annot"><span class="annottext">KernelPath -&gt; [Stm SOACS] -&gt; DistribM (Stms GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#transformStms"><span class="hs-identifier hs-var">transformStms</span></a></span><span> </span><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422928"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="annot"><span class="annottext">([Stm SOACS] -&gt; DistribM (Stms GPU))
-&gt; (Stms SOACS -&gt; [Stm SOACS]) -&gt; Stms SOACS -&gt; DistribM (Stms GPU)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Stms SOACS -&gt; [Stm SOACS]
forall rep. Stms rep -&gt; [Stm rep]
</span><a href="Futhark.IR.Syntax.html#stmsToList"><span class="hs-identifier hs-var">stmsToList</span></a></span><span> </span><span class="annot"><span class="annottext">(Stms SOACS -&gt; [Stm SOACS])
-&gt; (Stms SOACS -&gt; Stms SOACS) -&gt; Stms SOACS -&gt; [Stm SOACS]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Stm SOACS -&gt; Stm SOACS) -&gt; Stms SOACS -&gt; Stms SOACS
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Certs -&gt; Stm SOACS -&gt; Stm SOACS
forall rep. Certs -&gt; Stm rep -&gt; Stm rep
</span><a href="Futhark.IR.Prop.html#certify"><span class="hs-identifier hs-var">certify</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StmAux () -&gt; Certs
forall dec. StmAux dec -&gt; Certs
</span><a href="Futhark.IR.Syntax.html#stmAuxCerts"><span class="hs-identifier hs-var hs-var">stmAuxCerts</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux ()
StmAux (ExpDec SOACS)
</span><a href="#local-6989586621684422926"><span class="hs-identifier hs-var">aux</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-358"></span><span>      </span><span class="annot"><span class="annottext">(Stms SOACS -&gt; DistribM (Stms GPU))
-&gt; DistribM (Stms SOACS) -&gt; DistribM (Stms GPU)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">Builder SOACS () -&gt; DistribM (Stms SOACS)
forall (m :: * -&gt; *) somerep rep a.
(MonadFreshNames m, HasScope somerep m, SameScope somerep rep) =&gt;
Builder rep a -&gt; m (Stms rep)
</span><a href="Futhark.Builder.html#runBuilder_"><span class="hs-identifier hs-var">runBuilder_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pat (Rep (BuilderT SOACS (State VNameSource)))
-&gt; SOAC (Rep (BuilderT SOACS (State VNameSource)))
-&gt; Builder SOACS ()
forall (m :: * -&gt; *).
Transformer m =&gt;
Pat (Rep m) -&gt; SOAC (Rep m) -&gt; m ()
</span><a href="Futhark.Transform.FirstOrderTransform.html#transformSOAC"><span class="hs-identifier hs-var">FOT.transformSOAC</span></a></span><span> </span><span class="annot"><span class="annottext">Pat (Rep (BuilderT SOACS (State VNameSource)))
Pat SOACS
</span><a href="#local-6989586621684422927"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">Op SOACS
SOAC (Rep (BuilderT SOACS (State VNameSource)))
</span><a href="#local-6989586621684422925"><span class="hs-identifier hs-var">soac</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-359"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#transformStm"><span class="hs-identifier hs-var">transformStm</span></a></span><span> </span><span id="local-6989586621684422922"><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422922"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684422921"><span class="annot"><span class="annottext">Pat SOACS
</span><a href="#local-6989586621684422921"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684422920"><span class="annot"><span class="annottext">StmAux (ExpDec SOACS)
</span><a href="#local-6989586621684422920"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#If"><span class="hs-identifier hs-type">If</span></a></span><span> </span><span id="local-6989586621684422919"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422919"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span id="local-6989586621684422918"><span class="annot"><span class="annottext">BodyT SOACS
</span><a href="#local-6989586621684422918"><span class="hs-identifier hs-var">tb</span></a></span></span><span> </span><span id="local-6989586621684422917"><span class="annot"><span class="annottext">BodyT SOACS
</span><a href="#local-6989586621684422917"><span class="hs-identifier hs-var">fb</span></a></span></span><span> </span><span id="local-6989586621684422916"><span class="annot"><span class="annottext">IfDec (BranchType SOACS)
</span><a href="#local-6989586621684422916"><span class="hs-identifier hs-var">rt</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-360"></span><span>  </span><span id="local-6989586621684422915"><span class="annot"><span class="annottext">Body GPU
</span><a href="#local-6989586621684422915"><span class="hs-identifier hs-var">tb'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">KernelPath -&gt; BodyT SOACS -&gt; DistribM (Body GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#transformBody"><span class="hs-identifier hs-var">transformBody</span></a></span><span> </span><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422922"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT SOACS
</span><a href="#local-6989586621684422918"><span class="hs-identifier hs-var">tb</span></a></span><span>
</span><span id="line-361"></span><span>  </span><span id="local-6989586621684422914"><span class="annot"><span class="annottext">Body GPU
</span><a href="#local-6989586621684422914"><span class="hs-identifier hs-var">fb'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">KernelPath -&gt; BodyT SOACS -&gt; DistribM (Body GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#transformBody"><span class="hs-identifier hs-var">transformBody</span></a></span><span> </span><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422922"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT SOACS
</span><a href="#local-6989586621684422917"><span class="hs-identifier hs-var">fb</span></a></span><span>
</span><span id="line-362"></span><span>  </span><span class="annot"><span class="annottext">Stms GPU -&gt; DistribM (Stms GPU)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Stms GPU -&gt; DistribM (Stms GPU))
-&gt; Stms GPU -&gt; DistribM (Stms GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stm GPU -&gt; Stms GPU
forall rep. Stm rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#oneStm"><span class="hs-identifier hs-var">oneStm</span></a></span><span> </span><span class="annot"><span class="annottext">(Stm GPU -&gt; Stms GPU) -&gt; Stm GPU -&gt; Stms GPU
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat GPU -&gt; StmAux (ExpDec GPU) -&gt; ExpT GPU -&gt; Stm GPU
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat SOACS
Pat GPU
</span><a href="#local-6989586621684422921"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec SOACS)
StmAux (ExpDec GPU)
</span><a href="#local-6989586621684422920"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">(ExpT GPU -&gt; Stm GPU) -&gt; ExpT GPU -&gt; Stm GPU
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp
-&gt; Body GPU -&gt; Body GPU -&gt; IfDec (BranchType GPU) -&gt; ExpT GPU
forall rep.
SubExp
-&gt; BodyT rep -&gt; BodyT rep -&gt; IfDec (BranchType rep) -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#If"><span class="hs-identifier hs-var">If</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422919"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Body GPU
</span><a href="#local-6989586621684422915"><span class="hs-identifier hs-var">tb'</span></a></span><span> </span><span class="annot"><span class="annottext">Body GPU
</span><a href="#local-6989586621684422914"><span class="hs-identifier hs-var">fb'</span></a></span><span> </span><span class="annot"><span class="annottext">IfDec (BranchType SOACS)
IfDec (BranchType GPU)
</span><a href="#local-6989586621684422916"><span class="hs-identifier hs-var">rt</span></a></span><span>
</span><span id="line-363"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#transformStm"><span class="hs-identifier hs-var">transformStm</span></a></span><span> </span><span id="local-6989586621684422912"><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422912"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684422911"><span class="annot"><span class="annottext">Pat SOACS
</span><a href="#local-6989586621684422911"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684422910"><span class="annot"><span class="annottext">StmAux (ExpDec SOACS)
</span><a href="#local-6989586621684422910"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#WithAcc"><span class="hs-identifier hs-type">WithAcc</span></a></span><span> </span><span id="local-6989586621684422909"><span class="annot"><span class="annottext">[WithAccInput SOACS]
</span><a href="#local-6989586621684422909"><span class="hs-identifier hs-var">inputs</span></a></span></span><span> </span><span id="local-6989586621684422908"><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422908"><span class="hs-identifier hs-var">lam</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-364"></span><span>  </span><span class="annot"><span class="annottext">Stm GPU -&gt; Stms GPU
forall rep. Stm rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#oneStm"><span class="hs-identifier hs-var">oneStm</span></a></span><span> </span><span class="annot"><span class="annottext">(Stm GPU -&gt; Stms GPU)
-&gt; (ExpT GPU -&gt; Stm GPU) -&gt; ExpT GPU -&gt; Stms GPU
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Pat GPU -&gt; StmAux (ExpDec GPU) -&gt; ExpT GPU -&gt; Stm GPU
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat SOACS
Pat GPU
</span><a href="#local-6989586621684422911"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec SOACS)
StmAux (ExpDec GPU)
</span><a href="#local-6989586621684422910"><span class="hs-identifier hs-var">aux</span></a></span><span>
</span><span id="line-365"></span><span>    </span><span class="annot"><span class="annottext">(ExpT GPU -&gt; Stms GPU)
-&gt; DistribM (ExpT GPU) -&gt; DistribM (Stms GPU)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[WithAccInput GPU] -&gt; Lambda GPU -&gt; ExpT GPU
forall rep. [WithAccInput rep] -&gt; Lambda rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#WithAcc"><span class="hs-identifier hs-var">WithAcc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(WithAccInput SOACS -&gt; WithAccInput GPU)
-&gt; [WithAccInput SOACS] -&gt; [WithAccInput GPU]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">WithAccInput SOACS -&gt; WithAccInput GPU
forall {f :: * -&gt; *} {p :: * -&gt; * -&gt; *} {a} {b} {c}.
(Functor f, Bifunctor p) =&gt;
(a, b, f (p Lambda c)) -&gt; (a, b, f (p (Lambda GPU) c))
</span><a href="#local-6989586621684422907"><span class="hs-identifier hs-var">transformInput</span></a></span><span> </span><span class="annot"><span class="annottext">[WithAccInput SOACS]
</span><a href="#local-6989586621684422909"><span class="hs-identifier hs-var">inputs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Lambda GPU -&gt; ExpT GPU)
-&gt; DistribM (Lambda GPU) -&gt; DistribM (ExpT GPU)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">KernelPath -&gt; Lambda -&gt; DistribM (Lambda GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#transformLambda"><span class="hs-identifier hs-var">transformLambda</span></a></span><span> </span><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422912"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422908"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-366"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-367"></span><span>    </span><span id="local-6989586621684422907"><span class="annot"><span class="annottext">transformInput :: (a, b, f (p Lambda c)) -&gt; (a, b, f (p (Lambda GPU) c))
</span><a href="#local-6989586621684422907"><span class="hs-identifier hs-var hs-var">transformInput</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684422902"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684422902"><span class="hs-identifier hs-var">shape</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684422901"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684422901"><span class="hs-identifier hs-var">arrs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684422900"><span class="annot"><span class="annottext">f (p Lambda c)
</span><a href="#local-6989586621684422900"><span class="hs-identifier hs-var">op</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-368"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684422902"><span class="hs-identifier hs-var">shape</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684422901"><span class="hs-identifier hs-var">arrs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(p Lambda c -&gt; p (Lambda GPU) c)
-&gt; f (p Lambda c) -&gt; f (p (Lambda GPU) c)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Lambda -&gt; Lambda GPU) -&gt; p Lambda c -&gt; p (Lambda GPU) c
forall (p :: * -&gt; * -&gt; *) a b c.
Bifunctor p =&gt;
(a -&gt; b) -&gt; p a c -&gt; p b c
</span><span class="hs-identifier hs-var">first</span></span><span> </span><span class="annot"><span class="annottext">Lambda -&gt; Lambda GPU
</span><a href="Futhark.Pass.ExtractKernels.ToGPU.html#soacsLambdaToGPU"><span class="hs-identifier hs-var">soacsLambdaToGPU</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">f (p Lambda c)
</span><a href="#local-6989586621684422900"><span class="hs-identifier hs-var">op</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-369"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#transformStm"><span class="hs-identifier hs-var">transformStm</span></a></span><span> </span><span id="local-6989586621684422898"><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422898"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684422897"><span class="annot"><span class="annottext">Pat SOACS
</span><a href="#local-6989586621684422897"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684422896"><span class="annot"><span class="annottext">StmAux (ExpDec SOACS)
</span><a href="#local-6989586621684422896"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#DoLoop"><span class="hs-identifier hs-type">DoLoop</span></a></span><span> </span><span id="local-6989586621684422895"><span class="annot"><span class="annottext">[(FParam SOACS, SubExp)]
</span><a href="#local-6989586621684422895"><span class="hs-identifier hs-var">merge</span></a></span></span><span> </span><span id="local-6989586621684422894"><span class="annot"><span class="annottext">LoopForm SOACS
</span><a href="#local-6989586621684422894"><span class="hs-identifier hs-var">form</span></a></span></span><span> </span><span id="local-6989586621684422893"><span class="annot"><span class="annottext">BodyT SOACS
</span><a href="#local-6989586621684422893"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-370"></span><span>  </span><span class="annot"><span class="annottext">Scope GPU -&gt; DistribM (Stms GPU) -&gt; DistribM (Stms GPU)
forall rep (m :: * -&gt; *) a.
LocalScope rep m =&gt;
Scope rep -&gt; m a -&gt; m a
</span><a href="Futhark.IR.Prop.Scope.html#localScope"><span class="hs-identifier hs-var">localScope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Scope SOACS -&gt; Scope GPU
forall fromrep torep.
SameScope fromrep torep =&gt;
Scope fromrep -&gt; Scope torep
</span><a href="Futhark.IR.Prop.Scope.html#castScope"><span class="hs-identifier hs-var">castScope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LoopForm SOACS -&gt; Scope SOACS
forall rep a. Scoped rep a =&gt; a -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOf"><span class="hs-identifier hs-var">scopeOf</span></a></span><span> </span><span class="annot"><span class="annottext">LoopForm SOACS
</span><a href="#local-6989586621684422894"><span class="hs-identifier hs-var">form</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Scope GPU -&gt; Scope GPU -&gt; Scope GPU
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Param DeclType] -&gt; Scope GPU
forall rep dec. (FParamInfo rep ~ dec) =&gt; [Param dec] -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOfFParams"><span class="hs-identifier hs-var">scopeOfFParams</span></a></span><span> </span><span class="annot"><span class="annottext">[Param DeclType]
</span><a href="#local-6989586621684422891"><span class="hs-identifier hs-var">params</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(DistribM (Stms GPU) -&gt; DistribM (Stms GPU))
-&gt; DistribM (Stms GPU) -&gt; DistribM (Stms GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-371"></span><span>    </span><span class="annot"><span class="annottext">Stm GPU -&gt; Stms GPU
forall rep. Stm rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#oneStm"><span class="hs-identifier hs-var">oneStm</span></a></span><span> </span><span class="annot"><span class="annottext">(Stm GPU -&gt; Stms GPU)
-&gt; (Body GPU -&gt; Stm GPU) -&gt; Body GPU -&gt; Stms GPU
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Pat GPU -&gt; StmAux (ExpDec GPU) -&gt; ExpT GPU -&gt; Stm GPU
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat SOACS
Pat GPU
</span><a href="#local-6989586621684422897"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec SOACS)
StmAux (ExpDec GPU)
</span><a href="#local-6989586621684422896"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">(ExpT GPU -&gt; Stm GPU)
-&gt; (Body GPU -&gt; ExpT GPU) -&gt; Body GPU -&gt; Stm GPU
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[(FParam GPU, SubExp)] -&gt; LoopForm GPU -&gt; Body GPU -&gt; ExpT GPU
forall rep.
[(FParam rep, SubExp)] -&gt; LoopForm rep -&gt; BodyT rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#DoLoop"><span class="hs-identifier hs-var">DoLoop</span></a></span><span> </span><span class="annot"><span class="annottext">[(FParam SOACS, SubExp)]
[(FParam GPU, SubExp)]
</span><a href="#local-6989586621684422895"><span class="hs-identifier hs-var">merge</span></a></span><span> </span><span class="annot"><span class="annottext">LoopForm GPU
</span><a href="#local-6989586621684422890"><span class="hs-identifier hs-var">form'</span></a></span><span> </span><span class="annot"><span class="annottext">(Body GPU -&gt; Stms GPU)
-&gt; DistribM (Body GPU) -&gt; DistribM (Stms GPU)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">KernelPath -&gt; BodyT SOACS -&gt; DistribM (Body GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#transformBody"><span class="hs-identifier hs-var">transformBody</span></a></span><span> </span><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422898"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT SOACS
</span><a href="#local-6989586621684422893"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-372"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-373"></span><span>    </span><span id="local-6989586621684422891"><span class="annot"><span class="annottext">params :: [Param DeclType]
</span><a href="#local-6989586621684422891"><span class="hs-identifier hs-var hs-var">params</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Param DeclType, SubExp) -&gt; Param DeclType)
-&gt; [(Param DeclType, SubExp)] -&gt; [Param DeclType]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Param DeclType, SubExp) -&gt; Param DeclType
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(Param DeclType, SubExp)]
[(FParam SOACS, SubExp)]
</span><a href="#local-6989586621684422895"><span class="hs-identifier hs-var">merge</span></a></span><span>
</span><span id="line-374"></span><span>    </span><span id="local-6989586621684422890"><span class="annot"><span class="annottext">form' :: LoopForm GPU
</span><a href="#local-6989586621684422890"><span class="hs-identifier hs-var hs-var">form'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">LoopForm SOACS
</span><a href="#local-6989586621684422894"><span class="hs-identifier hs-var">form</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-375"></span><span>      </span><span class="annot"><a href="Futhark.IR.Syntax.html#WhileLoop"><span class="hs-identifier hs-type">WhileLoop</span></a></span><span> </span><span id="local-6989586621684422888"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684422888"><span class="hs-identifier hs-var">cond</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-376"></span><span>        </span><span class="annot"><span class="annottext">VName -&gt; LoopForm GPU
forall rep. VName -&gt; LoopForm rep
</span><a href="Futhark.IR.Syntax.html#WhileLoop"><span class="hs-identifier hs-var">WhileLoop</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684422888"><span class="hs-identifier hs-var">cond</span></a></span><span>
</span><span id="line-377"></span><span>      </span><span class="annot"><a href="Futhark.IR.Syntax.html#ForLoop"><span class="hs-identifier hs-type">ForLoop</span></a></span><span> </span><span id="local-6989586621684422886"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684422886"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621684422885"><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684422885"><span class="hs-identifier hs-var">it</span></a></span></span><span> </span><span id="local-6989586621684422884"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422884"><span class="hs-identifier hs-var">bound</span></a></span></span><span> </span><span id="local-6989586621684422883"><span class="annot"><span class="annottext">[(LParam SOACS, VName)]
</span><a href="#local-6989586621684422883"><span class="hs-identifier hs-var">ps</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-378"></span><span>        </span><span class="annot"><span class="annottext">VName -&gt; IntType -&gt; SubExp -&gt; [(LParam GPU, VName)] -&gt; LoopForm GPU
forall rep.
VName -&gt; IntType -&gt; SubExp -&gt; [(LParam rep, VName)] -&gt; LoopForm rep
</span><a href="Futhark.IR.Syntax.html#ForLoop"><span class="hs-identifier hs-var">ForLoop</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684422886"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684422885"><span class="hs-identifier hs-var">it</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422884"><span class="hs-identifier hs-var">bound</span></a></span><span> </span><span class="annot"><span class="annottext">[(LParam SOACS, VName)]
[(LParam GPU, VName)]
</span><a href="#local-6989586621684422883"><span class="hs-identifier hs-var">ps</span></a></span><span>
</span><span id="line-379"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#transformStm"><span class="hs-identifier hs-var">transformStm</span></a></span><span> </span><span id="local-6989586621684422882"><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422882"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684422881"><span class="annot"><span class="annottext">Pat SOACS
</span><a href="#local-6989586621684422881"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684422880"><span class="annot"><span class="annottext">StmAux (ExpDec SOACS)
</span><a href="#local-6989586621684422880"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Screma"><span class="hs-identifier hs-type">Screma</span></a></span><span> </span><span id="local-6989586621684422879"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422879"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684422878"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684422878"><span class="hs-identifier hs-var">arrs</span></a></span></span><span> </span><span id="local-6989586621684422877"><span class="annot"><span class="annottext">ScremaForm SOACS
</span><a href="#local-6989586621684422877"><span class="hs-identifier hs-var">form</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-380"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684422876"><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422876"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ScremaForm SOACS -&gt; Maybe Lambda
forall rep. ScremaForm rep -&gt; Maybe (Lambda rep)
</span><a href="Futhark.IR.SOACS.SOAC.html#isMapSOAC"><span class="hs-identifier hs-var">isMapSOAC</span></a></span><span> </span><span class="annot"><span class="annottext">ScremaForm SOACS
</span><a href="#local-6989586621684422877"><span class="hs-identifier hs-var">form</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-381"></span><span>    </span><span class="annot"><span class="annottext">KernelPath -&gt; MapLoop -&gt; DistribM (Stms GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#onMap"><span class="hs-identifier hs-var">onMap</span></a></span><span> </span><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422882"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="annot"><span class="annottext">(MapLoop -&gt; DistribM (Stms GPU)) -&gt; MapLoop -&gt; DistribM (Stms GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat SOACS -&gt; StmAux () -&gt; SubExp -&gt; Lambda -&gt; [VName] -&gt; MapLoop
</span><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#MapLoop"><span class="hs-identifier hs-var">MapLoop</span></a></span><span> </span><span class="annot"><span class="annottext">Pat SOACS
</span><a href="#local-6989586621684422881"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux ()
StmAux (ExpDec SOACS)
</span><a href="#local-6989586621684422880"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422879"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422876"><span class="hs-identifier hs-var">lam</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684422878"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-382"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#transformStm"><span class="hs-identifier hs-var">transformStm</span></a></span><span> </span><span id="local-6989586621684422872"><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422872"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684422871"><span class="annot"><span class="annottext">Pat SOACS
</span><a href="#local-6989586621684422871"><span class="hs-identifier hs-var">res_pat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#StmAux"><span class="hs-identifier hs-type">StmAux</span></a></span><span> </span><span id="local-6989586621684422869"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684422869"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ExpDec SOACS
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Screma"><span class="hs-identifier hs-type">Screma</span></a></span><span> </span><span id="local-6989586621684422868"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422868"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684422867"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684422867"><span class="hs-identifier hs-var">arrs</span></a></span></span><span> </span><span id="local-6989586621684422866"><span class="annot"><span class="annottext">ScremaForm SOACS
</span><a href="#local-6989586621684422866"><span class="hs-identifier hs-var">form</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-383"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684422865"><span class="annot"><span class="annottext">[Scan SOACS]
</span><a href="#local-6989586621684422865"><span class="hs-identifier hs-var">scans</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ScremaForm SOACS -&gt; Maybe [Scan SOACS]
forall rep. ScremaForm rep -&gt; Maybe [Scan rep]
</span><a href="Futhark.IR.SOACS.SOAC.html#isScanSOAC"><span class="hs-identifier hs-var">isScanSOAC</span></a></span><span> </span><span class="annot"><span class="annottext">ScremaForm SOACS
</span><a href="#local-6989586621684422866"><span class="hs-identifier hs-var">form</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-384"></span><span>    </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Scan"><span class="hs-identifier hs-type">Scan</span></a></span><span> </span><span id="local-6989586621684422862"><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422862"><span class="hs-identifier hs-var">scan_lam</span></a></span></span><span> </span><span id="local-6989586621684422861"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684422861"><span class="hs-identifier hs-var">nes</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Scan SOACS] -&gt; Scan SOACS
forall rep. Buildable rep =&gt; [Scan rep] -&gt; Scan rep
</span><a href="Futhark.IR.SOACS.SOAC.html#singleScan"><span class="hs-identifier hs-var">singleScan</span></a></span><span> </span><span class="annot"><span class="annottext">[Scan SOACS]
</span><a href="#local-6989586621684422865"><span class="hs-identifier hs-var">scans</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-385"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684422859"><span class="annot"><span class="annottext">BuilderT SOACS DistribM ()
</span><a href="#local-6989586621684422859"><span class="hs-identifier hs-var">do_iswim</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Pat SOACS
-&gt; SubExp
-&gt; Lambda
-&gt; [(SubExp, VName)]
-&gt; Maybe (BuilderT SOACS DistribM ())
forall (m :: * -&gt; *).
(MonadBuilder m, Rep m ~ SOACS) =&gt;
Pat SOACS -&gt; SubExp -&gt; Lambda -&gt; [(SubExp, VName)] -&gt; Maybe (m ())
</span><a href="Futhark.Pass.ExtractKernels.ISRWIM.html#iswim"><span class="hs-identifier hs-var">iswim</span></a></span><span> </span><span class="annot"><span class="annottext">Pat SOACS
</span><a href="#local-6989586621684422871"><span class="hs-identifier hs-var">res_pat</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422868"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422862"><span class="hs-identifier hs-var">scan_lam</span></a></span><span> </span><span class="annot"><span class="annottext">([(SubExp, VName)] -&gt; Maybe (BuilderT SOACS DistribM ()))
-&gt; [(SubExp, VName)] -&gt; Maybe (BuilderT SOACS DistribM ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; [VName] -&gt; [(SubExp, VName)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684422861"><span class="hs-identifier hs-var">nes</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684422867"><span class="hs-identifier hs-var">arrs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-386"></span><span>    </span><span id="local-6989586621684422857"><span class="annot"><span class="annottext">Scope SOACS
</span><a href="#local-6989586621684422857"><span class="hs-identifier hs-var">types</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Scope GPU -&gt; Scope SOACS) -&gt; DistribM (Scope SOACS)
forall rep (m :: * -&gt; *) a.
HasScope rep m =&gt;
(Scope rep -&gt; a) -&gt; m a
</span><a href="Futhark.IR.Prop.Scope.html#asksScope"><span class="hs-identifier hs-var">asksScope</span></a></span><span> </span><span class="annot"><span class="annottext">Scope GPU -&gt; Scope SOACS
</span><a href="Futhark.Pass.ExtractKernels.ToGPU.html#scopeForSOACs"><span class="hs-identifier hs-var">scopeForSOACs</span></a></span><span>
</span><span id="line-387"></span><span>    </span><span class="annot"><span class="annottext">KernelPath -&gt; [Stm SOACS] -&gt; DistribM (Stms GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#transformStms"><span class="hs-identifier hs-var">transformStms</span></a></span><span> </span><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422872"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="annot"><span class="annottext">([Stm SOACS] -&gt; DistribM (Stms GPU))
-&gt; (((), Stms SOACS) -&gt; [Stm SOACS])
-&gt; ((), Stms SOACS)
-&gt; DistribM (Stms GPU)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Stms SOACS -&gt; [Stm SOACS]
forall rep. Stms rep -&gt; [Stm rep]
</span><a href="Futhark.IR.Syntax.html#stmsToList"><span class="hs-identifier hs-var">stmsToList</span></a></span><span> </span><span class="annot"><span class="annottext">(Stms SOACS -&gt; [Stm SOACS])
-&gt; (((), Stms SOACS) -&gt; Stms SOACS)
-&gt; ((), Stms SOACS)
-&gt; [Stm SOACS]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">((), Stms SOACS) -&gt; Stms SOACS
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">(((), Stms SOACS) -&gt; DistribM (Stms GPU))
-&gt; DistribM ((), Stms SOACS) -&gt; DistribM (Stms GPU)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">BuilderT SOACS DistribM ()
-&gt; Scope SOACS -&gt; DistribM ((), Stms SOACS)
forall (m :: * -&gt; *) rep a.
MonadFreshNames m =&gt;
BuilderT rep m a -&gt; Scope rep -&gt; m (a, Stms rep)
</span><a href="Futhark.Builder.html#runBuilderT"><span class="hs-identifier hs-var">runBuilderT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Certs -&gt; BuilderT SOACS DistribM () -&gt; BuilderT SOACS DistribM ()
forall (m :: * -&gt; *) a. MonadBuilder m =&gt; Certs -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#certifying"><span class="hs-identifier hs-var">certifying</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684422869"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">BuilderT SOACS DistribM ()
</span><a href="#local-6989586621684422859"><span class="hs-identifier hs-var">do_iswim</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Scope SOACS
</span><a href="#local-6989586621684422857"><span class="hs-identifier hs-var">types</span></a></span><span>
</span><span id="line-388"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684422856"><span class="annot"><span class="annottext">[Scan SOACS]
</span><a href="#local-6989586621684422856"><span class="hs-identifier hs-var">scans</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684422855"><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422855"><span class="hs-identifier hs-var">map_lam</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ScremaForm SOACS -&gt; Maybe ([Scan SOACS], Lambda)
forall rep. ScremaForm rep -&gt; Maybe ([Scan rep], Lambda rep)
</span><a href="Futhark.IR.SOACS.SOAC.html#isScanomapSOAC"><span class="hs-identifier hs-var">isScanomapSOAC</span></a></span><span> </span><span class="annot"><span class="annottext">ScremaForm SOACS
</span><a href="#local-6989586621684422866"><span class="hs-identifier hs-var">form</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Builder GPU () -&gt; DistribM (Stms GPU)
forall (m :: * -&gt; *) somerep rep a.
(MonadFreshNames m, HasScope somerep m, SameScope somerep rep) =&gt;
Builder rep a -&gt; m (Stms rep)
</span><a href="Futhark.Builder.html#runBuilder_"><span class="hs-identifier hs-var">runBuilder_</span></a></span><span> </span><span class="annot"><span class="annottext">(Builder GPU () -&gt; DistribM (Stms GPU))
-&gt; Builder GPU () -&gt; DistribM (Stms GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-389"></span><span>    </span><span id="local-6989586621684422853"><span class="annot"><span class="annottext">[SegBinOp GPU]
</span><a href="#local-6989586621684422853"><span class="hs-identifier hs-var">scan_ops</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Scan SOACS]
-&gt; (Scan SOACS -&gt; BuilderT GPU (State VNameSource) (SegBinOp GPU))
-&gt; BuilderT GPU (State VNameSource) [SegBinOp GPU]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="annot"><span class="annottext">[Scan SOACS]
</span><a href="#local-6989586621684422856"><span class="hs-identifier hs-var">scans</span></a></span><span> </span><span class="annot"><span class="annottext">((Scan SOACS -&gt; BuilderT GPU (State VNameSource) (SegBinOp GPU))
 -&gt; BuilderT GPU (State VNameSource) [SegBinOp GPU])
-&gt; (Scan SOACS -&gt; BuilderT GPU (State VNameSource) (SegBinOp GPU))
-&gt; BuilderT GPU (State VNameSource) [SegBinOp GPU]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Scan"><span class="hs-identifier hs-type">Scan</span></a></span><span> </span><span id="local-6989586621684422852"><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422852"><span class="hs-identifier hs-var">scan_lam</span></a></span></span><span> </span><span id="local-6989586621684422851"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684422851"><span class="hs-identifier hs-var">nes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-390"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684422850"><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422850"><span class="hs-identifier hs-var">scan_lam'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684422849"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684422849"><span class="hs-identifier hs-var">nes'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684422848"><span class="annot"><span class="annottext">ShapeBase SubExp
</span><a href="#local-6989586621684422848"><span class="hs-identifier hs-var">shape</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Lambda
-&gt; [SubExp]
-&gt; BuilderT
     GPU (State VNameSource) (Lambda, [SubExp], ShapeBase SubExp)
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Lambda -&gt; [SubExp] -&gt; m (Lambda, [SubExp], ShapeBase SubExp)
</span><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#determineReduceOp"><span class="hs-identifier hs-var">determineReduceOp</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422852"><span class="hs-identifier hs-var">scan_lam</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684422851"><span class="hs-identifier hs-var">nes</span></a></span><span>
</span><span id="line-391"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684422846"><span class="annot"><span class="annottext">scan_lam'' :: Lambda GPU
</span><a href="#local-6989586621684422846"><span class="hs-identifier hs-var hs-var">scan_lam''</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Lambda -&gt; Lambda GPU
</span><a href="Futhark.Pass.ExtractKernels.ToGPU.html#soacsLambdaToGPU"><span class="hs-identifier hs-var">soacsLambdaToGPU</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422850"><span class="hs-identifier hs-var">scan_lam'</span></a></span><span>
</span><span id="line-392"></span><span>      </span><span class="annot"><span class="annottext">SegBinOp GPU -&gt; BuilderT GPU (State VNameSource) (SegBinOp GPU)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(SegBinOp GPU -&gt; BuilderT GPU (State VNameSource) (SegBinOp GPU))
-&gt; SegBinOp GPU -&gt; BuilderT GPU (State VNameSource) (SegBinOp GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Commutativity
-&gt; Lambda GPU -&gt; [SubExp] -&gt; ShapeBase SubExp -&gt; SegBinOp GPU
forall rep.
Commutativity
-&gt; Lambda rep -&gt; [SubExp] -&gt; ShapeBase SubExp -&gt; SegBinOp rep
</span><a href="Futhark.IR.SegOp.html#SegBinOp"><span class="hs-identifier hs-var">SegBinOp</span></a></span><span> </span><span class="annot"><span class="annottext">Commutativity
</span><a href="Futhark.IR.Syntax.Core.html#Noncommutative"><span class="hs-identifier hs-var">Noncommutative</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPU
</span><a href="#local-6989586621684422846"><span class="hs-identifier hs-var">scan_lam''</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684422849"><span class="hs-identifier hs-var">nes'</span></a></span><span> </span><span class="annot"><span class="annottext">ShapeBase SubExp
</span><a href="#local-6989586621684422848"><span class="hs-identifier hs-var">shape</span></a></span><span>
</span><span id="line-393"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684422843"><span class="annot"><span class="annottext">map_lam_sequential :: Lambda GPU
</span><a href="#local-6989586621684422843"><span class="hs-identifier hs-var hs-var">map_lam_sequential</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Lambda -&gt; Lambda GPU
</span><a href="Futhark.Pass.ExtractKernels.ToGPU.html#soacsLambdaToGPU"><span class="hs-identifier hs-var">soacsLambdaToGPU</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422855"><span class="hs-identifier hs-var">map_lam</span></a></span><span>
</span><span id="line-394"></span><span>    </span><span id="local-6989586621684422842"><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684422842"><span class="hs-identifier hs-var">lvl</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MkSegLevel GPU (State VNameSource)
forall (m :: * -&gt; *). MonadFreshNames m =&gt; MkSegLevel GPU m
</span><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#segThreadCapped"><span class="hs-identifier hs-var">segThreadCapped</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422868"><span class="hs-identifier hs-var">w</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;segscan&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ThreadRecommendation
 -&gt; BuilderT GPU (State VNameSource) (SegOpLevel GPU))
-&gt; ThreadRecommendation
-&gt; BuilderT GPU (State VNameSource) (SegOpLevel GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegVirt -&gt; ThreadRecommendation
</span><a href="Futhark.Pass.ExtractKernels.BlockedKernel.html#NoRecommendation"><span class="hs-identifier hs-var">NoRecommendation</span></a></span><span> </span><span class="annot"><span class="annottext">SegVirt
</span><a href="Futhark.IR.SegOp.html#SegNoVirt"><span class="hs-identifier hs-var">SegNoVirt</span></a></span><span>
</span><span id="line-395"></span><span>    </span><span class="annot"><span class="annottext">Stms GPU -&gt; Builder GPU ()
forall (m :: * -&gt; *). MonadBuilder m =&gt; Stms (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#addStms"><span class="hs-identifier hs-var">addStms</span></a></span><span> </span><span class="annot"><span class="annottext">(Stms GPU -&gt; Builder GPU ())
-&gt; (Stms GPU -&gt; Stms GPU) -&gt; Stms GPU -&gt; Builder GPU ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Stm GPU -&gt; Stm GPU) -&gt; Stms GPU -&gt; Stms GPU
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Certs -&gt; Stm GPU -&gt; Stm GPU
forall rep. Certs -&gt; Stm rep -&gt; Stm rep
</span><a href="Futhark.IR.Prop.html#certify"><span class="hs-identifier hs-var">certify</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684422869"><span class="hs-identifier hs-var">cs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-396"></span><span>      </span><span class="annot"><span class="annottext">(Stms GPU -&gt; Builder GPU ())
-&gt; BuilderT GPU (State VNameSource) (Stms GPU) -&gt; Builder GPU ()
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">SegOpLevel GPU
-&gt; Pat GPU
-&gt; Certs
-&gt; SubExp
-&gt; [SegBinOp GPU]
-&gt; Lambda GPU
-&gt; [VName]
-&gt; [(VName, SubExp)]
-&gt; [KernelInput]
-&gt; BuilderT GPU (State VNameSource) (Stms GPU)
forall (m :: * -&gt; *) rep.
(MonadFreshNames m, DistRep rep, HasScope rep m) =&gt;
SegOpLevel rep
-&gt; Pat rep
-&gt; Certs
-&gt; SubExp
-&gt; [SegBinOp rep]
-&gt; Lambda rep
-&gt; [VName]
-&gt; [(VName, SubExp)]
-&gt; [KernelInput]
-&gt; m (Stms rep)
</span><a href="Futhark.Pass.ExtractKernels.BlockedKernel.html#segScan"><span class="hs-identifier hs-var">segScan</span></a></span><span> </span><span class="annot"><span class="annottext">SegOpLevel GPU
SegLevel
</span><a href="#local-6989586621684422842"><span class="hs-identifier hs-var">lvl</span></a></span><span> </span><span class="annot"><span class="annottext">Pat SOACS
Pat GPU
</span><a href="#local-6989586621684422871"><span class="hs-identifier hs-var">res_pat</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422868"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOp GPU]
</span><a href="#local-6989586621684422853"><span class="hs-identifier hs-var">scan_ops</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPU
</span><a href="#local-6989586621684422843"><span class="hs-identifier hs-var">map_lam_sequential</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684422867"><span class="hs-identifier hs-var">arrs</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-397"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#transformStm"><span class="hs-identifier hs-var">transformStm</span></a></span><span> </span><span id="local-6989586621684422836"><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422836"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684422835"><span class="annot"><span class="annottext">Pat SOACS
</span><a href="#local-6989586621684422835"><span class="hs-identifier hs-var">res_pat</span></a></span></span><span> </span><span id="local-6989586621684422834"><span class="annot"><span class="annottext">StmAux (ExpDec SOACS)
</span><a href="#local-6989586621684422834"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Screma"><span class="hs-identifier hs-type">Screma</span></a></span><span> </span><span id="local-6989586621684422833"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422833"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684422832"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684422832"><span class="hs-identifier hs-var">arrs</span></a></span></span><span> </span><span id="local-6989586621684422831"><span class="annot"><span class="annottext">ScremaForm SOACS
</span><a href="#local-6989586621684422831"><span class="hs-identifier hs-var">form</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-398"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Reduce"><span class="hs-identifier hs-type">Reduce</span></a></span><span> </span><span id="local-6989586621684422829"><span class="annot"><span class="annottext">Commutativity
</span><a href="#local-6989586621684422829"><span class="hs-identifier hs-var">comm</span></a></span></span><span> </span><span id="local-6989586621684422828"><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422828"><span class="hs-identifier hs-var">red_fun</span></a></span></span><span> </span><span id="local-6989586621684422827"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684422827"><span class="hs-identifier hs-var">nes</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ScremaForm SOACS -&gt; Maybe [Reduce SOACS]
forall rep. ScremaForm rep -&gt; Maybe [Reduce rep]
</span><a href="Futhark.IR.SOACS.SOAC.html#isReduceSOAC"><span class="hs-identifier hs-var">isReduceSOAC</span></a></span><span> </span><span class="annot"><span class="annottext">ScremaForm SOACS
</span><a href="#local-6989586621684422831"><span class="hs-identifier hs-var">form</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-399"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684422825"><span class="annot"><span class="annottext">comm' :: Commutativity
</span><a href="#local-6989586621684422825"><span class="hs-identifier hs-var hs-var">comm'</span></a></span></span><span>
</span><span id="line-400"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Lambda -&gt; Bool
forall rep. Lambda rep -&gt; Bool
</span><a href="Futhark.IR.Prop.html#commutativeLambda"><span class="hs-identifier hs-var">commutativeLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422828"><span class="hs-identifier hs-var">red_fun</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Commutativity
</span><a href="Futhark.IR.Syntax.Core.html#Commutative"><span class="hs-identifier hs-var">Commutative</span></a></span><span>
</span><span id="line-401"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Commutativity
</span><a href="#local-6989586621684422829"><span class="hs-identifier hs-var">comm</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-402"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684422822"><span class="annot"><span class="annottext">BuilderT SOACS DistribM ()
</span><a href="#local-6989586621684422822"><span class="hs-identifier hs-var">do_irwim</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Pat SOACS
-&gt; SubExp
-&gt; Commutativity
-&gt; Lambda
-&gt; [(SubExp, VName)]
-&gt; Maybe (BuilderT SOACS DistribM ())
forall (m :: * -&gt; *).
(MonadBuilder m, Rep m ~ SOACS) =&gt;
Pat SOACS
-&gt; SubExp
-&gt; Commutativity
-&gt; Lambda
-&gt; [(SubExp, VName)]
-&gt; Maybe (m ())
</span><a href="Futhark.Pass.ExtractKernels.ISRWIM.html#irwim"><span class="hs-identifier hs-var">irwim</span></a></span><span> </span><span class="annot"><span class="annottext">Pat SOACS
</span><a href="#local-6989586621684422835"><span class="hs-identifier hs-var">res_pat</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422833"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">Commutativity
</span><a href="#local-6989586621684422825"><span class="hs-identifier hs-var">comm'</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422828"><span class="hs-identifier hs-var">red_fun</span></a></span><span> </span><span class="annot"><span class="annottext">([(SubExp, VName)] -&gt; Maybe (BuilderT SOACS DistribM ()))
-&gt; [(SubExp, VName)] -&gt; Maybe (BuilderT SOACS DistribM ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; [VName] -&gt; [(SubExp, VName)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684422827"><span class="hs-identifier hs-var">nes</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684422832"><span class="hs-identifier hs-var">arrs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-403"></span><span>    </span><span id="local-6989586621684422820"><span class="annot"><span class="annottext">Scope SOACS
</span><a href="#local-6989586621684422820"><span class="hs-identifier hs-var">types</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Scope GPU -&gt; Scope SOACS) -&gt; DistribM (Scope SOACS)
forall rep (m :: * -&gt; *) a.
HasScope rep m =&gt;
(Scope rep -&gt; a) -&gt; m a
</span><a href="Futhark.IR.Prop.Scope.html#asksScope"><span class="hs-identifier hs-var">asksScope</span></a></span><span> </span><span class="annot"><span class="annottext">Scope GPU -&gt; Scope SOACS
</span><a href="Futhark.Pass.ExtractKernels.ToGPU.html#scopeForSOACs"><span class="hs-identifier hs-var">scopeForSOACs</span></a></span><span>
</span><span id="line-404"></span><span>    </span><span id="local-6989586621684422819"><span class="annot"><span class="annottext">Stms SOACS
</span><a href="#local-6989586621684422819"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Stms SOACS, Stms SOACS) -&gt; Stms SOACS
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">((Stms SOACS, Stms SOACS) -&gt; Stms SOACS)
-&gt; DistribM (Stms SOACS, Stms SOACS) -&gt; DistribM (Stms SOACS)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">BuilderT SOACS DistribM (Stms SOACS)
-&gt; Scope SOACS -&gt; DistribM (Stms SOACS, Stms SOACS)
forall (m :: * -&gt; *) rep a.
MonadFreshNames m =&gt;
BuilderT rep m a -&gt; Scope rep -&gt; m (a, Stms rep)
</span><a href="Futhark.Builder.html#runBuilderT"><span class="hs-identifier hs-var">runBuilderT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms SOACS -&gt; BuilderT SOACS DistribM (Stms SOACS)
forall (m :: * -&gt; *).
(HasScope SOACS m, MonadFreshNames m) =&gt;
Stms SOACS -&gt; m (Stms SOACS)
</span><a href="Futhark.IR.SOACS.Simplify.html#simplifyStms"><span class="hs-identifier hs-var">simplifyStms</span></a></span><span> </span><span class="annot"><span class="annottext">(Stms SOACS -&gt; BuilderT SOACS DistribM (Stms SOACS))
-&gt; BuilderT SOACS DistribM (Stms SOACS)
-&gt; BuilderT SOACS DistribM (Stms SOACS)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">BuilderT SOACS DistribM ()
-&gt; BuilderT SOACS DistribM (Stms (Rep (BuilderT SOACS DistribM)))
forall (m :: * -&gt; *) a. MonadBuilder m =&gt; m a -&gt; m (Stms (Rep m))
</span><a href="Futhark.Builder.Class.html#collectStms_"><span class="hs-identifier hs-var">collectStms_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StmAux ()
-&gt; BuilderT SOACS DistribM () -&gt; BuilderT SOACS DistribM ()
forall (m :: * -&gt; *) anyrep a.
MonadBuilder m =&gt;
StmAux anyrep -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#auxing"><span class="hs-identifier hs-var">auxing</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux ()
StmAux (ExpDec SOACS)
</span><a href="#local-6989586621684422834"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">BuilderT SOACS DistribM ()
</span><a href="#local-6989586621684422822"><span class="hs-identifier hs-var">do_irwim</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Scope SOACS
</span><a href="#local-6989586621684422820"><span class="hs-identifier hs-var">types</span></a></span><span>
</span><span id="line-405"></span><span>    </span><span class="annot"><span class="annottext">KernelPath -&gt; [Stm SOACS] -&gt; DistribM (Stms GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#transformStms"><span class="hs-identifier hs-var">transformStms</span></a></span><span> </span><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422836"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="annot"><span class="annottext">([Stm SOACS] -&gt; DistribM (Stms GPU))
-&gt; [Stm SOACS] -&gt; DistribM (Stms GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stms SOACS -&gt; [Stm SOACS]
forall rep. Stms rep -&gt; [Stm rep]
</span><a href="Futhark.IR.Syntax.html#stmsToList"><span class="hs-identifier hs-var">stmsToList</span></a></span><span> </span><span class="annot"><span class="annottext">Stms SOACS
</span><a href="#local-6989586621684422819"><span class="hs-identifier hs-var">stms</span></a></span><span>
</span><span id="line-406"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#transformStm"><span class="hs-identifier hs-var">transformStm</span></a></span><span> </span><span id="local-6989586621684422816"><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422816"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684422815"><span class="annot"><span class="annottext">Pat SOACS
</span><a href="#local-6989586621684422815"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684422814"><span class="annot"><span class="annottext">aux :: StmAux (ExpDec SOACS)
</span><a href="#local-6989586621684422814"><span class="hs-identifier hs-var">aux</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#StmAux"><span class="hs-identifier hs-type">StmAux</span></a></span><span> </span><span id="local-6989586621684422813"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684422813"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ExpDec SOACS
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Screma"><span class="hs-identifier hs-type">Screma</span></a></span><span> </span><span id="local-6989586621684422812"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422812"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684422811"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684422811"><span class="hs-identifier hs-var">arrs</span></a></span></span><span> </span><span id="local-6989586621684422810"><span class="annot"><span class="annottext">ScremaForm SOACS
</span><a href="#local-6989586621684422810"><span class="hs-identifier hs-var">form</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-407"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684422809"><span class="annot"><span class="annottext">[Reduce SOACS]
</span><a href="#local-6989586621684422809"><span class="hs-identifier hs-var">reds</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684422808"><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422808"><span class="hs-identifier hs-var">map_lam</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ScremaForm SOACS -&gt; Maybe ([Reduce SOACS], Lambda)
forall rep. ScremaForm rep -&gt; Maybe ([Reduce rep], Lambda rep)
</span><a href="Futhark.IR.SOACS.SOAC.html#isRedomapSOAC"><span class="hs-identifier hs-var">isRedomapSOAC</span></a></span><span> </span><span class="annot"><span class="annottext">ScremaForm SOACS
</span><a href="#local-6989586621684422810"><span class="hs-identifier hs-var">form</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-408"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684422807"><span class="annot"><span class="annottext">paralleliseOuter :: DistribM (Stms GPU)
</span><a href="#local-6989586621684422807"><span class="hs-identifier hs-var hs-var">paralleliseOuter</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Builder GPU () -&gt; DistribM (Stms GPU)
forall (m :: * -&gt; *) somerep rep a.
(MonadFreshNames m, HasScope somerep m, SameScope somerep rep) =&gt;
Builder rep a -&gt; m (Stms rep)
</span><a href="Futhark.Builder.html#runBuilder_"><span class="hs-identifier hs-var">runBuilder_</span></a></span><span> </span><span class="annot"><span class="annottext">(Builder GPU () -&gt; DistribM (Stms GPU))
-&gt; Builder GPU () -&gt; DistribM (Stms GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-409"></span><span>          </span><span id="local-6989586621684422806"><span class="annot"><span class="annottext">[SegBinOp GPU]
</span><a href="#local-6989586621684422806"><span class="hs-identifier hs-var">red_ops</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Reduce SOACS]
-&gt; (Reduce SOACS
    -&gt; BuilderT GPU (State VNameSource) (SegBinOp GPU))
-&gt; BuilderT GPU (State VNameSource) [SegBinOp GPU]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="annot"><span class="annottext">[Reduce SOACS]
</span><a href="#local-6989586621684422809"><span class="hs-identifier hs-var">reds</span></a></span><span> </span><span class="annot"><span class="annottext">((Reduce SOACS -&gt; BuilderT GPU (State VNameSource) (SegBinOp GPU))
 -&gt; BuilderT GPU (State VNameSource) [SegBinOp GPU])
-&gt; (Reduce SOACS
    -&gt; BuilderT GPU (State VNameSource) (SegBinOp GPU))
-&gt; BuilderT GPU (State VNameSource) [SegBinOp GPU]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Reduce"><span class="hs-identifier hs-type">Reduce</span></a></span><span> </span><span id="local-6989586621684422805"><span class="annot"><span class="annottext">Commutativity
</span><a href="#local-6989586621684422805"><span class="hs-identifier hs-var">comm</span></a></span></span><span> </span><span id="local-6989586621684422804"><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422804"><span class="hs-identifier hs-var">red_lam</span></a></span></span><span> </span><span id="local-6989586621684422803"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684422803"><span class="hs-identifier hs-var">nes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-410"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621684422802"><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422802"><span class="hs-identifier hs-var">red_lam'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684422801"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684422801"><span class="hs-identifier hs-var">nes'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684422800"><span class="annot"><span class="annottext">ShapeBase SubExp
</span><a href="#local-6989586621684422800"><span class="hs-identifier hs-var">shape</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Lambda
-&gt; [SubExp]
-&gt; BuilderT
     GPU (State VNameSource) (Lambda, [SubExp], ShapeBase SubExp)
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Lambda -&gt; [SubExp] -&gt; m (Lambda, [SubExp], ShapeBase SubExp)
</span><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#determineReduceOp"><span class="hs-identifier hs-var">determineReduceOp</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422804"><span class="hs-identifier hs-var">red_lam</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684422803"><span class="hs-identifier hs-var">nes</span></a></span><span>
</span><span id="line-411"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684422799"><span class="annot"><span class="annottext">comm' :: Commutativity
</span><a href="#local-6989586621684422799"><span class="hs-identifier hs-var hs-var">comm'</span></a></span></span><span>
</span><span id="line-412"></span><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Lambda -&gt; Bool
forall rep. Lambda rep -&gt; Bool
</span><a href="Futhark.IR.Prop.html#commutativeLambda"><span class="hs-identifier hs-var">commutativeLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422802"><span class="hs-identifier hs-var">red_lam'</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Commutativity
</span><a href="Futhark.IR.Syntax.Core.html#Commutative"><span class="hs-identifier hs-var">Commutative</span></a></span><span>
</span><span id="line-413"></span><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Commutativity
</span><a href="#local-6989586621684422805"><span class="hs-identifier hs-var">comm</span></a></span><span>
</span><span id="line-414"></span><span>                </span><span id="local-6989586621684422798"><span class="annot"><span class="annottext">red_lam'' :: Lambda GPU
</span><a href="#local-6989586621684422798"><span class="hs-identifier hs-var hs-var">red_lam''</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Lambda -&gt; Lambda GPU
</span><a href="Futhark.Pass.ExtractKernels.ToGPU.html#soacsLambdaToGPU"><span class="hs-identifier hs-var">soacsLambdaToGPU</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422802"><span class="hs-identifier hs-var">red_lam'</span></a></span><span>
</span><span id="line-415"></span><span>            </span><span class="annot"><span class="annottext">SegBinOp GPU -&gt; BuilderT GPU (State VNameSource) (SegBinOp GPU)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(SegBinOp GPU -&gt; BuilderT GPU (State VNameSource) (SegBinOp GPU))
-&gt; SegBinOp GPU -&gt; BuilderT GPU (State VNameSource) (SegBinOp GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Commutativity
-&gt; Lambda GPU -&gt; [SubExp] -&gt; ShapeBase SubExp -&gt; SegBinOp GPU
forall rep.
Commutativity
-&gt; Lambda rep -&gt; [SubExp] -&gt; ShapeBase SubExp -&gt; SegBinOp rep
</span><a href="Futhark.IR.SegOp.html#SegBinOp"><span class="hs-identifier hs-var">SegBinOp</span></a></span><span> </span><span class="annot"><span class="annottext">Commutativity
</span><a href="#local-6989586621684422799"><span class="hs-identifier hs-var">comm'</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPU
</span><a href="#local-6989586621684422798"><span class="hs-identifier hs-var">red_lam''</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684422801"><span class="hs-identifier hs-var">nes'</span></a></span><span> </span><span class="annot"><span class="annottext">ShapeBase SubExp
</span><a href="#local-6989586621684422800"><span class="hs-identifier hs-var">shape</span></a></span><span>
</span><span id="line-416"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684422797"><span class="annot"><span class="annottext">map_lam_sequential :: Lambda GPU
</span><a href="#local-6989586621684422797"><span class="hs-identifier hs-var hs-var">map_lam_sequential</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Lambda -&gt; Lambda GPU
</span><a href="Futhark.Pass.ExtractKernels.ToGPU.html#soacsLambdaToGPU"><span class="hs-identifier hs-var">soacsLambdaToGPU</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422808"><span class="hs-identifier hs-var">map_lam</span></a></span><span>
</span><span id="line-417"></span><span>          </span><span id="local-6989586621684422796"><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684422796"><span class="hs-identifier hs-var">lvl</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MkSegLevel GPU (State VNameSource)
forall (m :: * -&gt; *). MonadFreshNames m =&gt; MkSegLevel GPU m
</span><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#segThreadCapped"><span class="hs-identifier hs-var">segThreadCapped</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422812"><span class="hs-identifier hs-var">w</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;segred&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ThreadRecommendation
 -&gt; BuilderT GPU (State VNameSource) (SegOpLevel GPU))
-&gt; ThreadRecommendation
-&gt; BuilderT GPU (State VNameSource) (SegOpLevel GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegVirt -&gt; ThreadRecommendation
</span><a href="Futhark.Pass.ExtractKernels.BlockedKernel.html#NoRecommendation"><span class="hs-identifier hs-var">NoRecommendation</span></a></span><span> </span><span class="annot"><span class="annottext">SegVirt
</span><a href="Futhark.IR.SegOp.html#SegNoVirt"><span class="hs-identifier hs-var">SegNoVirt</span></a></span><span>
</span><span id="line-418"></span><span>          </span><span class="annot"><span class="annottext">Stms GPU -&gt; Builder GPU ()
forall (m :: * -&gt; *). MonadBuilder m =&gt; Stms (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#addStms"><span class="hs-identifier hs-var">addStms</span></a></span><span> </span><span class="annot"><span class="annottext">(Stms GPU -&gt; Builder GPU ())
-&gt; (Stms GPU -&gt; Stms GPU) -&gt; Stms GPU -&gt; Builder GPU ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Stm GPU -&gt; Stm GPU) -&gt; Stms GPU -&gt; Stms GPU
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Certs -&gt; Stm GPU -&gt; Stm GPU
forall rep. Certs -&gt; Stm rep -&gt; Stm rep
</span><a href="Futhark.IR.Prop.html#certify"><span class="hs-identifier hs-var">certify</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684422813"><span class="hs-identifier hs-var">cs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-419"></span><span>            </span><span class="annot"><span class="annottext">(Stms GPU -&gt; Builder GPU ())
-&gt; BuilderT GPU (State VNameSource) (Stms GPU) -&gt; Builder GPU ()
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">SegOpLevel GPU
-&gt; Pat GPU
-&gt; SubExp
-&gt; [SegBinOp GPU]
-&gt; Lambda GPU
-&gt; [VName]
-&gt; BuilderT GPU (State VNameSource) (Stms GPU)
forall (m :: * -&gt; *) rep.
(MonadFreshNames m, DistRep rep, HasScope rep m) =&gt;
SegOpLevel rep
-&gt; Pat rep
-&gt; SubExp
-&gt; [SegBinOp rep]
-&gt; Lambda rep
-&gt; [VName]
-&gt; m (Stms rep)
</span><a href="Futhark.Pass.ExtractKernels.BlockedKernel.html#nonSegRed"><span class="hs-identifier hs-var">nonSegRed</span></a></span><span> </span><span class="annot"><span class="annottext">SegOpLevel GPU
SegLevel
</span><a href="#local-6989586621684422796"><span class="hs-identifier hs-var">lvl</span></a></span><span> </span><span class="annot"><span class="annottext">Pat SOACS
Pat GPU
</span><a href="#local-6989586621684422815"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422812"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOp GPU]
</span><a href="#local-6989586621684422806"><span class="hs-identifier hs-var">red_ops</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPU
</span><a href="#local-6989586621684422797"><span class="hs-identifier hs-var">map_lam_sequential</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684422811"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-420"></span><span>
</span><span id="line-421"></span><span>        </span><span id="local-6989586621684422794"><span class="annot"><span class="annottext">outerParallelBody :: DistribM (Body GPU)
</span><a href="#local-6989586621684422794"><span class="hs-identifier hs-var hs-var">outerParallelBody</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-422"></span><span>          </span><span class="annot"><span class="annottext">Body GPU -&gt; DistribM (Body GPU)
forall rep (m :: * -&gt; *).
(Renameable rep, MonadFreshNames m) =&gt;
Body rep -&gt; m (Body rep)
</span><a href="Futhark.Transform.Rename.html#renameBody"><span class="hs-identifier hs-var">renameBody</span></a></span><span>
</span><span id="line-423"></span><span>            </span><span class="annot"><span class="annottext">(Body GPU -&gt; DistribM (Body GPU))
-&gt; DistribM (Body GPU) -&gt; DistribM (Body GPU)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms GPU -&gt; Result -&gt; Body GPU
forall rep. Buildable rep =&gt; Stms rep -&gt; Result -&gt; Body rep
</span><a href="Futhark.Builder.Class.html#mkBody"><span class="hs-identifier hs-var">mkBody</span></a></span><span> </span><span class="annot"><span class="annottext">(Stms GPU -&gt; Result -&gt; Body GPU)
-&gt; DistribM (Stms GPU) -&gt; DistribM (Result -&gt; Body GPU)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">DistribM (Stms GPU)
</span><a href="#local-6989586621684422807"><span class="hs-identifier hs-var">paralleliseOuter</span></a></span><span> </span><span class="annot"><span class="annottext">DistribM (Result -&gt; Body GPU)
-&gt; DistribM Result -&gt; DistribM (Body GPU)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Result -&gt; DistribM Result
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; Result
</span><a href="Futhark.IR.Syntax.html#varsRes"><span class="hs-identifier hs-var">varsRes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatT Type -&gt; [VName]
forall dec. PatT dec -&gt; [VName]
</span><a href="Futhark.IR.Prop.Patterns.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="annot"><span class="annottext">PatT Type
Pat SOACS
</span><a href="#local-6989586621684422815"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-424"></span><span>
</span><span id="line-425"></span><span>        </span><span id="local-6989586621684422792"><span class="annot"><span class="annottext">paralleliseInner :: KernelPath -&gt; DistribM (Stms GPU)
</span><a href="#local-6989586621684422792"><span class="hs-identifier hs-var hs-var">paralleliseInner</span></a></span></span><span> </span><span id="local-6989586621684422791"><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422791"><span class="hs-identifier hs-var">path'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-426"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621684422790"><span class="annot"><span class="annottext">Stm SOACS
</span><a href="#local-6989586621684422790"><span class="hs-identifier hs-var">mapstm</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684422789"><span class="annot"><span class="annottext">Stm SOACS
</span><a href="#local-6989586621684422789"><span class="hs-identifier hs-var">redstm</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-427"></span><span>            </span><span class="annot"><span class="annottext">Pat SOACS
-&gt; (SubExp, [Reduce SOACS], Lambda, [VName])
-&gt; DistribM (Stm SOACS, Stm SOACS)
forall (m :: * -&gt; *) rep.
(MonadFreshNames m, Buildable rep, ExpDec rep ~ (),
 Op rep ~ SOAC rep) =&gt;
Pat rep
-&gt; (SubExp, [Reduce rep], LambdaT rep, [VName])
-&gt; m (Stm rep, Stm rep)
</span><a href="Futhark.Tools.html#redomapToMapAndReduce"><span class="hs-identifier hs-var">redomapToMapAndReduce</span></a></span><span> </span><span class="annot"><span class="annottext">Pat SOACS
</span><a href="#local-6989586621684422815"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422812"><span class="hs-identifier hs-var">w</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Reduce SOACS]
</span><a href="#local-6989586621684422809"><span class="hs-identifier hs-var">reds</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422808"><span class="hs-identifier hs-var">map_lam</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684422811"><span class="hs-identifier hs-var">arrs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-428"></span><span>          </span><span id="local-6989586621684422787"><span class="annot"><span class="annottext">Scope SOACS
</span><a href="#local-6989586621684422787"><span class="hs-identifier hs-var">types</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Scope GPU -&gt; Scope SOACS) -&gt; DistribM (Scope SOACS)
forall rep (m :: * -&gt; *) a.
HasScope rep m =&gt;
(Scope rep -&gt; a) -&gt; m a
</span><a href="Futhark.IR.Prop.Scope.html#asksScope"><span class="hs-identifier hs-var">asksScope</span></a></span><span> </span><span class="annot"><span class="annottext">Scope GPU -&gt; Scope SOACS
</span><a href="Futhark.Pass.ExtractKernels.ToGPU.html#scopeForSOACs"><span class="hs-identifier hs-var">scopeForSOACs</span></a></span><span>
</span><span id="line-429"></span><span>          </span><span class="annot"><span class="annottext">KernelPath -&gt; [Stm SOACS] -&gt; DistribM (Stms GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#transformStms"><span class="hs-identifier hs-var">transformStms</span></a></span><span> </span><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422791"><span class="hs-identifier hs-var">path'</span></a></span><span> </span><span class="annot"><span class="annottext">([Stm SOACS] -&gt; DistribM (Stms GPU))
-&gt; (Stms SOACS -&gt; [Stm SOACS]) -&gt; Stms SOACS -&gt; DistribM (Stms GPU)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Stms SOACS -&gt; [Stm SOACS]
forall rep. Stms rep -&gt; [Stm rep]
</span><a href="Futhark.IR.Syntax.html#stmsToList"><span class="hs-identifier hs-var">stmsToList</span></a></span><span> </span><span class="annot"><span class="annottext">(Stms SOACS -&gt; DistribM (Stms GPU))
-&gt; (BuilderT SOACS DistribM () -&gt; DistribM (Stms SOACS))
-&gt; BuilderT SOACS DistribM ()
-&gt; DistribM (Stms GPU)
forall (m :: * -&gt; *) b c a.
Monad m =&gt;
(b -&gt; m c) -&gt; (a -&gt; m b) -&gt; a -&gt; m c
</span><span class="hs-operator hs-var">&lt;=&lt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BuilderT SOACS DistribM () -&gt; Scope SOACS -&gt; DistribM (Stms SOACS)
forall (m :: * -&gt; *) rep.
MonadFreshNames m =&gt;
BuilderT rep m () -&gt; Scope rep -&gt; m (Stms rep)
</span><a href="Futhark.Builder.html#runBuilderT_"><span class="hs-operator hs-var">`runBuilderT_`</span></a></span><span> </span><span class="annot"><span class="annottext">Scope SOACS
</span><a href="#local-6989586621684422787"><span class="hs-identifier hs-var">types</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(BuilderT SOACS DistribM () -&gt; DistribM (Stms GPU))
-&gt; BuilderT SOACS DistribM () -&gt; DistribM (Stms GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-430"></span><span>            </span><span class="annot"><span class="annottext">Stms SOACS -&gt; BuilderT SOACS DistribM ()
forall (m :: * -&gt; *). MonadBuilder m =&gt; Stms (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#addStms"><span class="hs-identifier hs-var">addStms</span></a></span><span> </span><span class="annot"><span class="annottext">(Stms SOACS -&gt; BuilderT SOACS DistribM ())
-&gt; BuilderT SOACS DistribM (Stms SOACS)
-&gt; BuilderT SOACS DistribM ()
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">Stms SOACS -&gt; BuilderT SOACS DistribM (Stms SOACS)
forall (m :: * -&gt; *).
(HasScope SOACS m, MonadFreshNames m) =&gt;
Stms SOACS -&gt; m (Stms SOACS)
</span><a href="Futhark.IR.SOACS.Simplify.html#simplifyStms"><span class="hs-identifier hs-var">simplifyStms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Stm SOACS] -&gt; Stms SOACS
forall rep. [Stm rep] -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#stmsFromList"><span class="hs-identifier hs-var">stmsFromList</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Certs -&gt; Stm SOACS -&gt; Stm SOACS
forall rep. Certs -&gt; Stm rep -&gt; Stm rep
</span><a href="Futhark.IR.Prop.html#certify"><span class="hs-identifier hs-var">certify</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684422813"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">Stm SOACS
</span><a href="#local-6989586621684422790"><span class="hs-identifier hs-var">mapstm</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Certs -&gt; Stm SOACS -&gt; Stm SOACS
forall rep. Certs -&gt; Stm rep -&gt; Stm rep
</span><a href="Futhark.IR.Prop.html#certify"><span class="hs-identifier hs-var">certify</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684422813"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">Stm SOACS
</span><a href="#local-6989586621684422789"><span class="hs-identifier hs-var">redstm</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-431"></span><span>
</span><span id="line-432"></span><span>        </span><span id="local-6989586621684422783"><span class="annot"><span class="annottext">innerParallelBody :: KernelPath -&gt; DistribM (Body GPU)
</span><a href="#local-6989586621684422783"><span class="hs-identifier hs-var hs-var">innerParallelBody</span></a></span></span><span> </span><span id="local-6989586621684422782"><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422782"><span class="hs-identifier hs-var">path'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-433"></span><span>          </span><span class="annot"><span class="annottext">Body GPU -&gt; DistribM (Body GPU)
forall rep (m :: * -&gt; *).
(Renameable rep, MonadFreshNames m) =&gt;
Body rep -&gt; m (Body rep)
</span><a href="Futhark.Transform.Rename.html#renameBody"><span class="hs-identifier hs-var">renameBody</span></a></span><span>
</span><span id="line-434"></span><span>            </span><span class="annot"><span class="annottext">(Body GPU -&gt; DistribM (Body GPU))
-&gt; DistribM (Body GPU) -&gt; DistribM (Body GPU)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms GPU -&gt; Result -&gt; Body GPU
forall rep. Buildable rep =&gt; Stms rep -&gt; Result -&gt; Body rep
</span><a href="Futhark.Builder.Class.html#mkBody"><span class="hs-identifier hs-var">mkBody</span></a></span><span> </span><span class="annot"><span class="annottext">(Stms GPU -&gt; Result -&gt; Body GPU)
-&gt; DistribM (Stms GPU) -&gt; DistribM (Result -&gt; Body GPU)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">KernelPath -&gt; DistribM (Stms GPU)
</span><a href="#local-6989586621684422792"><span class="hs-identifier hs-var">paralleliseInner</span></a></span><span> </span><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422782"><span class="hs-identifier hs-var">path'</span></a></span><span> </span><span class="annot"><span class="annottext">DistribM (Result -&gt; Body GPU)
-&gt; DistribM Result -&gt; DistribM (Body GPU)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Result -&gt; DistribM Result
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; Result
</span><a href="Futhark.IR.Syntax.html#varsRes"><span class="hs-identifier hs-var">varsRes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatT Type -&gt; [VName]
forall dec. PatT dec -&gt; [VName]
</span><a href="Futhark.IR.Prop.Patterns.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="annot"><span class="annottext">PatT Type
Pat SOACS
</span><a href="#local-6989586621684422815"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-435"></span><span>
</span><span id="line-436"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda -&gt; Bool
</span><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#lambdaContainsParallelism"><span class="hs-identifier hs-var">lambdaContainsParallelism</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422808"><span class="hs-identifier hs-var">map_lam</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-437"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Attr
</span><span class="hs-string">&quot;sequential_inner&quot;</span></span><span> </span><span class="annot"><span class="annottext">Attr -&gt; Attrs -&gt; Bool
</span><a href="Futhark.IR.Syntax.Core.html#inAttrs"><span class="hs-operator hs-var">`inAttrs`</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux () -&gt; Attrs
forall dec. StmAux dec -&gt; Attrs
</span><a href="Futhark.IR.Syntax.html#stmAuxAttrs"><span class="hs-identifier hs-var hs-var">stmAuxAttrs</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux ()
StmAux (ExpDec SOACS)
</span><a href="#local-6989586621684422814"><span class="hs-identifier hs-var">aux</span></a></span><span>
</span><span id="line-438"></span><span>      </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">DistribM (Stms GPU)
</span><a href="#local-6989586621684422807"><span class="hs-identifier hs-var">paralleliseOuter</span></a></span><span>
</span><span id="line-439"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-440"></span><span>        </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621684422781"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422781"><span class="hs-identifier hs-var">outer_suff</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684422780"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684422780"><span class="hs-identifier hs-var">outer_suff_key</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621684422779"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684422779"><span class="hs-identifier hs-var">suff_stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-441"></span><span>          </span><span class="annot"><span class="annottext">[Char]
-&gt; [SubExp]
-&gt; KernelPath
-&gt; Maybe Int64
-&gt; DistribM ((SubExp, Name), Stms GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#sufficientParallelism"><span class="hs-identifier hs-var">sufficientParallelism</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;suff_outer_redomap&quot;</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422812"><span class="hs-identifier hs-var">w</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422816"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Int64
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-442"></span><span>
</span><span id="line-443"></span><span>        </span><span id="local-6989586621684422777"><span class="annot"><span class="annottext">Body GPU
</span><a href="#local-6989586621684422777"><span class="hs-identifier hs-var">outer_stms</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DistribM (Body GPU)
</span><a href="#local-6989586621684422794"><span class="hs-identifier hs-var">outerParallelBody</span></a></span><span>
</span><span id="line-444"></span><span>        </span><span id="local-6989586621684422776"><span class="annot"><span class="annottext">Body GPU
</span><a href="#local-6989586621684422776"><span class="hs-identifier hs-var">inner_stms</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">KernelPath -&gt; DistribM (Body GPU)
</span><a href="#local-6989586621684422783"><span class="hs-identifier hs-var">innerParallelBody</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684422780"><span class="hs-identifier hs-var">outer_suff_key</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Name, Bool) -&gt; KernelPath -&gt; KernelPath
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422816"><span class="hs-identifier hs-var">path</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-445"></span><span>
</span><span id="line-446"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684422779"><span class="hs-identifier hs-var">suff_stms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPU -&gt; Stms GPU -&gt; Stms GPU
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Stms GPU -&gt; Stms GPU)
-&gt; DistribM (Stms GPU) -&gt; DistribM (Stms GPU)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Pat GPU -&gt; Body GPU -&gt; [(SubExp, Body GPU)] -&gt; DistribM (Stms GPU)
forall (m :: * -&gt; *).
(MonadFreshNames m, HasScope GPU m) =&gt;
Pat GPU -&gt; Body GPU -&gt; [(SubExp, Body GPU)] -&gt; m (Stms GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#kernelAlternatives"><span class="hs-identifier hs-var">kernelAlternatives</span></a></span><span> </span><span class="annot"><span class="annottext">Pat SOACS
Pat GPU
</span><a href="#local-6989586621684422815"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">Body GPU
</span><a href="#local-6989586621684422776"><span class="hs-identifier hs-var">inner_stms</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422781"><span class="hs-identifier hs-var">outer_suff</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Body GPU
</span><a href="#local-6989586621684422777"><span class="hs-identifier hs-var">outer_stms</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-447"></span><span>
</span><span id="line-448"></span><span class="hs-comment">-- Streams can be handled in two different ways - either we</span><span>
</span><span id="line-449"></span><span class="hs-comment">-- sequentialise the body or we keep it parallel and distribute.</span><span>
</span><span id="line-450"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#transformStm"><span class="hs-identifier hs-var">transformStm</span></a></span><span> </span><span id="local-6989586621684422775"><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422775"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684422774"><span class="annot"><span class="annottext">Pat SOACS
</span><a href="#local-6989586621684422774"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684422773"><span class="annot"><span class="annottext">aux :: StmAux (ExpDec SOACS)
</span><a href="#local-6989586621684422773"><span class="hs-identifier hs-var">aux</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#StmAux"><span class="hs-identifier hs-type">StmAux</span></a></span><span> </span><span id="local-6989586621684422772"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684422772"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ExpDec SOACS
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621684422771"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422771"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684422770"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684422770"><span class="hs-identifier hs-var">arrs</span></a></span></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Parallel"><span class="hs-identifier hs-type">Parallel</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span id="local-6989586621684422768"><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422768"><span class="hs-identifier hs-var">map_fun</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-451"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Attr
</span><span class="hs-string">&quot;sequential_inner&quot;</span></span><span> </span><span class="annot"><span class="annottext">Attr -&gt; Attrs -&gt; Bool
</span><a href="Futhark.IR.Syntax.Core.html#inAttrs"><span class="hs-operator hs-var">`inAttrs`</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux () -&gt; Attrs
forall dec. StmAux dec -&gt; Attrs
</span><a href="Futhark.IR.Syntax.html#stmAuxAttrs"><span class="hs-identifier hs-var hs-var">stmAuxAttrs</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux ()
StmAux (ExpDec SOACS)
</span><a href="#local-6989586621684422773"><span class="hs-identifier hs-var">aux</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-452"></span><span>    </span><span class="hs-comment">-- No reduction part.  Remove the stream and leave the body</span><span>
</span><span id="line-453"></span><span>    </span><span class="hs-comment">-- parallel.  It will be distributed.</span><span>
</span><span id="line-454"></span><span>    </span><span id="local-6989586621684422767"><span class="annot"><span class="annottext">Scope SOACS
</span><a href="#local-6989586621684422767"><span class="hs-identifier hs-var">types</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Scope GPU -&gt; Scope SOACS) -&gt; DistribM (Scope SOACS)
forall rep (m :: * -&gt; *) a.
HasScope rep m =&gt;
(Scope rep -&gt; a) -&gt; m a
</span><a href="Futhark.IR.Prop.Scope.html#asksScope"><span class="hs-identifier hs-var">asksScope</span></a></span><span> </span><span class="annot"><span class="annottext">Scope GPU -&gt; Scope SOACS
</span><a href="Futhark.Pass.ExtractKernels.ToGPU.html#scopeForSOACs"><span class="hs-identifier hs-var">scopeForSOACs</span></a></span><span>
</span><span id="line-455"></span><span>    </span><span class="annot"><span class="annottext">KernelPath -&gt; [Stm SOACS] -&gt; DistribM (Stms GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#transformStms"><span class="hs-identifier hs-var">transformStms</span></a></span><span> </span><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422775"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="annot"><span class="annottext">([Stm SOACS] -&gt; DistribM (Stms GPU))
-&gt; (((), Stms SOACS) -&gt; [Stm SOACS])
-&gt; ((), Stms SOACS)
-&gt; DistribM (Stms GPU)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Stms SOACS -&gt; [Stm SOACS]
forall rep. Stms rep -&gt; [Stm rep]
</span><a href="Futhark.IR.Syntax.html#stmsToList"><span class="hs-identifier hs-var">stmsToList</span></a></span><span> </span><span class="annot"><span class="annottext">(Stms SOACS -&gt; [Stm SOACS])
-&gt; (((), Stms SOACS) -&gt; Stms SOACS)
-&gt; ((), Stms SOACS)
-&gt; [Stm SOACS]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">((), Stms SOACS) -&gt; Stms SOACS
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span>
</span><span id="line-456"></span><span>      </span><span class="annot"><span class="annottext">(((), Stms SOACS) -&gt; DistribM (Stms GPU))
-&gt; DistribM ((), Stms SOACS) -&gt; DistribM (Stms GPU)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">BuilderT SOACS DistribM ()
-&gt; Scope SOACS -&gt; DistribM ((), Stms SOACS)
forall (m :: * -&gt; *) rep a.
MonadFreshNames m =&gt;
BuilderT rep m a -&gt; Scope rep -&gt; m (a, Stms rep)
</span><a href="Futhark.Builder.html#runBuilderT"><span class="hs-identifier hs-var">runBuilderT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Certs -&gt; BuilderT SOACS DistribM () -&gt; BuilderT SOACS DistribM ()
forall (m :: * -&gt; *) a. MonadBuilder m =&gt; Certs -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#certifying"><span class="hs-identifier hs-var">certifying</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684422772"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">(BuilderT SOACS DistribM () -&gt; BuilderT SOACS DistribM ())
-&gt; BuilderT SOACS DistribM () -&gt; BuilderT SOACS DistribM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat (Rep (BuilderT SOACS DistribM))
-&gt; SubExp
-&gt; [SubExp]
-&gt; LambdaT (Rep (BuilderT SOACS DistribM))
-&gt; [VName]
-&gt; BuilderT SOACS DistribM ()
forall (m :: * -&gt; *).
(MonadBuilder m, Buildable (Rep m)) =&gt;
Pat (Rep m)
-&gt; SubExp -&gt; [SubExp] -&gt; LambdaT (Rep m) -&gt; [VName] -&gt; m ()
</span><a href="Futhark.Tools.html#sequentialStreamWholeArray"><span class="hs-identifier hs-var">sequentialStreamWholeArray</span></a></span><span> </span><span class="annot"><span class="annottext">Pat (Rep (BuilderT SOACS DistribM))
Pat SOACS
</span><a href="#local-6989586621684422774"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422771"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">LambdaT (Rep (BuilderT SOACS DistribM))
Lambda
</span><a href="#local-6989586621684422768"><span class="hs-identifier hs-var">map_fun</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684422770"><span class="hs-identifier hs-var">arrs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Scope SOACS
</span><a href="#local-6989586621684422767"><span class="hs-identifier hs-var">types</span></a></span><span>
</span><span id="line-457"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#transformStm"><span class="hs-identifier hs-var">transformStm</span></a></span><span> </span><span id="local-6989586621684422765"><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422765"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684422764"><span class="annot"><span class="annottext">Pat SOACS
</span><a href="#local-6989586621684422764"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684422763"><span class="annot"><span class="annottext">aux :: StmAux (ExpDec SOACS)
</span><a href="#local-6989586621684422763"><span class="hs-identifier hs-var">aux</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#StmAux"><span class="hs-identifier hs-type">StmAux</span></a></span><span> </span><span id="local-6989586621684422762"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684422762"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ExpDec SOACS
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621684422761"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422761"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684422760"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684422760"><span class="hs-identifier hs-var">arrs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Parallel"><span class="hs-identifier hs-type">Parallel</span></a></span><span> </span><span id="local-6989586621684422759"><span class="annot"><span class="annottext">StreamOrd
</span><a href="#local-6989586621684422759"><span class="hs-identifier hs-var">o</span></a></span></span><span> </span><span id="local-6989586621684422758"><span class="annot"><span class="annottext">Commutativity
</span><a href="#local-6989586621684422758"><span class="hs-identifier hs-var">comm</span></a></span></span><span> </span><span id="local-6989586621684422757"><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422757"><span class="hs-identifier hs-var">red_fun</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684422756"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684422756"><span class="hs-identifier hs-var">nes</span></a></span></span><span> </span><span id="local-6989586621684422755"><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422755"><span class="hs-identifier hs-var">fold_fun</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-458"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Attr
</span><span class="hs-string">&quot;sequential_inner&quot;</span></span><span> </span><span class="annot"><span class="annottext">Attr -&gt; Attrs -&gt; Bool
</span><a href="Futhark.IR.Syntax.Core.html#inAttrs"><span class="hs-operator hs-var">`inAttrs`</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux () -&gt; Attrs
forall dec. StmAux dec -&gt; Attrs
</span><a href="Futhark.IR.Syntax.html#stmAuxAttrs"><span class="hs-identifier hs-var hs-var">stmAuxAttrs</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux ()
StmAux (ExpDec SOACS)
</span><a href="#local-6989586621684422763"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-459"></span><span>    </span><span class="annot"><span class="annottext">KernelPath -&gt; DistribM (Stms GPU)
</span><a href="#local-6989586621684422754"><span class="hs-identifier hs-var">paralleliseOuter</span></a></span><span> </span><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422765"><span class="hs-identifier hs-var">path</span></a></span><span>
</span><span id="line-460"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-461"></span><span>    </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621684422753"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422753"><span class="hs-identifier hs-var">outer_suff</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684422752"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684422752"><span class="hs-identifier hs-var">outer_suff_key</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621684422751"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684422751"><span class="hs-identifier hs-var">suff_stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-462"></span><span>      </span><span class="annot"><span class="annottext">[Char]
-&gt; [SubExp]
-&gt; KernelPath
-&gt; Maybe Int64
-&gt; DistribM ((SubExp, Name), Stms GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#sufficientParallelism"><span class="hs-identifier hs-var">sufficientParallelism</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;suff_outer_stream&quot;</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422761"><span class="hs-identifier hs-var">w</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422765"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Int64
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-463"></span><span>
</span><span id="line-464"></span><span>    </span><span id="local-6989586621684422750"><span class="annot"><span class="annottext">Body GPU
</span><a href="#local-6989586621684422750"><span class="hs-identifier hs-var">outer_stms</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">KernelPath -&gt; DistribM (Body GPU)
</span><a href="#local-6989586621684422749"><span class="hs-identifier hs-var">outerParallelBody</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684422752"><span class="hs-identifier hs-var">outer_suff_key</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Name, Bool) -&gt; KernelPath -&gt; KernelPath
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422765"><span class="hs-identifier hs-var">path</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-465"></span><span>    </span><span id="local-6989586621684422748"><span class="annot"><span class="annottext">Body GPU
</span><a href="#local-6989586621684422748"><span class="hs-identifier hs-var">inner_stms</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">KernelPath -&gt; DistribM (Body GPU)
</span><a href="#local-6989586621684422747"><span class="hs-identifier hs-var">innerParallelBody</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684422752"><span class="hs-identifier hs-var">outer_suff_key</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Name, Bool) -&gt; KernelPath -&gt; KernelPath
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422765"><span class="hs-identifier hs-var">path</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-466"></span><span>
</span><span id="line-467"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684422751"><span class="hs-identifier hs-var">suff_stms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPU -&gt; Stms GPU -&gt; Stms GPU
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span class="hs-special">)</span><span>
</span><span id="line-468"></span><span>      </span><span class="annot"><span class="annottext">(Stms GPU -&gt; Stms GPU)
-&gt; DistribM (Stms GPU) -&gt; DistribM (Stms GPU)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Pat GPU -&gt; Body GPU -&gt; [(SubExp, Body GPU)] -&gt; DistribM (Stms GPU)
forall (m :: * -&gt; *).
(MonadFreshNames m, HasScope GPU m) =&gt;
Pat GPU -&gt; Body GPU -&gt; [(SubExp, Body GPU)] -&gt; m (Stms GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#kernelAlternatives"><span class="hs-identifier hs-var">kernelAlternatives</span></a></span><span> </span><span class="annot"><span class="annottext">Pat SOACS
Pat GPU
</span><a href="#local-6989586621684422764"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">Body GPU
</span><a href="#local-6989586621684422748"><span class="hs-identifier hs-var">inner_stms</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422753"><span class="hs-identifier hs-var">outer_suff</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Body GPU
</span><a href="#local-6989586621684422750"><span class="hs-identifier hs-var">outer_stms</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-469"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-470"></span><span>    </span><span id="local-6989586621684422754"><span class="annot"><span class="annottext">paralleliseOuter :: KernelPath -&gt; DistribM (Stms GPU)
</span><a href="#local-6989586621684422754"><span class="hs-identifier hs-var hs-var">paralleliseOuter</span></a></span></span><span> </span><span id="local-6989586621684422746"><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422746"><span class="hs-identifier hs-var">path'</span></a></span></span><span>
</span><span id="line-471"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Bool) -&gt; [Type] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Bool
forall shape u. TypeBase shape u -&gt; Bool
</span><a href="Futhark.IR.Prop.Types.html#primType"><span class="hs-identifier hs-var">primType</span></a></span><span> </span><span class="annot"><span class="annottext">([Type] -&gt; Bool) -&gt; [Type] -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda -&gt; [Type]
forall rep. LambdaT rep -&gt; [Type]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422757"><span class="hs-identifier hs-var">red_fun</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-472"></span><span>        </span><span class="hs-comment">-- Split into a chunked map and a reduction, with the latter</span><span>
</span><span id="line-473"></span><span>        </span><span class="hs-comment">-- further transformed.</span><span>
</span><span id="line-474"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684422742"><span class="annot"><span class="annottext">fold_fun' :: Lambda GPU
</span><a href="#local-6989586621684422742"><span class="hs-identifier hs-var hs-var">fold_fun'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Lambda -&gt; Lambda GPU
</span><a href="Futhark.Pass.ExtractKernels.ToGPU.html#soacsLambdaToGPU"><span class="hs-identifier hs-var">soacsLambdaToGPU</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422755"><span class="hs-identifier hs-var">fold_fun</span></a></span><span>
</span><span id="line-475"></span><span>
</span><span id="line-476"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684422741"><span class="annot"><span class="annottext">[PatElemT Type]
</span><a href="#local-6989586621684422741"><span class="hs-identifier hs-var">red_pat_elems</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684422740"><span class="annot"><span class="annottext">[PatElemT Type]
</span><a href="#local-6989586621684422740"><span class="hs-identifier hs-var">concat_pat_elems</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-477"></span><span>              </span><span class="annot"><span class="annottext">Int -&gt; [PatElemT Type] -&gt; ([PatElemT Type], [PatElemT Type])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684422756"><span class="hs-identifier hs-var">nes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([PatElemT Type] -&gt; ([PatElemT Type], [PatElemT Type]))
-&gt; [PatElemT Type] -&gt; ([PatElemT Type], [PatElemT Type])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatT Type -&gt; [PatElemT Type]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span> </span><span class="annot"><span class="annottext">PatT Type
Pat SOACS
</span><a href="#local-6989586621684422764"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-478"></span><span>            </span><span id="local-6989586621684422737"><span class="annot"><span class="annottext">red_pat :: PatT Type
</span><a href="#local-6989586621684422737"><span class="hs-identifier hs-var hs-var">red_pat</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[PatElemT Type] -&gt; PatT Type
forall dec. [PatElemT dec] -&gt; PatT dec
</span><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-var">Pat</span></a></span><span> </span><span class="annot"><span class="annottext">[PatElemT Type]
</span><a href="#local-6989586621684422741"><span class="hs-identifier hs-var">red_pat_elems</span></a></span><span>
</span><span id="line-479"></span><span>
</span><span id="line-480"></span><span>        </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621684422736"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422736"><span class="hs-identifier hs-var">num_threads</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684422735"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684422735"><span class="hs-identifier hs-var">red_results</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621684422734"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684422734"><span class="hs-identifier hs-var">stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-481"></span><span>          </span><span class="annot"><span class="annottext">MkSegLevel GPU DistribM
-&gt; [[Char]]
-&gt; [PatElem GPU]
-&gt; SubExp
-&gt; Commutativity
-&gt; Lambda GPU
-&gt; [SubExp]
-&gt; [VName]
-&gt; DistribM ((SubExp, [VName]), Stms GPU)
forall (m :: * -&gt; *).
(MonadFreshNames m, HasScope GPU m) =&gt;
MkSegLevel GPU m
-&gt; [[Char]]
-&gt; [PatElem GPU]
-&gt; SubExp
-&gt; Commutativity
-&gt; Lambda GPU
-&gt; [SubExp]
-&gt; [VName]
-&gt; m ((SubExp, [VName]), Stms GPU)
</span><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#streamMap"><span class="hs-identifier hs-var">streamMap</span></a></span><span>
</span><span id="line-482"></span><span>            </span><span class="annot"><span class="annottext">MkSegLevel GPU DistribM
forall (m :: * -&gt; *). MonadFreshNames m =&gt; MkSegLevel GPU m
</span><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#segThreadCapped"><span class="hs-identifier hs-var">segThreadCapped</span></a></span><span>
</span><span id="line-483"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PatElemT Type -&gt; [Char]) -&gt; [PatElemT Type] -&gt; [[Char]]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; [Char]
</span><a href="Language.Futhark.Core.html#baseString"><span class="hs-identifier hs-var">baseString</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; [Char])
-&gt; (PatElemT Type -&gt; VName) -&gt; PatElemT Type -&gt; [Char]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PatElemT Type -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[PatElemT Type]
</span><a href="#local-6989586621684422741"><span class="hs-identifier hs-var">red_pat_elems</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-484"></span><span>            </span><span class="annot"><span class="annottext">[PatElemT Type]
[PatElem GPU]
</span><a href="#local-6989586621684422740"><span class="hs-identifier hs-var">concat_pat_elems</span></a></span><span>
</span><span id="line-485"></span><span>            </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422761"><span class="hs-identifier hs-var">w</span></a></span><span>
</span><span id="line-486"></span><span>            </span><span class="annot"><span class="annottext">Commutativity
</span><a href="Futhark.IR.Syntax.Core.html#Noncommutative"><span class="hs-identifier hs-var">Noncommutative</span></a></span><span>
</span><span id="line-487"></span><span>            </span><span class="annot"><span class="annottext">Lambda GPU
</span><a href="#local-6989586621684422742"><span class="hs-identifier hs-var">fold_fun'</span></a></span><span>
</span><span id="line-488"></span><span>            </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684422756"><span class="hs-identifier hs-var">nes</span></a></span><span>
</span><span id="line-489"></span><span>            </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684422760"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-490"></span><span>
</span><span id="line-491"></span><span>        </span><span id="local-6989586621684422732"><span class="annot"><span class="annottext">ScremaForm SOACS
</span><a href="#local-6989586621684422732"><span class="hs-identifier hs-var">reduce_soac</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Reduce SOACS] -&gt; DistribM (ScremaForm SOACS)
forall rep (m :: * -&gt; *).
(Buildable rep, MonadFreshNames m) =&gt;
[Reduce rep] -&gt; m (ScremaForm rep)
</span><a href="Futhark.IR.SOACS.SOAC.html#reduceSOAC"><span class="hs-identifier hs-var">reduceSOAC</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Commutativity -&gt; Lambda -&gt; [SubExp] -&gt; Reduce SOACS
forall rep. Commutativity -&gt; Lambda rep -&gt; [SubExp] -&gt; Reduce rep
</span><a href="Futhark.IR.SOACS.SOAC.html#Reduce"><span class="hs-identifier hs-var">Reduce</span></a></span><span> </span><span class="annot"><span class="annottext">Commutativity
</span><a href="#local-6989586621684422730"><span class="hs-identifier hs-var">comm'</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422757"><span class="hs-identifier hs-var">red_fun</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684422756"><span class="hs-identifier hs-var">nes</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-492"></span><span>
</span><span id="line-493"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684422734"><span class="hs-identifier hs-var">stms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPU -&gt; Stms GPU -&gt; Stms GPU
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span class="hs-special">)</span><span>
</span><span id="line-494"></span><span>          </span><span class="annot"><span class="annottext">(Stms GPU -&gt; Stms GPU)
-&gt; DistribM (Stms GPU) -&gt; DistribM (Stms GPU)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Stms GPU -&gt; DistribM (Stms GPU) -&gt; DistribM (Stms GPU)
forall rep a (m :: * -&gt; *) b.
(Scoped rep a, LocalScope rep m) =&gt;
a -&gt; m b -&gt; m b
</span><a href="Futhark.IR.Prop.Scope.html#inScopeOf"><span class="hs-identifier hs-var">inScopeOf</span></a></span><span>
</span><span id="line-495"></span><span>            </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684422734"><span class="hs-identifier hs-var">stms</span></a></span><span>
</span><span id="line-496"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">KernelPath -&gt; Stm SOACS -&gt; DistribM (Stms GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#transformStm"><span class="hs-identifier hs-var">transformStm</span></a></span><span> </span><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422746"><span class="hs-identifier hs-var">path'</span></a></span><span> </span><span class="annot"><span class="annottext">(Stm SOACS -&gt; DistribM (Stms GPU))
-&gt; Stm SOACS -&gt; DistribM (Stms GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-497"></span><span>                </span><span class="annot"><span class="annottext">Pat SOACS -&gt; StmAux (ExpDec SOACS) -&gt; ExpT SOACS -&gt; Stm SOACS
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">PatT Type
Pat SOACS
</span><a href="#local-6989586621684422737"><span class="hs-identifier hs-var">red_pat</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux ()
StmAux (ExpDec SOACS)
</span><a href="#local-6989586621684422763"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">stmAuxAttrs :: Attrs
</span><a href="Futhark.IR.Syntax.html#stmAuxAttrs"><span class="hs-identifier hs-var">stmAuxAttrs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Attrs
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">}</span><span> </span><span class="annot"><span class="annottext">(ExpT SOACS -&gt; Stm SOACS) -&gt; ExpT SOACS -&gt; Stm SOACS
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-498"></span><span>                  </span><span class="annot"><span class="annottext">Op SOACS -&gt; ExpT SOACS
forall rep. Op rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-var">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp -&gt; [VName] -&gt; ScremaForm SOACS -&gt; SOAC SOACS
forall rep. SubExp -&gt; [VName] -&gt; ScremaForm rep -&gt; SOAC rep
</span><a href="Futhark.IR.SOACS.SOAC.html#Screma"><span class="hs-identifier hs-var">Screma</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422736"><span class="hs-identifier hs-var">num_threads</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684422735"><span class="hs-identifier hs-var">red_results</span></a></span><span> </span><span class="annot"><span class="annottext">ScremaForm SOACS
</span><a href="#local-6989586621684422732"><span class="hs-identifier hs-var">reduce_soac</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-499"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-500"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-501"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684422729"><span class="annot"><span class="annottext">red_fun_sequential :: Lambda GPU
</span><a href="#local-6989586621684422729"><span class="hs-identifier hs-var hs-var">red_fun_sequential</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Lambda -&gt; Lambda GPU
</span><a href="Futhark.Pass.ExtractKernels.ToGPU.html#soacsLambdaToGPU"><span class="hs-identifier hs-var">soacsLambdaToGPU</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422757"><span class="hs-identifier hs-var">red_fun</span></a></span><span>
</span><span id="line-502"></span><span>            </span><span id="local-6989586621684422728"><span class="annot"><span class="annottext">fold_fun_sequential :: Lambda GPU
</span><a href="#local-6989586621684422728"><span class="hs-identifier hs-var hs-var">fold_fun_sequential</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Lambda -&gt; Lambda GPU
</span><a href="Futhark.Pass.ExtractKernels.ToGPU.html#soacsLambdaToGPU"><span class="hs-identifier hs-var">soacsLambdaToGPU</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422755"><span class="hs-identifier hs-var">fold_fun</span></a></span><span>
</span><span id="line-503"></span><span>        </span><span class="annot"><span class="annottext">(Stm GPU -&gt; Stm GPU) -&gt; Stms GPU -&gt; Stms GPU
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Certs -&gt; Stm GPU -&gt; Stm GPU
forall rep. Certs -&gt; Stm rep -&gt; Stm rep
</span><a href="Futhark.IR.Prop.html#certify"><span class="hs-identifier hs-var">certify</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684422762"><span class="hs-identifier hs-var">cs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-504"></span><span>          </span><span class="annot"><span class="annottext">(Stms GPU -&gt; Stms GPU)
-&gt; DistribM (Stms GPU) -&gt; DistribM (Stms GPU)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">MkSegLevel GPU DistribM
-&gt; Pat GPU
-&gt; SubExp
-&gt; Commutativity
-&gt; Lambda GPU
-&gt; Lambda GPU
-&gt; [SubExp]
-&gt; [VName]
-&gt; DistribM (Stms GPU)
forall (m :: * -&gt; *).
(MonadFreshNames m, HasScope GPU m) =&gt;
MkSegLevel GPU m
-&gt; Pat GPU
-&gt; SubExp
-&gt; Commutativity
-&gt; Lambda GPU
-&gt; Lambda GPU
-&gt; [SubExp]
-&gt; [VName]
-&gt; m (Stms GPU)
</span><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#streamRed"><span class="hs-identifier hs-var">streamRed</span></a></span><span>
</span><span id="line-505"></span><span>            </span><span class="annot"><span class="annottext">MkSegLevel GPU DistribM
forall (m :: * -&gt; *). MonadFreshNames m =&gt; MkSegLevel GPU m
</span><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#segThreadCapped"><span class="hs-identifier hs-var">segThreadCapped</span></a></span><span>
</span><span id="line-506"></span><span>            </span><span class="annot"><span class="annottext">Pat SOACS
Pat GPU
</span><a href="#local-6989586621684422764"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-507"></span><span>            </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422761"><span class="hs-identifier hs-var">w</span></a></span><span>
</span><span id="line-508"></span><span>            </span><span class="annot"><span class="annottext">Commutativity
</span><a href="#local-6989586621684422730"><span class="hs-identifier hs-var">comm'</span></a></span><span>
</span><span id="line-509"></span><span>            </span><span class="annot"><span class="annottext">Lambda GPU
</span><a href="#local-6989586621684422729"><span class="hs-identifier hs-var">red_fun_sequential</span></a></span><span>
</span><span id="line-510"></span><span>            </span><span class="annot"><span class="annottext">Lambda GPU
</span><a href="#local-6989586621684422728"><span class="hs-identifier hs-var">fold_fun_sequential</span></a></span><span>
</span><span id="line-511"></span><span>            </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684422756"><span class="hs-identifier hs-var">nes</span></a></span><span>
</span><span id="line-512"></span><span>            </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684422760"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-513"></span><span>
</span><span id="line-514"></span><span>    </span><span id="local-6989586621684422749"><span class="annot"><span class="annottext">outerParallelBody :: KernelPath -&gt; DistribM (Body GPU)
</span><a href="#local-6989586621684422749"><span class="hs-identifier hs-var hs-var">outerParallelBody</span></a></span></span><span> </span><span id="local-6989586621684422726"><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422726"><span class="hs-identifier hs-var">path'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-515"></span><span>      </span><span class="annot"><span class="annottext">Body GPU -&gt; DistribM (Body GPU)
forall rep (m :: * -&gt; *).
(Renameable rep, MonadFreshNames m) =&gt;
Body rep -&gt; m (Body rep)
</span><a href="Futhark.Transform.Rename.html#renameBody"><span class="hs-identifier hs-var">renameBody</span></a></span><span>
</span><span id="line-516"></span><span>        </span><span class="annot"><span class="annottext">(Body GPU -&gt; DistribM (Body GPU))
-&gt; DistribM (Body GPU) -&gt; DistribM (Body GPU)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms GPU -&gt; Result -&gt; Body GPU
forall rep. Buildable rep =&gt; Stms rep -&gt; Result -&gt; Body rep
</span><a href="Futhark.Builder.Class.html#mkBody"><span class="hs-identifier hs-var">mkBody</span></a></span><span> </span><span class="annot"><span class="annottext">(Stms GPU -&gt; Result -&gt; Body GPU)
-&gt; DistribM (Stms GPU) -&gt; DistribM (Result -&gt; Body GPU)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">KernelPath -&gt; DistribM (Stms GPU)
</span><a href="#local-6989586621684422754"><span class="hs-identifier hs-var">paralleliseOuter</span></a></span><span> </span><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422726"><span class="hs-identifier hs-var">path'</span></a></span><span> </span><span class="annot"><span class="annottext">DistribM (Result -&gt; Body GPU)
-&gt; DistribM Result -&gt; DistribM (Body GPU)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Result -&gt; DistribM Result
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; Result
</span><a href="Futhark.IR.Syntax.html#varsRes"><span class="hs-identifier hs-var">varsRes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatT Type -&gt; [VName]
forall dec. PatT dec -&gt; [VName]
</span><a href="Futhark.IR.Prop.Patterns.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="annot"><span class="annottext">PatT Type
Pat SOACS
</span><a href="#local-6989586621684422764"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-517"></span><span>
</span><span id="line-518"></span><span>    </span><span id="local-6989586621684422725"><span class="annot"><span class="annottext">paralleliseInner :: KernelPath -&gt; DistribM (Stms GPU)
</span><a href="#local-6989586621684422725"><span class="hs-identifier hs-var hs-var">paralleliseInner</span></a></span></span><span> </span><span id="local-6989586621684422724"><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422724"><span class="hs-identifier hs-var">path'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-519"></span><span>      </span><span id="local-6989586621684422723"><span class="annot"><span class="annottext">Scope SOACS
</span><a href="#local-6989586621684422723"><span class="hs-identifier hs-var">types</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Scope GPU -&gt; Scope SOACS) -&gt; DistribM (Scope SOACS)
forall rep (m :: * -&gt; *) a.
HasScope rep m =&gt;
(Scope rep -&gt; a) -&gt; m a
</span><a href="Futhark.IR.Prop.Scope.html#asksScope"><span class="hs-identifier hs-var">asksScope</span></a></span><span> </span><span class="annot"><span class="annottext">Scope GPU -&gt; Scope SOACS
</span><a href="Futhark.Pass.ExtractKernels.ToGPU.html#scopeForSOACs"><span class="hs-identifier hs-var">scopeForSOACs</span></a></span><span>
</span><span id="line-520"></span><span>      </span><span class="annot"><span class="annottext">KernelPath -&gt; [Stm SOACS] -&gt; DistribM (Stms GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#transformStms"><span class="hs-identifier hs-var">transformStms</span></a></span><span> </span><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422724"><span class="hs-identifier hs-var">path'</span></a></span><span> </span><span class="annot"><span class="annottext">([Stm SOACS] -&gt; DistribM (Stms GPU))
-&gt; (((), Stms SOACS) -&gt; [Stm SOACS])
-&gt; ((), Stms SOACS)
-&gt; DistribM (Stms GPU)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Stm SOACS -&gt; Stm SOACS) -&gt; [Stm SOACS] -&gt; [Stm SOACS]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Certs -&gt; Stm SOACS -&gt; Stm SOACS
forall rep. Certs -&gt; Stm rep -&gt; Stm rep
</span><a href="Futhark.IR.Prop.html#certify"><span class="hs-identifier hs-var">certify</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684422762"><span class="hs-identifier hs-var">cs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Stm SOACS] -&gt; [Stm SOACS])
-&gt; (((), Stms SOACS) -&gt; [Stm SOACS])
-&gt; ((), Stms SOACS)
-&gt; [Stm SOACS]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Stms SOACS -&gt; [Stm SOACS]
forall rep. Stms rep -&gt; [Stm rep]
</span><a href="Futhark.IR.Syntax.html#stmsToList"><span class="hs-identifier hs-var">stmsToList</span></a></span><span> </span><span class="annot"><span class="annottext">(Stms SOACS -&gt; [Stm SOACS])
-&gt; (((), Stms SOACS) -&gt; Stms SOACS)
-&gt; ((), Stms SOACS)
-&gt; [Stm SOACS]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">((), Stms SOACS) -&gt; Stms SOACS
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span>
</span><span id="line-521"></span><span>        </span><span class="annot"><span class="annottext">(((), Stms SOACS) -&gt; DistribM (Stms GPU))
-&gt; DistribM ((), Stms SOACS) -&gt; DistribM (Stms GPU)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">BuilderT SOACS DistribM ()
-&gt; Scope SOACS -&gt; DistribM ((), Stms SOACS)
forall (m :: * -&gt; *) rep a.
MonadFreshNames m =&gt;
BuilderT rep m a -&gt; Scope rep -&gt; m (a, Stms rep)
</span><a href="Futhark.Builder.html#runBuilderT"><span class="hs-identifier hs-var">runBuilderT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pat (Rep (BuilderT SOACS DistribM))
-&gt; SubExp
-&gt; [SubExp]
-&gt; LambdaT (Rep (BuilderT SOACS DistribM))
-&gt; [VName]
-&gt; BuilderT SOACS DistribM ()
forall (m :: * -&gt; *).
(MonadBuilder m, Buildable (Rep m)) =&gt;
Pat (Rep m)
-&gt; SubExp -&gt; [SubExp] -&gt; LambdaT (Rep m) -&gt; [VName] -&gt; m ()
</span><a href="Futhark.Tools.html#sequentialStreamWholeArray"><span class="hs-identifier hs-var">sequentialStreamWholeArray</span></a></span><span> </span><span class="annot"><span class="annottext">Pat (Rep (BuilderT SOACS DistribM))
Pat SOACS
</span><a href="#local-6989586621684422764"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422761"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684422756"><span class="hs-identifier hs-var">nes</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT (Rep (BuilderT SOACS DistribM))
Lambda
</span><a href="#local-6989586621684422755"><span class="hs-identifier hs-var">fold_fun</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684422760"><span class="hs-identifier hs-var">arrs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Scope SOACS
</span><a href="#local-6989586621684422723"><span class="hs-identifier hs-var">types</span></a></span><span>
</span><span id="line-522"></span><span>
</span><span id="line-523"></span><span>    </span><span id="local-6989586621684422747"><span class="annot"><span class="annottext">innerParallelBody :: KernelPath -&gt; DistribM (Body GPU)
</span><a href="#local-6989586621684422747"><span class="hs-identifier hs-var hs-var">innerParallelBody</span></a></span></span><span> </span><span id="local-6989586621684422722"><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422722"><span class="hs-identifier hs-var">path'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-524"></span><span>      </span><span class="annot"><span class="annottext">Body GPU -&gt; DistribM (Body GPU)
forall rep (m :: * -&gt; *).
(Renameable rep, MonadFreshNames m) =&gt;
Body rep -&gt; m (Body rep)
</span><a href="Futhark.Transform.Rename.html#renameBody"><span class="hs-identifier hs-var">renameBody</span></a></span><span>
</span><span id="line-525"></span><span>        </span><span class="annot"><span class="annottext">(Body GPU -&gt; DistribM (Body GPU))
-&gt; DistribM (Body GPU) -&gt; DistribM (Body GPU)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms GPU -&gt; Result -&gt; Body GPU
forall rep. Buildable rep =&gt; Stms rep -&gt; Result -&gt; Body rep
</span><a href="Futhark.Builder.Class.html#mkBody"><span class="hs-identifier hs-var">mkBody</span></a></span><span> </span><span class="annot"><span class="annottext">(Stms GPU -&gt; Result -&gt; Body GPU)
-&gt; DistribM (Stms GPU) -&gt; DistribM (Result -&gt; Body GPU)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">KernelPath -&gt; DistribM (Stms GPU)
</span><a href="#local-6989586621684422725"><span class="hs-identifier hs-var">paralleliseInner</span></a></span><span> </span><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422722"><span class="hs-identifier hs-var">path'</span></a></span><span> </span><span class="annot"><span class="annottext">DistribM (Result -&gt; Body GPU)
-&gt; DistribM Result -&gt; DistribM (Body GPU)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Result -&gt; DistribM Result
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; Result
</span><a href="Futhark.IR.Syntax.html#varsRes"><span class="hs-identifier hs-var">varsRes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatT Type -&gt; [VName]
forall dec. PatT dec -&gt; [VName]
</span><a href="Futhark.IR.Prop.Patterns.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="annot"><span class="annottext">PatT Type
Pat SOACS
</span><a href="#local-6989586621684422764"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-526"></span><span>
</span><span id="line-527"></span><span>    </span><span id="local-6989586621684422730"><span class="annot"><span class="annottext">comm' :: Commutativity
</span><a href="#local-6989586621684422730"><span class="hs-identifier hs-var hs-var">comm'</span></a></span></span><span>
</span><span id="line-528"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Lambda -&gt; Bool
forall rep. Lambda rep -&gt; Bool
</span><a href="Futhark.IR.Prop.html#commutativeLambda"><span class="hs-identifier hs-var">commutativeLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422757"><span class="hs-identifier hs-var">red_fun</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StreamOrd
</span><a href="#local-6989586621684422759"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="annot"><span class="annottext">StreamOrd -&gt; StreamOrd -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">StreamOrd
</span><a href="Futhark.IR.SOACS.SOAC.html#InOrder"><span class="hs-identifier hs-var">InOrder</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Commutativity
</span><a href="Futhark.IR.Syntax.Core.html#Commutative"><span class="hs-identifier hs-var">Commutative</span></a></span><span>
</span><span id="line-529"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Commutativity
</span><a href="#local-6989586621684422758"><span class="hs-identifier hs-var">comm</span></a></span><span>
</span><span id="line-530"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#transformStm"><span class="hs-identifier hs-var">transformStm</span></a></span><span> </span><span id="local-6989586621684422719"><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422719"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684422718"><span class="annot"><span class="annottext">Pat SOACS
</span><a href="#local-6989586621684422718"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#StmAux"><span class="hs-identifier hs-type">StmAux</span></a></span><span> </span><span id="local-6989586621684422717"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684422717"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ExpDec SOACS
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Screma"><span class="hs-identifier hs-type">Screma</span></a></span><span> </span><span id="local-6989586621684422716"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422716"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684422715"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684422715"><span class="hs-identifier hs-var">arrs</span></a></span></span><span> </span><span id="local-6989586621684422714"><span class="annot"><span class="annottext">ScremaForm SOACS
</span><a href="#local-6989586621684422714"><span class="hs-identifier hs-var">form</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-531"></span><span>  </span><span class="hs-comment">-- This screma is too complicated for us to immediately do</span><span>
</span><span id="line-532"></span><span>  </span><span class="hs-comment">-- anything, so split it up and try again.</span><span>
</span><span id="line-533"></span><span>  </span><span id="local-6989586621684422713"><span class="annot"><span class="annottext">Scope SOACS
</span><a href="#local-6989586621684422713"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Scope GPU -&gt; Scope SOACS) -&gt; DistribM (Scope SOACS)
forall rep (m :: * -&gt; *) a.
HasScope rep m =&gt;
(Scope rep -&gt; a) -&gt; m a
</span><a href="Futhark.IR.Prop.Scope.html#asksScope"><span class="hs-identifier hs-var">asksScope</span></a></span><span> </span><span class="annot"><span class="annottext">Scope GPU -&gt; Scope SOACS
</span><a href="Futhark.Pass.ExtractKernels.ToGPU.html#scopeForSOACs"><span class="hs-identifier hs-var">scopeForSOACs</span></a></span><span>
</span><span id="line-534"></span><span>  </span><span class="annot"><span class="annottext">KernelPath -&gt; [Stm SOACS] -&gt; DistribM (Stms GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#transformStms"><span class="hs-identifier hs-var">transformStms</span></a></span><span> </span><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422719"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="annot"><span class="annottext">([Stm SOACS] -&gt; DistribM (Stms GPU))
-&gt; (((), Stms SOACS) -&gt; [Stm SOACS])
-&gt; ((), Stms SOACS)
-&gt; DistribM (Stms GPU)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Stm SOACS -&gt; Stm SOACS) -&gt; [Stm SOACS] -&gt; [Stm SOACS]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Certs -&gt; Stm SOACS -&gt; Stm SOACS
forall rep. Certs -&gt; Stm rep -&gt; Stm rep
</span><a href="Futhark.IR.Prop.html#certify"><span class="hs-identifier hs-var">certify</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684422717"><span class="hs-identifier hs-var">cs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Stm SOACS] -&gt; [Stm SOACS])
-&gt; (((), Stms SOACS) -&gt; [Stm SOACS])
-&gt; ((), Stms SOACS)
-&gt; [Stm SOACS]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Stms SOACS -&gt; [Stm SOACS]
forall rep. Stms rep -&gt; [Stm rep]
</span><a href="Futhark.IR.Syntax.html#stmsToList"><span class="hs-identifier hs-var">stmsToList</span></a></span><span> </span><span class="annot"><span class="annottext">(Stms SOACS -&gt; [Stm SOACS])
-&gt; (((), Stms SOACS) -&gt; Stms SOACS)
-&gt; ((), Stms SOACS)
-&gt; [Stm SOACS]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">((), Stms SOACS) -&gt; Stms SOACS
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span>
</span><span id="line-535"></span><span>    </span><span class="annot"><span class="annottext">(((), Stms SOACS) -&gt; DistribM (Stms GPU))
-&gt; DistribM ((), Stms SOACS) -&gt; DistribM (Stms GPU)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">BuilderT SOACS DistribM ()
-&gt; Scope SOACS -&gt; DistribM ((), Stms SOACS)
forall (m :: * -&gt; *) rep a.
MonadFreshNames m =&gt;
BuilderT rep m a -&gt; Scope rep -&gt; m (a, Stms rep)
</span><a href="Futhark.Builder.html#runBuilderT"><span class="hs-identifier hs-var">runBuilderT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pat (Rep (BuilderT SOACS DistribM))
-&gt; SubExp
-&gt; ScremaForm (Rep (BuilderT SOACS DistribM))
-&gt; [VName]
-&gt; BuilderT SOACS DistribM ()
forall (m :: * -&gt; *).
(MonadBuilder m, Op (Rep m) ~ SOAC (Rep m), Buildable (Rep m)) =&gt;
Pat (Rep m) -&gt; SubExp -&gt; ScremaForm (Rep m) -&gt; [VName] -&gt; m ()
</span><a href="Futhark.Tools.html#dissectScrema"><span class="hs-identifier hs-var">dissectScrema</span></a></span><span> </span><span class="annot"><span class="annottext">Pat (Rep (BuilderT SOACS DistribM))
Pat SOACS
</span><a href="#local-6989586621684422718"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422716"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">ScremaForm (Rep (BuilderT SOACS DistribM))
ScremaForm SOACS
</span><a href="#local-6989586621684422714"><span class="hs-identifier hs-var">form</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684422715"><span class="hs-identifier hs-var">arrs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Scope SOACS
</span><a href="#local-6989586621684422713"><span class="hs-identifier hs-var">scope</span></a></span><span>
</span><span id="line-536"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#transformStm"><span class="hs-identifier hs-var">transformStm</span></a></span><span> </span><span id="local-6989586621684422711"><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422711"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684422710"><span class="annot"><span class="annottext">Pat SOACS
</span><a href="#local-6989586621684422710"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec SOACS)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621684422709"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422709"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684422708"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684422708"><span class="hs-identifier hs-var">arrs</span></a></span></span><span> </span><span class="annot"><span class="annottext">StreamForm SOACS
</span><a href="Futhark.IR.SOACS.SOAC.html#Sequential"><span class="hs-identifier hs-var">Sequential</span></a></span><span> </span><span id="local-6989586621684422706"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684422706"><span class="hs-identifier hs-var">nes</span></a></span></span><span> </span><span id="local-6989586621684422705"><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422705"><span class="hs-identifier hs-var">fold_fun</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-537"></span><span>  </span><span class="hs-comment">-- Remove the stream and leave the body parallel.  It will be</span><span>
</span><span id="line-538"></span><span>  </span><span class="hs-comment">-- distributed.</span><span>
</span><span id="line-539"></span><span>  </span><span id="local-6989586621684422704"><span class="annot"><span class="annottext">Scope SOACS
</span><a href="#local-6989586621684422704"><span class="hs-identifier hs-var">types</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Scope GPU -&gt; Scope SOACS) -&gt; DistribM (Scope SOACS)
forall rep (m :: * -&gt; *) a.
HasScope rep m =&gt;
(Scope rep -&gt; a) -&gt; m a
</span><a href="Futhark.IR.Prop.Scope.html#asksScope"><span class="hs-identifier hs-var">asksScope</span></a></span><span> </span><span class="annot"><span class="annottext">Scope GPU -&gt; Scope SOACS
</span><a href="Futhark.Pass.ExtractKernels.ToGPU.html#scopeForSOACs"><span class="hs-identifier hs-var">scopeForSOACs</span></a></span><span>
</span><span id="line-540"></span><span>  </span><span class="annot"><span class="annottext">KernelPath -&gt; [Stm SOACS] -&gt; DistribM (Stms GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#transformStms"><span class="hs-identifier hs-var">transformStms</span></a></span><span> </span><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422711"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="annot"><span class="annottext">([Stm SOACS] -&gt; DistribM (Stms GPU))
-&gt; (((), Stms SOACS) -&gt; [Stm SOACS])
-&gt; ((), Stms SOACS)
-&gt; DistribM (Stms GPU)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Stms SOACS -&gt; [Stm SOACS]
forall rep. Stms rep -&gt; [Stm rep]
</span><a href="Futhark.IR.Syntax.html#stmsToList"><span class="hs-identifier hs-var">stmsToList</span></a></span><span> </span><span class="annot"><span class="annottext">(Stms SOACS -&gt; [Stm SOACS])
-&gt; (((), Stms SOACS) -&gt; Stms SOACS)
-&gt; ((), Stms SOACS)
-&gt; [Stm SOACS]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">((), Stms SOACS) -&gt; Stms SOACS
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span>
</span><span id="line-541"></span><span>    </span><span class="annot"><span class="annottext">(((), Stms SOACS) -&gt; DistribM (Stms GPU))
-&gt; DistribM ((), Stms SOACS) -&gt; DistribM (Stms GPU)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">BuilderT SOACS DistribM ()
-&gt; Scope SOACS -&gt; DistribM ((), Stms SOACS)
forall (m :: * -&gt; *) rep a.
MonadFreshNames m =&gt;
BuilderT rep m a -&gt; Scope rep -&gt; m (a, Stms rep)
</span><a href="Futhark.Builder.html#runBuilderT"><span class="hs-identifier hs-var">runBuilderT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pat (Rep (BuilderT SOACS DistribM))
-&gt; SubExp
-&gt; [SubExp]
-&gt; LambdaT (Rep (BuilderT SOACS DistribM))
-&gt; [VName]
-&gt; BuilderT SOACS DistribM ()
forall (m :: * -&gt; *).
(MonadBuilder m, Buildable (Rep m)) =&gt;
Pat (Rep m)
-&gt; SubExp -&gt; [SubExp] -&gt; LambdaT (Rep m) -&gt; [VName] -&gt; m ()
</span><a href="Futhark.Tools.html#sequentialStreamWholeArray"><span class="hs-identifier hs-var">sequentialStreamWholeArray</span></a></span><span> </span><span class="annot"><span class="annottext">Pat (Rep (BuilderT SOACS DistribM))
Pat SOACS
</span><a href="#local-6989586621684422710"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422709"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684422706"><span class="hs-identifier hs-var">nes</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT (Rep (BuilderT SOACS DistribM))
Lambda
</span><a href="#local-6989586621684422705"><span class="hs-identifier hs-var">fold_fun</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684422708"><span class="hs-identifier hs-var">arrs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Scope SOACS
</span><a href="#local-6989586621684422704"><span class="hs-identifier hs-var">types</span></a></span><span>
</span><span id="line-542"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#transformStm"><span class="hs-identifier hs-var">transformStm</span></a></span><span> </span><span class="annot"><span class="annottext">KernelPath
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684422703"><span class="annot"><span class="annottext">Pat SOACS
</span><a href="#local-6989586621684422703"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#StmAux"><span class="hs-identifier hs-type">StmAux</span></a></span><span> </span><span id="local-6989586621684422702"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684422702"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ExpDec SOACS
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Scatter"><span class="hs-identifier hs-type">Scatter</span></a></span><span> </span><span id="local-6989586621684422700"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422700"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684422699"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684422699"><span class="hs-identifier hs-var">ivs</span></a></span></span><span> </span><span id="local-6989586621684422698"><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422698"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span id="local-6989586621684422697"><span class="annot"><span class="annottext">[(ShapeBase SubExp, Int, VName)]
</span><a href="#local-6989586621684422697"><span class="hs-keyword hs-var">as</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Builder GPU () -&gt; DistribM (Stms GPU)
forall (m :: * -&gt; *) somerep rep a.
(MonadFreshNames m, HasScope somerep m, SameScope somerep rep) =&gt;
Builder rep a -&gt; m (Stms rep)
</span><a href="Futhark.Builder.html#runBuilder_"><span class="hs-identifier hs-var">runBuilder_</span></a></span><span> </span><span class="annot"><span class="annottext">(Builder GPU () -&gt; DistribM (Stms GPU))
-&gt; Builder GPU () -&gt; DistribM (Stms GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-543"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684422696"><span class="annot"><span class="annottext">lam' :: Lambda GPU
</span><a href="#local-6989586621684422696"><span class="hs-identifier hs-var hs-var">lam'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Lambda -&gt; Lambda GPU
</span><a href="Futhark.Pass.ExtractKernels.ToGPU.html#soacsLambdaToGPU"><span class="hs-identifier hs-var">soacsLambdaToGPU</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422698"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-544"></span><span>  </span><span id="local-6989586621684422695"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684422695"><span class="hs-identifier hs-var">write_i</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; BuilderT GPU (State VNameSource) VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; [Char] -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;write_i&quot;</span></span><span>
</span><span id="line-545"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684422694"><span class="annot"><span class="annottext">[ShapeBase SubExp]
</span><a href="#local-6989586621684422694"><span class="hs-identifier hs-var">as_ws</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Int]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(ShapeBase SubExp, Int, VName)]
-&gt; ([ShapeBase SubExp], [Int], [VName])
forall a b c. [(a, b, c)] -&gt; ([a], [b], [c])
</span><span class="hs-identifier hs-var">unzip3</span></span><span> </span><span class="annot"><span class="annottext">[(ShapeBase SubExp, Int, VName)]
</span><a href="#local-6989586621684422697"><span class="hs-keyword hs-var">as</span></a></span><span>
</span><span id="line-546"></span><span>      </span><span id="local-6989586621684422692"><span class="annot"><span class="annottext">kstms :: Stms GPU
</span><a href="#local-6989586621684422692"><span class="hs-identifier hs-var hs-var">kstms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Body GPU -&gt; Stms GPU
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">(Body GPU -&gt; Stms GPU) -&gt; Body GPU -&gt; Stms GPU
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda GPU -&gt; Body GPU
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPU
</span><a href="#local-6989586621684422696"><span class="hs-identifier hs-var">lam'</span></a></span><span>
</span><span id="line-547"></span><span>      </span><span id="local-6989586621684422691"><span class="annot"><span class="annottext">krets :: [KernelResult]
</span><a href="#local-6989586621684422691"><span class="hs-identifier hs-var hs-var">krets</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-548"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621684422690"><span class="annot"><span class="annottext">ShapeBase SubExp
</span><a href="#local-6989586621684422690"><span class="hs-identifier hs-var">a_w</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684422689"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684422689"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684422688"><span class="annot"><span class="annottext">[(Result, SubExpRes)]
</span><a href="#local-6989586621684422688"><span class="hs-identifier hs-var">is_vs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(ShapeBase SubExp, Int, VName)]
-&gt; Result -&gt; [(ShapeBase SubExp, VName, [(Result, SubExpRes)])]
forall array a.
[(ShapeBase SubExp, Int, array)]
-&gt; [a] -&gt; [(ShapeBase SubExp, array, [([a], a)])]
</span><a href="Futhark.IR.SOACS.SOAC.html#groupScatterResults"><span class="hs-identifier hs-var">groupScatterResults</span></a></span><span> </span><span class="annot"><span class="annottext">[(ShapeBase SubExp, Int, VName)]
</span><a href="#local-6989586621684422697"><span class="hs-keyword hs-var">as</span></a></span><span> </span><span class="annot"><span class="annottext">(Result -&gt; [(ShapeBase SubExp, VName, [(Result, SubExpRes)])])
-&gt; Result -&gt; [(ShapeBase SubExp, VName, [(Result, SubExpRes)])]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Body GPU -&gt; Result
forall rep. BodyT rep -&gt; Result
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var hs-var">bodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">(Body GPU -&gt; Result) -&gt; Body GPU -&gt; Result
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda GPU -&gt; Body GPU
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPU
</span><a href="#local-6989586621684422696"><span class="hs-identifier hs-var">lam'</span></a></span><span>
</span><span id="line-549"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684422686"><span class="annot"><span class="annottext">res_cs :: Certs
</span><a href="#local-6989586621684422686"><span class="hs-identifier hs-var hs-var">res_cs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-550"></span><span>              </span><span class="annot"><span class="annottext">((Result, SubExpRes) -&gt; Certs) -&gt; [(Result, SubExpRes)] -&gt; Certs
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SubExpRes -&gt; Certs) -&gt; Result -&gt; Certs
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">SubExpRes -&gt; Certs
</span><a href="Futhark.IR.Syntax.html#resCerts"><span class="hs-identifier hs-var hs-var">resCerts</span></a></span><span> </span><span class="annot"><span class="annottext">(Result -&gt; Certs)
-&gt; ((Result, SubExpRes) -&gt; Result) -&gt; (Result, SubExpRes) -&gt; Certs
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Result, SubExpRes) -&gt; Result
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Result, SubExpRes)]
</span><a href="#local-6989586621684422688"><span class="hs-identifier hs-var">is_vs</span></a></span><span>
</span><span id="line-551"></span><span>                </span><span class="annot"><span class="annottext">Certs -&gt; Certs -&gt; Certs
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">((Result, SubExpRes) -&gt; Certs) -&gt; [(Result, SubExpRes)] -&gt; Certs
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExpRes -&gt; Certs
</span><a href="Futhark.IR.Syntax.html#resCerts"><span class="hs-identifier hs-var hs-var">resCerts</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExpRes -&gt; Certs)
-&gt; ((Result, SubExpRes) -&gt; SubExpRes)
-&gt; (Result, SubExpRes)
-&gt; Certs
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Result, SubExpRes) -&gt; SubExpRes
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Result, SubExpRes)]
</span><a href="#local-6989586621684422688"><span class="hs-identifier hs-var">is_vs</span></a></span><span>
</span><span id="line-552"></span><span>            </span><span id="local-6989586621684422683"><span class="annot"><span class="annottext">is_vs' :: [(Slice SubExp, SubExp)]
</span><a href="#local-6989586621684422683"><span class="hs-identifier hs-var hs-var">is_vs'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DimIndex SubExp] -&gt; Slice SubExp
forall d. [DimIndex d] -&gt; Slice d
</span><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-var">Slice</span></a></span><span> </span><span class="annot"><span class="annottext">([DimIndex SubExp] -&gt; Slice SubExp)
-&gt; [DimIndex SubExp] -&gt; Slice SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExpRes -&gt; DimIndex SubExp) -&gt; Result -&gt; [DimIndex SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp -&gt; DimIndex SubExp
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; DimIndex SubExp)
-&gt; (SubExpRes -&gt; SubExp) -&gt; SubExpRes -&gt; DimIndex SubExp
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SubExpRes -&gt; SubExp
</span><a href="Futhark.IR.Syntax.html#resSubExp"><span class="hs-identifier hs-var hs-var">resSubExp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684422679"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SubExpRes -&gt; SubExp
</span><a href="Futhark.IR.Syntax.html#resSubExp"><span class="hs-identifier hs-var hs-var">resSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684422678"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684422679"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684422679"><span class="hs-identifier hs-var">is</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684422678"><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684422678"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Result, SubExpRes)]
</span><a href="#local-6989586621684422688"><span class="hs-identifier hs-var">is_vs</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-553"></span><span>        </span><span class="annot"><span class="annottext">KernelResult -&gt; [KernelResult]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(KernelResult -&gt; [KernelResult]) -&gt; KernelResult -&gt; [KernelResult]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Certs
-&gt; ShapeBase SubExp
-&gt; VName
-&gt; [(Slice SubExp, SubExp)]
-&gt; KernelResult
</span><a href="Futhark.IR.SegOp.html#WriteReturns"><span class="hs-identifier hs-var">WriteReturns</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684422686"><span class="hs-identifier hs-var">res_cs</span></a></span><span> </span><span class="annot"><span class="annottext">ShapeBase SubExp
</span><a href="#local-6989586621684422690"><span class="hs-identifier hs-var">a_w</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684422689"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">[(Slice SubExp, SubExp)]
</span><a href="#local-6989586621684422683"><span class="hs-identifier hs-var">is_vs'</span></a></span><span>
</span><span id="line-554"></span><span>      </span><span id="local-6989586621684422676"><span class="annot"><span class="annottext">body :: KernelBody GPU
</span><a href="#local-6989586621684422676"><span class="hs-identifier hs-var hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BodyDec GPU -&gt; Stms GPU -&gt; [KernelResult] -&gt; KernelBody GPU
forall rep.
BodyDec rep -&gt; Stms rep -&gt; [KernelResult] -&gt; KernelBody rep
</span><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-var">KernelBody</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684422692"><span class="hs-identifier hs-var">kstms</span></a></span><span> </span><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684422691"><span class="hs-identifier hs-var">krets</span></a></span><span>
</span><span id="line-555"></span><span>      </span><span id="local-6989586621684422674"><span class="annot"><span class="annottext">inputs :: [KernelInput]
</span><a href="#local-6989586621684422674"><span class="hs-identifier hs-var hs-var">inputs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-556"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621684422673"><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684422673"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684422672"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684422672"><span class="hs-identifier hs-var">p_a</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Param Type] -&gt; [VName] -&gt; [(Param Type, VName)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda GPU -&gt; [LParam GPU]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPU
</span><a href="#local-6989586621684422696"><span class="hs-identifier hs-var">lam'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684422699"><span class="hs-identifier hs-var">ivs</span></a></span><span>
</span><span id="line-557"></span><span>        </span><span class="annot"><span class="annottext">KernelInput -&gt; [KernelInput]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(KernelInput -&gt; [KernelInput]) -&gt; KernelInput -&gt; [KernelInput]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Type -&gt; VName -&gt; [SubExp] -&gt; KernelInput
</span><a href="Futhark.Pass.ExtractKernels.BlockedKernel.html#KernelInput"><span class="hs-identifier hs-var">KernelInput</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param Type -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684422673"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param Type -&gt; Type
forall dec. Typed dec =&gt; Param dec -&gt; Type
</span><a href="Futhark.IR.Prop.Patterns.html#paramType"><span class="hs-identifier hs-var">paramType</span></a></span><span> </span><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684422673"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684422672"><span class="hs-identifier hs-var">p_a</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684422695"><span class="hs-identifier hs-var">write_i</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-558"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684422669"><span class="annot"><span class="annottext">SegOp SegLevel GPU
</span><a href="#local-6989586621684422669"><span class="hs-identifier hs-var">kernel</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684422668"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684422668"><span class="hs-identifier hs-var">stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-559"></span><span>    </span><span class="annot"><span class="annottext">MkSegLevel GPU (BuilderT GPU (State VNameSource))
-&gt; [(VName, SubExp)]
-&gt; [KernelInput]
-&gt; [Type]
-&gt; KernelBody GPU
-&gt; BuilderT
     GPU (State VNameSource) (SegOp (SegOpLevel GPU) GPU, Stms GPU)
forall rep (m :: * -&gt; *).
(DistRep rep, HasScope rep m, MonadFreshNames m) =&gt;
MkSegLevel rep m
-&gt; [(VName, SubExp)]
-&gt; [KernelInput]
-&gt; [Type]
-&gt; KernelBody rep
-&gt; m (SegOp (SegOpLevel rep) rep, Stms rep)
</span><a href="Futhark.Pass.ExtractKernels.BlockedKernel.html#mapKernel"><span class="hs-identifier hs-var">mapKernel</span></a></span><span>
</span><span id="line-560"></span><span>      </span><span class="annot"><span class="annottext">MkSegLevel GPU (BuilderT GPU (State VNameSource))
forall (m :: * -&gt; *). MonadFreshNames m =&gt; MkSegLevel GPU m
</span><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#segThreadCapped"><span class="hs-identifier hs-var">segThreadCapped</span></a></span><span>
</span><span id="line-561"></span><span>      </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684422695"><span class="hs-identifier hs-var">write_i</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422700"><span class="hs-identifier hs-var">w</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-562"></span><span>      </span><span class="annot"><span class="annottext">[KernelInput]
</span><a href="#local-6989586621684422674"><span class="hs-identifier hs-var">inputs</span></a></span><span>
</span><span id="line-563"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ShapeBase SubExp -&gt; Type -&gt; Type)
-&gt; [ShapeBase SubExp] -&gt; [Type] -&gt; [Type]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Type -&gt; Type
forall u.
Int
-&gt; TypeBase (ShapeBase SubExp) u -&gt; TypeBase (ShapeBase SubExp) u
</span><a href="Futhark.IR.Prop.Types.html#stripArray"><span class="hs-identifier hs-var">stripArray</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Type -&gt; Type)
-&gt; (ShapeBase SubExp -&gt; Int) -&gt; ShapeBase SubExp -&gt; Type -&gt; Type
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ShapeBase SubExp -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ShapeBase SubExp]
</span><a href="#local-6989586621684422694"><span class="hs-identifier hs-var">as_ws</span></a></span><span> </span><span class="annot"><span class="annottext">([Type] -&gt; [Type]) -&gt; [Type] -&gt; [Type]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatT Type -&gt; [Type]
forall dec. Typed dec =&gt; PatT dec -&gt; [Type]
</span><a href="Futhark.IR.Prop.Patterns.html#patTypes"><span class="hs-identifier hs-var">patTypes</span></a></span><span> </span><span class="annot"><span class="annottext">PatT Type
Pat SOACS
</span><a href="#local-6989586621684422703"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-564"></span><span>      </span><span class="annot"><span class="annottext">KernelBody GPU
</span><a href="#local-6989586621684422676"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-565"></span><span>  </span><span class="annot"><span class="annottext">Certs -&gt; Builder GPU () -&gt; Builder GPU ()
forall (m :: * -&gt; *) a. MonadBuilder m =&gt; Certs -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#certifying"><span class="hs-identifier hs-var">certifying</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684422702"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">(Builder GPU () -&gt; Builder GPU ())
-&gt; Builder GPU () -&gt; Builder GPU ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-566"></span><span>    </span><span class="annot"><span class="annottext">Stms (Rep (BuilderT GPU (State VNameSource))) -&gt; Builder GPU ()
forall (m :: * -&gt; *). MonadBuilder m =&gt; Stms (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#addStms"><span class="hs-identifier hs-var">addStms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms (Rep (BuilderT GPU (State VNameSource)))
Stms GPU
</span><a href="#local-6989586621684422668"><span class="hs-identifier hs-var">stms</span></a></span><span>
</span><span id="line-567"></span><span>    </span><span class="annot"><span class="annottext">Pat (Rep (BuilderT GPU (State VNameSource)))
-&gt; Exp (Rep (BuilderT GPU (State VNameSource))) -&gt; Builder GPU ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">Pat (Rep (BuilderT GPU (State VNameSource)))
Pat SOACS
</span><a href="#local-6989586621684422703"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (BuilderT GPU (State VNameSource))) -&gt; Builder GPU ())
-&gt; Exp (Rep (BuilderT GPU (State VNameSource))) -&gt; Builder GPU ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Op GPU -&gt; ExpT GPU
forall rep. Op rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-var">Op</span></a></span><span> </span><span class="annot"><span class="annottext">(Op GPU -&gt; ExpT GPU) -&gt; Op GPU -&gt; ExpT GPU
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegOp SegLevel GPU -&gt; HostOp GPU (SOAC GPU)
forall rep op. SegOp SegLevel rep -&gt; HostOp rep op
</span><a href="Futhark.IR.GPU.Op.html#SegOp"><span class="hs-identifier hs-var">SegOp</span></a></span><span> </span><span class="annot"><span class="annottext">SegOp SegLevel GPU
</span><a href="#local-6989586621684422669"><span class="hs-identifier hs-var">kernel</span></a></span><span>
</span><span id="line-568"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#transformStm"><span class="hs-identifier hs-var">transformStm</span></a></span><span> </span><span class="annot"><span class="annottext">KernelPath
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684422663"><span class="annot"><span class="annottext">Pat SOACS
</span><a href="#local-6989586621684422663"><span class="hs-identifier hs-var">orig_pat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#StmAux"><span class="hs-identifier hs-type">StmAux</span></a></span><span> </span><span id="local-6989586621684422662"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684422662"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ExpDec SOACS
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Hist"><span class="hs-identifier hs-type">Hist</span></a></span><span> </span><span id="local-6989586621684422660"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422660"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684422659"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684422659"><span class="hs-identifier hs-var">imgs</span></a></span></span><span> </span><span id="local-6989586621684422658"><span class="annot"><span class="annottext">[HistOp SOACS]
</span><a href="#local-6989586621684422658"><span class="hs-identifier hs-var">ops</span></a></span></span><span> </span><span id="local-6989586621684422657"><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422657"><span class="hs-identifier hs-var">bucket_fun</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-569"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684422656"><span class="annot"><span class="annottext">bfun' :: Lambda GPU
</span><a href="#local-6989586621684422656"><span class="hs-identifier hs-var hs-var">bfun'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Lambda -&gt; Lambda GPU
</span><a href="Futhark.Pass.ExtractKernels.ToGPU.html#soacsLambdaToGPU"><span class="hs-identifier hs-var">soacsLambdaToGPU</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422657"><span class="hs-identifier hs-var">bucket_fun</span></a></span><span>
</span><span id="line-570"></span><span>
</span><span id="line-571"></span><span>  </span><span class="hs-comment">-- It is important not to launch unnecessarily many threads for</span><span>
</span><span id="line-572"></span><span>  </span><span class="hs-comment">-- histograms, because it may mean we unnecessarily need to reduce</span><span>
</span><span id="line-573"></span><span>  </span><span class="hs-comment">-- subhistograms as well.</span><span>
</span><span id="line-574"></span><span>  </span><span class="annot"><span class="annottext">Builder GPU () -&gt; DistribM (Stms GPU)
forall (m :: * -&gt; *) somerep rep a.
(MonadFreshNames m, HasScope somerep m, SameScope somerep rep) =&gt;
Builder rep a -&gt; m (Stms rep)
</span><a href="Futhark.Builder.html#runBuilder_"><span class="hs-identifier hs-var">runBuilder_</span></a></span><span> </span><span class="annot"><span class="annottext">(Builder GPU () -&gt; DistribM (Stms GPU))
-&gt; Builder GPU () -&gt; DistribM (Stms GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-575"></span><span>    </span><span id="local-6989586621684422655"><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684422655"><span class="hs-identifier hs-var">lvl</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MkSegLevel GPU (State VNameSource)
forall (m :: * -&gt; *). MonadFreshNames m =&gt; MkSegLevel GPU m
</span><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#segThreadCapped"><span class="hs-identifier hs-var">segThreadCapped</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422660"><span class="hs-identifier hs-var">w</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;seghist&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ThreadRecommendation
 -&gt; BuilderT GPU (State VNameSource) (SegOpLevel GPU))
-&gt; ThreadRecommendation
-&gt; BuilderT GPU (State VNameSource) (SegOpLevel GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegVirt -&gt; ThreadRecommendation
</span><a href="Futhark.Pass.ExtractKernels.BlockedKernel.html#NoRecommendation"><span class="hs-identifier hs-var">NoRecommendation</span></a></span><span> </span><span class="annot"><span class="annottext">SegVirt
</span><a href="Futhark.IR.SegOp.html#SegNoVirt"><span class="hs-identifier hs-var">SegNoVirt</span></a></span><span>
</span><span id="line-576"></span><span>    </span><span class="annot"><span class="annottext">Stms GPU -&gt; Builder GPU ()
forall (m :: * -&gt; *). MonadBuilder m =&gt; Stms (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#addStms"><span class="hs-identifier hs-var">addStms</span></a></span><span> </span><span class="annot"><span class="annottext">(Stms GPU -&gt; Builder GPU ())
-&gt; BuilderT GPU (State VNameSource) (Stms GPU) -&gt; Builder GPU ()
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">(Lambda
 -&gt; BuilderT
      GPU
      (State VNameSource)
      (Lambda (Rep (BuilderT GPU (State VNameSource)))))
-&gt; SegOpLevel (Rep (BuilderT GPU (State VNameSource)))
-&gt; PatT Type
-&gt; [(VName, SubExp)]
-&gt; [KernelInput]
-&gt; Certs
-&gt; SubExp
-&gt; [HistOp SOACS]
-&gt; Lambda (Rep (BuilderT GPU (State VNameSource)))
-&gt; [VName]
-&gt; BuilderT
     GPU
     (State VNameSource)
     (Stms (Rep (BuilderT GPU (State VNameSource))))
forall (m :: * -&gt; *).
(MonadBuilder m, DistRep (Rep m)) =&gt;
(Lambda -&gt; m (Lambda (Rep m)))
-&gt; SegOpLevel (Rep m)
-&gt; PatT Type
-&gt; [(VName, SubExp)]
-&gt; [KernelInput]
-&gt; Certs
-&gt; SubExp
-&gt; [HistOp SOACS]
-&gt; Lambda (Rep m)
-&gt; [VName]
-&gt; m (Stms (Rep m))
</span><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#histKernel"><span class="hs-identifier hs-var">histKernel</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda
-&gt; BuilderT
     GPU
     (State VNameSource)
     (Lambda (Rep (BuilderT GPU (State VNameSource))))
Lambda -&gt; BuilderT GPU (State VNameSource) (Lambda GPU)
</span><a href="#local-6989586621684422653"><span class="hs-identifier hs-var">onLambda</span></a></span><span> </span><span class="annot"><span class="annottext">SegOpLevel (Rep (BuilderT GPU (State VNameSource)))
SegLevel
</span><a href="#local-6989586621684422655"><span class="hs-identifier hs-var">lvl</span></a></span><span> </span><span class="annot"><span class="annottext">PatT Type
Pat SOACS
</span><a href="#local-6989586621684422663"><span class="hs-identifier hs-var">orig_pat</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684422662"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422660"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">[HistOp SOACS]
</span><a href="#local-6989586621684422658"><span class="hs-identifier hs-var">ops</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda (Rep (BuilderT GPU (State VNameSource)))
Lambda GPU
</span><a href="#local-6989586621684422656"><span class="hs-identifier hs-var">bfun'</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684422659"><span class="hs-identifier hs-var">imgs</span></a></span><span>
</span><span id="line-577"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-578"></span><span>    </span><span id="local-6989586621684422653"><span class="annot"><span class="annottext">onLambda :: Lambda -&gt; BuilderT GPU (State VNameSource) (Lambda GPU)
</span><a href="#local-6989586621684422653"><span class="hs-identifier hs-var hs-var">onLambda</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Lambda GPU -&gt; BuilderT GPU (State VNameSource) (Lambda GPU)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Lambda GPU -&gt; BuilderT GPU (State VNameSource) (Lambda GPU))
-&gt; (Lambda -&gt; Lambda GPU)
-&gt; Lambda
-&gt; BuilderT GPU (State VNameSource) (Lambda GPU)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Lambda -&gt; Lambda GPU
</span><a href="Futhark.Pass.ExtractKernels.ToGPU.html#soacsLambdaToGPU"><span class="hs-identifier hs-var">soacsLambdaToGPU</span></a></span><span>
</span><span id="line-579"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#transformStm"><span class="hs-identifier hs-var">transformStm</span></a></span><span> </span><span class="annot"><span class="annottext">KernelPath
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684422651"><span class="annot"><span class="annottext">Stm SOACS
</span><a href="#local-6989586621684422651"><span class="hs-identifier hs-var">stm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-580"></span><span>  </span><span class="annot"><span class="annottext">Builder GPU () -&gt; DistribM (Stms GPU)
forall (m :: * -&gt; *) somerep rep a.
(MonadFreshNames m, HasScope somerep m, SameScope somerep rep) =&gt;
Builder rep a -&gt; m (Stms rep)
</span><a href="Futhark.Builder.html#runBuilder_"><span class="hs-identifier hs-var">runBuilder_</span></a></span><span> </span><span class="annot"><span class="annottext">(Builder GPU () -&gt; DistribM (Stms GPU))
-&gt; Builder GPU () -&gt; DistribM (Stms GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stm SOACS -&gt; Builder GPU ()
forall (m :: * -&gt; *).
(Transformer m, LetDec (Rep m) ~ LetDec SOACS) =&gt;
Stm SOACS -&gt; m ()
</span><a href="Futhark.Transform.FirstOrderTransform.html#transformStmRecursively"><span class="hs-identifier hs-var">FOT.transformStmRecursively</span></a></span><span> </span><span class="annot"><span class="annottext">Stm SOACS
</span><a href="#local-6989586621684422651"><span class="hs-identifier hs-var">stm</span></a></span><span>
</span><span id="line-581"></span><span>
</span><span id="line-582"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#sufficientParallelism"><span class="hs-identifier hs-type">sufficientParallelism</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-583"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-584"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-585"></span><span>  </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#KernelPath"><span class="hs-identifier hs-type">KernelPath</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-586"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-587"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#DistribM"><span class="hs-identifier hs-type">DistribM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Out.Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">Out.GPU</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-588"></span><span id="sufficientParallelism"><span class="annot"><span class="annottext">sufficientParallelism :: [Char]
-&gt; [SubExp]
-&gt; KernelPath
-&gt; Maybe Int64
-&gt; DistribM ((SubExp, Name), Stms GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#sufficientParallelism"><span class="hs-identifier hs-var hs-var">sufficientParallelism</span></a></span></span><span> </span><span id="local-6989586621684422650"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684422650"><span class="hs-identifier hs-var">desc</span></a></span></span><span> </span><span id="local-6989586621684422649"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684422649"><span class="hs-identifier hs-var">ws</span></a></span></span><span> </span><span id="local-6989586621684422648"><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422648"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span id="local-6989586621684422647"><span class="annot"><span class="annottext">Maybe Int64
</span><a href="#local-6989586621684422647"><span class="hs-identifier hs-var">def</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-589"></span><span>  </span><span class="annot"><span class="annottext">[Char]
-&gt; SizeClass -&gt; [SubExp] -&gt; DistribM ((SubExp, Name), Stms GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#cmpSizeLe"><span class="hs-identifier hs-var">cmpSizeLe</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684422650"><span class="hs-identifier hs-var">desc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelPath -&gt; Maybe Int64 -&gt; SizeClass
</span><a href="Futhark.IR.GPU.Sizes.html#SizeThreshold"><span class="hs-identifier hs-var">Out.SizeThreshold</span></a></span><span> </span><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422648"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Int64
</span><a href="#local-6989586621684422647"><span class="hs-identifier hs-var">def</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684422649"><span class="hs-identifier hs-var">ws</span></a></span><span>
</span><span id="line-590"></span><span>
</span><span id="line-591"></span><span class="hs-comment">-- | Intra-group parallelism is worthwhile if the lambda contains more</span><span>
</span><span id="line-592"></span><span class="hs-comment">-- than one instance of non-map nested parallelism, or any nested</span><span>
</span><span id="line-593"></span><span class="hs-comment">-- parallelism inside a loop.</span><span>
</span><span id="line-594"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#worthIntraGroup"><span class="hs-identifier hs-type">worthIntraGroup</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-595"></span><span id="worthIntraGroup"><span class="annot"><span class="annottext">worthIntraGroup :: Lambda -&gt; Bool
</span><a href="Futhark.Pass.ExtractKernels.html#worthIntraGroup"><span class="hs-identifier hs-var hs-var">worthIntraGroup</span></a></span></span><span> </span><span id="local-6989586621684422644"><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422644"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BodyT SOACS -&gt; Int
forall {rep}. (Op rep ~ SOAC rep) =&gt; BodyT rep -&gt; Int
</span><a href="#local-6989586621684422643"><span class="hs-identifier hs-var">bodyInterest</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda -&gt; BodyT SOACS
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422644"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-596"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-597"></span><span>    </span><span id="local-6989586621684422643"><span class="annot"><span class="annottext">bodyInterest :: BodyT rep -&gt; Int
</span><a href="#local-6989586621684422643"><span class="hs-identifier hs-var hs-var">bodyInterest</span></a></span></span><span> </span><span id="local-6989586621684422623"><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684422623"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-598"></span><span>      </span><span class="annot"><span class="annottext">Seq Int -&gt; Int
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">sum</span></span><span> </span><span class="annot"><span class="annottext">(Seq Int -&gt; Int) -&gt; Seq Int -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; Int
</span><a href="#local-6989586621684422621"><span class="hs-identifier hs-var">interest</span></a></span><span> </span><span class="annot"><span class="annottext">(Stm rep -&gt; Int) -&gt; Seq (Stm rep) -&gt; Seq Int
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">BodyT rep -&gt; Seq (Stm rep)
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684422623"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-599"></span><span>    </span><span id="local-6989586621684422621"><span class="annot"><span class="annottext">interest :: Stm rep -&gt; Int
</span><a href="#local-6989586621684422621"><span class="hs-identifier hs-var hs-var">interest</span></a></span></span><span> </span><span id="local-6989586621684422620"><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684422620"><span class="hs-identifier hs-var">stm</span></a></span></span><span>
</span><span id="line-600"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Attr
</span><span class="hs-string">&quot;sequential&quot;</span></span><span> </span><span class="annot"><span class="annottext">Attr -&gt; Attrs -&gt; Bool
</span><a href="Futhark.IR.Syntax.Core.html#inAttrs"><span class="hs-operator hs-var">`inAttrs`</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684422619"><span class="hs-identifier hs-var">attrs</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-601"></span><span>        </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-602"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Screma"><span class="hs-identifier hs-type">Screma</span></a></span><span> </span><span id="local-6989586621684422618"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422618"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684422617"><span class="annot"><span class="annottext">ScremaForm rep
</span><a href="#local-6989586621684422617"><span class="hs-identifier hs-var">form</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; ExpT rep
forall rep. Stm rep -&gt; Exp rep
</span><a href="Futhark.IR.Syntax.html#stmExp"><span class="hs-identifier hs-var hs-var">stmExp</span></a></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684422620"><span class="hs-identifier hs-var">stm</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-603"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684422616"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684422616"><span class="hs-identifier hs-var">lam'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ScremaForm rep -&gt; Maybe (Lambda rep)
forall rep. ScremaForm rep -&gt; Maybe (Lambda rep)
</span><a href="Futhark.IR.SOACS.SOAC.html#isMapSOAC"><span class="hs-identifier hs-var">isMapSOAC</span></a></span><span> </span><span class="annot"><span class="annottext">ScremaForm rep
</span><a href="#local-6989586621684422617"><span class="hs-identifier hs-var">form</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-604"></span><span>        </span><span class="annot"><span class="annottext">SubExp -&gt; Lambda rep -&gt; Int
</span><a href="#local-6989586621684422615"><span class="hs-identifier hs-var">mapLike</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422618"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684422616"><span class="hs-identifier hs-var">lam'</span></a></span><span>
</span><span id="line-605"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Scatter"><span class="hs-identifier hs-type">Scatter</span></a></span><span> </span><span id="local-6989586621684422614"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422614"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684422613"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684422613"><span class="hs-identifier hs-var">lam'</span></a></span></span><span> </span><span class="annot"><span class="annottext">[(ShapeBase SubExp, Int, VName)]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; ExpT rep
forall rep. Stm rep -&gt; Exp rep
</span><a href="Futhark.IR.Syntax.html#stmExp"><span class="hs-identifier hs-var hs-var">stmExp</span></a></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684422620"><span class="hs-identifier hs-var">stm</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-606"></span><span>        </span><span class="annot"><span class="annottext">SubExp -&gt; Lambda rep -&gt; Int
</span><a href="#local-6989586621684422615"><span class="hs-identifier hs-var">mapLike</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422614"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684422613"><span class="hs-identifier hs-var">lam'</span></a></span><span>
</span><span id="line-607"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#DoLoop"><span class="hs-identifier hs-type">DoLoop</span></a></span><span> </span><span class="annot"><span class="annottext">[(FParam rep, SubExp)]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">LoopForm rep
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684422612"><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684422612"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; ExpT rep
forall rep. Stm rep -&gt; Exp rep
</span><a href="Futhark.IR.Syntax.html#stmExp"><span class="hs-identifier hs-var hs-var">stmExp</span></a></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684422620"><span class="hs-identifier hs-var">stm</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-608"></span><span>        </span><span class="annot"><span class="annottext">BodyT rep -&gt; Int
</span><a href="#local-6989586621684422643"><span class="hs-identifier hs-var">bodyInterest</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684422612"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">10</span></span><span>
</span><span id="line-609"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#If"><span class="hs-identifier hs-type">If</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684422610"><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684422610"><span class="hs-identifier hs-var">tbody</span></a></span></span><span> </span><span id="local-6989586621684422609"><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684422609"><span class="hs-identifier hs-var">fbody</span></a></span></span><span> </span><span class="annot"><span class="annottext">IfDec (BranchType rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; ExpT rep
forall rep. Stm rep -&gt; Exp rep
</span><a href="Futhark.IR.Syntax.html#stmExp"><span class="hs-identifier hs-var hs-var">stmExp</span></a></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684422620"><span class="hs-identifier hs-var">stm</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-610"></span><span>        </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">max</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BodyT rep -&gt; Int
</span><a href="#local-6989586621684422643"><span class="hs-identifier hs-var">bodyInterest</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684422610"><span class="hs-identifier hs-var">tbody</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BodyT rep -&gt; Int
</span><a href="#local-6989586621684422643"><span class="hs-identifier hs-var">bodyInterest</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684422609"><span class="hs-identifier hs-var">fbody</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-611"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Screma"><span class="hs-identifier hs-type">Screma</span></a></span><span> </span><span id="local-6989586621684422607"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422607"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#ScremaForm"><span class="hs-identifier hs-type">ScremaForm</span></a></span><span> </span><span class="annot"><span class="annottext">[Scan rep]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[Reduce rep]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684422605"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684422605"><span class="hs-identifier hs-var">lam'</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; ExpT rep
forall rep. Stm rep -&gt; Exp rep
</span><a href="Futhark.IR.Syntax.html#stmExp"><span class="hs-identifier hs-var hs-var">stmExp</span></a></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684422620"><span class="hs-identifier hs-var">stm</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-612"></span><span>        </span><span class="annot"><span class="annottext">SubExp -&gt; Int
forall {p}. Num p =&gt; SubExp -&gt; p
</span><a href="#local-6989586621684422604"><span class="hs-identifier hs-var">zeroIfTooSmall</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422607"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">BodyT rep -&gt; Int
</span><a href="#local-6989586621684422643"><span class="hs-identifier hs-var">bodyInterest</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda rep -&gt; BodyT rep
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684422605"><span class="hs-identifier hs-var">lam'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-613"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StreamForm rep
</span><a href="Futhark.IR.SOACS.SOAC.html#Sequential"><span class="hs-identifier hs-var">Sequential</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684422603"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684422603"><span class="hs-identifier hs-var">lam'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; ExpT rep
forall rep. Stm rep -&gt; Exp rep
</span><a href="Futhark.IR.Syntax.html#stmExp"><span class="hs-identifier hs-var hs-var">stmExp</span></a></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684422620"><span class="hs-identifier hs-var">stm</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-614"></span><span>        </span><span class="annot"><span class="annottext">BodyT rep -&gt; Int
</span><a href="#local-6989586621684422643"><span class="hs-identifier hs-var">bodyInterest</span></a></span><span> </span><span class="annot"><span class="annottext">(BodyT rep -&gt; Int) -&gt; BodyT rep -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; BodyT rep
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684422603"><span class="hs-identifier hs-var">lam'</span></a></span><span>
</span><span id="line-615"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-616"></span><span>        </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-617"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-618"></span><span>        </span><span id="local-6989586621684422619"><span class="annot"><span class="annottext">attrs :: Attrs
</span><a href="#local-6989586621684422619"><span class="hs-identifier hs-var hs-var">attrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep) -&gt; Attrs
forall dec. StmAux dec -&gt; Attrs
</span><a href="Futhark.IR.Syntax.html#stmAuxAttrs"><span class="hs-identifier hs-var hs-var">stmAuxAttrs</span></a></span><span> </span><span class="annot"><span class="annottext">(StmAux (ExpDec rep) -&gt; Attrs) -&gt; StmAux (ExpDec rep) -&gt; Attrs
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; StmAux (ExpDec rep)
forall rep. Stm rep -&gt; StmAux (ExpDec rep)
</span><a href="Futhark.IR.Syntax.html#stmAux"><span class="hs-identifier hs-var hs-var">stmAux</span></a></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684422620"><span class="hs-identifier hs-var">stm</span></a></span><span>
</span><span id="line-619"></span><span>        </span><span id="local-6989586621684422602"><span class="annot"><span class="annottext">sequential_inner :: Bool
</span><a href="#local-6989586621684422602"><span class="hs-identifier hs-var hs-var">sequential_inner</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Attr
</span><span class="hs-string">&quot;sequential_inner&quot;</span></span><span> </span><span class="annot"><span class="annottext">Attr -&gt; Attrs -&gt; Bool
</span><a href="Futhark.IR.Syntax.Core.html#inAttrs"><span class="hs-operator hs-var">`inAttrs`</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684422619"><span class="hs-identifier hs-var">attrs</span></a></span><span>
</span><span id="line-620"></span><span>
</span><span id="line-621"></span><span>        </span><span id="local-6989586621684422604"><span class="annot"><span class="annottext">zeroIfTooSmall :: SubExp -&gt; p
</span><a href="#local-6989586621684422604"><span class="hs-identifier hs-var hs-var">zeroIfTooSmall</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Primitive.html#IntValue"><span class="hs-identifier hs-type">IntValue</span></a></span><span> </span><span id="local-6989586621684422594"><span class="annot"><span class="annottext">IntValue
</span><a href="#local-6989586621684422594"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-622"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">IntValue -&gt; Int64
</span><a href="Futhark.IR.Primitive.html#intToInt64"><span class="hs-identifier hs-var">intToInt64</span></a></span><span> </span><span class="annot"><span class="annottext">IntValue
</span><a href="#local-6989586621684422594"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">Int64 -&gt; Int64 -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Int64
</span><span class="hs-number">32</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-number">0</span></span><span>
</span><span id="line-623"></span><span>        </span><span class="annot"><a href="#local-6989586621684422604"><span class="hs-identifier hs-var">zeroIfTooSmall</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-number">1</span></span><span>
</span><span id="line-624"></span><span>
</span><span id="line-625"></span><span>        </span><span id="local-6989586621684422615"><span class="annot"><span class="annottext">mapLike :: SubExp -&gt; Lambda rep -&gt; Int
</span><a href="#local-6989586621684422615"><span class="hs-identifier hs-var hs-var">mapLike</span></a></span></span><span> </span><span id="local-6989586621684422591"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422591"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684422590"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684422590"><span class="hs-identifier hs-var">lam'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-626"></span><span>          </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684422602"><span class="hs-identifier hs-var">sequential_inner</span></a></span><span>
</span><span id="line-627"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-628"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">max</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp -&gt; Int
forall {p}. Num p =&gt; SubExp -&gt; p
</span><a href="#local-6989586621684422604"><span class="hs-identifier hs-var">zeroIfTooSmall</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422591"><span class="hs-identifier hs-var">w</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BodyT rep -&gt; Int
</span><a href="#local-6989586621684422643"><span class="hs-identifier hs-var">bodyInterest</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda rep -&gt; BodyT rep
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684422590"><span class="hs-identifier hs-var">lam'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-629"></span><span>
</span><span id="line-630"></span><span class="hs-comment">-- | A lambda is worth sequentialising if it contains enough nested</span><span>
</span><span id="line-631"></span><span class="hs-comment">-- parallelism of an interesting kind.</span><span>
</span><span id="line-632"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#worthSequentialising"><span class="hs-identifier hs-type">worthSequentialising</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-633"></span><span id="worthSequentialising"><span class="annot"><span class="annottext">worthSequentialising :: Lambda -&gt; Bool
</span><a href="Futhark.Pass.ExtractKernels.html#worthSequentialising"><span class="hs-identifier hs-var hs-var">worthSequentialising</span></a></span></span><span> </span><span id="local-6989586621684422588"><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422588"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BodyT SOACS -&gt; Int
forall {rep}. (Op rep ~ SOAC rep) =&gt; BodyT rep -&gt; Int
</span><a href="#local-6989586621684422587"><span class="hs-identifier hs-var">bodyInterest</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda -&gt; BodyT SOACS
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422588"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-634"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-635"></span><span>    </span><span id="local-6989586621684422587"><span class="annot"><span class="annottext">bodyInterest :: BodyT rep -&gt; Int
</span><a href="#local-6989586621684422587"><span class="hs-identifier hs-var hs-var">bodyInterest</span></a></span></span><span> </span><span id="local-6989586621684422567"><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684422567"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-636"></span><span>      </span><span class="annot"><span class="annottext">Seq Int -&gt; Int
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">sum</span></span><span> </span><span class="annot"><span class="annottext">(Seq Int -&gt; Int) -&gt; Seq Int -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; Int
</span><a href="#local-6989586621684422566"><span class="hs-identifier hs-var">interest</span></a></span><span> </span><span class="annot"><span class="annottext">(Stm rep -&gt; Int) -&gt; Seq (Stm rep) -&gt; Seq Int
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">BodyT rep -&gt; Seq (Stm rep)
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684422567"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-637"></span><span>    </span><span id="local-6989586621684422566"><span class="annot"><span class="annottext">interest :: Stm rep -&gt; Int
</span><a href="#local-6989586621684422566"><span class="hs-identifier hs-var hs-var">interest</span></a></span></span><span> </span><span id="local-6989586621684422565"><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684422565"><span class="hs-identifier hs-var">stm</span></a></span></span><span>
</span><span id="line-638"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Attr
</span><span class="hs-string">&quot;sequential&quot;</span></span><span> </span><span class="annot"><span class="annottext">Attr -&gt; Attrs -&gt; Bool
</span><a href="Futhark.IR.Syntax.Core.html#inAttrs"><span class="hs-operator hs-var">`inAttrs`</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684422564"><span class="hs-identifier hs-var">attrs</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-639"></span><span>        </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-640"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Screma"><span class="hs-identifier hs-type">Screma</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684422563"><span class="annot"><span class="annottext">form :: ScremaForm rep
</span><a href="#local-6989586621684422563"><span class="hs-identifier hs-var">form</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#ScremaForm"><span class="hs-identifier hs-type">ScremaForm</span></a></span><span> </span><span class="annot"><span class="annottext">[Scan rep]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[Reduce rep]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684422562"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684422562"><span class="hs-identifier hs-var">lam'</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; ExpT rep
forall rep. Stm rep -&gt; Exp rep
</span><a href="Futhark.IR.Syntax.html#stmExp"><span class="hs-identifier hs-var hs-var">stmExp</span></a></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684422565"><span class="hs-identifier hs-var">stm</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-641"></span><span>        </span><span class="annot"><span class="annottext">Maybe (Lambda rep) -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (Lambda rep) -&gt; Bool) -&gt; Maybe (Lambda rep) -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ScremaForm rep -&gt; Maybe (Lambda rep)
forall rep. ScremaForm rep -&gt; Maybe (Lambda rep)
</span><a href="Futhark.IR.SOACS.SOAC.html#isMapSOAC"><span class="hs-identifier hs-var">isMapSOAC</span></a></span><span> </span><span class="annot"><span class="annottext">ScremaForm rep
</span><a href="#local-6989586621684422563"><span class="hs-identifier hs-var">form</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-642"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684422560"><span class="hs-identifier hs-var">sequential_inner</span></a></span><span>
</span><span id="line-643"></span><span>          </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-644"></span><span>          </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">BodyT rep -&gt; Int
</span><a href="#local-6989586621684422587"><span class="hs-identifier hs-var">bodyInterest</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda rep -&gt; BodyT rep
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684422562"><span class="hs-identifier hs-var">lam'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-645"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Scatter"><span class="hs-identifier hs-type">Scatter</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; ExpT rep
forall rep. Stm rep -&gt; Exp rep
</span><a href="Futhark.IR.Syntax.html#stmExp"><span class="hs-identifier hs-var hs-var">stmExp</span></a></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684422565"><span class="hs-identifier hs-var">stm</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-646"></span><span>        </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-comment">-- Basically a map.</span><span>
</span><span id="line-647"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#DoLoop"><span class="hs-identifier hs-type">DoLoop</span></a></span><span> </span><span class="annot"><span class="annottext">[(FParam rep, SubExp)]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#ForLoop"><span class="hs-identifier hs-type">ForLoop</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span id="local-6989586621684422559"><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684422559"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; ExpT rep
forall rep. Stm rep -&gt; Exp rep
</span><a href="Futhark.IR.Syntax.html#stmExp"><span class="hs-identifier hs-var hs-var">stmExp</span></a></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684422565"><span class="hs-identifier hs-var">stm</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-648"></span><span>        </span><span class="annot"><span class="annottext">BodyT rep -&gt; Int
</span><a href="#local-6989586621684422587"><span class="hs-identifier hs-var">bodyInterest</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684422559"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">10</span></span><span>
</span><span id="line-649"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#WithAcc"><span class="hs-identifier hs-type">WithAcc</span></a></span><span> </span><span class="annot"><span class="annottext">[WithAccInput rep]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684422558"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684422558"><span class="hs-identifier hs-var">withacc_lam</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; ExpT rep
forall rep. Stm rep -&gt; Exp rep
</span><a href="Futhark.IR.Syntax.html#stmExp"><span class="hs-identifier hs-var hs-var">stmExp</span></a></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684422565"><span class="hs-identifier hs-var">stm</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-650"></span><span>        </span><span class="annot"><span class="annottext">BodyT rep -&gt; Int
</span><a href="#local-6989586621684422587"><span class="hs-identifier hs-var">bodyInterest</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda rep -&gt; BodyT rep
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684422558"><span class="hs-identifier hs-var">withacc_lam</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-651"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Screma"><span class="hs-identifier hs-type">Screma</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684422557"><span class="annot"><span class="annottext">form :: ScremaForm rep
</span><a href="#local-6989586621684422557"><span class="hs-identifier hs-var">form</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#ScremaForm"><span class="hs-identifier hs-type">ScremaForm</span></a></span><span> </span><span class="annot"><span class="annottext">[Scan rep]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[Reduce rep]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684422556"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684422556"><span class="hs-identifier hs-var">lam'</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; ExpT rep
forall rep. Stm rep -&gt; Exp rep
</span><a href="Futhark.IR.Syntax.html#stmExp"><span class="hs-identifier hs-var hs-var">stmExp</span></a></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684422565"><span class="hs-identifier hs-var">stm</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-652"></span><span>        </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">BodyT rep -&gt; Int
</span><a href="#local-6989586621684422587"><span class="hs-identifier hs-var">bodyInterest</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda rep -&gt; BodyT rep
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684422556"><span class="hs-identifier hs-var">lam'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-653"></span><span>          </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span>
</span><span id="line-654"></span><span>          </span><span class="hs-comment">-- Give this a bigger score if it's a redomap, as these</span><span>
</span><span id="line-655"></span><span>          </span><span class="hs-comment">-- are often tileable and thus benefit more from</span><span>
</span><span id="line-656"></span><span>          </span><span class="hs-comment">-- sequentialisation.</span><span>
</span><span id="line-657"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ScremaForm rep -&gt; Maybe ([Reduce rep], Lambda rep)
forall rep. ScremaForm rep -&gt; Maybe ([Reduce rep], Lambda rep)
</span><a href="Futhark.IR.SOACS.SOAC.html#isRedomapSOAC"><span class="hs-identifier hs-var">isRedomapSOAC</span></a></span><span> </span><span class="annot"><span class="annottext">ScremaForm rep
</span><a href="#local-6989586621684422557"><span class="hs-identifier hs-var">form</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-658"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">([Reduce rep], Lambda rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-659"></span><span>            </span><span class="annot"><span class="annottext">Maybe ([Reduce rep], Lambda rep)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-660"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-661"></span><span>        </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-662"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-663"></span><span>        </span><span id="local-6989586621684422564"><span class="annot"><span class="annottext">attrs :: Attrs
</span><a href="#local-6989586621684422564"><span class="hs-identifier hs-var hs-var">attrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep) -&gt; Attrs
forall dec. StmAux dec -&gt; Attrs
</span><a href="Futhark.IR.Syntax.html#stmAuxAttrs"><span class="hs-identifier hs-var hs-var">stmAuxAttrs</span></a></span><span> </span><span class="annot"><span class="annottext">(StmAux (ExpDec rep) -&gt; Attrs) -&gt; StmAux (ExpDec rep) -&gt; Attrs
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; StmAux (ExpDec rep)
forall rep. Stm rep -&gt; StmAux (ExpDec rep)
</span><a href="Futhark.IR.Syntax.html#stmAux"><span class="hs-identifier hs-var hs-var">stmAux</span></a></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684422565"><span class="hs-identifier hs-var">stm</span></a></span><span>
</span><span id="line-664"></span><span>        </span><span id="local-6989586621684422560"><span class="annot"><span class="annottext">sequential_inner :: Bool
</span><a href="#local-6989586621684422560"><span class="hs-identifier hs-var hs-var">sequential_inner</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Attr
</span><span class="hs-string">&quot;sequential_inner&quot;</span></span><span> </span><span class="annot"><span class="annottext">Attr -&gt; Attrs -&gt; Bool
</span><a href="Futhark.IR.Syntax.Core.html#inAttrs"><span class="hs-operator hs-var">`inAttrs`</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684422564"><span class="hs-identifier hs-var">attrs</span></a></span><span>
</span><span id="line-665"></span><span>
</span><span id="line-666"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#onTopLevelStms"><span class="hs-identifier hs-type">onTopLevelStms</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-667"></span><span>  </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#KernelPath"><span class="hs-identifier hs-type">KernelPath</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-668"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-669"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#DistNestT"><span class="hs-identifier hs-type">DistNestT</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">Out.GPU</span></a></span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#DistribM"><span class="hs-identifier hs-type">DistribM</span></a></span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#GPUStms"><span class="hs-identifier hs-type">GPUStms</span></a></span><span>
</span><span id="line-670"></span><span id="onTopLevelStms"><span class="annot"><span class="annottext">onTopLevelStms :: KernelPath -&gt; Stms SOACS -&gt; DistNestT GPU DistribM (Stms GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#onTopLevelStms"><span class="hs-identifier hs-var hs-var">onTopLevelStms</span></a></span></span><span> </span><span id="local-6989586621684422554"><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422554"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span id="local-6989586621684422553"><span class="annot"><span class="annottext">Stms SOACS
</span><a href="#local-6989586621684422553"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-671"></span><span>  </span><span class="annot"><span class="annottext">DistribM (Stms GPU) -&gt; DistNestT GPU DistribM (Stms GPU)
forall rep (m :: * -&gt; *) a.
(LocalScope rep m, DistRep rep) =&gt;
m a -&gt; DistNestT rep m a
</span><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#liftInner"><span class="hs-identifier hs-var">liftInner</span></a></span><span> </span><span class="annot"><span class="annottext">(DistribM (Stms GPU) -&gt; DistNestT GPU DistribM (Stms GPU))
-&gt; DistribM (Stms GPU) -&gt; DistNestT GPU DistribM (Stms GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KernelPath -&gt; [Stm SOACS] -&gt; DistribM (Stms GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#transformStms"><span class="hs-identifier hs-var">transformStms</span></a></span><span> </span><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422554"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="annot"><span class="annottext">([Stm SOACS] -&gt; DistribM (Stms GPU))
-&gt; [Stm SOACS] -&gt; DistribM (Stms GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stms SOACS -&gt; [Stm SOACS]
forall rep. Stms rep -&gt; [Stm rep]
</span><a href="Futhark.IR.Syntax.html#stmsToList"><span class="hs-identifier hs-var">stmsToList</span></a></span><span> </span><span class="annot"><span class="annottext">Stms SOACS
</span><a href="#local-6989586621684422553"><span class="hs-identifier hs-var">stms</span></a></span><span>
</span><span id="line-672"></span><span>
</span><span id="line-673"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#onMap"><span class="hs-identifier hs-type">onMap</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#KernelPath"><span class="hs-identifier hs-type">KernelPath</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#MapLoop"><span class="hs-identifier hs-type">MapLoop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#DistribM"><span class="hs-identifier hs-type">DistribM</span></a></span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#GPUStms"><span class="hs-identifier hs-type">GPUStms</span></a></span><span>
</span><span id="line-674"></span><span id="onMap"><span class="annot"><span class="annottext">onMap :: KernelPath -&gt; MapLoop -&gt; DistribM (Stms GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#onMap"><span class="hs-identifier hs-var hs-var">onMap</span></a></span></span><span> </span><span id="local-6989586621684422551"><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422551"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#MapLoop"><span class="hs-identifier hs-type">MapLoop</span></a></span><span> </span><span id="local-6989586621684422550"><span class="annot"><span class="annottext">Pat SOACS
</span><a href="#local-6989586621684422550"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684422549"><span class="annot"><span class="annottext">StmAux ()
</span><a href="#local-6989586621684422549"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span id="local-6989586621684422548"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422548"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684422547"><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422547"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span id="local-6989586621684422546"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684422546"><span class="hs-identifier hs-var">arrs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-675"></span><span>  </span><span id="local-6989586621684422545"><span class="annot"><span class="annottext">Scope GPU
</span><a href="#local-6989586621684422545"><span class="hs-identifier hs-var">types</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DistribM (Scope GPU)
forall rep (m :: * -&gt; *). HasScope rep m =&gt; m (Scope rep)
</span><a href="Futhark.IR.Prop.Scope.html#askScope"><span class="hs-identifier hs-var">askScope</span></a></span><span>
</span><span id="line-676"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684422543"><span class="annot"><span class="annottext">loopnest :: LoopNesting
</span><a href="#local-6989586621684422543"><span class="hs-identifier hs-var hs-var">loopnest</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatT Type
-&gt; StmAux () -&gt; SubExp -&gt; [(Param Type, VName)] -&gt; LoopNesting
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#MapNesting"><span class="hs-identifier hs-var">MapNesting</span></a></span><span> </span><span class="annot"><span class="annottext">PatT Type
Pat SOACS
</span><a href="#local-6989586621684422550"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux ()
</span><a href="#local-6989586621684422549"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422548"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">([(Param Type, VName)] -&gt; LoopNesting)
-&gt; [(Param Type, VName)] -&gt; LoopNesting
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Param Type] -&gt; [VName] -&gt; [(Param Type, VName)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda -&gt; [LParam SOACS]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422547"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684422546"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-677"></span><span>      </span><span id="local-6989586621684422541"><span class="annot"><span class="annottext">env :: KernelPath -&gt; DistEnv GPU DistribM
</span><a href="#local-6989586621684422541"><span class="hs-identifier hs-var hs-var">env</span></a></span></span><span> </span><span id="local-6989586621684422540"><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422540"><span class="hs-identifier hs-var">path'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-678"></span><span>        </span><span class="annot"><span class="annottext">DistEnv :: forall rep (m :: * -&gt; *).
Nestings
-&gt; Scope rep
-&gt; (Stms SOACS -&gt; DistNestT rep m (Stms rep))
-&gt; (MapLoop -&gt; DistAcc rep -&gt; DistNestT rep m (DistAcc rep))
-&gt; (Stm SOACS -&gt; Builder rep (Stms rep))
-&gt; (Lambda -&gt; Builder rep (Lambda rep))
-&gt; MkSegLevel rep m
-&gt; DistEnv rep m
</span><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#DistEnv"><span class="hs-identifier hs-type">DistEnv</span></a></span><span>
</span><span id="line-679"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">distNest :: Nestings
</span><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#distNest"><span class="hs-identifier hs-var">distNest</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Nesting -&gt; Nestings
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#singleNesting"><span class="hs-identifier hs-var">singleNesting</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Names -&gt; LoopNesting -&gt; Nesting
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#Nesting"><span class="hs-identifier hs-var">Nesting</span></a></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">LoopNesting
</span><a href="#local-6989586621684422543"><span class="hs-identifier hs-var">loopnest</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-680"></span><span>            </span><span class="annot"><span class="annottext">distScope :: Scope GPU
</span><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#distScope"><span class="hs-identifier hs-var">distScope</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-681"></span><span>              </span><span class="annot"><span class="annottext">PatT Type -&gt; Scope GPU
forall rep dec. (LetDec rep ~ dec) =&gt; PatT dec -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOfPat"><span class="hs-identifier hs-var">scopeOfPat</span></a></span><span> </span><span class="annot"><span class="annottext">PatT Type
Pat SOACS
</span><a href="#local-6989586621684422550"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-682"></span><span>                </span><span class="annot"><span class="annottext">Scope GPU -&gt; Scope GPU -&gt; Scope GPU
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Scope SOACS -&gt; Scope GPU
</span><a href="Futhark.Pass.ExtractKernels.ToGPU.html#scopeForGPU"><span class="hs-identifier hs-var">scopeForGPU</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda -&gt; Scope SOACS
forall rep a. Scoped rep a =&gt; a -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOf"><span class="hs-identifier hs-var">scopeOf</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422547"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-683"></span><span>                </span><span class="annot"><span class="annottext">Scope GPU -&gt; Scope GPU -&gt; Scope GPU
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Scope GPU
</span><a href="#local-6989586621684422545"><span class="hs-identifier hs-var">types</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-684"></span><span>            </span><span class="annot"><span class="annottext">distOnInnerMap :: MapLoop -&gt; DistAcc GPU -&gt; DistNestT GPU DistribM (DistAcc GPU)
</span><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#distOnInnerMap"><span class="hs-identifier hs-var">distOnInnerMap</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">KernelPath
-&gt; MapLoop -&gt; DistAcc GPU -&gt; DistNestT GPU DistribM (DistAcc GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#onInnerMap"><span class="hs-identifier hs-var">onInnerMap</span></a></span><span> </span><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422540"><span class="hs-identifier hs-var">path'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-685"></span><span>            </span><span class="annot"><span class="annottext">distOnTopLevelStms :: Stms SOACS -&gt; DistNestT GPU DistribM (Stms GPU)
</span><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#distOnTopLevelStms"><span class="hs-identifier hs-var">distOnTopLevelStms</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">KernelPath -&gt; Stms SOACS -&gt; DistNestT GPU DistribM (Stms GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#onTopLevelStms"><span class="hs-identifier hs-var">onTopLevelStms</span></a></span><span> </span><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422540"><span class="hs-identifier hs-var">path'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-686"></span><span>            </span><span class="annot"><span class="annottext">distSegLevel :: MkSegLevel GPU DistribM
</span><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#distSegLevel"><span class="hs-identifier hs-var">distSegLevel</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MkSegLevel GPU DistribM
forall (m :: * -&gt; *). MonadFreshNames m =&gt; MkSegLevel GPU m
</span><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#segThreadCapped"><span class="hs-identifier hs-var">segThreadCapped</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-687"></span><span>            </span><span class="annot"><span class="annottext">distOnSOACSStms :: Stm SOACS -&gt; BuilderT GPU (State VNameSource) (Stms GPU)
</span><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#distOnSOACSStms"><span class="hs-identifier hs-var">distOnSOACSStms</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stms GPU -&gt; BuilderT GPU (State VNameSource) (Stms GPU)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Stms GPU -&gt; BuilderT GPU (State VNameSource) (Stms GPU))
-&gt; (Stm SOACS -&gt; Stms GPU)
-&gt; Stm SOACS
-&gt; BuilderT GPU (State VNameSource) (Stms GPU)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Stm GPU -&gt; Stms GPU
forall rep. Stm rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#oneStm"><span class="hs-identifier hs-var">oneStm</span></a></span><span> </span><span class="annot"><span class="annottext">(Stm GPU -&gt; Stms GPU)
-&gt; (Stm SOACS -&gt; Stm GPU) -&gt; Stm SOACS -&gt; Stms GPU
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Stm SOACS -&gt; Stm GPU
</span><a href="Futhark.Pass.ExtractKernels.ToGPU.html#soacsStmToGPU"><span class="hs-identifier hs-var">soacsStmToGPU</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-688"></span><span>            </span><span class="annot"><span class="annottext">distOnSOACSLambda :: Lambda -&gt; BuilderT GPU (State VNameSource) (Lambda GPU)
</span><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#distOnSOACSLambda"><span class="hs-identifier hs-var">distOnSOACSLambda</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Lambda GPU -&gt; BuilderT GPU (State VNameSource) (Lambda GPU)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Lambda GPU -&gt; BuilderT GPU (State VNameSource) (Lambda GPU))
-&gt; (Lambda -&gt; Lambda GPU)
-&gt; Lambda
-&gt; BuilderT GPU (State VNameSource) (Lambda GPU)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Lambda -&gt; Lambda GPU
</span><a href="Futhark.Pass.ExtractKernels.ToGPU.html#soacsLambdaToGPU"><span class="hs-identifier hs-var">soacsLambdaToGPU</span></a></span><span>
</span><span id="line-689"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-690"></span><span>      </span><span id="local-6989586621684422525"><span class="annot"><span class="annottext">exploitInnerParallelism :: KernelPath -&gt; DistribM (Stms GPU)
</span><a href="#local-6989586621684422525"><span class="hs-identifier hs-var hs-var">exploitInnerParallelism</span></a></span></span><span> </span><span id="local-6989586621684422524"><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422524"><span class="hs-identifier hs-var">path'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-691"></span><span>        </span><span class="annot"><span class="annottext">DistEnv GPU DistribM
-&gt; DistNestT GPU DistribM (DistAcc GPU) -&gt; DistribM (Stms GPU)
forall (m :: * -&gt; *) rep.
(MonadLogger m, DistRep rep) =&gt;
DistEnv rep m -&gt; DistNestT rep m (DistAcc rep) -&gt; m (Stms rep)
</span><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#runDistNestT"><span class="hs-identifier hs-var">runDistNestT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelPath -&gt; DistEnv GPU DistribM
</span><a href="#local-6989586621684422541"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422524"><span class="hs-identifier hs-var">path'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(DistNestT GPU DistribM (DistAcc GPU) -&gt; DistribM (Stms GPU))
-&gt; DistNestT GPU DistribM (DistAcc GPU) -&gt; DistribM (Stms GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-692"></span><span>          </span><span class="annot"><span class="annottext">DistAcc GPU -&gt; Stms SOACS -&gt; DistNestT GPU DistribM (DistAcc GPU)
forall (m :: * -&gt; *) rep.
(MonadFreshNames m, LocalScope rep m, DistRep rep) =&gt;
DistAcc rep -&gt; Stms SOACS -&gt; DistNestT rep m (DistAcc rep)
</span><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#distributeMapBodyStms"><span class="hs-identifier hs-var">distributeMapBodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">DistAcc GPU
</span><a href="#local-6989586621684422521"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BodyT SOACS -&gt; Stms SOACS
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">(BodyT SOACS -&gt; Stms SOACS) -&gt; BodyT SOACS -&gt; Stms SOACS
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda -&gt; BodyT SOACS
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422547"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-693"></span><span>
</span><span id="line-694"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684422520"><span class="annot"><span class="annottext">exploitOuterParallelism :: KernelPath -&gt; DistribM (Stms GPU)
</span><a href="#local-6989586621684422520"><span class="hs-identifier hs-var hs-var">exploitOuterParallelism</span></a></span></span><span> </span><span id="local-6989586621684422519"><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422519"><span class="hs-identifier hs-var">path'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-695"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684422518"><span class="annot"><span class="annottext">lam' :: Lambda GPU
</span><a href="#local-6989586621684422518"><span class="hs-identifier hs-var hs-var">lam'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Lambda -&gt; Lambda GPU
</span><a href="Futhark.Pass.ExtractKernels.ToGPU.html#soacsLambdaToGPU"><span class="hs-identifier hs-var">soacsLambdaToGPU</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422547"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-696"></span><span>        </span><span class="annot"><span class="annottext">DistEnv GPU DistribM
-&gt; DistNestT GPU DistribM (DistAcc GPU) -&gt; DistribM (Stms GPU)
forall (m :: * -&gt; *) rep.
(MonadLogger m, DistRep rep) =&gt;
DistEnv rep m -&gt; DistNestT rep m (DistAcc rep) -&gt; m (Stms rep)
</span><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#runDistNestT"><span class="hs-identifier hs-var">runDistNestT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelPath -&gt; DistEnv GPU DistribM
</span><a href="#local-6989586621684422541"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422519"><span class="hs-identifier hs-var">path'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(DistNestT GPU DistribM (DistAcc GPU) -&gt; DistribM (Stms GPU))
-&gt; DistNestT GPU DistribM (DistAcc GPU) -&gt; DistribM (Stms GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-697"></span><span>          </span><span class="annot"><span class="annottext">DistAcc GPU -&gt; DistNestT GPU DistribM (DistAcc GPU)
forall (m :: * -&gt; *) rep.
(MonadFreshNames m, LocalScope rep m, DistRep rep) =&gt;
DistAcc rep -&gt; DistNestT rep m (DistAcc rep)
</span><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#distribute"><span class="hs-identifier hs-var">distribute</span></a></span><span> </span><span class="annot"><span class="annottext">(DistAcc GPU -&gt; DistNestT GPU DistribM (DistAcc GPU))
-&gt; DistAcc GPU -&gt; DistNestT GPU DistribM (DistAcc GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-698"></span><span>            </span><span class="annot"><span class="annottext">Stms GPU -&gt; DistAcc GPU -&gt; DistAcc GPU
forall rep. Stms rep -&gt; DistAcc rep -&gt; DistAcc rep
</span><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#addStmsToAcc"><span class="hs-identifier hs-var">addStmsToAcc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Body GPU -&gt; Stms GPU
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">(Body GPU -&gt; Stms GPU) -&gt; Body GPU -&gt; Stms GPU
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda GPU -&gt; Body GPU
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPU
</span><a href="#local-6989586621684422518"><span class="hs-identifier hs-var">lam'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DistAcc GPU
</span><a href="#local-6989586621684422521"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-699"></span><span>
</span><span id="line-700"></span><span>  </span><span class="annot"><span class="annottext">KernelNest
-&gt; KernelPath
-&gt; (KernelPath -&gt; DistribM (Stms GPU))
-&gt; (KernelPath -&gt; DistribM (Stms GPU))
-&gt; Pat SOACS
-&gt; Lambda
-&gt; DistribM (Stms GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#onMap%27"><span class="hs-identifier hs-var">onMap'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LoopNesting -&gt; KernelNest
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#newKernel"><span class="hs-identifier hs-var">newKernel</span></a></span><span> </span><span class="annot"><span class="annottext">LoopNesting
</span><a href="#local-6989586621684422543"><span class="hs-identifier hs-var">loopnest</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422551"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="annot"><span class="annottext">KernelPath -&gt; DistribM (Stms GPU)
</span><a href="#local-6989586621684422520"><span class="hs-identifier hs-var">exploitOuterParallelism</span></a></span><span> </span><span class="annot"><span class="annottext">KernelPath -&gt; DistribM (Stms GPU)
</span><a href="#local-6989586621684422525"><span class="hs-identifier hs-var">exploitInnerParallelism</span></a></span><span> </span><span class="annot"><span class="annottext">Pat SOACS
</span><a href="#local-6989586621684422550"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422547"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-701"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-702"></span><span>    </span><span id="local-6989586621684422521"><span class="annot"><span class="annottext">acc :: DistAcc GPU
</span><a href="#local-6989586621684422521"><span class="hs-identifier hs-var hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-703"></span><span>      </span><span class="annot"><span class="annottext">DistAcc :: forall rep. Targets -&gt; Stms rep -&gt; DistAcc rep
</span><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#DistAcc"><span class="hs-identifier hs-type">DistAcc</span></a></span><span>
</span><span id="line-704"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">distTargets :: Targets
</span><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#distTargets"><span class="hs-identifier hs-var">distTargets</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Target -&gt; Targets
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#singleTarget"><span class="hs-identifier hs-var">singleTarget</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatT Type
Pat SOACS
</span><a href="#local-6989586621684422550"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">BodyT SOACS -&gt; Result
forall rep. BodyT rep -&gt; Result
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var hs-var">bodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">(BodyT SOACS -&gt; Result) -&gt; BodyT SOACS -&gt; Result
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda -&gt; BodyT SOACS
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422547"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-705"></span><span>          </span><span class="annot"><span class="annottext">distStms :: Stms GPU
</span><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#distStms"><span class="hs-identifier hs-var">distStms</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stms GPU
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-706"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-707"></span><span>
</span><span id="line-708"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#onlyExploitIntra"><span class="hs-identifier hs-type">onlyExploitIntra</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Attrs"><span class="hs-identifier hs-type">Attrs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-709"></span><span id="onlyExploitIntra"><span class="annot"><span class="annottext">onlyExploitIntra :: Attrs -&gt; Bool
</span><a href="Futhark.Pass.ExtractKernels.html#onlyExploitIntra"><span class="hs-identifier hs-var hs-var">onlyExploitIntra</span></a></span></span><span> </span><span id="local-6989586621684422508"><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684422508"><span class="hs-identifier hs-var">attrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-710"></span><span>  </span><span class="annot"><span class="annottext">Name -&gt; [Attr] -&gt; Attr
</span><a href="Futhark.IR.Syntax.Core.html#AttrComp"><span class="hs-identifier hs-var">AttrComp</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-string">&quot;incremental_flattening&quot;</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Attr
</span><span class="hs-string">&quot;only_intra&quot;</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Attr -&gt; Attrs -&gt; Bool
</span><a href="Futhark.IR.Syntax.Core.html#inAttrs"><span class="hs-operator hs-var">`inAttrs`</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684422508"><span class="hs-identifier hs-var">attrs</span></a></span><span>
</span><span id="line-711"></span><span>
</span><span id="line-712"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#mayExploitOuter"><span class="hs-identifier hs-type">mayExploitOuter</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Attrs"><span class="hs-identifier hs-type">Attrs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-713"></span><span id="mayExploitOuter"><span class="annot"><span class="annottext">mayExploitOuter :: Attrs -&gt; Bool
</span><a href="Futhark.Pass.ExtractKernels.html#mayExploitOuter"><span class="hs-identifier hs-var hs-var">mayExploitOuter</span></a></span></span><span> </span><span id="local-6989586621684422505"><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684422505"><span class="hs-identifier hs-var">attrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-714"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-715"></span><span>    </span><span class="annot"><span class="annottext">Name -&gt; [Attr] -&gt; Attr
</span><a href="Futhark.IR.Syntax.Core.html#AttrComp"><span class="hs-identifier hs-var">AttrComp</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-string">&quot;incremental_flattening&quot;</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Attr
</span><span class="hs-string">&quot;no_outer&quot;</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Attr -&gt; Attrs -&gt; Bool
</span><a href="Futhark.IR.Syntax.Core.html#inAttrs"><span class="hs-operator hs-var">`inAttrs`</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684422505"><span class="hs-identifier hs-var">attrs</span></a></span><span>
</span><span id="line-716"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; [Attr] -&gt; Attr
</span><a href="Futhark.IR.Syntax.Core.html#AttrComp"><span class="hs-identifier hs-var">AttrComp</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-string">&quot;incremental_flattening&quot;</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Attr
</span><span class="hs-string">&quot;only_inner&quot;</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Attr -&gt; Attrs -&gt; Bool
</span><a href="Futhark.IR.Syntax.Core.html#inAttrs"><span class="hs-operator hs-var">`inAttrs`</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684422505"><span class="hs-identifier hs-var">attrs</span></a></span><span>
</span><span id="line-717"></span><span>
</span><span id="line-718"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#mayExploitIntra"><span class="hs-identifier hs-type">mayExploitIntra</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Attrs"><span class="hs-identifier hs-type">Attrs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-719"></span><span id="mayExploitIntra"><span class="annot"><span class="annottext">mayExploitIntra :: Attrs -&gt; Bool
</span><a href="Futhark.Pass.ExtractKernels.html#mayExploitIntra"><span class="hs-identifier hs-var hs-var">mayExploitIntra</span></a></span></span><span> </span><span id="local-6989586621684422503"><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684422503"><span class="hs-identifier hs-var">attrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-720"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-721"></span><span>    </span><span class="annot"><span class="annottext">Name -&gt; [Attr] -&gt; Attr
</span><a href="Futhark.IR.Syntax.Core.html#AttrComp"><span class="hs-identifier hs-var">AttrComp</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-string">&quot;incremental_flattening&quot;</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Attr
</span><span class="hs-string">&quot;no_intra&quot;</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Attr -&gt; Attrs -&gt; Bool
</span><a href="Futhark.IR.Syntax.Core.html#inAttrs"><span class="hs-operator hs-var">`inAttrs`</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684422503"><span class="hs-identifier hs-var">attrs</span></a></span><span>
</span><span id="line-722"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; [Attr] -&gt; Attr
</span><a href="Futhark.IR.Syntax.Core.html#AttrComp"><span class="hs-identifier hs-var">AttrComp</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-string">&quot;incremental_flattening&quot;</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Attr
</span><span class="hs-string">&quot;only_inner&quot;</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Attr -&gt; Attrs -&gt; Bool
</span><a href="Futhark.IR.Syntax.Core.html#inAttrs"><span class="hs-operator hs-var">`inAttrs`</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684422503"><span class="hs-identifier hs-var">attrs</span></a></span><span>
</span><span id="line-723"></span><span>
</span><span id="line-724"></span><span class="hs-comment">-- The minimum amount of inner parallelism we require (by default) in</span><span>
</span><span id="line-725"></span><span class="hs-comment">-- intra-group versions.  Less than this is usually pointless on a GPU</span><span>
</span><span id="line-726"></span><span class="hs-comment">-- (but we allow tuning to change it).</span><span>
</span><span id="line-727"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#intraMinInnerPar"><span class="hs-identifier hs-type">intraMinInnerPar</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span>
</span><span id="line-728"></span><span id="intraMinInnerPar"><span class="annot"><span class="annottext">intraMinInnerPar :: Int64
</span><a href="Futhark.Pass.ExtractKernels.html#intraMinInnerPar"><span class="hs-identifier hs-var hs-var">intraMinInnerPar</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int64
</span><span class="hs-number">32</span></span><span> </span><span class="hs-comment">-- One NVIDIA warp</span><span>
</span><span id="line-729"></span><span>
</span><span id="line-730"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#onMap%27"><span class="hs-identifier hs-type">onMap'</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-731"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#KernelNest"><span class="hs-identifier hs-type">KernelNest</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-732"></span><span>  </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#KernelPath"><span class="hs-identifier hs-type">KernelPath</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-733"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#KernelPath"><span class="hs-identifier hs-type">KernelPath</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#DistribM"><span class="hs-identifier hs-type">DistribM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Out.Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">Out.GPU</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-734"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#KernelPath"><span class="hs-identifier hs-type">KernelPath</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#DistribM"><span class="hs-identifier hs-type">DistribM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Out.Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">Out.GPU</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-735"></span><span>  </span><span class="annot"><a href="Futhark.IR.SOACS.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-736"></span><span>  </span><span class="annot"><a href="Futhark.IR.SOACS.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-737"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#DistribM"><span class="hs-identifier hs-type">DistribM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Out.Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">Out.GPU</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-738"></span><span id="onMap%27"><span class="annot"><span class="annottext">onMap' :: KernelNest
-&gt; KernelPath
-&gt; (KernelPath -&gt; DistribM (Stms GPU))
-&gt; (KernelPath -&gt; DistribM (Stms GPU))
-&gt; Pat SOACS
-&gt; Lambda
-&gt; DistribM (Stms GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#onMap%27"><span class="hs-identifier hs-var hs-var">onMap'</span></a></span></span><span> </span><span id="local-6989586621684422500"><span class="annot"><span class="annottext">KernelNest
</span><a href="#local-6989586621684422500"><span class="hs-identifier hs-var">loopnest</span></a></span></span><span> </span><span id="local-6989586621684422499"><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422499"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span id="local-6989586621684422498"><span class="annot"><span class="annottext">KernelPath -&gt; DistribM (Stms GPU)
</span><a href="#local-6989586621684422498"><span class="hs-identifier hs-var">mk_seq_stms</span></a></span></span><span> </span><span id="local-6989586621684422497"><span class="annot"><span class="annottext">KernelPath -&gt; DistribM (Stms GPU)
</span><a href="#local-6989586621684422497"><span class="hs-identifier hs-var">mk_par_stms</span></a></span></span><span> </span><span id="local-6989586621684422496"><span class="annot"><span class="annottext">Pat SOACS
</span><a href="#local-6989586621684422496"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684422495"><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422495"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-739"></span><span>  </span><span class="hs-comment">-- Some of the control flow here looks a bit convoluted because we</span><span>
</span><span id="line-740"></span><span>  </span><span class="hs-comment">-- are trying to avoid generating unneeded threshold parameters,</span><span>
</span><span id="line-741"></span><span>  </span><span class="hs-comment">-- which means we need to do all the pruning checks up front.</span><span>
</span><span id="line-742"></span><span>
</span><span id="line-743"></span><span>  </span><span id="local-6989586621684422494"><span class="annot"><span class="annottext">Scope GPU
</span><a href="#local-6989586621684422494"><span class="hs-identifier hs-var">types</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DistribM (Scope GPU)
forall rep (m :: * -&gt; *). HasScope rep m =&gt; m (Scope rep)
</span><a href="Futhark.IR.Prop.Scope.html#askScope"><span class="hs-identifier hs-var">askScope</span></a></span><span>
</span><span id="line-744"></span><span>
</span><span id="line-745"></span><span>  </span><span id="local-6989586621684422493"><span class="annot"><span class="annottext">Maybe ((SubExp, SubExp), SubExp, Log, Stms GPU, Stms GPU)
</span><a href="#local-6989586621684422493"><span class="hs-identifier hs-var">intra</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-746"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Attrs -&gt; Bool
</span><a href="Futhark.Pass.ExtractKernels.html#onlyExploitIntra"><span class="hs-identifier hs-var">onlyExploitIntra</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StmAux () -&gt; Attrs
forall dec. StmAux dec -&gt; Attrs
</span><a href="Futhark.IR.Syntax.html#stmAuxAttrs"><span class="hs-identifier hs-var hs-var">stmAuxAttrs</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux ()
</span><a href="#local-6989586621684422492"><span class="hs-identifier hs-var">aux</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-747"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda -&gt; Bool
</span><a href="Futhark.Pass.ExtractKernels.html#worthIntraGroup"><span class="hs-identifier hs-var">worthIntraGroup</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422495"><span class="hs-identifier hs-var">lam</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Attrs -&gt; Bool
</span><a href="Futhark.Pass.ExtractKernels.html#mayExploitIntra"><span class="hs-identifier hs-var">mayExploitIntra</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684422491"><span class="hs-identifier hs-var">attrs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-748"></span><span>      </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">(ReaderT
   (Scope GPU)
   DistribM
   (Maybe ((SubExp, SubExp), SubExp, Log, Stms GPU, Stms GPU))
 -&gt; Scope GPU
 -&gt; DistribM
      (Maybe ((SubExp, SubExp), SubExp, Log, Stms GPU, Stms GPU)))
-&gt; Scope GPU
-&gt; ReaderT
     (Scope GPU)
     DistribM
     (Maybe ((SubExp, SubExp), SubExp, Log, Stms GPU, Stms GPU))
-&gt; DistribM
     (Maybe ((SubExp, SubExp), SubExp, Log, Stms GPU, Stms GPU))
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">ReaderT
  (Scope GPU)
  DistribM
  (Maybe ((SubExp, SubExp), SubExp, Log, Stms GPU, Stms GPU))
-&gt; Scope GPU
-&gt; DistribM
     (Maybe ((SubExp, SubExp), SubExp, Log, Stms GPU, Stms GPU))
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var hs-var">runReaderT</span></span><span> </span><span class="annot"><span class="annottext">Scope GPU
</span><a href="#local-6989586621684422494"><span class="hs-identifier hs-var">types</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT
   (Scope GPU)
   DistribM
   (Maybe ((SubExp, SubExp), SubExp, Log, Stms GPU, Stms GPU))
 -&gt; DistribM
      (Maybe ((SubExp, SubExp), SubExp, Log, Stms GPU, Stms GPU)))
-&gt; ReaderT
     (Scope GPU)
     DistribM
     (Maybe ((SubExp, SubExp), SubExp, Log, Stms GPU, Stms GPU))
-&gt; DistribM
     (Maybe ((SubExp, SubExp), SubExp, Log, Stms GPU, Stms GPU))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KernelNest
-&gt; Lambda
-&gt; ReaderT
     (Scope GPU)
     DistribM
     (Maybe ((SubExp, SubExp), SubExp, Log, Stms GPU, Stms GPU))
forall (m :: * -&gt; *).
(MonadFreshNames m, LocalScope GPU m) =&gt;
KernelNest
-&gt; Lambda
-&gt; m (Maybe ((SubExp, SubExp), SubExp, Log, Stms GPU, Stms GPU))
</span><a href="Futhark.Pass.ExtractKernels.Intragroup.html#intraGroupParallelise"><span class="hs-identifier hs-var">intraGroupParallelise</span></a></span><span> </span><span class="annot"><span class="annottext">KernelNest
</span><a href="#local-6989586621684422500"><span class="hs-identifier hs-var">loopnest</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422495"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-749"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Maybe ((SubExp, SubExp), SubExp, Log, Stms GPU, Stms GPU)
-&gt; DistribM
     (Maybe ((SubExp, SubExp), SubExp, Log, Stms GPU, Stms GPU))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe ((SubExp, SubExp), SubExp, Log, Stms GPU, Stms GPU)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-750"></span><span>
</span><span id="line-751"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe ((SubExp, SubExp), SubExp, Log, Stms GPU, Stms GPU)
</span><a href="#local-6989586621684422493"><span class="hs-identifier hs-var">intra</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-752"></span><span>    </span><span class="annot"><span class="annottext">Maybe ((SubExp, SubExp), SubExp, Log, Stms GPU, Stms GPU)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Attr
</span><span class="hs-string">&quot;sequential_inner&quot;</span></span><span> </span><span class="annot"><span class="annottext">Attr -&gt; Attrs -&gt; Bool
</span><a href="Futhark.IR.Syntax.Core.html#inAttrs"><span class="hs-operator hs-var">`inAttrs`</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684422491"><span class="hs-identifier hs-var">attrs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-753"></span><span>      </span><span id="local-6989586621684422487"><span class="annot"><span class="annottext">Body GPU
</span><a href="#local-6989586621684422487"><span class="hs-identifier hs-var">seq_body</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Body GPU -&gt; DistribM (Body GPU)
forall rep (m :: * -&gt; *).
(Renameable rep, MonadFreshNames m) =&gt;
Body rep -&gt; m (Body rep)
</span><a href="Futhark.Transform.Rename.html#renameBody"><span class="hs-identifier hs-var">renameBody</span></a></span><span> </span><span class="annot"><span class="annottext">(Body GPU -&gt; DistribM (Body GPU))
-&gt; DistribM (Body GPU) -&gt; DistribM (Body GPU)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">Stms GPU -&gt; Result -&gt; Body GPU
forall rep. Buildable rep =&gt; Stms rep -&gt; Result -&gt; Body rep
</span><a href="Futhark.Builder.Class.html#mkBody"><span class="hs-identifier hs-var">mkBody</span></a></span><span> </span><span class="annot"><span class="annottext">(Stms GPU -&gt; Result -&gt; Body GPU)
-&gt; DistribM (Stms GPU) -&gt; DistribM (Result -&gt; Body GPU)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">KernelPath -&gt; DistribM (Stms GPU)
</span><a href="#local-6989586621684422498"><span class="hs-identifier hs-var">mk_seq_stms</span></a></span><span> </span><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422499"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="annot"><span class="annottext">DistribM (Result -&gt; Body GPU)
-&gt; DistribM Result -&gt; DistribM (Body GPU)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Result -&gt; DistribM Result
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684422486"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-754"></span><span>      </span><span class="annot"><span class="annottext">Pat GPU -&gt; Body GPU -&gt; [(SubExp, Body GPU)] -&gt; DistribM (Stms GPU)
forall (m :: * -&gt; *).
(MonadFreshNames m, HasScope GPU m) =&gt;
Pat GPU -&gt; Body GPU -&gt; [(SubExp, Body GPU)] -&gt; m (Stms GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#kernelAlternatives"><span class="hs-identifier hs-var">kernelAlternatives</span></a></span><span> </span><span class="annot"><span class="annottext">Pat SOACS
Pat GPU
</span><a href="#local-6989586621684422496"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">Body GPU
</span><a href="#local-6989586621684422487"><span class="hs-identifier hs-var">seq_body</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-755"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-756"></span><span>    </span><span class="annot"><span class="annottext">Maybe ((SubExp, SubExp), SubExp, Log, Stms GPU, Stms GPU)
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-757"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684422485"><span class="annot"><span class="annottext">DistribM (SubExp, Name, Stms GPU, Body GPU)
</span><a href="#local-6989586621684422485"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe (DistribM (SubExp, Name, Stms GPU, Body GPU))
</span><a href="#local-6989586621684422484"><span class="hs-identifier hs-var">mkSeqAlts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-758"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621684422483"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422483"><span class="hs-identifier hs-var">outer_suff</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684422482"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684422482"><span class="hs-identifier hs-var">outer_suff_key</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684422481"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684422481"><span class="hs-identifier hs-var">outer_suff_stms</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684422480"><span class="annot"><span class="annottext">Body GPU
</span><a href="#local-6989586621684422480"><span class="hs-identifier hs-var">seq_body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DistribM (SubExp, Name, Stms GPU, Body GPU)
</span><a href="#local-6989586621684422485"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-759"></span><span>        </span><span id="local-6989586621684422479"><span class="annot"><span class="annottext">Body GPU
</span><a href="#local-6989586621684422479"><span class="hs-identifier hs-var">par_body</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-760"></span><span>          </span><span class="annot"><span class="annottext">Body GPU -&gt; DistribM (Body GPU)
forall rep (m :: * -&gt; *).
(Renameable rep, MonadFreshNames m) =&gt;
Body rep -&gt; m (Body rep)
</span><a href="Futhark.Transform.Rename.html#renameBody"><span class="hs-identifier hs-var">renameBody</span></a></span><span> </span><span class="annot"><span class="annottext">(Body GPU -&gt; DistribM (Body GPU))
-&gt; DistribM (Body GPU) -&gt; DistribM (Body GPU)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">Stms GPU -&gt; Result -&gt; Body GPU
forall rep. Buildable rep =&gt; Stms rep -&gt; Result -&gt; Body rep
</span><a href="Futhark.Builder.Class.html#mkBody"><span class="hs-identifier hs-var">mkBody</span></a></span><span>
</span><span id="line-761"></span><span>            </span><span class="annot"><span class="annottext">(Stms GPU -&gt; Result -&gt; Body GPU)
-&gt; DistribM (Stms GPU) -&gt; DistribM (Result -&gt; Body GPU)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">KernelPath -&gt; DistribM (Stms GPU)
</span><a href="#local-6989586621684422497"><span class="hs-identifier hs-var">mk_par_stms</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684422482"><span class="hs-identifier hs-var">outer_suff_key</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Name, Bool) -&gt; KernelPath -&gt; KernelPath
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422499"><span class="hs-identifier hs-var">path</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DistribM (Result -&gt; Body GPU)
-&gt; DistribM Result -&gt; DistribM (Body GPU)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Result -&gt; DistribM Result
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684422486"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-762"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684422481"><span class="hs-identifier hs-var">outer_suff_stms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPU -&gt; Stms GPU -&gt; Stms GPU
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Stms GPU -&gt; Stms GPU)
-&gt; DistribM (Stms GPU) -&gt; DistribM (Stms GPU)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Pat GPU -&gt; Body GPU -&gt; [(SubExp, Body GPU)] -&gt; DistribM (Stms GPU)
forall (m :: * -&gt; *).
(MonadFreshNames m, HasScope GPU m) =&gt;
Pat GPU -&gt; Body GPU -&gt; [(SubExp, Body GPU)] -&gt; m (Stms GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#kernelAlternatives"><span class="hs-identifier hs-var">kernelAlternatives</span></a></span><span> </span><span class="annot"><span class="annottext">Pat SOACS
Pat GPU
</span><a href="#local-6989586621684422496"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">Body GPU
</span><a href="#local-6989586621684422479"><span class="hs-identifier hs-var">par_body</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422483"><span class="hs-identifier hs-var">outer_suff</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Body GPU
</span><a href="#local-6989586621684422480"><span class="hs-identifier hs-var">seq_body</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-763"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-764"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-765"></span><span>        </span><span id="local-6989586621684422478"><span class="annot"><span class="annottext">Body GPU
</span><a href="#local-6989586621684422478"><span class="hs-identifier hs-var">par_body</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Body GPU -&gt; DistribM (Body GPU)
forall rep (m :: * -&gt; *).
(Renameable rep, MonadFreshNames m) =&gt;
Body rep -&gt; m (Body rep)
</span><a href="Futhark.Transform.Rename.html#renameBody"><span class="hs-identifier hs-var">renameBody</span></a></span><span> </span><span class="annot"><span class="annottext">(Body GPU -&gt; DistribM (Body GPU))
-&gt; DistribM (Body GPU) -&gt; DistribM (Body GPU)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">Stms GPU -&gt; Result -&gt; Body GPU
forall rep. Buildable rep =&gt; Stms rep -&gt; Result -&gt; Body rep
</span><a href="Futhark.Builder.Class.html#mkBody"><span class="hs-identifier hs-var">mkBody</span></a></span><span> </span><span class="annot"><span class="annottext">(Stms GPU -&gt; Result -&gt; Body GPU)
-&gt; DistribM (Stms GPU) -&gt; DistribM (Result -&gt; Body GPU)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">KernelPath -&gt; DistribM (Stms GPU)
</span><a href="#local-6989586621684422497"><span class="hs-identifier hs-var">mk_par_stms</span></a></span><span> </span><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422499"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="annot"><span class="annottext">DistribM (Result -&gt; Body GPU)
-&gt; DistribM Result -&gt; DistribM (Body GPU)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Result -&gt; DistribM Result
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684422486"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-766"></span><span>        </span><span class="annot"><span class="annottext">Pat GPU -&gt; Body GPU -&gt; [(SubExp, Body GPU)] -&gt; DistribM (Stms GPU)
forall (m :: * -&gt; *).
(MonadFreshNames m, HasScope GPU m) =&gt;
Pat GPU -&gt; Body GPU -&gt; [(SubExp, Body GPU)] -&gt; m (Stms GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#kernelAlternatives"><span class="hs-identifier hs-var">kernelAlternatives</span></a></span><span> </span><span class="annot"><span class="annottext">Pat SOACS
Pat GPU
</span><a href="#local-6989586621684422496"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">Body GPU
</span><a href="#local-6989586621684422478"><span class="hs-identifier hs-var">par_body</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-767"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-768"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684422477"><span class="annot"><span class="annottext">intra' :: ((SubExp, SubExp), SubExp, Log, Stms GPU, Stms GPU)
</span><a href="#local-6989586621684422477"><span class="hs-identifier hs-var">intra'</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SubExp, SubExp)
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684422476"><span class="annot"><span class="annottext">Log
</span><a href="#local-6989586621684422476"><span class="hs-identifier hs-var">log</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684422475"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684422475"><span class="hs-identifier hs-var">intra_prelude</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684422474"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684422474"><span class="hs-identifier hs-var">intra_stms</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-769"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Attrs -&gt; Bool
</span><a href="Futhark.Pass.ExtractKernels.html#onlyExploitIntra"><span class="hs-identifier hs-var">onlyExploitIntra</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684422491"><span class="hs-identifier hs-var">attrs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-770"></span><span>        </span><span class="annot"><span class="annottext">Log -&gt; DistribM ()
forall (m :: * -&gt; *). MonadLogger m =&gt; Log -&gt; m ()
</span><a href="Futhark.Util.Log.html#addLog"><span class="hs-identifier hs-var">addLog</span></a></span><span> </span><span class="annot"><span class="annottext">Log
</span><a href="#local-6989586621684422476"><span class="hs-identifier hs-var">log</span></a></span><span>
</span><span id="line-771"></span><span>        </span><span id="local-6989586621684422473"><span class="annot"><span class="annottext">Body GPU
</span><a href="#local-6989586621684422473"><span class="hs-identifier hs-var">group_par_body</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Body GPU -&gt; DistribM (Body GPU)
forall rep (m :: * -&gt; *).
(Renameable rep, MonadFreshNames m) =&gt;
Body rep -&gt; m (Body rep)
</span><a href="Futhark.Transform.Rename.html#renameBody"><span class="hs-identifier hs-var">renameBody</span></a></span><span> </span><span class="annot"><span class="annottext">(Body GPU -&gt; DistribM (Body GPU))
-&gt; Body GPU -&gt; DistribM (Body GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stms GPU -&gt; Result -&gt; Body GPU
forall rep. Buildable rep =&gt; Stms rep -&gt; Result -&gt; Body rep
</span><a href="Futhark.Builder.Class.html#mkBody"><span class="hs-identifier hs-var">mkBody</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684422474"><span class="hs-identifier hs-var">intra_stms</span></a></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684422486"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-772"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684422475"><span class="hs-identifier hs-var">intra_prelude</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPU -&gt; Stms GPU -&gt; Stms GPU
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Stms GPU -&gt; Stms GPU)
-&gt; DistribM (Stms GPU) -&gt; DistribM (Stms GPU)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Pat GPU -&gt; Body GPU -&gt; [(SubExp, Body GPU)] -&gt; DistribM (Stms GPU)
forall (m :: * -&gt; *).
(MonadFreshNames m, HasScope GPU m) =&gt;
Pat GPU -&gt; Body GPU -&gt; [(SubExp, Body GPU)] -&gt; m (Stms GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#kernelAlternatives"><span class="hs-identifier hs-var">kernelAlternatives</span></a></span><span> </span><span class="annot"><span class="annottext">Pat SOACS
Pat GPU
</span><a href="#local-6989586621684422496"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">Body GPU
</span><a href="#local-6989586621684422473"><span class="hs-identifier hs-var">group_par_body</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-773"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-774"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-775"></span><span>        </span><span class="annot"><span class="annottext">Log -&gt; DistribM ()
forall (m :: * -&gt; *). MonadLogger m =&gt; Log -&gt; m ()
</span><a href="Futhark.Util.Log.html#addLog"><span class="hs-identifier hs-var">addLog</span></a></span><span> </span><span class="annot"><span class="annottext">Log
</span><a href="#local-6989586621684422476"><span class="hs-identifier hs-var">log</span></a></span><span>
</span><span id="line-776"></span><span>
</span><span id="line-777"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (DistribM (SubExp, Name, Stms GPU, Body GPU))
</span><a href="#local-6989586621684422484"><span class="hs-identifier hs-var">mkSeqAlts</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-778"></span><span>          </span><span class="annot"><span class="annottext">Maybe (DistribM (SubExp, Name, Stms GPU, Body GPU))
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-779"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621684422472"><span class="annot"><span class="annottext">Body GPU
</span><a href="#local-6989586621684422472"><span class="hs-identifier hs-var">group_par_body</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684422471"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422471"><span class="hs-identifier hs-var">intra_ok</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684422470"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684422470"><span class="hs-identifier hs-var">intra_suff_key</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684422469"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684422469"><span class="hs-identifier hs-var">intra_suff_stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-780"></span><span>              </span><span class="annot"><span class="annottext">KernelPath
-&gt; ((SubExp, SubExp), SubExp, Log, Stms GPU, Stms GPU)
-&gt; DistribM (Body GPU, SubExp, Name, Stms GPU)
</span><a href="#local-6989586621684422468"><span class="hs-identifier hs-var">checkSuffIntraPar</span></a></span><span> </span><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422499"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="annot"><span class="annottext">((SubExp, SubExp), SubExp, Log, Stms GPU, Stms GPU)
</span><a href="#local-6989586621684422477"><span class="hs-identifier hs-var">intra'</span></a></span><span>
</span><span id="line-781"></span><span>
</span><span id="line-782"></span><span>            </span><span id="local-6989586621684422467"><span class="annot"><span class="annottext">Body GPU
</span><a href="#local-6989586621684422467"><span class="hs-identifier hs-var">par_body</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-783"></span><span>              </span><span class="annot"><span class="annottext">Body GPU -&gt; DistribM (Body GPU)
forall rep (m :: * -&gt; *).
(Renameable rep, MonadFreshNames m) =&gt;
Body rep -&gt; m (Body rep)
</span><a href="Futhark.Transform.Rename.html#renameBody"><span class="hs-identifier hs-var">renameBody</span></a></span><span> </span><span class="annot"><span class="annottext">(Body GPU -&gt; DistribM (Body GPU))
-&gt; DistribM (Body GPU) -&gt; DistribM (Body GPU)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">Stms GPU -&gt; Result -&gt; Body GPU
forall rep. Buildable rep =&gt; Stms rep -&gt; Result -&gt; Body rep
</span><a href="Futhark.Builder.Class.html#mkBody"><span class="hs-identifier hs-var">mkBody</span></a></span><span>
</span><span id="line-784"></span><span>                </span><span class="annot"><span class="annottext">(Stms GPU -&gt; Result -&gt; Body GPU)
-&gt; DistribM (Stms GPU) -&gt; DistribM (Result -&gt; Body GPU)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">KernelPath -&gt; DistribM (Stms GPU)
</span><a href="#local-6989586621684422497"><span class="hs-identifier hs-var">mk_par_stms</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684422470"><span class="hs-identifier hs-var">intra_suff_key</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Name, Bool) -&gt; KernelPath -&gt; KernelPath
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422499"><span class="hs-identifier hs-var">path</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DistribM (Result -&gt; Body GPU)
-&gt; DistribM Result -&gt; DistribM (Body GPU)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Result -&gt; DistribM Result
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684422486"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-785"></span><span>
</span><span id="line-786"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684422469"><span class="hs-identifier hs-var">intra_suff_stms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPU -&gt; Stms GPU -&gt; Stms GPU
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span class="hs-special">)</span><span>
</span><span id="line-787"></span><span>              </span><span class="annot"><span class="annottext">(Stms GPU -&gt; Stms GPU)
-&gt; DistribM (Stms GPU) -&gt; DistribM (Stms GPU)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Pat GPU -&gt; Body GPU -&gt; [(SubExp, Body GPU)] -&gt; DistribM (Stms GPU)
forall (m :: * -&gt; *).
(MonadFreshNames m, HasScope GPU m) =&gt;
Pat GPU -&gt; Body GPU -&gt; [(SubExp, Body GPU)] -&gt; m (Stms GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#kernelAlternatives"><span class="hs-identifier hs-var">kernelAlternatives</span></a></span><span> </span><span class="annot"><span class="annottext">Pat SOACS
Pat GPU
</span><a href="#local-6989586621684422496"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">Body GPU
</span><a href="#local-6989586621684422467"><span class="hs-identifier hs-var">par_body</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422471"><span class="hs-identifier hs-var">intra_ok</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Body GPU
</span><a href="#local-6989586621684422472"><span class="hs-identifier hs-var">group_par_body</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-788"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684422466"><span class="annot"><span class="annottext">DistribM (SubExp, Name, Stms GPU, Body GPU)
</span><a href="#local-6989586621684422466"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-789"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621684422465"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422465"><span class="hs-identifier hs-var">outer_suff</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684422464"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684422464"><span class="hs-identifier hs-var">outer_suff_key</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684422463"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684422463"><span class="hs-identifier hs-var">outer_suff_stms</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684422462"><span class="annot"><span class="annottext">Body GPU
</span><a href="#local-6989586621684422462"><span class="hs-identifier hs-var">seq_body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DistribM (SubExp, Name, Stms GPU, Body GPU)
</span><a href="#local-6989586621684422466"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-790"></span><span>
</span><span id="line-791"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621684422461"><span class="annot"><span class="annottext">Body GPU
</span><a href="#local-6989586621684422461"><span class="hs-identifier hs-var">group_par_body</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684422460"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422460"><span class="hs-identifier hs-var">intra_ok</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684422459"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684422459"><span class="hs-identifier hs-var">intra_suff_key</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684422458"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684422458"><span class="hs-identifier hs-var">intra_suff_stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-792"></span><span>              </span><span class="annot"><span class="annottext">KernelPath
-&gt; ((SubExp, SubExp), SubExp, Log, Stms GPU, Stms GPU)
-&gt; DistribM (Body GPU, SubExp, Name, Stms GPU)
</span><a href="#local-6989586621684422468"><span class="hs-identifier hs-var">checkSuffIntraPar</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684422464"><span class="hs-identifier hs-var">outer_suff_key</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Name, Bool) -&gt; KernelPath -&gt; KernelPath
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422499"><span class="hs-identifier hs-var">path</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((SubExp, SubExp), SubExp, Log, Stms GPU, Stms GPU)
</span><a href="#local-6989586621684422477"><span class="hs-identifier hs-var">intra'</span></a></span><span>
</span><span id="line-793"></span><span>
</span><span id="line-794"></span><span>            </span><span id="local-6989586621684422457"><span class="annot"><span class="annottext">Body GPU
</span><a href="#local-6989586621684422457"><span class="hs-identifier hs-var">par_body</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-795"></span><span>              </span><span class="annot"><span class="annottext">Body GPU -&gt; DistribM (Body GPU)
forall rep (m :: * -&gt; *).
(Renameable rep, MonadFreshNames m) =&gt;
Body rep -&gt; m (Body rep)
</span><a href="Futhark.Transform.Rename.html#renameBody"><span class="hs-identifier hs-var">renameBody</span></a></span><span> </span><span class="annot"><span class="annottext">(Body GPU -&gt; DistribM (Body GPU))
-&gt; DistribM (Body GPU) -&gt; DistribM (Body GPU)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">Stms GPU -&gt; Result -&gt; Body GPU
forall rep. Buildable rep =&gt; Stms rep -&gt; Result -&gt; Body rep
</span><a href="Futhark.Builder.Class.html#mkBody"><span class="hs-identifier hs-var">mkBody</span></a></span><span>
</span><span id="line-796"></span><span>                </span><span class="annot"><span class="annottext">(Stms GPU -&gt; Result -&gt; Body GPU)
-&gt; DistribM (Stms GPU) -&gt; DistribM (Result -&gt; Body GPU)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">KernelPath -&gt; DistribM (Stms GPU)
</span><a href="#local-6989586621684422497"><span class="hs-identifier hs-var">mk_par_stms</span></a></span><span>
</span><span id="line-797"></span><span>                  </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684422464"><span class="hs-identifier hs-var">outer_suff_key</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-798"></span><span>                      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684422459"><span class="hs-identifier hs-var">intra_suff_key</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span>
</span><span id="line-799"></span><span>                    </span><span class="hs-special">]</span><span>
</span><span id="line-800"></span><span>                      </span><span class="annot"><span class="annottext">KernelPath -&gt; KernelPath -&gt; KernelPath
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422499"><span class="hs-identifier hs-var">path</span></a></span><span>
</span><span id="line-801"></span><span>                  </span><span class="hs-special">)</span><span>
</span><span id="line-802"></span><span>                  </span><span class="annot"><span class="annottext">DistribM (Result -&gt; Body GPU)
-&gt; DistribM Result -&gt; DistribM (Body GPU)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Result -&gt; DistribM Result
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684422486"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-803"></span><span>
</span><span id="line-804"></span><span>            </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684422463"><span class="hs-identifier hs-var">outer_suff_stms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPU -&gt; Stms GPU -&gt; Stms GPU
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684422458"><span class="hs-identifier hs-var">intra_suff_stms</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stms GPU -&gt; Stms GPU -&gt; Stms GPU
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span class="hs-special">)</span><span>
</span><span id="line-805"></span><span>              </span><span class="annot"><span class="annottext">(Stms GPU -&gt; Stms GPU)
-&gt; DistribM (Stms GPU) -&gt; DistribM (Stms GPU)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Pat GPU -&gt; Body GPU -&gt; [(SubExp, Body GPU)] -&gt; DistribM (Stms GPU)
forall (m :: * -&gt; *).
(MonadFreshNames m, HasScope GPU m) =&gt;
Pat GPU -&gt; Body GPU -&gt; [(SubExp, Body GPU)] -&gt; m (Stms GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#kernelAlternatives"><span class="hs-identifier hs-var">kernelAlternatives</span></a></span><span>
</span><span id="line-806"></span><span>                </span><span class="annot"><span class="annottext">Pat SOACS
Pat GPU
</span><a href="#local-6989586621684422496"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-807"></span><span>                </span><span class="annot"><span class="annottext">Body GPU
</span><a href="#local-6989586621684422457"><span class="hs-identifier hs-var">par_body</span></a></span><span>
</span><span id="line-808"></span><span>                </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422465"><span class="hs-identifier hs-var">outer_suff</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Body GPU
</span><a href="#local-6989586621684422462"><span class="hs-identifier hs-var">seq_body</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422460"><span class="hs-identifier hs-var">intra_ok</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Body GPU
</span><a href="#local-6989586621684422461"><span class="hs-identifier hs-var">group_par_body</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-809"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-810"></span><span>    </span><span id="local-6989586621684422456"><span class="annot"><span class="annottext">nest_ws :: [SubExp]
</span><a href="#local-6989586621684422456"><span class="hs-identifier hs-var hs-var">nest_ws</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">KernelNest -&gt; [SubExp]
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#kernelNestWidths"><span class="hs-identifier hs-var">kernelNestWidths</span></a></span><span> </span><span class="annot"><span class="annottext">KernelNest
</span><a href="#local-6989586621684422500"><span class="hs-identifier hs-var">loopnest</span></a></span><span>
</span><span id="line-811"></span><span>    </span><span id="local-6989586621684422486"><span class="annot"><span class="annottext">res :: Result
</span><a href="#local-6989586621684422486"><span class="hs-identifier hs-var hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Result
</span><a href="Futhark.IR.Syntax.html#varsRes"><span class="hs-identifier hs-var">varsRes</span></a></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; Result) -&gt; [VName] -&gt; Result
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatT Type -&gt; [VName]
forall dec. PatT dec -&gt; [VName]
</span><a href="Futhark.IR.Prop.Patterns.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="annot"><span class="annottext">PatT Type
Pat SOACS
</span><a href="#local-6989586621684422496"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-812"></span><span>    </span><span id="local-6989586621684422492"><span class="annot"><span class="annottext">aux :: StmAux ()
</span><a href="#local-6989586621684422492"><span class="hs-identifier hs-var hs-var">aux</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LoopNesting -&gt; StmAux ()
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#loopNestingAux"><span class="hs-identifier hs-var hs-var">loopNestingAux</span></a></span><span> </span><span class="annot"><span class="annottext">(LoopNesting -&gt; StmAux ()) -&gt; LoopNesting -&gt; StmAux ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KernelNest -&gt; LoopNesting
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#innermostKernelNesting"><span class="hs-identifier hs-var">innermostKernelNesting</span></a></span><span> </span><span class="annot"><span class="annottext">KernelNest
</span><a href="#local-6989586621684422500"><span class="hs-identifier hs-var">loopnest</span></a></span><span>
</span><span id="line-813"></span><span>    </span><span id="local-6989586621684422491"><span class="annot"><span class="annottext">attrs :: Attrs
</span><a href="#local-6989586621684422491"><span class="hs-identifier hs-var hs-var">attrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StmAux () -&gt; Attrs
forall dec. StmAux dec -&gt; Attrs
</span><a href="Futhark.IR.Syntax.html#stmAuxAttrs"><span class="hs-identifier hs-var hs-var">stmAuxAttrs</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux ()
</span><a href="#local-6989586621684422492"><span class="hs-identifier hs-var">aux</span></a></span><span>
</span><span id="line-814"></span><span>
</span><span id="line-815"></span><span>    </span><span id="local-6989586621684422484"><span class="annot"><span class="annottext">mkSeqAlts :: Maybe (DistribM (SubExp, Name, Stms GPU, Body GPU))
</span><a href="#local-6989586621684422484"><span class="hs-identifier hs-var hs-var">mkSeqAlts</span></a></span></span><span>
</span><span id="line-816"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Lambda -&gt; Bool
</span><a href="Futhark.Pass.ExtractKernels.html#worthSequentialising"><span class="hs-identifier hs-var">worthSequentialising</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422495"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-817"></span><span>        </span><span class="annot"><span class="annottext">Attrs -&gt; Bool
</span><a href="Futhark.Pass.ExtractKernels.html#mayExploitOuter"><span class="hs-identifier hs-var">mayExploitOuter</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684422491"><span class="hs-identifier hs-var">attrs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DistribM (SubExp, Name, Stms GPU, Body GPU)
-&gt; Maybe (DistribM (SubExp, Name, Stms GPU, Body GPU))
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(DistribM (SubExp, Name, Stms GPU, Body GPU)
 -&gt; Maybe (DistribM (SubExp, Name, Stms GPU, Body GPU)))
-&gt; DistribM (SubExp, Name, Stms GPU, Body GPU)
-&gt; Maybe (DistribM (SubExp, Name, Stms GPU, Body GPU))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-818"></span><span>        </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621684422452"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422452"><span class="hs-identifier hs-var">outer_suff</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684422451"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684422451"><span class="hs-identifier hs-var">outer_suff_key</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621684422450"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684422450"><span class="hs-identifier hs-var">outer_suff_stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DistribM ((SubExp, Name), Stms GPU)
</span><a href="#local-6989586621684422449"><span class="hs-identifier hs-var">checkSuffOuterPar</span></a></span><span>
</span><span id="line-819"></span><span>        </span><span id="local-6989586621684422448"><span class="annot"><span class="annottext">Body GPU
</span><a href="#local-6989586621684422448"><span class="hs-identifier hs-var">seq_body</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-820"></span><span>          </span><span class="annot"><span class="annottext">Body GPU -&gt; DistribM (Body GPU)
forall rep (m :: * -&gt; *).
(Renameable rep, MonadFreshNames m) =&gt;
Body rep -&gt; m (Body rep)
</span><a href="Futhark.Transform.Rename.html#renameBody"><span class="hs-identifier hs-var">renameBody</span></a></span><span> </span><span class="annot"><span class="annottext">(Body GPU -&gt; DistribM (Body GPU))
-&gt; DistribM (Body GPU) -&gt; DistribM (Body GPU)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">Stms GPU -&gt; Result -&gt; Body GPU
forall rep. Buildable rep =&gt; Stms rep -&gt; Result -&gt; Body rep
</span><a href="Futhark.Builder.Class.html#mkBody"><span class="hs-identifier hs-var">mkBody</span></a></span><span>
</span><span id="line-821"></span><span>            </span><span class="annot"><span class="annottext">(Stms GPU -&gt; Result -&gt; Body GPU)
-&gt; DistribM (Stms GPU) -&gt; DistribM (Result -&gt; Body GPU)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">KernelPath -&gt; DistribM (Stms GPU)
</span><a href="#local-6989586621684422498"><span class="hs-identifier hs-var">mk_seq_stms</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684422451"><span class="hs-identifier hs-var">outer_suff_key</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Name, Bool) -&gt; KernelPath -&gt; KernelPath
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422499"><span class="hs-identifier hs-var">path</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DistribM (Result -&gt; Body GPU)
-&gt; DistribM Result -&gt; DistribM (Body GPU)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Result -&gt; DistribM Result
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684422486"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-822"></span><span>        </span><span class="annot"><span class="annottext">(SubExp, Name, Stms GPU, Body GPU)
-&gt; DistribM (SubExp, Name, Stms GPU, Body GPU)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422452"><span class="hs-identifier hs-var">outer_suff</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684422451"><span class="hs-identifier hs-var">outer_suff_key</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684422450"><span class="hs-identifier hs-var">outer_suff_stms</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Body GPU
</span><a href="#local-6989586621684422448"><span class="hs-identifier hs-var">seq_body</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-823"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-824"></span><span>        </span><span class="annot"><span class="annottext">Maybe (DistribM (SubExp, Name, Stms GPU, Body GPU))
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-825"></span><span>
</span><span id="line-826"></span><span>    </span><span id="local-6989586621684422449"><span class="annot"><span class="annottext">checkSuffOuterPar :: DistribM ((SubExp, Name), Stms GPU)
</span><a href="#local-6989586621684422449"><span class="hs-identifier hs-var hs-var">checkSuffOuterPar</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-827"></span><span>      </span><span class="annot"><span class="annottext">[Char]
-&gt; [SubExp]
-&gt; KernelPath
-&gt; Maybe Int64
-&gt; DistribM ((SubExp, Name), Stms GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#sufficientParallelism"><span class="hs-identifier hs-var">sufficientParallelism</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;suff_outer_par&quot;</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684422456"><span class="hs-identifier hs-var">nest_ws</span></a></span><span> </span><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422499"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Int64
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-828"></span><span>
</span><span id="line-829"></span><span>    </span><span id="local-6989586621684422468"><span class="annot"><span class="annottext">checkSuffIntraPar :: KernelPath
-&gt; ((SubExp, SubExp), SubExp, Log, Stms GPU, Stms GPU)
-&gt; DistribM (Body GPU, SubExp, Name, Stms GPU)
</span><a href="#local-6989586621684422468"><span class="hs-identifier hs-var hs-var">checkSuffIntraPar</span></a></span></span><span>
</span><span id="line-830"></span><span>      </span><span id="local-6989586621684422447"><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422447"><span class="hs-identifier hs-var">path'</span></a></span></span><span>
</span><span id="line-831"></span><span>      </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621684422446"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422446"><span class="hs-identifier hs-var">_intra_min_par</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684422445"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422445"><span class="hs-identifier hs-var">intra_avail_par</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621684422444"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422444"><span class="hs-identifier hs-var">group_size</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Log
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684422443"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684422443"><span class="hs-identifier hs-var">intra_prelude</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684422442"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684422442"><span class="hs-identifier hs-var">intra_stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-832"></span><span>        </span><span class="hs-comment">-- We must check that all intra-group parallelism fits in a group.</span><span>
</span><span id="line-833"></span><span>        </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621684422441"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422441"><span class="hs-identifier hs-var">intra_ok</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684422440"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684422440"><span class="hs-identifier hs-var">intra_suff_key</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621684422439"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684422439"><span class="hs-identifier hs-var">intra_suff_stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-834"></span><span>          </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621684422438"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422438"><span class="hs-identifier hs-var">intra_suff</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684422437"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684422437"><span class="hs-identifier hs-var">suff_key</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621684422436"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684422436"><span class="hs-identifier hs-var">check_suff_stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-835"></span><span>            </span><span class="annot"><span class="annottext">[Char]
-&gt; [SubExp]
-&gt; KernelPath
-&gt; Maybe Int64
-&gt; DistribM ((SubExp, Name), Stms GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#sufficientParallelism"><span class="hs-identifier hs-var">sufficientParallelism</span></a></span><span>
</span><span id="line-836"></span><span>              </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;suff_intra_par&quot;</span></span><span>
</span><span id="line-837"></span><span>              </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422445"><span class="hs-identifier hs-var">intra_avail_par</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-838"></span><span>              </span><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422447"><span class="hs-identifier hs-var">path'</span></a></span><span>
</span><span id="line-839"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int64 -&gt; Maybe Int64
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Int64
</span><a href="Futhark.Pass.ExtractKernels.html#intraMinInnerPar"><span class="hs-identifier hs-var">intraMinInnerPar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-840"></span><span>
</span><span id="line-841"></span><span>          </span><span class="annot"><span class="annottext">Builder GPU (SubExp, Name) -&gt; DistribM ((SubExp, Name), Stms GPU)
forall (m :: * -&gt; *) somerep rep a.
(MonadFreshNames m, HasScope somerep m, SameScope somerep rep) =&gt;
Builder rep a -&gt; m (a, Stms rep)
</span><a href="Futhark.Builder.html#runBuilder"><span class="hs-identifier hs-var">runBuilder</span></a></span><span> </span><span class="annot"><span class="annottext">(Builder GPU (SubExp, Name) -&gt; DistribM ((SubExp, Name), Stms GPU))
-&gt; Builder GPU (SubExp, Name)
-&gt; DistribM ((SubExp, Name), Stms GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-842"></span><span>            </span><span class="annot"><span class="annottext">Stms (Rep (BuilderT GPU (State VNameSource))) -&gt; Builder GPU ()
forall (m :: * -&gt; *). MonadBuilder m =&gt; Stms (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#addStms"><span class="hs-identifier hs-var">addStms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms (Rep (BuilderT GPU (State VNameSource)))
Stms GPU
</span><a href="#local-6989586621684422443"><span class="hs-identifier hs-var">intra_prelude</span></a></span><span>
</span><span id="line-843"></span><span>
</span><span id="line-844"></span><span>            </span><span id="local-6989586621684422435"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422435"><span class="hs-identifier hs-var">max_group_size</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-845"></span><span>              </span><span class="annot"><span class="annottext">[Char]
-&gt; Exp (Rep (BuilderT GPU (State VNameSource)))
-&gt; BuilderT GPU (State VNameSource) SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[Char] -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;max_group_size&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (BuilderT GPU (State VNameSource)))
 -&gt; BuilderT GPU (State VNameSource) SubExp)
-&gt; Exp (Rep (BuilderT GPU (State VNameSource)))
-&gt; BuilderT GPU (State VNameSource) SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Op GPU -&gt; ExpT GPU
forall rep. Op rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-var">Op</span></a></span><span> </span><span class="annot"><span class="annottext">(Op GPU -&gt; ExpT GPU) -&gt; Op GPU -&gt; ExpT GPU
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SizeOp -&gt; HostOp GPU (SOAC GPU)
forall rep op. SizeOp -&gt; HostOp rep op
</span><a href="Futhark.IR.GPU.Op.html#SizeOp"><span class="hs-identifier hs-var">SizeOp</span></a></span><span> </span><span class="annot"><span class="annottext">(SizeOp -&gt; HostOp GPU (SOAC GPU))
-&gt; SizeOp -&gt; HostOp GPU (SOAC GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SizeClass -&gt; SizeOp
</span><a href="Futhark.IR.GPU.Op.html#GetSizeMax"><span class="hs-identifier hs-var">Out.GetSizeMax</span></a></span><span> </span><span class="annot"><span class="annottext">SizeClass
</span><a href="Futhark.IR.GPU.Sizes.html#SizeGroup"><span class="hs-identifier hs-var">Out.SizeGroup</span></a></span><span>
</span><span id="line-846"></span><span>            </span><span id="local-6989586621684422432"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422432"><span class="hs-identifier hs-var">fits</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-847"></span><span>              </span><span class="annot"><span class="annottext">[Char]
-&gt; Exp (Rep (BuilderT GPU (State VNameSource)))
-&gt; BuilderT GPU (State VNameSource) SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[Char] -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;fits&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (BuilderT GPU (State VNameSource)))
 -&gt; BuilderT GPU (State VNameSource) SubExp)
-&gt; Exp (Rep (BuilderT GPU (State VNameSource)))
-&gt; BuilderT GPU (State VNameSource) SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-848"></span><span>                </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT GPU
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT GPU) -&gt; BasicOp -&gt; ExpT GPU
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-849"></span><span>                  </span><span class="annot"><span class="annottext">CmpOp -&gt; SubExp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#CmpOp"><span class="hs-identifier hs-var">CmpOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; CmpOp
</span><a href="Futhark.IR.Primitive.html#CmpSle"><span class="hs-identifier hs-var">CmpSle</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422444"><span class="hs-identifier hs-var">group_size</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422435"><span class="hs-identifier hs-var">max_group_size</span></a></span><span>
</span><span id="line-850"></span><span>
</span><span id="line-851"></span><span>            </span><span class="annot"><span class="annottext">Stms (Rep (BuilderT GPU (State VNameSource))) -&gt; Builder GPU ()
forall (m :: * -&gt; *). MonadBuilder m =&gt; Stms (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#addStms"><span class="hs-identifier hs-var">addStms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms (Rep (BuilderT GPU (State VNameSource)))
Stms GPU
</span><a href="#local-6989586621684422436"><span class="hs-identifier hs-var">check_suff_stms</span></a></span><span>
</span><span id="line-852"></span><span>
</span><span id="line-853"></span><span>            </span><span id="local-6989586621684422429"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422429"><span class="hs-identifier hs-var">intra_ok</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Char]
-&gt; Exp (Rep (BuilderT GPU (State VNameSource)))
-&gt; BuilderT GPU (State VNameSource) SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[Char] -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;intra_suff_and_fits&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (BuilderT GPU (State VNameSource)))
 -&gt; BuilderT GPU (State VNameSource) SubExp)
-&gt; Exp (Rep (BuilderT GPU (State VNameSource)))
-&gt; BuilderT GPU (State VNameSource) SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT GPU
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT GPU) -&gt; BasicOp -&gt; ExpT GPU
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BinOp -&gt; SubExp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#BinOp"><span class="hs-identifier hs-var">BinOp</span></a></span><span> </span><span class="annot"><span class="annottext">BinOp
</span><a href="Futhark.IR.Primitive.html#LogAnd"><span class="hs-identifier hs-var">LogAnd</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422432"><span class="hs-identifier hs-var">fits</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422438"><span class="hs-identifier hs-var">intra_suff</span></a></span><span>
</span><span id="line-854"></span><span>            </span><span class="annot"><span class="annottext">(SubExp, Name) -&gt; Builder GPU (SubExp, Name)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422429"><span class="hs-identifier hs-var">intra_ok</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684422437"><span class="hs-identifier hs-var">suff_key</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-855"></span><span>
</span><span id="line-856"></span><span>        </span><span id="local-6989586621684422426"><span class="annot"><span class="annottext">Body GPU
</span><a href="#local-6989586621684422426"><span class="hs-identifier hs-var">group_par_body</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Body GPU -&gt; DistribM (Body GPU)
forall rep (m :: * -&gt; *).
(Renameable rep, MonadFreshNames m) =&gt;
Body rep -&gt; m (Body rep)
</span><a href="Futhark.Transform.Rename.html#renameBody"><span class="hs-identifier hs-var">renameBody</span></a></span><span> </span><span class="annot"><span class="annottext">(Body GPU -&gt; DistribM (Body GPU))
-&gt; Body GPU -&gt; DistribM (Body GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stms GPU -&gt; Result -&gt; Body GPU
forall rep. Buildable rep =&gt; Stms rep -&gt; Result -&gt; Body rep
</span><a href="Futhark.Builder.Class.html#mkBody"><span class="hs-identifier hs-var">mkBody</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684422442"><span class="hs-identifier hs-var">intra_stms</span></a></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684422486"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-857"></span><span>        </span><span class="annot"><span class="annottext">(Body GPU, SubExp, Name, Stms GPU)
-&gt; DistribM (Body GPU, SubExp, Name, Stms GPU)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Body GPU
</span><a href="#local-6989586621684422426"><span class="hs-identifier hs-var">group_par_body</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422441"><span class="hs-identifier hs-var">intra_ok</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684422440"><span class="hs-identifier hs-var">intra_suff_key</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684422439"><span class="hs-identifier hs-var">intra_suff_stms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-858"></span><span>
</span><span id="line-859"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#onInnerMap"><span class="hs-identifier hs-type">onInnerMap</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-860"></span><span>  </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#KernelPath"><span class="hs-identifier hs-type">KernelPath</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-861"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#MapLoop"><span class="hs-identifier hs-type">MapLoop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-862"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#DistAcc"><span class="hs-identifier hs-type">DistAcc</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">Out.GPU</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-863"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#DistNestT"><span class="hs-identifier hs-type">DistNestT</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">Out.GPU</span></a></span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.html#DistribM"><span class="hs-identifier hs-type">DistribM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#DistAcc"><span class="hs-identifier hs-type">DistAcc</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">Out.GPU</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-864"></span><span id="onInnerMap"><span class="annot"><span class="annottext">onInnerMap :: KernelPath
-&gt; MapLoop -&gt; DistAcc GPU -&gt; DistNestT GPU DistribM (DistAcc GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#onInnerMap"><span class="hs-identifier hs-var hs-var">onInnerMap</span></a></span></span><span> </span><span id="local-6989586621684422425"><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422425"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span id="local-6989586621684422424"><span class="annot"><span class="annottext">maploop :: MapLoop
</span><a href="#local-6989586621684422424"><span class="hs-identifier hs-var">maploop</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#MapLoop"><span class="hs-identifier hs-type">MapLoop</span></a></span><span> </span><span id="local-6989586621684422423"><span class="annot"><span class="annottext">Pat SOACS
</span><a href="#local-6989586621684422423"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684422422"><span class="annot"><span class="annottext">StmAux ()
</span><a href="#local-6989586621684422422"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span id="local-6989586621684422421"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422421"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684422420"><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422420"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span id="local-6989586621684422419"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684422419"><span class="hs-identifier hs-var">arrs</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684422418"><span class="annot"><span class="annottext">DistAcc GPU
</span><a href="#local-6989586621684422418"><span class="hs-identifier hs-var">acc</span></a></span></span><span>
</span><span id="line-865"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Lambda -&gt; Bool
</span><a href="Futhark.Pass.ExtractKernels.html#unbalancedLambda"><span class="hs-identifier hs-var">unbalancedLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422420"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-866"></span><span>    </span><span class="annot"><span class="annottext">Lambda -&gt; Bool
</span><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#lambdaContainsParallelism"><span class="hs-identifier hs-var">lambdaContainsParallelism</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422420"><span class="hs-identifier hs-var">lam</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-867"></span><span>    </span><span class="annot"><span class="annottext">Stm SOACS -&gt; DistAcc GPU -&gt; DistNestT GPU DistribM (DistAcc GPU)
forall (m :: * -&gt; *) rep.
(MonadFreshNames m, DistRep rep) =&gt;
Stm SOACS -&gt; DistAcc rep -&gt; DistNestT rep m (DistAcc rep)
</span><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#addStmToAcc"><span class="hs-identifier hs-var">addStmToAcc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MapLoop -&gt; Stm SOACS
</span><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#mapLoopStm"><span class="hs-identifier hs-var">mapLoopStm</span></a></span><span> </span><span class="annot"><span class="annottext">MapLoop
</span><a href="#local-6989586621684422424"><span class="hs-identifier hs-var">maploop</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DistAcc GPU
</span><a href="#local-6989586621684422418"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-868"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-869"></span><span>    </span><span class="annot"><span class="annottext">DistAcc GPU
-&gt; Stm SOACS
-&gt; DistNestT
     GPU
     DistribM
     (Maybe (PostStms GPU, Result, KernelNest, DistAcc GPU))
forall (m :: * -&gt; *) rep.
(MonadFreshNames m, LocalScope rep m, DistRep rep) =&gt;
DistAcc rep
-&gt; Stm SOACS
-&gt; DistNestT
     rep m (Maybe (PostStms rep, Result, KernelNest, DistAcc rep))
</span><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#distributeSingleStm"><span class="hs-identifier hs-var">distributeSingleStm</span></a></span><span> </span><span class="annot"><span class="annottext">DistAcc GPU
</span><a href="#local-6989586621684422418"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MapLoop -&gt; Stm SOACS
</span><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#mapLoopStm"><span class="hs-identifier hs-var">mapLoopStm</span></a></span><span> </span><span class="annot"><span class="annottext">MapLoop
</span><a href="#local-6989586621684422424"><span class="hs-identifier hs-var">maploop</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DistNestT
  GPU
  DistribM
  (Maybe (PostStms GPU, Result, KernelNest, DistAcc GPU))
-&gt; (Maybe (PostStms GPU, Result, KernelNest, DistAcc GPU)
    -&gt; DistNestT GPU DistribM (DistAcc GPU))
-&gt; DistNestT GPU DistribM (DistAcc GPU)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-870"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684422414"><span class="annot"><span class="annottext">PostStms GPU
</span><a href="#local-6989586621684422414"><span class="hs-identifier hs-var">post_kernels</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684422413"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684422413"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684422412"><span class="annot"><span class="annottext">KernelNest
</span><a href="#local-6989586621684422412"><span class="hs-identifier hs-var">nest</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684422411"><span class="annot"><span class="annottext">DistAcc GPU
</span><a href="#local-6989586621684422411"><span class="hs-identifier hs-var">acc'</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-871"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684422410"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684422410"><span class="hs-identifier hs-var">perm</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684422409"><span class="annot"><span class="annottext">[PatElemT Type]
</span><a href="#local-6989586621684422409"><span class="hs-identifier hs-var">_pat_unused</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PatT Type -&gt; Result -&gt; Maybe ([Int], [PatElemT Type])
</span><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#permutationAndMissing"><span class="hs-identifier hs-var">permutationAndMissing</span></a></span><span> </span><span class="annot"><span class="annottext">PatT Type
Pat SOACS
</span><a href="#local-6989586621684422423"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684422413"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-872"></span><span>          </span><span class="annot"><span class="annottext">PostStms GPU -&gt; DistNestT GPU DistribM ()
forall (m :: * -&gt; *) rep.
Monad m =&gt;
PostStms rep -&gt; DistNestT rep m ()
</span><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#addPostStms"><span class="hs-identifier hs-var">addPostStms</span></a></span><span> </span><span class="annot"><span class="annottext">PostStms GPU
</span><a href="#local-6989586621684422414"><span class="hs-identifier hs-var">post_kernels</span></a></span><span>
</span><span id="line-873"></span><span>          </span><span class="annot"><span class="annottext">[Int]
-&gt; KernelNest
-&gt; DistAcc GPU
-&gt; DistNestT GPU DistribM (DistAcc GPU)
</span><a href="#local-6989586621684422406"><span class="hs-identifier hs-var">multiVersion</span></a></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684422410"><span class="hs-identifier hs-var">perm</span></a></span><span> </span><span class="annot"><span class="annottext">KernelNest
</span><a href="#local-6989586621684422412"><span class="hs-identifier hs-var">nest</span></a></span><span> </span><span class="annot"><span class="annottext">DistAcc GPU
</span><a href="#local-6989586621684422411"><span class="hs-identifier hs-var">acc'</span></a></span><span>
</span><span id="line-874"></span><span>      </span><span class="annot"><span class="annottext">Maybe (PostStms GPU, Result, KernelNest, DistAcc GPU)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MapLoop -&gt; DistAcc GPU -&gt; DistNestT GPU DistribM (DistAcc GPU)
forall (m :: * -&gt; *) rep.
(MonadFreshNames m, LocalScope rep m, DistRep rep) =&gt;
MapLoop -&gt; DistAcc rep -&gt; DistNestT rep m (DistAcc rep)
</span><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#distributeMap"><span class="hs-identifier hs-var">distributeMap</span></a></span><span> </span><span class="annot"><span class="annottext">MapLoop
</span><a href="#local-6989586621684422424"><span class="hs-identifier hs-var">maploop</span></a></span><span> </span><span class="annot"><span class="annottext">DistAcc GPU
</span><a href="#local-6989586621684422418"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-875"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-876"></span><span>    </span><span id="local-6989586621684422401"><span class="annot"><span class="annottext">discardTargets :: DistAcc rep -&gt; DistAcc rep
</span><a href="#local-6989586621684422401"><span class="hs-identifier hs-var hs-var">discardTargets</span></a></span></span><span> </span><span id="local-6989586621684422400"><span class="annot"><span class="annottext">DistAcc rep
</span><a href="#local-6989586621684422400"><span class="hs-identifier hs-var">acc'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-877"></span><span>      </span><span class="hs-comment">-- FIXME: work around bogus targets.</span><span>
</span><span id="line-878"></span><span>      </span><span class="annot"><span class="annottext">DistAcc rep
</span><a href="#local-6989586621684422400"><span class="hs-identifier hs-var">acc'</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">distTargets :: Targets
</span><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#distTargets"><span class="hs-identifier hs-var">distTargets</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Target -&gt; Targets
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#singleTarget"><span class="hs-identifier hs-var">singleTarget</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatT Type
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Result
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span class="hs-special">}</span><span>
</span><span id="line-879"></span><span>
</span><span id="line-880"></span><span>    </span><span id="local-6989586621684422406"><span class="annot"><span class="annottext">multiVersion :: [Int]
-&gt; KernelNest
-&gt; DistAcc GPU
-&gt; DistNestT GPU DistribM (DistAcc GPU)
</span><a href="#local-6989586621684422406"><span class="hs-identifier hs-var hs-var">multiVersion</span></a></span></span><span> </span><span id="local-6989586621684422399"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684422399"><span class="hs-identifier hs-var">perm</span></a></span></span><span> </span><span id="local-6989586621684422398"><span class="annot"><span class="annottext">KernelNest
</span><a href="#local-6989586621684422398"><span class="hs-identifier hs-var">nest</span></a></span></span><span> </span><span id="local-6989586621684422397"><span class="annot"><span class="annottext">DistAcc GPU
</span><a href="#local-6989586621684422397"><span class="hs-identifier hs-var">acc'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-881"></span><span>      </span><span class="hs-comment">-- The kernel can be distributed by itself, so now we can</span><span>
</span><span id="line-882"></span><span>      </span><span class="hs-comment">-- decide whether to just sequentialise, or exploit inner</span><span>
</span><span id="line-883"></span><span>      </span><span class="hs-comment">-- parallelism.</span><span>
</span><span id="line-884"></span><span>      </span><span id="local-6989586621684422396"><span class="annot"><span class="annottext">DistEnv GPU DistribM
</span><a href="#local-6989586621684422396"><span class="hs-identifier hs-var">dist_env</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DistNestT GPU DistribM (DistEnv GPU DistribM)
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-885"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684422394"><span class="annot"><span class="annottext">extra_scope :: Scope GPU
</span><a href="#local-6989586621684422394"><span class="hs-identifier hs-var hs-var">extra_scope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Targets -&gt; Scope GPU
forall rep. DistRep rep =&gt; Targets -&gt; Scope rep
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#targetsScope"><span class="hs-identifier hs-var">targetsScope</span></a></span><span> </span><span class="annot"><span class="annottext">(Targets -&gt; Scope GPU) -&gt; Targets -&gt; Scope GPU
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DistAcc GPU -&gt; Targets
forall rep. DistAcc rep -&gt; Targets
</span><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#distTargets"><span class="hs-identifier hs-var hs-var">distTargets</span></a></span><span> </span><span class="annot"><span class="annottext">DistAcc GPU
</span><a href="#local-6989586621684422397"><span class="hs-identifier hs-var">acc'</span></a></span><span>
</span><span id="line-886"></span><span>
</span><span id="line-887"></span><span>      </span><span id="local-6989586621684422392"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684422392"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DistribM (Stms GPU) -&gt; DistNestT GPU DistribM (Stms GPU)
forall rep (m :: * -&gt; *) a.
(LocalScope rep m, DistRep rep) =&gt;
m a -&gt; DistNestT rep m a
</span><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#liftInner"><span class="hs-identifier hs-var">liftInner</span></a></span><span> </span><span class="annot"><span class="annottext">(DistribM (Stms GPU) -&gt; DistNestT GPU DistribM (Stms GPU))
-&gt; DistribM (Stms GPU) -&gt; DistNestT GPU DistribM (Stms GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-888"></span><span>        </span><span class="annot"><span class="annottext">Scope GPU -&gt; DistribM (Stms GPU) -&gt; DistribM (Stms GPU)
forall rep (m :: * -&gt; *) a.
LocalScope rep m =&gt;
Scope rep -&gt; m a -&gt; m a
</span><a href="Futhark.IR.Prop.Scope.html#localScope"><span class="hs-identifier hs-var">localScope</span></a></span><span> </span><span class="annot"><span class="annottext">Scope GPU
</span><a href="#local-6989586621684422394"><span class="hs-identifier hs-var">extra_scope</span></a></span><span> </span><span class="annot"><span class="annottext">(DistribM (Stms GPU) -&gt; DistribM (Stms GPU))
-&gt; DistribM (Stms GPU) -&gt; DistribM (Stms GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-889"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684422391"><span class="annot"><span class="annottext">maploop' :: MapLoop
</span><a href="#local-6989586621684422391"><span class="hs-identifier hs-var hs-var">maploop'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Pat SOACS -&gt; StmAux () -&gt; SubExp -&gt; Lambda -&gt; [VName] -&gt; MapLoop
</span><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#MapLoop"><span class="hs-identifier hs-var">MapLoop</span></a></span><span> </span><span class="annot"><span class="annottext">Pat SOACS
</span><a href="#local-6989586621684422423"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux ()
</span><a href="#local-6989586621684422422"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422421"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422420"><span class="hs-identifier hs-var">lam</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684422419"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-890"></span><span>
</span><span id="line-891"></span><span>              </span><span id="local-6989586621684422390"><span class="annot"><span class="annottext">exploitInnerParallelism :: KernelPath -&gt; DistribM (Stms GPU)
</span><a href="#local-6989586621684422390"><span class="hs-identifier hs-var hs-var">exploitInnerParallelism</span></a></span></span><span> </span><span id="local-6989586621684422389"><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422389"><span class="hs-identifier hs-var">path'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-892"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684422388"><span class="annot"><span class="annottext">dist_env' :: DistEnv GPU DistribM
</span><a href="#local-6989586621684422388"><span class="hs-identifier hs-var hs-var">dist_env'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-893"></span><span>                      </span><span class="annot"><span class="annottext">DistEnv GPU DistribM
</span><a href="#local-6989586621684422396"><span class="hs-identifier hs-var">dist_env</span></a></span><span>
</span><span id="line-894"></span><span>                        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">distOnTopLevelStms :: Stms SOACS -&gt; DistNestT GPU DistribM (Stms GPU)
</span><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#distOnTopLevelStms"><span class="hs-identifier hs-var">distOnTopLevelStms</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">KernelPath -&gt; Stms SOACS -&gt; DistNestT GPU DistribM (Stms GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#onTopLevelStms"><span class="hs-identifier hs-var">onTopLevelStms</span></a></span><span> </span><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422389"><span class="hs-identifier hs-var">path'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-895"></span><span>                          </span><span class="annot"><span class="annottext">distOnInnerMap :: MapLoop -&gt; DistAcc GPU -&gt; DistNestT GPU DistribM (DistAcc GPU)
</span><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#distOnInnerMap"><span class="hs-identifier hs-var">distOnInnerMap</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">KernelPath
-&gt; MapLoop -&gt; DistAcc GPU -&gt; DistNestT GPU DistribM (DistAcc GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#onInnerMap"><span class="hs-identifier hs-var">onInnerMap</span></a></span><span> </span><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422389"><span class="hs-identifier hs-var">path'</span></a></span><span>
</span><span id="line-896"></span><span>                        </span><span class="hs-special">}</span><span>
</span><span id="line-897"></span><span>                </span><span class="annot"><span class="annottext">DistEnv GPU DistribM
-&gt; DistNestT GPU DistribM (DistAcc GPU) -&gt; DistribM (Stms GPU)
forall (m :: * -&gt; *) rep.
(MonadLogger m, DistRep rep) =&gt;
DistEnv rep m -&gt; DistNestT rep m (DistAcc rep) -&gt; m (Stms rep)
</span><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#runDistNestT"><span class="hs-identifier hs-var">runDistNestT</span></a></span><span> </span><span class="annot"><span class="annottext">DistEnv GPU DistribM
</span><a href="#local-6989586621684422388"><span class="hs-identifier hs-var">dist_env'</span></a></span><span> </span><span class="annot"><span class="annottext">(DistNestT GPU DistribM (DistAcc GPU) -&gt; DistribM (Stms GPU))
-&gt; DistNestT GPU DistribM (DistAcc GPU) -&gt; DistribM (Stms GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-898"></span><span>                  </span><span class="annot"><span class="annottext">KernelNest
-&gt; DistNestT GPU DistribM (DistAcc GPU)
-&gt; DistNestT GPU DistribM (DistAcc GPU)
forall (m :: * -&gt; *) rep a.
(Monad m, DistRep rep) =&gt;
KernelNest -&gt; DistNestT rep m a -&gt; DistNestT rep m a
</span><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#inNesting"><span class="hs-identifier hs-var">inNesting</span></a></span><span> </span><span class="annot"><span class="annottext">KernelNest
</span><a href="#local-6989586621684422398"><span class="hs-identifier hs-var">nest</span></a></span><span> </span><span class="annot"><span class="annottext">(DistNestT GPU DistribM (DistAcc GPU)
 -&gt; DistNestT GPU DistribM (DistAcc GPU))
-&gt; DistNestT GPU DistribM (DistAcc GPU)
-&gt; DistNestT GPU DistribM (DistAcc GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-899"></span><span>                    </span><span class="annot"><span class="annottext">Scope GPU
-&gt; DistNestT GPU DistribM (DistAcc GPU)
-&gt; DistNestT GPU DistribM (DistAcc GPU)
forall rep (m :: * -&gt; *) a.
LocalScope rep m =&gt;
Scope rep -&gt; m a -&gt; m a
</span><a href="Futhark.IR.Prop.Scope.html#localScope"><span class="hs-identifier hs-var">localScope</span></a></span><span> </span><span class="annot"><span class="annottext">Scope GPU
</span><a href="#local-6989586621684422394"><span class="hs-identifier hs-var">extra_scope</span></a></span><span> </span><span class="annot"><span class="annottext">(DistNestT GPU DistribM (DistAcc GPU)
 -&gt; DistNestT GPU DistribM (DistAcc GPU))
-&gt; DistNestT GPU DistribM (DistAcc GPU)
-&gt; DistNestT GPU DistribM (DistAcc GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-900"></span><span>                      </span><span class="annot"><span class="annottext">DistAcc GPU -&gt; DistAcc GPU
forall {rep}. DistAcc rep -&gt; DistAcc rep
</span><a href="#local-6989586621684422401"><span class="hs-identifier hs-var">discardTargets</span></a></span><span> </span><span class="annot"><span class="annottext">(DistAcc GPU -&gt; DistAcc GPU)
-&gt; DistNestT GPU DistribM (DistAcc GPU)
-&gt; DistNestT GPU DistribM (DistAcc GPU)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">MapLoop -&gt; DistAcc GPU -&gt; DistNestT GPU DistribM (DistAcc GPU)
forall (m :: * -&gt; *) rep.
(MonadFreshNames m, LocalScope rep m, DistRep rep) =&gt;
MapLoop -&gt; DistAcc rep -&gt; DistNestT rep m (DistAcc rep)
</span><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#distributeMap"><span class="hs-identifier hs-var">distributeMap</span></a></span><span> </span><span class="annot"><span class="annottext">MapLoop
</span><a href="#local-6989586621684422391"><span class="hs-identifier hs-var">maploop'</span></a></span><span> </span><span class="annot"><span class="annottext">DistAcc GPU
</span><a href="#local-6989586621684422418"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">distStms :: Stms GPU
</span><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#distStms"><span class="hs-identifier hs-var">distStms</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stms GPU
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">}</span><span>
</span><span id="line-901"></span><span>
</span><span id="line-902"></span><span>          </span><span class="hs-comment">-- Normally the permutation is for the output pattern, but</span><span>
</span><span id="line-903"></span><span>          </span><span class="hs-comment">-- we can't really change that, so we change the result</span><span>
</span><span id="line-904"></span><span>          </span><span class="hs-comment">-- order instead.</span><span>
</span><span id="line-905"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684422386"><span class="annot"><span class="annottext">lam_res' :: Result
</span><a href="#local-6989586621684422386"><span class="hs-identifier hs-var hs-var">lam_res'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-906"></span><span>                </span><span class="annot"><span class="annottext">[Int] -&gt; Result -&gt; Result
forall a. [Int] -&gt; [a] -&gt; [a]
</span><a href="Futhark.IR.Prop.Rearrange.html#rearrangeShape"><span class="hs-identifier hs-var">rearrangeShape</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Int] -&gt; [Int]
</span><a href="Futhark.IR.Prop.Rearrange.html#rearrangeInverse"><span class="hs-identifier hs-var">rearrangeInverse</span></a></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684422399"><span class="hs-identifier hs-var">perm</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Result -&gt; Result) -&gt; Result -&gt; Result
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-907"></span><span>                  </span><span class="annot"><span class="annottext">BodyT SOACS -&gt; Result
forall rep. BodyT rep -&gt; Result
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var hs-var">bodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">(BodyT SOACS -&gt; Result) -&gt; BodyT SOACS -&gt; Result
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda -&gt; BodyT SOACS
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422420"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-908"></span><span>              </span><span id="local-6989586621684422383"><span class="annot"><span class="annottext">lam' :: Lambda
</span><a href="#local-6989586621684422383"><span class="hs-identifier hs-var hs-var">lam'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422420"><span class="hs-identifier hs-var">lam</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">lambdaBody :: BodyT SOACS
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var">lambdaBody</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda -&gt; BodyT SOACS
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422420"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">bodyResult :: Result
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var">bodyResult</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684422386"><span class="hs-identifier hs-var">lam_res'</span></a></span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><span id="line-909"></span><span>              </span><span id="local-6989586621684422382"><span class="annot"><span class="annottext">map_nesting :: LoopNesting
</span><a href="#local-6989586621684422382"><span class="hs-identifier hs-var hs-var">map_nesting</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatT Type
-&gt; StmAux () -&gt; SubExp -&gt; [(Param Type, VName)] -&gt; LoopNesting
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#MapNesting"><span class="hs-identifier hs-var">MapNesting</span></a></span><span> </span><span class="annot"><span class="annottext">PatT Type
Pat SOACS
</span><a href="#local-6989586621684422423"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux ()
</span><a href="#local-6989586621684422422"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684422421"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">([(Param Type, VName)] -&gt; LoopNesting)
-&gt; [(Param Type, VName)] -&gt; LoopNesting
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Param Type] -&gt; [VName] -&gt; [(Param Type, VName)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda -&gt; [LParam SOACS]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422420"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684422419"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-910"></span><span>              </span><span id="local-6989586621684422381"><span class="annot"><span class="annottext">nest' :: KernelNest
</span><a href="#local-6989586621684422381"><span class="hs-identifier hs-var hs-var">nest'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Target -&gt; LoopNesting -&gt; KernelNest -&gt; KernelNest
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#pushInnerKernelNesting"><span class="hs-identifier hs-var">pushInnerKernelNesting</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatT Type
Pat SOACS
</span><a href="#local-6989586621684422423"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684422386"><span class="hs-identifier hs-var">lam_res'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LoopNesting
</span><a href="#local-6989586621684422382"><span class="hs-identifier hs-var">map_nesting</span></a></span><span> </span><span class="annot"><span class="annottext">KernelNest
</span><a href="#local-6989586621684422398"><span class="hs-identifier hs-var">nest</span></a></span><span>
</span><span id="line-911"></span><span>
</span><span id="line-912"></span><span>          </span><span class="hs-comment">-- XXX: we do not construct a new KernelPath when</span><span>
</span><span id="line-913"></span><span>          </span><span class="hs-comment">-- sequentialising.  This is only OK as long as further</span><span>
</span><span id="line-914"></span><span>          </span><span class="hs-comment">-- versioning does not take place down that branch (it currently</span><span>
</span><span id="line-915"></span><span>          </span><span class="hs-comment">-- does not).</span><span>
</span><span id="line-916"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621684422379"><span class="annot"><span class="annottext">Stm GPU
</span><a href="#local-6989586621684422379"><span class="hs-identifier hs-var">sequentialised_kernel</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684422378"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684422378"><span class="hs-identifier hs-var">nestw_stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Scope GPU
-&gt; DistribM (Stm GPU, Stms GPU) -&gt; DistribM (Stm GPU, Stms GPU)
forall rep (m :: * -&gt; *) a.
LocalScope rep m =&gt;
Scope rep -&gt; m a -&gt; m a
</span><a href="Futhark.IR.Prop.Scope.html#localScope"><span class="hs-identifier hs-var">localScope</span></a></span><span> </span><span class="annot"><span class="annottext">Scope GPU
</span><a href="#local-6989586621684422394"><span class="hs-identifier hs-var">extra_scope</span></a></span><span> </span><span class="annot"><span class="annottext">(DistribM (Stm GPU, Stms GPU) -&gt; DistribM (Stm GPU, Stms GPU))
-&gt; DistribM (Stm GPU, Stms GPU) -&gt; DistribM (Stm GPU, Stms GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-917"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684422377"><span class="annot"><span class="annottext">sequentialised_lam :: Lambda GPU
</span><a href="#local-6989586621684422377"><span class="hs-identifier hs-var hs-var">sequentialised_lam</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Lambda -&gt; Lambda GPU
</span><a href="Futhark.Pass.ExtractKernels.ToGPU.html#soacsLambdaToGPU"><span class="hs-identifier hs-var">soacsLambdaToGPU</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422383"><span class="hs-identifier hs-var">lam'</span></a></span><span>
</span><span id="line-918"></span><span>            </span><span class="annot"><span class="annottext">MkSegLevel GPU DistribM
-&gt; KernelNest -&gt; Body GPU -&gt; DistribM (Stm GPU, Stms GPU)
forall rep (m :: * -&gt; *).
(DistRep rep, MonadFreshNames m, LocalScope rep m) =&gt;
MkSegLevel rep m -&gt; KernelNest -&gt; Body rep -&gt; m (Stm rep, Stms rep)
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#constructKernel"><span class="hs-identifier hs-var">constructKernel</span></a></span><span> </span><span class="annot"><span class="annottext">MkSegLevel GPU DistribM
forall (m :: * -&gt; *). MonadFreshNames m =&gt; MkSegLevel GPU m
</span><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#segThreadCapped"><span class="hs-identifier hs-var">segThreadCapped</span></a></span><span> </span><span class="annot"><span class="annottext">KernelNest
</span><a href="#local-6989586621684422381"><span class="hs-identifier hs-var">nest'</span></a></span><span> </span><span class="annot"><span class="annottext">(Body GPU -&gt; DistribM (Stm GPU, Stms GPU))
-&gt; Body GPU -&gt; DistribM (Stm GPU, Stms GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda GPU -&gt; Body GPU
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPU
</span><a href="#local-6989586621684422377"><span class="hs-identifier hs-var">sequentialised_lam</span></a></span><span>
</span><span id="line-919"></span><span>
</span><span id="line-920"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684422375"><span class="annot"><span class="annottext">outer_pat :: PatT Type
</span><a href="#local-6989586621684422375"><span class="hs-identifier hs-var hs-var">outer_pat</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LoopNesting -&gt; PatT Type
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#loopNestingPat"><span class="hs-identifier hs-var hs-var">loopNestingPat</span></a></span><span> </span><span class="annot"><span class="annottext">(LoopNesting -&gt; PatT Type) -&gt; LoopNesting -&gt; PatT Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KernelNest -&gt; LoopNesting
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">KernelNest
</span><a href="#local-6989586621684422398"><span class="hs-identifier hs-var">nest</span></a></span><span>
</span><span id="line-921"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684422378"><span class="hs-identifier hs-var">nestw_stms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPU -&gt; Stms GPU -&gt; Stms GPU
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span class="hs-special">)</span><span>
</span><span id="line-922"></span><span>            </span><span class="annot"><span class="annottext">(Stms GPU -&gt; Stms GPU)
-&gt; DistribM (Stms GPU) -&gt; DistribM (Stms GPU)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">KernelNest
-&gt; KernelPath
-&gt; (KernelPath -&gt; DistribM (Stms GPU))
-&gt; (KernelPath -&gt; DistribM (Stms GPU))
-&gt; Pat SOACS
-&gt; Lambda
-&gt; DistribM (Stms GPU)
</span><a href="Futhark.Pass.ExtractKernels.html#onMap%27"><span class="hs-identifier hs-var">onMap'</span></a></span><span>
</span><span id="line-923"></span><span>              </span><span class="annot"><span class="annottext">KernelNest
</span><a href="#local-6989586621684422381"><span class="hs-identifier hs-var">nest'</span></a></span><span>
</span><span id="line-924"></span><span>              </span><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684422425"><span class="hs-identifier hs-var">path</span></a></span><span>
</span><span id="line-925"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DistribM (Stms GPU) -&gt; KernelPath -&gt; DistribM (Stms GPU)
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">(DistribM (Stms GPU) -&gt; KernelPath -&gt; DistribM (Stms GPU))
-&gt; DistribM (Stms GPU) -&gt; KernelPath -&gt; DistribM (Stms GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stms GPU -&gt; DistribM (Stms GPU)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Stms GPU -&gt; DistribM (Stms GPU))
-&gt; Stms GPU -&gt; DistribM (Stms GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stm GPU -&gt; Stms GPU
forall rep. Stm rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#oneStm"><span class="hs-identifier hs-var">oneStm</span></a></span><span> </span><span class="annot"><span class="annottext">Stm GPU
</span><a href="#local-6989586621684422379"><span class="hs-identifier hs-var">sequentialised_kernel</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-926"></span><span>              </span><span class="annot"><span class="annottext">KernelPath -&gt; DistribM (Stms GPU)
</span><a href="#local-6989586621684422390"><span class="hs-identifier hs-var">exploitInnerParallelism</span></a></span><span>
</span><span id="line-927"></span><span>              </span><span class="annot"><span class="annottext">PatT Type
Pat SOACS
</span><a href="#local-6989586621684422375"><span class="hs-identifier hs-var">outer_pat</span></a></span><span>
</span><span id="line-928"></span><span>              </span><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684422383"><span class="hs-identifier hs-var">lam'</span></a></span><span>
</span><span id="line-929"></span><span>
</span><span id="line-930"></span><span>      </span><span class="annot"><span class="annottext">Stms GPU -&gt; DistNestT GPU DistribM ()
forall (m :: * -&gt; *) rep. Monad m =&gt; Stms rep -&gt; DistNestT rep m ()
</span><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#postStm"><span class="hs-identifier hs-var">postStm</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684422392"><span class="hs-identifier hs-var">stms</span></a></span><span>
</span><span id="line-931"></span><span>      </span><span class="annot"><span class="annottext">DistAcc GPU -&gt; DistNestT GPU DistribM (DistAcc GPU)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">DistAcc GPU
</span><a href="#local-6989586621684422397"><span class="hs-identifier hs-var">acc'</span></a></span><span>
</span><span id="line-932"></span></pre></body></html>