<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-4"></span><span>
</span><span id="line-5"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Futhark.Optimise.Fusion.LoopKernel</span><span>
</span><span id="line-6"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#FusedKer"><span class="hs-identifier">FusedKer</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-7"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#newKernel"><span class="hs-identifier">newKernel</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-8"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#inputs"><span class="hs-identifier">inputs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-9"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#setInputs"><span class="hs-identifier">setInputs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-10"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#arrInputs"><span class="hs-identifier">arrInputs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-11"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#transformOutput"><span class="hs-identifier">transformOutput</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-12"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#attemptFusion"><span class="hs-identifier">attemptFusion</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-13"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#SOAC"><span class="hs-identifier">SOAC</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-14"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#MapNest"><span class="hs-identifier">MapNest</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-15"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-16"></span><span class="hs-keyword">where</span><span>
</span><span id="line-17"></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Applicative</span></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Arrow</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">first</span></span><span class="hs-special">)</span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Reader</span></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.State</span></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">find</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">tails</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-operator">(\\)</span></span><span class="hs-special">)</span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map.Strict</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S</span></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.Analysis.HORep.MapNest.html"><span class="hs-identifier">Futhark.Analysis.HORep.MapNest</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">MapNest</span></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html"><span class="hs-identifier">Futhark.Analysis.HORep.SOAC</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">SOAC</span></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Construct.html"><span class="hs-identifier">Futhark.Construct</span></a></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html"><span class="hs-identifier">Futhark.IR.SOACS</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#SOAC"><span class="hs-identifier">SOAC</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html"><span class="hs-identifier">Futhark.IR.SOACS</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Futhark</span></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Optimise.Fusion.Composing.html"><span class="hs-identifier">Futhark.Optimise.Fusion.Composing</span></a></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.ISRWIM.html"><span class="hs-identifier">Futhark.Pass.ExtractKernels.ISRWIM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExtractKernels.ISRWIM.html#rwimPossible"><span class="hs-identifier">rwimPossible</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Transform.Rename.html"><span class="hs-identifier">Futhark.Transform.Rename</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Transform.Rename.html#renameLambda"><span class="hs-identifier">renameLambda</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Transform.Substitute.html"><span class="hs-identifier">Futhark.Transform.Substitute</span></a></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Util.html"><span class="hs-identifier">Futhark.Util</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Util.html#splitAt3"><span class="hs-identifier">splitAt3</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-37"></span><span>
</span><span id="line-38"></span><span class="hs-keyword">newtype</span><span> </span><span id="TryFusion"><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#TryFusion"><span class="hs-identifier hs-var">TryFusion</span></a></span></span><span> </span><span id="local-6989586621684455619"><span class="annot"><a href="#local-6989586621684455619"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-39"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="TryFusion"><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#TryFusion"><span class="hs-identifier hs-var">TryFusion</span></a></span></span><span>
</span><span id="line-40"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ReaderT</span></span><span>
</span><span id="line-41"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="Futhark.FreshNames.html#VNameSource"><span class="hs-identifier hs-type">VNameSource</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span>          </span><span class="annot"><a href="#local-6989586621684455619"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-44"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span>  </span><span class="hs-keyword">deriving</span><span>
</span><span id="line-46"></span><span>    </span><span class="hs-special">(</span><span> </span><span id="local-6989586621684455610"><span id="local-6989586621684455616"><span class="annot"><span class="annottext">(forall a b. (a -&gt; b) -&gt; TryFusion a -&gt; TryFusion b)
-&gt; (forall a b. a -&gt; TryFusion b -&gt; TryFusion a)
-&gt; Functor TryFusion
forall a b. a -&gt; TryFusion b -&gt; TryFusion a
forall a b. (a -&gt; b) -&gt; TryFusion a -&gt; TryFusion b
forall (f :: * -&gt; *).
(forall a b. (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b. a -&gt; f b -&gt; f a) -&gt; Functor f
&lt;$ :: forall a b. a -&gt; TryFusion b -&gt; TryFusion a
$c&lt;$ :: forall a b. a -&gt; TryFusion b -&gt; TryFusion a
fmap :: forall a b. (a -&gt; b) -&gt; TryFusion a -&gt; TryFusion b
$cfmap :: forall a b. (a -&gt; b) -&gt; TryFusion a -&gt; TryFusion b
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Functor</span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-47"></span><span>      </span><span id="local-6989586621684455576"><span id="local-6989586621684455581"><span id="local-6989586621684455586"><span id="local-6989586621684455591"><span id="local-6989586621684455597"><span class="annot"><span class="annottext">Functor TryFusion
Functor TryFusion
-&gt; (forall a. a -&gt; TryFusion a)
-&gt; (forall a b. TryFusion (a -&gt; b) -&gt; TryFusion a -&gt; TryFusion b)
-&gt; (forall a b c.
    (a -&gt; b -&gt; c) -&gt; TryFusion a -&gt; TryFusion b -&gt; TryFusion c)
-&gt; (forall a b. TryFusion a -&gt; TryFusion b -&gt; TryFusion b)
-&gt; (forall a b. TryFusion a -&gt; TryFusion b -&gt; TryFusion a)
-&gt; Applicative TryFusion
forall a. a -&gt; TryFusion a
forall a b. TryFusion a -&gt; TryFusion b -&gt; TryFusion a
forall a b. TryFusion a -&gt; TryFusion b -&gt; TryFusion b
forall a b. TryFusion (a -&gt; b) -&gt; TryFusion a -&gt; TryFusion b
forall a b c.
(a -&gt; b -&gt; c) -&gt; TryFusion a -&gt; TryFusion b -&gt; TryFusion c
forall (f :: * -&gt; *).
Functor f
-&gt; (forall a. a -&gt; f a)
-&gt; (forall a b. f (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b c. (a -&gt; b -&gt; c) -&gt; f a -&gt; f b -&gt; f c)
-&gt; (forall a b. f a -&gt; f b -&gt; f b)
-&gt; (forall a b. f a -&gt; f b -&gt; f a)
-&gt; Applicative f
&lt;* :: forall a b. TryFusion a -&gt; TryFusion b -&gt; TryFusion a
$c&lt;* :: forall a b. TryFusion a -&gt; TryFusion b -&gt; TryFusion a
*&gt; :: forall a b. TryFusion a -&gt; TryFusion b -&gt; TryFusion b
$c*&gt; :: forall a b. TryFusion a -&gt; TryFusion b -&gt; TryFusion b
liftA2 :: forall a b c.
(a -&gt; b -&gt; c) -&gt; TryFusion a -&gt; TryFusion b -&gt; TryFusion c
$cliftA2 :: forall a b c.
(a -&gt; b -&gt; c) -&gt; TryFusion a -&gt; TryFusion b -&gt; TryFusion c
&lt;*&gt; :: forall a b. TryFusion (a -&gt; b) -&gt; TryFusion a -&gt; TryFusion b
$c&lt;*&gt; :: forall a b. TryFusion (a -&gt; b) -&gt; TryFusion a -&gt; TryFusion b
pure :: forall a. a -&gt; TryFusion a
$cpure :: forall a. a -&gt; TryFusion a
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Applicative</span></span></span></span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-48"></span><span>      </span><span id="local-6989586621684455546"><span id="local-6989586621684455551"><span id="local-6989586621684455556"><span id="local-6989586621684455562"><span class="annot"><span class="annottext">Applicative TryFusion
Applicative TryFusion
-&gt; (forall a. TryFusion a)
-&gt; (forall a. TryFusion a -&gt; TryFusion a -&gt; TryFusion a)
-&gt; (forall a. TryFusion a -&gt; TryFusion [a])
-&gt; (forall a. TryFusion a -&gt; TryFusion [a])
-&gt; Alternative TryFusion
forall a. TryFusion a
forall a. TryFusion a -&gt; TryFusion [a]
forall a. TryFusion a -&gt; TryFusion a -&gt; TryFusion a
forall (f :: * -&gt; *).
Applicative f
-&gt; (forall a. f a)
-&gt; (forall a. f a -&gt; f a -&gt; f a)
-&gt; (forall a. f a -&gt; f [a])
-&gt; (forall a. f a -&gt; f [a])
-&gt; Alternative f
many :: forall a. TryFusion a -&gt; TryFusion [a]
$cmany :: forall a. TryFusion a -&gt; TryFusion [a]
some :: forall a. TryFusion a -&gt; TryFusion [a]
$csome :: forall a. TryFusion a -&gt; TryFusion [a]
&lt;|&gt; :: forall a. TryFusion a -&gt; TryFusion a -&gt; TryFusion a
$c&lt;|&gt; :: forall a. TryFusion a -&gt; TryFusion a -&gt; TryFusion a
empty :: forall a. TryFusion a
$cempty :: forall a. TryFusion a
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Alternative</span></span></span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-49"></span><span>      </span><span id="local-6989586621684455517"><span id="local-6989586621684455522"><span id="local-6989586621684455528"><span class="annot"><span class="annottext">Applicative TryFusion
Applicative TryFusion
-&gt; (forall a b. TryFusion a -&gt; (a -&gt; TryFusion b) -&gt; TryFusion b)
-&gt; (forall a b. TryFusion a -&gt; TryFusion b -&gt; TryFusion b)
-&gt; (forall a. a -&gt; TryFusion a)
-&gt; Monad TryFusion
forall a. a -&gt; TryFusion a
forall a b. TryFusion a -&gt; TryFusion b -&gt; TryFusion b
forall a b. TryFusion a -&gt; (a -&gt; TryFusion b) -&gt; TryFusion b
forall (m :: * -&gt; *).
Applicative m
-&gt; (forall a b. m a -&gt; (a -&gt; m b) -&gt; m b)
-&gt; (forall a b. m a -&gt; m b -&gt; m b)
-&gt; (forall a. a -&gt; m a)
-&gt; Monad m
return :: forall a. a -&gt; TryFusion a
$creturn :: forall a. a -&gt; TryFusion a
&gt;&gt; :: forall a b. TryFusion a -&gt; TryFusion b -&gt; TryFusion b
$c&gt;&gt; :: forall a b. TryFusion a -&gt; TryFusion b -&gt; TryFusion b
&gt;&gt;= :: forall a b. TryFusion a -&gt; (a -&gt; TryFusion b) -&gt; TryFusion b
$c&gt;&gt;= :: forall a b. TryFusion a -&gt; (a -&gt; TryFusion b) -&gt; TryFusion b
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Monad</span></span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-50"></span><span>      </span><span id="local-6989586621684455508"><span class="annot"><span class="annottext">Monad TryFusion
Monad TryFusion
-&gt; (forall a. String -&gt; TryFusion a) -&gt; MonadFail TryFusion
forall a. String -&gt; TryFusion a
forall (m :: * -&gt; *).
Monad m -&gt; (forall a. String -&gt; m a) -&gt; MonadFail m
fail :: forall a. String -&gt; TryFusion a
$cfail :: forall a. String -&gt; TryFusion a
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var">MonadFail</span></span></span><span class="hs-special">,</span><span>
</span><span id="line-51"></span><span>      </span><span id="local-6989586621684455488"><span id="local-6989586621684455494"><span class="annot"><span class="annottext">Monad TryFusion
Applicative TryFusion
TryFusion VNameSource
Applicative TryFusion
-&gt; Monad TryFusion
-&gt; TryFusion VNameSource
-&gt; (VNameSource -&gt; TryFusion ())
-&gt; MonadFreshNames TryFusion
VNameSource -&gt; TryFusion ()
forall (m :: * -&gt; *).
Applicative m
-&gt; Monad m
-&gt; m VNameSource
-&gt; (VNameSource -&gt; m ())
-&gt; MonadFreshNames m
putNameSource :: VNameSource -&gt; TryFusion ()
$cputNameSource :: VNameSource -&gt; TryFusion ()
getNameSource :: TryFusion VNameSource
$cgetNameSource :: TryFusion VNameSource
</span><a href="Futhark.MonadFreshNames.html#C%3AMonadFreshNames"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">MonadFreshNames</span></a></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-52"></span><span>      </span><span id="local-6989586621684455455"><span id="local-6989586621684455461"><span id="local-6989586621684455467"><span id="local-6989586621684455474"><span class="annot"><a href="Futhark.IR.Prop.Scope.html#HasScope"><span class="hs-identifier hs-type">HasScope</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span></span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-53"></span><span>      </span><span id="local-6989586621684455440"><span class="annot"><a href="Futhark.IR.Prop.Scope.html#LocalScope"><span class="hs-identifier hs-type">LocalScope</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span></span><span>
</span><span id="line-54"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-55"></span><span>
</span><span id="line-56"></span><span id="local-6989586621684456268"><span id="local-6989586621684456269"><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#tryFusion"><span class="hs-identifier hs-type">tryFusion</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-57"></span><span>  </span><span class="annot"><a href="Futhark.MonadFreshNames.html#MonadFreshNames"><span class="hs-identifier hs-type">MonadFreshNames</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684456269"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-58"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#TryFusion"><span class="hs-identifier hs-type">TryFusion</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684456268"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-59"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-60"></span><span>  </span><span class="annot"><a href="#local-6989586621684456269"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621684456268"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-61"></span><span id="tryFusion"><span class="annot"><span class="annottext">tryFusion :: forall (m :: * -&gt; *) a.
MonadFreshNames m =&gt;
TryFusion a -&gt; Scope SOACS -&gt; m (Maybe a)
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#tryFusion"><span class="hs-identifier hs-var hs-var">tryFusion</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#TryFusion"><span class="hs-identifier hs-type">TryFusion</span></a></span><span> </span><span id="local-6989586621684455429"><span class="annot"><span class="annottext">ReaderT (Scope SOACS) (StateT VNameSource Maybe) a
</span><a href="#local-6989586621684455429"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684455428"><span class="annot"><span class="annottext">Scope SOACS
</span><a href="#local-6989586621684455428"><span class="hs-identifier hs-var">types</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VNameSource -&gt; (Maybe a, VNameSource)) -&gt; m (Maybe a)
forall (m :: * -&gt; *) a.
MonadFreshNames m =&gt;
(VNameSource -&gt; (a, VNameSource)) -&gt; m a
</span><a href="Futhark.MonadFreshNames.html#modifyNameSource"><span class="hs-identifier hs-var">modifyNameSource</span></a></span><span> </span><span class="annot"><span class="annottext">((VNameSource -&gt; (Maybe a, VNameSource)) -&gt; m (Maybe a))
-&gt; (VNameSource -&gt; (Maybe a, VNameSource)) -&gt; m (Maybe a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684455426"><span class="annot"><span class="annottext">VNameSource
</span><a href="#local-6989586621684455426"><span class="hs-identifier hs-var">src</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-62"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">StateT VNameSource Maybe a -&gt; VNameSource -&gt; Maybe (a, VNameSource)
forall s (m :: * -&gt; *) a. StateT s m a -&gt; s -&gt; m (a, s)
</span><span class="hs-identifier hs-var hs-var">runStateT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ReaderT (Scope SOACS) (StateT VNameSource Maybe) a
-&gt; Scope SOACS -&gt; StateT VNameSource Maybe a
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var hs-var">runReaderT</span></span><span> </span><span class="annot"><span class="annottext">ReaderT (Scope SOACS) (StateT VNameSource Maybe) a
</span><a href="#local-6989586621684455429"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">Scope SOACS
</span><a href="#local-6989586621684455428"><span class="hs-identifier hs-var">types</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VNameSource
</span><a href="#local-6989586621684455426"><span class="hs-identifier hs-var">src</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-63"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684455423"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684455423"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684455422"><span class="annot"><span class="annottext">VNameSource
</span><a href="#local-6989586621684455422"><span class="hs-identifier hs-var">src'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684455423"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VNameSource
</span><a href="#local-6989586621684455422"><span class="hs-identifier hs-var">src'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-64"></span><span>    </span><span class="annot"><span class="annottext">Maybe (a, VNameSource)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VNameSource
</span><a href="#local-6989586621684455426"><span class="hs-identifier hs-var">src</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span>
</span><span id="line-66"></span><span id="local-6989586621684456253"><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#liftMaybe"><span class="hs-identifier hs-type">liftMaybe</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621684456253"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#TryFusion"><span class="hs-identifier hs-type">TryFusion</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684456253"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-67"></span><span id="liftMaybe"><span class="annot"><span class="annottext">liftMaybe :: forall a. Maybe a -&gt; TryFusion a
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#liftMaybe"><span class="hs-identifier hs-var hs-var">liftMaybe</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; TryFusion a
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Nothing&quot;</span></span><span>
</span><span id="line-68"></span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#liftMaybe"><span class="hs-identifier hs-var">liftMaybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684455418"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684455418"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; TryFusion a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684455418"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-69"></span><span>
</span><span id="line-70"></span><span class="hs-keyword">type</span><span> </span><span id="SOAC"><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#SOAC"><span class="hs-identifier hs-var">SOAC</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#SOAC"><span class="hs-identifier hs-type">SOAC.SOAC</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span><span>
</span><span id="line-71"></span><span>
</span><span id="line-72"></span><span class="hs-keyword">type</span><span> </span><span id="MapNest"><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#MapNest"><span class="hs-identifier hs-var">MapNest</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Futhark.Analysis.HORep.MapNest.html#MapNest"><span class="hs-identifier hs-type">MapNest.MapNest</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span><span>
</span><span id="line-73"></span><span>
</span><span id="line-74"></span><span class="hs-comment">-- XXX: This function is very gross.</span><span>
</span><span id="line-75"></span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#transformOutput"><span class="hs-identifier hs-type">transformOutput</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-76"></span><span>  </span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#ArrayTransforms"><span class="hs-identifier hs-type">SOAC.ArrayTransforms</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-77"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-78"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Ident"><span class="hs-identifier hs-type">Ident</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-79"></span><span>  </span><span class="annot"><a href="Futhark.Builder.html#Builder"><span class="hs-identifier hs-type">Builder</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-80"></span><span id="transformOutput"><span class="annot"><span class="annottext">transformOutput :: ArrayTransforms -&gt; [VName] -&gt; [Ident] -&gt; Builder SOACS ()
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#transformOutput"><span class="hs-identifier hs-var hs-var">transformOutput</span></a></span></span><span> </span><span id="local-6989586621684455417"><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684455417"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span id="local-6989586621684455416"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455416"><span class="hs-identifier hs-var">names</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArrayTransforms -&gt; [Ident] -&gt; Builder SOACS ()
</span><a href="#local-6989586621684455415"><span class="hs-identifier hs-var">descend</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684455417"><span class="hs-identifier hs-var">ts</span></a></span><span>
</span><span id="line-81"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-82"></span><span>    </span><span id="local-6989586621684455415"><span class="annot"><span class="annottext">descend :: ArrayTransforms -&gt; [Ident] -&gt; Builder SOACS ()
</span><a href="#local-6989586621684455415"><span class="hs-identifier hs-var hs-var">descend</span></a></span></span><span> </span><span id="local-6989586621684455414"><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684455414"><span class="hs-identifier hs-var">ts'</span></a></span></span><span> </span><span id="local-6989586621684455413"><span class="annot"><span class="annottext">[Ident]
</span><a href="#local-6989586621684455413"><span class="hs-identifier hs-var">validents</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-83"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ArrayTransforms -&gt; ViewF
</span><a href="Futhark.Analysis.HORep.SOAC.html#viewf"><span class="hs-identifier hs-var">SOAC.viewf</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684455414"><span class="hs-identifier hs-var">ts'</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-84"></span><span>        </span><span class="annot"><span class="annottext">ViewF
</span><a href="Futhark.Analysis.HORep.SOAC.html#EmptyF"><span class="hs-identifier hs-var">SOAC.EmptyF</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-85"></span><span>          </span><span class="annot"><span class="annottext">[(VName, Ident)]
-&gt; ((VName, Ident) -&gt; Builder SOACS ()) -&gt; Builder SOACS ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; [Ident] -&gt; [(VName, Ident)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455416"><span class="hs-identifier hs-var">names</span></a></span><span> </span><span class="annot"><span class="annottext">[Ident]
</span><a href="#local-6989586621684455413"><span class="hs-identifier hs-var">validents</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((VName, Ident) -&gt; Builder SOACS ()) -&gt; Builder SOACS ())
-&gt; ((VName, Ident) -&gt; Builder SOACS ()) -&gt; Builder SOACS ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684455409"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684455409"><span class="hs-identifier hs-var">k</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684455408"><span class="annot"><span class="annottext">Ident
</span><a href="#local-6989586621684455408"><span class="hs-identifier hs-var">valident</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-86"></span><span>            </span><span class="annot"><span class="annottext">[VName]
-&gt; Exp (Rep (BuilderT SOACS (State VNameSource)))
-&gt; Builder SOACS ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[VName] -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBindNames"><span class="hs-identifier hs-var">letBindNames</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684455409"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (BuilderT SOACS (State VNameSource)))
 -&gt; Builder SOACS ())
-&gt; Exp (Rep (BuilderT SOACS (State VNameSource)))
-&gt; Builder SOACS ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT SOACS
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT SOACS) -&gt; BasicOp -&gt; ExpT SOACS
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#SubExp"><span class="hs-identifier hs-var">SubExp</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; BasicOp) -&gt; SubExp -&gt; BasicOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SubExp) -&gt; VName -&gt; SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Ident -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#identName"><span class="hs-identifier hs-var hs-var">identName</span></a></span><span> </span><span class="annot"><span class="annottext">Ident
</span><a href="#local-6989586621684455408"><span class="hs-identifier hs-var">valident</span></a></span><span>
</span><span id="line-87"></span><span>        </span><span id="local-6989586621684455402"><span class="annot"><span class="annottext">ArrayTransform
</span><a href="#local-6989586621684455402"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#%3A%3C"><span class="hs-operator hs-type">SOAC.:&lt;</span></a></span><span> </span><span id="local-6989586621684455400"><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684455400"><span class="hs-identifier hs-var">ts''</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-88"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684455399"><span class="annot"><span class="annottext">[BasicOp]
</span><a href="#local-6989586621684455399"><span class="hs-identifier hs-var">es</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684455398"><span class="annot"><span class="annottext">[Certs]
</span><a href="#local-6989586621684455398"><span class="hs-identifier hs-var">css</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(BasicOp, Certs)] -&gt; ([BasicOp], [Certs])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(BasicOp, Certs)] -&gt; ([BasicOp], [Certs]))
-&gt; [(BasicOp, Certs)] -&gt; ([BasicOp], [Certs])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Ident -&gt; (BasicOp, Certs)) -&gt; [Ident] -&gt; [(BasicOp, Certs)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ArrayTransform -&gt; Ident -&gt; (BasicOp, Certs)
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#applyTransform"><span class="hs-identifier hs-var">applyTransform</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayTransform
</span><a href="#local-6989586621684455402"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Ident]
</span><a href="#local-6989586621684455413"><span class="hs-identifier hs-var">validents</span></a></span><span>
</span><span id="line-89"></span><span>              </span><span id="local-6989586621684455395"><span class="annot"><span class="annottext">mkPat :: Ident -&gt; PatT (TypeBase (ShapeBase SubExp) NoUniqueness)
</span><a href="#local-6989586621684455395"><span class="hs-identifier hs-var hs-var">mkPat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Ident"><span class="hs-identifier hs-type">Ident</span></a></span><span> </span><span id="local-6989586621684455393"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684455393"><span class="hs-identifier hs-var">nm</span></a></span></span><span> </span><span id="local-6989586621684455392"><span class="annot"><span class="annottext">TypeBase (ShapeBase SubExp) NoUniqueness
</span><a href="#local-6989586621684455392"><span class="hs-identifier hs-var">tp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[PatElemT (TypeBase (ShapeBase SubExp) NoUniqueness)]
-&gt; PatT (TypeBase (ShapeBase SubExp) NoUniqueness)
forall dec. [PatElemT dec] -&gt; PatT dec
</span><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-var">Pat</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">VName
-&gt; TypeBase (ShapeBase SubExp) NoUniqueness
-&gt; PatElemT (TypeBase (ShapeBase SubExp) NoUniqueness)
forall dec. VName -&gt; dec -&gt; PatElemT dec
</span><a href="Futhark.IR.Syntax.Core.html#PatElem"><span class="hs-identifier hs-var">PatElem</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684455393"><span class="hs-identifier hs-var">nm</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase (ShapeBase SubExp) NoUniqueness
</span><a href="#local-6989586621684455392"><span class="hs-identifier hs-var">tp</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-90"></span><span>          </span><span id="local-6989586621684455389"><span class="annot"><span class="annottext">[TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="#local-6989586621684455389"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[[TypeBase (ShapeBase SubExp) NoUniqueness]]
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span> </span><span class="annot"><span class="annottext">([[TypeBase (ShapeBase SubExp) NoUniqueness]]
 -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness])
-&gt; BuilderT
     SOACS
     (State VNameSource)
     [[TypeBase (ShapeBase SubExp) NoUniqueness]]
-&gt; BuilderT
     SOACS
     (State VNameSource)
     [TypeBase (ShapeBase SubExp) NoUniqueness]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(BasicOp
 -&gt; BuilderT
      SOACS
      (State VNameSource)
      [TypeBase (ShapeBase SubExp) NoUniqueness])
-&gt; [BasicOp]
-&gt; BuilderT
     SOACS
     (State VNameSource)
     [[TypeBase (ShapeBase SubExp) NoUniqueness]]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">BasicOp
-&gt; BuilderT
     SOACS
     (State VNameSource)
     [TypeBase (ShapeBase SubExp) NoUniqueness]
forall rep (m :: * -&gt; *).
HasScope rep m =&gt;
BasicOp -&gt; m [TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="Futhark.IR.Prop.TypeOf.html#basicOpType"><span class="hs-identifier hs-var">basicOpType</span></a></span><span> </span><span class="annot"><span class="annottext">[BasicOp]
</span><a href="#local-6989586621684455399"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-91"></span><span>          </span><span id="local-6989586621684455384"><span class="annot"><span class="annottext">[Ident]
</span><a href="#local-6989586621684455384"><span class="hs-identifier hs-var">newIds</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(VName, TypeBase (ShapeBase SubExp) NoUniqueness)]
-&gt; ((VName, TypeBase (ShapeBase SubExp) NoUniqueness)
    -&gt; BuilderT SOACS (State VNameSource) Ident)
-&gt; BuilderT SOACS (State VNameSource) [Ident]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName]
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; [(VName, TypeBase (ShapeBase SubExp) NoUniqueness)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455416"><span class="hs-identifier hs-var">names</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="#local-6989586621684455389"><span class="hs-identifier hs-var">opts</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((VName, TypeBase (ShapeBase SubExp) NoUniqueness)
  -&gt; BuilderT SOACS (State VNameSource) Ident)
 -&gt; BuilderT SOACS (State VNameSource) [Ident])
-&gt; ((VName, TypeBase (ShapeBase SubExp) NoUniqueness)
    -&gt; BuilderT SOACS (State VNameSource) Ident)
-&gt; BuilderT SOACS (State VNameSource) [Ident]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684455382"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684455382"><span class="hs-identifier hs-var">k</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684455381"><span class="annot"><span class="annottext">TypeBase (ShapeBase SubExp) NoUniqueness
</span><a href="#local-6989586621684455381"><span class="hs-identifier hs-var">opt</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-92"></span><span>            </span><span class="annot"><span class="annottext">String
-&gt; TypeBase (ShapeBase SubExp) NoUniqueness
-&gt; BuilderT SOACS (State VNameSource) Ident
forall (m :: * -&gt; *).
MonadFreshNames m =&gt;
String -&gt; TypeBase (ShapeBase SubExp) NoUniqueness -&gt; m Ident
</span><a href="Futhark.MonadFreshNames.html#newIdent"><span class="hs-identifier hs-var">newIdent</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; String
</span><a href="Language.Futhark.Core.html#baseString"><span class="hs-identifier hs-var">baseString</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684455382"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TypeBase (ShapeBase SubExp) NoUniqueness
</span><a href="#local-6989586621684455381"><span class="hs-identifier hs-var">opt</span></a></span><span>
</span><span id="line-93"></span><span>          </span><span class="annot"><span class="annottext">[(Certs, Ident, BasicOp)]
-&gt; ((Certs, Ident, BasicOp) -&gt; Builder SOACS ())
-&gt; Builder SOACS ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Certs] -&gt; [Ident] -&gt; [BasicOp] -&gt; [(Certs, Ident, BasicOp)]
forall a b c. [a] -&gt; [b] -&gt; [c] -&gt; [(a, b, c)]
</span><span class="hs-identifier hs-var">zip3</span></span><span> </span><span class="annot"><span class="annottext">[Certs]
</span><a href="#local-6989586621684455398"><span class="hs-identifier hs-var">css</span></a></span><span> </span><span class="annot"><span class="annottext">[Ident]
</span><a href="#local-6989586621684455384"><span class="hs-identifier hs-var">newIds</span></a></span><span> </span><span class="annot"><span class="annottext">[BasicOp]
</span><a href="#local-6989586621684455399"><span class="hs-identifier hs-var">es</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Certs, Ident, BasicOp) -&gt; Builder SOACS ()) -&gt; Builder SOACS ())
-&gt; ((Certs, Ident, BasicOp) -&gt; Builder SOACS ())
-&gt; Builder SOACS ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684455377"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684455377"><span class="hs-identifier hs-var">cs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684455376"><span class="annot"><span class="annottext">Ident
</span><a href="#local-6989586621684455376"><span class="hs-identifier hs-var">ids</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684455375"><span class="annot"><span class="annottext">BasicOp
</span><a href="#local-6989586621684455375"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-94"></span><span>            </span><span class="annot"><span class="annottext">Certs -&gt; Builder SOACS () -&gt; Builder SOACS ()
forall (m :: * -&gt; *) a. MonadBuilder m =&gt; Certs -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#certifying"><span class="hs-identifier hs-var">certifying</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684455377"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">(Builder SOACS () -&gt; Builder SOACS ())
-&gt; Builder SOACS () -&gt; Builder SOACS ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat (Rep (BuilderT SOACS (State VNameSource)))
-&gt; Exp (Rep (BuilderT SOACS (State VNameSource)))
-&gt; Builder SOACS ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ident -&gt; PatT (TypeBase (ShapeBase SubExp) NoUniqueness)
</span><a href="#local-6989586621684455395"><span class="hs-identifier hs-var">mkPat</span></a></span><span> </span><span class="annot"><span class="annottext">Ident
</span><a href="#local-6989586621684455376"><span class="hs-identifier hs-var">ids</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT SOACS
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">BasicOp
</span><a href="#local-6989586621684455375"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-95"></span><span>          </span><span class="annot"><span class="annottext">ArrayTransforms -&gt; [Ident] -&gt; Builder SOACS ()
</span><a href="#local-6989586621684455415"><span class="hs-identifier hs-var">descend</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684455400"><span class="hs-identifier hs-var">ts''</span></a></span><span> </span><span class="annot"><span class="annottext">[Ident]
</span><a href="#local-6989586621684455384"><span class="hs-identifier hs-var">newIds</span></a></span><span>
</span><span id="line-96"></span><span>
</span><span id="line-97"></span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#applyTransform"><span class="hs-identifier hs-type">applyTransform</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#ArrayTransform"><span class="hs-identifier hs-type">SOAC.ArrayTransform</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Ident"><span class="hs-identifier hs-type">Ident</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Certs"><span class="hs-identifier hs-type">Certs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-98"></span><span id="applyTransform"><span class="annot"><span class="annottext">applyTransform :: ArrayTransform -&gt; Ident -&gt; (BasicOp, Certs)
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#applyTransform"><span class="hs-identifier hs-var hs-var">applyTransform</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Rearrange"><span class="hs-identifier hs-type">SOAC.Rearrange</span></a></span><span> </span><span id="local-6989586621684455371"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684455371"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span id="local-6989586621684455370"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684455370"><span class="hs-identifier hs-var">perm</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684455369"><span class="annot"><span class="annottext">Ident
</span><a href="#local-6989586621684455369"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-99"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Int] -&gt; VName -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Rearrange"><span class="hs-identifier hs-var">Rearrange</span></a></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684455367"><span class="hs-identifier hs-var">perm'</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; BasicOp) -&gt; VName -&gt; BasicOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Ident -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#identName"><span class="hs-identifier hs-var hs-var">identName</span></a></span><span> </span><span class="annot"><span class="annottext">Ident
</span><a href="#local-6989586621684455369"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684455371"><span class="hs-identifier hs-var">cs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-100"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-101"></span><span>    </span><span id="local-6989586621684455367"><span class="annot"><span class="annottext">perm' :: [Int]
</span><a href="#local-6989586621684455367"><span class="hs-identifier hs-var hs-var">perm'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684455370"><span class="hs-identifier hs-var">perm</span></a></span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; [Int] -&gt; [Int]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Int] -&gt; [Int]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Int] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684455370"><span class="hs-identifier hs-var">perm</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">TypeBase (ShapeBase SubExp) NoUniqueness -&gt; Int
forall shape u. ArrayShape shape =&gt; TypeBase shape u -&gt; Int
</span><a href="Futhark.IR.Prop.Types.html#arrayRank"><span class="hs-identifier hs-var">arrayRank</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ident -&gt; TypeBase (ShapeBase SubExp) NoUniqueness
</span><a href="Futhark.IR.Syntax.Core.html#identType"><span class="hs-identifier hs-var hs-var">identType</span></a></span><span> </span><span class="annot"><span class="annottext">Ident
</span><a href="#local-6989586621684455369"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span>
</span><span id="line-102"></span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#applyTransform"><span class="hs-identifier hs-var">applyTransform</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Reshape"><span class="hs-identifier hs-type">SOAC.Reshape</span></a></span><span> </span><span id="local-6989586621684455361"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684455361"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span id="local-6989586621684455360"><span class="annot"><span class="annottext">ShapeChange SubExp
</span><a href="#local-6989586621684455360"><span class="hs-identifier hs-var">shape</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684455359"><span class="annot"><span class="annottext">Ident
</span><a href="#local-6989586621684455359"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-103"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ShapeChange SubExp -&gt; VName -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Reshape"><span class="hs-identifier hs-var">Reshape</span></a></span><span> </span><span class="annot"><span class="annottext">ShapeChange SubExp
</span><a href="#local-6989586621684455360"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; BasicOp) -&gt; VName -&gt; BasicOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Ident -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#identName"><span class="hs-identifier hs-var hs-var">identName</span></a></span><span> </span><span class="annot"><span class="annottext">Ident
</span><a href="#local-6989586621684455359"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684455361"><span class="hs-identifier hs-var">cs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-104"></span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#applyTransform"><span class="hs-identifier hs-var">applyTransform</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#ReshapeOuter"><span class="hs-identifier hs-type">SOAC.ReshapeOuter</span></a></span><span> </span><span id="local-6989586621684455356"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684455356"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span id="local-6989586621684455355"><span class="annot"><span class="annottext">ShapeChange SubExp
</span><a href="#local-6989586621684455355"><span class="hs-identifier hs-var">shape</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684455354"><span class="annot"><span class="annottext">Ident
</span><a href="#local-6989586621684455354"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-105"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684455353"><span class="annot"><span class="annottext">shapes :: ShapeChange SubExp
</span><a href="#local-6989586621684455353"><span class="hs-identifier hs-var hs-var">shapes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ShapeChange SubExp -&gt; Int -&gt; ShapeBase SubExp -&gt; ShapeChange SubExp
</span><a href="Futhark.IR.Prop.Reshape.html#reshapeOuter"><span class="hs-identifier hs-var">reshapeOuter</span></a></span><span> </span><span class="annot"><span class="annottext">ShapeChange SubExp
</span><a href="#local-6989586621684455355"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">(ShapeBase SubExp -&gt; ShapeChange SubExp)
-&gt; ShapeBase SubExp -&gt; ShapeChange SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TypeBase (ShapeBase SubExp) NoUniqueness -&gt; ShapeBase SubExp
forall shape u. ArrayShape shape =&gt; TypeBase shape u -&gt; shape
</span><a href="Futhark.IR.Prop.Types.html#arrayShape"><span class="hs-identifier hs-var">arrayShape</span></a></span><span> </span><span class="annot"><span class="annottext">(TypeBase (ShapeBase SubExp) NoUniqueness -&gt; ShapeBase SubExp)
-&gt; TypeBase (ShapeBase SubExp) NoUniqueness -&gt; ShapeBase SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Ident -&gt; TypeBase (ShapeBase SubExp) NoUniqueness
</span><a href="Futhark.IR.Syntax.Core.html#identType"><span class="hs-identifier hs-var hs-var">identType</span></a></span><span> </span><span class="annot"><span class="annottext">Ident
</span><a href="#local-6989586621684455354"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-106"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ShapeChange SubExp -&gt; VName -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Reshape"><span class="hs-identifier hs-var">Reshape</span></a></span><span> </span><span class="annot"><span class="annottext">ShapeChange SubExp
</span><a href="#local-6989586621684455353"><span class="hs-identifier hs-var">shapes</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; BasicOp) -&gt; VName -&gt; BasicOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Ident -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#identName"><span class="hs-identifier hs-var hs-var">identName</span></a></span><span> </span><span class="annot"><span class="annottext">Ident
</span><a href="#local-6989586621684455354"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684455356"><span class="hs-identifier hs-var">cs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-107"></span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#applyTransform"><span class="hs-identifier hs-var">applyTransform</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#ReshapeInner"><span class="hs-identifier hs-type">SOAC.ReshapeInner</span></a></span><span> </span><span id="local-6989586621684455349"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684455349"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span id="local-6989586621684455348"><span class="annot"><span class="annottext">ShapeChange SubExp
</span><a href="#local-6989586621684455348"><span class="hs-identifier hs-var">shape</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684455347"><span class="annot"><span class="annottext">Ident
</span><a href="#local-6989586621684455347"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-108"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684455346"><span class="annot"><span class="annottext">shapes :: ShapeChange SubExp
</span><a href="#local-6989586621684455346"><span class="hs-identifier hs-var hs-var">shapes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ShapeChange SubExp -&gt; Int -&gt; ShapeBase SubExp -&gt; ShapeChange SubExp
</span><a href="Futhark.IR.Prop.Reshape.html#reshapeInner"><span class="hs-identifier hs-var">reshapeInner</span></a></span><span> </span><span class="annot"><span class="annottext">ShapeChange SubExp
</span><a href="#local-6989586621684455348"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">(ShapeBase SubExp -&gt; ShapeChange SubExp)
-&gt; ShapeBase SubExp -&gt; ShapeChange SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TypeBase (ShapeBase SubExp) NoUniqueness -&gt; ShapeBase SubExp
forall shape u. ArrayShape shape =&gt; TypeBase shape u -&gt; shape
</span><a href="Futhark.IR.Prop.Types.html#arrayShape"><span class="hs-identifier hs-var">arrayShape</span></a></span><span> </span><span class="annot"><span class="annottext">(TypeBase (ShapeBase SubExp) NoUniqueness -&gt; ShapeBase SubExp)
-&gt; TypeBase (ShapeBase SubExp) NoUniqueness -&gt; ShapeBase SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Ident -&gt; TypeBase (ShapeBase SubExp) NoUniqueness
</span><a href="Futhark.IR.Syntax.Core.html#identType"><span class="hs-identifier hs-var hs-var">identType</span></a></span><span> </span><span class="annot"><span class="annottext">Ident
</span><a href="#local-6989586621684455347"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-109"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ShapeChange SubExp -&gt; VName -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Reshape"><span class="hs-identifier hs-var">Reshape</span></a></span><span> </span><span class="annot"><span class="annottext">ShapeChange SubExp
</span><a href="#local-6989586621684455346"><span class="hs-identifier hs-var">shapes</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; BasicOp) -&gt; VName -&gt; BasicOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Ident -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#identName"><span class="hs-identifier hs-var hs-var">identName</span></a></span><span> </span><span class="annot"><span class="annottext">Ident
</span><a href="#local-6989586621684455347"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684455349"><span class="hs-identifier hs-var">cs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-110"></span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#applyTransform"><span class="hs-identifier hs-var">applyTransform</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Replicate"><span class="hs-identifier hs-type">SOAC.Replicate</span></a></span><span> </span><span id="local-6989586621684455343"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684455343"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span id="local-6989586621684455342"><span class="annot"><span class="annottext">ShapeBase SubExp
</span><a href="#local-6989586621684455342"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684455341"><span class="annot"><span class="annottext">Ident
</span><a href="#local-6989586621684455341"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-111"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ShapeBase SubExp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Replicate"><span class="hs-identifier hs-var">Replicate</span></a></span><span> </span><span class="annot"><span class="annottext">ShapeBase SubExp
</span><a href="#local-6989586621684455342"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; BasicOp) -&gt; SubExp -&gt; BasicOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SubExp) -&gt; VName -&gt; SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Ident -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#identName"><span class="hs-identifier hs-var hs-var">identName</span></a></span><span> </span><span class="annot"><span class="annottext">Ident
</span><a href="#local-6989586621684455341"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684455343"><span class="hs-identifier hs-var">cs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-112"></span><span>
</span><span id="line-113"></span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#inputToOutput"><span class="hs-identifier hs-type">inputToOutput</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Input"><span class="hs-identifier hs-type">SOAC.Input</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#ArrayTransform"><span class="hs-identifier hs-type">SOAC.ArrayTransform</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Input"><span class="hs-identifier hs-type">SOAC.Input</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-114"></span><span id="inputToOutput"><span class="annot"><span class="annottext">inputToOutput :: Input -&gt; Maybe (ArrayTransform, Input)
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#inputToOutput"><span class="hs-identifier hs-var hs-var">inputToOutput</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Input"><span class="hs-identifier hs-type">SOAC.Input</span></a></span><span> </span><span id="local-6989586621684455337"><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684455337"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span id="local-6989586621684455336"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684455336"><span class="hs-identifier hs-var">ia</span></a></span></span><span> </span><span id="local-6989586621684455335"><span class="annot"><span class="annottext">TypeBase (ShapeBase SubExp) NoUniqueness
</span><a href="#local-6989586621684455335"><span class="hs-identifier hs-var">iat</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-115"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ArrayTransforms -&gt; ViewF
</span><a href="Futhark.Analysis.HORep.SOAC.html#viewf"><span class="hs-identifier hs-var">SOAC.viewf</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684455337"><span class="hs-identifier hs-var">ts</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-116"></span><span>    </span><span id="local-6989586621684455334"><span class="annot"><span class="annottext">ArrayTransform
</span><a href="#local-6989586621684455334"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#%3A%3C"><span class="hs-operator hs-type">SOAC.:&lt;</span></a></span><span> </span><span id="local-6989586621684455333"><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684455333"><span class="hs-identifier hs-var">ts'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(ArrayTransform, Input) -&gt; Maybe (ArrayTransform, Input)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ArrayTransform
</span><a href="#local-6989586621684455334"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ArrayTransforms
-&gt; VName -&gt; TypeBase (ShapeBase SubExp) NoUniqueness -&gt; Input
</span><a href="Futhark.Analysis.HORep.SOAC.html#Input"><span class="hs-identifier hs-var">SOAC.Input</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684455333"><span class="hs-identifier hs-var">ts'</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684455336"><span class="hs-identifier hs-var">ia</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase (ShapeBase SubExp) NoUniqueness
</span><a href="#local-6989586621684455335"><span class="hs-identifier hs-var">iat</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-117"></span><span>    </span><span class="annot"><span class="annottext">ViewF
</span><a href="Futhark.Analysis.HORep.SOAC.html#EmptyF"><span class="hs-identifier hs-var">SOAC.EmptyF</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (ArrayTransform, Input)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-118"></span><span>
</span><span id="line-119"></span><span class="hs-keyword">data</span><span> </span><span id="FusedKer"><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#FusedKer"><span class="hs-identifier hs-var">FusedKer</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="FusedKer"><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#FusedKer"><span class="hs-identifier hs-var">FusedKer</span></a></span></span><span>
</span><span id="line-120"></span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- | the SOAC expression, e.g., mapT( f(a,b), x, y )</span><span>
</span><span id="line-121"></span><span>    </span><span id="fsoac"><span class="annot"><span class="annottext">FusedKer -&gt; SOAC SOACS
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#fsoac"><span class="hs-identifier hs-var hs-var">fsoac</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#SOAC"><span class="hs-identifier hs-type">SOAC</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-122"></span><span>    </span><span class="hs-comment">-- | Variables used in in-place updates in the kernel itself, as</span><span>
</span><span id="line-123"></span><span>    </span><span class="hs-comment">-- well as on the path to the kernel from the current position.</span><span>
</span><span id="line-124"></span><span>    </span><span class="hs-comment">-- This is used to avoid fusion that would violate in-place</span><span>
</span><span id="line-125"></span><span>    </span><span class="hs-comment">-- restrictions.</span><span>
</span><span id="line-126"></span><span>    </span><span id="inplace"><span class="annot"><span class="annottext">FusedKer -&gt; Names
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#inplace"><span class="hs-identifier hs-var hs-var">inplace</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-127"></span><span>    </span><span class="hs-comment">-- | whether at least a fusion has been performed.</span><span>
</span><span id="line-128"></span><span>    </span><span id="fusedVars"><span class="annot"><span class="annottext">FusedKer -&gt; [VName]
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#fusedVars"><span class="hs-identifier hs-var hs-var">fusedVars</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><span id="line-129"></span><span>    </span><span class="hs-comment">-- | The set of variables that were consumed by the SOACs</span><span>
</span><span id="line-130"></span><span>    </span><span class="hs-comment">-- contributing to this kernel.  Note that, by the type rules, the</span><span>
</span><span id="line-131"></span><span>    </span><span class="hs-comment">-- final SOAC may actually consume _more_ than its original</span><span>
</span><span id="line-132"></span><span>    </span><span class="hs-comment">-- contributors, which implies the need for 'Copy' expressions.</span><span>
</span><span id="line-133"></span><span>    </span><span id="fusedConsumed"><span class="annot"><span class="annottext">FusedKer -&gt; Names
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#fusedConsumed"><span class="hs-identifier hs-var hs-var">fusedConsumed</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-134"></span><span>    </span><span class="hs-comment">-- | The names in scope at the kernel.</span><span>
</span><span id="line-135"></span><span>    </span><span id="kernelScope"><span class="annot"><span class="annottext">FusedKer -&gt; Scope SOACS
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#kernelScope"><span class="hs-identifier hs-var hs-var">kernelScope</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-136"></span><span>    </span><span id="outputTransform"><span class="annot"><span class="annottext">FusedKer -&gt; ArrayTransforms
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#outputTransform"><span class="hs-identifier hs-var hs-var">outputTransform</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#ArrayTransforms"><span class="hs-identifier hs-type">SOAC.ArrayTransforms</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-137"></span><span>    </span><span id="outNames"><span class="annot"><span class="annottext">FusedKer -&gt; [VName]
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#outNames"><span class="hs-identifier hs-var hs-var">outNames</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><span id="line-138"></span><span>    </span><span id="kerAux"><span class="annot"><span class="annottext">FusedKer -&gt; StmAux ()
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#kerAux"><span class="hs-identifier hs-var hs-var">kerAux</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#StmAux"><span class="hs-identifier hs-type">StmAux</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-139"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-140"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684455300"><span id="local-6989586621684455302"><span id="local-6989586621684455322"><span class="annot"><span class="annottext">Int -&gt; FusedKer -&gt; ShowS
[FusedKer] -&gt; ShowS
FusedKer -&gt; String
(Int -&gt; FusedKer -&gt; ShowS)
-&gt; (FusedKer -&gt; String) -&gt; ([FusedKer] -&gt; ShowS) -&gt; Show FusedKer
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [FusedKer] -&gt; ShowS
$cshowList :: [FusedKer] -&gt; ShowS
show :: FusedKer -&gt; String
$cshow :: FusedKer -&gt; String
showsPrec :: Int -&gt; FusedKer -&gt; ShowS
$cshowsPrec :: Int -&gt; FusedKer -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-141"></span><span>
</span><span id="line-142"></span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#newKernel"><span class="hs-identifier hs-type">newKernel</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#StmAux"><span class="hs-identifier hs-type">StmAux</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#SOAC"><span class="hs-identifier hs-type">SOAC</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#FusedKer"><span class="hs-identifier hs-type">FusedKer</span></a></span><span>
</span><span id="line-143"></span><span id="newKernel"><span class="annot"><span class="annottext">newKernel :: StmAux ()
-&gt; SOAC SOACS -&gt; Names -&gt; [VName] -&gt; Scope SOACS -&gt; FusedKer
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#newKernel"><span class="hs-identifier hs-var hs-var">newKernel</span></a></span></span><span> </span><span id="local-6989586621684455295"><span class="annot"><span class="annottext">StmAux ()
</span><a href="#local-6989586621684455295"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span id="local-6989586621684455294"><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455294"><span class="hs-identifier hs-var">soac</span></a></span></span><span> </span><span id="local-6989586621684455293"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684455293"><span class="hs-identifier hs-var">consumed</span></a></span></span><span> </span><span id="local-6989586621684455292"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455292"><span class="hs-identifier hs-var">out_nms</span></a></span></span><span> </span><span id="local-6989586621684455291"><span class="annot"><span class="annottext">Scope SOACS
</span><a href="#local-6989586621684455291"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-144"></span><span>  </span><span class="annot"><span class="annottext">FusedKer :: SOAC SOACS
-&gt; Names
-&gt; [VName]
-&gt; Names
-&gt; Scope SOACS
-&gt; ArrayTransforms
-&gt; [VName]
-&gt; StmAux ()
-&gt; FusedKer
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#FusedKer"><span class="hs-identifier hs-type">FusedKer</span></a></span><span>
</span><span id="line-145"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fsoac :: SOAC SOACS
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#fsoac"><span class="hs-identifier hs-var">fsoac</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455294"><span class="hs-identifier hs-var">soac</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-146"></span><span>      </span><span class="annot"><span class="annottext">inplace :: Names
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#inplace"><span class="hs-identifier hs-var">inplace</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684455293"><span class="hs-identifier hs-var">consumed</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-147"></span><span>      </span><span class="annot"><span class="annottext">fusedVars :: [VName]
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#fusedVars"><span class="hs-identifier hs-var">fusedVars</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><span id="line-148"></span><span>      </span><span class="annot"><span class="annottext">fusedConsumed :: Names
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#fusedConsumed"><span class="hs-identifier hs-var">fusedConsumed</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684455293"><span class="hs-identifier hs-var">consumed</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-149"></span><span>      </span><span class="annot"><span class="annottext">outputTransform :: ArrayTransforms
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#outputTransform"><span class="hs-identifier hs-var">outputTransform</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="Futhark.Analysis.HORep.SOAC.html#noTransforms"><span class="hs-identifier hs-var">SOAC.noTransforms</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-150"></span><span>      </span><span class="annot"><span class="annottext">outNames :: [VName]
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#outNames"><span class="hs-identifier hs-var">outNames</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455292"><span class="hs-identifier hs-var">out_nms</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-151"></span><span>      </span><span class="annot"><span class="annottext">kernelScope :: Scope SOACS
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#kernelScope"><span class="hs-identifier hs-var">kernelScope</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Scope SOACS
</span><a href="#local-6989586621684455291"><span class="hs-identifier hs-var">scope</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-152"></span><span>      </span><span class="annot"><span class="annottext">kerAux :: StmAux ()
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#kerAux"><span class="hs-identifier hs-var">kerAux</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StmAux ()
</span><a href="#local-6989586621684455295"><span class="hs-identifier hs-var">aux</span></a></span><span>
</span><span id="line-153"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-154"></span><span>
</span><span id="line-155"></span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#arrInputs"><span class="hs-identifier hs-type">arrInputs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#FusedKer"><span class="hs-identifier hs-type">FusedKer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.Set</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span>
</span><span id="line-156"></span><span id="arrInputs"><span class="annot"><span class="annottext">arrInputs :: FusedKer -&gt; Set VName
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#arrInputs"><span class="hs-identifier hs-var hs-var">arrInputs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Set VName
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">S.fromList</span></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; Set VName)
-&gt; (FusedKer -&gt; [VName]) -&gt; FusedKer -&gt; Set VName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Input -&gt; VName) -&gt; [Input] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Input -&gt; VName
</span><a href="Futhark.Analysis.HORep.SOAC.html#inputArray"><span class="hs-identifier hs-var">SOAC.inputArray</span></a></span><span> </span><span class="annot"><span class="annottext">([Input] -&gt; [VName])
-&gt; (FusedKer -&gt; [Input]) -&gt; FusedKer -&gt; [VName]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">FusedKer -&gt; [Input]
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#inputs"><span class="hs-identifier hs-var">inputs</span></a></span><span>
</span><span id="line-157"></span><span>
</span><span id="line-158"></span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#inputs"><span class="hs-identifier hs-type">inputs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#FusedKer"><span class="hs-identifier hs-type">FusedKer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Input"><span class="hs-identifier hs-type">SOAC.Input</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-159"></span><span id="inputs"><span class="annot"><span class="annottext">inputs :: FusedKer -&gt; [Input]
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#inputs"><span class="hs-identifier hs-var hs-var">inputs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SOAC SOACS -&gt; [Input]
forall rep. SOAC rep -&gt; [Input]
</span><a href="Futhark.Analysis.HORep.SOAC.html#inputs"><span class="hs-identifier hs-var">SOAC.inputs</span></a></span><span> </span><span class="annot"><span class="annottext">(SOAC SOACS -&gt; [Input])
-&gt; (FusedKer -&gt; SOAC SOACS) -&gt; FusedKer -&gt; [Input]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">FusedKer -&gt; SOAC SOACS
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#fsoac"><span class="hs-identifier hs-var hs-var">fsoac</span></a></span><span>
</span><span id="line-160"></span><span>
</span><span id="line-161"></span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#setInputs"><span class="hs-identifier hs-type">setInputs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Input"><span class="hs-identifier hs-type">SOAC.Input</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#FusedKer"><span class="hs-identifier hs-type">FusedKer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#FusedKer"><span class="hs-identifier hs-type">FusedKer</span></a></span><span>
</span><span id="line-162"></span><span id="setInputs"><span class="annot"><span class="annottext">setInputs :: [Input] -&gt; FusedKer -&gt; FusedKer
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#setInputs"><span class="hs-identifier hs-var hs-var">setInputs</span></a></span></span><span> </span><span id="local-6989586621684455285"><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684455285"><span class="hs-identifier hs-var">inps</span></a></span></span><span> </span><span id="local-6989586621684455284"><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455284"><span class="hs-identifier hs-var">ker</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455284"><span class="hs-identifier hs-var">ker</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">fsoac :: SOAC SOACS
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#fsoac"><span class="hs-identifier hs-var">fsoac</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684455285"><span class="hs-identifier hs-var">inps</span></a></span><span> </span><span class="annot"><span class="annottext">[Input] -&gt; SOAC SOACS -&gt; SOAC SOACS
forall rep. [Input] -&gt; SOAC rep -&gt; SOAC rep
</span><a href="Futhark.Analysis.HORep.SOAC.html#setInputs"><span class="hs-operator hs-var">`SOAC.setInputs`</span></a></span><span> </span><span class="annot"><span class="annottext">FusedKer -&gt; SOAC SOACS
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#fsoac"><span class="hs-identifier hs-var hs-var">fsoac</span></a></span><span> </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455284"><span class="hs-identifier hs-var">ker</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-163"></span><span>
</span><span id="line-164"></span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#tryOptimizeSOAC"><span class="hs-identifier hs-type">tryOptimizeSOAC</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-165"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-166"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-167"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#SOAC"><span class="hs-identifier hs-type">SOAC</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-168"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-169"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#FusedKer"><span class="hs-identifier hs-type">FusedKer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-170"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#TryFusion"><span class="hs-identifier hs-type">TryFusion</span></a></span><span> </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#FusedKer"><span class="hs-identifier hs-type">FusedKer</span></a></span><span>
</span><span id="line-171"></span><span id="tryOptimizeSOAC"><span class="annot"><span class="annottext">tryOptimizeSOAC :: Names
-&gt; [VName] -&gt; SOAC SOACS -&gt; Names -&gt; FusedKer -&gt; TryFusion FusedKer
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#tryOptimizeSOAC"><span class="hs-identifier hs-var hs-var">tryOptimizeSOAC</span></a></span></span><span> </span><span id="local-6989586621684455281"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684455281"><span class="hs-identifier hs-var">unfus_nms</span></a></span></span><span> </span><span id="local-6989586621684455280"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455280"><span class="hs-identifier hs-var">outVars</span></a></span></span><span> </span><span id="local-6989586621684455279"><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455279"><span class="hs-identifier hs-var">soac</span></a></span></span><span> </span><span id="local-6989586621684455278"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684455278"><span class="hs-identifier hs-var">consumed</span></a></span></span><span> </span><span id="local-6989586621684455277"><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455277"><span class="hs-identifier hs-var">ker</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-172"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684455276"><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455276"><span class="hs-identifier hs-var">soac'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684455275"><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684455275"><span class="hs-identifier hs-var">ots</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe [VName]
-&gt; SOAC SOACS
-&gt; ArrayTransforms
-&gt; TryFusion (SOAC SOACS, ArrayTransforms)
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#optimizeSOAC"><span class="hs-identifier hs-var">optimizeSOAC</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe [VName]
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455279"><span class="hs-identifier hs-var">soac</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayTransforms
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-173"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684455273"><span class="annot"><span class="annottext">ker' :: FusedKer
</span><a href="#local-6989586621684455273"><span class="hs-identifier hs-var hs-var">ker'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Input -&gt; Input) -&gt; [Input] -&gt; [Input]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ArrayTransforms -&gt; Input -&gt; Input
</span><a href="#local-6989586621684455272"><span class="hs-identifier hs-var">addInitialTransformIfRelevant</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684455275"><span class="hs-identifier hs-var">ots</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FusedKer -&gt; [Input]
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#inputs"><span class="hs-identifier hs-var">inputs</span></a></span><span> </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455277"><span class="hs-identifier hs-var">ker</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Input] -&gt; FusedKer -&gt; FusedKer
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#setInputs"><span class="hs-operator hs-var">`setInputs`</span></a></span><span> </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455277"><span class="hs-identifier hs-var">ker</span></a></span><span>
</span><span id="line-174"></span><span>      </span><span id="local-6989586621684455271"><span class="annot"><span class="annottext">outIdents :: [Ident]
</span><a href="#local-6989586621684455271"><span class="hs-identifier hs-var hs-var">outIdents</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; TypeBase (ShapeBase SubExp) NoUniqueness -&gt; Ident)
-&gt; [VName] -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness] -&gt; [Ident]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TypeBase (ShapeBase SubExp) NoUniqueness -&gt; Ident
</span><a href="Futhark.IR.Syntax.Core.html#Ident"><span class="hs-identifier hs-var">Ident</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455280"><span class="hs-identifier hs-var">outVars</span></a></span><span> </span><span class="annot"><span class="annottext">([TypeBase (ShapeBase SubExp) NoUniqueness] -&gt; [Ident])
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness] -&gt; [Ident]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
forall rep. SOAC rep -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="Futhark.Analysis.HORep.SOAC.html#typeOf"><span class="hs-identifier hs-var">SOAC.typeOf</span></a></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455276"><span class="hs-identifier hs-var">soac'</span></a></span><span>
</span><span id="line-175"></span><span>      </span><span id="local-6989586621684455268"><span class="annot"><span class="annottext">ker'' :: FusedKer
</span><a href="#local-6989586621684455268"><span class="hs-identifier hs-var hs-var">ker''</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Ident] -&gt; FusedKer -&gt; FusedKer
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#fixInputTypes"><span class="hs-identifier hs-var">fixInputTypes</span></a></span><span> </span><span class="annot"><span class="annottext">[Ident]
</span><a href="#local-6989586621684455271"><span class="hs-identifier hs-var">outIdents</span></a></span><span> </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455273"><span class="hs-identifier hs-var">ker'</span></a></span><span>
</span><span id="line-176"></span><span>  </span><span class="annot"><span class="annottext">Names
-&gt; [VName] -&gt; SOAC SOACS -&gt; Names -&gt; FusedKer -&gt; TryFusion FusedKer
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#applyFusionRules"><span class="hs-identifier hs-var">applyFusionRules</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684455281"><span class="hs-identifier hs-var">unfus_nms</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455280"><span class="hs-identifier hs-var">outVars</span></a></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455276"><span class="hs-identifier hs-var">soac'</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684455278"><span class="hs-identifier hs-var">consumed</span></a></span><span> </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455268"><span class="hs-identifier hs-var">ker''</span></a></span><span>
</span><span id="line-177"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-178"></span><span>    </span><span id="local-6989586621684455272"><span class="annot"><span class="annottext">addInitialTransformIfRelevant :: ArrayTransforms -&gt; Input -&gt; Input
</span><a href="#local-6989586621684455272"><span class="hs-identifier hs-var hs-var">addInitialTransformIfRelevant</span></a></span></span><span> </span><span id="local-6989586621684455265"><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684455265"><span class="hs-identifier hs-var">ots</span></a></span></span><span> </span><span id="local-6989586621684455264"><span class="annot"><span class="annottext">Input
</span><a href="#local-6989586621684455264"><span class="hs-identifier hs-var">inp</span></a></span></span><span>
</span><span id="line-179"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Input -&gt; VName
</span><a href="Futhark.Analysis.HORep.SOAC.html#inputArray"><span class="hs-identifier hs-var">SOAC.inputArray</span></a></span><span> </span><span class="annot"><span class="annottext">Input
</span><a href="#local-6989586621684455264"><span class="hs-identifier hs-var">inp</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [VName] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455280"><span class="hs-identifier hs-var">outVars</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-180"></span><span>        </span><span class="annot"><span class="annottext">ArrayTransforms -&gt; Input -&gt; Input
</span><a href="Futhark.Analysis.HORep.SOAC.html#addInitialTransforms"><span class="hs-identifier hs-var">SOAC.addInitialTransforms</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684455265"><span class="hs-identifier hs-var">ots</span></a></span><span> </span><span class="annot"><span class="annottext">Input
</span><a href="#local-6989586621684455264"><span class="hs-identifier hs-var">inp</span></a></span><span>
</span><span id="line-181"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-182"></span><span>        </span><span class="annot"><span class="annottext">Input
</span><a href="#local-6989586621684455264"><span class="hs-identifier hs-var">inp</span></a></span><span>
</span><span id="line-183"></span><span>
</span><span id="line-184"></span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#tryOptimizeKernel"><span class="hs-identifier hs-type">tryOptimizeKernel</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-185"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-186"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-187"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#SOAC"><span class="hs-identifier hs-type">SOAC</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-188"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-189"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#FusedKer"><span class="hs-identifier hs-type">FusedKer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-190"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#TryFusion"><span class="hs-identifier hs-type">TryFusion</span></a></span><span> </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#FusedKer"><span class="hs-identifier hs-type">FusedKer</span></a></span><span>
</span><span id="line-191"></span><span id="tryOptimizeKernel"><span class="annot"><span class="annottext">tryOptimizeKernel :: Names
-&gt; [VName] -&gt; SOAC SOACS -&gt; Names -&gt; FusedKer -&gt; TryFusion FusedKer
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#tryOptimizeKernel"><span class="hs-identifier hs-var hs-var">tryOptimizeKernel</span></a></span></span><span> </span><span id="local-6989586621684455260"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684455260"><span class="hs-identifier hs-var">unfus_nms</span></a></span></span><span> </span><span id="local-6989586621684455259"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455259"><span class="hs-identifier hs-var">outVars</span></a></span></span><span> </span><span id="local-6989586621684455258"><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455258"><span class="hs-identifier hs-var">soac</span></a></span></span><span> </span><span id="local-6989586621684455257"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684455257"><span class="hs-identifier hs-var">consumed</span></a></span></span><span> </span><span id="local-6989586621684455256"><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455256"><span class="hs-identifier hs-var">ker</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-192"></span><span>  </span><span id="local-6989586621684455255"><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455255"><span class="hs-identifier hs-var">ker'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe [VName] -&gt; FusedKer -&gt; TryFusion FusedKer
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#optimizeKernel"><span class="hs-identifier hs-var">optimizeKernel</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; Maybe [VName]
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455259"><span class="hs-identifier hs-var">outVars</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455256"><span class="hs-identifier hs-var">ker</span></a></span><span>
</span><span id="line-193"></span><span>  </span><span class="annot"><span class="annottext">Names
-&gt; [VName] -&gt; SOAC SOACS -&gt; Names -&gt; FusedKer -&gt; TryFusion FusedKer
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#applyFusionRules"><span class="hs-identifier hs-var">applyFusionRules</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684455260"><span class="hs-identifier hs-var">unfus_nms</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455259"><span class="hs-identifier hs-var">outVars</span></a></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455258"><span class="hs-identifier hs-var">soac</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684455257"><span class="hs-identifier hs-var">consumed</span></a></span><span> </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455255"><span class="hs-identifier hs-var">ker'</span></a></span><span>
</span><span id="line-194"></span><span>
</span><span id="line-195"></span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#tryExposeInputs"><span class="hs-identifier hs-type">tryExposeInputs</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-196"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-197"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-198"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#SOAC"><span class="hs-identifier hs-type">SOAC</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-199"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-200"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#FusedKer"><span class="hs-identifier hs-type">FusedKer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-201"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#TryFusion"><span class="hs-identifier hs-type">TryFusion</span></a></span><span> </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#FusedKer"><span class="hs-identifier hs-type">FusedKer</span></a></span><span>
</span><span id="line-202"></span><span id="tryExposeInputs"><span class="annot"><span class="annottext">tryExposeInputs :: Names
-&gt; [VName] -&gt; SOAC SOACS -&gt; Names -&gt; FusedKer -&gt; TryFusion FusedKer
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#tryExposeInputs"><span class="hs-identifier hs-var hs-var">tryExposeInputs</span></a></span></span><span> </span><span id="local-6989586621684455252"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684455252"><span class="hs-identifier hs-var">unfus_nms</span></a></span></span><span> </span><span id="local-6989586621684455251"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455251"><span class="hs-identifier hs-var">outVars</span></a></span></span><span> </span><span id="local-6989586621684455250"><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455250"><span class="hs-identifier hs-var">soac</span></a></span></span><span> </span><span id="local-6989586621684455249"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684455249"><span class="hs-identifier hs-var">consumed</span></a></span></span><span> </span><span id="local-6989586621684455248"><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455248"><span class="hs-identifier hs-var">ker</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-203"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684455247"><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455247"><span class="hs-identifier hs-var">ker'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684455246"><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684455246"><span class="hs-identifier hs-var">ots</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; FusedKer -&gt; TryFusion (FusedKer, ArrayTransforms)
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#exposeInputs"><span class="hs-identifier hs-var">exposeInputs</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455251"><span class="hs-identifier hs-var">outVars</span></a></span><span> </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455248"><span class="hs-identifier hs-var">ker</span></a></span><span>
</span><span id="line-204"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">ArrayTransforms -&gt; Bool
</span><a href="Futhark.Analysis.HORep.SOAC.html#nullTransforms"><span class="hs-identifier hs-var">SOAC.nullTransforms</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684455246"><span class="hs-identifier hs-var">ots</span></a></span><span>
</span><span id="line-205"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Names
-&gt; [VName] -&gt; SOAC SOACS -&gt; Names -&gt; FusedKer -&gt; TryFusion FusedKer
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#fuseSOACwithKer"><span class="hs-identifier hs-var">fuseSOACwithKer</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684455252"><span class="hs-identifier hs-var">unfus_nms</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455251"><span class="hs-identifier hs-var">outVars</span></a></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455250"><span class="hs-identifier hs-var">soac</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684455249"><span class="hs-identifier hs-var">consumed</span></a></span><span> </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455247"><span class="hs-identifier hs-var">ker'</span></a></span><span>
</span><span id="line-206"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-207"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684455242"><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455242"><span class="hs-identifier hs-var">soac'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684455241"><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684455241"><span class="hs-identifier hs-var">ots'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
-&gt; ArrayTransforms -&gt; TryFusion (SOAC SOACS, ArrayTransforms)
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#pullOutputTransforms"><span class="hs-identifier hs-var">pullOutputTransforms</span></a></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455250"><span class="hs-identifier hs-var">soac</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684455246"><span class="hs-identifier hs-var">ots</span></a></span><span>
</span><span id="line-208"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684455239"><span class="annot"><span class="annottext">outIdents :: [Ident]
</span><a href="#local-6989586621684455239"><span class="hs-identifier hs-var hs-var">outIdents</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; TypeBase (ShapeBase SubExp) NoUniqueness -&gt; Ident)
-&gt; [VName] -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness] -&gt; [Ident]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TypeBase (ShapeBase SubExp) NoUniqueness -&gt; Ident
</span><a href="Futhark.IR.Syntax.Core.html#Ident"><span class="hs-identifier hs-var">Ident</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455251"><span class="hs-identifier hs-var">outVars</span></a></span><span> </span><span class="annot"><span class="annottext">([TypeBase (ShapeBase SubExp) NoUniqueness] -&gt; [Ident])
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness] -&gt; [Ident]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
forall rep. SOAC rep -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="Futhark.Analysis.HORep.SOAC.html#typeOf"><span class="hs-identifier hs-var">SOAC.typeOf</span></a></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455242"><span class="hs-identifier hs-var">soac'</span></a></span><span>
</span><span id="line-209"></span><span>          </span><span id="local-6989586621684455238"><span class="annot"><span class="annottext">ker'' :: FusedKer
</span><a href="#local-6989586621684455238"><span class="hs-identifier hs-var hs-var">ker''</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Ident] -&gt; FusedKer -&gt; FusedKer
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#fixInputTypes"><span class="hs-identifier hs-var">fixInputTypes</span></a></span><span> </span><span class="annot"><span class="annottext">[Ident]
</span><a href="#local-6989586621684455239"><span class="hs-identifier hs-var">outIdents</span></a></span><span> </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455247"><span class="hs-identifier hs-var">ker'</span></a></span><span>
</span><span id="line-210"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">ArrayTransforms -&gt; Bool
</span><a href="Futhark.Analysis.HORep.SOAC.html#nullTransforms"><span class="hs-identifier hs-var">SOAC.nullTransforms</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684455241"><span class="hs-identifier hs-var">ots'</span></a></span><span>
</span><span id="line-211"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Names
-&gt; [VName] -&gt; SOAC SOACS -&gt; Names -&gt; FusedKer -&gt; TryFusion FusedKer
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#applyFusionRules"><span class="hs-identifier hs-var">applyFusionRules</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684455252"><span class="hs-identifier hs-var">unfus_nms</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455251"><span class="hs-identifier hs-var">outVars</span></a></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455242"><span class="hs-identifier hs-var">soac'</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684455249"><span class="hs-identifier hs-var">consumed</span></a></span><span> </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455238"><span class="hs-identifier hs-var">ker''</span></a></span><span>
</span><span id="line-212"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">String -&gt; TryFusion FusedKer
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;tryExposeInputs could not pull SOAC transforms&quot;</span></span><span>
</span><span id="line-213"></span><span>
</span><span id="line-214"></span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#fixInputTypes"><span class="hs-identifier hs-type">fixInputTypes</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Ident"><span class="hs-identifier hs-type">Ident</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#FusedKer"><span class="hs-identifier hs-type">FusedKer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#FusedKer"><span class="hs-identifier hs-type">FusedKer</span></a></span><span>
</span><span id="line-215"></span><span id="fixInputTypes"><span class="annot"><span class="annottext">fixInputTypes :: [Ident] -&gt; FusedKer -&gt; FusedKer
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#fixInputTypes"><span class="hs-identifier hs-var hs-var">fixInputTypes</span></a></span></span><span> </span><span id="local-6989586621684455237"><span class="annot"><span class="annottext">[Ident]
</span><a href="#local-6989586621684455237"><span class="hs-identifier hs-var">outIdents</span></a></span></span><span> </span><span id="local-6989586621684455236"><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455236"><span class="hs-identifier hs-var">ker</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-216"></span><span>  </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455236"><span class="hs-identifier hs-var">ker</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">fsoac :: SOAC SOACS
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#fsoac"><span class="hs-identifier hs-var">fsoac</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SOAC SOACS -&gt; SOAC SOACS
</span><a href="#local-6989586621684455235"><span class="hs-identifier hs-var">fixInputTypes'</span></a></span><span> </span><span class="annot"><span class="annottext">(SOAC SOACS -&gt; SOAC SOACS) -&gt; SOAC SOACS -&gt; SOAC SOACS
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FusedKer -&gt; SOAC SOACS
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#fsoac"><span class="hs-identifier hs-var hs-var">fsoac</span></a></span><span> </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455236"><span class="hs-identifier hs-var">ker</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-217"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-218"></span><span>    </span><span id="local-6989586621684455235"><span class="annot"><span class="annottext">fixInputTypes' :: SOAC SOACS -&gt; SOAC SOACS
</span><a href="#local-6989586621684455235"><span class="hs-identifier hs-var hs-var">fixInputTypes'</span></a></span></span><span> </span><span id="local-6989586621684455234"><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455234"><span class="hs-identifier hs-var">soac</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-219"></span><span>      </span><span class="annot"><span class="annottext">(Input -&gt; Input) -&gt; [Input] -&gt; [Input]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Input -&gt; Input
</span><a href="#local-6989586621684455233"><span class="hs-identifier hs-var">fixInputType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SOAC SOACS -&gt; [Input]
forall rep. SOAC rep -&gt; [Input]
</span><a href="Futhark.Analysis.HORep.SOAC.html#inputs"><span class="hs-identifier hs-var">SOAC.inputs</span></a></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455234"><span class="hs-identifier hs-var">soac</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Input] -&gt; SOAC SOACS -&gt; SOAC SOACS
forall rep. [Input] -&gt; SOAC rep -&gt; SOAC rep
</span><a href="Futhark.Analysis.HORep.SOAC.html#setInputs"><span class="hs-operator hs-var">`SOAC.setInputs`</span></a></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455234"><span class="hs-identifier hs-var">soac</span></a></span><span>
</span><span id="line-220"></span><span>    </span><span id="local-6989586621684455233"><span class="annot"><span class="annottext">fixInputType :: Input -&gt; Input
</span><a href="#local-6989586621684455233"><span class="hs-identifier hs-var hs-var">fixInputType</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Input"><span class="hs-identifier hs-type">SOAC.Input</span></a></span><span> </span><span id="local-6989586621684455232"><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684455232"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span id="local-6989586621684455231"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684455231"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="annot"><span class="annottext">TypeBase (ShapeBase SubExp) NoUniqueness
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-221"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684455230"><span class="annot"><span class="annottext">Ident
</span><a href="#local-6989586621684455230"><span class="hs-identifier hs-var">v'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Ident -&gt; Bool) -&gt; [Ident] -&gt; Maybe Ident
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Maybe a
</span><span class="hs-identifier hs-var">find</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; VName -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684455231"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Bool) -&gt; (Ident -&gt; VName) -&gt; Ident -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Ident -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#identName"><span class="hs-identifier hs-var hs-var">identName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Ident]
</span><a href="#local-6989586621684455237"><span class="hs-identifier hs-var">outIdents</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-222"></span><span>        </span><span class="annot"><span class="annottext">ArrayTransforms
-&gt; VName -&gt; TypeBase (ShapeBase SubExp) NoUniqueness -&gt; Input
</span><a href="Futhark.Analysis.HORep.SOAC.html#Input"><span class="hs-identifier hs-var">SOAC.Input</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684455232"><span class="hs-identifier hs-var">ts</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684455231"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">(TypeBase (ShapeBase SubExp) NoUniqueness -&gt; Input)
-&gt; TypeBase (ShapeBase SubExp) NoUniqueness -&gt; Input
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Ident -&gt; TypeBase (ShapeBase SubExp) NoUniqueness
</span><a href="Futhark.IR.Syntax.Core.html#identType"><span class="hs-identifier hs-var hs-var">identType</span></a></span><span> </span><span class="annot"><span class="annottext">Ident
</span><a href="#local-6989586621684455230"><span class="hs-identifier hs-var">v'</span></a></span><span>
</span><span id="line-223"></span><span>    </span><span class="annot"><a href="#local-6989586621684455233"><span class="hs-identifier hs-var">fixInputType</span></a></span><span> </span><span id="local-6989586621684455229"><span class="annot"><span class="annottext">Input
</span><a href="#local-6989586621684455229"><span class="hs-identifier hs-var">inp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Input
</span><a href="#local-6989586621684455229"><span class="hs-identifier hs-var">inp</span></a></span><span>
</span><span id="line-224"></span><span>
</span><span id="line-225"></span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#applyFusionRules"><span class="hs-identifier hs-type">applyFusionRules</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-226"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-227"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-228"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#SOAC"><span class="hs-identifier hs-type">SOAC</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-229"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-230"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#FusedKer"><span class="hs-identifier hs-type">FusedKer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-231"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#TryFusion"><span class="hs-identifier hs-type">TryFusion</span></a></span><span> </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#FusedKer"><span class="hs-identifier hs-type">FusedKer</span></a></span><span>
</span><span id="line-232"></span><span id="applyFusionRules"><span class="annot"><span class="annottext">applyFusionRules :: Names
-&gt; [VName] -&gt; SOAC SOACS -&gt; Names -&gt; FusedKer -&gt; TryFusion FusedKer
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#applyFusionRules"><span class="hs-identifier hs-var hs-var">applyFusionRules</span></a></span></span><span> </span><span id="local-6989586621684455228"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684455228"><span class="hs-identifier hs-var">unfus_nms</span></a></span></span><span> </span><span id="local-6989586621684455227"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455227"><span class="hs-identifier hs-var">outVars</span></a></span></span><span> </span><span id="local-6989586621684455226"><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455226"><span class="hs-identifier hs-var">soac</span></a></span></span><span> </span><span id="local-6989586621684455225"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684455225"><span class="hs-identifier hs-var">consumed</span></a></span></span><span> </span><span id="local-6989586621684455224"><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455224"><span class="hs-identifier hs-var">ker</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-233"></span><span>  </span><span class="annot"><span class="annottext">Names
-&gt; [VName] -&gt; SOAC SOACS -&gt; Names -&gt; FusedKer -&gt; TryFusion FusedKer
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#tryOptimizeSOAC"><span class="hs-identifier hs-var">tryOptimizeSOAC</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684455228"><span class="hs-identifier hs-var">unfus_nms</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455227"><span class="hs-identifier hs-var">outVars</span></a></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455226"><span class="hs-identifier hs-var">soac</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684455225"><span class="hs-identifier hs-var">consumed</span></a></span><span> </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455224"><span class="hs-identifier hs-var">ker</span></a></span><span>
</span><span id="line-234"></span><span>    </span><span class="annot"><span class="annottext">TryFusion FusedKer -&gt; TryFusion FusedKer -&gt; TryFusion FusedKer
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">Names
-&gt; [VName] -&gt; SOAC SOACS -&gt; Names -&gt; FusedKer -&gt; TryFusion FusedKer
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#tryOptimizeKernel"><span class="hs-identifier hs-var">tryOptimizeKernel</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684455228"><span class="hs-identifier hs-var">unfus_nms</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455227"><span class="hs-identifier hs-var">outVars</span></a></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455226"><span class="hs-identifier hs-var">soac</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684455225"><span class="hs-identifier hs-var">consumed</span></a></span><span> </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455224"><span class="hs-identifier hs-var">ker</span></a></span><span>
</span><span id="line-235"></span><span>    </span><span class="annot"><span class="annottext">TryFusion FusedKer -&gt; TryFusion FusedKer -&gt; TryFusion FusedKer
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">Names
-&gt; [VName] -&gt; SOAC SOACS -&gt; Names -&gt; FusedKer -&gt; TryFusion FusedKer
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#fuseSOACwithKer"><span class="hs-identifier hs-var">fuseSOACwithKer</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684455228"><span class="hs-identifier hs-var">unfus_nms</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455227"><span class="hs-identifier hs-var">outVars</span></a></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455226"><span class="hs-identifier hs-var">soac</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684455225"><span class="hs-identifier hs-var">consumed</span></a></span><span> </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455224"><span class="hs-identifier hs-var">ker</span></a></span><span>
</span><span id="line-236"></span><span>    </span><span class="annot"><span class="annottext">TryFusion FusedKer -&gt; TryFusion FusedKer -&gt; TryFusion FusedKer
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">Names
-&gt; [VName] -&gt; SOAC SOACS -&gt; Names -&gt; FusedKer -&gt; TryFusion FusedKer
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#tryExposeInputs"><span class="hs-identifier hs-var">tryExposeInputs</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684455228"><span class="hs-identifier hs-var">unfus_nms</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455227"><span class="hs-identifier hs-var">outVars</span></a></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455226"><span class="hs-identifier hs-var">soac</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684455225"><span class="hs-identifier hs-var">consumed</span></a></span><span> </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455224"><span class="hs-identifier hs-var">ker</span></a></span><span>
</span><span id="line-237"></span><span>
</span><span id="line-238"></span><span id="local-6989586621684456171"><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#attemptFusion"><span class="hs-identifier hs-type">attemptFusion</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-239"></span><span>  </span><span class="annot"><a href="Futhark.MonadFreshNames.html#MonadFreshNames"><span class="hs-identifier hs-type">MonadFreshNames</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684456171"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-240"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-241"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-242"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#SOAC"><span class="hs-identifier hs-type">SOAC</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-243"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-244"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#FusedKer"><span class="hs-identifier hs-type">FusedKer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-245"></span><span>  </span><span class="annot"><a href="#local-6989586621684456171"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#FusedKer"><span class="hs-identifier hs-type">FusedKer</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-246"></span><span id="attemptFusion"><span class="annot"><span class="annottext">attemptFusion :: forall (m :: * -&gt; *).
MonadFreshNames m =&gt;
Names
-&gt; [VName] -&gt; SOAC SOACS -&gt; Names -&gt; FusedKer -&gt; m (Maybe FusedKer)
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#attemptFusion"><span class="hs-identifier hs-var hs-var">attemptFusion</span></a></span></span><span> </span><span id="local-6989586621684455214"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684455214"><span class="hs-identifier hs-var">unfus_nms</span></a></span></span><span> </span><span id="local-6989586621684455213"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455213"><span class="hs-identifier hs-var">outVars</span></a></span></span><span> </span><span id="local-6989586621684455212"><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455212"><span class="hs-identifier hs-var">soac</span></a></span></span><span> </span><span id="local-6989586621684455211"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684455211"><span class="hs-identifier hs-var">consumed</span></a></span></span><span> </span><span id="local-6989586621684455210"><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455210"><span class="hs-identifier hs-var">ker</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-247"></span><span>  </span><span class="annot"><span class="annottext">(FusedKer -&gt; FusedKer) -&gt; Maybe FusedKer -&gt; Maybe FusedKer
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">FusedKer -&gt; FusedKer
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#removeUnusedParamsFromKer"><span class="hs-identifier hs-var">removeUnusedParamsFromKer</span></a></span><span>
</span><span id="line-248"></span><span>    </span><span class="annot"><span class="annottext">(Maybe FusedKer -&gt; Maybe FusedKer)
-&gt; m (Maybe FusedKer) -&gt; m (Maybe FusedKer)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">TryFusion FusedKer -&gt; Scope SOACS -&gt; m (Maybe FusedKer)
forall (m :: * -&gt; *) a.
MonadFreshNames m =&gt;
TryFusion a -&gt; Scope SOACS -&gt; m (Maybe a)
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#tryFusion"><span class="hs-identifier hs-var">tryFusion</span></a></span><span>
</span><span id="line-249"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Names
-&gt; [VName] -&gt; SOAC SOACS -&gt; Names -&gt; FusedKer -&gt; TryFusion FusedKer
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#applyFusionRules"><span class="hs-identifier hs-var">applyFusionRules</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684455214"><span class="hs-identifier hs-var">unfus_nms</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455213"><span class="hs-identifier hs-var">outVars</span></a></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455212"><span class="hs-identifier hs-var">soac</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684455211"><span class="hs-identifier hs-var">consumed</span></a></span><span> </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455210"><span class="hs-identifier hs-var">ker</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-250"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FusedKer -&gt; Scope SOACS
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#kernelScope"><span class="hs-identifier hs-var hs-var">kernelScope</span></a></span><span> </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455210"><span class="hs-identifier hs-var">ker</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-251"></span><span>
</span><span id="line-252"></span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#removeUnusedParamsFromKer"><span class="hs-identifier hs-type">removeUnusedParamsFromKer</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#FusedKer"><span class="hs-identifier hs-type">FusedKer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#FusedKer"><span class="hs-identifier hs-type">FusedKer</span></a></span><span>
</span><span id="line-253"></span><span id="removeUnusedParamsFromKer"><span class="annot"><span class="annottext">removeUnusedParamsFromKer :: FusedKer -&gt; FusedKer
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#removeUnusedParamsFromKer"><span class="hs-identifier hs-var hs-var">removeUnusedParamsFromKer</span></a></span></span><span> </span><span id="local-6989586621684455208"><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455208"><span class="hs-identifier hs-var">ker</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-254"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455207"><span class="hs-identifier hs-var">soac</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-255"></span><span>    </span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Screma"><span class="hs-identifier hs-type">SOAC.Screma</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455208"><span class="hs-identifier hs-var">ker</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">fsoac :: SOAC SOACS
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#fsoac"><span class="hs-identifier hs-var">fsoac</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455205"><span class="hs-identifier hs-var">soac'</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-256"></span><span>    </span><span class="annot"><span class="annottext">SOAC SOACS
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455208"><span class="hs-identifier hs-var">ker</span></a></span><span>
</span><span id="line-257"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-258"></span><span>    </span><span id="local-6989586621684455207"><span class="annot"><span class="annottext">soac :: SOAC SOACS
</span><a href="#local-6989586621684455207"><span class="hs-identifier hs-var hs-var">soac</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FusedKer -&gt; SOAC SOACS
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#fsoac"><span class="hs-identifier hs-var hs-var">fsoac</span></a></span><span> </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455208"><span class="hs-identifier hs-var">ker</span></a></span><span>
</span><span id="line-259"></span><span>    </span><span id="local-6989586621684455204"><span class="annot"><span class="annottext">l :: Lambda SOACS
</span><a href="#local-6989586621684455204"><span class="hs-identifier hs-var hs-var">l</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SOAC SOACS -&gt; Lambda SOACS
forall rep. SOAC rep -&gt; Lambda rep
</span><a href="Futhark.Analysis.HORep.SOAC.html#lambda"><span class="hs-identifier hs-var">SOAC.lambda</span></a></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455207"><span class="hs-identifier hs-var">soac</span></a></span><span>
</span><span id="line-260"></span><span>    </span><span id="local-6989586621684455202"><span class="annot"><span class="annottext">inps :: [Input]
</span><a href="#local-6989586621684455202"><span class="hs-identifier hs-var hs-var">inps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SOAC SOACS -&gt; [Input]
forall rep. SOAC rep -&gt; [Input]
</span><a href="Futhark.Analysis.HORep.SOAC.html#inputs"><span class="hs-identifier hs-var">SOAC.inputs</span></a></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455207"><span class="hs-identifier hs-var">soac</span></a></span><span>
</span><span id="line-261"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684455201"><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684455201"><span class="hs-identifier hs-var">l'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684455200"><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684455200"><span class="hs-identifier hs-var">inps'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Lambda SOACS -&gt; [Input] -&gt; (Lambda SOACS, [Input])
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#removeUnusedParams"><span class="hs-identifier hs-var">removeUnusedParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684455204"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684455202"><span class="hs-identifier hs-var">inps</span></a></span><span>
</span><span id="line-262"></span><span>    </span><span id="local-6989586621684455205"><span class="annot"><span class="annottext">soac' :: SOAC SOACS
</span><a href="#local-6989586621684455205"><span class="hs-identifier hs-var hs-var">soac'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-263"></span><span>      </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684455201"><span class="hs-identifier hs-var">l'</span></a></span><span>
</span><span id="line-264"></span><span>        </span><span class="annot"><span class="annottext">Lambda SOACS -&gt; SOAC SOACS -&gt; SOAC SOACS
forall rep. Lambda rep -&gt; SOAC rep -&gt; SOAC rep
</span><a href="Futhark.Analysis.HORep.SOAC.html#setLambda"><span class="hs-operator hs-var">`SOAC.setLambda`</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684455200"><span class="hs-identifier hs-var">inps'</span></a></span><span> </span><span class="annot"><span class="annottext">[Input] -&gt; SOAC SOACS -&gt; SOAC SOACS
forall rep. [Input] -&gt; SOAC rep -&gt; SOAC rep
</span><a href="Futhark.Analysis.HORep.SOAC.html#setInputs"><span class="hs-operator hs-var">`SOAC.setInputs`</span></a></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455207"><span class="hs-identifier hs-var">soac</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-265"></span><span>
</span><span id="line-266"></span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#removeUnusedParams"><span class="hs-identifier hs-type">removeUnusedParams</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Input"><span class="hs-identifier hs-type">SOAC.Input</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Input"><span class="hs-identifier hs-type">SOAC.Input</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-267"></span><span id="removeUnusedParams"><span class="annot"><span class="annottext">removeUnusedParams :: Lambda SOACS -&gt; [Input] -&gt; (Lambda SOACS, [Input])
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#removeUnusedParams"><span class="hs-identifier hs-var hs-var">removeUnusedParams</span></a></span></span><span> </span><span id="local-6989586621684455196"><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684455196"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span id="local-6989586621684455195"><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684455195"><span class="hs-identifier hs-var">inps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-268"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684455196"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">lambdaParams :: [LParam SOACS]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var">lambdaParams</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
[LParam SOACS]
</span><a href="#local-6989586621684455193"><span class="hs-identifier hs-var">ps'</span></a></span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684455192"><span class="hs-identifier hs-var">inps'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-269"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-270"></span><span>    </span><span id="local-6989586621684455191"><span class="annot"><span class="annottext">pInps :: [(Param (TypeBase (ShapeBase SubExp) NoUniqueness), Input)]
</span><a href="#local-6989586621684455191"><span class="hs-identifier hs-var hs-var">pInps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
-&gt; [Input]
-&gt; [(Param (TypeBase (ShapeBase SubExp) NoUniqueness), Input)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda SOACS -&gt; [LParam SOACS]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684455196"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684455195"><span class="hs-identifier hs-var">inps</span></a></span><span>
</span><span id="line-271"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684455193"><span class="annot"><span class="annottext">[Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
</span><a href="#local-6989586621684455193"><span class="hs-identifier hs-var">ps'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684455192"><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684455192"><span class="hs-identifier hs-var">inps'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(Param (TypeBase (ShapeBase SubExp) NoUniqueness), Input)]
-&gt; ([Param (TypeBase (ShapeBase SubExp) NoUniqueness)], [Input])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(Param (TypeBase (ShapeBase SubExp) NoUniqueness), Input)]
 -&gt; ([Param (TypeBase (ShapeBase SubExp) NoUniqueness)], [Input]))
-&gt; [(Param (TypeBase (ShapeBase SubExp) NoUniqueness), Input)]
-&gt; ([Param (TypeBase (ShapeBase SubExp) NoUniqueness)], [Input])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((Param (TypeBase (ShapeBase SubExp) NoUniqueness), Input) -&gt; Bool)
-&gt; [(Param (TypeBase (ShapeBase SubExp) NoUniqueness), Input)]
-&gt; [(Param (TypeBase (ShapeBase SubExp) NoUniqueness), Input)]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param (TypeBase (ShapeBase SubExp) NoUniqueness) -&gt; Bool
</span><a href="#local-6989586621684455190"><span class="hs-identifier hs-var">used</span></a></span><span> </span><span class="annot"><span class="annottext">(Param (TypeBase (ShapeBase SubExp) NoUniqueness) -&gt; Bool)
-&gt; ((Param (TypeBase (ShapeBase SubExp) NoUniqueness), Input)
    -&gt; Param (TypeBase (ShapeBase SubExp) NoUniqueness))
-&gt; (Param (TypeBase (ShapeBase SubExp) NoUniqueness), Input)
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Param (TypeBase (ShapeBase SubExp) NoUniqueness), Input)
-&gt; Param (TypeBase (ShapeBase SubExp) NoUniqueness)
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Param (TypeBase (ShapeBase SubExp) NoUniqueness), Input)]
</span><a href="#local-6989586621684455191"><span class="hs-identifier hs-var">pInps</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(Param (TypeBase (ShapeBase SubExp) NoUniqueness), Input)]
</span><a href="#local-6989586621684455191"><span class="hs-identifier hs-var">pInps</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-272"></span><span>      </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684455189"><span class="annot"><span class="annottext">Param (TypeBase (ShapeBase SubExp) NoUniqueness)
</span><a href="#local-6989586621684455189"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684455188"><span class="annot"><span class="annottext">Input
</span><a href="#local-6989586621684455188"><span class="hs-identifier hs-var">inp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><span class="annottext">[(Param (TypeBase (ShapeBase SubExp) NoUniqueness), Input)]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><span class="annottext">Param (TypeBase (ShapeBase SubExp) NoUniqueness)
</span><a href="#local-6989586621684455189"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Input
</span><a href="#local-6989586621684455188"><span class="hs-identifier hs-var">inp</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-273"></span><span>      </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621684455187"><span class="annot"><span class="annottext">[Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
</span><a href="#local-6989586621684455187"><span class="hs-identifier hs-var">ps_</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684455186"><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684455186"><span class="hs-identifier hs-var">inps_</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(Param (TypeBase (ShapeBase SubExp) NoUniqueness), Input)]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
</span><a href="#local-6989586621684455187"><span class="hs-identifier hs-var">ps_</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684455186"><span class="hs-identifier hs-var">inps_</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-274"></span><span>    </span><span id="local-6989586621684455190"><span class="annot"><span class="annottext">used :: Param (TypeBase (ShapeBase SubExp) NoUniqueness) -&gt; Bool
</span><a href="#local-6989586621684455190"><span class="hs-identifier hs-var hs-var">used</span></a></span></span><span> </span><span id="local-6989586621684455185"><span class="annot"><span class="annottext">Param (TypeBase (ShapeBase SubExp) NoUniqueness)
</span><a href="#local-6989586621684455185"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Param (TypeBase (ShapeBase SubExp) NoUniqueness) -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param (TypeBase (ShapeBase SubExp) NoUniqueness)
</span><a href="#local-6989586621684455185"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#nameIn"><span class="hs-operator hs-var">`nameIn`</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684455182"><span class="hs-identifier hs-var">freeVars</span></a></span><span>
</span><span id="line-275"></span><span>    </span><span id="local-6989586621684455182"><span class="annot"><span class="annottext">freeVars :: Names
</span><a href="#local-6989586621684455182"><span class="hs-identifier hs-var hs-var">freeVars</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BodyT SOACS -&gt; Names
forall a. FreeIn a =&gt; a -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#freeIn"><span class="hs-identifier hs-var">freeIn</span></a></span><span> </span><span class="annot"><span class="annottext">(BodyT SOACS -&gt; Names) -&gt; BodyT SOACS -&gt; Names
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS -&gt; BodyT SOACS
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684455196"><span class="hs-identifier hs-var">l</span></a></span><span>
</span><span id="line-276"></span><span>
</span><span id="line-277"></span><span class="hs-comment">-- | Check that the consumer uses at least one output of the producer</span><span>
</span><span id="line-278"></span><span class="hs-comment">-- unmodified.</span><span>
</span><span id="line-279"></span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#mapFusionOK"><span class="hs-identifier hs-type">mapFusionOK</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#FusedKer"><span class="hs-identifier hs-type">FusedKer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-280"></span><span id="mapFusionOK"><span class="annot"><span class="annottext">mapFusionOK :: [VName] -&gt; FusedKer -&gt; Bool
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#mapFusionOK"><span class="hs-identifier hs-var hs-var">mapFusionOK</span></a></span></span><span> </span><span id="local-6989586621684455178"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455178"><span class="hs-identifier hs-var">outVars</span></a></span></span><span> </span><span id="local-6989586621684455177"><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455177"><span class="hs-identifier hs-var">ker</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Bool) -&gt; [VName] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; [VName] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455175"><span class="hs-identifier hs-var">inpIds</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455178"><span class="hs-identifier hs-var">outVars</span></a></span><span>
</span><span id="line-281"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-282"></span><span>    </span><span id="local-6989586621684455175"><span class="annot"><span class="annottext">inpIds :: [VName]
</span><a href="#local-6989586621684455175"><span class="hs-identifier hs-var hs-var">inpIds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Input -&gt; Maybe VName) -&gt; [Input] -&gt; [VName]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">mapMaybe</span></span><span> </span><span class="annot"><span class="annottext">Input -&gt; Maybe VName
</span><a href="Futhark.Analysis.HORep.SOAC.html#isVarishInput"><span class="hs-identifier hs-var">SOAC.isVarishInput</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FusedKer -&gt; [Input]
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#inputs"><span class="hs-identifier hs-var">inputs</span></a></span><span> </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455177"><span class="hs-identifier hs-var">ker</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-283"></span><span>
</span><span id="line-284"></span><span class="hs-comment">-- | Check that the consumer uses all the outputs of the producer unmodified.</span><span>
</span><span id="line-285"></span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#mapWriteFusionOK"><span class="hs-identifier hs-type">mapWriteFusionOK</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#FusedKer"><span class="hs-identifier hs-type">FusedKer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-286"></span><span id="mapWriteFusionOK"><span class="annot"><span class="annottext">mapWriteFusionOK :: [VName] -&gt; FusedKer -&gt; Bool
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#mapWriteFusionOK"><span class="hs-identifier hs-var hs-var">mapWriteFusionOK</span></a></span></span><span> </span><span id="local-6989586621684455171"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455171"><span class="hs-identifier hs-var">outVars</span></a></span></span><span> </span><span id="local-6989586621684455170"><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455170"><span class="hs-identifier hs-var">ker</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Bool) -&gt; [VName] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; [VName] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455168"><span class="hs-identifier hs-var">inpIds</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455171"><span class="hs-identifier hs-var">outVars</span></a></span><span>
</span><span id="line-287"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-288"></span><span>    </span><span id="local-6989586621684455168"><span class="annot"><span class="annottext">inpIds :: [VName]
</span><a href="#local-6989586621684455168"><span class="hs-identifier hs-var hs-var">inpIds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Input -&gt; Maybe VName) -&gt; [Input] -&gt; [VName]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">mapMaybe</span></span><span> </span><span class="annot"><span class="annottext">Input -&gt; Maybe VName
</span><a href="Futhark.Analysis.HORep.SOAC.html#isVarishInput"><span class="hs-identifier hs-var">SOAC.isVarishInput</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FusedKer -&gt; [Input]
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#inputs"><span class="hs-identifier hs-var">inputs</span></a></span><span> </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455170"><span class="hs-identifier hs-var">ker</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-289"></span><span>
</span><span id="line-290"></span><span class="hs-comment">-- | The brain of this module: Fusing a SOAC with a Kernel.</span><span>
</span><span id="line-291"></span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#fuseSOACwithKer"><span class="hs-identifier hs-type">fuseSOACwithKer</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-292"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-293"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-294"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#SOAC"><span class="hs-identifier hs-type">SOAC</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-295"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-296"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#FusedKer"><span class="hs-identifier hs-type">FusedKer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-297"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#TryFusion"><span class="hs-identifier hs-type">TryFusion</span></a></span><span> </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#FusedKer"><span class="hs-identifier hs-type">FusedKer</span></a></span><span>
</span><span id="line-298"></span><span id="fuseSOACwithKer"><span class="annot"><span class="annottext">fuseSOACwithKer :: Names
-&gt; [VName] -&gt; SOAC SOACS -&gt; Names -&gt; FusedKer -&gt; TryFusion FusedKer
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#fuseSOACwithKer"><span class="hs-identifier hs-var hs-var">fuseSOACwithKer</span></a></span></span><span> </span><span id="local-6989586621684455167"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684455167"><span class="hs-identifier hs-var">unfus_set</span></a></span></span><span> </span><span id="local-6989586621684455166"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455166"><span class="hs-identifier hs-var">outVars</span></a></span></span><span> </span><span id="local-6989586621684455165"><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455165"><span class="hs-identifier hs-var">soac_p</span></a></span></span><span> </span><span id="local-6989586621684455164"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684455164"><span class="hs-identifier hs-var">soac_p_consumed</span></a></span></span><span> </span><span id="local-6989586621684455163"><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455163"><span class="hs-identifier hs-var">ker</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-299"></span><span>  </span><span class="hs-comment">-- We are fusing soac_p into soac_c, i.e, the output of soac_p is going</span><span>
</span><span id="line-300"></span><span>  </span><span class="hs-comment">-- into soac_c.</span><span>
</span><span id="line-301"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684455162"><span class="annot"><span class="annottext">soac_c :: SOAC SOACS
</span><a href="#local-6989586621684455162"><span class="hs-identifier hs-var hs-var">soac_c</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FusedKer -&gt; SOAC SOACS
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#fsoac"><span class="hs-identifier hs-var hs-var">fsoac</span></a></span><span> </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455163"><span class="hs-identifier hs-var">ker</span></a></span><span>
</span><span id="line-302"></span><span>      </span><span id="local-6989586621684455161"><span class="annot"><span class="annottext">inp_p_arr :: [Input]
</span><a href="#local-6989586621684455161"><span class="hs-identifier hs-var hs-var">inp_p_arr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SOAC SOACS -&gt; [Input]
forall rep. SOAC rep -&gt; [Input]
</span><a href="Futhark.Analysis.HORep.SOAC.html#inputs"><span class="hs-identifier hs-var">SOAC.inputs</span></a></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455165"><span class="hs-identifier hs-var">soac_p</span></a></span><span>
</span><span id="line-303"></span><span>      </span><span id="local-6989586621684455160"><span class="annot"><span class="annottext">horizFuse :: Bool
</span><a href="#local-6989586621684455160"><span class="hs-identifier hs-var hs-var">horizFuse</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-304"></span><span>        </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684455167"><span class="hs-identifier hs-var">unfus_set</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-305"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS -&gt; SubExp
forall rep. SOAC rep -&gt; SubExp
</span><a href="Futhark.Analysis.HORep.SOAC.html#width"><span class="hs-identifier hs-var">SOAC.width</span></a></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455165"><span class="hs-identifier hs-var">soac_p</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; SubExp -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS -&gt; SubExp
forall rep. SOAC rep -&gt; SubExp
</span><a href="Futhark.Analysis.HORep.SOAC.html#width"><span class="hs-identifier hs-var">SOAC.width</span></a></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455162"><span class="hs-identifier hs-var">soac_c</span></a></span><span>
</span><span id="line-306"></span><span>      </span><span id="local-6989586621684455156"><span class="annot"><span class="annottext">inp_c_arr :: [Input]
</span><a href="#local-6989586621684455156"><span class="hs-identifier hs-var hs-var">inp_c_arr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SOAC SOACS -&gt; [Input]
forall rep. SOAC rep -&gt; [Input]
</span><a href="Futhark.Analysis.HORep.SOAC.html#inputs"><span class="hs-identifier hs-var">SOAC.inputs</span></a></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455162"><span class="hs-identifier hs-var">soac_c</span></a></span><span>
</span><span id="line-307"></span><span>      </span><span id="local-6989586621684455155"><span class="annot"><span class="annottext">lam_p :: Lambda SOACS
</span><a href="#local-6989586621684455155"><span class="hs-identifier hs-var hs-var">lam_p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SOAC SOACS -&gt; Lambda SOACS
forall rep. SOAC rep -&gt; Lambda rep
</span><a href="Futhark.Analysis.HORep.SOAC.html#lambda"><span class="hs-identifier hs-var">SOAC.lambda</span></a></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455165"><span class="hs-identifier hs-var">soac_p</span></a></span><span>
</span><span id="line-308"></span><span>      </span><span id="local-6989586621684455154"><span class="annot"><span class="annottext">lam_c :: Lambda SOACS
</span><a href="#local-6989586621684455154"><span class="hs-identifier hs-var hs-var">lam_c</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SOAC SOACS -&gt; Lambda SOACS
forall rep. SOAC rep -&gt; Lambda rep
</span><a href="Futhark.Analysis.HORep.SOAC.html#lambda"><span class="hs-identifier hs-var">SOAC.lambda</span></a></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455162"><span class="hs-identifier hs-var">soac_c</span></a></span><span>
</span><span id="line-309"></span><span>      </span><span id="local-6989586621684455153"><span class="annot"><span class="annottext">w :: SubExp
</span><a href="#local-6989586621684455153"><span class="hs-identifier hs-var hs-var">w</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SOAC SOACS -&gt; SubExp
forall rep. SOAC rep -&gt; SubExp
</span><a href="Futhark.Analysis.HORep.SOAC.html#width"><span class="hs-identifier hs-var">SOAC.width</span></a></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455165"><span class="hs-identifier hs-var">soac_p</span></a></span><span>
</span><span id="line-310"></span><span>      </span><span id="local-6989586621684455152"><span class="annot"><span class="annottext">returned_outvars :: [VName]
</span><a href="#local-6989586621684455152"><span class="hs-identifier hs-var hs-var">returned_outvars</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Bool) -&gt; [VName] -&gt; [VName]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#nameIn"><span class="hs-operator hs-var">`nameIn`</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684455167"><span class="hs-identifier hs-var">unfus_set</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455166"><span class="hs-identifier hs-var">outVars</span></a></span><span>
</span><span id="line-311"></span><span>      </span><span id="local-6989586621684455151"><span class="annot"><span class="annottext">success :: [VName] -&gt; SOAC SOACS -&gt; TryFusion FusedKer
</span><a href="#local-6989586621684455151"><span class="hs-identifier hs-var hs-var">success</span></a></span></span><span> </span><span id="local-6989586621684455150"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455150"><span class="hs-identifier hs-var">res_outnms</span></a></span></span><span> </span><span id="local-6989586621684455149"><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455149"><span class="hs-identifier hs-var">res_soac</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-312"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684455148"><span class="annot"><span class="annottext">fusedVars_new :: [VName]
</span><a href="#local-6989586621684455148"><span class="hs-identifier hs-var hs-var">fusedVars_new</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FusedKer -&gt; [VName]
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#fusedVars"><span class="hs-identifier hs-var hs-var">fusedVars</span></a></span><span> </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455163"><span class="hs-identifier hs-var">ker</span></a></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455166"><span class="hs-identifier hs-var">outVars</span></a></span><span>
</span><span id="line-313"></span><span>        </span><span class="hs-comment">-- Avoid name duplication, because the producer lambda is not</span><span>
</span><span id="line-314"></span><span>        </span><span class="hs-comment">-- removed from the program until much later.</span><span>
</span><span id="line-315"></span><span>        </span><span id="local-6989586621684455147"><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684455147"><span class="hs-identifier hs-var">uniq_lam</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Lambda SOACS -&gt; TryFusion (Lambda SOACS)
forall rep (m :: * -&gt; *).
(Renameable rep, MonadFreshNames m) =&gt;
Lambda rep -&gt; m (Lambda rep)
</span><a href="Futhark.Transform.Rename.html#renameLambda"><span class="hs-identifier hs-var">renameLambda</span></a></span><span> </span><span class="annot"><span class="annottext">(Lambda SOACS -&gt; TryFusion (Lambda SOACS))
-&gt; Lambda SOACS -&gt; TryFusion (Lambda SOACS)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS -&gt; Lambda SOACS
forall rep. SOAC rep -&gt; Lambda rep
</span><a href="Futhark.Analysis.HORep.SOAC.html#lambda"><span class="hs-identifier hs-var">SOAC.lambda</span></a></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455149"><span class="hs-identifier hs-var">res_soac</span></a></span><span>
</span><span id="line-316"></span><span>        </span><span class="annot"><span class="annottext">FusedKer -&gt; TryFusion FusedKer
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(FusedKer -&gt; TryFusion FusedKer) -&gt; FusedKer -&gt; TryFusion FusedKer
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-317"></span><span>          </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455163"><span class="hs-identifier hs-var">ker</span></a></span><span>
</span><span id="line-318"></span><span>            </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fsoac :: SOAC SOACS
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#fsoac"><span class="hs-identifier hs-var">fsoac</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684455147"><span class="hs-identifier hs-var">uniq_lam</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS -&gt; SOAC SOACS -&gt; SOAC SOACS
forall rep. Lambda rep -&gt; SOAC rep -&gt; SOAC rep
</span><a href="Futhark.Analysis.HORep.SOAC.html#setLambda"><span class="hs-operator hs-var">`SOAC.setLambda`</span></a></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455149"><span class="hs-identifier hs-var">res_soac</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-319"></span><span>              </span><span class="annot"><span class="annottext">fusedVars :: [VName]
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#fusedVars"><span class="hs-identifier hs-var">fusedVars</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455148"><span class="hs-identifier hs-var">fusedVars_new</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-320"></span><span>              </span><span class="annot"><span class="annottext">inplace :: Names
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#inplace"><span class="hs-identifier hs-var">inplace</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FusedKer -&gt; Names
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#inplace"><span class="hs-identifier hs-var hs-var">inplace</span></a></span><span> </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455163"><span class="hs-identifier hs-var">ker</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684455164"><span class="hs-identifier hs-var">soac_p_consumed</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-321"></span><span>              </span><span class="annot"><span class="annottext">fusedConsumed :: Names
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#fusedConsumed"><span class="hs-identifier hs-var">fusedConsumed</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FusedKer -&gt; Names
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#fusedConsumed"><span class="hs-identifier hs-var hs-var">fusedConsumed</span></a></span><span> </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455163"><span class="hs-identifier hs-var">ker</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684455164"><span class="hs-identifier hs-var">soac_p_consumed</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-322"></span><span>              </span><span class="annot"><span class="annottext">outNames :: [VName]
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#outNames"><span class="hs-identifier hs-var">outNames</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455150"><span class="hs-identifier hs-var">res_outnms</span></a></span><span>
</span><span id="line-323"></span><span>            </span><span class="hs-special">}</span><span>
</span><span id="line-324"></span><span>
</span><span id="line-325"></span><span>  </span><span id="local-6989586621684455146"><span class="annot"><span class="annottext">[(VName, Ident)]
</span><a href="#local-6989586621684455146"><span class="hs-identifier hs-var">outPairs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(VName, TypeBase (ShapeBase SubExp) NoUniqueness)]
-&gt; ((VName, TypeBase (ShapeBase SubExp) NoUniqueness)
    -&gt; TryFusion (VName, Ident))
-&gt; TryFusion [(VName, Ident)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName]
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; [(VName, TypeBase (ShapeBase SubExp) NoUniqueness)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455166"><span class="hs-identifier hs-var">outVars</span></a></span><span> </span><span class="annot"><span class="annottext">([TypeBase (ShapeBase SubExp) NoUniqueness]
 -&gt; [(VName, TypeBase (ShapeBase SubExp) NoUniqueness)])
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; [(VName, TypeBase (ShapeBase SubExp) NoUniqueness)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(TypeBase (ShapeBase SubExp) NoUniqueness
 -&gt; TypeBase (ShapeBase SubExp) NoUniqueness)
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TypeBase (ShapeBase SubExp) NoUniqueness
-&gt; TypeBase (ShapeBase SubExp) NoUniqueness
forall u.
TypeBase (ShapeBase SubExp) u -&gt; TypeBase (ShapeBase SubExp) u
</span><a href="Futhark.IR.Prop.Types.html#rowType"><span class="hs-identifier hs-var">rowType</span></a></span><span> </span><span class="annot"><span class="annottext">([TypeBase (ShapeBase SubExp) NoUniqueness]
 -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness])
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
forall rep. SOAC rep -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="Futhark.Analysis.HORep.SOAC.html#typeOf"><span class="hs-identifier hs-var">SOAC.typeOf</span></a></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455165"><span class="hs-identifier hs-var">soac_p</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((VName, TypeBase (ShapeBase SubExp) NoUniqueness)
  -&gt; TryFusion (VName, Ident))
 -&gt; TryFusion [(VName, Ident)])
-&gt; ((VName, TypeBase (ShapeBase SubExp) NoUniqueness)
    -&gt; TryFusion (VName, Ident))
-&gt; TryFusion [(VName, Ident)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684455144"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684455144"><span class="hs-identifier hs-var">outVar</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684455143"><span class="annot"><span class="annottext">TypeBase (ShapeBase SubExp) NoUniqueness
</span><a href="#local-6989586621684455143"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-326"></span><span>    </span><span id="local-6989586621684455142"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684455142"><span class="hs-identifier hs-var">outVar'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; TryFusion VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; String -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; TryFusion VName) -&gt; String -&gt; TryFusion VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; String
</span><a href="Language.Futhark.Core.html#baseString"><span class="hs-identifier hs-var">baseString</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684455144"><span class="hs-identifier hs-var">outVar</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_elem&quot;</span></span><span>
</span><span id="line-327"></span><span>    </span><span class="annot"><span class="annottext">(VName, Ident) -&gt; TryFusion (VName, Ident)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684455144"><span class="hs-identifier hs-var">outVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VName -&gt; TypeBase (ShapeBase SubExp) NoUniqueness -&gt; Ident
</span><a href="Futhark.IR.Syntax.Core.html#Ident"><span class="hs-identifier hs-var">Ident</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684455142"><span class="hs-identifier hs-var">outVar'</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase (ShapeBase SubExp) NoUniqueness
</span><a href="#local-6989586621684455143"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-328"></span><span>
</span><span id="line-329"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684455140"><span class="annot"><span class="annottext">mapLikeFusionCheck :: ([VName], Lambda SOACS, [Input])
</span><a href="#local-6989586621684455140"><span class="hs-identifier hs-var hs-var">mapLikeFusionCheck</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-330"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684455139"><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684455139"><span class="hs-identifier hs-var">res_lam</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684455138"><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684455138"><span class="hs-identifier hs-var">new_inp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Names
-&gt; Lambda SOACS
-&gt; [Input]
-&gt; [(VName, Ident)]
-&gt; Lambda SOACS
-&gt; [Input]
-&gt; (Lambda SOACS, [Input])
forall rep.
Buildable rep =&gt;
Names
-&gt; Lambda rep
-&gt; [Input]
-&gt; [(VName, Ident)]
-&gt; Lambda rep
-&gt; [Input]
-&gt; (Lambda rep, [Input])
</span><a href="Futhark.Optimise.Fusion.Composing.html#fuseMaps"><span class="hs-identifier hs-var">fuseMaps</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684455167"><span class="hs-identifier hs-var">unfus_set</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684455155"><span class="hs-identifier hs-var">lam_p</span></a></span><span> </span><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684455161"><span class="hs-identifier hs-var">inp_p_arr</span></a></span><span> </span><span class="annot"><span class="annottext">[(VName, Ident)]
</span><a href="#local-6989586621684455146"><span class="hs-identifier hs-var">outPairs</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684455154"><span class="hs-identifier hs-var">lam_c</span></a></span><span> </span><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684455156"><span class="hs-identifier hs-var">inp_c_arr</span></a></span><span>
</span><span id="line-331"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621684455136"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455136"><span class="hs-identifier hs-var">extra_nms</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684455135"><span class="annot"><span class="annottext">[TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="#local-6989586621684455135"><span class="hs-identifier hs-var">extra_rtps</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-332"></span><span>              </span><span class="annot"><span class="annottext">[(VName, TypeBase (ShapeBase SubExp) NoUniqueness)]
-&gt; ([VName], [TypeBase (ShapeBase SubExp) NoUniqueness])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(VName, TypeBase (ShapeBase SubExp) NoUniqueness)]
 -&gt; ([VName], [TypeBase (ShapeBase SubExp) NoUniqueness]))
-&gt; [(VName, TypeBase (ShapeBase SubExp) NoUniqueness)]
-&gt; ([VName], [TypeBase (ShapeBase SubExp) NoUniqueness])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-333"></span><span>                </span><span class="annot"><span class="annottext">((VName, TypeBase (ShapeBase SubExp) NoUniqueness) -&gt; Bool)
-&gt; [(VName, TypeBase (ShapeBase SubExp) NoUniqueness)]
-&gt; [(VName, TypeBase (ShapeBase SubExp) NoUniqueness)]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#nameIn"><span class="hs-operator hs-var">`nameIn`</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684455167"><span class="hs-identifier hs-var">unfus_set</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Bool)
-&gt; ((VName, TypeBase (ShapeBase SubExp) NoUniqueness) -&gt; VName)
-&gt; (VName, TypeBase (ShapeBase SubExp) NoUniqueness)
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(VName, TypeBase (ShapeBase SubExp) NoUniqueness) -&gt; VName
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(VName, TypeBase (ShapeBase SubExp) NoUniqueness)]
 -&gt; [(VName, TypeBase (ShapeBase SubExp) NoUniqueness)])
-&gt; [(VName, TypeBase (ShapeBase SubExp) NoUniqueness)]
-&gt; [(VName, TypeBase (ShapeBase SubExp) NoUniqueness)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-334"></span><span>                  </span><span class="annot"><span class="annottext">[VName]
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; [(VName, TypeBase (ShapeBase SubExp) NoUniqueness)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455166"><span class="hs-identifier hs-var">outVars</span></a></span><span> </span><span class="annot"><span class="annottext">([TypeBase (ShapeBase SubExp) NoUniqueness]
 -&gt; [(VName, TypeBase (ShapeBase SubExp) NoUniqueness)])
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; [(VName, TypeBase (ShapeBase SubExp) NoUniqueness)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(TypeBase (ShapeBase SubExp) NoUniqueness
 -&gt; TypeBase (ShapeBase SubExp) NoUniqueness)
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
-&gt; TypeBase (ShapeBase SubExp) NoUniqueness
-&gt; TypeBase (ShapeBase SubExp) NoUniqueness
forall u.
Int
-&gt; TypeBase (ShapeBase SubExp) u -&gt; TypeBase (ShapeBase SubExp) u
</span><a href="Futhark.IR.Prop.Types.html#stripArray"><span class="hs-identifier hs-var">stripArray</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([TypeBase (ShapeBase SubExp) NoUniqueness]
 -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness])
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
forall rep. SOAC rep -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="Futhark.Analysis.HORep.SOAC.html#typeOf"><span class="hs-identifier hs-var">SOAC.typeOf</span></a></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455165"><span class="hs-identifier hs-var">soac_p</span></a></span><span>
</span><span id="line-335"></span><span>            </span><span id="local-6989586621684455133"><span class="annot"><span class="annottext">res_lam' :: Lambda SOACS
</span><a href="#local-6989586621684455133"><span class="hs-identifier hs-var hs-var">res_lam'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684455139"><span class="hs-identifier hs-var">res_lam</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">lambdaReturnType :: [TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var">lambdaReturnType</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Lambda SOACS -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
forall rep.
LambdaT rep -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684455139"><span class="hs-identifier hs-var">res_lam</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="#local-6989586621684455135"><span class="hs-identifier hs-var">extra_rtps</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-336"></span><span>         </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455136"><span class="hs-identifier hs-var">extra_nms</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684455133"><span class="hs-identifier hs-var">res_lam'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684455138"><span class="hs-identifier hs-var">new_inp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-337"></span><span>
</span><span id="line-338"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; TryFusion () -&gt; TryFusion ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684455160"><span class="hs-identifier hs-var">horizFuse</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ArrayTransforms -&gt; Bool
</span><a href="Futhark.Analysis.HORep.SOAC.html#nullTransforms"><span class="hs-identifier hs-var">SOAC.nullTransforms</span></a></span><span> </span><span class="annot"><span class="annottext">(ArrayTransforms -&gt; Bool) -&gt; ArrayTransforms -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FusedKer -&gt; ArrayTransforms
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#outputTransform"><span class="hs-identifier hs-var hs-var">outputTransform</span></a></span><span> </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455163"><span class="hs-identifier hs-var">ker</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TryFusion () -&gt; TryFusion ()) -&gt; TryFusion () -&gt; TryFusion ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-339"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; TryFusion ()
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Horizontal fusion is invalid in the presence of output transforms.&quot;</span></span><span>
</span><span id="line-340"></span><span>
</span><span id="line-341"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455162"><span class="hs-identifier hs-var">soac_c</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455165"><span class="hs-identifier hs-var">soac_p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-342"></span><span>    </span><span class="annot"><span class="annottext">(SOAC SOACS, SOAC SOACS)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">SOAC SOACS -&gt; SubExp
forall rep. SOAC rep -&gt; SubExp
</span><a href="Futhark.Analysis.HORep.SOAC.html#width"><span class="hs-identifier hs-var">SOAC.width</span></a></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455165"><span class="hs-identifier hs-var">soac_p</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; SubExp -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS -&gt; SubExp
forall rep. SOAC rep -&gt; SubExp
</span><a href="Futhark.Analysis.HORep.SOAC.html#width"><span class="hs-identifier hs-var">SOAC.width</span></a></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455162"><span class="hs-identifier hs-var">soac_c</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; TryFusion FusedKer
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;SOAC widths must match.&quot;</span></span><span>
</span><span id="line-343"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Screma"><span class="hs-identifier hs-type">SOAC.Screma</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#ScremaForm"><span class="hs-identifier hs-type">ScremaForm</span></a></span><span> </span><span id="local-6989586621684455128"><span class="annot"><span class="annottext">[Scan SOACS]
</span><a href="#local-6989586621684455128"><span class="hs-identifier hs-var">scans_c</span></a></span></span><span> </span><span id="local-6989586621684455127"><span class="annot"><span class="annottext">[Reduce SOACS]
</span><a href="#local-6989586621684455127"><span class="hs-identifier hs-var">reds_c</span></a></span></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Input]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span>
</span><span id="line-344"></span><span>      </span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Screma"><span class="hs-identifier hs-type">SOAC.Screma</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#ScremaForm"><span class="hs-identifier hs-type">ScremaForm</span></a></span><span> </span><span id="local-6989586621684455126"><span class="annot"><span class="annottext">[Scan SOACS]
</span><a href="#local-6989586621684455126"><span class="hs-identifier hs-var">scans_p</span></a></span></span><span> </span><span id="local-6989586621684455125"><span class="annot"><span class="annottext">[Reduce SOACS]
</span><a href="#local-6989586621684455125"><span class="hs-identifier hs-var">reds_p</span></a></span></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Input]
</span><span class="hs-identifier">_</span></span><span>
</span><span id="line-345"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-346"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; FusedKer -&gt; Bool
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#mapFusionOK"><span class="hs-identifier hs-var">mapFusionOK</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; [VName] -&gt; [VName]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Scan SOACS] -&gt; Int
forall rep. [Scan rep] -&gt; Int
</span><a href="Futhark.IR.SOACS.SOAC.html#scanResults"><span class="hs-identifier hs-var">Futhark.scanResults</span></a></span><span> </span><span class="annot"><span class="annottext">[Scan SOACS]
</span><a href="#local-6989586621684455126"><span class="hs-identifier hs-var">scans_p</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">[Reduce SOACS] -&gt; Int
forall rep. [Reduce rep] -&gt; Int
</span><a href="Futhark.IR.SOACS.SOAC.html#redResults"><span class="hs-identifier hs-var">Futhark.redResults</span></a></span><span> </span><span class="annot"><span class="annottext">[Reduce SOACS]
</span><a href="#local-6989586621684455125"><span class="hs-identifier hs-var">reds_p</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455166"><span class="hs-identifier hs-var">outVars</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455163"><span class="hs-identifier hs-var">ker</span></a></span><span>
</span><span id="line-347"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684455160"><span class="hs-identifier hs-var">horizFuse</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-348"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684455120"><span class="annot"><span class="annottext">red_nes_p :: [SubExp]
</span><a href="#local-6989586621684455120"><span class="hs-identifier hs-var hs-var">red_nes_p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Reduce SOACS -&gt; [SubExp]) -&gt; [Reduce SOACS] -&gt; [SubExp]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="annot"><span class="annottext">Reduce SOACS -&gt; [SubExp]
forall rep. Reduce rep -&gt; [SubExp]
</span><a href="Futhark.IR.SOACS.SOAC.html#redNeutral"><span class="hs-identifier hs-var hs-var">redNeutral</span></a></span><span> </span><span class="annot"><span class="annottext">[Reduce SOACS]
</span><a href="#local-6989586621684455125"><span class="hs-identifier hs-var">reds_p</span></a></span><span>
</span><span id="line-349"></span><span>              </span><span id="local-6989586621684455117"><span class="annot"><span class="annottext">red_nes_c :: [SubExp]
</span><a href="#local-6989586621684455117"><span class="hs-identifier hs-var hs-var">red_nes_c</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Reduce SOACS -&gt; [SubExp]) -&gt; [Reduce SOACS] -&gt; [SubExp]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="annot"><span class="annottext">Reduce SOACS -&gt; [SubExp]
forall rep. Reduce rep -&gt; [SubExp]
</span><a href="Futhark.IR.SOACS.SOAC.html#redNeutral"><span class="hs-identifier hs-var hs-var">redNeutral</span></a></span><span> </span><span class="annot"><span class="annottext">[Reduce SOACS]
</span><a href="#local-6989586621684455127"><span class="hs-identifier hs-var">reds_c</span></a></span><span>
</span><span id="line-350"></span><span>              </span><span id="local-6989586621684455116"><span class="annot"><span class="annottext">scan_nes_p :: [SubExp]
</span><a href="#local-6989586621684455116"><span class="hs-identifier hs-var hs-var">scan_nes_p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Scan SOACS -&gt; [SubExp]) -&gt; [Scan SOACS] -&gt; [SubExp]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="annot"><span class="annottext">Scan SOACS -&gt; [SubExp]
forall rep. Scan rep -&gt; [SubExp]
</span><a href="Futhark.IR.SOACS.SOAC.html#scanNeutral"><span class="hs-identifier hs-var hs-var">scanNeutral</span></a></span><span> </span><span class="annot"><span class="annottext">[Scan SOACS]
</span><a href="#local-6989586621684455126"><span class="hs-identifier hs-var">scans_p</span></a></span><span>
</span><span id="line-351"></span><span>              </span><span id="local-6989586621684455114"><span class="annot"><span class="annottext">scan_nes_c :: [SubExp]
</span><a href="#local-6989586621684455114"><span class="hs-identifier hs-var hs-var">scan_nes_c</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Scan SOACS -&gt; [SubExp]) -&gt; [Scan SOACS] -&gt; [SubExp]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="annot"><span class="annottext">Scan SOACS -&gt; [SubExp]
forall rep. Scan rep -&gt; [SubExp]
</span><a href="Futhark.IR.SOACS.SOAC.html#scanNeutral"><span class="hs-identifier hs-var hs-var">scanNeutral</span></a></span><span> </span><span class="annot"><span class="annottext">[Scan SOACS]
</span><a href="#local-6989586621684455128"><span class="hs-identifier hs-var">scans_c</span></a></span><span>
</span><span id="line-352"></span><span>              </span><span class="hs-special">(</span><span id="local-6989586621684455113"><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684455113"><span class="hs-identifier hs-var">res_lam'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684455112"><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684455112"><span class="hs-identifier hs-var">new_inp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-353"></span><span>                </span><span class="annot"><span class="annottext">Names
-&gt; [VName]
-&gt; Lambda SOACS
-&gt; [SubExp]
-&gt; [SubExp]
-&gt; [Input]
-&gt; [(VName, Ident)]
-&gt; Lambda SOACS
-&gt; [SubExp]
-&gt; [SubExp]
-&gt; [Input]
-&gt; (Lambda SOACS, [Input])
forall rep.
Buildable rep =&gt;
Names
-&gt; [VName]
-&gt; Lambda rep
-&gt; [SubExp]
-&gt; [SubExp]
-&gt; [Input]
-&gt; [(VName, Ident)]
-&gt; Lambda rep
-&gt; [SubExp]
-&gt; [SubExp]
-&gt; [Input]
-&gt; (Lambda rep, [Input])
</span><a href="Futhark.Optimise.Fusion.Composing.html#fuseRedomap"><span class="hs-identifier hs-var">fuseRedomap</span></a></span><span>
</span><span id="line-354"></span><span>                  </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684455167"><span class="hs-identifier hs-var">unfus_set</span></a></span><span>
</span><span id="line-355"></span><span>                  </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455166"><span class="hs-identifier hs-var">outVars</span></a></span><span>
</span><span id="line-356"></span><span>                  </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684455155"><span class="hs-identifier hs-var">lam_p</span></a></span><span>
</span><span id="line-357"></span><span>                  </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684455116"><span class="hs-identifier hs-var">scan_nes_p</span></a></span><span>
</span><span id="line-358"></span><span>                  </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684455120"><span class="hs-identifier hs-var">red_nes_p</span></a></span><span>
</span><span id="line-359"></span><span>                  </span><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684455161"><span class="hs-identifier hs-var">inp_p_arr</span></a></span><span>
</span><span id="line-360"></span><span>                  </span><span class="annot"><span class="annottext">[(VName, Ident)]
</span><a href="#local-6989586621684455146"><span class="hs-identifier hs-var">outPairs</span></a></span><span>
</span><span id="line-361"></span><span>                  </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684455154"><span class="hs-identifier hs-var">lam_c</span></a></span><span>
</span><span id="line-362"></span><span>                  </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684455114"><span class="hs-identifier hs-var">scan_nes_c</span></a></span><span>
</span><span id="line-363"></span><span>                  </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684455117"><span class="hs-identifier hs-var">red_nes_c</span></a></span><span>
</span><span id="line-364"></span><span>                  </span><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684455156"><span class="hs-identifier hs-var">inp_c_arr</span></a></span><span>
</span><span id="line-365"></span><span>              </span><span class="hs-special">(</span><span id="local-6989586621684455110"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455110"><span class="hs-identifier hs-var">soac_p_scanout</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684455109"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455109"><span class="hs-identifier hs-var">soac_p_redout</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684455108"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455108"><span class="hs-identifier hs-var">_soac_p_mapout</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-366"></span><span>                </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; [VName] -&gt; ([VName], [VName], [VName])
forall a. Int -&gt; Int -&gt; [a] -&gt; ([a], [a], [a])
</span><a href="Futhark.Util.html#splitAt3"><span class="hs-identifier hs-var">splitAt3</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684455116"><span class="hs-identifier hs-var">scan_nes_p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684455120"><span class="hs-identifier hs-var">red_nes_p</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455166"><span class="hs-identifier hs-var">outVars</span></a></span><span>
</span><span id="line-367"></span><span>              </span><span class="hs-special">(</span><span id="local-6989586621684455107"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455107"><span class="hs-identifier hs-var">soac_c_scanout</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684455106"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455106"><span class="hs-identifier hs-var">soac_c_redout</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684455105"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455105"><span class="hs-identifier hs-var">soac_c_mapout</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-368"></span><span>                </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; [VName] -&gt; ([VName], [VName], [VName])
forall a. Int -&gt; Int -&gt; [a] -&gt; ([a], [a], [a])
</span><a href="Futhark.Util.html#splitAt3"><span class="hs-identifier hs-var">splitAt3</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684455114"><span class="hs-identifier hs-var">scan_nes_c</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684455117"><span class="hs-identifier hs-var">red_nes_c</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; ([VName], [VName], [VName]))
-&gt; [VName] -&gt; ([VName], [VName], [VName])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FusedKer -&gt; [VName]
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#outNames"><span class="hs-identifier hs-var hs-var">outNames</span></a></span><span> </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455163"><span class="hs-identifier hs-var">ker</span></a></span><span>
</span><span id="line-369"></span><span>              </span><span id="local-6989586621684455104"><span class="annot"><span class="annottext">unfus_arrs :: [VName]
</span><a href="#local-6989586621684455104"><span class="hs-identifier hs-var hs-var">unfus_arrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455152"><span class="hs-identifier hs-var">returned_outvars</span></a></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [VName]
forall a. Eq a =&gt; [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">\\</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455110"><span class="hs-identifier hs-var">soac_p_scanout</span></a></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455109"><span class="hs-identifier hs-var">soac_p_redout</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-370"></span><span>          </span><span class="annot"><span class="annottext">[VName] -&gt; SOAC SOACS -&gt; TryFusion FusedKer
</span><a href="#local-6989586621684455151"><span class="hs-identifier hs-var">success</span></a></span><span>
</span><span id="line-371"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455110"><span class="hs-identifier hs-var">soac_p_scanout</span></a></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455107"><span class="hs-identifier hs-var">soac_c_scanout</span></a></span><span>
</span><span id="line-372"></span><span>                </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455109"><span class="hs-identifier hs-var">soac_p_redout</span></a></span><span>
</span><span id="line-373"></span><span>                </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455106"><span class="hs-identifier hs-var">soac_c_redout</span></a></span><span>
</span><span id="line-374"></span><span>                </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455105"><span class="hs-identifier hs-var">soac_c_mapout</span></a></span><span>
</span><span id="line-375"></span><span>                </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455104"><span class="hs-identifier hs-var">unfus_arrs</span></a></span><span>
</span><span id="line-376"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-377"></span><span>            </span><span class="annot"><span class="annottext">(SOAC SOACS -&gt; TryFusion FusedKer)
-&gt; SOAC SOACS -&gt; TryFusion FusedKer
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; ScremaForm SOACS -&gt; [Input] -&gt; SOAC SOACS
forall rep. SubExp -&gt; ScremaForm rep -&gt; [Input] -&gt; SOAC rep
</span><a href="Futhark.Analysis.HORep.SOAC.html#Screma"><span class="hs-identifier hs-var">SOAC.Screma</span></a></span><span>
</span><span id="line-378"></span><span>              </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684455153"><span class="hs-identifier hs-var">w</span></a></span><span>
</span><span id="line-379"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Scan SOACS] -&gt; [Reduce SOACS] -&gt; Lambda SOACS -&gt; ScremaForm SOACS
forall rep.
[Scan rep] -&gt; [Reduce rep] -&gt; Lambda rep -&gt; ScremaForm rep
</span><a href="Futhark.IR.SOACS.SOAC.html#ScremaForm"><span class="hs-identifier hs-var">ScremaForm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Scan SOACS]
</span><a href="#local-6989586621684455126"><span class="hs-identifier hs-var">scans_p</span></a></span><span> </span><span class="annot"><span class="annottext">[Scan SOACS] -&gt; [Scan SOACS] -&gt; [Scan SOACS]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Scan SOACS]
</span><a href="#local-6989586621684455128"><span class="hs-identifier hs-var">scans_c</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Reduce SOACS]
</span><a href="#local-6989586621684455125"><span class="hs-identifier hs-var">reds_p</span></a></span><span> </span><span class="annot"><span class="annottext">[Reduce SOACS] -&gt; [Reduce SOACS] -&gt; [Reduce SOACS]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Reduce SOACS]
</span><a href="#local-6989586621684455127"><span class="hs-identifier hs-var">reds_c</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684455113"><span class="hs-identifier hs-var">res_lam'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-380"></span><span>              </span><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684455112"><span class="hs-identifier hs-var">new_inp</span></a></span><span>
</span><span id="line-381"></span><span>
</span><span id="line-382"></span><span>    </span><span class="hs-comment">------------------</span><span>
</span><span id="line-383"></span><span>    </span><span class="hs-comment">-- Scatter fusion --</span><span>
</span><span id="line-384"></span><span>    </span><span class="hs-comment">------------------</span><span>
</span><span id="line-385"></span><span>
</span><span id="line-386"></span><span>    </span><span class="hs-comment">-- Map-Scatter fusion.</span><span>
</span><span id="line-387"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-388"></span><span>    </span><span class="hs-comment">-- The 'inplace' mechanism for kernels already takes care of</span><span>
</span><span id="line-389"></span><span>    </span><span class="hs-comment">-- checking that the Scatter is not writing to any array used in</span><span>
</span><span id="line-390"></span><span>    </span><span class="hs-comment">-- the Map.</span><span>
</span><span id="line-391"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Scatter"><span class="hs-identifier hs-type">SOAC.Scatter</span></a></span><span> </span><span id="local-6989586621684455102"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684455102"><span class="hs-identifier hs-var">_len</span></a></span></span><span> </span><span id="local-6989586621684455101"><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684455101"><span class="hs-identifier hs-var">_lam</span></a></span></span><span> </span><span id="local-6989586621684455100"><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684455100"><span class="hs-identifier hs-var">_ivs</span></a></span></span><span> </span><span id="local-6989586621684455099"><span class="annot"><span class="annottext">[(ShapeBase SubExp, Int, VName)]
</span><a href="#local-6989586621684455099"><span class="hs-identifier hs-var">dests</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-392"></span><span>      </span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Screma"><span class="hs-identifier hs-type">SOAC.Screma</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684455098"><span class="annot"><span class="annottext">ScremaForm SOACS
</span><a href="#local-6989586621684455098"><span class="hs-identifier hs-var">form</span></a></span></span><span> </span><span class="annot"><span class="annottext">[Input]
</span><span class="hs-identifier">_</span></span><span>
</span><span id="line-393"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-394"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Maybe (Lambda SOACS) -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (Lambda SOACS) -&gt; Bool) -&gt; Maybe (Lambda SOACS) -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ScremaForm SOACS -&gt; Maybe (Lambda SOACS)
forall rep. ScremaForm rep -&gt; Maybe (Lambda rep)
</span><a href="Futhark.IR.SOACS.SOAC.html#isMapSOAC"><span class="hs-identifier hs-var">isMapSOAC</span></a></span><span> </span><span class="annot"><span class="annottext">ScremaForm SOACS
</span><a href="#local-6989586621684455098"><span class="hs-identifier hs-var">form</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-395"></span><span>          </span><span class="hs-comment">-- 1. all arrays produced by the map are ONLY used (consumed)</span><span>
</span><span id="line-396"></span><span>          </span><span class="hs-comment">--    by the scatter, i.e., not used elsewhere.</span><span>
</span><span id="line-397"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(VName -&gt; Bool) -&gt; [VName] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#nameIn"><span class="hs-operator hs-var">`nameIn`</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684455167"><span class="hs-identifier hs-var">unfus_set</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455166"><span class="hs-identifier hs-var">outVars</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-398"></span><span>          </span><span class="hs-comment">-- 2. all arrays produced by the map are input to the scatter.</span><span>
</span><span id="line-399"></span><span>          </span><span class="annot"><span class="annottext">[VName] -&gt; FusedKer -&gt; Bool
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#mapWriteFusionOK"><span class="hs-identifier hs-var">mapWriteFusionOK</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455166"><span class="hs-identifier hs-var">outVars</span></a></span><span> </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455163"><span class="hs-identifier hs-var">ker</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-400"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684455095"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455095"><span class="hs-identifier hs-var">extra_nms</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684455094"><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684455094"><span class="hs-identifier hs-var">res_lam'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684455093"><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684455093"><span class="hs-identifier hs-var">new_inp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([VName], Lambda SOACS, [Input])
</span><a href="#local-6989586621684455140"><span class="hs-identifier hs-var">mapLikeFusionCheck</span></a></span><span>
</span><span id="line-401"></span><span>          </span><span class="annot"><span class="annottext">[VName] -&gt; SOAC SOACS -&gt; TryFusion FusedKer
</span><a href="#local-6989586621684455151"><span class="hs-identifier hs-var">success</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FusedKer -&gt; [VName]
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#outNames"><span class="hs-identifier hs-var hs-var">outNames</span></a></span><span> </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455163"><span class="hs-identifier hs-var">ker</span></a></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455095"><span class="hs-identifier hs-var">extra_nms</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SOAC SOACS -&gt; TryFusion FusedKer)
-&gt; SOAC SOACS -&gt; TryFusion FusedKer
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-402"></span><span>            </span><span class="annot"><span class="annottext">SubExp
-&gt; Lambda SOACS
-&gt; [Input]
-&gt; [(ShapeBase SubExp, Int, VName)]
-&gt; SOAC SOACS
forall rep.
SubExp
-&gt; Lambda rep
-&gt; [Input]
-&gt; [(ShapeBase SubExp, Int, VName)]
-&gt; SOAC rep
</span><a href="Futhark.Analysis.HORep.SOAC.html#Scatter"><span class="hs-identifier hs-var">SOAC.Scatter</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684455153"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684455094"><span class="hs-identifier hs-var">res_lam'</span></a></span><span> </span><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684455093"><span class="hs-identifier hs-var">new_inp</span></a></span><span> </span><span class="annot"><span class="annottext">[(ShapeBase SubExp, Int, VName)]
</span><a href="#local-6989586621684455099"><span class="hs-identifier hs-var">dests</span></a></span><span>
</span><span id="line-403"></span><span>
</span><span id="line-404"></span><span>    </span><span class="hs-comment">-- Map-Hist fusion.</span><span>
</span><span id="line-405"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-406"></span><span>    </span><span class="hs-comment">-- The 'inplace' mechanism for kernels already takes care of</span><span>
</span><span id="line-407"></span><span>    </span><span class="hs-comment">-- checking that the Hist is not writing to any array used in</span><span>
</span><span id="line-408"></span><span>    </span><span class="hs-comment">-- the Map.</span><span>
</span><span id="line-409"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Hist"><span class="hs-identifier hs-type">SOAC.Hist</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684455091"><span class="annot"><span class="annottext">[HistOp SOACS]
</span><a href="#local-6989586621684455091"><span class="hs-identifier hs-var">ops</span></a></span></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[Input]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span>
</span><span id="line-410"></span><span>      </span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Screma"><span class="hs-identifier hs-type">SOAC.Screma</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684455090"><span class="annot"><span class="annottext">ScremaForm SOACS
</span><a href="#local-6989586621684455090"><span class="hs-identifier hs-var">form</span></a></span></span><span> </span><span class="annot"><span class="annottext">[Input]
</span><span class="hs-identifier">_</span></span><span>
</span><span id="line-411"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-412"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Maybe (Lambda SOACS) -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (Lambda SOACS) -&gt; Bool) -&gt; Maybe (Lambda SOACS) -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ScremaForm SOACS -&gt; Maybe (Lambda SOACS)
forall rep. ScremaForm rep -&gt; Maybe (Lambda rep)
</span><a href="Futhark.IR.SOACS.SOAC.html#isMapSOAC"><span class="hs-identifier hs-var">isMapSOAC</span></a></span><span> </span><span class="annot"><span class="annottext">ScremaForm SOACS
</span><a href="#local-6989586621684455090"><span class="hs-identifier hs-var">form</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-413"></span><span>          </span><span class="hs-comment">-- 1. all arrays produced by the map are ONLY used (consumed)</span><span>
</span><span id="line-414"></span><span>          </span><span class="hs-comment">--    by the hist, i.e., not used elsewhere.</span><span>
</span><span id="line-415"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(VName -&gt; Bool) -&gt; [VName] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#nameIn"><span class="hs-operator hs-var">`nameIn`</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684455167"><span class="hs-identifier hs-var">unfus_set</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455166"><span class="hs-identifier hs-var">outVars</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-416"></span><span>          </span><span class="hs-comment">-- 2. all arrays produced by the map are input to the scatter.</span><span>
</span><span id="line-417"></span><span>          </span><span class="annot"><span class="annottext">[VName] -&gt; FusedKer -&gt; Bool
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#mapWriteFusionOK"><span class="hs-identifier hs-var">mapWriteFusionOK</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455166"><span class="hs-identifier hs-var">outVars</span></a></span><span> </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455163"><span class="hs-identifier hs-var">ker</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-418"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684455089"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455089"><span class="hs-identifier hs-var">extra_nms</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684455088"><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684455088"><span class="hs-identifier hs-var">res_lam'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684455087"><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684455087"><span class="hs-identifier hs-var">new_inp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([VName], Lambda SOACS, [Input])
</span><a href="#local-6989586621684455140"><span class="hs-identifier hs-var">mapLikeFusionCheck</span></a></span><span>
</span><span id="line-419"></span><span>          </span><span class="annot"><span class="annottext">[VName] -&gt; SOAC SOACS -&gt; TryFusion FusedKer
</span><a href="#local-6989586621684455151"><span class="hs-identifier hs-var">success</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FusedKer -&gt; [VName]
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#outNames"><span class="hs-identifier hs-var hs-var">outNames</span></a></span><span> </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455163"><span class="hs-identifier hs-var">ker</span></a></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455089"><span class="hs-identifier hs-var">extra_nms</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SOAC SOACS -&gt; TryFusion FusedKer)
-&gt; SOAC SOACS -&gt; TryFusion FusedKer
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-420"></span><span>            </span><span class="annot"><span class="annottext">SubExp -&gt; [HistOp SOACS] -&gt; Lambda SOACS -&gt; [Input] -&gt; SOAC SOACS
forall rep.
SubExp -&gt; [HistOp rep] -&gt; Lambda rep -&gt; [Input] -&gt; SOAC rep
</span><a href="Futhark.Analysis.HORep.SOAC.html#Hist"><span class="hs-identifier hs-var">SOAC.Hist</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684455153"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">[HistOp SOACS]
</span><a href="#local-6989586621684455091"><span class="hs-identifier hs-var">ops</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684455088"><span class="hs-identifier hs-var">res_lam'</span></a></span><span> </span><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684455087"><span class="hs-identifier hs-var">new_inp</span></a></span><span>
</span><span id="line-421"></span><span>
</span><span id="line-422"></span><span>    </span><span class="hs-comment">-- Hist-Hist fusion</span><span>
</span><span id="line-423"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Hist"><span class="hs-identifier hs-type">SOAC.Hist</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684455086"><span class="annot"><span class="annottext">[HistOp SOACS]
</span><a href="#local-6989586621684455086"><span class="hs-identifier hs-var">ops_c</span></a></span></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[Input]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span>
</span><span id="line-424"></span><span>      </span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Hist"><span class="hs-identifier hs-type">SOAC.Hist</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684455085"><span class="annot"><span class="annottext">[HistOp SOACS]
</span><a href="#local-6989586621684455085"><span class="hs-identifier hs-var">ops_p</span></a></span></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[Input]
</span><span class="hs-identifier">_</span></span><span>
</span><span id="line-425"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-426"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684455160"><span class="hs-identifier hs-var">horizFuse</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-427"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684455084"><span class="annot"><span class="annottext">p_num_buckets :: Int
</span><a href="#local-6989586621684455084"><span class="hs-identifier hs-var hs-var">p_num_buckets</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[HistOp SOACS] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[HistOp SOACS]
</span><a href="#local-6989586621684455085"><span class="hs-identifier hs-var">ops_p</span></a></span><span>
</span><span id="line-428"></span><span>              </span><span id="local-6989586621684455083"><span class="annot"><span class="annottext">c_num_buckets :: Int
</span><a href="#local-6989586621684455083"><span class="hs-identifier hs-var hs-var">c_num_buckets</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[HistOp SOACS] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[HistOp SOACS]
</span><a href="#local-6989586621684455086"><span class="hs-identifier hs-var">ops_c</span></a></span><span>
</span><span id="line-429"></span><span>              </span><span class="hs-special">(</span><span id="local-6989586621684455082"><span class="annot"><span class="annottext">BodyT SOACS
</span><a href="#local-6989586621684455082"><span class="hs-identifier hs-var">body_p</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684455081"><span class="annot"><span class="annottext">BodyT SOACS
</span><a href="#local-6989586621684455081"><span class="hs-identifier hs-var">body_c</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda SOACS -&gt; BodyT SOACS
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684455155"><span class="hs-identifier hs-var">lam_p</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Lambda SOACS -&gt; BodyT SOACS
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684455154"><span class="hs-identifier hs-var">lam_c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-430"></span><span>              </span><span id="local-6989586621684455080"><span class="annot"><span class="annottext">body' :: BodyT SOACS
</span><a href="#local-6989586621684455080"><span class="hs-identifier hs-var hs-var">body'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-431"></span><span>                </span><span class="annot"><span class="annottext">Body :: forall rep. BodyDec rep -&gt; Stms rep -&gt; Result -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span>
</span><span id="line-432"></span><span>                  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">bodyDec :: BodyDec SOACS
</span><a href="Futhark.IR.Syntax.html#bodyDec"><span class="hs-identifier hs-var">bodyDec</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BodyT SOACS -&gt; BodyDec SOACS
forall rep. BodyT rep -&gt; BodyDec rep
</span><a href="Futhark.IR.Syntax.html#bodyDec"><span class="hs-identifier hs-var hs-var">bodyDec</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT SOACS
</span><a href="#local-6989586621684455082"><span class="hs-identifier hs-var">body_p</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-comment">-- body_p and body_c have the same decorations</span><span>
</span><span id="line-433"></span><span>                    </span><span class="annot"><span class="annottext">bodyStms :: Stms SOACS
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var">bodyStms</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BodyT SOACS -&gt; Stms SOACS
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT SOACS
</span><a href="#local-6989586621684455082"><span class="hs-identifier hs-var">body_p</span></a></span><span> </span><span class="annot"><span class="annottext">Stms SOACS -&gt; Stms SOACS -&gt; Stms SOACS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">BodyT SOACS -&gt; Stms SOACS
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT SOACS
</span><a href="#local-6989586621684455081"><span class="hs-identifier hs-var">body_c</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-434"></span><span>                    </span><span class="annot"><span class="annottext">bodyResult :: Result
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var">bodyResult</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-435"></span><span>                      </span><span class="annot"><span class="annottext">Int -&gt; Result -&gt; Result
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">take</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684455083"><span class="hs-identifier hs-var">c_num_buckets</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BodyT SOACS -&gt; Result
forall rep. BodyT rep -&gt; Result
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var hs-var">bodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT SOACS
</span><a href="#local-6989586621684455081"><span class="hs-identifier hs-var">body_c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-436"></span><span>                        </span><span class="annot"><span class="annottext">Result -&gt; Result -&gt; Result
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Result -&gt; Result
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">take</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684455084"><span class="hs-identifier hs-var">p_num_buckets</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BodyT SOACS -&gt; Result
forall rep. BodyT rep -&gt; Result
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var hs-var">bodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT SOACS
</span><a href="#local-6989586621684455082"><span class="hs-identifier hs-var">body_p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-437"></span><span>                        </span><span class="annot"><span class="annottext">Result -&gt; Result -&gt; Result
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Result -&gt; Result
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684455083"><span class="hs-identifier hs-var">c_num_buckets</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BodyT SOACS -&gt; Result
forall rep. BodyT rep -&gt; Result
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var hs-var">bodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT SOACS
</span><a href="#local-6989586621684455081"><span class="hs-identifier hs-var">body_c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-438"></span><span>                        </span><span class="annot"><span class="annottext">Result -&gt; Result -&gt; Result
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Result -&gt; Result
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684455084"><span class="hs-identifier hs-var">p_num_buckets</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BodyT SOACS -&gt; Result
forall rep. BodyT rep -&gt; Result
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var hs-var">bodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT SOACS
</span><a href="#local-6989586621684455082"><span class="hs-identifier hs-var">body_p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-439"></span><span>                  </span><span class="hs-special">}</span><span>
</span><span id="line-440"></span><span>              </span><span id="local-6989586621684455074"><span class="annot"><span class="annottext">lam' :: Lambda SOACS
</span><a href="#local-6989586621684455074"><span class="hs-identifier hs-var hs-var">lam'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-441"></span><span>                </span><span class="annot"><span class="annottext">Lambda :: forall rep.
[LParam rep]
-&gt; BodyT rep
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; LambdaT rep
</span><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span>
</span><span id="line-442"></span><span>                  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">lambdaParams :: [LParam SOACS]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var">lambdaParams</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Lambda SOACS -&gt; [LParam SOACS]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684455154"><span class="hs-identifier hs-var">lam_c</span></a></span><span> </span><span class="annot"><span class="annottext">[Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
-&gt; [Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
-&gt; [Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS -&gt; [LParam SOACS]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684455155"><span class="hs-identifier hs-var">lam_p</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-443"></span><span>                    </span><span class="annot"><span class="annottext">lambdaBody :: BodyT SOACS
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var">lambdaBody</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BodyT SOACS
</span><a href="#local-6989586621684455080"><span class="hs-identifier hs-var">body'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-444"></span><span>                    </span><span class="annot"><span class="annottext">lambdaReturnType :: [TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var">lambdaReturnType</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-445"></span><span>                      </span><span class="annot"><span class="annottext">Int
-&gt; TypeBase (ShapeBase SubExp) NoUniqueness
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
forall a. Int -&gt; a -&gt; [a]
</span><span class="hs-identifier hs-var">replicate</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684455083"><span class="hs-identifier hs-var">c_num_buckets</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684455084"><span class="hs-identifier hs-var">p_num_buckets</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimType -&gt; TypeBase (ShapeBase SubExp) NoUniqueness
forall shape u. PrimType -&gt; TypeBase shape u
</span><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int64"><span class="hs-identifier hs-var">int64</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-446"></span><span>                        </span><span class="annot"><span class="annottext">[TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Int
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684455083"><span class="hs-identifier hs-var">c_num_buckets</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda SOACS -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
forall rep.
LambdaT rep -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684455154"><span class="hs-identifier hs-var">lam_c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-447"></span><span>                        </span><span class="annot"><span class="annottext">[TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Int
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684455084"><span class="hs-identifier hs-var">p_num_buckets</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda SOACS -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
forall rep.
LambdaT rep -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684455155"><span class="hs-identifier hs-var">lam_p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-448"></span><span>                  </span><span class="hs-special">}</span><span>
</span><span id="line-449"></span><span>          </span><span class="annot"><span class="annottext">[VName] -&gt; SOAC SOACS -&gt; TryFusion FusedKer
</span><a href="#local-6989586621684455151"><span class="hs-identifier hs-var">success</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FusedKer -&gt; [VName]
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#outNames"><span class="hs-identifier hs-var hs-var">outNames</span></a></span><span> </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455163"><span class="hs-identifier hs-var">ker</span></a></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455152"><span class="hs-identifier hs-var">returned_outvars</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SOAC SOACS -&gt; TryFusion FusedKer)
-&gt; SOAC SOACS -&gt; TryFusion FusedKer
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-450"></span><span>            </span><span class="annot"><span class="annottext">SubExp -&gt; [HistOp SOACS] -&gt; Lambda SOACS -&gt; [Input] -&gt; SOAC SOACS
forall rep.
SubExp -&gt; [HistOp rep] -&gt; Lambda rep -&gt; [Input] -&gt; SOAC rep
</span><a href="Futhark.Analysis.HORep.SOAC.html#Hist"><span class="hs-identifier hs-var">SOAC.Hist</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684455153"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[HistOp SOACS]
</span><a href="#local-6989586621684455086"><span class="hs-identifier hs-var">ops_c</span></a></span><span> </span><span class="annot"><span class="annottext">[HistOp SOACS] -&gt; [HistOp SOACS] -&gt; [HistOp SOACS]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[HistOp SOACS]
</span><a href="#local-6989586621684455085"><span class="hs-identifier hs-var">ops_p</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684455074"><span class="hs-identifier hs-var">lam'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684455156"><span class="hs-identifier hs-var">inp_c_arr</span></a></span><span> </span><span class="annot"><span class="annottext">[Input] -&gt; [Input] -&gt; [Input]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684455161"><span class="hs-identifier hs-var">inp_p_arr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-451"></span><span>
</span><span id="line-452"></span><span>    </span><span class="hs-comment">-- Scatter-write fusion.</span><span>
</span><span id="line-453"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Scatter"><span class="hs-identifier hs-type">SOAC.Scatter</span></a></span><span> </span><span id="local-6989586621684455069"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684455069"><span class="hs-identifier hs-var">_len_c</span></a></span></span><span> </span><span id="local-6989586621684455068"><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684455068"><span class="hs-identifier hs-var">_lam_c</span></a></span></span><span> </span><span id="local-6989586621684455067"><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684455067"><span class="hs-identifier hs-var">ivs_c</span></a></span></span><span> </span><span id="local-6989586621684455066"><span class="annot"><span class="annottext">[(ShapeBase SubExp, Int, VName)]
</span><a href="#local-6989586621684455066"><span class="hs-identifier hs-var">as_c</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-454"></span><span>      </span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Scatter"><span class="hs-identifier hs-type">SOAC.Scatter</span></a></span><span> </span><span id="local-6989586621684455065"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684455065"><span class="hs-identifier hs-var">_len_p</span></a></span></span><span> </span><span id="local-6989586621684455064"><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684455064"><span class="hs-identifier hs-var">_lam_p</span></a></span></span><span> </span><span id="local-6989586621684455063"><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684455063"><span class="hs-identifier hs-var">ivs_p</span></a></span></span><span> </span><span id="local-6989586621684455062"><span class="annot"><span class="annottext">[(ShapeBase SubExp, Int, VName)]
</span><a href="#local-6989586621684455062"><span class="hs-identifier hs-var">as_p</span></a></span></span><span>
</span><span id="line-455"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-456"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684455160"><span class="hs-identifier hs-var">horizFuse</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-457"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684455061"><span class="annot"><span class="annottext">zipW :: [(ShapeBase SubExp, Int, array)]
-&gt; [a] -&gt; [(ShapeBase SubExp, Int, array)] -&gt; [a] -&gt; [a]
</span><a href="#local-6989586621684455061"><span class="hs-identifier hs-var hs-var">zipW</span></a></span></span><span> </span><span id="local-6989586621684455060"><span class="annot"><span class="annottext">[(ShapeBase SubExp, Int, array)]
</span><a href="#local-6989586621684455060"><span class="hs-identifier hs-var">as_xs</span></a></span></span><span> </span><span id="local-6989586621684455059"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684455059"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span id="local-6989586621684455058"><span class="annot"><span class="annottext">[(ShapeBase SubExp, Int, array)]
</span><a href="#local-6989586621684455058"><span class="hs-identifier hs-var">as_ys</span></a></span></span><span> </span><span id="local-6989586621684455057"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684455057"><span class="hs-identifier hs-var">ys</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684455056"><span class="hs-identifier hs-var">xs_indices</span></a></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [a] -&gt; [a]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684455055"><span class="hs-identifier hs-var">ys_indices</span></a></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [a] -&gt; [a]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684455054"><span class="hs-identifier hs-var">xs_vals</span></a></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [a] -&gt; [a]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684455053"><span class="hs-identifier hs-var">ys_vals</span></a></span><span>
</span><span id="line-458"></span><span>                </span><span class="hs-keyword">where</span><span>
</span><span id="line-459"></span><span>                  </span><span class="hs-special">(</span><span id="local-6989586621684455056"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684455056"><span class="hs-identifier hs-var">xs_indices</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684455054"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684455054"><span class="hs-identifier hs-var">xs_vals</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(ShapeBase SubExp, Int, array)] -&gt; [a] -&gt; ([a], [a])
forall array a.
[(ShapeBase SubExp, Int, array)] -&gt; [a] -&gt; ([a], [a])
</span><a href="Futhark.IR.SOACS.SOAC.html#splitScatterResults"><span class="hs-identifier hs-var">splitScatterResults</span></a></span><span> </span><span class="annot"><span class="annottext">[(ShapeBase SubExp, Int, array)]
</span><a href="#local-6989586621684455060"><span class="hs-identifier hs-var">as_xs</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684455059"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-460"></span><span>                  </span><span class="hs-special">(</span><span id="local-6989586621684455055"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684455055"><span class="hs-identifier hs-var">ys_indices</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684455053"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684455053"><span class="hs-identifier hs-var">ys_vals</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(ShapeBase SubExp, Int, array)] -&gt; [a] -&gt; ([a], [a])
forall array a.
[(ShapeBase SubExp, Int, array)] -&gt; [a] -&gt; ([a], [a])
</span><a href="Futhark.IR.SOACS.SOAC.html#splitScatterResults"><span class="hs-identifier hs-var">splitScatterResults</span></a></span><span> </span><span class="annot"><span class="annottext">[(ShapeBase SubExp, Int, array)]
</span><a href="#local-6989586621684455058"><span class="hs-identifier hs-var">as_ys</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684455057"><span class="hs-identifier hs-var">ys</span></a></span><span>
</span><span id="line-461"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684455051"><span class="annot"><span class="annottext">BodyT SOACS
</span><a href="#local-6989586621684455051"><span class="hs-identifier hs-var">body_p</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684455050"><span class="annot"><span class="annottext">BodyT SOACS
</span><a href="#local-6989586621684455050"><span class="hs-identifier hs-var">body_c</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda SOACS -&gt; BodyT SOACS
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684455155"><span class="hs-identifier hs-var">lam_p</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Lambda SOACS -&gt; BodyT SOACS
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684455154"><span class="hs-identifier hs-var">lam_c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-462"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684455049"><span class="annot"><span class="annottext">body' :: BodyT SOACS
</span><a href="#local-6989586621684455049"><span class="hs-identifier hs-var hs-var">body'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-463"></span><span>                </span><span class="annot"><span class="annottext">Body :: forall rep. BodyDec rep -&gt; Stms rep -&gt; Result -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span>
</span><span id="line-464"></span><span>                  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">bodyDec :: BodyDec SOACS
</span><a href="Futhark.IR.Syntax.html#bodyDec"><span class="hs-identifier hs-var">bodyDec</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BodyT SOACS -&gt; BodyDec SOACS
forall rep. BodyT rep -&gt; BodyDec rep
</span><a href="Futhark.IR.Syntax.html#bodyDec"><span class="hs-identifier hs-var hs-var">bodyDec</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT SOACS
</span><a href="#local-6989586621684455051"><span class="hs-identifier hs-var">body_p</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-comment">-- body_p and body_c have the same decorations</span><span>
</span><span id="line-465"></span><span>                    </span><span class="annot"><span class="annottext">bodyStms :: Stms SOACS
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var">bodyStms</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BodyT SOACS -&gt; Stms SOACS
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT SOACS
</span><a href="#local-6989586621684455051"><span class="hs-identifier hs-var">body_p</span></a></span><span> </span><span class="annot"><span class="annottext">Stms SOACS -&gt; Stms SOACS -&gt; Stms SOACS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">BodyT SOACS -&gt; Stms SOACS
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT SOACS
</span><a href="#local-6989586621684455050"><span class="hs-identifier hs-var">body_c</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-466"></span><span>                    </span><span class="annot"><span class="annottext">bodyResult :: Result
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var">bodyResult</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(ShapeBase SubExp, Int, VName)]
-&gt; Result -&gt; [(ShapeBase SubExp, Int, VName)] -&gt; Result -&gt; Result
forall {array} {a} {array}.
[(ShapeBase SubExp, Int, array)]
-&gt; [a] -&gt; [(ShapeBase SubExp, Int, array)] -&gt; [a] -&gt; [a]
</span><a href="#local-6989586621684455061"><span class="hs-identifier hs-var">zipW</span></a></span><span> </span><span class="annot"><span class="annottext">[(ShapeBase SubExp, Int, VName)]
</span><a href="#local-6989586621684455066"><span class="hs-identifier hs-var">as_c</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BodyT SOACS -&gt; Result
forall rep. BodyT rep -&gt; Result
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var hs-var">bodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT SOACS
</span><a href="#local-6989586621684455050"><span class="hs-identifier hs-var">body_c</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(ShapeBase SubExp, Int, VName)]
</span><a href="#local-6989586621684455062"><span class="hs-identifier hs-var">as_p</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BodyT SOACS -&gt; Result
forall rep. BodyT rep -&gt; Result
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var hs-var">bodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT SOACS
</span><a href="#local-6989586621684455051"><span class="hs-identifier hs-var">body_p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-467"></span><span>                  </span><span class="hs-special">}</span><span>
</span><span id="line-468"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684455048"><span class="annot"><span class="annottext">lam' :: Lambda SOACS
</span><a href="#local-6989586621684455048"><span class="hs-identifier hs-var hs-var">lam'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-469"></span><span>                </span><span class="annot"><span class="annottext">Lambda :: forall rep.
[LParam rep]
-&gt; BodyT rep
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; LambdaT rep
</span><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span>
</span><span id="line-470"></span><span>                  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">lambdaParams :: [LParam SOACS]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var">lambdaParams</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Lambda SOACS -&gt; [LParam SOACS]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684455154"><span class="hs-identifier hs-var">lam_c</span></a></span><span> </span><span class="annot"><span class="annottext">[Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
-&gt; [Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
-&gt; [Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS -&gt; [LParam SOACS]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684455155"><span class="hs-identifier hs-var">lam_p</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-471"></span><span>                    </span><span class="annot"><span class="annottext">lambdaBody :: BodyT SOACS
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var">lambdaBody</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BodyT SOACS
</span><a href="#local-6989586621684455049"><span class="hs-identifier hs-var">body'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-472"></span><span>                    </span><span class="annot"><span class="annottext">lambdaReturnType :: [TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var">lambdaReturnType</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(ShapeBase SubExp, Int, VName)]
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; [(ShapeBase SubExp, Int, VName)]
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
forall {array} {a} {array}.
[(ShapeBase SubExp, Int, array)]
-&gt; [a] -&gt; [(ShapeBase SubExp, Int, array)] -&gt; [a] -&gt; [a]
</span><a href="#local-6989586621684455061"><span class="hs-identifier hs-var">zipW</span></a></span><span> </span><span class="annot"><span class="annottext">[(ShapeBase SubExp, Int, VName)]
</span><a href="#local-6989586621684455066"><span class="hs-identifier hs-var">as_c</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda SOACS -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
forall rep.
LambdaT rep -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684455154"><span class="hs-identifier hs-var">lam_c</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(ShapeBase SubExp, Int, VName)]
</span><a href="#local-6989586621684455062"><span class="hs-identifier hs-var">as_p</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda SOACS -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
forall rep.
LambdaT rep -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684455155"><span class="hs-identifier hs-var">lam_p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-473"></span><span>                  </span><span class="hs-special">}</span><span>
</span><span id="line-474"></span><span>          </span><span class="annot"><span class="annottext">[VName] -&gt; SOAC SOACS -&gt; TryFusion FusedKer
</span><a href="#local-6989586621684455151"><span class="hs-identifier hs-var">success</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FusedKer -&gt; [VName]
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#outNames"><span class="hs-identifier hs-var hs-var">outNames</span></a></span><span> </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455163"><span class="hs-identifier hs-var">ker</span></a></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455152"><span class="hs-identifier hs-var">returned_outvars</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SOAC SOACS -&gt; TryFusion FusedKer)
-&gt; SOAC SOACS -&gt; TryFusion FusedKer
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-475"></span><span>            </span><span class="annot"><span class="annottext">SubExp
-&gt; Lambda SOACS
-&gt; [Input]
-&gt; [(ShapeBase SubExp, Int, VName)]
-&gt; SOAC SOACS
forall rep.
SubExp
-&gt; Lambda rep
-&gt; [Input]
-&gt; [(ShapeBase SubExp, Int, VName)]
-&gt; SOAC rep
</span><a href="Futhark.Analysis.HORep.SOAC.html#Scatter"><span class="hs-identifier hs-var">SOAC.Scatter</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684455153"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684455048"><span class="hs-identifier hs-var">lam'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684455067"><span class="hs-identifier hs-var">ivs_c</span></a></span><span> </span><span class="annot"><span class="annottext">[Input] -&gt; [Input] -&gt; [Input]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684455063"><span class="hs-identifier hs-var">ivs_p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(ShapeBase SubExp, Int, VName)]
</span><a href="#local-6989586621684455066"><span class="hs-identifier hs-var">as_c</span></a></span><span> </span><span class="annot"><span class="annottext">[(ShapeBase SubExp, Int, VName)]
-&gt; [(ShapeBase SubExp, Int, VName)]
-&gt; [(ShapeBase SubExp, Int, VName)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[(ShapeBase SubExp, Int, VName)]
</span><a href="#local-6989586621684455062"><span class="hs-identifier hs-var">as_p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-476"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Scatter"><span class="hs-identifier hs-type">SOAC.Scatter</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-477"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; TryFusion FusedKer
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Cannot fuse a write with anything else than a write or a map&quot;</span></span><span>
</span><span id="line-478"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SOAC SOACS
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Scatter"><span class="hs-identifier hs-type">SOAC.Scatter</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-479"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; TryFusion FusedKer
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Cannot fuse a write with anything else than a write or a map&quot;</span></span><span>
</span><span id="line-480"></span><span>    </span><span class="hs-comment">----------------------------</span><span>
</span><span id="line-481"></span><span>    </span><span class="hs-comment">-- Stream-Stream Fusions: --</span><span>
</span><span id="line-482"></span><span>    </span><span class="hs-comment">----------------------------</span><span>
</span><span id="line-483"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Stream"><span class="hs-identifier hs-type">SOAC.Stream</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StreamForm SOACS
</span><a href="Futhark.IR.SOACS.SOAC.html#Sequential"><span class="hs-identifier hs-var">Sequential</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[Input]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Stream"><span class="hs-identifier hs-type">SOAC.Stream</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StreamForm SOACS
</span><a href="Futhark.IR.SOACS.SOAC.html#Sequential"><span class="hs-identifier hs-var">Sequential</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684455045"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684455045"><span class="hs-identifier hs-var">nes</span></a></span></span><span> </span><span class="annot"><span class="annottext">[Input]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-484"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; FusedKer -&gt; Bool
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#mapFusionOK"><span class="hs-identifier hs-var">mapFusionOK</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; [VName] -&gt; [VName]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684455045"><span class="hs-identifier hs-var">nes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455166"><span class="hs-identifier hs-var">outVars</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455163"><span class="hs-identifier hs-var">ker</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684455160"><span class="hs-identifier hs-var">horizFuse</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-485"></span><span>        </span><span class="hs-comment">-- fuse two SEQUENTIAL streams</span><span>
</span><span id="line-486"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621684455044"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455044"><span class="hs-identifier hs-var">res_nms</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684455043"><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455043"><span class="hs-identifier hs-var">res_stream</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[VName]
-&gt; Names
-&gt; [VName]
-&gt; [(VName, Ident)]
-&gt; SOAC SOACS
-&gt; SOAC SOACS
-&gt; TryFusion ([VName], SOAC SOACS)
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#fuseStreamHelper"><span class="hs-identifier hs-var">fuseStreamHelper</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FusedKer -&gt; [VName]
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#outNames"><span class="hs-identifier hs-var hs-var">outNames</span></a></span><span> </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455163"><span class="hs-identifier hs-var">ker</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684455167"><span class="hs-identifier hs-var">unfus_set</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455166"><span class="hs-identifier hs-var">outVars</span></a></span><span> </span><span class="annot"><span class="annottext">[(VName, Ident)]
</span><a href="#local-6989586621684455146"><span class="hs-identifier hs-var">outPairs</span></a></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455162"><span class="hs-identifier hs-var">soac_c</span></a></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455165"><span class="hs-identifier hs-var">soac_p</span></a></span><span>
</span><span id="line-487"></span><span>        </span><span class="annot"><span class="annottext">[VName] -&gt; SOAC SOACS -&gt; TryFusion FusedKer
</span><a href="#local-6989586621684455151"><span class="hs-identifier hs-var">success</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455044"><span class="hs-identifier hs-var">res_nms</span></a></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455043"><span class="hs-identifier hs-var">res_stream</span></a></span><span>
</span><span id="line-488"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Stream"><span class="hs-identifier hs-type">SOAC.Stream</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StreamForm SOACS
</span><a href="Futhark.IR.SOACS.SOAC.html#Sequential"><span class="hs-identifier hs-var">Sequential</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[Input]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Stream"><span class="hs-identifier hs-type">SOAC.Stream</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StreamForm SOACS
</span><a href="Futhark.IR.SOACS.SOAC.html#Sequential"><span class="hs-identifier hs-var">Sequential</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[Input]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-489"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; TryFusion FusedKer
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Fusion conditions not met for two SEQ streams!&quot;</span></span><span>
</span><span id="line-490"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Stream"><span class="hs-identifier hs-type">SOAC.Stream</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StreamForm SOACS
</span><a href="Futhark.IR.SOACS.SOAC.html#Sequential"><span class="hs-identifier hs-var">Sequential</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[Input]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Stream"><span class="hs-identifier hs-type">SOAC.Stream</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-491"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; TryFusion FusedKer
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Cannot fuse a parallel with a sequential Stream!&quot;</span></span><span>
</span><span id="line-492"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Stream"><span class="hs-identifier hs-type">SOAC.Stream</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Stream"><span class="hs-identifier hs-type">SOAC.Stream</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StreamForm SOACS
</span><a href="Futhark.IR.SOACS.SOAC.html#Sequential"><span class="hs-identifier hs-var">Sequential</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[Input]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-493"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; TryFusion FusedKer
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Cannot fuse a parallel with a sequential Stream!&quot;</span></span><span>
</span><span id="line-494"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Stream"><span class="hs-identifier hs-type">SOAC.Stream</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Stream"><span class="hs-identifier hs-type">SOAC.Stream</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StreamForm SOACS
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684455041"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684455041"><span class="hs-identifier hs-var">nes</span></a></span></span><span> </span><span class="annot"><span class="annottext">[Input]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-495"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; FusedKer -&gt; Bool
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#mapFusionOK"><span class="hs-identifier hs-var">mapFusionOK</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; [VName] -&gt; [VName]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684455041"><span class="hs-identifier hs-var">nes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455166"><span class="hs-identifier hs-var">outVars</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455163"><span class="hs-identifier hs-var">ker</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684455160"><span class="hs-identifier hs-var">horizFuse</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-496"></span><span>        </span><span class="hs-comment">-- fuse two PARALLEL streams</span><span>
</span><span id="line-497"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621684455040"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455040"><span class="hs-identifier hs-var">res_nms</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684455039"><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455039"><span class="hs-identifier hs-var">res_stream</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[VName]
-&gt; Names
-&gt; [VName]
-&gt; [(VName, Ident)]
-&gt; SOAC SOACS
-&gt; SOAC SOACS
-&gt; TryFusion ([VName], SOAC SOACS)
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#fuseStreamHelper"><span class="hs-identifier hs-var">fuseStreamHelper</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FusedKer -&gt; [VName]
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#outNames"><span class="hs-identifier hs-var hs-var">outNames</span></a></span><span> </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455163"><span class="hs-identifier hs-var">ker</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684455167"><span class="hs-identifier hs-var">unfus_set</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455166"><span class="hs-identifier hs-var">outVars</span></a></span><span> </span><span class="annot"><span class="annottext">[(VName, Ident)]
</span><a href="#local-6989586621684455146"><span class="hs-identifier hs-var">outPairs</span></a></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455162"><span class="hs-identifier hs-var">soac_c</span></a></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455165"><span class="hs-identifier hs-var">soac_p</span></a></span><span>
</span><span id="line-498"></span><span>        </span><span class="annot"><span class="annottext">[VName] -&gt; SOAC SOACS -&gt; TryFusion FusedKer
</span><a href="#local-6989586621684455151"><span class="hs-identifier hs-var">success</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455040"><span class="hs-identifier hs-var">res_nms</span></a></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455039"><span class="hs-identifier hs-var">res_stream</span></a></span><span>
</span><span id="line-499"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Stream"><span class="hs-identifier hs-type">SOAC.Stream</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Stream"><span class="hs-identifier hs-type">SOAC.Stream</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-500"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; TryFusion FusedKer
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Fusion conditions not met for two PAR streams!&quot;</span></span><span>
</span><span id="line-501"></span><span>    </span><span class="hs-comment">-------------------------------------------------------------------</span><span>
</span><span id="line-502"></span><span>    </span><span class="hs-comment">--- If one is a stream, translate the other to a stream as well.---</span><span>
</span><span id="line-503"></span><span>    </span><span class="hs-comment">--- This does not get in trouble (infinite computation) because ---</span><span>
</span><span id="line-504"></span><span>    </span><span class="hs-comment">---   scan's translation to Stream introduces a hindrance to    ---</span><span>
</span><span id="line-505"></span><span>    </span><span class="hs-comment">---   (horizontal fusion), hence repeated application is for the---</span><span>
</span><span id="line-506"></span><span>    </span><span class="hs-comment">---   moment impossible. However, if with a dependence-graph rep---</span><span>
</span><span id="line-507"></span><span>    </span><span class="hs-comment">---   we could run in an infinite recursion, i.e., repeatedly   ---</span><span>
</span><span id="line-508"></span><span>    </span><span class="hs-comment">---   fusing map o scan into an infinity of Stream levels!      ---</span><span>
</span><span id="line-509"></span><span>    </span><span class="hs-comment">-------------------------------------------------------------------</span><span>
</span><span id="line-510"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Stream"><span class="hs-identifier hs-type">SOAC.Stream</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684455038"><span class="annot"><span class="annottext">StreamForm SOACS
</span><a href="#local-6989586621684455038"><span class="hs-identifier hs-var">form2</span></a></span></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[Input]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-511"></span><span>      </span><span class="hs-comment">-- If this rule is matched then soac_p is NOT a stream.</span><span>
</span><span id="line-512"></span><span>      </span><span class="hs-comment">-- To fuse a stream kernel, we transform soac_p to a stream, which</span><span>
</span><span id="line-513"></span><span>      </span><span class="hs-comment">-- borrows the sequential/parallel property of the soac_c Stream,</span><span>
</span><span id="line-514"></span><span>      </span><span class="hs-comment">-- and recursively perform stream-stream fusion.</span><span>
</span><span id="line-515"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684455037"><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455037"><span class="hs-identifier hs-var">soac_p'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684455036"><span class="annot"><span class="annottext">[Ident]
</span><a href="#local-6989586621684455036"><span class="hs-identifier hs-var">newacc_ids</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SOAC SOACS -&gt; TryFusion (SOAC SOACS, [Ident])
forall (m :: * -&gt; *) rep.
(MonadFreshNames m, Buildable rep, Op rep ~ SOAC rep) =&gt;
SOAC rep -&gt; m (SOAC rep, [Ident])
</span><a href="Futhark.Analysis.HORep.SOAC.html#soacToStream"><span class="hs-identifier hs-var">SOAC.soacToStream</span></a></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455165"><span class="hs-identifier hs-var">soac_p</span></a></span><span>
</span><span id="line-516"></span><span>      </span><span id="local-6989586621684455034"><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455034"><span class="hs-identifier hs-var">soac_p''</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">StreamForm SOACS
</span><a href="#local-6989586621684455038"><span class="hs-identifier hs-var">form2</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-517"></span><span>        </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Sequential"><span class="hs-identifier hs-type">Sequential</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SOAC SOACS -&gt; TryFusion (SOAC SOACS)
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#toSeqStream"><span class="hs-identifier hs-var">toSeqStream</span></a></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455037"><span class="hs-identifier hs-var">soac_p'</span></a></span><span>
</span><span id="line-518"></span><span>        </span><span class="annot"><span class="annottext">StreamForm SOACS
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SOAC SOACS -&gt; TryFusion (SOAC SOACS)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455037"><span class="hs-identifier hs-var">soac_p'</span></a></span><span>
</span><span id="line-519"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455037"><span class="hs-identifier hs-var">soac_p'</span></a></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS -&gt; SOAC SOACS -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455165"><span class="hs-identifier hs-var">soac_p</span></a></span><span>
</span><span id="line-520"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">String -&gt; TryFusion FusedKer
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;SOAC could not be turned into stream.&quot;</span></span><span>
</span><span id="line-521"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Names
-&gt; [VName] -&gt; SOAC SOACS -&gt; Names -&gt; FusedKer -&gt; TryFusion FusedKer
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#fuseSOACwithKer"><span class="hs-identifier hs-var">fuseSOACwithKer</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684455167"><span class="hs-identifier hs-var">unfus_set</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Ident -&gt; VName) -&gt; [Ident] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Ident -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#identName"><span class="hs-identifier hs-var hs-var">identName</span></a></span><span> </span><span class="annot"><span class="annottext">[Ident]
</span><a href="#local-6989586621684455036"><span class="hs-identifier hs-var">newacc_ids</span></a></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455166"><span class="hs-identifier hs-var">outVars</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455034"><span class="hs-identifier hs-var">soac_p''</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684455164"><span class="hs-identifier hs-var">soac_p_consumed</span></a></span><span> </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455163"><span class="hs-identifier hs-var">ker</span></a></span><span>
</span><span id="line-522"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SOAC SOACS
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Screma"><span class="hs-identifier hs-type">SOAC.Screma</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684455032"><span class="annot"><span class="annottext">ScremaForm SOACS
</span><a href="#local-6989586621684455032"><span class="hs-identifier hs-var">form</span></a></span></span><span> </span><span class="annot"><span class="annottext">[Input]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">[Scan SOACS]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ScremaForm SOACS -&gt; Maybe [Scan SOACS]
forall rep. ScremaForm rep -&gt; Maybe [Scan rep]
</span><a href="Futhark.IR.SOACS.SOAC.html#isScanSOAC"><span class="hs-identifier hs-var">Futhark.isScanSOAC</span></a></span><span> </span><span class="annot"><span class="annottext">ScremaForm SOACS
</span><a href="#local-6989586621684455032"><span class="hs-identifier hs-var">form</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-523"></span><span>      </span><span class="hs-comment">-- A Scan soac can be currently only fused as a (sequential) stream,</span><span>
</span><span id="line-524"></span><span>      </span><span class="hs-comment">-- hence it is first translated to a (sequential) Stream and then</span><span>
</span><span id="line-525"></span><span>      </span><span class="hs-comment">-- fusion with a kernel is attempted.</span><span>
</span><span id="line-526"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684455030"><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455030"><span class="hs-identifier hs-var">soac_p'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684455029"><span class="annot"><span class="annottext">[Ident]
</span><a href="#local-6989586621684455029"><span class="hs-identifier hs-var">newacc_ids</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SOAC SOACS -&gt; TryFusion (SOAC SOACS, [Ident])
forall (m :: * -&gt; *) rep.
(MonadFreshNames m, Buildable rep, Op rep ~ SOAC rep) =&gt;
SOAC rep -&gt; m (SOAC rep, [Ident])
</span><a href="Futhark.Analysis.HORep.SOAC.html#soacToStream"><span class="hs-identifier hs-var">SOAC.soacToStream</span></a></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455165"><span class="hs-identifier hs-var">soac_p</span></a></span><span>
</span><span id="line-527"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455030"><span class="hs-identifier hs-var">soac_p'</span></a></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS -&gt; SOAC SOACS -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455165"><span class="hs-identifier hs-var">soac_p</span></a></span><span>
</span><span id="line-528"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Names
-&gt; [VName] -&gt; SOAC SOACS -&gt; Names -&gt; FusedKer -&gt; TryFusion FusedKer
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#fuseSOACwithKer"><span class="hs-identifier hs-var">fuseSOACwithKer</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684455167"><span class="hs-identifier hs-var">unfus_set</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Ident -&gt; VName) -&gt; [Ident] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Ident -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#identName"><span class="hs-identifier hs-var hs-var">identName</span></a></span><span> </span><span class="annot"><span class="annottext">[Ident]
</span><a href="#local-6989586621684455029"><span class="hs-identifier hs-var">newacc_ids</span></a></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455166"><span class="hs-identifier hs-var">outVars</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455030"><span class="hs-identifier hs-var">soac_p'</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684455164"><span class="hs-identifier hs-var">soac_p_consumed</span></a></span><span> </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455163"><span class="hs-identifier hs-var">ker</span></a></span><span>
</span><span id="line-529"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">String -&gt; TryFusion FusedKer
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;SOAC could not be turned into stream.&quot;</span></span><span>
</span><span id="line-530"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SOAC SOACS
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Stream"><span class="hs-identifier hs-type">SOAC.Stream</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684455028"><span class="annot"><span class="annottext">StreamForm SOACS
</span><a href="#local-6989586621684455028"><span class="hs-identifier hs-var">form_p</span></a></span></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[Input]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-531"></span><span>      </span><span class="hs-comment">-- If it reached this case then soac_c is NOT a Stream kernel,</span><span>
</span><span id="line-532"></span><span>      </span><span class="hs-comment">-- hence transform the kernel's soac to a stream and attempt</span><span>
</span><span id="line-533"></span><span>      </span><span class="hs-comment">-- stream-stream fusion recursivelly.</span><span>
</span><span id="line-534"></span><span>      </span><span class="hs-comment">-- The newly created stream corresponding to soac_c borrows the</span><span>
</span><span id="line-535"></span><span>      </span><span class="hs-comment">-- sequential/parallel property of the soac_p stream.</span><span>
</span><span id="line-536"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684455027"><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455027"><span class="hs-identifier hs-var">soac_c'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684455026"><span class="annot"><span class="annottext">[Ident]
</span><a href="#local-6989586621684455026"><span class="hs-identifier hs-var">newacc_ids</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SOAC SOACS -&gt; TryFusion (SOAC SOACS, [Ident])
forall (m :: * -&gt; *) rep.
(MonadFreshNames m, Buildable rep, Op rep ~ SOAC rep) =&gt;
SOAC rep -&gt; m (SOAC rep, [Ident])
</span><a href="Futhark.Analysis.HORep.SOAC.html#soacToStream"><span class="hs-identifier hs-var">SOAC.soacToStream</span></a></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455162"><span class="hs-identifier hs-var">soac_c</span></a></span><span>
</span><span id="line-537"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; TryFusion () -&gt; TryFusion ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455027"><span class="hs-identifier hs-var">soac_c'</span></a></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS -&gt; SOAC SOACS -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455162"><span class="hs-identifier hs-var">soac_c</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TryFusion () -&gt; TryFusion ()) -&gt; TryFusion () -&gt; TryFusion ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; TryFusion ()
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;SOAC could not be turned into stream.&quot;</span></span><span>
</span><span id="line-538"></span><span>      </span><span id="local-6989586621684455025"><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455025"><span class="hs-identifier hs-var">soac_c''</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">StreamForm SOACS
</span><a href="#local-6989586621684455028"><span class="hs-identifier hs-var">form_p</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-539"></span><span>        </span><span class="annot"><span class="annottext">StreamForm SOACS
</span><a href="Futhark.IR.SOACS.SOAC.html#Sequential"><span class="hs-identifier hs-var">Sequential</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SOAC SOACS -&gt; TryFusion (SOAC SOACS)
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#toSeqStream"><span class="hs-identifier hs-var">toSeqStream</span></a></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455027"><span class="hs-identifier hs-var">soac_c'</span></a></span><span>
</span><span id="line-540"></span><span>        </span><span class="annot"><span class="annottext">StreamForm SOACS
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SOAC SOACS -&gt; TryFusion (SOAC SOACS)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455027"><span class="hs-identifier hs-var">soac_c'</span></a></span><span>
</span><span id="line-541"></span><span>
</span><span id="line-542"></span><span>      </span><span class="annot"><span class="annottext">Names
-&gt; [VName] -&gt; SOAC SOACS -&gt; Names -&gt; FusedKer -&gt; TryFusion FusedKer
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#fuseSOACwithKer"><span class="hs-identifier hs-var">fuseSOACwithKer</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684455167"><span class="hs-identifier hs-var">unfus_set</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455166"><span class="hs-identifier hs-var">outVars</span></a></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455165"><span class="hs-identifier hs-var">soac_p</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684455164"><span class="hs-identifier hs-var">soac_p_consumed</span></a></span><span> </span><span class="annot"><span class="annottext">(FusedKer -&gt; TryFusion FusedKer) -&gt; FusedKer -&gt; TryFusion FusedKer
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-543"></span><span>        </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455163"><span class="hs-identifier hs-var">ker</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">fsoac :: SOAC SOACS
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#fsoac"><span class="hs-identifier hs-var">fsoac</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684455025"><span class="hs-identifier hs-var">soac_c''</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">outNames :: [VName]
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#outNames"><span class="hs-identifier hs-var">outNames</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Ident -&gt; VName) -&gt; [Ident] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Ident -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#identName"><span class="hs-identifier hs-var hs-var">identName</span></a></span><span> </span><span class="annot"><span class="annottext">[Ident]
</span><a href="#local-6989586621684455026"><span class="hs-identifier hs-var">newacc_ids</span></a></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">FusedKer -&gt; [VName]
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#outNames"><span class="hs-identifier hs-var hs-var">outNames</span></a></span><span> </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684455163"><span class="hs-identifier hs-var">ker</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-544"></span><span>
</span><span id="line-545"></span><span>    </span><span class="hs-comment">---------------------------------</span><span>
</span><span id="line-546"></span><span>    </span><span class="hs-comment">--- DEFAULT, CANNOT FUSE CASE ---</span><span>
</span><span id="line-547"></span><span>    </span><span class="hs-comment">---------------------------------</span><span>
</span><span id="line-548"></span><span>    </span><span class="annot"><span class="annottext">(SOAC SOACS, SOAC SOACS)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; TryFusion FusedKer
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Cannot fuse&quot;</span></span><span>
</span><span id="line-549"></span><span>
</span><span id="line-550"></span><span id="local-6989586621684456114"><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#getStreamOrder"><span class="hs-identifier hs-type">getStreamOrder</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#StreamForm"><span class="hs-identifier hs-type">StreamForm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684456114"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#StreamOrd"><span class="hs-identifier hs-type">StreamOrd</span></a></span></span><span>
</span><span id="line-551"></span><span id="getStreamOrder"><span class="annot"><span class="annottext">getStreamOrder :: forall rep. StreamForm rep -&gt; StreamOrd
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#getStreamOrder"><span class="hs-identifier hs-var hs-var">getStreamOrder</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Parallel"><span class="hs-identifier hs-type">Parallel</span></a></span><span> </span><span id="local-6989586621684455022"><span class="annot"><span class="annottext">StreamOrd
</span><a href="#local-6989586621684455022"><span class="hs-identifier hs-var">o</span></a></span></span><span> </span><span class="annot"><span class="annottext">Commutativity
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StreamOrd
</span><a href="#local-6989586621684455022"><span class="hs-identifier hs-var">o</span></a></span><span>
</span><span id="line-552"></span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#getStreamOrder"><span class="hs-identifier hs-var">getStreamOrder</span></a></span><span> </span><span class="annot"><span class="annottext">StreamForm rep
</span><a href="Futhark.IR.SOACS.SOAC.html#Sequential"><span class="hs-identifier hs-var">Sequential</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StreamOrd
</span><a href="Futhark.IR.SOACS.SOAC.html#InOrder"><span class="hs-identifier hs-var">InOrder</span></a></span><span>
</span><span id="line-553"></span><span>
</span><span id="line-554"></span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#fuseStreamHelper"><span class="hs-identifier hs-type">fuseStreamHelper</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-555"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-556"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-557"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-558"></span><span>  </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Ident"><span class="hs-identifier hs-type">Ident</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-559"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#SOAC"><span class="hs-identifier hs-type">SOAC</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-560"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#SOAC"><span class="hs-identifier hs-type">SOAC</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-561"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#TryFusion"><span class="hs-identifier hs-type">TryFusion</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#SOAC"><span class="hs-identifier hs-type">SOAC</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-562"></span><span id="fuseStreamHelper"><span class="annot"><span class="annottext">fuseStreamHelper :: [VName]
-&gt; Names
-&gt; [VName]
-&gt; [(VName, Ident)]
-&gt; SOAC SOACS
-&gt; SOAC SOACS
-&gt; TryFusion ([VName], SOAC SOACS)
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#fuseStreamHelper"><span class="hs-identifier hs-var hs-var">fuseStreamHelper</span></a></span></span><span>
</span><span id="line-563"></span><span>  </span><span id="local-6989586621684455020"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455020"><span class="hs-identifier hs-var">out_kernms</span></a></span></span><span>
</span><span id="line-564"></span><span>  </span><span id="local-6989586621684455019"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684455019"><span class="hs-identifier hs-var">unfus_set</span></a></span></span><span>
</span><span id="line-565"></span><span>  </span><span id="local-6989586621684455018"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455018"><span class="hs-identifier hs-var">outVars</span></a></span></span><span>
</span><span id="line-566"></span><span>  </span><span id="local-6989586621684455017"><span class="annot"><span class="annottext">[(VName, Ident)]
</span><a href="#local-6989586621684455017"><span class="hs-identifier hs-var">outPairs</span></a></span></span><span>
</span><span id="line-567"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Stream"><span class="hs-identifier hs-type">SOAC.Stream</span></a></span><span> </span><span id="local-6989586621684455016"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684455016"><span class="hs-identifier hs-var">w2</span></a></span></span><span> </span><span id="local-6989586621684455015"><span class="annot"><span class="annottext">StreamForm SOACS
</span><a href="#local-6989586621684455015"><span class="hs-identifier hs-var">form2</span></a></span></span><span> </span><span id="local-6989586621684455014"><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684455014"><span class="hs-identifier hs-var">lam2</span></a></span></span><span> </span><span id="local-6989586621684455013"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684455013"><span class="hs-identifier hs-var">nes2</span></a></span></span><span> </span><span id="local-6989586621684455012"><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684455012"><span class="hs-identifier hs-var">inp2_arr</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-568"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Stream"><span class="hs-identifier hs-type">SOAC.Stream</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684455011"><span class="annot"><span class="annottext">StreamForm SOACS
</span><a href="#local-6989586621684455011"><span class="hs-identifier hs-var">form1</span></a></span></span><span> </span><span id="local-6989586621684455010"><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684455010"><span class="hs-identifier hs-var">lam1</span></a></span></span><span> </span><span id="local-6989586621684455009"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684455009"><span class="hs-identifier hs-var">nes1</span></a></span></span><span> </span><span id="local-6989586621684455008"><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684455008"><span class="hs-identifier hs-var">inp1_arr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-569"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">StreamForm SOACS -&gt; StreamOrd
forall rep. StreamForm rep -&gt; StreamOrd
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#getStreamOrder"><span class="hs-identifier hs-var">getStreamOrder</span></a></span><span> </span><span class="annot"><span class="annottext">StreamForm SOACS
</span><a href="#local-6989586621684455015"><span class="hs-identifier hs-var">form2</span></a></span><span> </span><span class="annot"><span class="annottext">StreamOrd -&gt; StreamOrd -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">StreamForm SOACS -&gt; StreamOrd
forall rep. StreamForm rep -&gt; StreamOrd
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#getStreamOrder"><span class="hs-identifier hs-var">getStreamOrder</span></a></span><span> </span><span class="annot"><span class="annottext">StreamForm SOACS
</span><a href="#local-6989586621684455011"><span class="hs-identifier hs-var">form1</span></a></span><span>
</span><span id="line-570"></span><span>      </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">String -&gt; TryFusion ([VName], SOAC SOACS)
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;fusion conditions not met!&quot;</span></span><span>
</span><span id="line-571"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-572"></span><span>        </span><span class="hs-comment">-- very similar to redomap o redomap composition, but need</span><span>
</span><span id="line-573"></span><span>        </span><span class="hs-comment">-- to remove first the `chunk' parameters of streams'</span><span>
</span><span id="line-574"></span><span>        </span><span class="hs-comment">-- lambdas and put them in the resulting stream lambda.</span><span>
</span><span id="line-575"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684455007"><span class="annot"><span class="annottext">chunk1 :: Param (TypeBase (ShapeBase SubExp) NoUniqueness)
</span><a href="#local-6989586621684455007"><span class="hs-identifier hs-var hs-var">chunk1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
-&gt; Param (TypeBase (ShapeBase SubExp) NoUniqueness)
forall a. [a] -&gt; a
</span><span class="hs-identifier hs-var">head</span></span><span> </span><span class="annot"><span class="annottext">([Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
 -&gt; Param (TypeBase (ShapeBase SubExp) NoUniqueness))
-&gt; [Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
-&gt; Param (TypeBase (ShapeBase SubExp) NoUniqueness)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS -&gt; [LParam SOACS]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684455010"><span class="hs-identifier hs-var">lam1</span></a></span><span>
</span><span id="line-576"></span><span>            </span><span id="local-6989586621684455005"><span class="annot"><span class="annottext">chunk2 :: Param (TypeBase (ShapeBase SubExp) NoUniqueness)
</span><a href="#local-6989586621684455005"><span class="hs-identifier hs-var hs-var">chunk2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
-&gt; Param (TypeBase (ShapeBase SubExp) NoUniqueness)
forall a. [a] -&gt; a
</span><span class="hs-identifier hs-var">head</span></span><span> </span><span class="annot"><span class="annottext">([Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
 -&gt; Param (TypeBase (ShapeBase SubExp) NoUniqueness))
-&gt; [Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
-&gt; Param (TypeBase (ShapeBase SubExp) NoUniqueness)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS -&gt; [LParam SOACS]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684455014"><span class="hs-identifier hs-var">lam2</span></a></span><span>
</span><span id="line-577"></span><span>            </span><span id="local-6989586621684455004"><span class="annot"><span class="annottext">hmnms :: Map VName VName
</span><a href="#local-6989586621684455004"><span class="hs-identifier hs-var hs-var">hmnms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VName, VName)] -&gt; Map VName VName
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param (TypeBase (ShapeBase SubExp) NoUniqueness) -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param (TypeBase (ShapeBase SubExp) NoUniqueness)
</span><a href="#local-6989586621684455005"><span class="hs-identifier hs-var">chunk2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Param (TypeBase (ShapeBase SubExp) NoUniqueness) -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param (TypeBase (ShapeBase SubExp) NoUniqueness)
</span><a href="#local-6989586621684455007"><span class="hs-identifier hs-var">chunk1</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-578"></span><span>            </span><span id="local-6989586621684455002"><span class="annot"><span class="annottext">lam20 :: Lambda SOACS
</span><a href="#local-6989586621684455002"><span class="hs-identifier hs-var hs-var">lam20</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map VName VName -&gt; Lambda SOACS -&gt; Lambda SOACS
forall a. Substitute a =&gt; Map VName VName -&gt; a -&gt; a
</span><a href="Futhark.Transform.Substitute.html#substituteNames"><span class="hs-identifier hs-var">substituteNames</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684455004"><span class="hs-identifier hs-var">hmnms</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684455014"><span class="hs-identifier hs-var">lam2</span></a></span><span>
</span><span id="line-579"></span><span>            </span><span id="local-6989586621684455000"><span class="annot"><span class="annottext">lam1' :: Lambda SOACS
</span><a href="#local-6989586621684455000"><span class="hs-identifier hs-var hs-var">lam1'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684455010"><span class="hs-identifier hs-var">lam1</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">lambdaParams :: [LParam SOACS]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var">lambdaParams</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
-&gt; [Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">tail</span></span><span> </span><span class="annot"><span class="annottext">([Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
 -&gt; [Param (TypeBase (ShapeBase SubExp) NoUniqueness)])
-&gt; [Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
-&gt; [Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS -&gt; [LParam SOACS]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684455010"><span class="hs-identifier hs-var">lam1</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-580"></span><span>            </span><span id="local-6989586621684454998"><span class="annot"><span class="annottext">lam2' :: Lambda SOACS
</span><a href="#local-6989586621684454998"><span class="hs-identifier hs-var hs-var">lam2'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684455002"><span class="hs-identifier hs-var">lam20</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">lambdaParams :: [LParam SOACS]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var">lambdaParams</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
-&gt; [Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">tail</span></span><span> </span><span class="annot"><span class="annottext">([Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
 -&gt; [Param (TypeBase (ShapeBase SubExp) NoUniqueness)])
-&gt; [Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
-&gt; [Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS -&gt; [LParam SOACS]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684455002"><span class="hs-identifier hs-var">lam20</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-581"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621684454997"><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684454997"><span class="hs-identifier hs-var">res_lam'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684454996"><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684454996"><span class="hs-identifier hs-var">new_inp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-582"></span><span>              </span><span class="annot"><span class="annottext">Names
-&gt; [VName]
-&gt; Lambda SOACS
-&gt; [SubExp]
-&gt; [SubExp]
-&gt; [Input]
-&gt; [(VName, Ident)]
-&gt; Lambda SOACS
-&gt; [SubExp]
-&gt; [SubExp]
-&gt; [Input]
-&gt; (Lambda SOACS, [Input])
forall rep.
Buildable rep =&gt;
Names
-&gt; [VName]
-&gt; Lambda rep
-&gt; [SubExp]
-&gt; [SubExp]
-&gt; [Input]
-&gt; [(VName, Ident)]
-&gt; Lambda rep
-&gt; [SubExp]
-&gt; [SubExp]
-&gt; [Input]
-&gt; (Lambda rep, [Input])
</span><a href="Futhark.Optimise.Fusion.Composing.html#fuseRedomap"><span class="hs-identifier hs-var">fuseRedomap</span></a></span><span>
</span><span id="line-583"></span><span>                </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684455019"><span class="hs-identifier hs-var">unfus_set</span></a></span><span>
</span><span id="line-584"></span><span>                </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455018"><span class="hs-identifier hs-var">outVars</span></a></span><span>
</span><span id="line-585"></span><span>                </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684455000"><span class="hs-identifier hs-var">lam1'</span></a></span><span>
</span><span id="line-586"></span><span>                </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-587"></span><span>                </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684455009"><span class="hs-identifier hs-var">nes1</span></a></span><span>
</span><span id="line-588"></span><span>                </span><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684455008"><span class="hs-identifier hs-var">inp1_arr</span></a></span><span>
</span><span id="line-589"></span><span>                </span><span class="annot"><span class="annottext">[(VName, Ident)]
</span><a href="#local-6989586621684455017"><span class="hs-identifier hs-var">outPairs</span></a></span><span>
</span><span id="line-590"></span><span>                </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684454998"><span class="hs-identifier hs-var">lam2'</span></a></span><span>
</span><span id="line-591"></span><span>                </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-592"></span><span>                </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684455013"><span class="hs-identifier hs-var">nes2</span></a></span><span>
</span><span id="line-593"></span><span>                </span><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684455012"><span class="hs-identifier hs-var">inp2_arr</span></a></span><span>
</span><span id="line-594"></span><span>            </span><span id="local-6989586621684454995"><span class="annot"><span class="annottext">res_lam'' :: Lambda SOACS
</span><a href="#local-6989586621684454995"><span class="hs-identifier hs-var hs-var">res_lam''</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684454997"><span class="hs-identifier hs-var">res_lam'</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">lambdaParams :: [LParam SOACS]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var">lambdaParams</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Param (TypeBase (ShapeBase SubExp) NoUniqueness)
</span><a href="#local-6989586621684455007"><span class="hs-identifier hs-var">chunk1</span></a></span><span> </span><span class="annot"><span class="annottext">Param (TypeBase (ShapeBase SubExp) NoUniqueness)
-&gt; [Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
-&gt; [Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS -&gt; [LParam SOACS]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684454997"><span class="hs-identifier hs-var">res_lam'</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-595"></span><span>            </span><span id="local-6989586621684454994"><span class="annot"><span class="annottext">unfus_accs :: [VName]
</span><a href="#local-6989586621684454994"><span class="hs-identifier hs-var hs-var">unfus_accs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [VName] -&gt; [VName]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">take</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684455009"><span class="hs-identifier hs-var">nes1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455018"><span class="hs-identifier hs-var">outVars</span></a></span><span>
</span><span id="line-596"></span><span>            </span><span id="local-6989586621684454993"><span class="annot"><span class="annottext">unfus_arrs :: [VName]
</span><a href="#local-6989586621684454993"><span class="hs-identifier hs-var hs-var">unfus_arrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Bool) -&gt; [VName] -&gt; [VName]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; [VName] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`notElem`</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684454994"><span class="hs-identifier hs-var">unfus_accs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; [VName]) -&gt; [VName] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Bool) -&gt; [VName] -&gt; [VName]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#nameIn"><span class="hs-operator hs-var">`nameIn`</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684455019"><span class="hs-identifier hs-var">unfus_set</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455018"><span class="hs-identifier hs-var">outVars</span></a></span><span>
</span><span id="line-597"></span><span>        </span><span id="local-6989586621684454991"><span class="annot"><span class="annottext">StreamForm SOACS
</span><a href="#local-6989586621684454991"><span class="hs-identifier hs-var">res_form</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StreamForm SOACS
-&gt; StreamForm SOACS -&gt; TryFusion (StreamForm SOACS)
forall {m :: * -&gt; *} {rep}.
MonadFail m =&gt;
StreamForm rep -&gt; StreamForm rep -&gt; m (StreamForm rep)
</span><a href="#local-6989586621684454990"><span class="hs-identifier hs-var">mergeForms</span></a></span><span> </span><span class="annot"><span class="annottext">StreamForm SOACS
</span><a href="#local-6989586621684455015"><span class="hs-identifier hs-var">form2</span></a></span><span> </span><span class="annot"><span class="annottext">StreamForm SOACS
</span><a href="#local-6989586621684455011"><span class="hs-identifier hs-var">form1</span></a></span><span>
</span><span id="line-598"></span><span>        </span><span class="annot"><span class="annottext">([VName], SOAC SOACS) -&gt; TryFusion ([VName], SOAC SOACS)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-599"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684454994"><span class="hs-identifier hs-var">unfus_accs</span></a></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684455020"><span class="hs-identifier hs-var">out_kernms</span></a></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684454993"><span class="hs-identifier hs-var">unfus_arrs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-600"></span><span>            </span><span class="annot"><span class="annottext">SubExp
-&gt; StreamForm SOACS
-&gt; Lambda SOACS
-&gt; [SubExp]
-&gt; [Input]
-&gt; SOAC SOACS
forall rep.
SubExp
-&gt; StreamForm rep -&gt; Lambda rep -&gt; [SubExp] -&gt; [Input] -&gt; SOAC rep
</span><a href="Futhark.Analysis.HORep.SOAC.html#Stream"><span class="hs-identifier hs-var">SOAC.Stream</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684455016"><span class="hs-identifier hs-var">w2</span></a></span><span> </span><span class="annot"><span class="annottext">StreamForm SOACS
</span><a href="#local-6989586621684454991"><span class="hs-identifier hs-var">res_form</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684454995"><span class="hs-identifier hs-var">res_lam''</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684455009"><span class="hs-identifier hs-var">nes1</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; [SubExp] -&gt; [SubExp]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684455013"><span class="hs-identifier hs-var">nes2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684454996"><span class="hs-identifier hs-var">new_inp</span></a></span><span>
</span><span id="line-601"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-602"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-603"></span><span>      </span><span id="local-6989586621684454990"><span class="annot"><span class="annottext">mergeForms :: StreamForm rep -&gt; StreamForm rep -&gt; m (StreamForm rep)
</span><a href="#local-6989586621684454990"><span class="hs-identifier hs-var hs-var">mergeForms</span></a></span></span><span> </span><span class="annot"><span class="annottext">StreamForm rep
</span><a href="Futhark.IR.SOACS.SOAC.html#Sequential"><span class="hs-identifier hs-var">Sequential</span></a></span><span> </span><span class="annot"><span class="annottext">StreamForm rep
</span><a href="Futhark.IR.SOACS.SOAC.html#Sequential"><span class="hs-identifier hs-var">Sequential</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StreamForm rep -&gt; m (StreamForm rep)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">StreamForm rep
forall rep. StreamForm rep
</span><a href="Futhark.IR.SOACS.SOAC.html#Sequential"><span class="hs-identifier hs-var">Sequential</span></a></span><span>
</span><span id="line-604"></span><span>      </span><span class="annot"><a href="#local-6989586621684454990"><span class="hs-identifier hs-var">mergeForms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Parallel"><span class="hs-identifier hs-type">Parallel</span></a></span><span> </span><span class="annot"><span class="annottext">StreamOrd
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684454981"><span class="annot"><span class="annottext">Commutativity
</span><a href="#local-6989586621684454981"><span class="hs-identifier hs-var">comm2</span></a></span></span><span> </span><span id="local-6989586621684454980"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684454980"><span class="hs-identifier hs-var">lam2r</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Parallel"><span class="hs-identifier hs-type">Parallel</span></a></span><span> </span><span id="local-6989586621684454979"><span class="annot"><span class="annottext">StreamOrd
</span><a href="#local-6989586621684454979"><span class="hs-identifier hs-var">o1</span></a></span></span><span> </span><span id="local-6989586621684454978"><span class="annot"><span class="annottext">Commutativity
</span><a href="#local-6989586621684454978"><span class="hs-identifier hs-var">comm1</span></a></span></span><span> </span><span id="local-6989586621684454977"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684454977"><span class="hs-identifier hs-var">lam1r</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-605"></span><span>        </span><span class="annot"><span class="annottext">StreamForm rep -&gt; m (StreamForm rep)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(StreamForm rep -&gt; m (StreamForm rep))
-&gt; StreamForm rep -&gt; m (StreamForm rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">StreamOrd -&gt; Commutativity -&gt; Lambda rep -&gt; StreamForm rep
forall rep.
StreamOrd -&gt; Commutativity -&gt; Lambda rep -&gt; StreamForm rep
</span><a href="Futhark.IR.SOACS.SOAC.html#Parallel"><span class="hs-identifier hs-var">Parallel</span></a></span><span> </span><span class="annot"><span class="annottext">StreamOrd
</span><a href="#local-6989586621684454979"><span class="hs-identifier hs-var">o1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Commutativity
</span><a href="#local-6989586621684454978"><span class="hs-identifier hs-var">comm1</span></a></span><span> </span><span class="annot"><span class="annottext">Commutativity -&gt; Commutativity -&gt; Commutativity
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Commutativity
</span><a href="#local-6989586621684454981"><span class="hs-identifier hs-var">comm2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda rep -&gt; Lambda rep -&gt; Lambda rep
forall rep. Lambda rep -&gt; Lambda rep -&gt; Lambda rep
</span><a href="Futhark.Optimise.Fusion.Composing.html#mergeReduceOps"><span class="hs-identifier hs-var">mergeReduceOps</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684454977"><span class="hs-identifier hs-var">lam1r</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684454980"><span class="hs-identifier hs-var">lam2r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-606"></span><span>      </span><span class="annot"><a href="#local-6989586621684454990"><span class="hs-identifier hs-var">mergeForms</span></a></span><span> </span><span class="annot"><span class="annottext">StreamForm rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StreamForm rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; m (StreamForm rep)
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Fusing sequential to parallel stream disallowed!&quot;</span></span><span>
</span><span id="line-607"></span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#fuseStreamHelper"><span class="hs-identifier hs-var">fuseStreamHelper</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Names
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[(VName, Ident)]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; TryFusion ([VName], SOAC SOACS)
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Cannot Fuse Streams!&quot;</span></span><span>
</span><span id="line-608"></span><span>
</span><span id="line-609"></span><span class="hs-comment">-- | If a Stream is passed as argument then it converts it to a</span><span>
</span><span id="line-610"></span><span class="hs-comment">--   Sequential Stream; Otherwise it FAILS!</span><span>
</span><span id="line-611"></span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#toSeqStream"><span class="hs-identifier hs-type">toSeqStream</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#SOAC"><span class="hs-identifier hs-type">SOAC</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#TryFusion"><span class="hs-identifier hs-type">TryFusion</span></a></span><span> </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#SOAC"><span class="hs-identifier hs-type">SOAC</span></a></span><span>
</span><span id="line-612"></span><span id="toSeqStream"><span class="annot"><span class="annottext">toSeqStream :: SOAC SOACS -&gt; TryFusion (SOAC SOACS)
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#toSeqStream"><span class="hs-identifier hs-var hs-var">toSeqStream</span></a></span></span><span> </span><span id="local-6989586621684454975"><span class="annot"><span class="annottext">s :: SOAC SOACS
</span><a href="#local-6989586621684454975"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Stream"><span class="hs-identifier hs-type">SOAC.Stream</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StreamForm SOACS
</span><a href="Futhark.IR.SOACS.SOAC.html#Sequential"><span class="hs-identifier hs-var">Sequential</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[Input]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SOAC SOACS -&gt; TryFusion (SOAC SOACS)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684454975"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-613"></span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#toSeqStream"><span class="hs-identifier hs-var">toSeqStream</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Stream"><span class="hs-identifier hs-type">SOAC.Stream</span></a></span><span> </span><span id="local-6989586621684454974"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684454974"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Parallel"><span class="hs-identifier hs-type">Parallel</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span id="local-6989586621684454973"><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684454973"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span id="local-6989586621684454972"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684454972"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621684454971"><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684454971"><span class="hs-identifier hs-var">inps</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-614"></span><span>  </span><span class="annot"><span class="annottext">SOAC SOACS -&gt; TryFusion (SOAC SOACS)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(SOAC SOACS -&gt; TryFusion (SOAC SOACS))
-&gt; SOAC SOACS -&gt; TryFusion (SOAC SOACS)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp
-&gt; StreamForm SOACS
-&gt; Lambda SOACS
-&gt; [SubExp]
-&gt; [Input]
-&gt; SOAC SOACS
forall rep.
SubExp
-&gt; StreamForm rep -&gt; Lambda rep -&gt; [SubExp] -&gt; [Input] -&gt; SOAC rep
</span><a href="Futhark.Analysis.HORep.SOAC.html#Stream"><span class="hs-identifier hs-var">SOAC.Stream</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684454974"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">StreamForm SOACS
forall rep. StreamForm rep
</span><a href="Futhark.IR.SOACS.SOAC.html#Sequential"><span class="hs-identifier hs-var">Sequential</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684454973"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684454972"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684454971"><span class="hs-identifier hs-var">inps</span></a></span><span>
</span><span id="line-615"></span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#toSeqStream"><span class="hs-identifier hs-var">toSeqStream</span></a></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; TryFusion (SOAC SOACS)
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;toSeqStream expects a stream, but given a SOAC.&quot;</span></span><span>
</span><span id="line-616"></span><span>
</span><span id="line-617"></span><span class="hs-comment">-- Here follows optimizations and transforms to expose fusability.</span><span>
</span><span id="line-618"></span><span>
</span><span id="line-619"></span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#optimizeKernel"><span class="hs-identifier hs-type">optimizeKernel</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#FusedKer"><span class="hs-identifier hs-type">FusedKer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#TryFusion"><span class="hs-identifier hs-type">TryFusion</span></a></span><span> </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#FusedKer"><span class="hs-identifier hs-type">FusedKer</span></a></span><span>
</span><span id="line-620"></span><span id="optimizeKernel"><span class="annot"><span class="annottext">optimizeKernel :: Maybe [VName] -&gt; FusedKer -&gt; TryFusion FusedKer
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#optimizeKernel"><span class="hs-identifier hs-var hs-var">optimizeKernel</span></a></span></span><span> </span><span id="local-6989586621684454970"><span class="annot"><span class="annottext">Maybe [VName]
</span><a href="#local-6989586621684454970"><span class="hs-identifier hs-var">inp</span></a></span></span><span> </span><span id="local-6989586621684454969"><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684454969"><span class="hs-identifier hs-var">ker</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-621"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684454968"><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684454968"><span class="hs-identifier hs-var">soac</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684454967"><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684454967"><span class="hs-identifier hs-var">resTrans</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe [VName]
-&gt; SOAC SOACS
-&gt; ArrayTransforms
-&gt; TryFusion (SOAC SOACS, ArrayTransforms)
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#optimizeSOAC"><span class="hs-identifier hs-var">optimizeSOAC</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe [VName]
</span><a href="#local-6989586621684454970"><span class="hs-identifier hs-var">inp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FusedKer -&gt; SOAC SOACS
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#fsoac"><span class="hs-identifier hs-var hs-var">fsoac</span></a></span><span> </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684454969"><span class="hs-identifier hs-var">ker</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684454966"><span class="hs-identifier hs-var">startTrans</span></a></span><span>
</span><span id="line-622"></span><span>  </span><span class="annot"><span class="annottext">FusedKer -&gt; TryFusion FusedKer
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(FusedKer -&gt; TryFusion FusedKer) -&gt; FusedKer -&gt; TryFusion FusedKer
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-623"></span><span>    </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684454969"><span class="hs-identifier hs-var">ker</span></a></span><span>
</span><span id="line-624"></span><span>      </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fsoac :: SOAC SOACS
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#fsoac"><span class="hs-identifier hs-var">fsoac</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684454968"><span class="hs-identifier hs-var">soac</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-625"></span><span>        </span><span class="annot"><span class="annottext">outputTransform :: ArrayTransforms
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#outputTransform"><span class="hs-identifier hs-var">outputTransform</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684454967"><span class="hs-identifier hs-var">resTrans</span></a></span><span>
</span><span id="line-626"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-627"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-628"></span><span>    </span><span id="local-6989586621684454966"><span class="annot"><span class="annottext">startTrans :: ArrayTransforms
</span><a href="#local-6989586621684454966"><span class="hs-identifier hs-var hs-var">startTrans</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FusedKer -&gt; ArrayTransforms
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#outputTransform"><span class="hs-identifier hs-var hs-var">outputTransform</span></a></span><span> </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684454969"><span class="hs-identifier hs-var">ker</span></a></span><span>
</span><span id="line-629"></span><span>
</span><span id="line-630"></span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#optimizeSOAC"><span class="hs-identifier hs-type">optimizeSOAC</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-631"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-632"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#SOAC"><span class="hs-identifier hs-type">SOAC</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-633"></span><span>  </span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#ArrayTransforms"><span class="hs-identifier hs-type">SOAC.ArrayTransforms</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-634"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#TryFusion"><span class="hs-identifier hs-type">TryFusion</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#SOAC"><span class="hs-identifier hs-type">SOAC</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#ArrayTransforms"><span class="hs-identifier hs-type">SOAC.ArrayTransforms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-635"></span><span id="optimizeSOAC"><span class="annot"><span class="annottext">optimizeSOAC :: Maybe [VName]
-&gt; SOAC SOACS
-&gt; ArrayTransforms
-&gt; TryFusion (SOAC SOACS, ArrayTransforms)
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#optimizeSOAC"><span class="hs-identifier hs-var hs-var">optimizeSOAC</span></a></span></span><span> </span><span id="local-6989586621684454965"><span class="annot"><span class="annottext">Maybe [VName]
</span><a href="#local-6989586621684454965"><span class="hs-identifier hs-var">inp</span></a></span></span><span> </span><span id="local-6989586621684454964"><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684454964"><span class="hs-identifier hs-var">soac</span></a></span></span><span> </span><span id="local-6989586621684454963"><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684454963"><span class="hs-identifier hs-var">os</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-636"></span><span>  </span><span id="local-6989586621684454962"><span class="annot"><span class="annottext">(Bool, SOAC SOACS, ArrayTransforms)
</span><a href="#local-6989586621684454962"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((Bool, SOAC SOACS, ArrayTransforms)
 -&gt; (Maybe [VName]
     -&gt; SOAC SOACS
     -&gt; ArrayTransforms
     -&gt; TryFusion (SOAC SOACS, ArrayTransforms))
 -&gt; TryFusion (Bool, SOAC SOACS, ArrayTransforms))
-&gt; (Bool, SOAC SOACS, ArrayTransforms)
-&gt; [Maybe [VName]
    -&gt; SOAC SOACS
    -&gt; ArrayTransforms
    -&gt; TryFusion (SOAC SOACS, ArrayTransforms)]
-&gt; TryFusion (Bool, SOAC SOACS, ArrayTransforms)
forall (t :: * -&gt; *) (m :: * -&gt; *) b a.
(Foldable t, Monad m) =&gt;
(b -&gt; a -&gt; m b) -&gt; b -&gt; t a -&gt; m b
</span><span class="hs-identifier hs-var">foldM</span></span><span> </span><span class="annot"><span class="annottext">(Bool, SOAC SOACS, ArrayTransforms)
-&gt; (Maybe [VName]
    -&gt; SOAC SOACS
    -&gt; ArrayTransforms
    -&gt; TryFusion (SOAC SOACS, ArrayTransforms))
-&gt; TryFusion (Bool, SOAC SOACS, ArrayTransforms)
</span><a href="#local-6989586621684454960"><span class="hs-identifier hs-var">comb</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684454964"><span class="hs-identifier hs-var">soac</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684454963"><span class="hs-identifier hs-var">os</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Maybe [VName]
 -&gt; SOAC SOACS
 -&gt; ArrayTransforms
 -&gt; TryFusion (SOAC SOACS, ArrayTransforms)]
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#optimizations"><span class="hs-identifier hs-var">optimizations</span></a></span><span>
</span><span id="line-637"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(Bool, SOAC SOACS, ArrayTransforms)
</span><a href="#local-6989586621684454962"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-638"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ArrayTransforms
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; TryFusion (SOAC SOACS, ArrayTransforms)
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;No optimisation applied&quot;</span></span><span>
</span><span id="line-639"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684454958"><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684454958"><span class="hs-identifier hs-var">soac'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684454957"><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684454957"><span class="hs-identifier hs-var">os'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(SOAC SOACS, ArrayTransforms)
-&gt; TryFusion (SOAC SOACS, ArrayTransforms)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684454958"><span class="hs-identifier hs-var">soac'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684454957"><span class="hs-identifier hs-var">os'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-640"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-641"></span><span>    </span><span id="local-6989586621684454960"><span class="annot"><span class="annottext">comb :: (Bool, SOAC SOACS, ArrayTransforms)
-&gt; (Maybe [VName]
    -&gt; SOAC SOACS
    -&gt; ArrayTransforms
    -&gt; TryFusion (SOAC SOACS, ArrayTransforms))
-&gt; TryFusion (Bool, SOAC SOACS, ArrayTransforms)
</span><a href="#local-6989586621684454960"><span class="hs-identifier hs-var hs-var">comb</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684454956"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684454956"><span class="hs-identifier hs-var">changed</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684454955"><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684454955"><span class="hs-identifier hs-var">soac'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684454954"><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684454954"><span class="hs-identifier hs-var">os'</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684454953"><span class="annot"><span class="annottext">Maybe [VName]
-&gt; SOAC SOACS
-&gt; ArrayTransforms
-&gt; TryFusion (SOAC SOACS, ArrayTransforms)
</span><a href="#local-6989586621684454953"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-642"></span><span>      </span><span class="hs-keyword">do</span><span>
</span><span id="line-643"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621684454952"><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684454952"><span class="hs-identifier hs-var">soac''</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684454951"><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684454951"><span class="hs-identifier hs-var">os''</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe [VName]
-&gt; SOAC SOACS
-&gt; ArrayTransforms
-&gt; TryFusion (SOAC SOACS, ArrayTransforms)
</span><a href="#local-6989586621684454953"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe [VName]
</span><a href="#local-6989586621684454965"><span class="hs-identifier hs-var">inp</span></a></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684454955"><span class="hs-identifier hs-var">soac'</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684454963"><span class="hs-identifier hs-var">os</span></a></span><span>
</span><span id="line-644"></span><span>        </span><span class="annot"><span class="annottext">(Bool, SOAC SOACS, ArrayTransforms)
-&gt; TryFusion (Bool, SOAC SOACS, ArrayTransforms)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684454952"><span class="hs-identifier hs-var">soac''</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684454951"><span class="hs-identifier hs-var">os''</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-645"></span><span>        </span><span class="annot"><span class="annottext">TryFusion (Bool, SOAC SOACS, ArrayTransforms)
-&gt; TryFusion (Bool, SOAC SOACS, ArrayTransforms)
-&gt; TryFusion (Bool, SOAC SOACS, ArrayTransforms)
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Bool, SOAC SOACS, ArrayTransforms)
-&gt; TryFusion (Bool, SOAC SOACS, ArrayTransforms)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684454956"><span class="hs-identifier hs-var">changed</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684454955"><span class="hs-identifier hs-var">soac'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684454954"><span class="hs-identifier hs-var">os'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-646"></span><span>
</span><span id="line-647"></span><span class="hs-keyword">type</span><span> </span><span id="Optimization"><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#Optimization"><span class="hs-identifier hs-var">Optimization</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-648"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-649"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#SOAC"><span class="hs-identifier hs-type">SOAC</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-650"></span><span>  </span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#ArrayTransforms"><span class="hs-identifier hs-type">SOAC.ArrayTransforms</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-651"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#TryFusion"><span class="hs-identifier hs-type">TryFusion</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#SOAC"><span class="hs-identifier hs-type">SOAC</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#ArrayTransforms"><span class="hs-identifier hs-type">SOAC.ArrayTransforms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-652"></span><span>
</span><span id="line-653"></span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#optimizations"><span class="hs-identifier hs-type">optimizations</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#Optimization"><span class="hs-identifier hs-type">Optimization</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-654"></span><span id="optimizations"><span class="annot"><span class="annottext">optimizations :: [Maybe [VName]
 -&gt; SOAC SOACS
 -&gt; ArrayTransforms
 -&gt; TryFusion (SOAC SOACS, ArrayTransforms)]
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#optimizations"><span class="hs-identifier hs-var hs-var">optimizations</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Maybe [VName]
-&gt; SOAC SOACS
-&gt; ArrayTransforms
-&gt; TryFusion (SOAC SOACS, ArrayTransforms)
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#iswim"><span class="hs-identifier hs-var">iswim</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-655"></span><span>
</span><span id="line-656"></span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#iswim"><span class="hs-identifier hs-type">iswim</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-657"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-658"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#SOAC"><span class="hs-identifier hs-type">SOAC</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-659"></span><span>  </span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#ArrayTransforms"><span class="hs-identifier hs-type">SOAC.ArrayTransforms</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-660"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#TryFusion"><span class="hs-identifier hs-type">TryFusion</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#SOAC"><span class="hs-identifier hs-type">SOAC</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#ArrayTransforms"><span class="hs-identifier hs-type">SOAC.ArrayTransforms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-661"></span><span id="iswim"><span class="annot"><span class="annottext">iswim :: Maybe [VName]
-&gt; SOAC SOACS
-&gt; ArrayTransforms
-&gt; TryFusion (SOAC SOACS, ArrayTransforms)
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#iswim"><span class="hs-identifier hs-var hs-var">iswim</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe [VName]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Screma"><span class="hs-identifier hs-type">SOAC.Screma</span></a></span><span> </span><span id="local-6989586621684454948"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684454948"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684454947"><span class="annot"><span class="annottext">ScremaForm SOACS
</span><a href="#local-6989586621684454947"><span class="hs-identifier hs-var">form</span></a></span></span><span> </span><span id="local-6989586621684454946"><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684454946"><span class="hs-identifier hs-var">arrs</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684454945"><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684454945"><span class="hs-identifier hs-var">ots</span></a></span></span><span>
</span><span id="line-662"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Scan"><span class="hs-identifier hs-type">Futhark.Scan</span></a></span><span> </span><span id="local-6989586621684454943"><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684454943"><span class="hs-identifier hs-var">scan_fun</span></a></span></span><span> </span><span id="local-6989586621684454942"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684454942"><span class="hs-identifier hs-var">nes</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ScremaForm SOACS -&gt; Maybe [Scan SOACS]
forall rep. ScremaForm rep -&gt; Maybe [Scan rep]
</span><a href="Futhark.IR.SOACS.SOAC.html#isScanSOAC"><span class="hs-identifier hs-var">Futhark.isScanSOAC</span></a></span><span> </span><span class="annot"><span class="annottext">ScremaForm SOACS
</span><a href="#local-6989586621684454947"><span class="hs-identifier hs-var">form</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-663"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684454941"><span class="annot"><span class="annottext">Pat
</span><a href="#local-6989586621684454941"><span class="hs-identifier hs-var">map_pat</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684454940"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684454940"><span class="hs-identifier hs-var">map_cs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684454939"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684454939"><span class="hs-identifier hs-var">map_w</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684454938"><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684454938"><span class="hs-identifier hs-var">map_fun</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Lambda SOACS -&gt; Maybe (Pat, Certs, SubExp, Lambda SOACS)
</span><a href="Futhark.Pass.ExtractKernels.ISRWIM.html#rwimPossible"><span class="hs-identifier hs-var">rwimPossible</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684454943"><span class="hs-identifier hs-var">scan_fun</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-664"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684454937"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684454937"><span class="hs-identifier hs-var">nes_names</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; Maybe VName) -&gt; [SubExp] -&gt; Maybe [VName]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Maybe VName
</span><a href="Futhark.IR.Prop.html#subExpVar"><span class="hs-identifier hs-var">subExpVar</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684454942"><span class="hs-identifier hs-var">nes</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-665"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684454935"><span class="annot"><span class="annottext">nes_idents :: [Ident]
</span><a href="#local-6989586621684454935"><span class="hs-identifier hs-var hs-var">nes_idents</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; TypeBase (ShapeBase SubExp) NoUniqueness -&gt; Ident)
-&gt; [VName] -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness] -&gt; [Ident]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TypeBase (ShapeBase SubExp) NoUniqueness -&gt; Ident
</span><a href="Futhark.IR.Syntax.Core.html#Ident"><span class="hs-identifier hs-var">Ident</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684454937"><span class="hs-identifier hs-var">nes_names</span></a></span><span> </span><span class="annot"><span class="annottext">([TypeBase (ShapeBase SubExp) NoUniqueness] -&gt; [Ident])
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness] -&gt; [Ident]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
forall rep.
LambdaT rep -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684454943"><span class="hs-identifier hs-var">scan_fun</span></a></span><span>
</span><span id="line-666"></span><span>        </span><span id="local-6989586621684454934"><span class="annot"><span class="annottext">map_nes :: [Input]
</span><a href="#local-6989586621684454934"><span class="hs-identifier hs-var hs-var">map_nes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Ident -&gt; Input) -&gt; [Ident] -&gt; [Input]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Ident -&gt; Input
</span><a href="Futhark.Analysis.HORep.SOAC.html#identInput"><span class="hs-identifier hs-var">SOAC.identInput</span></a></span><span> </span><span class="annot"><span class="annottext">[Ident]
</span><a href="#local-6989586621684454935"><span class="hs-identifier hs-var">nes_idents</span></a></span><span>
</span><span id="line-667"></span><span>        </span><span id="local-6989586621684454932"><span class="annot"><span class="annottext">map_arrs' :: [Input]
</span><a href="#local-6989586621684454932"><span class="hs-identifier hs-var hs-var">map_arrs'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684454934"><span class="hs-identifier hs-var">map_nes</span></a></span><span> </span><span class="annot"><span class="annottext">[Input] -&gt; [Input] -&gt; [Input]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">(Input -&gt; Input) -&gt; [Input] -&gt; [Input]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Input -&gt; Input
</span><a href="Futhark.Analysis.HORep.SOAC.html#transposeInput"><span class="hs-identifier hs-var">SOAC.transposeInput</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684454946"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-668"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621684454930"><span class="annot"><span class="annottext">[Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
</span><a href="#local-6989586621684454930"><span class="hs-identifier hs-var">scan_acc_params</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684454929"><span class="annot"><span class="annottext">[Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
</span><a href="#local-6989586621684454929"><span class="hs-identifier hs-var">scan_elem_params</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-669"></span><span>          </span><span class="annot"><span class="annottext">Int
-&gt; [Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
-&gt; ([Param (TypeBase (ShapeBase SubExp) NoUniqueness)],
    [Param (TypeBase (ShapeBase SubExp) NoUniqueness)])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Input] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684454946"><span class="hs-identifier hs-var">arrs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
 -&gt; ([Param (TypeBase (ShapeBase SubExp) NoUniqueness)],
     [Param (TypeBase (ShapeBase SubExp) NoUniqueness)]))
-&gt; [Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
-&gt; ([Param (TypeBase (ShapeBase SubExp) NoUniqueness)],
    [Param (TypeBase (ShapeBase SubExp) NoUniqueness)])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS -&gt; [LParam SOACS]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684454943"><span class="hs-identifier hs-var">scan_fun</span></a></span><span>
</span><span id="line-670"></span><span>        </span><span id="local-6989586621684454927"><span class="annot"><span class="annottext">map_params :: [Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
</span><a href="#local-6989586621684454927"><span class="hs-identifier hs-var hs-var">map_params</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-671"></span><span>          </span><span class="annot"><span class="annottext">(Param (TypeBase (ShapeBase SubExp) NoUniqueness)
 -&gt; Param (TypeBase (ShapeBase SubExp) NoUniqueness))
-&gt; [Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
-&gt; [Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Param (TypeBase (ShapeBase SubExp) NoUniqueness)
-&gt; Param (TypeBase (ShapeBase SubExp) NoUniqueness)
LParam SOACS -&gt; LParam SOACS
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#removeParamOuterDim"><span class="hs-identifier hs-var">removeParamOuterDim</span></a></span><span> </span><span class="annot"><span class="annottext">[Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
</span><a href="#local-6989586621684454930"><span class="hs-identifier hs-var">scan_acc_params</span></a></span><span>
</span><span id="line-672"></span><span>            </span><span class="annot"><span class="annottext">[Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
-&gt; [Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
-&gt; [Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">(Param (TypeBase (ShapeBase SubExp) NoUniqueness)
 -&gt; Param (TypeBase (ShapeBase SubExp) NoUniqueness))
-&gt; [Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
-&gt; [Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp -&gt; LParam SOACS -&gt; LParam SOACS
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#setParamOuterDimTo"><span class="hs-identifier hs-var">setParamOuterDimTo</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684454948"><span class="hs-identifier hs-var">w</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
</span><a href="#local-6989586621684454929"><span class="hs-identifier hs-var">scan_elem_params</span></a></span><span>
</span><span id="line-673"></span><span>        </span><span id="local-6989586621684454924"><span class="annot"><span class="annottext">map_rettype :: [TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="#local-6989586621684454924"><span class="hs-identifier hs-var hs-var">map_rettype</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TypeBase (ShapeBase SubExp) NoUniqueness
 -&gt; TypeBase (ShapeBase SubExp) NoUniqueness)
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeBase (ShapeBase SubExp) NoUniqueness
-&gt; SubExp -&gt; TypeBase (ShapeBase SubExp) NoUniqueness
forall d u.
ArrayShape (ShapeBase d) =&gt;
TypeBase (ShapeBase d) u -&gt; d -&gt; TypeBase (ShapeBase d) u
</span><a href="Futhark.IR.Prop.Types.html#setOuterSize"><span class="hs-operator hs-var">`setOuterSize`</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684454948"><span class="hs-identifier hs-var">w</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([TypeBase (ShapeBase SubExp) NoUniqueness]
 -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness])
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
forall rep.
LambdaT rep -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684454943"><span class="hs-identifier hs-var">scan_fun</span></a></span><span>
</span><span id="line-674"></span><span>
</span><span id="line-675"></span><span>        </span><span id="local-6989586621684454922"><span class="annot"><span class="annottext">scan_params :: [LParam SOACS]
</span><a href="#local-6989586621684454922"><span class="hs-identifier hs-var hs-var">scan_params</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Lambda SOACS -&gt; [LParam SOACS]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684454938"><span class="hs-identifier hs-var">map_fun</span></a></span><span>
</span><span id="line-676"></span><span>        </span><span id="local-6989586621684454921"><span class="annot"><span class="annottext">scan_body :: BodyT SOACS
</span><a href="#local-6989586621684454921"><span class="hs-identifier hs-var hs-var">scan_body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Lambda SOACS -&gt; BodyT SOACS
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684454938"><span class="hs-identifier hs-var">map_fun</span></a></span><span>
</span><span id="line-677"></span><span>        </span><span id="local-6989586621684454920"><span class="annot"><span class="annottext">scan_rettype :: [TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="#local-6989586621684454920"><span class="hs-identifier hs-var hs-var">scan_rettype</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Lambda SOACS -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
forall rep.
LambdaT rep -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684454938"><span class="hs-identifier hs-var">map_fun</span></a></span><span>
</span><span id="line-678"></span><span>        </span><span id="local-6989586621684454919"><span class="annot"><span class="annottext">scan_fun' :: Lambda SOACS
</span><a href="#local-6989586621684454919"><span class="hs-identifier hs-var hs-var">scan_fun'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[LParam SOACS]
-&gt; BodyT SOACS
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; Lambda SOACS
forall rep.
[LParam rep]
-&gt; BodyT rep
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; LambdaT rep
</span><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-var">Lambda</span></a></span><span> </span><span class="annot"><span class="annottext">[LParam SOACS]
</span><a href="#local-6989586621684454922"><span class="hs-identifier hs-var">scan_params</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT SOACS
</span><a href="#local-6989586621684454921"><span class="hs-identifier hs-var">scan_body</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="#local-6989586621684454920"><span class="hs-identifier hs-var">scan_rettype</span></a></span><span>
</span><span id="line-679"></span><span>        </span><span id="local-6989586621684454918"><span class="annot"><span class="annottext">nes' :: [SubExp]
</span><a href="#local-6989586621684454918"><span class="hs-identifier hs-var hs-var">nes'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SubExp) -&gt; [VName] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; [SubExp]) -&gt; [VName] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [VName] -&gt; [VName]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">take</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Input] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684454934"><span class="hs-identifier hs-var">map_nes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; [VName]) -&gt; [VName] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Param (TypeBase (ShapeBase SubExp) NoUniqueness) -&gt; VName)
-&gt; [Param (TypeBase (ShapeBase SubExp) NoUniqueness)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Param (TypeBase (ShapeBase SubExp) NoUniqueness) -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">[Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
</span><a href="#local-6989586621684454927"><span class="hs-identifier hs-var">map_params</span></a></span><span>
</span><span id="line-680"></span><span>        </span><span id="local-6989586621684454917"><span class="annot"><span class="annottext">arrs' :: [VName]
</span><a href="#local-6989586621684454917"><span class="hs-identifier hs-var hs-var">arrs'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [VName] -&gt; [VName]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Input] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684454934"><span class="hs-identifier hs-var">map_nes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; [VName]) -&gt; [VName] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Param (TypeBase (ShapeBase SubExp) NoUniqueness) -&gt; VName)
-&gt; [Param (TypeBase (ShapeBase SubExp) NoUniqueness)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Param (TypeBase (ShapeBase SubExp) NoUniqueness) -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">[Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
</span><a href="#local-6989586621684454927"><span class="hs-identifier hs-var">map_params</span></a></span><span>
</span><span id="line-681"></span><span>
</span><span id="line-682"></span><span>    </span><span id="local-6989586621684454916"><span class="annot"><span class="annottext">ScremaForm SOACS
</span><a href="#local-6989586621684454916"><span class="hs-identifier hs-var">scan_form</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Scan SOACS] -&gt; TryFusion (ScremaForm SOACS)
forall rep (m :: * -&gt; *).
(Buildable rep, MonadFreshNames m) =&gt;
[Scan rep] -&gt; m (ScremaForm rep)
</span><a href="Futhark.IR.SOACS.SOAC.html#scanSOAC"><span class="hs-identifier hs-var">scanSOAC</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Lambda SOACS -&gt; [SubExp] -&gt; Scan SOACS
forall rep. Lambda rep -&gt; [SubExp] -&gt; Scan rep
</span><a href="Futhark.IR.SOACS.SOAC.html#Scan"><span class="hs-identifier hs-var">Futhark.Scan</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684454919"><span class="hs-identifier hs-var">scan_fun'</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684454918"><span class="hs-identifier hs-var">nes'</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-683"></span><span>
</span><span id="line-684"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684454914"><span class="annot"><span class="annottext">map_body :: BodyT SOACS
</span><a href="#local-6989586621684454914"><span class="hs-identifier hs-var hs-var">map_body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-685"></span><span>          </span><span class="annot"><span class="annottext">Stms SOACS -&gt; Result -&gt; BodyT SOACS
forall rep. Buildable rep =&gt; Stms rep -&gt; Result -&gt; Body rep
</span><a href="Futhark.Builder.Class.html#mkBody"><span class="hs-identifier hs-var">mkBody</span></a></span><span>
</span><span id="line-686"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Stm SOACS -&gt; Stms SOACS
forall rep. Stm rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#oneStm"><span class="hs-identifier hs-var">oneStm</span></a></span><span> </span><span class="annot"><span class="annottext">(Stm SOACS -&gt; Stms SOACS) -&gt; Stm SOACS -&gt; Stms SOACS
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-687"></span><span>                </span><span class="annot"><span class="annottext">Pat -&gt; StmAux (ExpDec SOACS) -&gt; ExpT SOACS -&gt; Stm SOACS
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp -&gt; Pat -&gt; Pat
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#setPatOuterDimTo"><span class="hs-identifier hs-var">setPatOuterDimTo</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684454948"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">Pat
</span><a href="#local-6989586621684454941"><span class="hs-identifier hs-var">map_pat</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; StmAux ()
forall dec. dec -&gt; StmAux dec
</span><a href="Futhark.IR.Prop.html#defAux"><span class="hs-identifier hs-var">defAux</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ExpT SOACS -&gt; Stm SOACS) -&gt; ExpT SOACS -&gt; Stm SOACS
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-688"></span><span>                  </span><span class="annot"><span class="annottext">Op SOACS -&gt; ExpT SOACS
forall rep. Op rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-var">Op</span></a></span><span> </span><span class="annot"><span class="annottext">(Op SOACS -&gt; ExpT SOACS) -&gt; Op SOACS -&gt; ExpT SOACS
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; [VName] -&gt; ScremaForm SOACS -&gt; SOAC SOACS
forall rep. SubExp -&gt; [VName] -&gt; ScremaForm rep -&gt; SOAC rep
</span><a href="Futhark.IR.SOACS.SOAC.html#Screma"><span class="hs-identifier hs-var">Futhark.Screma</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684454948"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684454917"><span class="hs-identifier hs-var">arrs'</span></a></span><span> </span><span class="annot"><span class="annottext">ScremaForm SOACS
</span><a href="#local-6989586621684454916"><span class="hs-identifier hs-var">scan_form</span></a></span><span>
</span><span id="line-689"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-690"></span><span>            </span><span class="annot"><span class="annottext">(Result -&gt; BodyT SOACS) -&gt; Result -&gt; BodyT SOACS
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Result
</span><a href="Futhark.IR.Syntax.html#varsRes"><span class="hs-identifier hs-var">varsRes</span></a></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; Result) -&gt; [VName] -&gt; Result
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatT (TypeBase (ShapeBase SubExp) NoUniqueness) -&gt; [VName]
forall dec. PatT dec -&gt; [VName]
</span><a href="Futhark.IR.Prop.Patterns.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="annot"><span class="annottext">PatT (TypeBase (ShapeBase SubExp) NoUniqueness)
Pat
</span><a href="#local-6989586621684454941"><span class="hs-identifier hs-var">map_pat</span></a></span><span>
</span><span id="line-691"></span><span>        </span><span id="local-6989586621684454904"><span class="annot"><span class="annottext">map_fun' :: Lambda SOACS
</span><a href="#local-6989586621684454904"><span class="hs-identifier hs-var hs-var">map_fun'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[LParam SOACS]
-&gt; BodyT SOACS
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; Lambda SOACS
forall rep.
[LParam rep]
-&gt; BodyT rep
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; LambdaT rep
</span><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-var">Lambda</span></a></span><span> </span><span class="annot"><span class="annottext">[Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
[LParam SOACS]
</span><a href="#local-6989586621684454927"><span class="hs-identifier hs-var">map_params</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT SOACS
</span><a href="#local-6989586621684454914"><span class="hs-identifier hs-var">map_body</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="#local-6989586621684454924"><span class="hs-identifier hs-var">map_rettype</span></a></span><span>
</span><span id="line-692"></span><span>        </span><span id="local-6989586621684454903"><span class="annot"><span class="annottext">perm :: [Int]
</span><a href="#local-6989586621684454903"><span class="hs-identifier hs-var hs-var">perm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Lambda SOACS -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
forall rep.
LambdaT rep -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684454938"><span class="hs-identifier hs-var">map_fun</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-693"></span><span>          </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-694"></span><span>          </span><span id="local-6989586621684454902"><span class="annot"><span class="annottext">TypeBase (ShapeBase SubExp) NoUniqueness
</span><a href="#local-6989586621684454902"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><span class="annottext">[TypeBase (ShapeBase SubExp) NoUniqueness]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Int] -&gt; [Int]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Int] -&gt; [Int]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">TypeBase (ShapeBase SubExp) NoUniqueness -&gt; Int
forall shape u. ArrayShape shape =&gt; TypeBase shape u -&gt; Int
</span><a href="Futhark.IR.Prop.Types.html#arrayRank"><span class="hs-identifier hs-var">arrayRank</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase (ShapeBase SubExp) NoUniqueness
</span><a href="#local-6989586621684454902"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-695"></span><span>
</span><span id="line-696"></span><span>    </span><span class="annot"><span class="annottext">(SOAC SOACS, ArrayTransforms)
-&gt; TryFusion (SOAC SOACS, ArrayTransforms)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-697"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; ScremaForm SOACS -&gt; [Input] -&gt; SOAC SOACS
forall rep. SubExp -&gt; ScremaForm rep -&gt; [Input] -&gt; SOAC rep
</span><a href="Futhark.Analysis.HORep.SOAC.html#Screma"><span class="hs-identifier hs-var">SOAC.Screma</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684454939"><span class="hs-identifier hs-var">map_w</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Scan SOACS] -&gt; [Reduce SOACS] -&gt; Lambda SOACS -&gt; ScremaForm SOACS
forall rep.
[Scan rep] -&gt; [Reduce rep] -&gt; Lambda rep -&gt; ScremaForm rep
</span><a href="Futhark.IR.SOACS.SOAC.html#ScremaForm"><span class="hs-identifier hs-var">ScremaForm</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684454904"><span class="hs-identifier hs-var">map_fun'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684454932"><span class="hs-identifier hs-var">map_arrs'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-698"></span><span>        </span><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684454945"><span class="hs-identifier hs-var">ots</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayTransforms -&gt; ArrayTransform -&gt; ArrayTransforms
</span><a href="Futhark.Analysis.HORep.SOAC.html#%7C%3E"><span class="hs-operator hs-var">SOAC.|&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Certs -&gt; [Int] -&gt; ArrayTransform
</span><a href="Futhark.Analysis.HORep.SOAC.html#Rearrange"><span class="hs-identifier hs-var">SOAC.Rearrange</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684454940"><span class="hs-identifier hs-var">map_cs</span></a></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684454903"><span class="hs-identifier hs-var">perm</span></a></span><span>
</span><span id="line-699"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-700"></span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#iswim"><span class="hs-identifier hs-var">iswim</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe [VName]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ArrayTransforms
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-701"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; TryFusion (SOAC SOACS, ArrayTransforms)
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ISWIM does not apply.&quot;</span></span><span>
</span><span id="line-702"></span><span>
</span><span id="line-703"></span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#removeParamOuterDim"><span class="hs-identifier hs-type">removeParamOuterDim</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#LParam"><span class="hs-identifier hs-type">LParam</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#LParam"><span class="hs-identifier hs-type">LParam</span></a></span><span>
</span><span id="line-704"></span><span id="removeParamOuterDim"><span class="annot"><span class="annottext">removeParamOuterDim :: LParam SOACS -&gt; LParam SOACS
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#removeParamOuterDim"><span class="hs-identifier hs-var hs-var">removeParamOuterDim</span></a></span></span><span> </span><span id="local-6989586621684454899"><span class="annot"><span class="annottext">LParam SOACS
</span><a href="#local-6989586621684454899"><span class="hs-identifier hs-var">param</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-705"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684454898"><span class="annot"><span class="annottext">t :: TypeBase (ShapeBase SubExp) NoUniqueness
</span><a href="#local-6989586621684454898"><span class="hs-identifier hs-var hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeBase (ShapeBase SubExp) NoUniqueness
-&gt; TypeBase (ShapeBase SubExp) NoUniqueness
forall u.
TypeBase (ShapeBase SubExp) u -&gt; TypeBase (ShapeBase SubExp) u
</span><a href="Futhark.IR.Prop.Types.html#rowType"><span class="hs-identifier hs-var">rowType</span></a></span><span> </span><span class="annot"><span class="annottext">(TypeBase (ShapeBase SubExp) NoUniqueness
 -&gt; TypeBase (ShapeBase SubExp) NoUniqueness)
-&gt; TypeBase (ShapeBase SubExp) NoUniqueness
-&gt; TypeBase (ShapeBase SubExp) NoUniqueness
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param (TypeBase (ShapeBase SubExp) NoUniqueness)
-&gt; TypeBase (ShapeBase SubExp) NoUniqueness
forall dec.
Typed dec =&gt;
Param dec -&gt; TypeBase (ShapeBase SubExp) NoUniqueness
</span><a href="Futhark.IR.Prop.Patterns.html#paramType"><span class="hs-identifier hs-var">paramType</span></a></span><span> </span><span class="annot"><span class="annottext">Param (TypeBase (ShapeBase SubExp) NoUniqueness)
LParam SOACS
</span><a href="#local-6989586621684454899"><span class="hs-identifier hs-var">param</span></a></span><span>
</span><span id="line-706"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Param (TypeBase (ShapeBase SubExp) NoUniqueness)
LParam SOACS
</span><a href="#local-6989586621684454899"><span class="hs-identifier hs-var">param</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">paramDec :: TypeBase (ShapeBase SubExp) NoUniqueness
</span><a href="Futhark.IR.Syntax.Core.html#paramDec"><span class="hs-identifier hs-var">paramDec</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeBase (ShapeBase SubExp) NoUniqueness
</span><a href="#local-6989586621684454898"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-707"></span><span>
</span><span id="line-708"></span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#setParamOuterDimTo"><span class="hs-identifier hs-type">setParamOuterDimTo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#LParam"><span class="hs-identifier hs-type">LParam</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#LParam"><span class="hs-identifier hs-type">LParam</span></a></span><span>
</span><span id="line-709"></span><span id="setParamOuterDimTo"><span class="annot"><span class="annottext">setParamOuterDimTo :: SubExp -&gt; LParam SOACS -&gt; LParam SOACS
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#setParamOuterDimTo"><span class="hs-identifier hs-var hs-var">setParamOuterDimTo</span></a></span></span><span> </span><span id="local-6989586621684454895"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684454895"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684454894"><span class="annot"><span class="annottext">LParam SOACS
</span><a href="#local-6989586621684454894"><span class="hs-identifier hs-var">param</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-710"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684454893"><span class="annot"><span class="annottext">t :: TypeBase (ShapeBase SubExp) NoUniqueness
</span><a href="#local-6989586621684454893"><span class="hs-identifier hs-var hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Param (TypeBase (ShapeBase SubExp) NoUniqueness)
-&gt; TypeBase (ShapeBase SubExp) NoUniqueness
forall dec.
Typed dec =&gt;
Param dec -&gt; TypeBase (ShapeBase SubExp) NoUniqueness
</span><a href="Futhark.IR.Prop.Patterns.html#paramType"><span class="hs-identifier hs-var">paramType</span></a></span><span> </span><span class="annot"><span class="annottext">Param (TypeBase (ShapeBase SubExp) NoUniqueness)
LParam SOACS
</span><a href="#local-6989586621684454894"><span class="hs-identifier hs-var">param</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase (ShapeBase SubExp) NoUniqueness
-&gt; SubExp -&gt; TypeBase (ShapeBase SubExp) NoUniqueness
forall d u.
ArrayShape (ShapeBase d) =&gt;
TypeBase (ShapeBase d) u -&gt; d -&gt; TypeBase (ShapeBase d) u
</span><a href="Futhark.IR.Prop.Types.html#setOuterSize"><span class="hs-operator hs-var">`setOuterSize`</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684454895"><span class="hs-identifier hs-var">w</span></a></span><span>
</span><span id="line-711"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Param (TypeBase (ShapeBase SubExp) NoUniqueness)
LParam SOACS
</span><a href="#local-6989586621684454894"><span class="hs-identifier hs-var">param</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">paramDec :: TypeBase (ShapeBase SubExp) NoUniqueness
</span><a href="Futhark.IR.Syntax.Core.html#paramDec"><span class="hs-identifier hs-var">paramDec</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeBase (ShapeBase SubExp) NoUniqueness
</span><a href="#local-6989586621684454893"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-712"></span><span>
</span><span id="line-713"></span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#setPatOuterDimTo"><span class="hs-identifier hs-type">setPatOuterDimTo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span>
</span><span id="line-714"></span><span id="setPatOuterDimTo"><span class="annot"><span class="annottext">setPatOuterDimTo :: SubExp -&gt; Pat -&gt; Pat
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#setPatOuterDimTo"><span class="hs-identifier hs-var hs-var">setPatOuterDimTo</span></a></span></span><span> </span><span id="local-6989586621684454892"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684454892"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TypeBase (ShapeBase SubExp) NoUniqueness
 -&gt; TypeBase (ShapeBase SubExp) NoUniqueness)
-&gt; PatT (TypeBase (ShapeBase SubExp) NoUniqueness)
-&gt; PatT (TypeBase (ShapeBase SubExp) NoUniqueness)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeBase (ShapeBase SubExp) NoUniqueness
-&gt; SubExp -&gt; TypeBase (ShapeBase SubExp) NoUniqueness
forall d u.
ArrayShape (ShapeBase d) =&gt;
TypeBase (ShapeBase d) u -&gt; d -&gt; TypeBase (ShapeBase d) u
</span><a href="Futhark.IR.Prop.Types.html#setOuterSize"><span class="hs-operator hs-var">`setOuterSize`</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684454892"><span class="hs-identifier hs-var">w</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-715"></span><span>
</span><span id="line-716"></span><span class="hs-comment">-- Now for fiddling with transpositions...</span><span>
</span><span id="line-717"></span><span>
</span><span id="line-718"></span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#commonTransforms"><span class="hs-identifier hs-type">commonTransforms</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-719"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-720"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Input"><span class="hs-identifier hs-type">SOAC.Input</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-721"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#ArrayTransforms"><span class="hs-identifier hs-type">SOAC.ArrayTransforms</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Input"><span class="hs-identifier hs-type">SOAC.Input</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-722"></span><span id="commonTransforms"><span class="annot"><span class="annottext">commonTransforms :: [VName] -&gt; [Input] -&gt; (ArrayTransforms, [Input])
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#commonTransforms"><span class="hs-identifier hs-var hs-var">commonTransforms</span></a></span></span><span> </span><span id="local-6989586621684454890"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684454890"><span class="hs-identifier hs-var">interesting</span></a></span></span><span> </span><span id="local-6989586621684454889"><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684454889"><span class="hs-identifier hs-var">inps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Bool, Input)] -&gt; (ArrayTransforms, [Input])
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#commonTransforms%27"><span class="hs-identifier hs-var">commonTransforms'</span></a></span><span> </span><span class="annot"><span class="annottext">[(Bool, Input)]
</span><a href="#local-6989586621684454887"><span class="hs-identifier hs-var">inps'</span></a></span><span>
</span><span id="line-723"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-724"></span><span>    </span><span id="local-6989586621684454887"><span class="annot"><span class="annottext">inps' :: [(Bool, Input)]
</span><a href="#local-6989586621684454887"><span class="hs-identifier hs-var hs-var">inps'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-725"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Input -&gt; VName
</span><a href="Futhark.Analysis.HORep.SOAC.html#inputArray"><span class="hs-identifier hs-var">SOAC.inputArray</span></a></span><span> </span><span class="annot"><span class="annottext">Input
</span><a href="#local-6989586621684454886"><span class="hs-identifier hs-var">inp</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [VName] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684454890"><span class="hs-identifier hs-var">interesting</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Input
</span><a href="#local-6989586621684454886"><span class="hs-identifier hs-var">inp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-726"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621684454886"><span class="annot"><span class="annottext">Input
</span><a href="#local-6989586621684454886"><span class="hs-identifier hs-var">inp</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684454889"><span class="hs-identifier hs-var">inps</span></a></span><span>
</span><span id="line-727"></span><span>      </span><span class="hs-special">]</span><span>
</span><span id="line-728"></span><span>
</span><span id="line-729"></span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#commonTransforms%27"><span class="hs-identifier hs-type">commonTransforms'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Input"><span class="hs-identifier hs-type">SOAC.Input</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#ArrayTransforms"><span class="hs-identifier hs-type">SOAC.ArrayTransforms</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Input"><span class="hs-identifier hs-type">SOAC.Input</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-730"></span><span id="commonTransforms%27"><span class="annot"><span class="annottext">commonTransforms' :: [(Bool, Input)] -&gt; (ArrayTransforms, [Input])
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#commonTransforms%27"><span class="hs-identifier hs-var hs-var">commonTransforms'</span></a></span></span><span> </span><span id="local-6989586621684454885"><span class="annot"><span class="annottext">[(Bool, Input)]
</span><a href="#local-6989586621684454885"><span class="hs-identifier hs-var">inps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-731"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">((Maybe ArrayTransform, [(Bool, Input)])
 -&gt; (Bool, Input) -&gt; Maybe (Maybe ArrayTransform, [(Bool, Input)]))
-&gt; (Maybe ArrayTransform, [(Bool, Input)])
-&gt; [(Bool, Input)]
-&gt; Maybe (Maybe ArrayTransform, [(Bool, Input)])
forall (t :: * -&gt; *) (m :: * -&gt; *) b a.
(Foldable t, Monad m) =&gt;
(b -&gt; a -&gt; m b) -&gt; b -&gt; t a -&gt; m b
</span><span class="hs-identifier hs-var">foldM</span></span><span> </span><span class="annot"><span class="annottext">(Maybe ArrayTransform, [(Bool, Input)])
-&gt; (Bool, Input) -&gt; Maybe (Maybe ArrayTransform, [(Bool, Input)])
</span><a href="#local-6989586621684454884"><span class="hs-identifier hs-var">inspect</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe ArrayTransform
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Bool, Input)]
</span><a href="#local-6989586621684454885"><span class="hs-identifier hs-var">inps</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-732"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684454883"><span class="annot"><span class="annottext">ArrayTransform
</span><a href="#local-6989586621684454883"><span class="hs-identifier hs-var">mot</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684454882"><span class="annot"><span class="annottext">[(Bool, Input)]
</span><a href="#local-6989586621684454882"><span class="hs-identifier hs-var">inps'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(ArrayTransforms -&gt; ArrayTransforms)
-&gt; (ArrayTransforms, [Input]) -&gt; (ArrayTransforms, [Input])
forall (a :: * -&gt; * -&gt; *) b c d.
Arrow a =&gt;
a b c -&gt; a (b, d) (c, d)
</span><span class="hs-identifier hs-var">first</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ArrayTransform
</span><a href="#local-6989586621684454883"><span class="hs-identifier hs-var">mot</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayTransform -&gt; ArrayTransforms -&gt; ArrayTransforms
</span><a href="Futhark.Analysis.HORep.SOAC.html#%3C%7C"><span class="hs-operator hs-var">SOAC.&lt;|</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((ArrayTransforms, [Input]) -&gt; (ArrayTransforms, [Input]))
-&gt; (ArrayTransforms, [Input]) -&gt; (ArrayTransforms, [Input])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(Bool, Input)] -&gt; (ArrayTransforms, [Input])
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#commonTransforms%27"><span class="hs-identifier hs-var">commonTransforms'</span></a></span><span> </span><span class="annot"><span class="annottext">([(Bool, Input)] -&gt; (ArrayTransforms, [Input]))
-&gt; [(Bool, Input)] -&gt; (ArrayTransforms, [Input])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(Bool, Input)] -&gt; [(Bool, Input)]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[(Bool, Input)]
</span><a href="#local-6989586621684454882"><span class="hs-identifier hs-var">inps'</span></a></span><span>
</span><span id="line-733"></span><span>    </span><span class="annot"><span class="annottext">Maybe (Maybe ArrayTransform, [(Bool, Input)])
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="Futhark.Analysis.HORep.SOAC.html#noTransforms"><span class="hs-identifier hs-var">SOAC.noTransforms</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">((Bool, Input) -&gt; Input) -&gt; [(Bool, Input)] -&gt; [Input]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Bool, Input) -&gt; Input
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">[(Bool, Input)]
</span><a href="#local-6989586621684454885"><span class="hs-identifier hs-var">inps</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-734"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-735"></span><span>    </span><span id="local-6989586621684454884"><span class="annot"><span class="annottext">inspect :: (Maybe ArrayTransform, [(Bool, Input)])
-&gt; (Bool, Input) -&gt; Maybe (Maybe ArrayTransform, [(Bool, Input)])
</span><a href="#local-6989586621684454884"><span class="hs-identifier hs-var hs-var">inspect</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684454877"><span class="annot"><span class="annottext">Maybe ArrayTransform
</span><a href="#local-6989586621684454877"><span class="hs-identifier hs-var">mot</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684454876"><span class="annot"><span class="annottext">[(Bool, Input)]
</span><a href="#local-6989586621684454876"><span class="hs-identifier hs-var">prev</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684454875"><span class="annot"><span class="annottext">Input
</span><a href="#local-6989586621684454875"><span class="hs-identifier hs-var">inp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-736"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe ArrayTransform
</span><a href="#local-6989586621684454877"><span class="hs-identifier hs-var">mot</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Input -&gt; Maybe (ArrayTransform, Input)
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#inputToOutput"><span class="hs-identifier hs-var">inputToOutput</span></a></span><span> </span><span class="annot"><span class="annottext">Input
</span><a href="#local-6989586621684454875"><span class="hs-identifier hs-var">inp</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-737"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe ArrayTransform
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684454874"><span class="annot"><span class="annottext">ArrayTransform
</span><a href="#local-6989586621684454874"><span class="hs-identifier hs-var">ot</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684454873"><span class="annot"><span class="annottext">Input
</span><a href="#local-6989586621684454873"><span class="hs-identifier hs-var">inp'</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Maybe ArrayTransform, [(Bool, Input)])
-&gt; Maybe (Maybe ArrayTransform, [(Bool, Input)])
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ArrayTransform -&gt; Maybe ArrayTransform
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">ArrayTransform
</span><a href="#local-6989586621684454874"><span class="hs-identifier hs-var">ot</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Input
</span><a href="#local-6989586621684454873"><span class="hs-identifier hs-var">inp'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Bool, Input) -&gt; [(Bool, Input)] -&gt; [(Bool, Input)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[(Bool, Input)]
</span><a href="#local-6989586621684454876"><span class="hs-identifier hs-var">prev</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-738"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684454872"><span class="annot"><span class="annottext">ArrayTransform
</span><a href="#local-6989586621684454872"><span class="hs-identifier hs-var">ot1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684454871"><span class="annot"><span class="annottext">ArrayTransform
</span><a href="#local-6989586621684454871"><span class="hs-identifier hs-var">ot2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684454870"><span class="annot"><span class="annottext">Input
</span><a href="#local-6989586621684454870"><span class="hs-identifier hs-var">inp'</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-739"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">ArrayTransform
</span><a href="#local-6989586621684454872"><span class="hs-identifier hs-var">ot1</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayTransform -&gt; ArrayTransform -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ArrayTransform
</span><a href="#local-6989586621684454871"><span class="hs-identifier hs-var">ot2</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Maybe ArrayTransform, [(Bool, Input)])
-&gt; Maybe (Maybe ArrayTransform, [(Bool, Input)])
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ArrayTransform -&gt; Maybe ArrayTransform
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">ArrayTransform
</span><a href="#local-6989586621684454871"><span class="hs-identifier hs-var">ot2</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Input
</span><a href="#local-6989586621684454870"><span class="hs-identifier hs-var">inp'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Bool, Input) -&gt; [(Bool, Input)] -&gt; [(Bool, Input)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[(Bool, Input)]
</span><a href="#local-6989586621684454876"><span class="hs-identifier hs-var">prev</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-740"></span><span>        </span><span class="annot"><span class="annottext">(Maybe ArrayTransform, Maybe (ArrayTransform, Input))
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (Maybe ArrayTransform, [(Bool, Input)])
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-741"></span><span>    </span><span class="annot"><a href="#local-6989586621684454884"><span class="hs-identifier hs-var">inspect</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684454869"><span class="annot"><span class="annottext">Maybe ArrayTransform
</span><a href="#local-6989586621684454869"><span class="hs-identifier hs-var">mot</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684454868"><span class="annot"><span class="annottext">[(Bool, Input)]
</span><a href="#local-6989586621684454868"><span class="hs-identifier hs-var">prev</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684454867"><span class="annot"><span class="annottext">(Bool, Input)
</span><a href="#local-6989586621684454867"><span class="hs-identifier hs-var">inp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Maybe ArrayTransform, [(Bool, Input)])
-&gt; Maybe (Maybe ArrayTransform, [(Bool, Input)])
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe ArrayTransform
</span><a href="#local-6989586621684454869"><span class="hs-identifier hs-var">mot</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(Bool, Input)
</span><a href="#local-6989586621684454867"><span class="hs-identifier hs-var">inp</span></a></span><span> </span><span class="annot"><span class="annottext">(Bool, Input) -&gt; [(Bool, Input)] -&gt; [(Bool, Input)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[(Bool, Input)]
</span><a href="#local-6989586621684454868"><span class="hs-identifier hs-var">prev</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-742"></span><span>
</span><span id="line-743"></span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#mapDepth"><span class="hs-identifier hs-type">mapDepth</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#MapNest"><span class="hs-identifier hs-type">MapNest</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-744"></span><span id="mapDepth"><span class="annot"><span class="annottext">mapDepth :: MapNest -&gt; Int
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#mapDepth"><span class="hs-identifier hs-var hs-var">mapDepth</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.HORep.MapNest.html#MapNest"><span class="hs-identifier hs-type">MapNest.MapNest</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684454864"><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684454864"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span id="local-6989586621684454863"><span class="annot"><span class="annottext">[Nesting SOACS]
</span><a href="#local-6989586621684454863"><span class="hs-identifier hs-var">levels</span></a></span></span><span> </span><span class="annot"><span class="annottext">[Input]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-745"></span><span>  </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">min</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684454861"><span class="hs-identifier hs-var">resDims</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Nesting SOACS] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Nesting SOACS]
</span><a href="#local-6989586621684454863"><span class="hs-identifier hs-var">levels</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-746"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-747"></span><span>    </span><span id="local-6989586621684454861"><span class="annot"><span class="annottext">resDims :: Int
</span><a href="#local-6989586621684454861"><span class="hs-identifier hs-var hs-var">resDims</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TypeBase (ShapeBase SubExp) NoUniqueness] -&gt; Int
forall {shape} {u}. ArrayShape shape =&gt; [TypeBase shape u] -&gt; Int
</span><a href="#local-6989586621684454860"><span class="hs-identifier hs-var">minDim</span></a></span><span> </span><span class="annot"><span class="annottext">([TypeBase (ShapeBase SubExp) NoUniqueness] -&gt; Int)
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness] -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[Nesting SOACS]
</span><a href="#local-6989586621684454863"><span class="hs-identifier hs-var">levels</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-748"></span><span>      </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Lambda SOACS -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
forall rep.
LambdaT rep -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684454864"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-749"></span><span>      </span><span id="local-6989586621684454859"><span class="annot"><span class="annottext">Nesting SOACS
</span><a href="#local-6989586621684454859"><span class="hs-identifier hs-var">nest</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><span class="annottext">[Nesting SOACS]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Nesting SOACS -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
forall rep.
Nesting rep -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="Futhark.Analysis.HORep.MapNest.html#nestingReturnType"><span class="hs-identifier hs-var hs-var">MapNest.nestingReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">Nesting SOACS
</span><a href="#local-6989586621684454859"><span class="hs-identifier hs-var">nest</span></a></span><span>
</span><span id="line-750"></span><span>    </span><span id="local-6989586621684454860"><span class="annot"><span class="annottext">minDim :: [TypeBase shape u] -&gt; Int
</span><a href="#local-6989586621684454860"><span class="hs-identifier hs-var hs-var">minDim</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-751"></span><span>    </span><span class="annot"><a href="#local-6989586621684454860"><span class="hs-identifier hs-var">minDim</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684454851"><span class="annot"><span class="annottext">TypeBase shape u
</span><a href="#local-6989586621684454851"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684454850"><span class="annot"><span class="annottext">[TypeBase shape u]
</span><a href="#local-6989586621684454850"><span class="hs-identifier hs-var">ts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Int -&gt; Int) -&gt; Int -&gt; [Int] -&gt; Int
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">min</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeBase shape u -&gt; Int
forall shape u. ArrayShape shape =&gt; TypeBase shape u -&gt; Int
</span><a href="Futhark.IR.Prop.Types.html#arrayRank"><span class="hs-identifier hs-var">arrayRank</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase shape u
</span><a href="#local-6989586621684454851"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Int] -&gt; Int) -&gt; [Int] -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(TypeBase shape u -&gt; Int) -&gt; [TypeBase shape u] -&gt; [Int]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TypeBase shape u -&gt; Int
forall shape u. ArrayShape shape =&gt; TypeBase shape u -&gt; Int
</span><a href="Futhark.IR.Prop.Types.html#arrayRank"><span class="hs-identifier hs-var">arrayRank</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeBase shape u]
</span><a href="#local-6989586621684454850"><span class="hs-identifier hs-var">ts</span></a></span><span>
</span><span id="line-752"></span><span>
</span><span id="line-753"></span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#pullRearrange"><span class="hs-identifier hs-type">pullRearrange</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-754"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#SOAC"><span class="hs-identifier hs-type">SOAC</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-755"></span><span>  </span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#ArrayTransforms"><span class="hs-identifier hs-type">SOAC.ArrayTransforms</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-756"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#TryFusion"><span class="hs-identifier hs-type">TryFusion</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#SOAC"><span class="hs-identifier hs-type">SOAC</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#ArrayTransforms"><span class="hs-identifier hs-type">SOAC.ArrayTransforms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-757"></span><span id="pullRearrange"><span class="annot"><span class="annottext">pullRearrange :: SOAC SOACS
-&gt; ArrayTransforms -&gt; TryFusion (SOAC SOACS, ArrayTransforms)
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#pullRearrange"><span class="hs-identifier hs-var hs-var">pullRearrange</span></a></span></span><span> </span><span id="local-6989586621684454847"><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684454847"><span class="hs-identifier hs-var">soac</span></a></span></span><span> </span><span id="local-6989586621684454846"><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684454846"><span class="hs-identifier hs-var">ots</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-758"></span><span>  </span><span id="local-6989586621684454845"><span class="annot"><span class="annottext">MapNest
</span><a href="#local-6989586621684454845"><span class="hs-identifier hs-var">nest</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe MapNest -&gt; TryFusion MapNest
forall a. Maybe a -&gt; TryFusion a
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#liftMaybe"><span class="hs-identifier hs-var">liftMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe MapNest -&gt; TryFusion MapNest)
-&gt; TryFusion (Maybe MapNest) -&gt; TryFusion MapNest
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS -&gt; TryFusion (Maybe MapNest)
forall rep (m :: * -&gt; *).
(Buildable rep, MonadFreshNames m, LocalScope rep m,
 Op rep ~ SOAC rep) =&gt;
SOAC rep -&gt; m (Maybe (MapNest rep))
</span><a href="Futhark.Analysis.HORep.MapNest.html#fromSOAC"><span class="hs-identifier hs-var">MapNest.fromSOAC</span></a></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684454847"><span class="hs-identifier hs-var">soac</span></a></span><span>
</span><span id="line-759"></span><span>  </span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Rearrange"><span class="hs-identifier hs-type">SOAC.Rearrange</span></a></span><span> </span><span id="local-6989586621684454842"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684454842"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span id="local-6989586621684454841"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684454841"><span class="hs-identifier hs-var">perm</span></a></span></span><span> </span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#%3A%3C"><span class="hs-operator hs-type">SOAC.:&lt;</span></a></span><span> </span><span id="local-6989586621684454840"><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684454840"><span class="hs-identifier hs-var">ots'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ViewF -&gt; TryFusion ViewF
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(ViewF -&gt; TryFusion ViewF) -&gt; ViewF -&gt; TryFusion ViewF
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ArrayTransforms -&gt; ViewF
</span><a href="Futhark.Analysis.HORep.SOAC.html#viewf"><span class="hs-identifier hs-var">SOAC.viewf</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684454846"><span class="hs-identifier hs-var">ots</span></a></span><span>
</span><span id="line-760"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; Int
</span><a href="Futhark.IR.Prop.Rearrange.html#rearrangeReach"><span class="hs-identifier hs-var">rearrangeReach</span></a></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684454841"><span class="hs-identifier hs-var">perm</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">MapNest -&gt; Int
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#mapDepth"><span class="hs-identifier hs-var">mapDepth</span></a></span><span> </span><span class="annot"><span class="annottext">MapNest
</span><a href="#local-6989586621684454845"><span class="hs-identifier hs-var">nest</span></a></span><span>
</span><span id="line-761"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-762"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- Expand perm to cover the full extent of the input dimensionality</span><span>
</span><span id="line-763"></span><span>          </span><span id="local-6989586621684454837"><span class="annot"><span class="annottext">perm' :: Input -&gt; [Int]
</span><a href="#local-6989586621684454837"><span class="hs-identifier hs-var hs-var">perm'</span></a></span></span><span> </span><span id="local-6989586621684454836"><span class="annot"><span class="annottext">Input
</span><a href="#local-6989586621684454836"><span class="hs-identifier hs-var">inp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Int] -&gt; [Int]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">take</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684454835"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684454841"><span class="hs-identifier hs-var">perm</span></a></span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; [Int] -&gt; [Int]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">[Int] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684454841"><span class="hs-identifier hs-var">perm</span></a></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684454835"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span>
</span><span id="line-764"></span><span>            </span><span class="hs-keyword">where</span><span>
</span><span id="line-765"></span><span>              </span><span id="local-6989586621684454835"><span class="annot"><span class="annottext">r :: Int
</span><a href="#local-6989586621684454835"><span class="hs-identifier hs-var hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Input -&gt; Int
</span><a href="Futhark.Analysis.HORep.SOAC.html#inputRank"><span class="hs-identifier hs-var">SOAC.inputRank</span></a></span><span> </span><span class="annot"><span class="annottext">Input
</span><a href="#local-6989586621684454836"><span class="hs-identifier hs-var">inp</span></a></span><span>
</span><span id="line-766"></span><span>          </span><span id="local-6989586621684454833"><span class="annot"><span class="annottext">addPerm :: Input -&gt; Input
</span><a href="#local-6989586621684454833"><span class="hs-identifier hs-var hs-var">addPerm</span></a></span></span><span> </span><span id="local-6989586621684454832"><span class="annot"><span class="annottext">Input
</span><a href="#local-6989586621684454832"><span class="hs-identifier hs-var">inp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArrayTransform -&gt; Input -&gt; Input
</span><a href="Futhark.Analysis.HORep.SOAC.html#addTransform"><span class="hs-identifier hs-var">SOAC.addTransform</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Certs -&gt; [Int] -&gt; ArrayTransform
</span><a href="Futhark.Analysis.HORep.SOAC.html#Rearrange"><span class="hs-identifier hs-var">SOAC.Rearrange</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684454842"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">([Int] -&gt; ArrayTransform) -&gt; [Int] -&gt; ArrayTransform
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Input -&gt; [Int]
</span><a href="#local-6989586621684454837"><span class="hs-identifier hs-var">perm'</span></a></span><span> </span><span class="annot"><span class="annottext">Input
</span><a href="#local-6989586621684454832"><span class="hs-identifier hs-var">inp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Input
</span><a href="#local-6989586621684454832"><span class="hs-identifier hs-var">inp</span></a></span><span>
</span><span id="line-767"></span><span>          </span><span id="local-6989586621684454830"><span class="annot"><span class="annottext">inputs' :: [Input]
</span><a href="#local-6989586621684454830"><span class="hs-identifier hs-var hs-var">inputs'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Input -&gt; Input) -&gt; [Input] -&gt; [Input]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Input -&gt; Input
</span><a href="#local-6989586621684454833"><span class="hs-identifier hs-var">addPerm</span></a></span><span> </span><span class="annot"><span class="annottext">([Input] -&gt; [Input]) -&gt; [Input] -&gt; [Input]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MapNest -&gt; [Input]
forall rep. MapNest rep -&gt; [Input]
</span><a href="Futhark.Analysis.HORep.MapNest.html#inputs"><span class="hs-identifier hs-var">MapNest.inputs</span></a></span><span> </span><span class="annot"><span class="annottext">MapNest
</span><a href="#local-6989586621684454845"><span class="hs-identifier hs-var">nest</span></a></span><span>
</span><span id="line-768"></span><span>      </span><span id="local-6989586621684454828"><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684454828"><span class="hs-identifier hs-var">soac'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-769"></span><span>        </span><span class="annot"><span class="annottext">MapNest -&gt; TryFusion (SOAC SOACS)
forall (m :: * -&gt; *) rep.
(MonadFreshNames m, HasScope rep m, Buildable rep, BuilderOps rep,
 Op rep ~ SOAC rep) =&gt;
MapNest rep -&gt; m (SOAC rep)
</span><a href="Futhark.Analysis.HORep.MapNest.html#toSOAC"><span class="hs-identifier hs-var">MapNest.toSOAC</span></a></span><span> </span><span class="annot"><span class="annottext">(MapNest -&gt; TryFusion (SOAC SOACS))
-&gt; MapNest -&gt; TryFusion (SOAC SOACS)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-770"></span><span>          </span><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684454830"><span class="hs-identifier hs-var">inputs'</span></a></span><span> </span><span class="annot"><span class="annottext">[Input] -&gt; MapNest -&gt; MapNest
forall rep. [Input] -&gt; MapNest rep -&gt; MapNest rep
</span><a href="Futhark.Analysis.HORep.MapNest.html#setInputs"><span class="hs-operator hs-var">`MapNest.setInputs`</span></a></span><span> </span><span class="annot"><span class="annottext">MapNest -&gt; [Int] -&gt; MapNest
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#rearrangeReturnTypes"><span class="hs-identifier hs-var">rearrangeReturnTypes</span></a></span><span> </span><span class="annot"><span class="annottext">MapNest
</span><a href="#local-6989586621684454845"><span class="hs-identifier hs-var">nest</span></a></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684454841"><span class="hs-identifier hs-var">perm</span></a></span><span>
</span><span id="line-771"></span><span>      </span><span class="annot"><span class="annottext">(SOAC SOACS, ArrayTransforms)
-&gt; TryFusion (SOAC SOACS, ArrayTransforms)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684454828"><span class="hs-identifier hs-var">soac'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684454840"><span class="hs-identifier hs-var">ots'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-772"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">String -&gt; TryFusion (SOAC SOACS, ArrayTransforms)
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Cannot pull transpose&quot;</span></span><span>
</span><span id="line-773"></span><span>
</span><span id="line-774"></span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#pushRearrange"><span class="hs-identifier hs-type">pushRearrange</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-775"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-776"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#SOAC"><span class="hs-identifier hs-type">SOAC</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-777"></span><span>  </span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#ArrayTransforms"><span class="hs-identifier hs-type">SOAC.ArrayTransforms</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-778"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#TryFusion"><span class="hs-identifier hs-type">TryFusion</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#SOAC"><span class="hs-identifier hs-type">SOAC</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#ArrayTransforms"><span class="hs-identifier hs-type">SOAC.ArrayTransforms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-779"></span><span id="pushRearrange"><span class="annot"><span class="annottext">pushRearrange :: [VName]
-&gt; SOAC SOACS
-&gt; ArrayTransforms
-&gt; TryFusion (SOAC SOACS, ArrayTransforms)
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#pushRearrange"><span class="hs-identifier hs-var hs-var">pushRearrange</span></a></span></span><span> </span><span id="local-6989586621684454823"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684454823"><span class="hs-identifier hs-var">inpIds</span></a></span></span><span> </span><span id="local-6989586621684454822"><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684454822"><span class="hs-identifier hs-var">soac</span></a></span></span><span> </span><span id="local-6989586621684454821"><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684454821"><span class="hs-identifier hs-var">ots</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-780"></span><span>  </span><span id="local-6989586621684454820"><span class="annot"><span class="annottext">MapNest
</span><a href="#local-6989586621684454820"><span class="hs-identifier hs-var">nest</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe MapNest -&gt; TryFusion MapNest
forall a. Maybe a -&gt; TryFusion a
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#liftMaybe"><span class="hs-identifier hs-var">liftMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe MapNest -&gt; TryFusion MapNest)
-&gt; TryFusion (Maybe MapNest) -&gt; TryFusion MapNest
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS -&gt; TryFusion (Maybe MapNest)
forall rep (m :: * -&gt; *).
(Buildable rep, MonadFreshNames m, LocalScope rep m,
 Op rep ~ SOAC rep) =&gt;
SOAC rep -&gt; m (Maybe (MapNest rep))
</span><a href="Futhark.Analysis.HORep.MapNest.html#fromSOAC"><span class="hs-identifier hs-var">MapNest.fromSOAC</span></a></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684454822"><span class="hs-identifier hs-var">soac</span></a></span><span>
</span><span id="line-781"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684454819"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684454819"><span class="hs-identifier hs-var">perm</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684454818"><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684454818"><span class="hs-identifier hs-var">inputs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe ([Int], [Input]) -&gt; TryFusion ([Int], [Input])
forall a. Maybe a -&gt; TryFusion a
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#liftMaybe"><span class="hs-identifier hs-var">liftMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe ([Int], [Input]) -&gt; TryFusion ([Int], [Input]))
-&gt; Maybe ([Int], [Input]) -&gt; TryFusion ([Int], [Input])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [Input] -&gt; Maybe ([Int], [Input])
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#fixupInputs"><span class="hs-identifier hs-var">fixupInputs</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684454823"><span class="hs-identifier hs-var">inpIds</span></a></span><span> </span><span class="annot"><span class="annottext">([Input] -&gt; Maybe ([Int], [Input]))
-&gt; [Input] -&gt; Maybe ([Int], [Input])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MapNest -&gt; [Input]
forall rep. MapNest rep -&gt; [Input]
</span><a href="Futhark.Analysis.HORep.MapNest.html#inputs"><span class="hs-identifier hs-var">MapNest.inputs</span></a></span><span> </span><span class="annot"><span class="annottext">MapNest
</span><a href="#local-6989586621684454820"><span class="hs-identifier hs-var">nest</span></a></span><span>
</span><span id="line-782"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; Int
</span><a href="Futhark.IR.Prop.Rearrange.html#rearrangeReach"><span class="hs-identifier hs-var">rearrangeReach</span></a></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684454819"><span class="hs-identifier hs-var">perm</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">MapNest -&gt; Int
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#mapDepth"><span class="hs-identifier hs-var">mapDepth</span></a></span><span> </span><span class="annot"><span class="annottext">MapNest
</span><a href="#local-6989586621684454820"><span class="hs-identifier hs-var">nest</span></a></span><span>
</span><span id="line-783"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-784"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684454816"><span class="annot"><span class="annottext">invertRearrange :: ArrayTransform
</span><a href="#local-6989586621684454816"><span class="hs-identifier hs-var hs-var">invertRearrange</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Certs -&gt; [Int] -&gt; ArrayTransform
</span><a href="Futhark.Analysis.HORep.SOAC.html#Rearrange"><span class="hs-identifier hs-var">SOAC.Rearrange</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">([Int] -&gt; ArrayTransform) -&gt; [Int] -&gt; ArrayTransform
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; [Int]
</span><a href="Futhark.IR.Prop.Rearrange.html#rearrangeInverse"><span class="hs-identifier hs-var">rearrangeInverse</span></a></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684454819"><span class="hs-identifier hs-var">perm</span></a></span><span>
</span><span id="line-785"></span><span>      </span><span id="local-6989586621684454814"><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684454814"><span class="hs-identifier hs-var">soac'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-786"></span><span>        </span><span class="annot"><span class="annottext">MapNest -&gt; TryFusion (SOAC SOACS)
forall (m :: * -&gt; *) rep.
(MonadFreshNames m, HasScope rep m, Buildable rep, BuilderOps rep,
 Op rep ~ SOAC rep) =&gt;
MapNest rep -&gt; m (SOAC rep)
</span><a href="Futhark.Analysis.HORep.MapNest.html#toSOAC"><span class="hs-identifier hs-var">MapNest.toSOAC</span></a></span><span> </span><span class="annot"><span class="annottext">(MapNest -&gt; TryFusion (SOAC SOACS))
-&gt; MapNest -&gt; TryFusion (SOAC SOACS)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-787"></span><span>          </span><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684454818"><span class="hs-identifier hs-var">inputs'</span></a></span><span>
</span><span id="line-788"></span><span>            </span><span class="annot"><span class="annottext">[Input] -&gt; MapNest -&gt; MapNest
forall rep. [Input] -&gt; MapNest rep -&gt; MapNest rep
</span><a href="Futhark.Analysis.HORep.MapNest.html#setInputs"><span class="hs-operator hs-var">`MapNest.setInputs`</span></a></span><span> </span><span class="annot"><span class="annottext">MapNest -&gt; [Int] -&gt; MapNest
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#rearrangeReturnTypes"><span class="hs-identifier hs-var">rearrangeReturnTypes</span></a></span><span> </span><span class="annot"><span class="annottext">MapNest
</span><a href="#local-6989586621684454820"><span class="hs-identifier hs-var">nest</span></a></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684454819"><span class="hs-identifier hs-var">perm</span></a></span><span>
</span><span id="line-789"></span><span>      </span><span class="annot"><span class="annottext">(SOAC SOACS, ArrayTransforms)
-&gt; TryFusion (SOAC SOACS, ArrayTransforms)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684454814"><span class="hs-identifier hs-var">soac'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ArrayTransform
</span><a href="#local-6989586621684454816"><span class="hs-identifier hs-var">invertRearrange</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayTransform -&gt; ArrayTransforms -&gt; ArrayTransforms
</span><a href="Futhark.Analysis.HORep.SOAC.html#%3C%7C"><span class="hs-operator hs-var">SOAC.&lt;|</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684454821"><span class="hs-identifier hs-var">ots</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-790"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">String -&gt; TryFusion (SOAC SOACS, ArrayTransforms)
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Cannot push transpose&quot;</span></span><span>
</span><span id="line-791"></span><span>
</span><span id="line-792"></span><span class="hs-comment">-- | Actually also rearranges indices.</span><span>
</span><span id="line-793"></span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#rearrangeReturnTypes"><span class="hs-identifier hs-type">rearrangeReturnTypes</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#MapNest"><span class="hs-identifier hs-type">MapNest</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#MapNest"><span class="hs-identifier hs-type">MapNest</span></a></span><span>
</span><span id="line-794"></span><span id="rearrangeReturnTypes"><span class="annot"><span class="annottext">rearrangeReturnTypes :: MapNest -&gt; [Int] -&gt; MapNest
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#rearrangeReturnTypes"><span class="hs-identifier hs-var hs-var">rearrangeReturnTypes</span></a></span></span><span> </span><span id="local-6989586621684454813"><span class="annot"><span class="annottext">nest :: MapNest
</span><a href="#local-6989586621684454813"><span class="hs-identifier hs-var">nest</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.HORep.MapNest.html#MapNest"><span class="hs-identifier hs-type">MapNest.MapNest</span></a></span><span> </span><span id="local-6989586621684454812"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684454812"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684454811"><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684454811"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span id="local-6989586621684454810"><span class="annot"><span class="annottext">[Nesting SOACS]
</span><a href="#local-6989586621684454810"><span class="hs-identifier hs-var">nestings</span></a></span></span><span> </span><span id="local-6989586621684454809"><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684454809"><span class="hs-identifier hs-var">inps</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684454808"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684454808"><span class="hs-identifier hs-var">perm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-795"></span><span>  </span><span class="annot"><span class="annottext">SubExp -&gt; Lambda SOACS -&gt; [Nesting SOACS] -&gt; [Input] -&gt; MapNest
forall rep.
SubExp -&gt; Lambda rep -&gt; [Nesting rep] -&gt; [Input] -&gt; MapNest rep
</span><a href="Futhark.Analysis.HORep.MapNest.html#MapNest"><span class="hs-identifier hs-var">MapNest.MapNest</span></a></span><span>
</span><span id="line-796"></span><span>    </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684454812"><span class="hs-identifier hs-var">w</span></a></span><span>
</span><span id="line-797"></span><span>    </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684454811"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-798"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">(Nesting SOACS
 -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness] -&gt; Nesting SOACS)
-&gt; [Nesting SOACS]
-&gt; [[TypeBase (ShapeBase SubExp) NoUniqueness]]
-&gt; [Nesting SOACS]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span>
</span><span id="line-799"></span><span>        </span><span class="annot"><span class="annottext">Nesting SOACS
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness] -&gt; Nesting SOACS
forall {rep} {rep}.
Nesting rep
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness] -&gt; Nesting rep
</span><a href="#local-6989586621684454807"><span class="hs-identifier hs-var">setReturnType</span></a></span><span>
</span><span id="line-800"></span><span>        </span><span class="annot"><span class="annottext">[Nesting SOACS]
</span><a href="#local-6989586621684454810"><span class="hs-identifier hs-var">nestings</span></a></span><span>
</span><span id="line-801"></span><span>        </span><span class="annot"><span class="annottext">([[TypeBase (ShapeBase SubExp) NoUniqueness]] -&gt; [Nesting SOACS])
-&gt; [[TypeBase (ShapeBase SubExp) NoUniqueness]] -&gt; [Nesting SOACS]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int
-&gt; [[TypeBase (ShapeBase SubExp) NoUniqueness]]
-&gt; [[TypeBase (ShapeBase SubExp) NoUniqueness]]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">([[TypeBase (ShapeBase SubExp) NoUniqueness]]
 -&gt; [[TypeBase (ShapeBase SubExp) NoUniqueness]])
-&gt; [[TypeBase (ShapeBase SubExp) NoUniqueness]]
-&gt; [[TypeBase (ShapeBase SubExp) NoUniqueness]]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">([TypeBase (ShapeBase SubExp) NoUniqueness]
 -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness])
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; [[TypeBase (ShapeBase SubExp) NoUniqueness]]
forall a. (a -&gt; a) -&gt; a -&gt; [a]
</span><span class="hs-identifier hs-var">iterate</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TypeBase (ShapeBase SubExp) NoUniqueness
 -&gt; TypeBase (ShapeBase SubExp) NoUniqueness)
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TypeBase (ShapeBase SubExp) NoUniqueness
-&gt; TypeBase (ShapeBase SubExp) NoUniqueness
forall u.
TypeBase (ShapeBase SubExp) u -&gt; TypeBase (ShapeBase SubExp) u
</span><a href="Futhark.IR.Prop.Types.html#rowType"><span class="hs-identifier hs-var">rowType</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="#local-6989586621684454805"><span class="hs-identifier hs-var">ts</span></a></span><span>
</span><span id="line-802"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-803"></span><span>    </span><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684454809"><span class="hs-identifier hs-var">inps</span></a></span><span>
</span><span id="line-804"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-805"></span><span>    </span><span id="local-6989586621684454804"><span class="annot"><span class="annottext">origts :: [TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="#local-6989586621684454804"><span class="hs-identifier hs-var hs-var">origts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MapNest -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
forall rep.
MapNest rep -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="Futhark.Analysis.HORep.MapNest.html#typeOf"><span class="hs-identifier hs-var">MapNest.typeOf</span></a></span><span> </span><span class="annot"><span class="annottext">MapNest
</span><a href="#local-6989586621684454813"><span class="hs-identifier hs-var">nest</span></a></span><span>
</span><span id="line-806"></span><span>    </span><span class="hs-comment">-- The permutation may be deeper than the rank of the type,</span><span>
</span><span id="line-807"></span><span>    </span><span class="hs-comment">-- but it is required that it is an identity permutation</span><span>
</span><span id="line-808"></span><span>    </span><span class="hs-comment">-- beyond that.  This is supposed to be checked as an</span><span>
</span><span id="line-809"></span><span>    </span><span class="hs-comment">-- invariant by whoever calls rearrangeReturnTypes.</span><span>
</span><span id="line-810"></span><span>    </span><span id="local-6989586621684454802"><span class="annot"><span class="annottext">rearrangeType' :: TypeBase (ShapeBase SubExp) NoUniqueness
-&gt; TypeBase (ShapeBase SubExp) NoUniqueness
</span><a href="#local-6989586621684454802"><span class="hs-identifier hs-var hs-var">rearrangeType'</span></a></span></span><span> </span><span id="local-6989586621684454801"><span class="annot"><span class="annottext">TypeBase (ShapeBase SubExp) NoUniqueness
</span><a href="#local-6989586621684454801"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Int]
-&gt; TypeBase (ShapeBase SubExp) NoUniqueness
-&gt; TypeBase (ShapeBase SubExp) NoUniqueness
</span><a href="Futhark.IR.Prop.Types.html#rearrangeType"><span class="hs-identifier hs-var">rearrangeType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; [Int] -&gt; [Int]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">take</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeBase (ShapeBase SubExp) NoUniqueness -&gt; Int
forall shape u. ArrayShape shape =&gt; TypeBase shape u -&gt; Int
</span><a href="Futhark.IR.Prop.Types.html#arrayRank"><span class="hs-identifier hs-var">arrayRank</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase (ShapeBase SubExp) NoUniqueness
</span><a href="#local-6989586621684454801"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684454808"><span class="hs-identifier hs-var">perm</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TypeBase (ShapeBase SubExp) NoUniqueness
</span><a href="#local-6989586621684454801"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-811"></span><span>    </span><span id="local-6989586621684454805"><span class="annot"><span class="annottext">ts :: [TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="#local-6989586621684454805"><span class="hs-identifier hs-var hs-var">ts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TypeBase (ShapeBase SubExp) NoUniqueness
 -&gt; TypeBase (ShapeBase SubExp) NoUniqueness)
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TypeBase (ShapeBase SubExp) NoUniqueness
-&gt; TypeBase (ShapeBase SubExp) NoUniqueness
</span><a href="#local-6989586621684454802"><span class="hs-identifier hs-var">rearrangeType'</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="#local-6989586621684454804"><span class="hs-identifier hs-var">origts</span></a></span><span>
</span><span id="line-812"></span><span>
</span><span id="line-813"></span><span>    </span><span id="local-6989586621684454807"><span class="annot"><span class="annottext">setReturnType :: Nesting rep
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness] -&gt; Nesting rep
</span><a href="#local-6989586621684454807"><span class="hs-identifier hs-var hs-var">setReturnType</span></a></span></span><span> </span><span id="local-6989586621684454799"><span class="annot"><span class="annottext">Nesting rep
</span><a href="#local-6989586621684454799"><span class="hs-identifier hs-var">nesting</span></a></span></span><span> </span><span id="local-6989586621684454798"><span class="annot"><span class="annottext">[TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="#local-6989586621684454798"><span class="hs-identifier hs-var">t'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-814"></span><span>      </span><span class="annot"><span class="annottext">Nesting rep
</span><a href="#local-6989586621684454799"><span class="hs-identifier hs-var">nesting</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">nestingReturnType :: [TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="Futhark.Analysis.HORep.MapNest.html#nestingReturnType"><span class="hs-identifier hs-var">MapNest.nestingReturnType</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="#local-6989586621684454798"><span class="hs-identifier hs-var">t'</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-815"></span><span>
</span><span id="line-816"></span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#fixupInputs"><span class="hs-identifier hs-type">fixupInputs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Input"><span class="hs-identifier hs-type">SOAC.Input</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Input"><span class="hs-identifier hs-type">SOAC.Input</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-817"></span><span id="fixupInputs"><span class="annot"><span class="annottext">fixupInputs :: [VName] -&gt; [Input] -&gt; Maybe ([Int], [Input])
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#fixupInputs"><span class="hs-identifier hs-var hs-var">fixupInputs</span></a></span></span><span> </span><span id="local-6989586621684454797"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684454797"><span class="hs-identifier hs-var">inpIds</span></a></span></span><span> </span><span id="local-6989586621684454796"><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684454796"><span class="hs-identifier hs-var">inps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-818"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(Input -&gt; Maybe [Int]) -&gt; [Input] -&gt; [[Int]]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">mapMaybe</span></span><span> </span><span class="annot"><span class="annottext">Input -&gt; Maybe [Int]
</span><a href="#local-6989586621684454795"><span class="hs-identifier hs-var">inputRearrange</span></a></span><span> </span><span class="annot"><span class="annottext">([Input] -&gt; [[Int]]) -&gt; [Input] -&gt; [[Int]]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Input -&gt; Bool) -&gt; [Input] -&gt; [Input]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="annot"><span class="annottext">Input -&gt; Bool
</span><a href="#local-6989586621684454794"><span class="hs-identifier hs-var">exposable</span></a></span><span> </span><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684454796"><span class="hs-identifier hs-var">inps</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-819"></span><span>    </span><span id="local-6989586621684454793"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684454793"><span class="hs-identifier hs-var">perm</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><span class="annottext">[[Int]]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-820"></span><span>      </span><span id="local-6989586621684454792"><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684454792"><span class="hs-identifier hs-var">inps'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Input -&gt; Maybe Input) -&gt; [Input] -&gt; Maybe [Input]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; [Int] -&gt; Input -&gt; Maybe Input
</span><a href="#local-6989586621684454791"><span class="hs-identifier hs-var">fixupInput</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Int] -&gt; Int
</span><a href="Futhark.IR.Prop.Rearrange.html#rearrangeReach"><span class="hs-identifier hs-var">rearrangeReach</span></a></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684454793"><span class="hs-identifier hs-var">perm</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684454793"><span class="hs-identifier hs-var">perm</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684454796"><span class="hs-identifier hs-var">inps</span></a></span><span>
</span><span id="line-821"></span><span>      </span><span class="annot"><span class="annottext">([Int], [Input]) -&gt; Maybe ([Int], [Input])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684454793"><span class="hs-identifier hs-var">perm</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684454792"><span class="hs-identifier hs-var">inps'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-822"></span><span>    </span><span class="annot"><span class="annottext">[[Int]]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe ([Int], [Input])
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-823"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-824"></span><span>    </span><span id="local-6989586621684454794"><span class="annot"><span class="annottext">exposable :: Input -&gt; Bool
</span><a href="#local-6989586621684454794"><span class="hs-identifier hs-var hs-var">exposable</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; [VName] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684454797"><span class="hs-identifier hs-var">inpIds</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Bool) -&gt; (Input -&gt; VName) -&gt; Input -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Input -&gt; VName
</span><a href="Futhark.Analysis.HORep.SOAC.html#inputArray"><span class="hs-identifier hs-var">SOAC.inputArray</span></a></span><span>
</span><span id="line-825"></span><span>
</span><span id="line-826"></span><span>    </span><span id="local-6989586621684454795"><span class="annot"><span class="annottext">inputRearrange :: Input -&gt; Maybe [Int]
</span><a href="#local-6989586621684454795"><span class="hs-identifier hs-var hs-var">inputRearrange</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Input"><span class="hs-identifier hs-type">SOAC.Input</span></a></span><span> </span><span id="local-6989586621684454790"><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684454790"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">TypeBase (ShapeBase SubExp) NoUniqueness
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-827"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">ArrayTransforms
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#%3A%3E"><span class="hs-operator hs-type">SOAC.:&gt;</span></a></span><span> </span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Rearrange"><span class="hs-identifier hs-type">SOAC.Rearrange</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684454788"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684454788"><span class="hs-identifier hs-var">perm</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ArrayTransforms -&gt; ViewL
</span><a href="Futhark.Analysis.HORep.SOAC.html#viewl"><span class="hs-identifier hs-var">SOAC.viewl</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684454790"><span class="hs-identifier hs-var">ts</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; Maybe [Int]
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684454788"><span class="hs-identifier hs-var">perm</span></a></span><span>
</span><span id="line-828"></span><span>    </span><span class="annot"><a href="#local-6989586621684454795"><span class="hs-identifier hs-var">inputRearrange</span></a></span><span> </span><span class="annot"><span class="annottext">Input
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe [Int]
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-829"></span><span>
</span><span id="line-830"></span><span>    </span><span id="local-6989586621684454791"><span class="annot"><span class="annottext">fixupInput :: Int -&gt; [Int] -&gt; Input -&gt; Maybe Input
</span><a href="#local-6989586621684454791"><span class="hs-identifier hs-var hs-var">fixupInput</span></a></span></span><span> </span><span id="local-6989586621684454784"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684454784"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span id="local-6989586621684454783"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684454783"><span class="hs-identifier hs-var">perm</span></a></span></span><span> </span><span id="local-6989586621684454782"><span class="annot"><span class="annottext">Input
</span><a href="#local-6989586621684454782"><span class="hs-identifier hs-var">inp</span></a></span></span><span>
</span><span id="line-831"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621684454781"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684454781"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Input -&gt; Int
</span><a href="Futhark.Analysis.HORep.SOAC.html#inputRank"><span class="hs-identifier hs-var">SOAC.inputRank</span></a></span><span> </span><span class="annot"><span class="annottext">Input
</span><a href="#local-6989586621684454782"><span class="hs-identifier hs-var">inp</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-832"></span><span>        </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684454781"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684454784"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-833"></span><span>        </span><span class="annot"><span class="annottext">Input -&gt; Maybe Input
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Input -&gt; Maybe Input) -&gt; Input -&gt; Maybe Input
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ArrayTransform -&gt; Input -&gt; Input
</span><a href="Futhark.Analysis.HORep.SOAC.html#addTransform"><span class="hs-identifier hs-var">SOAC.addTransform</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Certs -&gt; [Int] -&gt; ArrayTransform
</span><a href="Futhark.Analysis.HORep.SOAC.html#Rearrange"><span class="hs-identifier hs-var">SOAC.Rearrange</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">([Int] -&gt; ArrayTransform) -&gt; [Int] -&gt; ArrayTransform
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Int] -&gt; [Int]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">take</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684454781"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684454783"><span class="hs-identifier hs-var">perm</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Input
</span><a href="#local-6989586621684454782"><span class="hs-identifier hs-var">inp</span></a></span><span>
</span><span id="line-834"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Input
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-835"></span><span>
</span><span id="line-836"></span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#pullReshape"><span class="hs-identifier hs-type">pullReshape</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#SOAC"><span class="hs-identifier hs-type">SOAC</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#ArrayTransforms"><span class="hs-identifier hs-type">SOAC.ArrayTransforms</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#TryFusion"><span class="hs-identifier hs-type">TryFusion</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#SOAC"><span class="hs-identifier hs-type">SOAC</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#ArrayTransforms"><span class="hs-identifier hs-type">SOAC.ArrayTransforms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-837"></span><span id="pullReshape"><span class="annot"><span class="annottext">pullReshape :: SOAC SOACS
-&gt; ArrayTransforms -&gt; TryFusion (SOAC SOACS, ArrayTransforms)
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#pullReshape"><span class="hs-identifier hs-var hs-var">pullReshape</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Screma"><span class="hs-identifier hs-type">SOAC.Screma</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684454779"><span class="annot"><span class="annottext">ScremaForm SOACS
</span><a href="#local-6989586621684454779"><span class="hs-identifier hs-var">form</span></a></span></span><span> </span><span id="local-6989586621684454778"><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684454778"><span class="hs-identifier hs-var">inps</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684454777"><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684454777"><span class="hs-identifier hs-var">ots</span></a></span></span><span>
</span><span id="line-838"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684454776"><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684454776"><span class="hs-identifier hs-var">maplam</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ScremaForm SOACS -&gt; Maybe (Lambda SOACS)
forall rep. ScremaForm rep -&gt; Maybe (Lambda rep)
</span><a href="Futhark.IR.SOACS.SOAC.html#isMapSOAC"><span class="hs-identifier hs-var">Futhark.isMapSOAC</span></a></span><span> </span><span class="annot"><span class="annottext">ScremaForm SOACS
</span><a href="#local-6989586621684454779"><span class="hs-identifier hs-var">form</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-839"></span><span>    </span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Reshape"><span class="hs-identifier hs-type">SOAC.Reshape</span></a></span><span> </span><span id="local-6989586621684454775"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684454775"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span id="local-6989586621684454774"><span class="annot"><span class="annottext">ShapeChange SubExp
</span><a href="#local-6989586621684454774"><span class="hs-identifier hs-var">shape</span></a></span></span><span> </span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#%3A%3C"><span class="hs-operator hs-type">SOAC.:&lt;</span></a></span><span> </span><span id="local-6989586621684454773"><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684454773"><span class="hs-identifier hs-var">ots'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ArrayTransforms -&gt; ViewF
</span><a href="Futhark.Analysis.HORep.SOAC.html#viewf"><span class="hs-identifier hs-var">SOAC.viewf</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684454777"><span class="hs-identifier hs-var">ots</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-840"></span><span>    </span><span class="annot"><span class="annottext">(TypeBase (ShapeBase SubExp) NoUniqueness -&gt; Bool)
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="annot"><span class="annottext">TypeBase (ShapeBase SubExp) NoUniqueness -&gt; Bool
forall shape u. TypeBase shape u -&gt; Bool
</span><a href="Futhark.IR.Prop.Types.html#primType"><span class="hs-identifier hs-var">primType</span></a></span><span> </span><span class="annot"><span class="annottext">([TypeBase (ShapeBase SubExp) NoUniqueness] -&gt; Bool)
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness] -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
forall rep.
LambdaT rep -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684454776"><span class="hs-identifier hs-var">maplam</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-841"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684454771"><span class="annot"><span class="annottext">mapw' :: SubExp
</span><a href="#local-6989586621684454771"><span class="hs-identifier hs-var hs-var">mapw'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; [SubExp]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [SubExp]) -&gt; [SubExp] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ShapeChange SubExp -&gt; [SubExp]
forall d. ShapeChange d -&gt; [d]
</span><a href="Futhark.IR.Prop.Reshape.html#newDims"><span class="hs-identifier hs-var">newDims</span></a></span><span> </span><span class="annot"><span class="annottext">ShapeChange SubExp
</span><a href="#local-6989586621684454774"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-842"></span><span>          </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IntType -&gt; Integer -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#intConst"><span class="hs-identifier hs-var">intConst</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span>
</span><span id="line-843"></span><span>          </span><span id="local-6989586621684454767"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684454767"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684454767"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-844"></span><span>        </span><span id="local-6989586621684454766"><span class="annot"><span class="annottext">inputs' :: [Input]
</span><a href="#local-6989586621684454766"><span class="hs-identifier hs-var hs-var">inputs'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Input -&gt; Input) -&gt; [Input] -&gt; [Input]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ArrayTransform -&gt; Input -&gt; Input
</span><a href="Futhark.Analysis.HORep.SOAC.html#addTransform"><span class="hs-identifier hs-var">SOAC.addTransform</span></a></span><span> </span><span class="annot"><span class="annottext">(ArrayTransform -&gt; Input -&gt; Input)
-&gt; ArrayTransform -&gt; Input -&gt; Input
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Certs -&gt; ShapeChange SubExp -&gt; ArrayTransform
</span><a href="Futhark.Analysis.HORep.SOAC.html#ReshapeOuter"><span class="hs-identifier hs-var">SOAC.ReshapeOuter</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684454775"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">ShapeChange SubExp
</span><a href="#local-6989586621684454774"><span class="hs-identifier hs-var">shape</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684454778"><span class="hs-identifier hs-var">inps</span></a></span><span>
</span><span id="line-845"></span><span>        </span><span id="local-6989586621684454765"><span class="annot"><span class="annottext">inputTypes :: [TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="#local-6989586621684454765"><span class="hs-identifier hs-var hs-var">inputTypes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Input -&gt; TypeBase (ShapeBase SubExp) NoUniqueness)
-&gt; [Input] -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Input -&gt; TypeBase (ShapeBase SubExp) NoUniqueness
</span><a href="Futhark.Analysis.HORep.SOAC.html#inputType"><span class="hs-identifier hs-var">SOAC.inputType</span></a></span><span> </span><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684454766"><span class="hs-identifier hs-var">inputs'</span></a></span><span>
</span><span id="line-846"></span><span>
</span><span id="line-847"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621684454763"><span class="hs-identifier hs-type">outersoac</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-848"></span><span>          </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Input"><span class="hs-identifier hs-type">SOAC.Input</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#SOAC"><span class="hs-identifier hs-type">SOAC</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-849"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-850"></span><span>          </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#TryFusion"><span class="hs-identifier hs-type">TryFusion</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Input"><span class="hs-identifier hs-type">SOAC.Input</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#SOAC"><span class="hs-identifier hs-type">SOAC</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-851"></span><span>        </span><span id="local-6989586621684454763"><span class="annot"><span class="annottext">outersoac :: ([Input] -&gt; SOAC SOACS)
-&gt; (SubExp, [SubExp]) -&gt; TryFusion ([Input] -&gt; SOAC SOACS)
</span><a href="#local-6989586621684454763"><span class="hs-identifier hs-var hs-var">outersoac</span></a></span></span><span> </span><span id="local-6989586621684454762"><span class="annot"><span class="annottext">[Input] -&gt; SOAC SOACS
</span><a href="#local-6989586621684454762"><span class="hs-identifier hs-var">inner</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684454761"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684454761"><span class="hs-identifier hs-var">w</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684454760"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684454760"><span class="hs-identifier hs-var">outershape</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-852"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684454759"><span class="annot"><span class="annottext">addDims :: TypeBase (ShapeBase SubExp) NoUniqueness
-&gt; TypeBase (ShapeBase SubExp) NoUniqueness
</span><a href="#local-6989586621684454759"><span class="hs-identifier hs-var hs-var">addDims</span></a></span></span><span> </span><span id="local-6989586621684454758"><span class="annot"><span class="annottext">TypeBase (ShapeBase SubExp) NoUniqueness
</span><a href="#local-6989586621684454758"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeBase (ShapeBase SubExp) NoUniqueness
-&gt; ShapeBase SubExp
-&gt; NoUniqueness
-&gt; TypeBase (ShapeBase SubExp) NoUniqueness
forall shape u_unused u.
ArrayShape shape =&gt;
TypeBase shape u_unused -&gt; shape -&gt; u -&gt; TypeBase shape u
</span><a href="Futhark.IR.Prop.Types.html#arrayOf"><span class="hs-identifier hs-var">arrayOf</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase (ShapeBase SubExp) NoUniqueness
</span><a href="#local-6989586621684454758"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; ShapeBase SubExp
forall d. [d] -&gt; ShapeBase d
</span><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-var">Shape</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684454760"><span class="hs-identifier hs-var">outershape</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">NoUniqueness
</span><a href="Futhark.IR.Syntax.Core.html#NoUniqueness"><span class="hs-identifier hs-var">NoUniqueness</span></a></span><span>
</span><span id="line-853"></span><span>              </span><span id="local-6989586621684454754"><span class="annot"><span class="annottext">retTypes :: [TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="#local-6989586621684454754"><span class="hs-identifier hs-var hs-var">retTypes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TypeBase (ShapeBase SubExp) NoUniqueness
 -&gt; TypeBase (ShapeBase SubExp) NoUniqueness)
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TypeBase (ShapeBase SubExp) NoUniqueness
-&gt; TypeBase (ShapeBase SubExp) NoUniqueness
</span><a href="#local-6989586621684454759"><span class="hs-identifier hs-var">addDims</span></a></span><span> </span><span class="annot"><span class="annottext">([TypeBase (ShapeBase SubExp) NoUniqueness]
 -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness])
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
forall rep.
LambdaT rep -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684454776"><span class="hs-identifier hs-var">maplam</span></a></span><span>
</span><span id="line-854"></span><span>
</span><span id="line-855"></span><span>          </span><span id="local-6989586621684454753"><span class="annot"><span class="annottext">[Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
</span><a href="#local-6989586621684454753"><span class="hs-identifier hs-var">ps</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; (TypeBase (ShapeBase SubExp) NoUniqueness
    -&gt; TryFusion (Param (TypeBase (ShapeBase SubExp) NoUniqueness)))
-&gt; TryFusion [Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="annot"><span class="annottext">[TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="#local-6989586621684454765"><span class="hs-identifier hs-var">inputTypes</span></a></span><span> </span><span class="annot"><span class="annottext">((TypeBase (ShapeBase SubExp) NoUniqueness
  -&gt; TryFusion (Param (TypeBase (ShapeBase SubExp) NoUniqueness)))
 -&gt; TryFusion [Param (TypeBase (ShapeBase SubExp) NoUniqueness)])
-&gt; (TypeBase (ShapeBase SubExp) NoUniqueness
    -&gt; TryFusion (Param (TypeBase (ShapeBase SubExp) NoUniqueness)))
-&gt; TryFusion [Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684454752"><span class="annot"><span class="annottext">TypeBase (ShapeBase SubExp) NoUniqueness
</span><a href="#local-6989586621684454752"><span class="hs-identifier hs-var">inpt</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-856"></span><span>            </span><span class="annot"><span class="annottext">String
-&gt; TypeBase (ShapeBase SubExp) NoUniqueness
-&gt; TryFusion (Param (TypeBase (ShapeBase SubExp) NoUniqueness))
forall (m :: * -&gt; *) dec.
MonadFreshNames m =&gt;
String -&gt; dec -&gt; m (Param dec)
</span><a href="Futhark.MonadFreshNames.html#newParam"><span class="hs-identifier hs-var">newParam</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;pullReshape_param&quot;</span></span><span> </span><span class="annot"><span class="annottext">(TypeBase (ShapeBase SubExp) NoUniqueness
 -&gt; TryFusion (Param (TypeBase (ShapeBase SubExp) NoUniqueness)))
-&gt; TypeBase (ShapeBase SubExp) NoUniqueness
-&gt; TryFusion (Param (TypeBase (ShapeBase SubExp) NoUniqueness))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-857"></span><span>              </span><span class="annot"><span class="annottext">Int
-&gt; TypeBase (ShapeBase SubExp) NoUniqueness
-&gt; TypeBase (ShapeBase SubExp) NoUniqueness
forall u.
Int
-&gt; TypeBase (ShapeBase SubExp) u -&gt; TypeBase (ShapeBase SubExp) u
</span><a href="Futhark.IR.Prop.Types.html#stripArray"><span class="hs-identifier hs-var">stripArray</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ShapeChange SubExp -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">ShapeChange SubExp
</span><a href="#local-6989586621684454774"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684454760"><span class="hs-identifier hs-var">outershape</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TypeBase (ShapeBase SubExp) NoUniqueness
</span><a href="#local-6989586621684454752"><span class="hs-identifier hs-var">inpt</span></a></span><span>
</span><span id="line-858"></span><span>
</span><span id="line-859"></span><span>          </span><span id="local-6989586621684454750"><span class="annot"><span class="annottext">BodyT SOACS
</span><a href="#local-6989586621684454750"><span class="hs-identifier hs-var">inner_body</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-860"></span><span>            </span><span class="annot"><span class="annottext">Builder SOACS (BodyT SOACS) -&gt; TryFusion (BodyT SOACS)
forall rep (m :: * -&gt; *) somerep.
(Buildable rep, MonadFreshNames m, HasScope somerep m,
 SameScope somerep rep) =&gt;
Builder rep (Body rep) -&gt; m (Body rep)
</span><a href="Futhark.Builder.html#runBodyBuilder"><span class="hs-identifier hs-var">runBodyBuilder</span></a></span><span> </span><span class="annot"><span class="annottext">(Builder SOACS (BodyT SOACS) -&gt; TryFusion (BodyT SOACS))
-&gt; Builder SOACS (BodyT SOACS) -&gt; TryFusion (BodyT SOACS)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-861"></span><span>              </span><span class="annot"><span class="annottext">[BuilderT
   SOACS
   (State VNameSource)
   (Exp (Rep (BuilderT SOACS (State VNameSource))))]
-&gt; BuilderT
     SOACS
     (State VNameSource)
     (Body (Rep (BuilderT SOACS (State VNameSource))))
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[m (Exp (Rep m))] -&gt; m (Body (Rep m))
</span><a href="Futhark.Construct.html#eBody"><span class="hs-identifier hs-var">eBody</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SOAC (Rep (BuilderT SOACS (State VNameSource)))
-&gt; BuilderT
     SOACS
     (State VNameSource)
     (Exp (Rep (BuilderT SOACS (State VNameSource))))
forall (m :: * -&gt; *).
(MonadBuilder m, Op (Rep m) ~ SOAC (Rep m)) =&gt;
SOAC (Rep m) -&gt; m (Exp (Rep m))
</span><a href="Futhark.Analysis.HORep.SOAC.html#toExp"><span class="hs-identifier hs-var">SOAC.toExp</span></a></span><span> </span><span class="annot"><span class="annottext">(SOAC (Rep (BuilderT SOACS (State VNameSource)))
 -&gt; BuilderT
      SOACS
      (State VNameSource)
      (Exp (Rep (BuilderT SOACS (State VNameSource)))))
-&gt; SOAC (Rep (BuilderT SOACS (State VNameSource)))
-&gt; BuilderT
     SOACS
     (State VNameSource)
     (Exp (Rep (BuilderT SOACS (State VNameSource))))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Input] -&gt; SOAC SOACS
</span><a href="#local-6989586621684454762"><span class="hs-identifier hs-var">inner</span></a></span><span> </span><span class="annot"><span class="annottext">([Input] -&gt; SOAC SOACS) -&gt; [Input] -&gt; SOAC SOACS
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Param (TypeBase (ShapeBase SubExp) NoUniqueness) -&gt; Input)
-&gt; [Param (TypeBase (ShapeBase SubExp) NoUniqueness)] -&gt; [Input]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ident -&gt; Input
</span><a href="Futhark.Analysis.HORep.SOAC.html#identInput"><span class="hs-identifier hs-var">SOAC.identInput</span></a></span><span> </span><span class="annot"><span class="annottext">(Ident -&gt; Input)
-&gt; (Param (TypeBase (ShapeBase SubExp) NoUniqueness) -&gt; Ident)
-&gt; Param (TypeBase (ShapeBase SubExp) NoUniqueness)
-&gt; Input
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Param (TypeBase (ShapeBase SubExp) NoUniqueness) -&gt; Ident
forall dec. Typed dec =&gt; Param dec -&gt; Ident
</span><a href="Futhark.IR.Prop.Patterns.html#paramIdent"><span class="hs-identifier hs-var">paramIdent</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
</span><a href="#local-6989586621684454753"><span class="hs-identifier hs-var">ps</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-862"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684454745"><span class="annot"><span class="annottext">inner_fun :: Lambda SOACS
</span><a href="#local-6989586621684454745"><span class="hs-identifier hs-var hs-var">inner_fun</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-863"></span><span>                </span><span class="annot"><span class="annottext">Lambda :: forall rep.
[LParam rep]
-&gt; BodyT rep
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; LambdaT rep
</span><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span>
</span><span id="line-864"></span><span>                  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">lambdaParams :: [LParam SOACS]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var">lambdaParams</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
[LParam SOACS]
</span><a href="#local-6989586621684454753"><span class="hs-identifier hs-var">ps</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-865"></span><span>                    </span><span class="annot"><span class="annottext">lambdaReturnType :: [TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var">lambdaReturnType</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="#local-6989586621684454754"><span class="hs-identifier hs-var">retTypes</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-866"></span><span>                    </span><span class="annot"><span class="annottext">lambdaBody :: BodyT SOACS
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var">lambdaBody</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BodyT SOACS
</span><a href="#local-6989586621684454750"><span class="hs-identifier hs-var">inner_body</span></a></span><span>
</span><span id="line-867"></span><span>                  </span><span class="hs-special">}</span><span>
</span><span id="line-868"></span><span>          </span><span class="annot"><span class="annottext">([Input] -&gt; SOAC SOACS) -&gt; TryFusion ([Input] -&gt; SOAC SOACS)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(([Input] -&gt; SOAC SOACS) -&gt; TryFusion ([Input] -&gt; SOAC SOACS))
-&gt; ([Input] -&gt; SOAC SOACS) -&gt; TryFusion ([Input] -&gt; SOAC SOACS)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; ScremaForm SOACS -&gt; [Input] -&gt; SOAC SOACS
forall rep. SubExp -&gt; ScremaForm rep -&gt; [Input] -&gt; SOAC rep
</span><a href="Futhark.Analysis.HORep.SOAC.html#Screma"><span class="hs-identifier hs-var">SOAC.Screma</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684454761"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">(ScremaForm SOACS -&gt; [Input] -&gt; SOAC SOACS)
-&gt; ScremaForm SOACS -&gt; [Input] -&gt; SOAC SOACS
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS -&gt; ScremaForm SOACS
forall rep. Lambda rep -&gt; ScremaForm rep
</span><a href="Futhark.IR.SOACS.SOAC.html#mapSOAC"><span class="hs-identifier hs-var">Futhark.mapSOAC</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684454745"><span class="hs-identifier hs-var">inner_fun</span></a></span><span>
</span><span id="line-869"></span><span>
</span><span id="line-870"></span><span>    </span><span id="local-6989586621684454743"><span class="annot"><span class="annottext">[Input] -&gt; SOAC SOACS
</span><a href="#local-6989586621684454743"><span class="hs-identifier hs-var">op'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-871"></span><span>      </span><span class="annot"><span class="annottext">(([Input] -&gt; SOAC SOACS)
 -&gt; (SubExp, [SubExp]) -&gt; TryFusion ([Input] -&gt; SOAC SOACS))
-&gt; ([Input] -&gt; SOAC SOACS)
-&gt; [(SubExp, [SubExp])]
-&gt; TryFusion ([Input] -&gt; SOAC SOACS)
forall (t :: * -&gt; *) (m :: * -&gt; *) b a.
(Foldable t, Monad m) =&gt;
(b -&gt; a -&gt; m b) -&gt; b -&gt; t a -&gt; m b
</span><span class="hs-identifier hs-var">foldM</span></span><span> </span><span class="annot"><span class="annottext">([Input] -&gt; SOAC SOACS)
-&gt; (SubExp, [SubExp]) -&gt; TryFusion ([Input] -&gt; SOAC SOACS)
</span><a href="#local-6989586621684454763"><span class="hs-identifier hs-var">outersoac</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp -&gt; ScremaForm SOACS -&gt; [Input] -&gt; SOAC SOACS
forall rep. SubExp -&gt; ScremaForm rep -&gt; [Input] -&gt; SOAC rep
</span><a href="Futhark.Analysis.HORep.SOAC.html#Screma"><span class="hs-identifier hs-var">SOAC.Screma</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684454771"><span class="hs-identifier hs-var">mapw'</span></a></span><span> </span><span class="annot"><span class="annottext">(ScremaForm SOACS -&gt; [Input] -&gt; SOAC SOACS)
-&gt; ScremaForm SOACS -&gt; [Input] -&gt; SOAC SOACS
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS -&gt; ScremaForm SOACS
forall rep. Lambda rep -&gt; ScremaForm rep
</span><a href="Futhark.IR.SOACS.SOAC.html#mapSOAC"><span class="hs-identifier hs-var">Futhark.mapSOAC</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684454776"><span class="hs-identifier hs-var">maplam</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(SubExp, [SubExp])] -&gt; TryFusion ([Input] -&gt; SOAC SOACS))
-&gt; [(SubExp, [SubExp])] -&gt; TryFusion ([Input] -&gt; SOAC SOACS)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-872"></span><span>        </span><span class="annot"><span class="annottext">[SubExp] -&gt; [[SubExp]] -&gt; [(SubExp, [SubExp])]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; [SubExp] -&gt; [SubExp]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [SubExp]) -&gt; [SubExp] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; [SubExp]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [SubExp]) -&gt; [SubExp] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ShapeChange SubExp -&gt; [SubExp]
forall d. ShapeChange d -&gt; [d]
</span><a href="Futhark.IR.Prop.Reshape.html#newDims"><span class="hs-identifier hs-var">newDims</span></a></span><span> </span><span class="annot"><span class="annottext">ShapeChange SubExp
</span><a href="#local-6989586621684454774"><span class="hs-identifier hs-var">shape</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([[SubExp]] -&gt; [(SubExp, [SubExp])])
-&gt; [[SubExp]] -&gt; [(SubExp, [SubExp])]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-873"></span><span>          </span><span class="annot"><span class="annottext">Int -&gt; [[SubExp]] -&gt; [[SubExp]]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">([[SubExp]] -&gt; [[SubExp]]) -&gt; [[SubExp]] -&gt; [[SubExp]]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[[SubExp]] -&gt; [[SubExp]]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">([[SubExp]] -&gt; [[SubExp]]) -&gt; [[SubExp]] -&gt; [[SubExp]]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [[SubExp]] -&gt; [[SubExp]]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">([[SubExp]] -&gt; [[SubExp]]) -&gt; [[SubExp]] -&gt; [[SubExp]]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; [[SubExp]]
forall a. [a] -&gt; [[a]]
</span><span class="hs-identifier hs-var">tails</span></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [[SubExp]]) -&gt; [SubExp] -&gt; [[SubExp]]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ShapeChange SubExp -&gt; [SubExp]
forall d. ShapeChange d -&gt; [d]
</span><a href="Futhark.IR.Prop.Reshape.html#newDims"><span class="hs-identifier hs-var">newDims</span></a></span><span> </span><span class="annot"><span class="annottext">ShapeChange SubExp
</span><a href="#local-6989586621684454774"><span class="hs-identifier hs-var">shape</span></a></span><span>
</span><span id="line-874"></span><span>    </span><span class="annot"><span class="annottext">(SOAC SOACS, ArrayTransforms)
-&gt; TryFusion (SOAC SOACS, ArrayTransforms)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Input] -&gt; SOAC SOACS
</span><a href="#local-6989586621684454743"><span class="hs-identifier hs-var">op'</span></a></span><span> </span><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684454766"><span class="hs-identifier hs-var">inputs'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684454773"><span class="hs-identifier hs-var">ots'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-875"></span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#pullReshape"><span class="hs-identifier hs-var">pullReshape</span></a></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ArrayTransforms
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; TryFusion (SOAC SOACS, ArrayTransforms)
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Cannot pull reshape&quot;</span></span><span>
</span><span id="line-876"></span><span>
</span><span id="line-877"></span><span class="hs-comment">-- Tie it all together in exposeInputs (for making inputs to a</span><span>
</span><span id="line-878"></span><span class="hs-comment">-- consumer available) and pullOutputTransforms (for moving</span><span>
</span><span id="line-879"></span><span class="hs-comment">-- output-transforms of a producer to its inputs instead).</span><span>
</span><span id="line-880"></span><span>
</span><span id="line-881"></span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#exposeInputs"><span class="hs-identifier hs-type">exposeInputs</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-882"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-883"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#FusedKer"><span class="hs-identifier hs-type">FusedKer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-884"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#TryFusion"><span class="hs-identifier hs-type">TryFusion</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#FusedKer"><span class="hs-identifier hs-type">FusedKer</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#ArrayTransforms"><span class="hs-identifier hs-type">SOAC.ArrayTransforms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-885"></span><span id="exposeInputs"><span class="annot"><span class="annottext">exposeInputs :: [VName] -&gt; FusedKer -&gt; TryFusion (FusedKer, ArrayTransforms)
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#exposeInputs"><span class="hs-identifier hs-var hs-var">exposeInputs</span></a></span></span><span> </span><span id="local-6989586621684454742"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684454742"><span class="hs-identifier hs-var">inpIds</span></a></span></span><span> </span><span id="local-6989586621684454741"><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684454741"><span class="hs-identifier hs-var">ker</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-886"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FusedKer -&gt; TryFusion (FusedKer, ArrayTransforms)
</span><a href="#local-6989586621684454740"><span class="hs-identifier hs-var">exposeInputs'</span></a></span><span> </span><span class="annot"><span class="annottext">(FusedKer -&gt; TryFusion (FusedKer, ArrayTransforms))
-&gt; TryFusion FusedKer -&gt; TryFusion (FusedKer, ArrayTransforms)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">TryFusion FusedKer
</span><a href="#local-6989586621684454739"><span class="hs-identifier hs-var">pushRearrange'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-887"></span><span>    </span><span class="annot"><span class="annottext">TryFusion (FusedKer, ArrayTransforms)
-&gt; TryFusion (FusedKer, ArrayTransforms)
-&gt; TryFusion (FusedKer, ArrayTransforms)
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">&lt;|&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FusedKer -&gt; TryFusion (FusedKer, ArrayTransforms)
</span><a href="#local-6989586621684454740"><span class="hs-identifier hs-var">exposeInputs'</span></a></span><span> </span><span class="annot"><span class="annottext">(FusedKer -&gt; TryFusion (FusedKer, ArrayTransforms))
-&gt; TryFusion FusedKer -&gt; TryFusion (FusedKer, ArrayTransforms)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">TryFusion FusedKer
</span><a href="#local-6989586621684454738"><span class="hs-identifier hs-var">pullRearrange'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-888"></span><span>    </span><span class="annot"><span class="annottext">TryFusion (FusedKer, ArrayTransforms)
-&gt; TryFusion (FusedKer, ArrayTransforms)
-&gt; TryFusion (FusedKer, ArrayTransforms)
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">FusedKer -&gt; TryFusion (FusedKer, ArrayTransforms)
</span><a href="#local-6989586621684454740"><span class="hs-identifier hs-var">exposeInputs'</span></a></span><span> </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684454741"><span class="hs-identifier hs-var">ker</span></a></span><span>
</span><span id="line-889"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-890"></span><span>    </span><span id="local-6989586621684454737"><span class="annot"><span class="annottext">ot :: ArrayTransforms
</span><a href="#local-6989586621684454737"><span class="hs-identifier hs-var hs-var">ot</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FusedKer -&gt; ArrayTransforms
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#outputTransform"><span class="hs-identifier hs-var hs-var">outputTransform</span></a></span><span> </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684454741"><span class="hs-identifier hs-var">ker</span></a></span><span>
</span><span id="line-891"></span><span>
</span><span id="line-892"></span><span>    </span><span id="local-6989586621684454739"><span class="annot"><span class="annottext">pushRearrange' :: TryFusion FusedKer
</span><a href="#local-6989586621684454739"><span class="hs-identifier hs-var hs-var">pushRearrange'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-893"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684454736"><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684454736"><span class="hs-identifier hs-var">soac'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684454735"><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684454735"><span class="hs-identifier hs-var">ot'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[VName]
-&gt; SOAC SOACS
-&gt; ArrayTransforms
-&gt; TryFusion (SOAC SOACS, ArrayTransforms)
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#pushRearrange"><span class="hs-identifier hs-var">pushRearrange</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684454742"><span class="hs-identifier hs-var">inpIds</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FusedKer -&gt; SOAC SOACS
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#fsoac"><span class="hs-identifier hs-var hs-var">fsoac</span></a></span><span> </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684454741"><span class="hs-identifier hs-var">ker</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684454737"><span class="hs-identifier hs-var">ot</span></a></span><span>
</span><span id="line-894"></span><span>      </span><span class="annot"><span class="annottext">FusedKer -&gt; TryFusion FusedKer
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-895"></span><span>        </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684454741"><span class="hs-identifier hs-var">ker</span></a></span><span>
</span><span id="line-896"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fsoac :: SOAC SOACS
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#fsoac"><span class="hs-identifier hs-var">fsoac</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684454736"><span class="hs-identifier hs-var">soac'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-897"></span><span>            </span><span class="annot"><span class="annottext">outputTransform :: ArrayTransforms
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#outputTransform"><span class="hs-identifier hs-var">outputTransform</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684454735"><span class="hs-identifier hs-var">ot'</span></a></span><span>
</span><span id="line-898"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-899"></span><span>
</span><span id="line-900"></span><span>    </span><span id="local-6989586621684454738"><span class="annot"><span class="annottext">pullRearrange' :: TryFusion FusedKer
</span><a href="#local-6989586621684454738"><span class="hs-identifier hs-var hs-var">pullRearrange'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-901"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684454734"><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684454734"><span class="hs-identifier hs-var">soac'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684454733"><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684454733"><span class="hs-identifier hs-var">ot'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
-&gt; ArrayTransforms -&gt; TryFusion (SOAC SOACS, ArrayTransforms)
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#pullRearrange"><span class="hs-identifier hs-var">pullRearrange</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FusedKer -&gt; SOAC SOACS
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#fsoac"><span class="hs-identifier hs-var hs-var">fsoac</span></a></span><span> </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684454741"><span class="hs-identifier hs-var">ker</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684454737"><span class="hs-identifier hs-var">ot</span></a></span><span>
</span><span id="line-902"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; TryFusion () -&gt; TryFusion ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ArrayTransforms -&gt; Bool
</span><a href="Futhark.Analysis.HORep.SOAC.html#nullTransforms"><span class="hs-identifier hs-var">SOAC.nullTransforms</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684454733"><span class="hs-identifier hs-var">ot'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TryFusion () -&gt; TryFusion ()) -&gt; TryFusion () -&gt; TryFusion ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-903"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; TryFusion ()
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;pullRearrange was not enough&quot;</span></span><span>
</span><span id="line-904"></span><span>      </span><span class="annot"><span class="annottext">FusedKer -&gt; TryFusion FusedKer
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-905"></span><span>        </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684454741"><span class="hs-identifier hs-var">ker</span></a></span><span>
</span><span id="line-906"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">fsoac :: SOAC SOACS
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#fsoac"><span class="hs-identifier hs-var">fsoac</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684454734"><span class="hs-identifier hs-var">soac'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-907"></span><span>            </span><span class="annot"><span class="annottext">outputTransform :: ArrayTransforms
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#outputTransform"><span class="hs-identifier hs-var">outputTransform</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="Futhark.Analysis.HORep.SOAC.html#noTransforms"><span class="hs-identifier hs-var">SOAC.noTransforms</span></a></span><span>
</span><span id="line-908"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-909"></span><span>
</span><span id="line-910"></span><span>    </span><span id="local-6989586621684454740"><span class="annot"><span class="annottext">exposeInputs' :: FusedKer -&gt; TryFusion (FusedKer, ArrayTransforms)
</span><a href="#local-6989586621684454740"><span class="hs-identifier hs-var hs-var">exposeInputs'</span></a></span></span><span> </span><span id="local-6989586621684454731"><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684454731"><span class="hs-identifier hs-var">ker'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-911"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [Input] -&gt; (ArrayTransforms, [Input])
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#commonTransforms"><span class="hs-identifier hs-var">commonTransforms</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684454742"><span class="hs-identifier hs-var">inpIds</span></a></span><span> </span><span class="annot"><span class="annottext">([Input] -&gt; (ArrayTransforms, [Input]))
-&gt; [Input] -&gt; (ArrayTransforms, [Input])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FusedKer -&gt; [Input]
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#inputs"><span class="hs-identifier hs-var">inputs</span></a></span><span> </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684454731"><span class="hs-identifier hs-var">ker'</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-912"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621684454730"><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684454730"><span class="hs-identifier hs-var">ot'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684454729"><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684454729"><span class="hs-identifier hs-var">inps'</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-913"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">(Input -&gt; Bool) -&gt; [Input] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="annot"><span class="annottext">Input -&gt; Bool
</span><a href="#local-6989586621684454728"><span class="hs-identifier hs-var">exposed</span></a></span><span> </span><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684454729"><span class="hs-identifier hs-var">inps'</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-914"></span><span>            </span><span class="annot"><span class="annottext">(FusedKer, ArrayTransforms)
-&gt; TryFusion (FusedKer, ArrayTransforms)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684454731"><span class="hs-identifier hs-var">ker'</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">fsoac :: SOAC SOACS
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#fsoac"><span class="hs-identifier hs-var">fsoac</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Input]
</span><a href="#local-6989586621684454729"><span class="hs-identifier hs-var">inps'</span></a></span><span> </span><span class="annot"><span class="annottext">[Input] -&gt; SOAC SOACS -&gt; SOAC SOACS
forall rep. [Input] -&gt; SOAC rep -&gt; SOAC rep
</span><a href="Futhark.Analysis.HORep.SOAC.html#setInputs"><span class="hs-operator hs-var">`SOAC.setInputs`</span></a></span><span> </span><span class="annot"><span class="annottext">FusedKer -&gt; SOAC SOACS
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#fsoac"><span class="hs-identifier hs-var hs-var">fsoac</span></a></span><span> </span><span class="annot"><span class="annottext">FusedKer
</span><a href="#local-6989586621684454731"><span class="hs-identifier hs-var">ker'</span></a></span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684454730"><span class="hs-identifier hs-var">ot'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-915"></span><span>        </span><span class="annot"><span class="annottext">(ArrayTransforms, [Input])
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; TryFusion (FusedKer, ArrayTransforms)
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Cannot expose&quot;</span></span><span>
</span><span id="line-916"></span><span>
</span><span id="line-917"></span><span>    </span><span id="local-6989586621684454728"><span class="annot"><span class="annottext">exposed :: Input -&gt; Bool
</span><a href="#local-6989586621684454728"><span class="hs-identifier hs-var hs-var">exposed</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#Input"><span class="hs-identifier hs-type">SOAC.Input</span></a></span><span> </span><span id="local-6989586621684454727"><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684454727"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">TypeBase (ShapeBase SubExp) NoUniqueness
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-918"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">ArrayTransforms -&gt; Bool
</span><a href="Futhark.Analysis.HORep.SOAC.html#nullTransforms"><span class="hs-identifier hs-var">SOAC.nullTransforms</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684454727"><span class="hs-identifier hs-var">ts</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-919"></span><span>    </span><span class="annot"><a href="#local-6989586621684454728"><span class="hs-identifier hs-var">exposed</span></a></span><span> </span><span id="local-6989586621684454726"><span class="annot"><span class="annottext">Input
</span><a href="#local-6989586621684454726"><span class="hs-identifier hs-var">inp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Input -&gt; VName
</span><a href="Futhark.Analysis.HORep.SOAC.html#inputArray"><span class="hs-identifier hs-var">SOAC.inputArray</span></a></span><span> </span><span class="annot"><span class="annottext">Input
</span><a href="#local-6989586621684454726"><span class="hs-identifier hs-var">inp</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [VName] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`notElem`</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684454742"><span class="hs-identifier hs-var">inpIds</span></a></span><span>
</span><span id="line-920"></span><span>
</span><span id="line-921"></span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#outputTransformPullers"><span class="hs-identifier hs-type">outputTransformPullers</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#SOAC"><span class="hs-identifier hs-type">SOAC</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#ArrayTransforms"><span class="hs-identifier hs-type">SOAC.ArrayTransforms</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#TryFusion"><span class="hs-identifier hs-type">TryFusion</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#SOAC"><span class="hs-identifier hs-type">SOAC</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#ArrayTransforms"><span class="hs-identifier hs-type">SOAC.ArrayTransforms</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-922"></span><span id="outputTransformPullers"><span class="annot"><span class="annottext">outputTransformPullers :: [SOAC SOACS
 -&gt; ArrayTransforms -&gt; TryFusion (SOAC SOACS, ArrayTransforms)]
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#outputTransformPullers"><span class="hs-identifier hs-var hs-var">outputTransformPullers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SOAC SOACS
-&gt; ArrayTransforms -&gt; TryFusion (SOAC SOACS, ArrayTransforms)
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#pullRearrange"><span class="hs-identifier hs-var">pullRearrange</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
-&gt; ArrayTransforms -&gt; TryFusion (SOAC SOACS, ArrayTransforms)
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#pullReshape"><span class="hs-identifier hs-var">pullReshape</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-923"></span><span>
</span><span id="line-924"></span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#pullOutputTransforms"><span class="hs-identifier hs-type">pullOutputTransforms</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-925"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#SOAC"><span class="hs-identifier hs-type">SOAC</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-926"></span><span>  </span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#ArrayTransforms"><span class="hs-identifier hs-type">SOAC.ArrayTransforms</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-927"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#TryFusion"><span class="hs-identifier hs-type">TryFusion</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Fusion.LoopKernel.html#SOAC"><span class="hs-identifier hs-type">SOAC</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Analysis.HORep.SOAC.html#ArrayTransforms"><span class="hs-identifier hs-type">SOAC.ArrayTransforms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-928"></span><span id="pullOutputTransforms"><span class="annot"><span class="annottext">pullOutputTransforms :: SOAC SOACS
-&gt; ArrayTransforms -&gt; TryFusion (SOAC SOACS, ArrayTransforms)
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#pullOutputTransforms"><span class="hs-identifier hs-var hs-var">pullOutputTransforms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SOAC SOACS
 -&gt; ArrayTransforms -&gt; TryFusion (SOAC SOACS, ArrayTransforms)]
-&gt; SOAC SOACS
-&gt; ArrayTransforms
-&gt; TryFusion (SOAC SOACS, ArrayTransforms)
forall {t} {t}.
[t -&gt; t -&gt; TryFusion (SOAC SOACS, ArrayTransforms)]
-&gt; t -&gt; t -&gt; TryFusion (SOAC SOACS, ArrayTransforms)
</span><a href="#local-6989586621684454724"><span class="hs-identifier hs-var">attempt</span></a></span><span> </span><span class="annot"><span class="annottext">[SOAC SOACS
 -&gt; ArrayTransforms -&gt; TryFusion (SOAC SOACS, ArrayTransforms)]
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#outputTransformPullers"><span class="hs-identifier hs-var">outputTransformPullers</span></a></span><span>
</span><span id="line-929"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-930"></span><span>    </span><span id="local-6989586621684454724"><span class="annot"><span class="annottext">attempt :: [t -&gt; t -&gt; TryFusion (SOAC SOACS, ArrayTransforms)]
-&gt; t -&gt; t -&gt; TryFusion (SOAC SOACS, ArrayTransforms)
</span><a href="#local-6989586621684454724"><span class="hs-identifier hs-var hs-var">attempt</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">t
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">t
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; TryFusion (SOAC SOACS, ArrayTransforms)
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Cannot pull anything&quot;</span></span><span>
</span><span id="line-931"></span><span>    </span><span class="annot"><a href="#local-6989586621684454724"><span class="hs-identifier hs-var">attempt</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684454717"><span class="annot"><span class="annottext">t -&gt; t -&gt; TryFusion (SOAC SOACS, ArrayTransforms)
</span><a href="#local-6989586621684454717"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684454716"><span class="annot"><span class="annottext">[t -&gt; t -&gt; TryFusion (SOAC SOACS, ArrayTransforms)]
</span><a href="#local-6989586621684454716"><span class="hs-identifier hs-var">ps</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684454715"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621684454715"><span class="hs-identifier hs-var">soac</span></a></span></span><span> </span><span id="local-6989586621684454714"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621684454714"><span class="hs-identifier hs-var">ots</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-932"></span><span>      </span><span class="hs-keyword">do</span><span>
</span><span id="line-933"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621684454713"><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684454713"><span class="hs-identifier hs-var">soac'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684454712"><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684454712"><span class="hs-identifier hs-var">ots'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">t -&gt; t -&gt; TryFusion (SOAC SOACS, ArrayTransforms)
</span><a href="#local-6989586621684454717"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621684454715"><span class="hs-identifier hs-var">soac</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621684454714"><span class="hs-identifier hs-var">ots</span></a></span><span>
</span><span id="line-934"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">ArrayTransforms -&gt; Bool
</span><a href="Futhark.Analysis.HORep.SOAC.html#nullTransforms"><span class="hs-identifier hs-var">SOAC.nullTransforms</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684454712"><span class="hs-identifier hs-var">ots'</span></a></span><span>
</span><span id="line-935"></span><span>          </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">(SOAC SOACS, ArrayTransforms)
-&gt; TryFusion (SOAC SOACS, ArrayTransforms)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684454713"><span class="hs-identifier hs-var">soac'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="Futhark.Analysis.HORep.SOAC.html#noTransforms"><span class="hs-identifier hs-var">SOAC.noTransforms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-936"></span><span>          </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
-&gt; ArrayTransforms -&gt; TryFusion (SOAC SOACS, ArrayTransforms)
</span><a href="Futhark.Optimise.Fusion.LoopKernel.html#pullOutputTransforms"><span class="hs-identifier hs-var">pullOutputTransforms</span></a></span><span> </span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684454713"><span class="hs-identifier hs-var">soac'</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684454712"><span class="hs-identifier hs-var">ots'</span></a></span><span> </span><span class="annot"><span class="annottext">TryFusion (SOAC SOACS, ArrayTransforms)
-&gt; TryFusion (SOAC SOACS, ArrayTransforms)
-&gt; TryFusion (SOAC SOACS, ArrayTransforms)
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">(SOAC SOACS, ArrayTransforms)
-&gt; TryFusion (SOAC SOACS, ArrayTransforms)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SOAC SOACS
</span><a href="#local-6989586621684454713"><span class="hs-identifier hs-var">soac'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ArrayTransforms
</span><a href="#local-6989586621684454712"><span class="hs-identifier hs-var">ots'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-937"></span><span>        </span><span class="annot"><span class="annottext">TryFusion (SOAC SOACS, ArrayTransforms)
-&gt; TryFusion (SOAC SOACS, ArrayTransforms)
-&gt; TryFusion (SOAC SOACS, ArrayTransforms)
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">[t -&gt; t -&gt; TryFusion (SOAC SOACS, ArrayTransforms)]
-&gt; t -&gt; t -&gt; TryFusion (SOAC SOACS, ArrayTransforms)
</span><a href="#local-6989586621684454724"><span class="hs-identifier hs-var">attempt</span></a></span><span> </span><span class="annot"><span class="annottext">[t -&gt; t -&gt; TryFusion (SOAC SOACS, ArrayTransforms)]
</span><a href="#local-6989586621684454716"><span class="hs-identifier hs-var">ps</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621684454715"><span class="hs-identifier hs-var">soac</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621684454714"><span class="hs-identifier hs-var">ots</span></a></span><span>
</span><span id="line-938"></span></pre></body></html>