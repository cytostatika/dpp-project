<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE QuasiQuotes #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE TemplateHaskell #-}</span><span>
</span><span id="line-4"></span><span>
</span><span id="line-5"></span><span class="hs-comment">-- | C code generator.  This module can convert a correct ImpCode</span><span>
</span><span id="line-6"></span><span class="hs-comment">-- program to an equivalent C program.</span><span>
</span><span id="line-7"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Futhark.CodeGen.Backends.MulticoreC</span><span>
</span><span id="line-8"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#compileProg"><span class="hs-identifier">compileProg</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-9"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#generateContext"><span class="hs-identifier">generateContext</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-10"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.Backends.GenericC.html#CParts"><span class="hs-identifier">GC.CParts</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-11"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.Backends.GenericC.html#asLibrary"><span class="hs-identifier">GC.asLibrary</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-12"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.Backends.GenericC.html#asExecutable"><span class="hs-identifier">GC.asExecutable</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-13"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.Backends.GenericC.html#asServer"><span class="hs-identifier">GC.asServer</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-14"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#operations"><span class="hs-identifier">operations</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-15"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#cliOptions"><span class="hs-identifier">cliOptions</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-16"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span class="hs-keyword">where</span><span>
</span><span id="line-18"></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">T</span></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.CodeGen.Backends.GenericC.html"><span class="hs-identifier">Futhark.CodeGen.Backends.GenericC</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">GC</span></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.CodeGen.Backends.GenericC.Options.html"><span class="hs-identifier">Futhark.CodeGen.Backends.GenericC.Options</span></a></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.CodeGen.Backends.SimpleRep.html"><span class="hs-identifier">Futhark.CodeGen.Backends.SimpleRep</span></a></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.Multicore.html"><span class="hs-identifier">Futhark.CodeGen.ImpCode.Multicore</span></a></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.html"><span class="hs-identifier">Futhark.CodeGen.ImpGen.Multicore</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">ImpGen</span></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.CodeGen.RTS.C.html"><span class="hs-identifier">Futhark.CodeGen.RTS.C</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.RTS.C.html#schedulerH"><span class="hs-identifier">schedulerH</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html"><span class="hs-identifier">Futhark.IR.MCMem</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier">MCMem</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Prog"><span class="hs-identifier">Prog</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.MonadFreshNames.html"><span class="hs-identifier">Futhark.MonadFreshNames</span></a></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Language.C.Quote.OpenCL</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">C</span></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Language.C.Syntax</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">C</span></span><span>
</span><span id="line-33"></span><span>
</span><span id="line-34"></span><span class="hs-comment">-- | Compile the program to ImpCode with multicore operations.</span><span>
</span><span id="line-35"></span><span id="local-6989586621684536098"><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#compileProg"><span class="hs-identifier hs-type">compileProg</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-36"></span><span>  </span><span class="annot"><a href="Futhark.MonadFreshNames.html#MonadFreshNames"><span class="hs-identifier hs-type">MonadFreshNames</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684536098"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Prog"><span class="hs-identifier hs-type">Prog</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684536098"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Warnings.html#Warnings"><span class="hs-identifier hs-type">ImpGen.Warnings</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.CodeGen.Backends.GenericC.html#CParts"><span class="hs-identifier hs-type">GC.CParts</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-37"></span><span id="compileProg"><span class="annot"><span class="annottext">compileProg :: forall (m :: * -&gt; *).
MonadFreshNames m =&gt;
Text -&gt; Prog MCMem -&gt; m (Warnings, CParts)
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#compileProg"><span class="hs-identifier hs-var hs-var">compileProg</span></a></span></span><span> </span><span id="local-6989586621684535684"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621684535684"><span class="hs-identifier hs-var">version</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-38"></span><span>  </span><span class="annot"><span class="annottext">(Definitions Multicore -&gt; m CParts)
-&gt; (Warnings, Definitions Multicore) -&gt; m (Warnings, CParts)
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span>
</span><span id="line-39"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Text
-&gt; Text
-&gt; Operations Multicore ()
-&gt; CompilerM Multicore () ()
-&gt; Text
-&gt; [Space]
-&gt; [Option]
-&gt; Definitions Multicore
-&gt; m CParts
forall (m :: * -&gt; *) op.
MonadFreshNames m =&gt;
Text
-&gt; Text
-&gt; Operations op ()
-&gt; CompilerM op () ()
-&gt; Text
-&gt; [Space]
-&gt; [Option]
-&gt; Definitions op
-&gt; m CParts
</span><a href="Futhark.CodeGen.Backends.GenericC.html#compileProg"><span class="hs-identifier hs-var">GC.compileProg</span></a></span><span>
</span><span id="line-40"></span><span>        </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;multicore&quot;</span></span><span>
</span><span id="line-41"></span><span>        </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621684535684"><span class="hs-identifier hs-var">version</span></a></span><span>
</span><span id="line-42"></span><span>        </span><span class="annot"><span class="annottext">Operations Multicore ()
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#operations"><span class="hs-identifier hs-var">operations</span></a></span><span>
</span><span id="line-43"></span><span>        </span><span class="annot"><span class="annottext">CompilerM Multicore () ()
forall op. CompilerM op () ()
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#generateContext"><span class="hs-identifier hs-var">generateContext</span></a></span><span>
</span><span id="line-44"></span><span>        </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;&quot;</span></span><span>
</span><span id="line-45"></span><span>        </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Space
</span><a href="Futhark.IR.Syntax.Core.html#DefaultSpace"><span class="hs-identifier hs-var">DefaultSpace</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-46"></span><span>        </span><span class="annot"><span class="annottext">[Option]
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#cliOptions"><span class="hs-identifier hs-var">cliOptions</span></a></span><span>
</span><span id="line-47"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-48"></span><span>    </span><span class="annot"><span class="annottext">((Warnings, Definitions Multicore) -&gt; m (Warnings, CParts))
-&gt; (Prog MCMem -&gt; m (Warnings, Definitions Multicore))
-&gt; Prog MCMem
-&gt; m (Warnings, CParts)
forall (m :: * -&gt; *) b c a.
Monad m =&gt;
(b -&gt; m c) -&gt; (a -&gt; m b) -&gt; a -&gt; m c
</span><span class="hs-operator hs-var">&lt;=&lt;</span></span><span> </span><span class="annot"><span class="annottext">Prog MCMem -&gt; m (Warnings, Definitions Multicore)
forall (m :: * -&gt; *).
MonadFreshNames m =&gt;
Prog MCMem -&gt; m (Warnings, Definitions Multicore)
</span><a href="Futhark.CodeGen.ImpGen.Multicore.html#compileProg"><span class="hs-identifier hs-var">ImpGen.compileProg</span></a></span><span>
</span><span id="line-49"></span><span>
</span><span id="line-50"></span><span id="local-6989586621684536078"><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#generateContext"><span class="hs-identifier hs-type">generateContext</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.Backends.GenericC.html#CompilerM"><span class="hs-identifier hs-type">GC.CompilerM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684536078"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-51"></span><span id="generateContext"><span class="annot"><span class="annottext">generateContext :: forall op. CompilerM op () ()
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#generateContext"><span class="hs-identifier hs-var hs-var">generateContext</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-52"></span><span>  </span><span class="annot"><span class="annottext">(Definition -&gt; CompilerM op () ())
-&gt; [Definition] -&gt; CompilerM op () ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="annot"><span class="annottext">Definition -&gt; CompilerM op () ()
forall op s. Definition -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#earlyDecl"><span class="hs-identifier hs-var">GC.earlyDecl</span></a></span><span> </span><span class="annot"><span class="">[C.cunit|$esc:(T.unpack schedulerH)|]</span></span><span>
</span><span id="line-53"></span><span>
</span><span id="line-54"></span><span>  </span><span id="local-6989586621684535599"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684535599"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Char]
-&gt; HeaderSection
-&gt; ([Char] -&gt; (Definition, Definition))
-&gt; CompilerM op () [Char]
forall op s.
[Char]
-&gt; HeaderSection
-&gt; ([Char] -&gt; (Definition, Definition))
-&gt; CompilerM op s [Char]
</span><a href="Futhark.CodeGen.Backends.GenericC.html#publicDef"><span class="hs-identifier hs-var">GC.publicDef</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;context_config&quot;</span></span><span> </span><span class="annot"><span class="annottext">HeaderSection
</span><a href="Futhark.CodeGen.Backends.GenericC.html#InitDecl"><span class="hs-identifier hs-var">GC.InitDecl</span></a></span><span> </span><span class="annot"><span class="annottext">(([Char] -&gt; (Definition, Definition)) -&gt; CompilerM op () [Char])
-&gt; ([Char] -&gt; (Definition, Definition)) -&gt; CompilerM op () [Char]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684535596"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684535596"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-55"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="">[C.cedecl|struct $id:s;|]</span></span><span class="hs-special">,</span><span>
</span><span id="line-56"></span><span>      </span><span class="annot"><span class="">[C.cedecl|struct $id:s { int in_use;
                               int debugging;
                               int profiling;
                               int num_threads;
                             };|]</span></span><span>
</span><span id="line-61"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-62"></span><span>
</span><span id="line-63"></span><span>  </span><span class="annot"><span class="annottext">[Char]
-&gt; HeaderSection
-&gt; ([Char] -&gt; (Definition, Definition))
-&gt; CompilerM op () ()
forall op s.
[Char]
-&gt; HeaderSection
-&gt; ([Char] -&gt; (Definition, Definition))
-&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#publicDef_"><span class="hs-identifier hs-var">GC.publicDef_</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;context_config_new&quot;</span></span><span> </span><span class="annot"><span class="annottext">HeaderSection
</span><a href="Futhark.CodeGen.Backends.GenericC.html#InitDecl"><span class="hs-identifier hs-var">GC.InitDecl</span></a></span><span> </span><span class="annot"><span class="annottext">(([Char] -&gt; (Definition, Definition)) -&gt; CompilerM op () ())
-&gt; ([Char] -&gt; (Definition, Definition)) -&gt; CompilerM op () ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684535584"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684535584"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-64"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="">[C.cedecl|struct $id:cfg* $id:s(void);|]</span></span><span class="hs-special">,</span><span>
</span><span id="line-65"></span><span>      </span><span class="annot"><span class="">[C.cedecl|struct $id:cfg* $id:s(void) {
                             struct $id:cfg *cfg = (struct $id:cfg*) malloc(sizeof(struct $id:cfg));
                             if (cfg == NULL) {
                               return NULL;
                             }
                             cfg-&gt;in_use = 0;
                             cfg-&gt;debugging = 0;
                             cfg-&gt;profiling = 0;
                             cfg-&gt;num_threads = 0;
                             return cfg;
                           }|]</span></span><span>
</span><span id="line-76"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-77"></span><span>
</span><span id="line-78"></span><span>  </span><span class="annot"><span class="annottext">[Char]
-&gt; HeaderSection
-&gt; ([Char] -&gt; (Definition, Definition))
-&gt; CompilerM op () ()
forall op s.
[Char]
-&gt; HeaderSection
-&gt; ([Char] -&gt; (Definition, Definition))
-&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#publicDef_"><span class="hs-identifier hs-var">GC.publicDef_</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;context_config_free&quot;</span></span><span> </span><span class="annot"><span class="annottext">HeaderSection
</span><a href="Futhark.CodeGen.Backends.GenericC.html#InitDecl"><span class="hs-identifier hs-var">GC.InitDecl</span></a></span><span> </span><span class="annot"><span class="annottext">(([Char] -&gt; (Definition, Definition)) -&gt; CompilerM op () ())
-&gt; ([Char] -&gt; (Definition, Definition)) -&gt; CompilerM op () ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684535556"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684535556"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-79"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="">[C.cedecl|void $id:s(struct $id:cfg* cfg);|]</span></span><span class="hs-special">,</span><span>
</span><span id="line-80"></span><span>      </span><span class="annot"><span class="">[C.cedecl|void $id:s(struct $id:cfg* cfg) {
                             assert(!cfg-&gt;in_use);
                             free(cfg);
                           }|]</span></span><span>
</span><span id="line-84"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-85"></span><span>
</span><span id="line-86"></span><span>  </span><span class="annot"><span class="annottext">[Char]
-&gt; HeaderSection
-&gt; ([Char] -&gt; (Definition, Definition))
-&gt; CompilerM op () ()
forall op s.
[Char]
-&gt; HeaderSection
-&gt; ([Char] -&gt; (Definition, Definition))
-&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#publicDef_"><span class="hs-identifier hs-var">GC.publicDef_</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;context_config_set_debugging&quot;</span></span><span> </span><span class="annot"><span class="annottext">HeaderSection
</span><a href="Futhark.CodeGen.Backends.GenericC.html#InitDecl"><span class="hs-identifier hs-var">GC.InitDecl</span></a></span><span> </span><span class="annot"><span class="annottext">(([Char] -&gt; (Definition, Definition)) -&gt; CompilerM op () ())
-&gt; ([Char] -&gt; (Definition, Definition)) -&gt; CompilerM op () ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684535553"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684535553"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-87"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="">[C.cedecl|void $id:s(struct $id:cfg* cfg, int flag);|]</span></span><span class="hs-special">,</span><span>
</span><span id="line-88"></span><span>      </span><span class="annot"><span class="">[C.cedecl|void $id:s(struct $id:cfg* cfg, int detail) {
                      cfg-&gt;debugging = detail;
                    }|]</span></span><span>
</span><span id="line-91"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-92"></span><span>
</span><span id="line-93"></span><span>  </span><span class="annot"><span class="annottext">[Char]
-&gt; HeaderSection
-&gt; ([Char] -&gt; (Definition, Definition))
-&gt; CompilerM op () ()
forall op s.
[Char]
-&gt; HeaderSection
-&gt; ([Char] -&gt; (Definition, Definition))
-&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#publicDef_"><span class="hs-identifier hs-var">GC.publicDef_</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;context_config_set_profiling&quot;</span></span><span> </span><span class="annot"><span class="annottext">HeaderSection
</span><a href="Futhark.CodeGen.Backends.GenericC.html#InitDecl"><span class="hs-identifier hs-var">GC.InitDecl</span></a></span><span> </span><span class="annot"><span class="annottext">(([Char] -&gt; (Definition, Definition)) -&gt; CompilerM op () ())
-&gt; ([Char] -&gt; (Definition, Definition)) -&gt; CompilerM op () ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684535552"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684535552"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-94"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="">[C.cedecl|void $id:s(struct $id:cfg* cfg, int flag);|]</span></span><span class="hs-special">,</span><span>
</span><span id="line-95"></span><span>      </span><span class="annot"><span class="">[C.cedecl|void $id:s(struct $id:cfg* cfg, int flag) {
                      cfg-&gt;profiling = flag;
                    }|]</span></span><span>
</span><span id="line-98"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-99"></span><span>
</span><span id="line-100"></span><span>  </span><span class="annot"><span class="annottext">[Char]
-&gt; HeaderSection
-&gt; ([Char] -&gt; (Definition, Definition))
-&gt; CompilerM op () ()
forall op s.
[Char]
-&gt; HeaderSection
-&gt; ([Char] -&gt; (Definition, Definition))
-&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#publicDef_"><span class="hs-identifier hs-var">GC.publicDef_</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;context_config_set_logging&quot;</span></span><span> </span><span class="annot"><span class="annottext">HeaderSection
</span><a href="Futhark.CodeGen.Backends.GenericC.html#InitDecl"><span class="hs-identifier hs-var">GC.InitDecl</span></a></span><span> </span><span class="annot"><span class="annottext">(([Char] -&gt; (Definition, Definition)) -&gt; CompilerM op () ())
-&gt; ([Char] -&gt; (Definition, Definition)) -&gt; CompilerM op () ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684535551"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684535551"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-101"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="">[C.cedecl|void $id:s(struct $id:cfg* cfg, int flag);|]</span></span><span class="hs-special">,</span><span>
</span><span id="line-102"></span><span>      </span><span class="annot"><span class="">[C.cedecl|void $id:s(struct $id:cfg* cfg, int detail) {
                             // Does nothing for this backend.
                             (void)cfg; (void)detail;
                           }|]</span></span><span>
</span><span id="line-106"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-107"></span><span>
</span><span id="line-108"></span><span>  </span><span class="annot"><span class="annottext">[Char]
-&gt; HeaderSection
-&gt; ([Char] -&gt; (Definition, Definition))
-&gt; CompilerM op () ()
forall op s.
[Char]
-&gt; HeaderSection
-&gt; ([Char] -&gt; (Definition, Definition))
-&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#publicDef_"><span class="hs-identifier hs-var">GC.publicDef_</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;context_config_set_num_threads&quot;</span></span><span> </span><span class="annot"><span class="annottext">HeaderSection
</span><a href="Futhark.CodeGen.Backends.GenericC.html#InitDecl"><span class="hs-identifier hs-var">GC.InitDecl</span></a></span><span> </span><span class="annot"><span class="annottext">(([Char] -&gt; (Definition, Definition)) -&gt; CompilerM op () ())
-&gt; ([Char] -&gt; (Definition, Definition)) -&gt; CompilerM op () ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684535549"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684535549"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-109"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="">[C.cedecl|void $id:s(struct $id:cfg *cfg, int n);|]</span></span><span class="hs-special">,</span><span>
</span><span id="line-110"></span><span>      </span><span class="annot"><span class="">[C.cedecl|void $id:s(struct $id:cfg *cfg, int n) {
                             cfg-&gt;num_threads = n;
                           }|]</span></span><span>
</span><span id="line-113"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-114"></span><span>
</span><span id="line-115"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684535548"><span class="annot"><span class="annottext">[FieldGroup]
</span><a href="#local-6989586621684535548"><span class="hs-identifier hs-var">fields</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684535547"><span class="annot"><span class="annottext">[Stm]
</span><a href="#local-6989586621684535547"><span class="hs-identifier hs-var">init_fields</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684535546"><span class="annot"><span class="annottext">[Stm]
</span><a href="#local-6989586621684535546"><span class="hs-identifier hs-var">free_fields</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CompilerM op () ([FieldGroup], [Stm], [Stm])
forall op s. CompilerM op s ([FieldGroup], [Stm], [Stm])
</span><a href="Futhark.CodeGen.Backends.GenericC.html#contextContents"><span class="hs-identifier hs-var">GC.contextContents</span></a></span><span>
</span><span id="line-116"></span><span>
</span><span id="line-117"></span><span>  </span><span id="local-6989586621684535544"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684535544"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Char]
-&gt; HeaderSection
-&gt; ([Char] -&gt; (Definition, Definition))
-&gt; CompilerM op () [Char]
forall op s.
[Char]
-&gt; HeaderSection
-&gt; ([Char] -&gt; (Definition, Definition))
-&gt; CompilerM op s [Char]
</span><a href="Futhark.CodeGen.Backends.GenericC.html#publicDef"><span class="hs-identifier hs-var">GC.publicDef</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;context&quot;</span></span><span> </span><span class="annot"><span class="annottext">HeaderSection
</span><a href="Futhark.CodeGen.Backends.GenericC.html#InitDecl"><span class="hs-identifier hs-var">GC.InitDecl</span></a></span><span> </span><span class="annot"><span class="annottext">(([Char] -&gt; (Definition, Definition)) -&gt; CompilerM op () [Char])
-&gt; ([Char] -&gt; (Definition, Definition)) -&gt; CompilerM op () [Char]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684535543"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684535543"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-118"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="">[C.cedecl|struct $id:s;|]</span></span><span class="hs-special">,</span><span>
</span><span id="line-119"></span><span>      </span><span class="annot"><span class="">[C.cedecl|struct $id:s {
                      struct $id:cfg* cfg;
                      struct scheduler scheduler;
                      int detail_memory;
                      int debugging;
                      int profiling;
                      int profiling_paused;
                      int logging;
                      typename lock_t lock;
                      char *error;
                      typename FILE *log;
                      int total_runs;
                      long int total_runtime;
                      $sdecls:fields

                      // Tuning parameters
                      typename int64_t tuning_timing;
                      typename int64_t tuning_iter;
                    };|]</span></span><span>
</span><span id="line-138"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-139"></span><span>
</span><span id="line-140"></span><span>  </span><span class="annot"><span class="annottext">[Char]
-&gt; HeaderSection
-&gt; ([Char] -&gt; (Definition, Definition))
-&gt; CompilerM op () ()
forall op s.
[Char]
-&gt; HeaderSection
-&gt; ([Char] -&gt; (Definition, Definition))
-&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#publicDef_"><span class="hs-identifier hs-var">GC.publicDef_</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;context_new&quot;</span></span><span> </span><span class="annot"><span class="annottext">HeaderSection
</span><a href="Futhark.CodeGen.Backends.GenericC.html#InitDecl"><span class="hs-identifier hs-var">GC.InitDecl</span></a></span><span> </span><span class="annot"><span class="annottext">(([Char] -&gt; (Definition, Definition)) -&gt; CompilerM op () ())
-&gt; ([Char] -&gt; (Definition, Definition)) -&gt; CompilerM op () ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684535539"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684535539"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-141"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="">[C.cedecl|struct $id:ctx* $id:s(struct $id:cfg* cfg);|]</span></span><span class="hs-special">,</span><span>
</span><span id="line-142"></span><span>      </span><span class="annot"><span class="">[C.cedecl|struct $id:ctx* $id:s(struct $id:cfg* cfg) {
             assert(!cfg-&gt;in_use);
             struct $id:ctx* ctx = (struct $id:ctx*) malloc(sizeof(struct $id:ctx));
             if (ctx == NULL) {
               return NULL;
             }
             ctx-&gt;cfg = cfg;
             ctx-&gt;cfg-&gt;in_use = 1;

             // Initialize rand()
             fast_srand(time(0));
             ctx-&gt;detail_memory = cfg-&gt;debugging;
             ctx-&gt;debugging = cfg-&gt;debugging;
             ctx-&gt;profiling = cfg-&gt;profiling;
             ctx-&gt;profiling_paused = 0;
             ctx-&gt;logging = 0;
             ctx-&gt;error = NULL;
             ctx-&gt;log = stderr;
             create_lock(&amp;ctx-&gt;lock);

             int tune_kappa = 0;
             double kappa = 5.1f * 1000;

             if (tune_kappa) {
               if (determine_kappa(&amp;kappa) != 0) {
                 return NULL;
               }
             }

             if (scheduler_init(&amp;ctx-&gt;scheduler,
                                cfg-&gt;num_threads &gt; 0 ?
                                cfg-&gt;num_threads : num_processors(),
                                kappa) != 0) {
               return NULL;
             }

             $stms:init_fields

             init_constants(ctx);

             return ctx;
          }|]</span></span><span>
</span><span id="line-184"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-185"></span><span>
</span><span id="line-186"></span><span>  </span><span class="annot"><span class="annottext">[Char]
-&gt; HeaderSection
-&gt; ([Char] -&gt; (Definition, Definition))
-&gt; CompilerM op () ()
forall op s.
[Char]
-&gt; HeaderSection
-&gt; ([Char] -&gt; (Definition, Definition))
-&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#publicDef_"><span class="hs-identifier hs-var">GC.publicDef_</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;context_free&quot;</span></span><span> </span><span class="annot"><span class="annottext">HeaderSection
</span><a href="Futhark.CodeGen.Backends.GenericC.html#InitDecl"><span class="hs-identifier hs-var">GC.InitDecl</span></a></span><span> </span><span class="annot"><span class="annottext">(([Char] -&gt; (Definition, Definition)) -&gt; CompilerM op () ())
-&gt; ([Char] -&gt; (Definition, Definition)) -&gt; CompilerM op () ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684535531"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684535531"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-187"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="">[C.cedecl|void $id:s(struct $id:ctx* ctx);|]</span></span><span class="hs-special">,</span><span>
</span><span id="line-188"></span><span>      </span><span class="annot"><span class="">[C.cedecl|void $id:s(struct $id:ctx* ctx) {
             $stms:free_fields
             free_constants(ctx);
             (void)scheduler_destroy(&amp;ctx-&gt;scheduler);
             free_lock(&amp;ctx-&gt;lock);
             ctx-&gt;cfg-&gt;in_use = 0;
             free(ctx);
           }|]</span></span><span>
</span><span id="line-196"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-197"></span><span>
</span><span id="line-198"></span><span>  </span><span class="annot"><span class="annottext">[Char]
-&gt; HeaderSection
-&gt; ([Char] -&gt; (Definition, Definition))
-&gt; CompilerM op () ()
forall op s.
[Char]
-&gt; HeaderSection
-&gt; ([Char] -&gt; (Definition, Definition))
-&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#publicDef_"><span class="hs-identifier hs-var">GC.publicDef_</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;context_sync&quot;</span></span><span> </span><span class="annot"><span class="annottext">HeaderSection
</span><a href="Futhark.CodeGen.Backends.GenericC.html#InitDecl"><span class="hs-identifier hs-var">GC.InitDecl</span></a></span><span> </span><span class="annot"><span class="annottext">(([Char] -&gt; (Definition, Definition)) -&gt; CompilerM op () ())
-&gt; ([Char] -&gt; (Definition, Definition)) -&gt; CompilerM op () ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684535530"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684535530"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-199"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="">[C.cedecl|int $id:s(struct $id:ctx* ctx);|]</span></span><span class="hs-special">,</span><span>
</span><span id="line-200"></span><span>      </span><span class="annot"><span class="">[C.cedecl|int $id:s(struct $id:ctx* ctx) {
                             (void)ctx;
                             return 0;
                           }|]</span></span><span>
</span><span id="line-204"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-205"></span><span>
</span><span id="line-206"></span><span>  </span><span class="annot"><span class="annottext">Definition -&gt; CompilerM op () ()
forall op s. Definition -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#earlyDecl"><span class="hs-identifier hs-var">GC.earlyDecl</span></a></span><span> </span><span class="annot"><span class="">[C.cedecl|static const char *tuning_param_names[0];|]</span></span><span>
</span><span id="line-207"></span><span>  </span><span class="annot"><span class="annottext">Definition -&gt; CompilerM op () ()
forall op s. Definition -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#earlyDecl"><span class="hs-identifier hs-var">GC.earlyDecl</span></a></span><span> </span><span class="annot"><span class="">[C.cedecl|static const char *tuning_param_vars[0];|]</span></span><span>
</span><span id="line-208"></span><span>  </span><span class="annot"><span class="annottext">Definition -&gt; CompilerM op () ()
forall op s. Definition -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#earlyDecl"><span class="hs-identifier hs-var">GC.earlyDecl</span></a></span><span> </span><span class="annot"><span class="">[C.cedecl|static const char *tuning_param_classes[0];|]</span></span><span>
</span><span id="line-209"></span><span>
</span><span id="line-210"></span><span>  </span><span class="annot"><span class="annottext">[Char]
-&gt; HeaderSection
-&gt; ([Char] -&gt; (Definition, Definition))
-&gt; CompilerM op () ()
forall op s.
[Char]
-&gt; HeaderSection
-&gt; ([Char] -&gt; (Definition, Definition))
-&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#publicDef_"><span class="hs-identifier hs-var">GC.publicDef_</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;context_config_set_tuning_param&quot;</span></span><span> </span><span class="annot"><span class="annottext">HeaderSection
</span><a href="Futhark.CodeGen.Backends.GenericC.html#InitDecl"><span class="hs-identifier hs-var">GC.InitDecl</span></a></span><span> </span><span class="annot"><span class="annottext">(([Char] -&gt; (Definition, Definition)) -&gt; CompilerM op () ())
-&gt; ([Char] -&gt; (Definition, Definition)) -&gt; CompilerM op () ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684535525"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684535525"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-211"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="">[C.cedecl|int $id:s(struct $id:cfg* cfg, const char *param_name, size_t param_value);|]</span></span><span class="hs-special">,</span><span>
</span><span id="line-212"></span><span>      </span><span class="annot"><span class="">[C.cedecl|int $id:s(struct $id:cfg* cfg, const char *param_name, size_t param_value) {
                     (void)cfg; (void)param_name; (void)param_value;
                     return 1;
                   }|]</span></span><span>
</span><span id="line-216"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-217"></span><span>
</span><span id="line-218"></span><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#cliOptions"><span class="hs-identifier hs-type">cliOptions</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.CodeGen.Backends.GenericC.Options.html#Option"><span class="hs-identifier hs-type">Option</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-219"></span><span id="cliOptions"><span class="annot"><span class="annottext">cliOptions :: [Option]
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#cliOptions"><span class="hs-identifier hs-var hs-var">cliOptions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-220"></span><span>  </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Option :: [Char] -&gt; Maybe Char -&gt; OptionArgument -&gt; [Char] -&gt; Stm -&gt; Option
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#Option"><span class="hs-identifier hs-type">Option</span></a></span><span>
</span><span id="line-221"></span><span>      </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">optionLongName :: [Char]
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#optionLongName"><span class="hs-identifier hs-var">optionLongName</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;profile&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-222"></span><span>        </span><span class="annot"><span class="annottext">optionShortName :: Maybe Char
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#optionShortName"><span class="hs-identifier hs-var">optionShortName</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Char -&gt; Maybe Char
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'P'</span></span><span class="hs-special">,</span><span>
</span><span id="line-223"></span><span>        </span><span class="annot"><span class="annottext">optionArgument :: OptionArgument
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#optionArgument"><span class="hs-identifier hs-var">optionArgument</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OptionArgument
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#NoArgument"><span class="hs-identifier hs-var">NoArgument</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-224"></span><span>        </span><span class="annot"><span class="annottext">optionAction :: Stm
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#optionAction"><span class="hs-identifier hs-var">optionAction</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="">[C.cstm|futhark_context_config_set_profiling(cfg, 1);|]</span></span><span class="hs-special">,</span><span>
</span><span id="line-225"></span><span>        </span><span class="annot"><span class="annottext">optionDescription :: [Char]
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#optionDescription"><span class="hs-identifier hs-var">optionDescription</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Gather profiling information.&quot;</span></span><span>
</span><span id="line-226"></span><span>      </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><span id="line-227"></span><span>    </span><span class="annot"><span class="annottext">Option :: [Char] -&gt; Maybe Char -&gt; OptionArgument -&gt; [Char] -&gt; Stm -&gt; Option
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#Option"><span class="hs-identifier hs-type">Option</span></a></span><span>
</span><span id="line-228"></span><span>      </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">optionLongName :: [Char]
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#optionLongName"><span class="hs-identifier hs-var">optionLongName</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;num-threads&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-229"></span><span>        </span><span class="annot"><span class="annottext">optionShortName :: Maybe Char
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#optionShortName"><span class="hs-identifier hs-var">optionShortName</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Char
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span>
</span><span id="line-230"></span><span>        </span><span class="annot"><span class="annottext">optionArgument :: OptionArgument
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#optionArgument"><span class="hs-identifier hs-var">optionArgument</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; OptionArgument
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#RequiredArgument"><span class="hs-identifier hs-var">RequiredArgument</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;INT&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-231"></span><span>        </span><span class="annot"><span class="annottext">optionAction :: Stm
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#optionAction"><span class="hs-identifier hs-var">optionAction</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="">[C.cstm|futhark_context_config_set_num_threads(cfg, atoi(optarg));|]</span></span><span class="hs-special">,</span><span>
</span><span id="line-232"></span><span>        </span><span class="annot"><span class="annottext">optionDescription :: [Char]
</span><a href="Futhark.CodeGen.Backends.GenericC.Options.html#optionDescription"><span class="hs-identifier hs-var">optionDescription</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Set number of threads used for execution.&quot;</span></span><span>
</span><span id="line-233"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-234"></span><span>  </span><span class="hs-special">]</span><span>
</span><span id="line-235"></span><span>
</span><span id="line-236"></span><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#operations"><span class="hs-identifier hs-type">operations</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.Backends.GenericC.html#Operations"><span class="hs-identifier hs-type">GC.Operations</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.Multicore.html#Multicore"><span class="hs-identifier hs-type">Multicore</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-237"></span><span id="operations"><span class="annot"><span class="annottext">operations :: Operations Multicore ()
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#operations"><span class="hs-identifier hs-var hs-var">operations</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-238"></span><span>  </span><span class="annot"><span class="annottext">Operations Multicore ()
forall op s. Operations op s
</span><a href="Futhark.CodeGen.Backends.GenericC.html#defaultOperations"><span class="hs-identifier hs-var">GC.defaultOperations</span></a></span><span>
</span><span id="line-239"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">opsCompiler :: OpCompiler Multicore ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#opsCompiler"><span class="hs-identifier hs-var">GC.opsCompiler</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OpCompiler Multicore ()
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#compileOp"><span class="hs-identifier hs-var">compileOp</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-240"></span><span>      </span><span class="annot"><span class="annottext">opsCritical :: ([BlockItem], [BlockItem])
</span><a href="Futhark.CodeGen.Backends.GenericC.html#opsCritical"><span class="hs-identifier hs-var">GC.opsCritical</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-241"></span><span>        </span><span class="hs-comment">-- The thread entering an API function is always considered</span><span>
</span><span id="line-242"></span><span>        </span><span class="hs-comment">-- the &quot;first worker&quot; - note that this might differ from the</span><span>
</span><span id="line-243"></span><span>        </span><span class="hs-comment">-- thread that created the context!  This likely only matters</span><span>
</span><span id="line-244"></span><span>        </span><span class="hs-comment">-- for entry points, since they are the only API functions</span><span>
</span><span id="line-245"></span><span>        </span><span class="hs-comment">-- that contain parallel operations.</span><span>
</span><span id="line-246"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="">[C.citems|worker_local = &amp;ctx-&gt;scheduler.workers[0];|]</span></span><span class="hs-special">,</span><span>
</span><span id="line-247"></span><span>          </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-248"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-249"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-250"></span><span>
</span><span id="line-251"></span><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#closureFreeStructField"><span class="hs-identifier hs-type">closureFreeStructField</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span>
</span><span id="line-252"></span><span id="closureFreeStructField"><span class="annot"><span class="annottext">closureFreeStructField :: VName -&gt; Name
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#closureFreeStructField"><span class="hs-identifier hs-var hs-var">closureFreeStructField</span></a></span></span><span> </span><span id="local-6989586621684535509"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684535509"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-253"></span><span>  </span><span class="annot"><span class="annottext">[Char] -&gt; Name
</span><a href="Language.Futhark.Core.html#nameFromString"><span class="hs-identifier hs-var">nameFromString</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;free_&quot;</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Name -&gt; Name
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Name
</span><a href="Language.Futhark.Core.html#nameFromString"><span class="hs-identifier hs-var">nameFromString</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; [Char]
forall a. Pretty a =&gt; a -&gt; [Char]
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684535509"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-254"></span><span>
</span><span id="line-255"></span><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#closureRetvalStructField"><span class="hs-identifier hs-type">closureRetvalStructField</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span>
</span><span id="line-256"></span><span id="closureRetvalStructField"><span class="annot"><span class="annottext">closureRetvalStructField :: VName -&gt; Name
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#closureRetvalStructField"><span class="hs-identifier hs-var hs-var">closureRetvalStructField</span></a></span></span><span> </span><span id="local-6989586621684535505"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684535505"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-257"></span><span>  </span><span class="annot"><span class="annottext">[Char] -&gt; Name
</span><a href="Language.Futhark.Core.html#nameFromString"><span class="hs-identifier hs-var">nameFromString</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;retval_&quot;</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Name -&gt; Name
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Name
</span><a href="Language.Futhark.Core.html#nameFromString"><span class="hs-identifier hs-var">nameFromString</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; [Char]
forall a. Pretty a =&gt; a -&gt; [Char]
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684535505"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-258"></span><span>
</span><span id="line-259"></span><span class="hs-keyword">data</span><span> </span><span id="ValueType"><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#ValueType"><span class="hs-identifier hs-var">ValueType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Prim"><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="MemBlock"><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#MemBlock"><span class="hs-identifier hs-var">MemBlock</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="RawMem"><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#RawMem"><span class="hs-identifier hs-var">RawMem</span></a></span></span><span>
</span><span id="line-260"></span><span>
</span><span id="line-261"></span><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#compileFreeStructFields"><span class="hs-identifier hs-type">compileFreeStructFields</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Type</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#ValueType"><span class="hs-identifier hs-type">ValueType</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">C.FieldGroup</span></span><span class="hs-special">]</span><span>
</span><span id="line-262"></span><span id="compileFreeStructFields"><span class="annot"><span class="annottext">compileFreeStructFields :: [VName] -&gt; [(Type, ValueType)] -&gt; [FieldGroup]
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#compileFreeStructFields"><span class="hs-identifier hs-var hs-var">compileFreeStructFields</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; (Type, ValueType) -&gt; FieldGroup)
-&gt; [VName] -&gt; [(Type, ValueType)] -&gt; [FieldGroup]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; (Type, ValueType) -&gt; FieldGroup
</span><a href="#local-6989586621684535499"><span class="hs-identifier hs-var">field</span></a></span><span>
</span><span id="line-263"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-264"></span><span>    </span><span id="local-6989586621684535499"><span class="annot"><span class="annottext">field :: VName -&gt; (Type, ValueType) -&gt; FieldGroup
</span><a href="#local-6989586621684535499"><span class="hs-identifier hs-var hs-var">field</span></a></span></span><span> </span><span id="local-6989586621684535496"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684535496"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684535495"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684535495"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ValueType
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-265"></span><span>      </span><span class="annot"><span class="">[C.csdecl|$ty:ty $id:(closureFreeStructField name);|]</span></span><span>
</span><span id="line-266"></span><span>    </span><span class="annot"><a href="#local-6989586621684535499"><span class="hs-identifier hs-var">field</span></a></span><span> </span><span id="local-6989586621684535489"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684535489"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ValueType
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-267"></span><span>      </span><span class="annot"><span class="">[C.csdecl|$ty:defaultMemBlockType $id:(closureFreeStructField name);|]</span></span><span>
</span><span id="line-268"></span><span>
</span><span id="line-269"></span><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#compileRetvalStructFields"><span class="hs-identifier hs-type">compileRetvalStructFields</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Type</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#ValueType"><span class="hs-identifier hs-type">ValueType</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">C.FieldGroup</span></span><span class="hs-special">]</span><span>
</span><span id="line-270"></span><span id="compileRetvalStructFields"><span class="annot"><span class="annottext">compileRetvalStructFields :: [VName] -&gt; [(Type, ValueType)] -&gt; [FieldGroup]
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#compileRetvalStructFields"><span class="hs-identifier hs-var hs-var">compileRetvalStructFields</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; (Type, ValueType) -&gt; FieldGroup)
-&gt; [VName] -&gt; [(Type, ValueType)] -&gt; [FieldGroup]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; (Type, ValueType) -&gt; FieldGroup
</span><a href="#local-6989586621684535481"><span class="hs-identifier hs-var">field</span></a></span><span>
</span><span id="line-271"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-272"></span><span>    </span><span id="local-6989586621684535481"><span class="annot"><span class="annottext">field :: VName -&gt; (Type, ValueType) -&gt; FieldGroup
</span><a href="#local-6989586621684535481"><span class="hs-identifier hs-var hs-var">field</span></a></span></span><span> </span><span id="local-6989586621684535478"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684535478"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684535477"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684535477"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ValueType
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-273"></span><span>      </span><span class="annot"><span class="">[C.csdecl|$ty:ty *$id:(closureRetvalStructField name);|]</span></span><span>
</span><span id="line-274"></span><span>    </span><span class="annot"><a href="#local-6989586621684535481"><span class="hs-identifier hs-var">field</span></a></span><span> </span><span id="local-6989586621684535471"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684535471"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ValueType
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-275"></span><span>      </span><span class="annot"><span class="">[C.csdecl|$ty:defaultMemBlockType $id:(closureRetvalStructField name);|]</span></span><span>
</span><span id="line-276"></span><span>
</span><span id="line-277"></span><span id="local-6989586621684536014"><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#compileSetStructValues"><span class="hs-identifier hs-type">compileSetStructValues</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-278"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">C.ToIdent</span></span><span> </span><span class="annot"><a href="#local-6989586621684536014"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-279"></span><span>  </span><span class="annot"><a href="#local-6989586621684536014"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-280"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-281"></span><span>  </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Type</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#ValueType"><span class="hs-identifier hs-type">ValueType</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-282"></span><span>  </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">C.Stm</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-283"></span><span id="compileSetStructValues"><span class="annot"><span class="annottext">compileSetStructValues :: forall a. ToIdent a =&gt; a -&gt; [VName] -&gt; [(Type, ValueType)] -&gt; [Stm]
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#compileSetStructValues"><span class="hs-identifier hs-var hs-var">compileSetStructValues</span></a></span></span><span> </span><span id="local-6989586621684535463"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684535463"><span class="hs-identifier hs-var">struct</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; (Type, ValueType) -&gt; Stm)
-&gt; [VName] -&gt; [(Type, ValueType)] -&gt; [Stm]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; (Type, ValueType) -&gt; Stm
forall {a}. VName -&gt; (a, ValueType) -&gt; Stm
</span><a href="#local-6989586621684535462"><span class="hs-identifier hs-var">field</span></a></span><span>
</span><span id="line-284"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-285"></span><span>    </span><span id="local-6989586621684535462"><span class="annot"><span class="annottext">field :: VName -&gt; (a, ValueType) -&gt; Stm
</span><a href="#local-6989586621684535462"><span class="hs-identifier hs-var hs-var">field</span></a></span></span><span> </span><span id="local-6989586621684535452"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684535452"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ValueType
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-286"></span><span>      </span><span class="annot"><span class="">[C.cstm|$id:struct.$id:(closureFreeStructField name)=$id:name;|]</span></span><span>
</span><span id="line-287"></span><span>    </span><span class="annot"><a href="#local-6989586621684535462"><span class="hs-identifier hs-var">field</span></a></span><span> </span><span id="local-6989586621684535451"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684535451"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ValueType
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#MemBlock"><span class="hs-identifier hs-var">MemBlock</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-288"></span><span>      </span><span class="annot"><span class="">[C.cstm|$id:struct.$id:(closureFreeStructField name)=$id:name.mem;|]</span></span><span>
</span><span id="line-289"></span><span>    </span><span class="annot"><a href="#local-6989586621684535462"><span class="hs-identifier hs-var">field</span></a></span><span> </span><span id="local-6989586621684535450"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684535450"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ValueType
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#RawMem"><span class="hs-identifier hs-var">RawMem</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-290"></span><span>      </span><span class="annot"><span class="">[C.cstm|$id:struct.$id:(closureFreeStructField name)=$id:name;|]</span></span><span>
</span><span id="line-291"></span><span>
</span><span id="line-292"></span><span id="local-6989586621684535449"><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#compileSetRetvalStructValues"><span class="hs-identifier hs-type">compileSetRetvalStructValues</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-293"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">C.ToIdent</span></span><span> </span><span class="annot"><a href="#local-6989586621684535449"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-294"></span><span>  </span><span class="annot"><a href="#local-6989586621684535449"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-295"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-296"></span><span>  </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Type</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#ValueType"><span class="hs-identifier hs-type">ValueType</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-297"></span><span>  </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">C.Stm</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-298"></span><span id="compileSetRetvalStructValues"><span class="annot"><span class="annottext">compileSetRetvalStructValues :: forall a. ToIdent a =&gt; a -&gt; [VName] -&gt; [(Type, ValueType)] -&gt; [Stm]
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#compileSetRetvalStructValues"><span class="hs-identifier hs-var hs-var">compileSetRetvalStructValues</span></a></span></span><span> </span><span id="local-6989586621684535446"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684535446"><span class="hs-identifier hs-var">struct</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; (Type, ValueType) -&gt; Stm)
-&gt; [VName] -&gt; [(Type, ValueType)] -&gt; [Stm]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; (Type, ValueType) -&gt; Stm
forall {a}. VName -&gt; (a, ValueType) -&gt; Stm
</span><a href="#local-6989586621684535445"><span class="hs-identifier hs-var">field</span></a></span><span>
</span><span id="line-299"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-300"></span><span>    </span><span id="local-6989586621684535445"><span class="annot"><span class="annottext">field :: VName -&gt; (a, ValueType) -&gt; Stm
</span><a href="#local-6989586621684535445"><span class="hs-identifier hs-var hs-var">field</span></a></span></span><span> </span><span id="local-6989586621684535435"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684535435"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ValueType
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-301"></span><span>      </span><span class="annot"><span class="">[C.cstm|$id:struct.$id:(closureRetvalStructField name)=&amp;$id:name;|]</span></span><span>
</span><span id="line-302"></span><span>    </span><span class="annot"><a href="#local-6989586621684535445"><span class="hs-identifier hs-var">field</span></a></span><span> </span><span id="local-6989586621684535434"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684535434"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ValueType
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#MemBlock"><span class="hs-identifier hs-var">MemBlock</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-303"></span><span>      </span><span class="annot"><span class="">[C.cstm|$id:struct.$id:(closureRetvalStructField name)=$id:name.mem;|]</span></span><span>
</span><span id="line-304"></span><span>    </span><span class="annot"><a href="#local-6989586621684535445"><span class="hs-identifier hs-var">field</span></a></span><span> </span><span id="local-6989586621684535433"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684535433"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ValueType
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#RawMem"><span class="hs-identifier hs-var">RawMem</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-305"></span><span>      </span><span class="annot"><span class="">[C.cstm|$id:struct.$id:(closureRetvalStructField name)=$id:name;|]</span></span><span>
</span><span id="line-306"></span><span>
</span><span id="line-307"></span><span id="local-6989586621684536009"><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#compileGetRetvalStructVals"><span class="hs-identifier hs-type">compileGetRetvalStructVals</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.ToIdent</span></span><span> </span><span class="annot"><a href="#local-6989586621684536009"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684536009"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Type</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#ValueType"><span class="hs-identifier hs-type">ValueType</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">C.InitGroup</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-308"></span><span id="compileGetRetvalStructVals"><span class="annot"><span class="annottext">compileGetRetvalStructVals :: forall a.
ToIdent a =&gt;
a -&gt; [VName] -&gt; [(Type, ValueType)] -&gt; [InitGroup]
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#compileGetRetvalStructVals"><span class="hs-identifier hs-var hs-var">compileGetRetvalStructVals</span></a></span></span><span> </span><span id="local-6989586621684535430"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684535430"><span class="hs-identifier hs-var">struct</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; (Type, ValueType) -&gt; InitGroup)
-&gt; [VName] -&gt; [(Type, ValueType)] -&gt; [InitGroup]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; (Type, ValueType) -&gt; InitGroup
</span><a href="#local-6989586621684535429"><span class="hs-identifier hs-var">field</span></a></span><span>
</span><span id="line-309"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-310"></span><span>    </span><span id="local-6989586621684535429"><span class="annot"><span class="annottext">field :: VName -&gt; (Type, ValueType) -&gt; InitGroup
</span><a href="#local-6989586621684535429"><span class="hs-identifier hs-var hs-var">field</span></a></span></span><span> </span><span id="local-6989586621684535418"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684535418"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684535417"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684535417"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ValueType
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-311"></span><span>      </span><span class="annot"><span class="">[C.cdecl|$ty:ty $id:name = *$id:struct-&gt;$id:(closureRetvalStructField name);|]</span></span><span>
</span><span id="line-312"></span><span>    </span><span class="annot"><a href="#local-6989586621684535429"><span class="hs-identifier hs-var">field</span></a></span><span> </span><span id="local-6989586621684535410"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684535410"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684535409"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684535409"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ValueType
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-313"></span><span>      </span><span class="annot"><span class="">[C.cdecl|$ty:ty $id:name =
                 {.desc = $string:(pretty name),
                 .mem = $id:struct-&gt;$id:(closureRetvalStructField name),
                 .size = 0, .references = NULL};|]</span></span><span>
</span><span id="line-317"></span><span>
</span><span id="line-318"></span><span id="local-6989586621684535398"><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#compileGetStructVals"><span class="hs-identifier hs-type">compileGetStructVals</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-319"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">C.ToIdent</span></span><span> </span><span class="annot"><a href="#local-6989586621684535398"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-320"></span><span>  </span><span class="annot"><a href="#local-6989586621684535398"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-321"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-322"></span><span>  </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Type</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#ValueType"><span class="hs-identifier hs-type">ValueType</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-323"></span><span>  </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">C.InitGroup</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-324"></span><span id="compileGetStructVals"><span class="annot"><span class="annottext">compileGetStructVals :: forall a.
ToIdent a =&gt;
a -&gt; [VName] -&gt; [(Type, ValueType)] -&gt; [InitGroup]
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#compileGetStructVals"><span class="hs-identifier hs-var hs-var">compileGetStructVals</span></a></span></span><span> </span><span id="local-6989586621684535395"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684535395"><span class="hs-identifier hs-var">struct</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; (Type, ValueType) -&gt; InitGroup)
-&gt; [VName] -&gt; [(Type, ValueType)] -&gt; [InitGroup]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; (Type, ValueType) -&gt; InitGroup
</span><a href="#local-6989586621684535394"><span class="hs-identifier hs-var">field</span></a></span><span>
</span><span id="line-325"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-326"></span><span>    </span><span id="local-6989586621684535394"><span class="annot"><span class="annottext">field :: VName -&gt; (Type, ValueType) -&gt; InitGroup
</span><a href="#local-6989586621684535394"><span class="hs-identifier hs-var hs-var">field</span></a></span></span><span> </span><span id="local-6989586621684535383"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684535383"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684535382"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684535382"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ValueType
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-327"></span><span>      </span><span class="annot"><span class="">[C.cdecl|$ty:ty $id:name = $id:struct-&gt;$id:(closureFreeStructField name);|]</span></span><span>
</span><span id="line-328"></span><span>    </span><span class="annot"><a href="#local-6989586621684535394"><span class="hs-identifier hs-var">field</span></a></span><span> </span><span id="local-6989586621684535376"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684535376"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684535375"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684535375"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ValueType
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-329"></span><span>      </span><span class="annot"><span class="">[C.cdecl|$ty:ty $id:name =
                 {.desc = $string:(pretty name),
                  .mem = $id:struct-&gt;$id:(closureFreeStructField name),
                  .size = 0, .references = NULL};|]</span></span><span>
</span><span id="line-333"></span><span>
</span><span id="line-334"></span><span id="local-6989586621684535369"><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#compileWriteBackResVals"><span class="hs-identifier hs-type">compileWriteBackResVals</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.ToIdent</span></span><span> </span><span class="annot"><a href="#local-6989586621684535369"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684535369"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Type</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#ValueType"><span class="hs-identifier hs-type">ValueType</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">C.Stm</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-335"></span><span id="compileWriteBackResVals"><span class="annot"><span class="annottext">compileWriteBackResVals :: forall a. ToIdent a =&gt; a -&gt; [VName] -&gt; [(Type, ValueType)] -&gt; [Stm]
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#compileWriteBackResVals"><span class="hs-identifier hs-var hs-var">compileWriteBackResVals</span></a></span></span><span> </span><span id="local-6989586621684535366"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684535366"><span class="hs-identifier hs-var">struct</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; (Type, ValueType) -&gt; Stm)
-&gt; [VName] -&gt; [(Type, ValueType)] -&gt; [Stm]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; (Type, ValueType) -&gt; Stm
forall {a}. VName -&gt; (a, ValueType) -&gt; Stm
</span><a href="#local-6989586621684535365"><span class="hs-identifier hs-var">field</span></a></span><span>
</span><span id="line-336"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-337"></span><span>    </span><span id="local-6989586621684535365"><span class="annot"><span class="annottext">field :: VName -&gt; (a, ValueType) -&gt; Stm
</span><a href="#local-6989586621684535365"><span class="hs-identifier hs-var hs-var">field</span></a></span></span><span> </span><span id="local-6989586621684535358"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684535358"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ValueType
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-338"></span><span>      </span><span class="annot"><span class="">[C.cstm|*$id:struct-&gt;$id:(closureRetvalStructField name) = $id:name;|]</span></span><span>
</span><span id="line-339"></span><span>    </span><span class="annot"><a href="#local-6989586621684535365"><span class="hs-identifier hs-var">field</span></a></span><span> </span><span id="local-6989586621684535357"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684535357"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ValueType
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-340"></span><span>      </span><span class="annot"><span class="">[C.cstm|$id:struct-&gt;$id:(closureRetvalStructField name) = $id:name.mem;|]</span></span><span>
</span><span id="line-341"></span><span>
</span><span id="line-342"></span><span id="local-6989586621684535998"><span id="local-6989586621684535999"><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#paramToCType"><span class="hs-identifier hs-type">paramToCType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#Param"><span class="hs-identifier hs-type">Param</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.Backends.GenericC.html#CompilerM"><span class="hs-identifier hs-type">GC.CompilerM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684535999"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684535998"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Type</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#ValueType"><span class="hs-identifier hs-type">ValueType</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-343"></span><span id="paramToCType"><span class="annot"><span class="annottext">paramToCType :: forall op s. Param -&gt; CompilerM op s (Type, ValueType)
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#paramToCType"><span class="hs-identifier hs-var hs-var">paramToCType</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#ScalarParam"><span class="hs-identifier hs-type">ScalarParam</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684535353"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684535353"><span class="hs-identifier hs-var">pt</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-344"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684535352"><span class="annot"><span class="annottext">t :: Type
</span><a href="#local-6989586621684535352"><span class="hs-identifier hs-var hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; Type
</span><a href="Futhark.CodeGen.Backends.SimpleRep.html#primTypeToCType"><span class="hs-identifier hs-var">GC.primTypeToCType</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684535353"><span class="hs-identifier hs-var">pt</span></a></span><span>
</span><span id="line-345"></span><span>  </span><span class="annot"><span class="annottext">(Type, ValueType) -&gt; CompilerM op s (Type, ValueType)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684535352"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ValueType
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-346"></span><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#paramToCType"><span class="hs-identifier hs-var">paramToCType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#MemParam"><span class="hs-identifier hs-type">MemParam</span></a></span><span> </span><span id="local-6989586621684535349"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684535349"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621684535348"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684535348"><span class="hs-identifier hs-var">space'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Space -&gt; CompilerM op s (Type, ValueType)
forall op s. VName -&gt; Space -&gt; CompilerM op s (Type, ValueType)
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#mcMemToCType"><span class="hs-identifier hs-var">mcMemToCType</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684535349"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684535348"><span class="hs-identifier hs-var">space'</span></a></span><span>
</span><span id="line-347"></span><span>
</span><span id="line-348"></span><span id="local-6989586621684535991"><span id="local-6989586621684535992"><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#mcMemToCType"><span class="hs-identifier hs-type">mcMemToCType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.Backends.GenericC.html#CompilerM"><span class="hs-identifier hs-type">GC.CompilerM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684535992"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684535991"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Type</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#ValueType"><span class="hs-identifier hs-type">ValueType</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-349"></span><span id="mcMemToCType"><span class="annot"><span class="annottext">mcMemToCType :: forall op s. VName -&gt; Space -&gt; CompilerM op s (Type, ValueType)
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#mcMemToCType"><span class="hs-identifier hs-var hs-var">mcMemToCType</span></a></span></span><span> </span><span id="local-6989586621684535339"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684535339"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621684535338"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684535338"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-350"></span><span>  </span><span id="local-6989586621684535337"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684535337"><span class="hs-identifier hs-var">refcount</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Space -&gt; CompilerM op s Bool
forall op s. Space -&gt; CompilerM op s Bool
</span><a href="Futhark.CodeGen.Backends.GenericC.html#fatMemory"><span class="hs-identifier hs-var">GC.fatMemory</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684535338"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-351"></span><span>  </span><span id="local-6989586621684535335"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684535335"><span class="hs-identifier hs-var">cached</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe VName -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="annot"><span class="annottext">(Maybe VName -&gt; Bool)
-&gt; CompilerM op s (Maybe VName) -&gt; CompilerM op s Bool
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; CompilerM op s (Maybe VName)
forall a op s. ToExp a =&gt; a -&gt; CompilerM op s (Maybe VName)
</span><a href="Futhark.CodeGen.Backends.GenericC.html#cacheMem"><span class="hs-identifier hs-var">GC.cacheMem</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684535339"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-352"></span><span>  </span><span class="annot"><span class="annottext">(Type, ValueType) -&gt; CompilerM op s (Type, ValueType)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-353"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Space -&gt; Type
</span><a href="Futhark.CodeGen.Backends.GenericC.html#fatMemType"><span class="hs-identifier hs-var">GC.fatMemType</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684535338"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-354"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684535337"><span class="hs-identifier hs-var">refcount</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684535335"><span class="hs-identifier hs-var">cached</span></a></span><span>
</span><span id="line-355"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">ValueType
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#MemBlock"><span class="hs-identifier hs-var">MemBlock</span></a></span><span>
</span><span id="line-356"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">ValueType
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#RawMem"><span class="hs-identifier hs-var">RawMem</span></a></span><span>
</span><span id="line-357"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-358"></span><span>
</span><span id="line-359"></span><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#functionRuntime"><span class="hs-identifier hs-type">functionRuntime</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.Id</span></span><span>
</span><span id="line-360"></span><span id="functionRuntime"><span class="annot"><span class="annottext">functionRuntime :: Name -&gt; Id
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#functionRuntime"><span class="hs-identifier hs-var hs-var">functionRuntime</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; SrcLoc -&gt; Id
forall a. ToIdent a =&gt; a -&gt; SrcLoc -&gt; Id
</span><span class="hs-operator hs-var">`C.toIdent`</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; Id) -&gt; (Name -&gt; Name) -&gt; Name -&gt; Id
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Name -&gt; Name
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-string">&quot;_total_runtime&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-361"></span><span>
</span><span id="line-362"></span><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#functionRuns"><span class="hs-identifier hs-type">functionRuns</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.Id</span></span><span>
</span><span id="line-363"></span><span id="functionRuns"><span class="annot"><span class="annottext">functionRuns :: Name -&gt; Id
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#functionRuns"><span class="hs-identifier hs-var hs-var">functionRuns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; SrcLoc -&gt; Id
forall a. ToIdent a =&gt; a -&gt; SrcLoc -&gt; Id
</span><span class="hs-operator hs-var">`C.toIdent`</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; Id) -&gt; (Name -&gt; Name) -&gt; Name -&gt; Id
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Name -&gt; Name
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-string">&quot;_runs&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-364"></span><span>
</span><span id="line-365"></span><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#functionIter"><span class="hs-identifier hs-type">functionIter</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.Id</span></span><span>
</span><span id="line-366"></span><span id="functionIter"><span class="annot"><span class="annottext">functionIter :: Name -&gt; Id
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#functionIter"><span class="hs-identifier hs-var hs-var">functionIter</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; SrcLoc -&gt; Id
forall a. ToIdent a =&gt; a -&gt; SrcLoc -&gt; Id
</span><span class="hs-operator hs-var">`C.toIdent`</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; Id) -&gt; (Name -&gt; Name) -&gt; Name -&gt; Id
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Name -&gt; Name
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-string">&quot;_iter&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-367"></span><span>
</span><span id="line-368"></span><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#multiCoreReport"><span class="hs-identifier hs-type">multiCoreReport</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">C.BlockItem</span></span><span class="hs-special">]</span><span>
</span><span id="line-369"></span><span id="multiCoreReport"><span class="annot"><span class="annottext">multiCoreReport :: [(Name, Bool)] -&gt; [BlockItem]
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#multiCoreReport"><span class="hs-identifier hs-var hs-var">multiCoreReport</span></a></span></span><span> </span><span id="local-6989586621684535323"><span class="annot"><span class="annottext">[(Name, Bool)]
</span><a href="#local-6989586621684535323"><span class="hs-identifier hs-var">names</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621684535322"><span class="hs-identifier hs-var">report_kernels</span></a></span><span>
</span><span id="line-370"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-371"></span><span>    </span><span id="local-6989586621684535322"><span class="annot"><span class="annottext">report_kernels :: [BlockItem]
</span><a href="#local-6989586621684535322"><span class="hs-identifier hs-var hs-var">report_kernels</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Name, Bool) -&gt; [BlockItem]) -&gt; [(Name, Bool)] -&gt; [BlockItem]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="annot"><span class="annottext">(Name, Bool) -&gt; [BlockItem]
</span><a href="#local-6989586621684535319"><span class="hs-identifier hs-var">reportKernel</span></a></span><span> </span><span class="annot"><span class="annottext">[(Name, Bool)]
</span><a href="#local-6989586621684535323"><span class="hs-identifier hs-var">names</span></a></span><span>
</span><span id="line-372"></span><span>    </span><span id="local-6989586621684535316"><span class="annot"><span class="annottext">max_name_len_pad :: Int
</span><a href="#local-6989586621684535316"><span class="hs-identifier hs-var hs-var">max_name_len_pad</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">40</span></span><span>
</span><span id="line-373"></span><span>    </span><span id="local-6989586621684535315"><span class="annot"><span class="annottext">format_string :: Name -&gt; Bool -&gt; [Char]
</span><a href="#local-6989586621684535315"><span class="hs-identifier hs-var hs-var">format_string</span></a></span></span><span> </span><span id="local-6989586621684535314"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684535314"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-374"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684535313"><span class="annot"><span class="annottext">name_s :: [Char]
</span><a href="#local-6989586621684535313"><span class="hs-identifier hs-var hs-var">name_s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; [Char]
</span><a href="Language.Futhark.Core.html#nameToString"><span class="hs-identifier hs-var">nameToString</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684535314"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-375"></span><span>          </span><span id="local-6989586621684535309"><span class="annot"><span class="annottext">padding :: [Char]
</span><a href="#local-6989586621684535309"><span class="hs-identifier hs-var hs-var">padding</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Char -&gt; [Char]
forall a. Int -&gt; a -&gt; [a]
</span><span class="hs-identifier hs-var">replicate</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684535316"><span class="hs-identifier hs-var">max_name_len_pad</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684535313"><span class="hs-identifier hs-var">name_s</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">' '</span></span><span>
</span><span id="line-376"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">[[Char]] -&gt; [Char]
</span><span class="hs-identifier hs-var">unwords</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;tid %2d -&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684535313"><span class="hs-identifier hs-var">name_s</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684535309"><span class="hs-identifier hs-var">padding</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;ran %10d times; avg: %10ldus; total: %10ldus; time pr. iter %9.6f; iters %9ld; avg %ld\n&quot;</span></span><span class="hs-special">]</span><span>
</span><span id="line-377"></span><span>    </span><span class="annot"><a href="#local-6989586621684535315"><span class="hs-identifier hs-var">format_string</span></a></span><span> </span><span id="local-6989586621684535305"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684535305"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-378"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684535304"><span class="annot"><span class="annottext">name_s :: [Char]
</span><a href="#local-6989586621684535304"><span class="hs-identifier hs-var hs-var">name_s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; [Char]
</span><a href="Language.Futhark.Core.html#nameToString"><span class="hs-identifier hs-var">nameToString</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684535305"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-379"></span><span>          </span><span id="local-6989586621684535301"><span class="annot"><span class="annottext">padding :: [Char]
</span><a href="#local-6989586621684535301"><span class="hs-identifier hs-var hs-var">padding</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Char -&gt; [Char]
forall a. Int -&gt; a -&gt; [a]
</span><span class="hs-identifier hs-var">replicate</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684535316"><span class="hs-identifier hs-var">max_name_len_pad</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684535304"><span class="hs-identifier hs-var">name_s</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">' '</span></span><span>
</span><span id="line-380"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">[[Char]] -&gt; [Char]
</span><span class="hs-identifier hs-var">unwords</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;        &quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684535304"><span class="hs-identifier hs-var">name_s</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684535301"><span class="hs-identifier hs-var">padding</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;ran %10d times; avg: %10ldus; total: %10ldus; time pr. iter %9.6f; iters %9ld; avg %ld\n&quot;</span></span><span class="hs-special">]</span><span>
</span><span id="line-381"></span><span>    </span><span id="local-6989586621684535319"><span class="annot"><span class="annottext">reportKernel :: (Name, Bool) -&gt; [BlockItem]
</span><a href="#local-6989586621684535319"><span class="hs-identifier hs-var hs-var">reportKernel</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684535271"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684535271"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684535270"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684535270"><span class="hs-identifier hs-var">is_array</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-382"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684535269"><span class="annot"><span class="annottext">runs :: Id
</span><a href="#local-6989586621684535269"><span class="hs-identifier hs-var hs-var">runs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Id
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#functionRuns"><span class="hs-identifier hs-var">functionRuns</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684535271"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-383"></span><span>          </span><span id="local-6989586621684535268"><span class="annot"><span class="annottext">total_runtime :: Id
</span><a href="#local-6989586621684535268"><span class="hs-identifier hs-var hs-var">total_runtime</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Id
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#functionRuntime"><span class="hs-identifier hs-var">functionRuntime</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684535271"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-384"></span><span>          </span><span id="local-6989586621684535267"><span class="annot"><span class="annottext">iters :: Id
</span><a href="#local-6989586621684535267"><span class="hs-identifier hs-var hs-var">iters</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Id
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#functionIter"><span class="hs-identifier hs-var">functionIter</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684535271"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-385"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684535270"><span class="hs-identifier hs-var">is_array</span></a></span><span>
</span><span id="line-386"></span><span>            </span><span class="hs-keyword">then</span><span>
</span><span id="line-387"></span><span>              </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="">[C.citem|
                     for (int i = 0; i &lt; ctx-&gt;scheduler.num_threads; i++) {
                       fprintf(ctx-&gt;log,
                         $string:(format_string name is_array),
                         i,
                         ctx-&gt;$id:runs[i],
                         (long int) ctx-&gt;$id:total_runtime[i] / (ctx-&gt;$id:runs[i] != 0 ? ctx-&gt;$id:runs[i] : 1),
                         (long int) ctx-&gt;$id:total_runtime[i],
                         (double) ctx-&gt;$id:total_runtime[i] /  (ctx-&gt;$id:iters[i] == 0 ? 1 : (double)ctx-&gt;$id:iters[i]),
                         (long int) (ctx-&gt;$id:iters[i]),
                         (long int) (ctx-&gt;$id:iters[i]) / (ctx-&gt;$id:runs[i] != 0 ? ctx-&gt;$id:runs[i] : 1)
                         );
                     }
                   |]</span></span><span>
</span><span id="line-401"></span><span>              </span><span class="hs-special">]</span><span>
</span><span id="line-402"></span><span>            </span><span class="hs-keyword">else</span><span>
</span><span id="line-403"></span><span>              </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="">[C.citem|
                    fprintf(ctx-&gt;log,
                       $string:(format_string name is_array),
                       ctx-&gt;$id:runs,
                       (long int) ctx-&gt;$id:total_runtime / (ctx-&gt;$id:runs != 0 ? ctx-&gt;$id:runs : 1),
                       (long int) ctx-&gt;$id:total_runtime,
                       (double) ctx-&gt;$id:total_runtime /  (ctx-&gt;$id:iters == 0 ? 1 : (double)ctx-&gt;$id:iters),
                       (long int) (ctx-&gt;$id:iters),
                       (long int) (ctx-&gt;$id:iters) / (ctx-&gt;$id:runs != 0 ? ctx-&gt;$id:runs : 1));
                   |]</span></span><span class="hs-special">,</span><span>
</span><span id="line-413"></span><span>                </span><span class="annot"><span class="">[C.citem|ctx-&gt;total_runtime += ctx-&gt;$id:total_runtime;|]</span></span><span class="hs-special">,</span><span>
</span><span id="line-414"></span><span>                </span><span class="annot"><span class="">[C.citem|ctx-&gt;total_runs += ctx-&gt;$id:runs;|]</span></span><span>
</span><span id="line-415"></span><span>              </span><span class="hs-special">]</span><span>
</span><span id="line-416"></span><span>
</span><span id="line-417"></span><span id="local-6989586621684535965"><span id="local-6989586621684535966"><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#addBenchmarkFields"><span class="hs-identifier hs-type">addBenchmarkFields</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.Backends.GenericC.html#CompilerM"><span class="hs-identifier hs-type">GC.CompilerM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684535966"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684535965"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-418"></span><span id="addBenchmarkFields"><span class="annot"><span class="annottext">addBenchmarkFields :: forall op s. Name -&gt; Maybe VName -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#addBenchmarkFields"><span class="hs-identifier hs-var hs-var">addBenchmarkFields</span></a></span></span><span> </span><span id="local-6989586621684535253"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684535253"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-419"></span><span>  </span><span class="annot"><span class="annottext">Id -&gt; Type -&gt; Exp -&gt; Stm -&gt; CompilerM op s ()
forall op s. Id -&gt; Type -&gt; Exp -&gt; Stm -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#contextFieldDyn"><span class="hs-identifier hs-var">GC.contextFieldDyn</span></a></span><span>
</span><span id="line-420"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Id
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#functionRuntime"><span class="hs-identifier hs-var">functionRuntime</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684535253"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-421"></span><span>    </span><span class="annot"><span class="">[C.cty|typename int64_t*|]</span></span><span>
</span><span id="line-422"></span><span>    </span><span class="annot"><span class="">[C.cexp|calloc(sizeof(typename int64_t), ctx-&gt;scheduler.num_threads)|]</span></span><span>
</span><span id="line-423"></span><span>    </span><span class="annot"><span class="">[C.cstm|free(ctx-&gt;$id:(functionRuntime name));|]</span></span><span>
</span><span id="line-424"></span><span>  </span><span class="annot"><span class="annottext">Id -&gt; Type -&gt; Exp -&gt; Stm -&gt; CompilerM op s ()
forall op s. Id -&gt; Type -&gt; Exp -&gt; Stm -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#contextFieldDyn"><span class="hs-identifier hs-var">GC.contextFieldDyn</span></a></span><span>
</span><span id="line-425"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Id
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#functionRuns"><span class="hs-identifier hs-var">functionRuns</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684535253"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-426"></span><span>    </span><span class="annot"><span class="">[C.cty|int*|]</span></span><span>
</span><span id="line-427"></span><span>    </span><span class="annot"><span class="">[C.cexp|calloc(sizeof(int), ctx-&gt;scheduler.num_threads)|]</span></span><span>
</span><span id="line-428"></span><span>    </span><span class="annot"><span class="">[C.cstm|free(ctx-&gt;$id:(functionRuns name));|]</span></span><span>
</span><span id="line-429"></span><span>  </span><span class="annot"><span class="annottext">Id -&gt; Type -&gt; Exp -&gt; Stm -&gt; CompilerM op s ()
forall op s. Id -&gt; Type -&gt; Exp -&gt; Stm -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#contextFieldDyn"><span class="hs-identifier hs-var">GC.contextFieldDyn</span></a></span><span>
</span><span id="line-430"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Id
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#functionIter"><span class="hs-identifier hs-var">functionIter</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684535253"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-431"></span><span>    </span><span class="annot"><span class="">[C.cty|typename int64_t*|]</span></span><span>
</span><span id="line-432"></span><span>    </span><span class="annot"><span class="">[C.cexp|calloc(sizeof(sizeof(typename int64_t)), ctx-&gt;scheduler.num_threads)|]</span></span><span>
</span><span id="line-433"></span><span>    </span><span class="annot"><span class="">[C.cstm|free(ctx-&gt;$id:(functionIter name));|]</span></span><span>
</span><span id="line-434"></span><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#addBenchmarkFields"><span class="hs-identifier hs-var">addBenchmarkFields</span></a></span><span> </span><span id="local-6989586621684535250"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684535250"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe VName
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-435"></span><span>  </span><span class="annot"><span class="annottext">Id -&gt; Type -&gt; Maybe Exp -&gt; CompilerM op s ()
forall op s. Id -&gt; Type -&gt; Maybe Exp -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#contextField"><span class="hs-identifier hs-var">GC.contextField</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Id
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#functionRuntime"><span class="hs-identifier hs-var">functionRuntime</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684535250"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="">[C.cty|typename int64_t|]</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Exp -&gt; CompilerM op s ()) -&gt; Maybe Exp -&gt; CompilerM op s ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Maybe Exp
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="">[C.cexp|0|]</span></span><span>
</span><span id="line-436"></span><span>  </span><span class="annot"><span class="annottext">Id -&gt; Type -&gt; Maybe Exp -&gt; CompilerM op s ()
forall op s. Id -&gt; Type -&gt; Maybe Exp -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#contextField"><span class="hs-identifier hs-var">GC.contextField</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Id
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#functionRuns"><span class="hs-identifier hs-var">functionRuns</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684535250"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="">[C.cty|int|]</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Exp -&gt; CompilerM op s ()) -&gt; Maybe Exp -&gt; CompilerM op s ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Maybe Exp
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="">[C.cexp|0|]</span></span><span>
</span><span id="line-437"></span><span>  </span><span class="annot"><span class="annottext">Id -&gt; Type -&gt; Maybe Exp -&gt; CompilerM op s ()
forall op s. Id -&gt; Type -&gt; Maybe Exp -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#contextField"><span class="hs-identifier hs-var">GC.contextField</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Id
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#functionIter"><span class="hs-identifier hs-var">functionIter</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684535250"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="">[C.cty|typename int64_t|]</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Exp -&gt; CompilerM op s ()) -&gt; Maybe Exp -&gt; CompilerM op s ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Maybe Exp
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="">[C.cexp|0|]</span></span><span>
</span><span id="line-438"></span><span>
</span><span id="line-439"></span><span id="local-6989586621684535957"><span id="local-6989586621684535958"><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#benchmarkCode"><span class="hs-identifier hs-type">benchmarkCode</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">C.BlockItem</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.Backends.GenericC.html#CompilerM"><span class="hs-identifier hs-type">GC.CompilerM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684535958"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684535957"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">C.BlockItem</span></span><span class="hs-special">]</span></span></span><span>
</span><span id="line-440"></span><span id="benchmarkCode"><span class="annot"><span class="annottext">benchmarkCode :: forall op s.
Name -&gt; Maybe VName -&gt; [BlockItem] -&gt; CompilerM op s [BlockItem]
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#benchmarkCode"><span class="hs-identifier hs-var hs-var">benchmarkCode</span></a></span></span><span> </span><span id="local-6989586621684535240"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684535240"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621684535239"><span class="annot"><span class="annottext">Maybe VName
</span><a href="#local-6989586621684535239"><span class="hs-identifier hs-var">tid</span></a></span></span><span> </span><span id="local-6989586621684535238"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621684535238"><span class="hs-identifier hs-var">code</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-441"></span><span>  </span><span class="annot"><span class="annottext">Name -&gt; Maybe VName -&gt; CompilerM op s ()
forall op s. Name -&gt; Maybe VName -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#addBenchmarkFields"><span class="hs-identifier hs-var">addBenchmarkFields</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684535240"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe VName
</span><a href="#local-6989586621684535239"><span class="hs-identifier hs-var">tid</span></a></span><span>
</span><span id="line-442"></span><span>  </span><span class="annot"><span class="annottext">[BlockItem] -&gt; CompilerM op s [BlockItem]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-443"></span><span>    </span><span class="annot"><span class="">[C.citems|
     typename uint64_t $id:start = 0;
     if (ctx-&gt;profiling &amp;&amp; !ctx-&gt;profiling_paused) {
       $id:start = get_wall_time();
     }
     $items:code
     if (ctx-&gt;profiling &amp;&amp; !ctx-&gt;profiling_paused) {
       typename uint64_t $id:end = get_wall_time();
       typename uint64_t elapsed = $id:end - $id:start;
       $items:(updateFields tid)
     }
     |]</span></span><span>
</span><span id="line-455"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-456"></span><span>    </span><span id="local-6989586621684535237"><span class="annot"><span class="annottext">start :: Name
</span><a href="#local-6989586621684535237"><span class="hs-identifier hs-var hs-var">start</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684535240"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Name -&gt; Name
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-string">&quot;_start&quot;</span></span><span>
</span><span id="line-457"></span><span>    </span><span id="local-6989586621684535236"><span class="annot"><span class="annottext">end :: Name
</span><a href="#local-6989586621684535236"><span class="hs-identifier hs-var hs-var">end</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684535240"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Name -&gt; Name
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-string">&quot;_end&quot;</span></span><span>
</span><span id="line-458"></span><span>    </span><span id="local-6989586621684535235"><span class="annot"><span class="annottext">updateFields :: Maybe a -&gt; [BlockItem]
</span><a href="#local-6989586621684535235"><span class="hs-identifier hs-var hs-var">updateFields</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-459"></span><span>      </span><span class="annot"><span class="">[C.citems|__atomic_fetch_add(&amp;ctx-&gt;$id:(functionRuns name), 1, __ATOMIC_RELAXED);
                                            __atomic_fetch_add(&amp;ctx-&gt;$id:(functionRuntime name), elapsed, __ATOMIC_RELAXED);
                                            __atomic_fetch_add(&amp;ctx-&gt;$id:(functionIter name), iterations, __ATOMIC_RELAXED);|]</span></span><span>
</span><span id="line-462"></span><span>    </span><span class="annot"><a href="#local-6989586621684535235"><span class="hs-identifier hs-var">updateFields</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684535221"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684535221"><span class="hs-identifier hs-var">_tid'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-463"></span><span>      </span><span class="annot"><span class="">[C.citems|ctx-&gt;$id:(functionRuns name)[tid]++;
                                            ctx-&gt;$id:(functionRuntime name)[tid] += elapsed;
                                            ctx-&gt;$id:(functionIter name)[tid] += iterations;|]</span></span><span>
</span><span id="line-466"></span><span>
</span><span id="line-467"></span><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#functionTiming"><span class="hs-identifier hs-type">functionTiming</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.Id</span></span><span>
</span><span id="line-468"></span><span id="functionTiming"><span class="annot"><span class="annottext">functionTiming :: Name -&gt; Id
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#functionTiming"><span class="hs-identifier hs-var hs-var">functionTiming</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; SrcLoc -&gt; Id
forall a. ToIdent a =&gt; a -&gt; SrcLoc -&gt; Id
</span><span class="hs-operator hs-var">`C.toIdent`</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; Id) -&gt; (Name -&gt; Name) -&gt; Name -&gt; Id
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Name -&gt; Name
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-string">&quot;_total_time&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-469"></span><span>
</span><span id="line-470"></span><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#functionIterations"><span class="hs-identifier hs-type">functionIterations</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.Id</span></span><span>
</span><span id="line-471"></span><span id="functionIterations"><span class="annot"><span class="annottext">functionIterations :: Name -&gt; Id
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#functionIterations"><span class="hs-identifier hs-var hs-var">functionIterations</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; SrcLoc -&gt; Id
forall a. ToIdent a =&gt; a -&gt; SrcLoc -&gt; Id
</span><span class="hs-operator hs-var">`C.toIdent`</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; Id) -&gt; (Name -&gt; Name) -&gt; Name -&gt; Id
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Name -&gt; Name
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-string">&quot;_total_iter&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-472"></span><span>
</span><span id="line-473"></span><span id="local-6989586621684535952"><span id="local-6989586621684535953"><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#addTimingFields"><span class="hs-identifier hs-type">addTimingFields</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.Backends.GenericC.html#CompilerM"><span class="hs-identifier hs-type">GC.CompilerM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684535953"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684535952"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-474"></span><span id="addTimingFields"><span class="annot"><span class="annottext">addTimingFields :: forall op s. Name -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#addTimingFields"><span class="hs-identifier hs-var hs-var">addTimingFields</span></a></span></span><span> </span><span id="local-6989586621684535216"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684535216"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-475"></span><span>  </span><span class="annot"><span class="annottext">Id -&gt; Type -&gt; Maybe Exp -&gt; CompilerM op s ()
forall op s. Id -&gt; Type -&gt; Maybe Exp -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#contextField"><span class="hs-identifier hs-var">GC.contextField</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Id
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#functionTiming"><span class="hs-identifier hs-var">functionTiming</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684535216"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="">[C.cty|typename int64_t|]</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Exp -&gt; CompilerM op s ()) -&gt; Maybe Exp -&gt; CompilerM op s ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Maybe Exp
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="">[C.cexp|0|]</span></span><span>
</span><span id="line-476"></span><span>  </span><span class="annot"><span class="annottext">Id -&gt; Type -&gt; Maybe Exp -&gt; CompilerM op s ()
forall op s. Id -&gt; Type -&gt; Maybe Exp -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#contextField"><span class="hs-identifier hs-var">GC.contextField</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Id
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#functionIterations"><span class="hs-identifier hs-var">functionIterations</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684535216"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="">[C.cty|typename int64_t|]</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Exp -&gt; CompilerM op s ()) -&gt; Maybe Exp -&gt; CompilerM op s ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Maybe Exp
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="">[C.cexp|0|]</span></span><span>
</span><span id="line-477"></span><span>
</span><span id="line-478"></span><span id="local-6989586621684535948"><span id="local-6989586621684535949"><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#multicoreName"><span class="hs-identifier hs-type">multicoreName</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.Backends.GenericC.html#CompilerM"><span class="hs-identifier hs-type">GC.CompilerM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684535949"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684535948"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span></span></span><span>
</span><span id="line-479"></span><span id="multicoreName"><span class="annot"><span class="annottext">multicoreName :: forall op s. [Char] -&gt; CompilerM op s Name
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#multicoreName"><span class="hs-identifier hs-var hs-var">multicoreName</span></a></span></span><span> </span><span id="local-6989586621684535206"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684535206"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-480"></span><span>  </span><span id="local-6989586621684535205"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684535205"><span class="hs-identifier hs-var">s'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; CompilerM op s VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; [Char] -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;futhark_mc_&quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684535206"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-481"></span><span>  </span><span class="annot"><span class="annottext">Name -&gt; CompilerM op s Name
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Name -&gt; CompilerM op s Name) -&gt; Name -&gt; CompilerM op s Name
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Name
</span><a href="Language.Futhark.Core.html#nameFromString"><span class="hs-identifier hs-var">nameFromString</span></a></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; Name) -&gt; [Char] -&gt; Name
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [Char]
</span><a href="Language.Futhark.Core.html#baseString"><span class="hs-identifier hs-var">baseString</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684535205"><span class="hs-identifier hs-var">s'</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;_&quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Int
</span><a href="Language.Futhark.Core.html#baseTag"><span class="hs-identifier hs-var">baseTag</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684535205"><span class="hs-identifier hs-var">s'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-482"></span><span>
</span><span id="line-483"></span><span id="local-6989586621684535941"><span id="local-6989586621684535942"><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#multicoreDef"><span class="hs-identifier hs-type">multicoreDef</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.Backends.GenericC.html#CompilerM"><span class="hs-identifier hs-type">GC.CompilerM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684535942"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684535941"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.Definition</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.Backends.GenericC.html#CompilerM"><span class="hs-identifier hs-type">GC.CompilerM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684535942"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684535941"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span></span></span><span>
</span><span id="line-484"></span><span id="multicoreDef"><span class="annot"><span class="annottext">multicoreDef :: forall op s.
[Char]
-&gt; (Name -&gt; CompilerM op s Definition) -&gt; CompilerM op s Name
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#multicoreDef"><span class="hs-identifier hs-var hs-var">multicoreDef</span></a></span></span><span> </span><span id="local-6989586621684535196"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684535196"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621684535195"><span class="annot"><span class="annottext">Name -&gt; CompilerM op s Definition
</span><a href="#local-6989586621684535195"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-485"></span><span>  </span><span id="local-6989586621684535194"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684535194"><span class="hs-identifier hs-var">s'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; CompilerM op s Name
forall op s. [Char] -&gt; CompilerM op s Name
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#multicoreName"><span class="hs-identifier hs-var">multicoreName</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684535196"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-486"></span><span>  </span><span class="annot"><span class="annottext">Definition -&gt; CompilerM op s ()
forall op s. Definition -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#libDecl"><span class="hs-identifier hs-var">GC.libDecl</span></a></span><span> </span><span class="annot"><span class="annottext">(Definition -&gt; CompilerM op s ())
-&gt; CompilerM op s Definition -&gt; CompilerM op s ()
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; CompilerM op s Definition
</span><a href="#local-6989586621684535195"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684535194"><span class="hs-identifier hs-var">s'</span></a></span><span>
</span><span id="line-487"></span><span>  </span><span class="annot"><span class="annottext">Name -&gt; CompilerM op s Name
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684535194"><span class="hs-identifier hs-var">s'</span></a></span><span>
</span><span id="line-488"></span><span>
</span><span id="line-489"></span><span id="local-6989586621684535932"><span id="local-6989586621684535935"><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#generateParLoopFn"><span class="hs-identifier hs-type">generateParLoopFn</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-490"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">C.ToIdent</span></span><span> </span><span class="annot"><a href="#local-6989586621684535935"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-491"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-492"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-493"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.Multicore.html#Code"><span class="hs-identifier hs-type">Code</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-494"></span><span>  </span><span class="annot"><a href="#local-6989586621684535935"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-495"></span><span>  </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Type</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#ValueType"><span class="hs-identifier hs-type">ValueType</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-496"></span><span>  </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Type</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#ValueType"><span class="hs-identifier hs-type">ValueType</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-497"></span><span>  </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-498"></span><span>  </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-499"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.Backends.GenericC.html#CompilerM"><span class="hs-identifier hs-type">GC.CompilerM</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.Multicore.html#Multicore"><span class="hs-identifier hs-type">Multicore</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684535932"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span></span></span><span>
</span><span id="line-500"></span><span id="generateParLoopFn"><span class="annot"><span class="annottext">generateParLoopFn :: forall a s.
ToIdent a =&gt;
Map VName Space
-&gt; [Char]
-&gt; Code
-&gt; a
-&gt; [(VName, (Type, ValueType))]
-&gt; [(VName, (Type, ValueType))]
-&gt; VName
-&gt; VName
-&gt; CompilerM Multicore s Name
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#generateParLoopFn"><span class="hs-identifier hs-var hs-var">generateParLoopFn</span></a></span></span><span> </span><span id="local-6989586621684535163"><span class="annot"><span class="annottext">Map VName Space
</span><a href="#local-6989586621684535163"><span class="hs-identifier hs-var">lexical</span></a></span></span><span> </span><span id="local-6989586621684535162"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684535162"><span class="hs-identifier hs-var">basename</span></a></span></span><span> </span><span id="local-6989586621684535161"><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684535161"><span class="hs-identifier hs-var">code</span></a></span></span><span> </span><span id="local-6989586621684535160"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684535160"><span class="hs-identifier hs-var">fstruct</span></a></span></span><span> </span><span id="local-6989586621684535159"><span class="annot"><span class="annottext">[(VName, (Type, ValueType))]
</span><a href="#local-6989586621684535159"><span class="hs-identifier hs-var">free</span></a></span></span><span> </span><span id="local-6989586621684535158"><span class="annot"><span class="annottext">[(VName, (Type, ValueType))]
</span><a href="#local-6989586621684535158"><span class="hs-identifier hs-var">retval</span></a></span></span><span> </span><span id="local-6989586621684535157"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684535157"><span class="hs-identifier hs-var">tid</span></a></span></span><span> </span><span id="local-6989586621684535156"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684535156"><span class="hs-identifier hs-var">ntasks</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-501"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684535155"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684535155"><span class="hs-identifier hs-var">fargs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684535154"><span class="annot"><span class="annottext">[(Type, ValueType)]
</span><a href="#local-6989586621684535154"><span class="hs-identifier hs-var">fctypes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VName, (Type, ValueType))] -&gt; ([VName], [(Type, ValueType)])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">[(VName, (Type, ValueType))]
</span><a href="#local-6989586621684535159"><span class="hs-identifier hs-var">free</span></a></span><span>
</span><span id="line-502"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684535152"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684535152"><span class="hs-identifier hs-var">retval_args</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684535151"><span class="annot"><span class="annottext">[(Type, ValueType)]
</span><a href="#local-6989586621684535151"><span class="hs-identifier hs-var">retval_ctypes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VName, (Type, ValueType))] -&gt; ([VName], [(Type, ValueType)])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">[(VName, (Type, ValueType))]
</span><a href="#local-6989586621684535158"><span class="hs-identifier hs-var">retval</span></a></span><span>
</span><span id="line-503"></span><span>  </span><span class="annot"><span class="annottext">[Char]
-&gt; (Name -&gt; CompilerM Multicore s Definition)
-&gt; CompilerM Multicore s Name
forall op s.
[Char]
-&gt; (Name -&gt; CompilerM op s Definition) -&gt; CompilerM op s Name
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#multicoreDef"><span class="hs-identifier hs-var">multicoreDef</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684535162"><span class="hs-identifier hs-var">basename</span></a></span><span> </span><span class="annot"><span class="annottext">((Name -&gt; CompilerM Multicore s Definition)
 -&gt; CompilerM Multicore s Name)
-&gt; (Name -&gt; CompilerM Multicore s Definition)
-&gt; CompilerM Multicore s Name
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684535150"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684535150"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-504"></span><span>    </span><span id="local-6989586621684535149"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621684535149"><span class="hs-identifier hs-var">fbody</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name
-&gt; Maybe VName -&gt; [BlockItem] -&gt; CompilerM Multicore s [BlockItem]
forall op s.
Name -&gt; Maybe VName -&gt; [BlockItem] -&gt; CompilerM op s [BlockItem]
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#benchmarkCode"><span class="hs-identifier hs-var">benchmarkCode</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684535150"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Maybe VName
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684535157"><span class="hs-identifier hs-var">tid</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([BlockItem] -&gt; CompilerM Multicore s [BlockItem])
-&gt; (CompilerM Multicore s [BlockItem]
    -&gt; CompilerM Multicore s [BlockItem])
-&gt; CompilerM Multicore s [BlockItem]
-&gt; CompilerM Multicore s [BlockItem]
forall (m :: * -&gt; *) b c a.
Monad m =&gt;
(b -&gt; m c) -&gt; (a -&gt; m b) -&gt; a -&gt; m c
</span><span class="hs-operator hs-var">&lt;=&lt;</span></span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; CompilerM Multicore s [BlockItem]
-&gt; CompilerM Multicore s [BlockItem]
forall op s a. Bool -&gt; CompilerM op s a -&gt; CompilerM op s a
</span><a href="Futhark.CodeGen.Backends.GenericC.html#inNewFunction"><span class="hs-identifier hs-var">GC.inNewFunction</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">(CompilerM Multicore s [BlockItem]
 -&gt; CompilerM Multicore s [BlockItem])
-&gt; CompilerM Multicore s [BlockItem]
-&gt; CompilerM Multicore s [BlockItem]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-505"></span><span>      </span><span class="annot"><span class="annottext">Map VName Space
-&gt; ([BlockItem] -&gt; [Stm] -&gt; CompilerM Multicore s [BlockItem])
-&gt; CompilerM Multicore s [BlockItem]
forall op s a.
Map VName Space
-&gt; ([BlockItem] -&gt; [Stm] -&gt; CompilerM op s a) -&gt; CompilerM op s a
</span><a href="Futhark.CodeGen.Backends.GenericC.html#cachingMemory"><span class="hs-identifier hs-var">GC.cachingMemory</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName Space
</span><a href="#local-6989586621684535163"><span class="hs-identifier hs-var">lexical</span></a></span><span> </span><span class="annot"><span class="annottext">(([BlockItem] -&gt; [Stm] -&gt; CompilerM Multicore s [BlockItem])
 -&gt; CompilerM Multicore s [BlockItem])
-&gt; ([BlockItem] -&gt; [Stm] -&gt; CompilerM Multicore s [BlockItem])
-&gt; CompilerM Multicore s [BlockItem]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-506"></span><span>        </span><span class="hs-glyph">\</span><span id="local-6989586621684535146"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621684535146"><span class="hs-identifier hs-var">decl_cached</span></a></span></span><span> </span><span id="local-6989586621684535145"><span class="annot"><span class="annottext">[Stm]
</span><a href="#local-6989586621684535145"><span class="hs-identifier hs-var">free_cached</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CompilerM Multicore s () -&gt; CompilerM Multicore s [BlockItem]
forall op s. CompilerM op s () -&gt; CompilerM op s [BlockItem]
</span><a href="Futhark.CodeGen.Backends.GenericC.html#blockScope"><span class="hs-identifier hs-var">GC.blockScope</span></a></span><span> </span><span class="annot"><span class="annottext">(CompilerM Multicore s () -&gt; CompilerM Multicore s [BlockItem])
-&gt; CompilerM Multicore s () -&gt; CompilerM Multicore s [BlockItem]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-507"></span><span>          </span><span class="annot"><span class="annottext">(BlockItem -&gt; CompilerM Multicore s ())
-&gt; [BlockItem] -&gt; CompilerM Multicore s ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="annot"><span class="annottext">BlockItem -&gt; CompilerM Multicore s ()
forall op s. BlockItem -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#item"><span class="hs-identifier hs-var">GC.item</span></a></span><span> </span><span class="annot"><span class="">[C.citems|$decls:(compileGetStructVals fstruct fargs fctypes)|]</span></span><span>
</span><span id="line-508"></span><span>          </span><span class="annot"><span class="annottext">(BlockItem -&gt; CompilerM Multicore s ())
-&gt; [BlockItem] -&gt; CompilerM Multicore s ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="annot"><span class="annottext">BlockItem -&gt; CompilerM Multicore s ()
forall op s. BlockItem -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#item"><span class="hs-identifier hs-var">GC.item</span></a></span><span> </span><span class="annot"><span class="">[C.citems|$decls:(compileGetRetvalStructVals fstruct retval_args retval_ctypes)|]</span></span><span>
</span><span id="line-509"></span><span>          </span><span class="annot"><span class="annottext">(BlockItem -&gt; CompilerM Multicore s ())
-&gt; [BlockItem] -&gt; CompilerM Multicore s ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="annot"><span class="annottext">BlockItem -&gt; CompilerM Multicore s ()
forall op s. BlockItem -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#item"><span class="hs-identifier hs-var">GC.item</span></a></span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621684535146"><span class="hs-identifier hs-var">decl_cached</span></a></span><span>
</span><span id="line-510"></span><span>          </span><span id="local-6989586621684535142"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621684535142"><span class="hs-identifier hs-var">code'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CompilerM Multicore s () -&gt; CompilerM Multicore s [BlockItem]
forall op s. CompilerM op s () -&gt; CompilerM op s [BlockItem]
</span><a href="Futhark.CodeGen.Backends.GenericC.html#blockScope"><span class="hs-identifier hs-var">GC.blockScope</span></a></span><span> </span><span class="annot"><span class="annottext">(CompilerM Multicore s () -&gt; CompilerM Multicore s [BlockItem])
-&gt; CompilerM Multicore s () -&gt; CompilerM Multicore s [BlockItem]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Code -&gt; CompilerM Multicore s ()
forall op s. Code op -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#compileCode"><span class="hs-identifier hs-var">GC.compileCode</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684535161"><span class="hs-identifier hs-var">code</span></a></span><span>
</span><span id="line-511"></span><span>          </span><span class="annot"><span class="annottext">(BlockItem -&gt; CompilerM Multicore s ())
-&gt; [BlockItem] -&gt; CompilerM Multicore s ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="annot"><span class="annottext">BlockItem -&gt; CompilerM Multicore s ()
forall op s. BlockItem -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#item"><span class="hs-identifier hs-var">GC.item</span></a></span><span> </span><span class="annot"><span class="">[C.citems|$items:code'|]</span></span><span>
</span><span id="line-512"></span><span>          </span><span class="annot"><span class="annottext">Stm -&gt; CompilerM Multicore s ()
forall op s. Stm -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#stm"><span class="hs-identifier hs-var">GC.stm</span></a></span><span> </span><span class="annot"><span class="">[C.cstm|cleanup: {$stms:free_cached}|]</span></span><span>
</span><span id="line-513"></span><span>    </span><span class="annot"><span class="annottext">Definition -&gt; CompilerM Multicore s Definition
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-514"></span><span>      </span><span class="annot"><span class="">[C.cedecl|int $id:s(void *args, typename int64_t iterations, int tid, struct scheduler_info info) {
                           int err = 0;
                           int $id:tid = tid;
                           int $id:ntasks = info.nsubtasks;
                           struct $id:fstruct *$id:fstruct = (struct $id:fstruct*) args;
                           struct futhark_context *ctx = $id:fstruct-&gt;ctx;
                           $items:fbody
                           if (err == 0) {
                             $stms:(compileWriteBackResVals fstruct retval_args retval_ctypes)
                           }
                           return err;
                      }|]</span></span><span>
</span><span id="line-526"></span><span>
</span><span id="line-527"></span><span id="local-6989586621684535912"><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#prepareTaskStruct"><span class="hs-identifier hs-type">prepareTaskStruct</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-528"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-529"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-530"></span><span>  </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Type</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#ValueType"><span class="hs-identifier hs-type">ValueType</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-531"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-532"></span><span>  </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Type</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#ValueType"><span class="hs-identifier hs-type">ValueType</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-533"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.Backends.GenericC.html#CompilerM"><span class="hs-identifier hs-type">GC.CompilerM</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.Multicore.html#Multicore"><span class="hs-identifier hs-type">Multicore</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684535912"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span></span><span>
</span><span id="line-534"></span><span id="prepareTaskStruct"><span class="annot"><span class="annottext">prepareTaskStruct :: forall s.
[Char]
-&gt; [VName]
-&gt; [(Type, ValueType)]
-&gt; [VName]
-&gt; [(Type, ValueType)]
-&gt; CompilerM Multicore s Name
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#prepareTaskStruct"><span class="hs-identifier hs-var hs-var">prepareTaskStruct</span></a></span></span><span> </span><span id="local-6989586621684535124"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684535124"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621684535123"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684535123"><span class="hs-identifier hs-var">free_args</span></a></span></span><span> </span><span id="local-6989586621684535122"><span class="annot"><span class="annottext">[(Type, ValueType)]
</span><a href="#local-6989586621684535122"><span class="hs-identifier hs-var">free_ctypes</span></a></span></span><span> </span><span id="local-6989586621684535121"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684535121"><span class="hs-identifier hs-var">retval_args</span></a></span></span><span> </span><span id="local-6989586621684535120"><span class="annot"><span class="annottext">[(Type, ValueType)]
</span><a href="#local-6989586621684535120"><span class="hs-identifier hs-var">retval_ctypes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-535"></span><span>  </span><span id="local-6989586621684535119"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684535119"><span class="hs-identifier hs-var">fstruct</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Char]
-&gt; (Name -&gt; CompilerM Multicore s Definition)
-&gt; CompilerM Multicore s Name
forall op s.
[Char]
-&gt; (Name -&gt; CompilerM op s Definition) -&gt; CompilerM op s Name
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#multicoreDef"><span class="hs-identifier hs-var">multicoreDef</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684535124"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">((Name -&gt; CompilerM Multicore s Definition)
 -&gt; CompilerM Multicore s Name)
-&gt; (Name -&gt; CompilerM Multicore s Definition)
-&gt; CompilerM Multicore s Name
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684535118"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684535118"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-536"></span><span>    </span><span class="annot"><span class="annottext">Definition -&gt; CompilerM Multicore s Definition
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-537"></span><span>      </span><span class="annot"><span class="">[C.cedecl|struct $id:s {
                       struct futhark_context *ctx;
                       $sdecls:(compileFreeStructFields free_args free_ctypes)
                       $sdecls:(compileRetvalStructFields retval_args retval_ctypes)
                     };|]</span></span><span>
</span><span id="line-542"></span><span>  </span><span class="annot"><span class="annottext">InitGroup -&gt; CompilerM Multicore s ()
forall op s. InitGroup -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#decl"><span class="hs-identifier hs-var">GC.decl</span></a></span><span> </span><span class="annot"><span class="">[C.cdecl|struct $id:fstruct $id:fstruct;|]</span></span><span>
</span><span id="line-543"></span><span>  </span><span class="annot"><span class="annottext">Stm -&gt; CompilerM Multicore s ()
forall op s. Stm -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#stm"><span class="hs-identifier hs-var">GC.stm</span></a></span><span> </span><span class="annot"><span class="">[C.cstm|$id:fstruct.ctx = ctx;|]</span></span><span>
</span><span id="line-544"></span><span>  </span><span class="annot"><span class="annottext">[Stm] -&gt; CompilerM Multicore s ()
forall op s. [Stm] -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#stms"><span class="hs-identifier hs-var">GC.stms</span></a></span><span> </span><span class="annot"><span class="">[C.cstms|$stms:(compileSetStructValues fstruct free_args free_ctypes)|]</span></span><span>
</span><span id="line-545"></span><span>  </span><span class="annot"><span class="annottext">[Stm] -&gt; CompilerM Multicore s ()
forall op s. [Stm] -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#stms"><span class="hs-identifier hs-var">GC.stms</span></a></span><span> </span><span class="annot"><span class="">[C.cstms|$stms:(compileSetRetvalStructValues fstruct retval_args retval_ctypes)|]</span></span><span>
</span><span id="line-546"></span><span>  </span><span class="annot"><span class="annottext">Name -&gt; CompilerM Multicore s Name
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684535119"><span class="hs-identifier hs-var">fstruct</span></a></span><span>
</span><span id="line-547"></span><span>
</span><span id="line-548"></span><span class="hs-comment">-- Generate a segop function for top_level and potentially nested SegOp code</span><span>
</span><span id="line-549"></span><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#compileOp"><span class="hs-identifier hs-type">compileOp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.Backends.GenericC.html#OpCompiler"><span class="hs-identifier hs-type">GC.OpCompiler</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.Multicore.html#Multicore"><span class="hs-identifier hs-type">Multicore</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-550"></span><span id="compileOp"><span class="annot"><span class="annottext">compileOp :: OpCompiler Multicore ()
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#compileOp"><span class="hs-identifier hs-var hs-var">compileOp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.Multicore.html#Segop"><span class="hs-identifier hs-type">Segop</span></a></span><span> </span><span id="local-6989586621684535114"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684535114"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621684535113"><span class="annot"><span class="annottext">[Param]
</span><a href="#local-6989586621684535113"><span class="hs-identifier hs-var">params</span></a></span></span><span> </span><span id="local-6989586621684535112"><span class="annot"><span class="annottext">ParallelTask
</span><a href="#local-6989586621684535112"><span class="hs-identifier hs-var">seq_task</span></a></span></span><span> </span><span id="local-6989586621684535111"><span class="annot"><span class="annottext">Maybe ParallelTask
</span><a href="#local-6989586621684535111"><span class="hs-identifier hs-var">par_task</span></a></span></span><span> </span><span id="local-6989586621684535110"><span class="annot"><span class="annottext">[Param]
</span><a href="#local-6989586621684535110"><span class="hs-identifier hs-var">retvals</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.Multicore.html#SchedulerInfo"><span class="hs-identifier hs-type">SchedulerInfo</span></a></span><span> </span><span id="local-6989586621684535108"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684535108"><span class="hs-identifier hs-var">nsubtask</span></a></span></span><span> </span><span id="local-6989586621684535107"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684535107"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621684535106"><span class="annot"><span class="annottext">Scheduling
</span><a href="#local-6989586621684535106"><span class="hs-identifier hs-var">sched</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-551"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.Multicore.html#ParallelTask"><span class="hs-identifier hs-type">ParallelTask</span></a></span><span> </span><span id="local-6989586621684535104"><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684535104"><span class="hs-identifier hs-var">seq_code</span></a></span></span><span> </span><span id="local-6989586621684535103"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684535103"><span class="hs-identifier hs-var">tid</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ParallelTask
</span><a href="#local-6989586621684535112"><span class="hs-identifier hs-var">seq_task</span></a></span><span>
</span><span id="line-552"></span><span>  </span><span id="local-6989586621684535102"><span class="annot"><span class="annottext">[(Type, ValueType)]
</span><a href="#local-6989586621684535102"><span class="hs-identifier hs-var">free_ctypes</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Param -&gt; CompilerM Multicore () (Type, ValueType))
-&gt; [Param] -&gt; CompilerM Multicore () [(Type, ValueType)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Param -&gt; CompilerM Multicore () (Type, ValueType)
forall op s. Param -&gt; CompilerM op s (Type, ValueType)
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#paramToCType"><span class="hs-identifier hs-var">paramToCType</span></a></span><span> </span><span class="annot"><span class="annottext">[Param]
</span><a href="#local-6989586621684535113"><span class="hs-identifier hs-var">params</span></a></span><span>
</span><span id="line-553"></span><span>  </span><span id="local-6989586621684535100"><span class="annot"><span class="annottext">[(Type, ValueType)]
</span><a href="#local-6989586621684535100"><span class="hs-identifier hs-var">retval_ctypes</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Param -&gt; CompilerM Multicore () (Type, ValueType))
-&gt; [Param] -&gt; CompilerM Multicore () [(Type, ValueType)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Param -&gt; CompilerM Multicore () (Type, ValueType)
forall op s. Param -&gt; CompilerM op s (Type, ValueType)
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#paramToCType"><span class="hs-identifier hs-var">paramToCType</span></a></span><span> </span><span class="annot"><span class="annottext">[Param]
</span><a href="#local-6989586621684535110"><span class="hs-identifier hs-var">retvals</span></a></span><span>
</span><span id="line-554"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684535099"><span class="annot"><span class="annottext">free_args :: [VName]
</span><a href="#local-6989586621684535099"><span class="hs-identifier hs-var hs-var">free_args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Param -&gt; VName) -&gt; [Param] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Param -&gt; VName
</span><a href="Futhark.CodeGen.ImpCode.html#paramName"><span class="hs-identifier hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">[Param]
</span><a href="#local-6989586621684535113"><span class="hs-identifier hs-var">params</span></a></span><span>
</span><span id="line-555"></span><span>      </span><span id="local-6989586621684535097"><span class="annot"><span class="annottext">retval_args :: [VName]
</span><a href="#local-6989586621684535097"><span class="hs-identifier hs-var hs-var">retval_args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Param -&gt; VName) -&gt; [Param] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Param -&gt; VName
</span><a href="Futhark.CodeGen.ImpCode.html#paramName"><span class="hs-identifier hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">[Param]
</span><a href="#local-6989586621684535110"><span class="hs-identifier hs-var">retvals</span></a></span><span>
</span><span id="line-556"></span><span>      </span><span id="local-6989586621684535096"><span class="annot"><span class="annottext">free :: [(VName, (Type, ValueType))]
</span><a href="#local-6989586621684535096"><span class="hs-identifier hs-var hs-var">free</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [(Type, ValueType)] -&gt; [(VName, (Type, ValueType))]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684535099"><span class="hs-identifier hs-var">free_args</span></a></span><span> </span><span class="annot"><span class="annottext">[(Type, ValueType)]
</span><a href="#local-6989586621684535102"><span class="hs-identifier hs-var">free_ctypes</span></a></span><span>
</span><span id="line-557"></span><span>      </span><span id="local-6989586621684535095"><span class="annot"><span class="annottext">retval :: [(VName, (Type, ValueType))]
</span><a href="#local-6989586621684535095"><span class="hs-identifier hs-var hs-var">retval</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [(Type, ValueType)] -&gt; [(VName, (Type, ValueType))]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684535097"><span class="hs-identifier hs-var">retval_args</span></a></span><span> </span><span class="annot"><span class="annottext">[(Type, ValueType)]
</span><a href="#local-6989586621684535100"><span class="hs-identifier hs-var">retval_ctypes</span></a></span><span>
</span><span id="line-558"></span><span>
</span><span id="line-559"></span><span>  </span><span id="local-6989586621684535094"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684535094"><span class="hs-identifier hs-var">e'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; CompilerM Multicore () Exp
forall op s. Exp -&gt; CompilerM op s Exp
</span><a href="Futhark.CodeGen.Backends.GenericC.html#compileExp"><span class="hs-identifier hs-var">GC.compileExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684535107"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-560"></span><span>
</span><span id="line-561"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684535092"><span class="annot"><span class="annottext">lexical :: Map VName Space
</span><a href="#local-6989586621684535092"><span class="hs-identifier hs-var hs-var">lexical</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Function Multicore -&gt; Map VName Space
forall a. Function a -&gt; Map VName Space
</span><a href="Futhark.CodeGen.ImpCode.html#lexicalMemoryUsage"><span class="hs-identifier hs-var">lexicalMemoryUsage</span></a></span><span> </span><span class="annot"><span class="annottext">(Function Multicore -&gt; Map VName Space)
-&gt; Function Multicore -&gt; Map VName Space
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe Name
-&gt; [Param]
-&gt; [Param]
-&gt; Code
-&gt; [ExternalValue]
-&gt; [(Name, ExternalValue)]
-&gt; Function Multicore
forall a.
Maybe Name
-&gt; [Param]
-&gt; [Param]
-&gt; Code a
-&gt; [ExternalValue]
-&gt; [(Name, ExternalValue)]
-&gt; FunctionT a
</span><a href="Futhark.CodeGen.ImpCode.html#Function"><span class="hs-identifier hs-var">Function</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Name
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[Param]
</span><a href="#local-6989586621684535113"><span class="hs-identifier hs-var">params</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684535104"><span class="hs-identifier hs-var">seq_code</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-562"></span><span>
</span><span id="line-563"></span><span>  </span><span id="local-6989586621684535089"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684535089"><span class="hs-identifier hs-var">fstruct</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-564"></span><span>    </span><span class="annot"><span class="annottext">[Char]
-&gt; [VName]
-&gt; [(Type, ValueType)]
-&gt; [VName]
-&gt; [(Type, ValueType)]
-&gt; CompilerM Multicore () Name
forall s.
[Char]
-&gt; [VName]
-&gt; [(Type, ValueType)]
-&gt; [VName]
-&gt; [(Type, ValueType)]
-&gt; CompilerM Multicore s Name
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#prepareTaskStruct"><span class="hs-identifier hs-var">prepareTaskStruct</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;task&quot;</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684535099"><span class="hs-identifier hs-var">free_args</span></a></span><span> </span><span class="annot"><span class="annottext">[(Type, ValueType)]
</span><a href="#local-6989586621684535102"><span class="hs-identifier hs-var">free_ctypes</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684535097"><span class="hs-identifier hs-var">retval_args</span></a></span><span> </span><span class="annot"><span class="annottext">[(Type, ValueType)]
</span><a href="#local-6989586621684535100"><span class="hs-identifier hs-var">retval_ctypes</span></a></span><span>
</span><span id="line-565"></span><span>
</span><span id="line-566"></span><span>  </span><span id="local-6989586621684535088"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684535088"><span class="hs-identifier hs-var">fpar_task</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Map VName Space
-&gt; [Char]
-&gt; Code
-&gt; Name
-&gt; [(VName, (Type, ValueType))]
-&gt; [(VName, (Type, ValueType))]
-&gt; VName
-&gt; VName
-&gt; CompilerM Multicore () Name
forall a s.
ToIdent a =&gt;
Map VName Space
-&gt; [Char]
-&gt; Code
-&gt; a
-&gt; [(VName, (Type, ValueType))]
-&gt; [(VName, (Type, ValueType))]
-&gt; VName
-&gt; VName
-&gt; CompilerM Multicore s Name
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#generateParLoopFn"><span class="hs-identifier hs-var">generateParLoopFn</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName Space
</span><a href="#local-6989586621684535092"><span class="hs-identifier hs-var">lexical</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684535114"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;_task&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684535104"><span class="hs-identifier hs-var">seq_code</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684535089"><span class="hs-identifier hs-var">fstruct</span></a></span><span> </span><span class="annot"><span class="annottext">[(VName, (Type, ValueType))]
</span><a href="#local-6989586621684535096"><span class="hs-identifier hs-var">free</span></a></span><span> </span><span class="annot"><span class="annottext">[(VName, (Type, ValueType))]
</span><a href="#local-6989586621684535095"><span class="hs-identifier hs-var">retval</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684535103"><span class="hs-identifier hs-var">tid</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684535108"><span class="hs-identifier hs-var">nsubtask</span></a></span><span>
</span><span id="line-567"></span><span>  </span><span class="annot"><span class="annottext">Name -&gt; CompilerM Multicore () ()
forall op s. Name -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#addTimingFields"><span class="hs-identifier hs-var">addTimingFields</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684535088"><span class="hs-identifier hs-var">fpar_task</span></a></span><span>
</span><span id="line-568"></span><span>
</span><span id="line-569"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684535085"><span class="annot"><span class="annottext">ftask_name :: Name
</span><a href="#local-6989586621684535085"><span class="hs-identifier hs-var hs-var">ftask_name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684535089"><span class="hs-identifier hs-var">fstruct</span></a></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Name -&gt; Name
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-string">&quot;_task&quot;</span></span><span>
</span><span id="line-570"></span><span>  </span><span class="annot"><span class="annottext">InitGroup -&gt; CompilerM Multicore () ()
forall op s. InitGroup -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#decl"><span class="hs-identifier hs-var">GC.decl</span></a></span><span> </span><span class="annot"><span class="">[C.cdecl|struct scheduler_segop $id:ftask_name;|]</span></span><span>
</span><span id="line-571"></span><span>  </span><span class="annot"><span class="annottext">Stm -&gt; CompilerM Multicore () ()
forall op s. Stm -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#stm"><span class="hs-identifier hs-var">GC.stm</span></a></span><span> </span><span class="annot"><span class="">[C.cstm|$id:ftask_name.args = &amp;$id:fstruct;|]</span></span><span>
</span><span id="line-572"></span><span>  </span><span class="annot"><span class="annottext">Stm -&gt; CompilerM Multicore () ()
forall op s. Stm -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#stm"><span class="hs-identifier hs-var">GC.stm</span></a></span><span> </span><span class="annot"><span class="">[C.cstm|$id:ftask_name.top_level_fn = $id:fpar_task;|]</span></span><span>
</span><span id="line-573"></span><span>  </span><span class="annot"><span class="annottext">Stm -&gt; CompilerM Multicore () ()
forall op s. Stm -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#stm"><span class="hs-identifier hs-var">GC.stm</span></a></span><span> </span><span class="annot"><span class="">[C.cstm|$id:ftask_name.name = $string:(nameToString fpar_task);|]</span></span><span>
</span><span id="line-574"></span><span>  </span><span class="annot"><span class="annottext">Stm -&gt; CompilerM Multicore () ()
forall op s. Stm -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#stm"><span class="hs-identifier hs-var">GC.stm</span></a></span><span> </span><span class="annot"><span class="">[C.cstm|$id:ftask_name.iterations = $exp:e';|]</span></span><span>
</span><span id="line-575"></span><span>  </span><span class="hs-comment">-- Create the timing fields for the task</span><span>
</span><span id="line-576"></span><span>  </span><span class="annot"><span class="annottext">Stm -&gt; CompilerM Multicore () ()
forall op s. Stm -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#stm"><span class="hs-identifier hs-var">GC.stm</span></a></span><span> </span><span class="annot"><span class="">[C.cstm|$id:ftask_name.task_time = &amp;ctx-&gt;$id:(functionTiming fpar_task);|]</span></span><span>
</span><span id="line-577"></span><span>  </span><span class="annot"><span class="annottext">Stm -&gt; CompilerM Multicore () ()
forall op s. Stm -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#stm"><span class="hs-identifier hs-var">GC.stm</span></a></span><span> </span><span class="annot"><span class="">[C.cstm|$id:ftask_name.task_iter = &amp;ctx-&gt;$id:(functionIterations fpar_task);|]</span></span><span>
</span><span id="line-578"></span><span>
</span><span id="line-579"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Scheduling
</span><a href="#local-6989586621684535106"><span class="hs-identifier hs-var">sched</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-580"></span><span>    </span><span class="annot"><span class="annottext">Scheduling
</span><a href="Futhark.CodeGen.ImpCode.Multicore.html#Dynamic"><span class="hs-identifier hs-var">Dynamic</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Stm -&gt; CompilerM Multicore () ()
forall op s. Stm -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#stm"><span class="hs-identifier hs-var">GC.stm</span></a></span><span> </span><span class="annot"><span class="">[C.cstm|$id:ftask_name.sched = DYNAMIC;|]</span></span><span>
</span><span id="line-581"></span><span>    </span><span class="annot"><span class="annottext">Scheduling
</span><a href="Futhark.CodeGen.ImpCode.Multicore.html#Static"><span class="hs-identifier hs-var">Static</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Stm -&gt; CompilerM Multicore () ()
forall op s. Stm -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#stm"><span class="hs-identifier hs-var">GC.stm</span></a></span><span> </span><span class="annot"><span class="">[C.cstm|$id:ftask_name.sched = STATIC;|]</span></span><span>
</span><span id="line-582"></span><span>
</span><span id="line-583"></span><span>  </span><span class="hs-comment">-- Generate the nested segop function if available</span><span>
</span><span id="line-584"></span><span>  </span><span id="local-6989586621684535081"><span class="annot"><span class="annottext">[(Name, Bool)]
</span><a href="#local-6989586621684535081"><span class="hs-identifier hs-var">fnpar_task</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe ParallelTask
</span><a href="#local-6989586621684535111"><span class="hs-identifier hs-var">par_task</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-585"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.Multicore.html#ParallelTask"><span class="hs-identifier hs-type">ParallelTask</span></a></span><span> </span><span id="local-6989586621684535080"><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684535080"><span class="hs-identifier hs-var">nested_code</span></a></span></span><span> </span><span id="local-6989586621684535079"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684535079"><span class="hs-identifier hs-var">nested_tid</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-586"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684535078"><span class="annot"><span class="annottext">lexical_nested :: Map VName Space
</span><a href="#local-6989586621684535078"><span class="hs-identifier hs-var hs-var">lexical_nested</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Function Multicore -&gt; Map VName Space
forall a. Function a -&gt; Map VName Space
</span><a href="Futhark.CodeGen.ImpCode.html#lexicalMemoryUsage"><span class="hs-identifier hs-var">lexicalMemoryUsage</span></a></span><span> </span><span class="annot"><span class="annottext">(Function Multicore -&gt; Map VName Space)
-&gt; Function Multicore -&gt; Map VName Space
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe Name
-&gt; [Param]
-&gt; [Param]
-&gt; Code
-&gt; [ExternalValue]
-&gt; [(Name, ExternalValue)]
-&gt; Function Multicore
forall a.
Maybe Name
-&gt; [Param]
-&gt; [Param]
-&gt; Code a
-&gt; [ExternalValue]
-&gt; [(Name, ExternalValue)]
-&gt; FunctionT a
</span><a href="Futhark.CodeGen.ImpCode.html#Function"><span class="hs-identifier hs-var">Function</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Name
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[Param]
</span><a href="#local-6989586621684535113"><span class="hs-identifier hs-var">params</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684535080"><span class="hs-identifier hs-var">nested_code</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-587"></span><span>      </span><span id="local-6989586621684535077"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684535077"><span class="hs-identifier hs-var">fnpar_task</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Map VName Space
-&gt; [Char]
-&gt; Code
-&gt; Name
-&gt; [(VName, (Type, ValueType))]
-&gt; [(VName, (Type, ValueType))]
-&gt; VName
-&gt; VName
-&gt; CompilerM Multicore () Name
forall a s.
ToIdent a =&gt;
Map VName Space
-&gt; [Char]
-&gt; Code
-&gt; a
-&gt; [(VName, (Type, ValueType))]
-&gt; [(VName, (Type, ValueType))]
-&gt; VName
-&gt; VName
-&gt; CompilerM Multicore s Name
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#generateParLoopFn"><span class="hs-identifier hs-var">generateParLoopFn</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName Space
</span><a href="#local-6989586621684535078"><span class="hs-identifier hs-var">lexical_nested</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684535114"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;_nested_task&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684535080"><span class="hs-identifier hs-var">nested_code</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684535089"><span class="hs-identifier hs-var">fstruct</span></a></span><span> </span><span class="annot"><span class="annottext">[(VName, (Type, ValueType))]
</span><a href="#local-6989586621684535096"><span class="hs-identifier hs-var">free</span></a></span><span> </span><span class="annot"><span class="annottext">[(VName, (Type, ValueType))]
</span><a href="#local-6989586621684535095"><span class="hs-identifier hs-var">retval</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684535079"><span class="hs-identifier hs-var">nested_tid</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684535108"><span class="hs-identifier hs-var">nsubtask</span></a></span><span>
</span><span id="line-588"></span><span>      </span><span class="annot"><span class="annottext">Stm -&gt; CompilerM Multicore () ()
forall op s. Stm -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#stm"><span class="hs-identifier hs-var">GC.stm</span></a></span><span> </span><span class="annot"><span class="">[C.cstm|$id:ftask_name.nested_fn = $id:fnpar_task;|]</span></span><span>
</span><span id="line-589"></span><span>      </span><span class="annot"><span class="annottext">[(Name, Bool)] -&gt; CompilerM Multicore () [(Name, Bool)]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">([(Name, Bool)] -&gt; CompilerM Multicore () [(Name, Bool)])
-&gt; [(Name, Bool)] -&gt; CompilerM Multicore () [(Name, Bool)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Name] -&gt; [Bool] -&gt; [(Name, Bool)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684535077"><span class="hs-identifier hs-var">fnpar_task</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">]</span><span>
</span><span id="line-590"></span><span>    </span><span class="annot"><span class="annottext">Maybe ParallelTask
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-591"></span><span>      </span><span class="annot"><span class="annottext">Stm -&gt; CompilerM Multicore () ()
forall op s. Stm -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#stm"><span class="hs-identifier hs-var">GC.stm</span></a></span><span> </span><span class="annot"><span class="">[C.cstm|$id:ftask_name.nested_fn=NULL;|]</span></span><span>
</span><span id="line-592"></span><span>      </span><span class="annot"><span class="annottext">[(Name, Bool)] -&gt; CompilerM Multicore () [(Name, Bool)]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">[(Name, Bool)]
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-593"></span><span>
</span><span id="line-594"></span><span>  </span><span id="local-6989586621684535076"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621684535076"><span class="hs-identifier hs-var">free_all_mem</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CompilerM Multicore () [BlockItem]
forall op s. CompilerM op s [BlockItem]
</span><a href="Futhark.CodeGen.Backends.GenericC.html#freeAllocatedMem"><span class="hs-identifier hs-var">GC.freeAllocatedMem</span></a></span><span>
</span><span id="line-595"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684535072"><span class="annot"><span class="annottext">ftask_err :: Name
</span><a href="#local-6989586621684535072"><span class="hs-identifier hs-var hs-var">ftask_err</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684535088"><span class="hs-identifier hs-var">fpar_task</span></a></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Name -&gt; Name
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-string">&quot;_err&quot;</span></span><span>
</span><span id="line-596"></span><span>      </span><span id="local-6989586621684535068"><span class="annot"><span class="annottext">code :: [BlockItem]
</span><a href="#local-6989586621684535068"><span class="hs-identifier hs-var hs-var">code</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-597"></span><span>        </span><span class="annot"><span class="">[C.citems|int $id:ftask_err = scheduler_prepare_task(&amp;ctx-&gt;scheduler, &amp;$id:ftask_name);
                  if ($id:ftask_err != 0) {
                    $items:free_all_mem;
                    err = 1;
                    goto cleanup;
                  }|]</span></span><span>
</span><span id="line-603"></span><span>
</span><span id="line-604"></span><span>  </span><span class="annot"><span class="annottext">(BlockItem -&gt; CompilerM Multicore () ())
-&gt; [BlockItem] -&gt; CompilerM Multicore () ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="annot"><span class="annottext">BlockItem -&gt; CompilerM Multicore () ()
forall op s. BlockItem -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#item"><span class="hs-identifier hs-var">GC.item</span></a></span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621684535068"><span class="hs-identifier hs-var">code</span></a></span><span>
</span><span id="line-605"></span><span>
</span><span id="line-606"></span><span>  </span><span class="hs-comment">-- Add profile fields for -P option</span><span>
</span><span id="line-607"></span><span>  </span><span class="annot"><span class="annottext">(BlockItem -&gt; CompilerM Multicore () ())
-&gt; [BlockItem] -&gt; CompilerM Multicore () ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="annot"><span class="annottext">BlockItem -&gt; CompilerM Multicore () ()
forall op s. BlockItem -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#profileReport"><span class="hs-identifier hs-var">GC.profileReport</span></a></span><span> </span><span class="annot"><span class="annottext">([BlockItem] -&gt; CompilerM Multicore () ())
-&gt; [BlockItem] -&gt; CompilerM Multicore () ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(Name, Bool)] -&gt; [BlockItem]
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#multiCoreReport"><span class="hs-identifier hs-var">multiCoreReport</span></a></span><span> </span><span class="annot"><span class="annottext">([(Name, Bool)] -&gt; [BlockItem]) -&gt; [(Name, Bool)] -&gt; [BlockItem]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684535088"><span class="hs-identifier hs-var">fpar_task</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Name, Bool) -&gt; [(Name, Bool)] -&gt; [(Name, Bool)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[(Name, Bool)]
</span><a href="#local-6989586621684535081"><span class="hs-identifier hs-var">fnpar_task</span></a></span><span>
</span><span id="line-608"></span><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#compileOp"><span class="hs-identifier hs-var">compileOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.Multicore.html#ParLoop"><span class="hs-identifier hs-type">ParLoop</span></a></span><span> </span><span id="local-6989586621684535064"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684535064"><span class="hs-identifier hs-var">s'</span></a></span></span><span> </span><span id="local-6989586621684535063"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684535063"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621684535062"><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684535062"><span class="hs-identifier hs-var">prebody</span></a></span></span><span> </span><span id="local-6989586621684535061"><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684535061"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span id="local-6989586621684535060"><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684535060"><span class="hs-identifier hs-var">postbody</span></a></span></span><span> </span><span id="local-6989586621684535059"><span class="annot"><span class="annottext">[Param]
</span><a href="#local-6989586621684535059"><span class="hs-identifier hs-var">free</span></a></span></span><span> </span><span id="local-6989586621684535058"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684535058"><span class="hs-identifier hs-var">tid</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-609"></span><span>  </span><span id="local-6989586621684535057"><span class="annot"><span class="annottext">[(Type, ValueType)]
</span><a href="#local-6989586621684535057"><span class="hs-identifier hs-var">free_ctypes</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Param -&gt; CompilerM Multicore () (Type, ValueType))
-&gt; [Param] -&gt; CompilerM Multicore () [(Type, ValueType)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Param -&gt; CompilerM Multicore () (Type, ValueType)
forall op s. Param -&gt; CompilerM op s (Type, ValueType)
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#paramToCType"><span class="hs-identifier hs-var">paramToCType</span></a></span><span> </span><span class="annot"><span class="annottext">[Param]
</span><a href="#local-6989586621684535059"><span class="hs-identifier hs-var">free</span></a></span><span>
</span><span id="line-610"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684535056"><span class="annot"><span class="annottext">free_args :: [VName]
</span><a href="#local-6989586621684535056"><span class="hs-identifier hs-var hs-var">free_args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Param -&gt; VName) -&gt; [Param] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Param -&gt; VName
</span><a href="Futhark.CodeGen.ImpCode.html#paramName"><span class="hs-identifier hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">[Param]
</span><a href="#local-6989586621684535059"><span class="hs-identifier hs-var">free</span></a></span><span>
</span><span id="line-611"></span><span>
</span><span id="line-612"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684535053"><span class="annot"><span class="annottext">lexical :: Map VName Space
</span><a href="#local-6989586621684535053"><span class="hs-identifier hs-var hs-var">lexical</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-613"></span><span>        </span><span class="annot"><span class="annottext">Function Multicore -&gt; Map VName Space
forall a. Function a -&gt; Map VName Space
</span><a href="Futhark.CodeGen.ImpCode.html#lexicalMemoryUsage"><span class="hs-identifier hs-var">lexicalMemoryUsage</span></a></span><span> </span><span class="annot"><span class="annottext">(Function Multicore -&gt; Map VName Space)
-&gt; Function Multicore -&gt; Map VName Space
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-614"></span><span>          </span><span class="annot"><span class="annottext">Maybe Name
-&gt; [Param]
-&gt; [Param]
-&gt; Code
-&gt; [ExternalValue]
-&gt; [(Name, ExternalValue)]
-&gt; Function Multicore
forall a.
Maybe Name
-&gt; [Param]
-&gt; [Param]
-&gt; Code a
-&gt; [ExternalValue]
-&gt; [(Name, ExternalValue)]
-&gt; FunctionT a
</span><a href="Futhark.CodeGen.ImpCode.html#Function"><span class="hs-identifier hs-var">Function</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Name
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[Param]
</span><a href="#local-6989586621684535059"><span class="hs-identifier hs-var">free</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684535062"><span class="hs-identifier hs-var">prebody</span></a></span><span> </span><span class="annot"><span class="annottext">Code -&gt; Code -&gt; Code
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684535061"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-615"></span><span>
</span><span id="line-616"></span><span>  </span><span id="local-6989586621684535052"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684535052"><span class="hs-identifier hs-var">fstruct</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-617"></span><span>    </span><span class="annot"><span class="annottext">[Char]
-&gt; [VName]
-&gt; [(Type, ValueType)]
-&gt; [VName]
-&gt; [(Type, ValueType)]
-&gt; CompilerM Multicore () Name
forall s.
[Char]
-&gt; [VName]
-&gt; [(Type, ValueType)]
-&gt; [VName]
-&gt; [(Type, ValueType)]
-&gt; CompilerM Multicore s Name
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#prepareTaskStruct"><span class="hs-identifier hs-var">prepareTaskStruct</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684535064"><span class="hs-identifier hs-var">s'</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;_parloop_struct&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684535056"><span class="hs-identifier hs-var">free_args</span></a></span><span> </span><span class="annot"><span class="annottext">[(Type, ValueType)]
</span><a href="#local-6989586621684535057"><span class="hs-identifier hs-var">free_ctypes</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">[(Type, ValueType)]
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-618"></span><span>
</span><span id="line-619"></span><span>  </span><span id="local-6989586621684535051"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684535051"><span class="hs-identifier hs-var">ftask</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Char]
-&gt; (Name -&gt; CompilerM Multicore () Definition)
-&gt; CompilerM Multicore () Name
forall op s.
[Char]
-&gt; (Name -&gt; CompilerM op s Definition) -&gt; CompilerM op s Name
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#multicoreDef"><span class="hs-identifier hs-var">multicoreDef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684535064"><span class="hs-identifier hs-var">s'</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;_parloop&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Name -&gt; CompilerM Multicore () Definition)
 -&gt; CompilerM Multicore () Name)
-&gt; (Name -&gt; CompilerM Multicore () Definition)
-&gt; CompilerM Multicore () Name
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684535050"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684535050"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-620"></span><span>    </span><span id="local-6989586621684535049"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621684535049"><span class="hs-identifier hs-var">fbody</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name
-&gt; Maybe VName -&gt; [BlockItem] -&gt; CompilerM Multicore () [BlockItem]
forall op s.
Name -&gt; Maybe VName -&gt; [BlockItem] -&gt; CompilerM op s [BlockItem]
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#benchmarkCode"><span class="hs-identifier hs-var">benchmarkCode</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684535050"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Maybe VName
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684535058"><span class="hs-identifier hs-var">tid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-621"></span><span>      </span><span class="annot"><span class="annottext">([BlockItem] -&gt; CompilerM Multicore () [BlockItem])
-&gt; (CompilerM Multicore () [BlockItem]
    -&gt; CompilerM Multicore () [BlockItem])
-&gt; CompilerM Multicore () [BlockItem]
-&gt; CompilerM Multicore () [BlockItem]
forall (m :: * -&gt; *) b c a.
Monad m =&gt;
(b -&gt; m c) -&gt; (a -&gt; m b) -&gt; a -&gt; m c
</span><span class="hs-operator hs-var">&lt;=&lt;</span></span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; CompilerM Multicore () [BlockItem]
-&gt; CompilerM Multicore () [BlockItem]
forall op s a. Bool -&gt; CompilerM op s a -&gt; CompilerM op s a
</span><a href="Futhark.CodeGen.Backends.GenericC.html#inNewFunction"><span class="hs-identifier hs-var">GC.inNewFunction</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-622"></span><span>      </span><span class="annot"><span class="annottext">(CompilerM Multicore () [BlockItem]
 -&gt; CompilerM Multicore () [BlockItem])
-&gt; CompilerM Multicore () [BlockItem]
-&gt; CompilerM Multicore () [BlockItem]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Map VName Space
-&gt; ([BlockItem] -&gt; [Stm] -&gt; CompilerM Multicore () [BlockItem])
-&gt; CompilerM Multicore () [BlockItem]
forall op s a.
Map VName Space
-&gt; ([BlockItem] -&gt; [Stm] -&gt; CompilerM op s a) -&gt; CompilerM op s a
</span><a href="Futhark.CodeGen.Backends.GenericC.html#cachingMemory"><span class="hs-identifier hs-var">GC.cachingMemory</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName Space
</span><a href="#local-6989586621684535053"><span class="hs-identifier hs-var">lexical</span></a></span><span> </span><span class="annot"><span class="annottext">(([BlockItem] -&gt; [Stm] -&gt; CompilerM Multicore () [BlockItem])
 -&gt; CompilerM Multicore () [BlockItem])
-&gt; ([BlockItem] -&gt; [Stm] -&gt; CompilerM Multicore () [BlockItem])
-&gt; CompilerM Multicore () [BlockItem]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-623"></span><span>        </span><span class="hs-glyph">\</span><span id="local-6989586621684535048"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621684535048"><span class="hs-identifier hs-var">decl_cached</span></a></span></span><span> </span><span id="local-6989586621684535047"><span class="annot"><span class="annottext">[Stm]
</span><a href="#local-6989586621684535047"><span class="hs-identifier hs-var">free_cached</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CompilerM Multicore () () -&gt; CompilerM Multicore () [BlockItem]
forall op s. CompilerM op s () -&gt; CompilerM op s [BlockItem]
</span><a href="Futhark.CodeGen.Backends.GenericC.html#blockScope"><span class="hs-identifier hs-var">GC.blockScope</span></a></span><span> </span><span class="annot"><span class="annottext">(CompilerM Multicore () () -&gt; CompilerM Multicore () [BlockItem])
-&gt; CompilerM Multicore () () -&gt; CompilerM Multicore () [BlockItem]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-624"></span><span>          </span><span class="annot"><span class="annottext">(BlockItem -&gt; CompilerM Multicore () ())
-&gt; [BlockItem] -&gt; CompilerM Multicore () ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span>
</span><span id="line-625"></span><span>            </span><span class="annot"><span class="annottext">BlockItem -&gt; CompilerM Multicore () ()
forall op s. BlockItem -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#item"><span class="hs-identifier hs-var">GC.item</span></a></span><span>
</span><span id="line-626"></span><span>            </span><span class="annot"><span class="">[C.citems|$decls:(compileGetStructVals fstruct free_args free_ctypes)|]</span></span><span>
</span><span id="line-627"></span><span>
</span><span id="line-628"></span><span>          </span><span class="annot"><span class="annottext">(BlockItem -&gt; CompilerM Multicore () ())
-&gt; [BlockItem] -&gt; CompilerM Multicore () ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="annot"><span class="annottext">BlockItem -&gt; CompilerM Multicore () ()
forall op s. BlockItem -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#item"><span class="hs-identifier hs-var">GC.item</span></a></span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621684535048"><span class="hs-identifier hs-var">decl_cached</span></a></span><span>
</span><span id="line-629"></span><span>
</span><span id="line-630"></span><span>          </span><span class="annot"><span class="annottext">InitGroup -&gt; CompilerM Multicore () ()
forall op s. InitGroup -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#decl"><span class="hs-identifier hs-var">GC.decl</span></a></span><span> </span><span class="annot"><span class="">[C.cdecl|typename int64_t iterations = end - start;|]</span></span><span>
</span><span id="line-631"></span><span>          </span><span class="annot"><span class="annottext">InitGroup -&gt; CompilerM Multicore () ()
forall op s. InitGroup -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#decl"><span class="hs-identifier hs-var">GC.decl</span></a></span><span> </span><span class="annot"><span class="">[C.cdecl|typename int64_t $id:i = start;|]</span></span><span>
</span><span id="line-632"></span><span>          </span><span class="annot"><span class="annottext">Code -&gt; CompilerM Multicore () ()
forall op s. Code op -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#compileCode"><span class="hs-identifier hs-var">GC.compileCode</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684535062"><span class="hs-identifier hs-var">prebody</span></a></span><span>
</span><span id="line-633"></span><span>          </span><span id="local-6989586621684535046"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621684535046"><span class="hs-identifier hs-var">body'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CompilerM Multicore () () -&gt; CompilerM Multicore () [BlockItem]
forall op s. CompilerM op s () -&gt; CompilerM op s [BlockItem]
</span><a href="Futhark.CodeGen.Backends.GenericC.html#blockScope"><span class="hs-identifier hs-var">GC.blockScope</span></a></span><span> </span><span class="annot"><span class="annottext">(CompilerM Multicore () () -&gt; CompilerM Multicore () [BlockItem])
-&gt; CompilerM Multicore () () -&gt; CompilerM Multicore () [BlockItem]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Code -&gt; CompilerM Multicore () ()
forall op s. Code op -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#compileCode"><span class="hs-identifier hs-var">GC.compileCode</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684535061"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-634"></span><span>          </span><span class="annot"><span class="annottext">Stm -&gt; CompilerM Multicore () ()
forall op s. Stm -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#stm"><span class="hs-identifier hs-var">GC.stm</span></a></span><span>
</span><span id="line-635"></span><span>            </span><span class="annot"><span class="">[C.cstm|for (; $id:i &lt; end; $id:i++) {
                       $items:body'
                     }|]</span></span><span>
</span><span id="line-638"></span><span>          </span><span class="annot"><span class="annottext">Code -&gt; CompilerM Multicore () ()
forall op s. Code op -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#compileCode"><span class="hs-identifier hs-var">GC.compileCode</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684535060"><span class="hs-identifier hs-var">postbody</span></a></span><span>
</span><span id="line-639"></span><span>          </span><span class="annot"><span class="annottext">Stm -&gt; CompilerM Multicore () ()
forall op s. Stm -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#stm"><span class="hs-identifier hs-var">GC.stm</span></a></span><span> </span><span class="annot"><span class="">[C.cstm|cleanup: {}|]</span></span><span>
</span><span id="line-640"></span><span>          </span><span class="annot"><span class="annottext">(Stm -&gt; CompilerM Multicore () ())
-&gt; [Stm] -&gt; CompilerM Multicore () ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="annot"><span class="annottext">Stm -&gt; CompilerM Multicore () ()
forall op s. Stm -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#stm"><span class="hs-identifier hs-var">GC.stm</span></a></span><span> </span><span class="annot"><span class="annottext">[Stm]
</span><a href="#local-6989586621684535047"><span class="hs-identifier hs-var">free_cached</span></a></span><span>
</span><span id="line-641"></span><span>
</span><span id="line-642"></span><span>    </span><span class="annot"><span class="annottext">Definition -&gt; CompilerM Multicore () Definition
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-643"></span><span>      </span><span class="annot"><span class="">[C.cedecl|static int $id:s(void *args, typename int64_t start, typename int64_t end, int $id:tid, int tid) {
                       int err = 0;
                       struct $id:fstruct *$id:fstruct = (struct $id:fstruct*) args;
                       struct futhark_context *ctx = $id:fstruct-&gt;ctx;
                       $items:fbody
                       return err;
                     }|]</span></span><span>
</span><span id="line-650"></span><span>
</span><span id="line-651"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684535043"><span class="annot"><span class="annottext">ftask_name :: Name
</span><a href="#local-6989586621684535043"><span class="hs-identifier hs-var hs-var">ftask_name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684535051"><span class="hs-identifier hs-var">ftask</span></a></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Name -&gt; Name
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-string">&quot;_task&quot;</span></span><span>
</span><span id="line-652"></span><span>  </span><span class="annot"><span class="annottext">InitGroup -&gt; CompilerM Multicore () ()
forall op s. InitGroup -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#decl"><span class="hs-identifier hs-var">GC.decl</span></a></span><span> </span><span class="annot"><span class="">[C.cdecl|struct scheduler_parloop $id:ftask_name;|]</span></span><span>
</span><span id="line-653"></span><span>  </span><span class="annot"><span class="annottext">Stm -&gt; CompilerM Multicore () ()
forall op s. Stm -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#stm"><span class="hs-identifier hs-var">GC.stm</span></a></span><span> </span><span class="annot"><span class="">[C.cstm|$id:ftask_name.name = $string:(nameToString ftask);|]</span></span><span>
</span><span id="line-654"></span><span>  </span><span class="annot"><span class="annottext">Stm -&gt; CompilerM Multicore () ()
forall op s. Stm -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#stm"><span class="hs-identifier hs-var">GC.stm</span></a></span><span> </span><span class="annot"><span class="">[C.cstm|$id:ftask_name.fn = $id:ftask;|]</span></span><span>
</span><span id="line-655"></span><span>  </span><span class="annot"><span class="annottext">Stm -&gt; CompilerM Multicore () ()
forall op s. Stm -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#stm"><span class="hs-identifier hs-var">GC.stm</span></a></span><span> </span><span class="annot"><span class="">[C.cstm|$id:ftask_name.args = &amp;$id:fstruct;|]</span></span><span>
</span><span id="line-656"></span><span>  </span><span class="annot"><span class="annottext">Stm -&gt; CompilerM Multicore () ()
forall op s. Stm -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#stm"><span class="hs-identifier hs-var">GC.stm</span></a></span><span> </span><span class="annot"><span class="">[C.cstm|$id:ftask_name.iterations = iterations;|]</span></span><span>
</span><span id="line-657"></span><span>  </span><span class="annot"><span class="annottext">Stm -&gt; CompilerM Multicore () ()
forall op s. Stm -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#stm"><span class="hs-identifier hs-var">GC.stm</span></a></span><span> </span><span class="annot"><span class="">[C.cstm|$id:ftask_name.info = info;|]</span></span><span>
</span><span id="line-658"></span><span>
</span><span id="line-659"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684535040"><span class="annot"><span class="annottext">ftask_err :: Name
</span><a href="#local-6989586621684535040"><span class="hs-identifier hs-var hs-var">ftask_err</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684535051"><span class="hs-identifier hs-var">ftask</span></a></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Name -&gt; Name
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-string">&quot;_err&quot;</span></span><span>
</span><span id="line-660"></span><span>      </span><span id="local-6989586621684535037"><span class="annot"><span class="annottext">ftask_total :: Name
</span><a href="#local-6989586621684535037"><span class="hs-identifier hs-var hs-var">ftask_total</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684535051"><span class="hs-identifier hs-var">ftask</span></a></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Name -&gt; Name
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-string">&quot;_total&quot;</span></span><span>
</span><span id="line-661"></span><span>  </span><span id="local-6989586621684535036"><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621684535036"><span class="hs-identifier hs-var">code'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-662"></span><span>    </span><span class="annot"><span class="annottext">Name
-&gt; Maybe VName -&gt; [BlockItem] -&gt; CompilerM Multicore () [BlockItem]
forall op s.
Name -&gt; Maybe VName -&gt; [BlockItem] -&gt; CompilerM op s [BlockItem]
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#benchmarkCode"><span class="hs-identifier hs-var">benchmarkCode</span></a></span><span>
</span><span id="line-663"></span><span>      </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684535037"><span class="hs-identifier hs-var">ftask_total</span></a></span><span>
</span><span id="line-664"></span><span>      </span><span class="annot"><span class="annottext">Maybe VName
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-665"></span><span>      </span><span class="annot"><span class="">[C.citems|int $id:ftask_err = scheduler_execute_task(&amp;ctx-&gt;scheduler,
                                                           &amp;$id:ftask_name);
               if ($id:ftask_err != 0) {
                 err = 1;
                 goto cleanup;
               }|]</span></span><span>
</span><span id="line-671"></span><span>
</span><span id="line-672"></span><span>  </span><span class="annot"><span class="annottext">(BlockItem -&gt; CompilerM Multicore () ())
-&gt; [BlockItem] -&gt; CompilerM Multicore () ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="annot"><span class="annottext">BlockItem -&gt; CompilerM Multicore () ()
forall op s. BlockItem -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#item"><span class="hs-identifier hs-var">GC.item</span></a></span><span> </span><span class="annot"><span class="annottext">[BlockItem]
</span><a href="#local-6989586621684535036"><span class="hs-identifier hs-var">code'</span></a></span><span>
</span><span id="line-673"></span><span>  </span><span class="annot"><span class="annottext">(BlockItem -&gt; CompilerM Multicore () ())
-&gt; [BlockItem] -&gt; CompilerM Multicore () ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="annot"><span class="annottext">BlockItem -&gt; CompilerM Multicore () ()
forall op s. BlockItem -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#profileReport"><span class="hs-identifier hs-var">GC.profileReport</span></a></span><span> </span><span class="annot"><span class="annottext">([BlockItem] -&gt; CompilerM Multicore () ())
-&gt; [BlockItem] -&gt; CompilerM Multicore () ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(Name, Bool)] -&gt; [BlockItem]
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#multiCoreReport"><span class="hs-identifier hs-var">multiCoreReport</span></a></span><span> </span><span class="annot"><span class="annottext">([(Name, Bool)] -&gt; [BlockItem]) -&gt; [(Name, Bool)] -&gt; [BlockItem]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Name] -&gt; [Bool] -&gt; [(Name, Bool)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684535051"><span class="hs-identifier hs-var">ftask</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684535037"><span class="hs-identifier hs-var">ftask_total</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">]</span><span>
</span><span id="line-674"></span><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#compileOp"><span class="hs-identifier hs-var">compileOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.Multicore.html#Atomic"><span class="hs-identifier hs-type">Atomic</span></a></span><span> </span><span id="local-6989586621684535034"><span class="annot"><span class="annottext">AtomicOp
</span><a href="#local-6989586621684535034"><span class="hs-identifier hs-var">aop</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-675"></span><span>  </span><span class="annot"><span class="annottext">AtomicOp -&gt; CompilerM Multicore () ()
forall op s. AtomicOp -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#atomicOps"><span class="hs-identifier hs-var">atomicOps</span></a></span><span> </span><span class="annot"><span class="annottext">AtomicOp
</span><a href="#local-6989586621684535034"><span class="hs-identifier hs-var">aop</span></a></span><span>
</span><span id="line-676"></span><span>
</span><span id="line-677"></span><span id="local-6989586621684535878"><span id="local-6989586621684535879"><span id="local-6989586621684535882"><span id="local-6989586621684535883"><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#doAtomic"><span class="hs-identifier hs-type">doAtomic</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-678"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.ToIdent</span></span><span> </span><span class="annot"><a href="#local-6989586621684535883"><span class="hs-identifier hs-type">a1</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-679"></span><span>  </span><span class="annot"><a href="#local-6989586621684535883"><span class="hs-identifier hs-type">a1</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-680"></span><span>  </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-681"></span><span>  </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-type">Count</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684535882"><span class="hs-identifier hs-type">u</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-682"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-683"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-684"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">C.Type</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-685"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.Backends.GenericC.html#CompilerM"><span class="hs-identifier hs-type">GC.CompilerM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684535879"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684535878"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-686"></span><span id="doAtomic"><span class="annot"><span class="annottext">doAtomic :: forall a1 u op s.
ToIdent a1 =&gt;
a1
-&gt; VName
-&gt; Count u (TExp Int32)
-&gt; Exp
-&gt; [Char]
-&gt; Type
-&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#doAtomic"><span class="hs-identifier hs-var hs-var">doAtomic</span></a></span></span><span> </span><span id="local-6989586621684535022"><span class="annot"><span class="annottext">a1
</span><a href="#local-6989586621684535022"><span class="hs-identifier hs-var">old</span></a></span></span><span> </span><span id="local-6989586621684535021"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684535021"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span id="local-6989586621684535020"><span class="annot"><span class="annottext">Count u (TExp Int32)
</span><a href="#local-6989586621684535020"><span class="hs-identifier hs-var">ind</span></a></span></span><span> </span><span id="local-6989586621684535019"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684535019"><span class="hs-identifier hs-var">val</span></a></span></span><span> </span><span id="local-6989586621684535018"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684535018"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span id="local-6989586621684535017"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684535017"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-687"></span><span>  </span><span id="local-6989586621684535016"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684535016"><span class="hs-identifier hs-var">ind'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; CompilerM op s Exp
forall op s. Exp -&gt; CompilerM op s Exp
</span><a href="Futhark.CodeGen.Backends.GenericC.html#compileExp"><span class="hs-identifier hs-var">GC.compileExp</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; CompilerM op s Exp) -&gt; Exp -&gt; CompilerM op s Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; Exp
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int32 -&gt; Exp) -&gt; TExp Int32 -&gt; Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Count u (TExp Int32) -&gt; TExp Int32
forall u e. Count u e -&gt; e
</span><a href="Futhark.IR.GPU.Sizes.html#unCount"><span class="hs-identifier hs-var hs-var">unCount</span></a></span><span> </span><span class="annot"><span class="annottext">Count u (TExp Int32)
</span><a href="#local-6989586621684535020"><span class="hs-identifier hs-var">ind</span></a></span><span>
</span><span id="line-688"></span><span>  </span><span id="local-6989586621684535013"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684535013"><span class="hs-identifier hs-var">val'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; CompilerM op s Exp
forall op s. Exp -&gt; CompilerM op s Exp
</span><a href="Futhark.CodeGen.Backends.GenericC.html#compileExp"><span class="hs-identifier hs-var">GC.compileExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684535019"><span class="hs-identifier hs-var">val</span></a></span><span>
</span><span id="line-689"></span><span>  </span><span id="local-6989586621684535012"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684535012"><span class="hs-identifier hs-var">arr'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; CompilerM op s Exp
forall op s. VName -&gt; CompilerM op s Exp
</span><a href="Futhark.CodeGen.Backends.GenericC.html#rawMem"><span class="hs-identifier hs-var">GC.rawMem</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684535021"><span class="hs-identifier hs-var">arr</span></a></span><span>
</span><span id="line-690"></span><span>  </span><span class="annot"><span class="annottext">Stm -&gt; CompilerM op s ()
forall op s. Stm -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#stm"><span class="hs-identifier hs-var">GC.stm</span></a></span><span> </span><span class="annot"><span class="">[C.cstm|$id:old = $id:op(&amp;(($ty:ty*)$exp:arr')[$exp:ind'], ($ty:ty) $exp:val', __ATOMIC_RELAXED);|]</span></span><span>
</span><span id="line-691"></span><span>
</span><span id="line-692"></span><span id="local-6989586621684535884"><span id="local-6989586621684535885"><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#atomicOps"><span class="hs-identifier hs-type">atomicOps</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.Multicore.html#AtomicOp"><span class="hs-identifier hs-type">AtomicOp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.Backends.GenericC.html#CompilerM"><span class="hs-identifier hs-type">GC.CompilerM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684535885"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684535884"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-693"></span><span id="atomicOps"><span class="annot"><span class="annottext">atomicOps :: forall op s. AtomicOp -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#atomicOps"><span class="hs-identifier hs-var hs-var">atomicOps</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.Multicore.html#AtomicCmpXchg"><span class="hs-identifier hs-type">AtomicCmpXchg</span></a></span><span> </span><span id="local-6989586621684534983"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684534983"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621684534982"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684534982"><span class="hs-identifier hs-var">old</span></a></span></span><span> </span><span id="local-6989586621684534981"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684534981"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span id="local-6989586621684534980"><span class="annot"><span class="annottext">Count Elements (TExp Int32)
</span><a href="#local-6989586621684534980"><span class="hs-identifier hs-var">ind</span></a></span></span><span> </span><span id="local-6989586621684534979"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684534979"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span id="local-6989586621684534978"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684534978"><span class="hs-identifier hs-var">val</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-694"></span><span>  </span><span id="local-6989586621684534977"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684534977"><span class="hs-identifier hs-var">ind'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; CompilerM op s Exp
forall op s. Exp -&gt; CompilerM op s Exp
</span><a href="Futhark.CodeGen.Backends.GenericC.html#compileExp"><span class="hs-identifier hs-var">GC.compileExp</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; CompilerM op s Exp) -&gt; Exp -&gt; CompilerM op s Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; Exp
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int32 -&gt; Exp) -&gt; TExp Int32 -&gt; Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Count Elements (TExp Int32) -&gt; TExp Int32
forall u e. Count u e -&gt; e
</span><a href="Futhark.IR.GPU.Sizes.html#unCount"><span class="hs-identifier hs-var hs-var">unCount</span></a></span><span> </span><span class="annot"><span class="annottext">Count Elements (TExp Int32)
</span><a href="#local-6989586621684534980"><span class="hs-identifier hs-var">ind</span></a></span><span>
</span><span id="line-695"></span><span>  </span><span id="local-6989586621684534976"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684534976"><span class="hs-identifier hs-var">new_val'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; CompilerM op s Exp
forall op s. Exp -&gt; CompilerM op s Exp
</span><a href="Futhark.CodeGen.Backends.GenericC.html#compileExp"><span class="hs-identifier hs-var">GC.compileExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684534978"><span class="hs-identifier hs-var">val</span></a></span><span>
</span><span id="line-696"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684534975"><span class="annot"><span class="annottext">cast :: Type
</span><a href="#local-6989586621684534975"><span class="hs-identifier hs-var hs-var">cast</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="">[C.cty|$ty:(GC.primTypeToCType t)*|]</span></span><span>
</span><span id="line-697"></span><span>  </span><span id="local-6989586621684534969"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684534969"><span class="hs-identifier hs-var">arr'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; CompilerM op s Exp
forall op s. VName -&gt; CompilerM op s Exp
</span><a href="Futhark.CodeGen.Backends.GenericC.html#rawMem"><span class="hs-identifier hs-var">GC.rawMem</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684534981"><span class="hs-identifier hs-var">arr</span></a></span><span>
</span><span id="line-698"></span><span>  </span><span class="annot"><span class="annottext">Stm -&gt; CompilerM op s ()
forall op s. Stm -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#stm"><span class="hs-identifier hs-var">GC.stm</span></a></span><span>
</span><span id="line-699"></span><span>    </span><span class="annot"><span class="">[C.cstm|$id:res = $id:op(&amp;(($ty:cast)$exp:arr')[$exp:ind'],
                ($ty:cast)&amp;$id:old,
                 $exp:new_val',
                 0, __ATOMIC_SEQ_CST, __ATOMIC_RELAXED);|]</span></span><span>
</span><span id="line-703"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-704"></span><span>    </span><span class="annot"><a href="#local-6989586621684534968"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-705"></span><span>    </span><span id="local-6989586621684534968"><span class="annot"><span class="annottext">op :: [Char]
</span><a href="#local-6989586621684534968"><span class="hs-identifier hs-var hs-var">op</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;__atomic_compare_exchange_n&quot;</span></span><span>
</span><span id="line-706"></span><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#atomicOps"><span class="hs-identifier hs-var">atomicOps</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.Multicore.html#AtomicXchg"><span class="hs-identifier hs-type">AtomicXchg</span></a></span><span> </span><span id="local-6989586621684534966"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684534966"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621684534965"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684534965"><span class="hs-identifier hs-var">old</span></a></span></span><span> </span><span id="local-6989586621684534964"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684534964"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span id="local-6989586621684534963"><span class="annot"><span class="annottext">Count Elements (TExp Int32)
</span><a href="#local-6989586621684534963"><span class="hs-identifier hs-var">ind</span></a></span></span><span> </span><span id="local-6989586621684534962"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684534962"><span class="hs-identifier hs-var">val</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-707"></span><span>  </span><span id="local-6989586621684534961"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684534961"><span class="hs-identifier hs-var">ind'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; CompilerM op s Exp
forall op s. Exp -&gt; CompilerM op s Exp
</span><a href="Futhark.CodeGen.Backends.GenericC.html#compileExp"><span class="hs-identifier hs-var">GC.compileExp</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; CompilerM op s Exp) -&gt; Exp -&gt; CompilerM op s Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; Exp
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int32 -&gt; Exp) -&gt; TExp Int32 -&gt; Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Count Elements (TExp Int32) -&gt; TExp Int32
forall u e. Count u e -&gt; e
</span><a href="Futhark.IR.GPU.Sizes.html#unCount"><span class="hs-identifier hs-var hs-var">unCount</span></a></span><span> </span><span class="annot"><span class="annottext">Count Elements (TExp Int32)
</span><a href="#local-6989586621684534963"><span class="hs-identifier hs-var">ind</span></a></span><span>
</span><span id="line-708"></span><span>  </span><span id="local-6989586621684534960"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684534960"><span class="hs-identifier hs-var">val'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; CompilerM op s Exp
forall op s. Exp -&gt; CompilerM op s Exp
</span><a href="Futhark.CodeGen.Backends.GenericC.html#compileExp"><span class="hs-identifier hs-var">GC.compileExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684534962"><span class="hs-identifier hs-var">val</span></a></span><span>
</span><span id="line-709"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684534959"><span class="annot"><span class="annottext">cast :: Type
</span><a href="#local-6989586621684534959"><span class="hs-identifier hs-var hs-var">cast</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="">[C.cty|$ty:(GC.primTypeToCType t)*|]</span></span><span>
</span><span id="line-710"></span><span>  </span><span class="annot"><span class="annottext">Stm -&gt; CompilerM op s ()
forall op s. Stm -&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.GenericC.html#stm"><span class="hs-identifier hs-var">GC.stm</span></a></span><span> </span><span class="annot"><span class="">[C.cstm|$id:old = $id:op(&amp;(($ty:cast)$id:arr.mem)[$exp:ind'], $exp:val', __ATOMIC_SEQ_CST);|]</span></span><span>
</span><span id="line-711"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-712"></span><span>    </span><span class="annot"><a href="#local-6989586621684534953"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-713"></span><span>    </span><span id="local-6989586621684534953"><span class="annot"><span class="annottext">op :: [Char]
</span><a href="#local-6989586621684534953"><span class="hs-identifier hs-var hs-var">op</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;__atomic_exchange_n&quot;</span></span><span>
</span><span id="line-714"></span><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#atomicOps"><span class="hs-identifier hs-var">atomicOps</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.Multicore.html#AtomicAdd"><span class="hs-identifier hs-type">AtomicAdd</span></a></span><span> </span><span id="local-6989586621684534951"><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684534951"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621684534950"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684534950"><span class="hs-identifier hs-var">old</span></a></span></span><span> </span><span id="local-6989586621684534949"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684534949"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span id="local-6989586621684534948"><span class="annot"><span class="annottext">Count Elements (TExp Int32)
</span><a href="#local-6989586621684534948"><span class="hs-identifier hs-var">ind</span></a></span></span><span> </span><span id="local-6989586621684534947"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684534947"><span class="hs-identifier hs-var">val</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-715"></span><span>  </span><span class="annot"><span class="annottext">VName
-&gt; VName
-&gt; Count Elements (TExp Int32)
-&gt; Exp
-&gt; [Char]
-&gt; Type
-&gt; CompilerM op s ()
forall a1 u op s.
ToIdent a1 =&gt;
a1
-&gt; VName
-&gt; Count u (TExp Int32)
-&gt; Exp
-&gt; [Char]
-&gt; Type
-&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#doAtomic"><span class="hs-identifier hs-var">doAtomic</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684534950"><span class="hs-identifier hs-var">old</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684534949"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">Count Elements (TExp Int32)
</span><a href="#local-6989586621684534948"><span class="hs-identifier hs-var">ind</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684534947"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;__atomic_fetch_add&quot;</span></span><span> </span><span class="annot"><span class="">[C.cty|$ty:(GC.intTypeToCType t)|]</span></span><span>
</span><span id="line-716"></span><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#atomicOps"><span class="hs-identifier hs-var">atomicOps</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.Multicore.html#AtomicSub"><span class="hs-identifier hs-type">AtomicSub</span></a></span><span> </span><span id="local-6989586621684534939"><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684534939"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621684534938"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684534938"><span class="hs-identifier hs-var">old</span></a></span></span><span> </span><span id="local-6989586621684534937"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684534937"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span id="local-6989586621684534936"><span class="annot"><span class="annottext">Count Elements (TExp Int32)
</span><a href="#local-6989586621684534936"><span class="hs-identifier hs-var">ind</span></a></span></span><span> </span><span id="local-6989586621684534935"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684534935"><span class="hs-identifier hs-var">val</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-717"></span><span>  </span><span class="annot"><span class="annottext">VName
-&gt; VName
-&gt; Count Elements (TExp Int32)
-&gt; Exp
-&gt; [Char]
-&gt; Type
-&gt; CompilerM op s ()
forall a1 u op s.
ToIdent a1 =&gt;
a1
-&gt; VName
-&gt; Count u (TExp Int32)
-&gt; Exp
-&gt; [Char]
-&gt; Type
-&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#doAtomic"><span class="hs-identifier hs-var">doAtomic</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684534938"><span class="hs-identifier hs-var">old</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684534937"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">Count Elements (TExp Int32)
</span><a href="#local-6989586621684534936"><span class="hs-identifier hs-var">ind</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684534935"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;__atomic_fetch_sub&quot;</span></span><span> </span><span class="annot"><span class="">[C.cty|$ty:(GC.intTypeToCType t)|]</span></span><span>
</span><span id="line-718"></span><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#atomicOps"><span class="hs-identifier hs-var">atomicOps</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.Multicore.html#AtomicAnd"><span class="hs-identifier hs-type">AtomicAnd</span></a></span><span> </span><span id="local-6989586621684534928"><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684534928"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621684534927"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684534927"><span class="hs-identifier hs-var">old</span></a></span></span><span> </span><span id="local-6989586621684534926"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684534926"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span id="local-6989586621684534925"><span class="annot"><span class="annottext">Count Elements (TExp Int32)
</span><a href="#local-6989586621684534925"><span class="hs-identifier hs-var">ind</span></a></span></span><span> </span><span id="local-6989586621684534924"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684534924"><span class="hs-identifier hs-var">val</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-719"></span><span>  </span><span class="annot"><span class="annottext">VName
-&gt; VName
-&gt; Count Elements (TExp Int32)
-&gt; Exp
-&gt; [Char]
-&gt; Type
-&gt; CompilerM op s ()
forall a1 u op s.
ToIdent a1 =&gt;
a1
-&gt; VName
-&gt; Count u (TExp Int32)
-&gt; Exp
-&gt; [Char]
-&gt; Type
-&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#doAtomic"><span class="hs-identifier hs-var">doAtomic</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684534927"><span class="hs-identifier hs-var">old</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684534926"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">Count Elements (TExp Int32)
</span><a href="#local-6989586621684534925"><span class="hs-identifier hs-var">ind</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684534924"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;__atomic_fetch_and&quot;</span></span><span> </span><span class="annot"><span class="">[C.cty|$ty:(GC.intTypeToCType t)|]</span></span><span>
</span><span id="line-720"></span><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#atomicOps"><span class="hs-identifier hs-var">atomicOps</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.Multicore.html#AtomicOr"><span class="hs-identifier hs-type">AtomicOr</span></a></span><span> </span><span id="local-6989586621684534917"><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684534917"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621684534916"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684534916"><span class="hs-identifier hs-var">old</span></a></span></span><span> </span><span id="local-6989586621684534915"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684534915"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span id="local-6989586621684534914"><span class="annot"><span class="annottext">Count Elements (TExp Int32)
</span><a href="#local-6989586621684534914"><span class="hs-identifier hs-var">ind</span></a></span></span><span> </span><span id="local-6989586621684534913"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684534913"><span class="hs-identifier hs-var">val</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-721"></span><span>  </span><span class="annot"><span class="annottext">VName
-&gt; VName
-&gt; Count Elements (TExp Int32)
-&gt; Exp
-&gt; [Char]
-&gt; Type
-&gt; CompilerM op s ()
forall a1 u op s.
ToIdent a1 =&gt;
a1
-&gt; VName
-&gt; Count u (TExp Int32)
-&gt; Exp
-&gt; [Char]
-&gt; Type
-&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#doAtomic"><span class="hs-identifier hs-var">doAtomic</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684534916"><span class="hs-identifier hs-var">old</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684534915"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">Count Elements (TExp Int32)
</span><a href="#local-6989586621684534914"><span class="hs-identifier hs-var">ind</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684534913"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;__atomic_fetch_or&quot;</span></span><span> </span><span class="annot"><span class="">[C.cty|$ty:(GC.intTypeToCType t)|]</span></span><span>
</span><span id="line-722"></span><span class="annot"><a href="Futhark.CodeGen.Backends.MulticoreC.html#atomicOps"><span class="hs-identifier hs-var">atomicOps</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.Multicore.html#AtomicXor"><span class="hs-identifier hs-type">AtomicXor</span></a></span><span> </span><span id="local-6989586621684534906"><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684534906"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621684534905"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684534905"><span class="hs-identifier hs-var">old</span></a></span></span><span> </span><span id="local-6989586621684534904"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684534904"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span id="local-6989586621684534903"><span class="annot"><span class="annottext">Count Elements (TExp Int32)
</span><a href="#local-6989586621684534903"><span class="hs-identifier hs-var">ind</span></a></span></span><span> </span><span id="local-6989586621684534902"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684534902"><span class="hs-identifier hs-var">val</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-723"></span><span>  </span><span class="annot"><span class="annottext">VName
-&gt; VName
-&gt; Count Elements (TExp Int32)
-&gt; Exp
-&gt; [Char]
-&gt; Type
-&gt; CompilerM op s ()
forall a1 u op s.
ToIdent a1 =&gt;
a1
-&gt; VName
-&gt; Count u (TExp Int32)
-&gt; Exp
-&gt; [Char]
-&gt; Type
-&gt; CompilerM op s ()
</span><a href="Futhark.CodeGen.Backends.MulticoreC.html#doAtomic"><span class="hs-identifier hs-var">doAtomic</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684534905"><span class="hs-identifier hs-var">old</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684534904"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">Count Elements (TExp Int32)
</span><a href="#local-6989586621684534903"><span class="hs-identifier hs-var">ind</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684534902"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;__atomic_fetch_xor&quot;</span></span><span> </span><span class="annot"><span class="">[C.cty|$ty:(GC.intTypeToCType t)|]</span></span><span>
</span><span id="line-724"></span></pre></body></html>