<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-3"></span><span>
</span><span id="line-4"></span><span class="hs-comment">-- | Tries to turn a generalized reduction kernel into</span><span>
</span><span id="line-5"></span><span class="hs-comment">--     a more specialized construct, for example:</span><span>
</span><span id="line-6"></span><span class="hs-comment">--       (a) a map nest with a sequential redomap ripe for tiling</span><span>
</span><span id="line-7"></span><span class="hs-comment">--       (b) a SegRed kernel followed by a smallish accumulation kernel.</span><span>
</span><span id="line-8"></span><span class="hs-comment">--       (c) a histogram (for this we need to track the withAccs)</span><span>
</span><span id="line-9"></span><span class="hs-comment">--   The idea is to identify the first accumulation and</span><span>
</span><span id="line-10"></span><span class="hs-comment">--     to separate the initial kernels into two:</span><span>
</span><span id="line-11"></span><span class="hs-comment">--     1. the code up to and including the accumulation,</span><span>
</span><span id="line-12"></span><span class="hs-comment">--        which is optimized to turn the accumulation either</span><span>
</span><span id="line-13"></span><span class="hs-comment">--        into a map-reduce composition or a histogram, and</span><span>
</span><span id="line-14"></span><span class="hs-comment">--     2. the remaining code, which is recursively optimized.</span><span>
</span><span id="line-15"></span><span class="hs-comment">--   Since this is mostly prototyping, when the accumulation</span><span>
</span><span id="line-16"></span><span class="hs-comment">--     can be rewritten as a map-reduce, we sequentialize the</span><span>
</span><span id="line-17"></span><span class="hs-comment">--     map-reduce, as to potentially enable tiling oportunities.</span><span>
</span><span id="line-18"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Futhark.Optimise.GenRedOpt</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#optimiseGenRed"><span class="hs-identifier">optimiseGenRed</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-19"></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Reader</span></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.State</span></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">L</span></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map.Strict</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Builder.html"><span class="hs-identifier">Futhark.Builder</span></a></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html"><span class="hs-identifier">Futhark.IR.GPU</span></a></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Optimise.TileLoops.Shared.html"><span class="hs-identifier">Futhark.Optimise.TileLoops.Shared</span></a></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Pass.html"><span class="hs-identifier">Futhark.Pass</span></a></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Tools.html"><span class="hs-identifier">Futhark.Tools</span></a></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Transform.Rename.html"><span class="hs-identifier">Futhark.Transform.Rename</span></a></span><span>
</span><span id="line-31"></span><span>
</span><span id="line-32"></span><span class="hs-comment">--import Debug.Trace</span><span>
</span><span id="line-33"></span><span>
</span><span id="line-34"></span><span class="hs-keyword">type</span><span> </span><span id="GenRedM"><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#GenRedM"><span class="hs-identifier hs-var">GenRedM</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ReaderT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">State</span></span><span> </span><span class="annot"><a href="Futhark.FreshNames.html#VNameSource"><span class="hs-identifier hs-type">VNameSource</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span>
</span><span id="line-36"></span><span class="hs-comment">-- | The pass definition.</span><span>
</span><span id="line-37"></span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#optimiseGenRed"><span class="hs-identifier hs-type">optimiseGenRed</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Pass.html#Pass"><span class="hs-identifier hs-type">Pass</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span>
</span><span id="line-38"></span><span id="optimiseGenRed"><span class="annot"><span class="annottext">optimiseGenRed :: Pass GPU GPU
</span><a href="Futhark.Optimise.GenRedOpt.html#optimiseGenRed"><span class="hs-identifier hs-var hs-var">optimiseGenRed</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-39"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; String -&gt; (Prog GPU -&gt; PassM (Prog GPU)) -&gt; Pass GPU GPU
forall fromrep torep.
String
-&gt; String
-&gt; (Prog fromrep -&gt; PassM (Prog torep))
-&gt; Pass fromrep torep
</span><a href="Futhark.Pass.html#Pass"><span class="hs-identifier hs-var">Pass</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;optimise generalized reductions&quot;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Specializes generalized reductions into map-reductions or histograms&quot;</span></span><span> </span><span class="annot"><span class="annottext">((Prog GPU -&gt; PassM (Prog GPU)) -&gt; Pass GPU GPU)
-&gt; (Prog GPU -&gt; PassM (Prog GPU)) -&gt; Pass GPU GPU
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-40"></span><span>    </span><span class="annot"><span class="annottext">(Scope GPU -&gt; Stms GPU -&gt; PassM (Stms GPU))
-&gt; Prog GPU -&gt; PassM (Prog GPU)
forall rep.
(Scope rep -&gt; Stms rep -&gt; PassM (Stms rep))
-&gt; Prog rep -&gt; PassM (Prog rep)
</span><a href="Futhark.Pass.html#intraproceduralTransformation"><span class="hs-identifier hs-var">intraproceduralTransformation</span></a></span><span> </span><span class="annot"><span class="annottext">Scope GPU -&gt; Stms GPU -&gt; PassM (Stms GPU)
forall {m :: * -&gt; *}.
MonadFreshNames m =&gt;
Scope GPU -&gt; Stms GPU -&gt; m (Stms GPU)
</span><a href="#local-6989586621684430285"><span class="hs-identifier hs-var">onStms</span></a></span><span>
</span><span id="line-41"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-42"></span><span>    </span><span id="local-6989586621684430285"><span class="annot"><span class="annottext">onStms :: Scope GPU -&gt; Stms GPU -&gt; m (Stms GPU)
</span><a href="#local-6989586621684430285"><span class="hs-identifier hs-var hs-var">onStms</span></a></span></span><span> </span><span id="local-6989586621684430282"><span class="annot"><span class="annottext">Scope GPU
</span><a href="#local-6989586621684430282"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span id="local-6989586621684430281"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684430281"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-43"></span><span>      </span><span class="annot"><span class="annottext">(VNameSource -&gt; (Stms GPU, VNameSource)) -&gt; m (Stms GPU)
forall (m :: * -&gt; *) a.
MonadFreshNames m =&gt;
(VNameSource -&gt; (a, VNameSource)) -&gt; m a
</span><a href="Futhark.MonadFreshNames.html#modifyNameSource"><span class="hs-identifier hs-var">modifyNameSource</span></a></span><span> </span><span class="annot"><span class="annottext">((VNameSource -&gt; (Stms GPU, VNameSource)) -&gt; m (Stms GPU))
-&gt; (VNameSource -&gt; (Stms GPU, VNameSource)) -&gt; m (Stms GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-44"></span><span>        </span><span class="annot"><span class="annottext">State VNameSource (Stms GPU)
-&gt; VNameSource -&gt; (Stms GPU, VNameSource)
forall s a. State s a -&gt; s -&gt; (a, s)
</span><span class="hs-identifier hs-var">runState</span></span><span> </span><span class="annot"><span class="annottext">(State VNameSource (Stms GPU)
 -&gt; VNameSource -&gt; (Stms GPU, VNameSource))
-&gt; State VNameSource (Stms GPU)
-&gt; VNameSource
-&gt; (Stms GPU, VNameSource)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-45"></span><span>          </span><span class="annot"><span class="annottext">ReaderT (Scope GPU) (State VNameSource) (Stms GPU)
-&gt; Scope GPU -&gt; State VNameSource (Stms GPU)
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var hs-var">runReaderT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Env
-&gt; Stms GPU -&gt; ReaderT (Scope GPU) (State VNameSource) (Stms GPU)
</span><a href="Futhark.Optimise.GenRedOpt.html#optimiseStms"><span class="hs-identifier hs-var">optimiseStms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WithEnv
forall k a. Map k a
</span><span class="hs-identifier hs-var">M.empty</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map VName IxFun
forall k a. Map k a
</span><span class="hs-identifier hs-var">M.empty</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684430281"><span class="hs-identifier hs-var">stms</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Scope GPU
</span><a href="#local-6989586621684430282"><span class="hs-identifier hs-var">scope</span></a></span><span>
</span><span id="line-46"></span><span>
</span><span id="line-47"></span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#optimiseBody"><span class="hs-identifier hs-type">optimiseBody</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.TileLoops.Shared.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#GenRedM"><span class="hs-identifier hs-type">GenRedM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-48"></span><span id="optimiseBody"><span class="annot"><span class="annottext">optimiseBody :: Env -&gt; Body GPU -&gt; GenRedM (Body GPU)
</span><a href="Futhark.Optimise.GenRedOpt.html#optimiseBody"><span class="hs-identifier hs-var hs-var">optimiseBody</span></a></span></span><span> </span><span id="local-6989586621684430274"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684430274"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span id="local-6989586621684430272"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684430272"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span id="local-6989586621684430271"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684430271"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-49"></span><span>  </span><span class="annot"><span class="annottext">BodyDec GPU -&gt; Stms GPU -&gt; Result -&gt; Body GPU
forall rep. BodyDec rep -&gt; Stms rep -&gt; Result -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-var">Body</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Stms GPU -&gt; Result -&gt; Body GPU)
-&gt; ReaderT (Scope GPU) (State VNameSource) (Stms GPU)
-&gt; ReaderT (Scope GPU) (State VNameSource) (Result -&gt; Body GPU)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Env
-&gt; Stms GPU -&gt; ReaderT (Scope GPU) (State VNameSource) (Stms GPU)
</span><a href="Futhark.Optimise.GenRedOpt.html#optimiseStms"><span class="hs-identifier hs-var">optimiseStms</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684430274"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684430272"><span class="hs-identifier hs-var">stms</span></a></span><span> </span><span class="annot"><span class="annottext">ReaderT (Scope GPU) (State VNameSource) (Result -&gt; Body GPU)
-&gt; ReaderT (Scope GPU) (State VNameSource) Result
-&gt; GenRedM (Body GPU)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Result -&gt; ReaderT (Scope GPU) (State VNameSource) Result
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684430271"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-50"></span><span>
</span><span id="line-51"></span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#optimiseStms"><span class="hs-identifier hs-type">optimiseStms</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.TileLoops.Shared.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#GenRedM"><span class="hs-identifier hs-type">GenRedM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span id="optimiseStms"><span class="annot"><span class="annottext">optimiseStms :: Env
-&gt; Stms GPU -&gt; ReaderT (Scope GPU) (State VNameSource) (Stms GPU)
</span><a href="Futhark.Optimise.GenRedOpt.html#optimiseStms"><span class="hs-identifier hs-var hs-var">optimiseStms</span></a></span></span><span> </span><span id="local-6989586621684430269"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684430269"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621684430268"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684430268"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-53"></span><span>  </span><span class="annot"><span class="annottext">Scope GPU
-&gt; ReaderT (Scope GPU) (State VNameSource) (Stms GPU)
-&gt; ReaderT (Scope GPU) (State VNameSource) (Stms GPU)
forall rep (m :: * -&gt; *) a.
LocalScope rep m =&gt;
Scope rep -&gt; m a -&gt; m a
</span><a href="Futhark.IR.Prop.Scope.html#localScope"><span class="hs-identifier hs-var">localScope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms GPU -&gt; Scope GPU
forall rep a. Scoped rep a =&gt; a -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOf"><span class="hs-identifier hs-var">scopeOf</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684430268"><span class="hs-identifier hs-var">stms</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ReaderT (Scope GPU) (State VNameSource) (Stms GPU)
 -&gt; ReaderT (Scope GPU) (State VNameSource) (Stms GPU))
-&gt; ReaderT (Scope GPU) (State VNameSource) (Stms GPU)
-&gt; ReaderT (Scope GPU) (State VNameSource) (Stms GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-54"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Env
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684430265"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684430265"><span class="hs-identifier hs-var">stms'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((Env, Stms GPU)
 -&gt; Stm GPU
 -&gt; ReaderT (Scope GPU) (State VNameSource) (Env, Stms GPU))
-&gt; (Env, Stms GPU)
-&gt; [Stm GPU]
-&gt; ReaderT (Scope GPU) (State VNameSource) (Env, Stms GPU)
forall (t :: * -&gt; *) (m :: * -&gt; *) b a.
(Foldable t, Monad m) =&gt;
(b -&gt; a -&gt; m b) -&gt; b -&gt; t a -&gt; m b
</span><span class="hs-identifier hs-var">foldM</span></span><span> </span><span class="annot"><span class="annottext">(Env, Stms GPU)
-&gt; Stm GPU
-&gt; ReaderT (Scope GPU) (State VNameSource) (Env, Stms GPU)
</span><a href="#local-6989586621684430263"><span class="hs-identifier hs-var">foldfun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684430269"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stms GPU
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Stm GPU]
 -&gt; ReaderT (Scope GPU) (State VNameSource) (Env, Stms GPU))
-&gt; [Stm GPU]
-&gt; ReaderT (Scope GPU) (State VNameSource) (Env, Stms GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stms GPU -&gt; [Stm GPU]
forall rep. Stms rep -&gt; [Stm rep]
</span><a href="Futhark.IR.Syntax.html#stmsToList"><span class="hs-identifier hs-var">stmsToList</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684430268"><span class="hs-identifier hs-var">stms</span></a></span><span>
</span><span id="line-55"></span><span>    </span><span class="annot"><span class="annottext">Stms GPU -&gt; ReaderT (Scope GPU) (State VNameSource) (Stms GPU)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684430265"><span class="hs-identifier hs-var">stms'</span></a></span><span>
</span><span id="line-56"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-57"></span><span>    </span><span class="annot"><a href="#local-6989586621684430263"><span class="hs-identifier hs-type">foldfun</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.TileLoops.Shared.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#GenRedM"><span class="hs-identifier hs-type">GenRedM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.TileLoops.Shared.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-58"></span><span>    </span><span id="local-6989586621684430263"><span class="annot"><span class="annottext">foldfun :: (Env, Stms GPU)
-&gt; Stm GPU
-&gt; ReaderT (Scope GPU) (State VNameSource) (Env, Stms GPU)
</span><a href="#local-6989586621684430263"><span class="hs-identifier hs-var hs-var">foldfun</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684430261"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684430261"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684430260"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684430260"><span class="hs-identifier hs-var">ss</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684430259"><span class="annot"><span class="annottext">Stm GPU
</span><a href="#local-6989586621684430259"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-59"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684430258"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684430258"><span class="hs-identifier hs-var">e'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684430257"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684430257"><span class="hs-identifier hs-var">s'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Env
-&gt; Stm GPU
-&gt; ReaderT (Scope GPU) (State VNameSource) (Env, Stms GPU)
</span><a href="Futhark.Optimise.GenRedOpt.html#optimiseStm"><span class="hs-identifier hs-var">optimiseStm</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684430261"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">Stm GPU
</span><a href="#local-6989586621684430259"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-60"></span><span>      </span><span class="annot"><span class="annottext">(Env, Stms GPU)
-&gt; ReaderT (Scope GPU) (State VNameSource) (Env, Stms GPU)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684430258"><span class="hs-identifier hs-var">e'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684430260"><span class="hs-identifier hs-var">ss</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPU -&gt; Stms GPU -&gt; Stms GPU
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684430257"><span class="hs-identifier hs-var">s'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-61"></span><span>
</span><span id="line-62"></span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#optimiseStm"><span class="hs-identifier hs-type">optimiseStm</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.TileLoops.Shared.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#GenRedM"><span class="hs-identifier hs-type">GenRedM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.TileLoops.Shared.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-63"></span><span id="optimiseStm"><span class="annot"><span class="annottext">optimiseStm :: Env
-&gt; Stm GPU
-&gt; ReaderT (Scope GPU) (State VNameSource) (Env, Stms GPU)
</span><a href="Futhark.Optimise.GenRedOpt.html#optimiseStm"><span class="hs-identifier hs-var hs-var">optimiseStm</span></a></span></span><span> </span><span id="local-6989586621684430255"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684430255"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621684430254"><span class="annot"><span class="annottext">stm :: Stm GPU
</span><a href="#local-6989586621684430254"><span class="hs-identifier hs-var">stm</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPU
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec GPU)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SegOp"><span class="hs-identifier hs-type">SegOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#SegMap"><span class="hs-identifier hs-type">SegMap</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SegThread"><span class="hs-identifier hs-type">SegThread</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">KernelBody GPU
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-64"></span><span>  </span><span id="local-6989586621684430248"><span class="annot"><span class="annottext">Maybe (Stms GPU)
</span><a href="#local-6989586621684430248"><span class="hs-identifier hs-var">res_genred_opt</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Env -&gt; Stm GPU -&gt; GenRedM (Maybe (Stms GPU))
</span><a href="Futhark.Optimise.GenRedOpt.html#genRedOpts"><span class="hs-identifier hs-var">genRedOpts</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684430255"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Stm GPU
</span><a href="#local-6989586621684430254"><span class="hs-identifier hs-var">stm</span></a></span><span>
</span><span id="line-65"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684430246"><span class="annot"><span class="annottext">stms' :: Stms GPU
</span><a href="#local-6989586621684430246"><span class="hs-identifier hs-var hs-var">stms'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-66"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (Stms GPU)
</span><a href="#local-6989586621684430248"><span class="hs-identifier hs-var">res_genred_opt</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-67"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684430245"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684430245"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684430245"><span class="hs-identifier hs-var">stms</span></a></span><span>
</span><span id="line-68"></span><span>          </span><span class="annot"><span class="annottext">Maybe (Stms GPU)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Stm GPU -&gt; Stms GPU
forall rep. Stm rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#oneStm"><span class="hs-identifier hs-var">oneStm</span></a></span><span> </span><span class="annot"><span class="annottext">Stm GPU
</span><a href="#local-6989586621684430254"><span class="hs-identifier hs-var">stm</span></a></span><span>
</span><span id="line-69"></span><span>  </span><span class="annot"><span class="annottext">(Env, Stms GPU)
-&gt; ReaderT (Scope GPU) (State VNameSource) (Env, Stms GPU)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684430255"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684430246"><span class="hs-identifier hs-var">stms'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#optimiseStm"><span class="hs-identifier hs-var">optimiseStm</span></a></span><span> </span><span id="local-6989586621684430243"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684430243"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684430242"><span class="annot"><span class="annottext">Pat GPU
</span><a href="#local-6989586621684430242"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684430241"><span class="annot"><span class="annottext">StmAux (ExpDec GPU)
</span><a href="#local-6989586621684430241"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span id="local-6989586621684430240"><span class="annot"><span class="annottext">ExpT GPU
</span><a href="#local-6989586621684430240"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-71"></span><span>  </span><span id="local-6989586621684430239"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684430239"><span class="hs-identifier hs-var">env'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Env -&gt; VName -&gt; ExpT GPU -&gt; TileM Env
</span><a href="Futhark.Optimise.TileLoops.Shared.html#changeEnv"><span class="hs-identifier hs-var">changeEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684430243"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; VName
forall a. [a] -&gt; a
</span><span class="hs-identifier hs-var">head</span></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; VName) -&gt; [VName] -&gt; VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatT Type -&gt; [VName]
forall dec. PatT dec -&gt; [VName]
</span><a href="Futhark.IR.Prop.Patterns.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="annot"><span class="annottext">PatT Type
Pat GPU
</span><a href="#local-6989586621684430242"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ExpT GPU
</span><a href="#local-6989586621684430240"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-72"></span><span>  </span><span id="local-6989586621684430235"><span class="annot"><span class="annottext">ExpT GPU
</span><a href="#local-6989586621684430235"><span class="hs-identifier hs-var">e'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Mapper GPU GPU (ReaderT (Scope GPU) (State VNameSource))
-&gt; ExpT GPU -&gt; ReaderT (Scope GPU) (State VNameSource) (ExpT GPU)
forall (m :: * -&gt; *) frep trep.
(Applicative m, Monad m) =&gt;
Mapper frep trep m -&gt; Exp frep -&gt; m (Exp trep)
</span><a href="Futhark.IR.Traversals.html#mapExpM"><span class="hs-identifier hs-var">mapExpM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Env -&gt; Mapper GPU GPU (ReaderT (Scope GPU) (State VNameSource))
</span><a href="#local-6989586621684430233"><span class="hs-identifier hs-var">optimise</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684430239"><span class="hs-identifier hs-var">env'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ExpT GPU
</span><a href="#local-6989586621684430240"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-73"></span><span>  </span><span class="annot"><span class="annottext">(Env, Stms GPU)
-&gt; ReaderT (Scope GPU) (State VNameSource) (Env, Stms GPU)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684430239"><span class="hs-identifier hs-var">env'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stm GPU -&gt; Stms GPU
forall rep. Stm rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#oneStm"><span class="hs-identifier hs-var">oneStm</span></a></span><span> </span><span class="annot"><span class="annottext">(Stm GPU -&gt; Stms GPU) -&gt; Stm GPU -&gt; Stms GPU
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat GPU -&gt; StmAux (ExpDec GPU) -&gt; ExpT GPU -&gt; Stm GPU
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPU
</span><a href="#local-6989586621684430242"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec GPU)
</span><a href="#local-6989586621684430241"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">ExpT GPU
</span><a href="#local-6989586621684430235"><span class="hs-identifier hs-var">e'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-74"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-75"></span><span>    </span><span id="local-6989586621684430233"><span class="annot"><span class="annottext">optimise :: Env -&gt; Mapper GPU GPU (ReaderT (Scope GPU) (State VNameSource))
</span><a href="#local-6989586621684430233"><span class="hs-identifier hs-var hs-var">optimise</span></a></span></span><span> </span><span id="local-6989586621684430225"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684430225"><span class="hs-identifier hs-var">env'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Mapper GPU GPU (ReaderT (Scope GPU) (State VNameSource))
forall (m :: * -&gt; *) rep. Monad m =&gt; Mapper rep rep m
</span><a href="Futhark.IR.Traversals.html#identityMapper"><span class="hs-identifier hs-var">identityMapper</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">mapOnBody :: Scope GPU -&gt; Body GPU -&gt; GenRedM (Body GPU)
</span><a href="Futhark.IR.Traversals.html#mapOnBody"><span class="hs-identifier hs-var">mapOnBody</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684430222"><span class="annot"><span class="annottext">Scope GPU
</span><a href="#local-6989586621684430222"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Scope GPU -&gt; GenRedM (Body GPU) -&gt; GenRedM (Body GPU)
forall rep (m :: * -&gt; *) a.
LocalScope rep m =&gt;
Scope rep -&gt; m a -&gt; m a
</span><a href="Futhark.IR.Prop.Scope.html#localScope"><span class="hs-identifier hs-var">localScope</span></a></span><span> </span><span class="annot"><span class="annottext">Scope GPU
</span><a href="#local-6989586621684430222"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="annot"><span class="annottext">(GenRedM (Body GPU) -&gt; GenRedM (Body GPU))
-&gt; (Body GPU -&gt; GenRedM (Body GPU))
-&gt; Body GPU
-&gt; GenRedM (Body GPU)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Env -&gt; Body GPU -&gt; GenRedM (Body GPU)
</span><a href="Futhark.Optimise.GenRedOpt.html#optimiseBody"><span class="hs-identifier hs-var">optimiseBody</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684430225"><span class="hs-identifier hs-var">env'</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-76"></span><span>
</span><span id="line-77"></span><span class="hs-comment">------------------------</span><span>
</span><span id="line-78"></span><span>
</span><span id="line-79"></span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#genRedOpts"><span class="hs-identifier hs-type">genRedOpts</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.TileLoops.Shared.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#GenRedM"><span class="hs-identifier hs-type">GenRedM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-80"></span><span id="genRedOpts"><span class="annot"><span class="annottext">genRedOpts :: Env -&gt; Stm GPU -&gt; GenRedM (Maybe (Stms GPU))
</span><a href="Futhark.Optimise.GenRedOpt.html#genRedOpts"><span class="hs-identifier hs-var hs-var">genRedOpts</span></a></span></span><span> </span><span id="local-6989586621684430220"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684430220"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621684430219"><span class="annot"><span class="annottext">Stm GPU
</span><a href="#local-6989586621684430219"><span class="hs-identifier hs-var">ker</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-81"></span><span>  </span><span id="local-6989586621684430218"><span class="annot"><span class="annottext">Maybe (Stms GPU, Stm GPU)
</span><a href="#local-6989586621684430218"><span class="hs-identifier hs-var">res_tile</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Env -&gt; Stm GPU -&gt; GenRedM (Maybe (Stms GPU, Stm GPU))
</span><a href="Futhark.Optimise.GenRedOpt.html#genRed2Tile2d"><span class="hs-identifier hs-var">genRed2Tile2d</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684430220"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Stm GPU
</span><a href="#local-6989586621684430219"><span class="hs-identifier hs-var">ker</span></a></span><span>
</span><span id="line-82"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (Stms GPU, Stm GPU)
</span><a href="#local-6989586621684430218"><span class="hs-identifier hs-var">res_tile</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-83"></span><span>    </span><span class="annot"><span class="annottext">Maybe (Stms GPU, Stm GPU)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-84"></span><span>      </span><span id="local-6989586621684430216"><span class="annot"><span class="annottext">Maybe (Stms GPU, Stm GPU)
</span><a href="#local-6989586621684430216"><span class="hs-identifier hs-var">res_sgrd</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Env -&gt; Stm GPU -&gt; GenRedM (Maybe (Stms GPU, Stm GPU))
</span><a href="Futhark.Optimise.GenRedOpt.html#genRed2SegRed"><span class="hs-identifier hs-var">genRed2SegRed</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684430220"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Stm GPU
</span><a href="#local-6989586621684430219"><span class="hs-identifier hs-var">ker</span></a></span><span>
</span><span id="line-85"></span><span>      </span><span class="annot"><span class="annottext">Maybe (Stms GPU, Stm GPU) -&gt; GenRedM (Maybe (Stms GPU))
</span><a href="#local-6989586621684430214"><span class="hs-identifier hs-var">helperGenRed</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Stms GPU, Stm GPU)
</span><a href="#local-6989586621684430216"><span class="hs-identifier hs-var">res_sgrd</span></a></span><span>
</span><span id="line-86"></span><span>    </span><span class="annot"><span class="annottext">Maybe (Stms GPU, Stm GPU)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (Stms GPU, Stm GPU) -&gt; GenRedM (Maybe (Stms GPU))
</span><a href="#local-6989586621684430214"><span class="hs-identifier hs-var">helperGenRed</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Stms GPU, Stm GPU)
</span><a href="#local-6989586621684430218"><span class="hs-identifier hs-var">res_tile</span></a></span><span>
</span><span id="line-87"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-88"></span><span>    </span><span id="local-6989586621684430214"><span class="annot"><span class="annottext">helperGenRed :: Maybe (Stms GPU, Stm GPU) -&gt; GenRedM (Maybe (Stms GPU))
</span><a href="#local-6989586621684430214"><span class="hs-identifier hs-var hs-var">helperGenRed</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe (Stms GPU, Stm GPU)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (Stms GPU) -&gt; GenRedM (Maybe (Stms GPU))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Stms GPU)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-89"></span><span>    </span><span class="annot"><a href="#local-6989586621684430214"><span class="hs-identifier hs-var">helperGenRed</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684430213"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684430213"><span class="hs-identifier hs-var">stms_before</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684430212"><span class="annot"><span class="annottext">Stm GPU
</span><a href="#local-6989586621684430212"><span class="hs-identifier hs-var">ker_snd</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-90"></span><span>      </span><span id="local-6989586621684430211"><span class="annot"><span class="annottext">Maybe (Stms GPU)
</span><a href="#local-6989586621684430211"><span class="hs-identifier hs-var">mb_stms_after</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Env -&gt; Stm GPU -&gt; GenRedM (Maybe (Stms GPU))
</span><a href="Futhark.Optimise.GenRedOpt.html#genRedOpts"><span class="hs-identifier hs-var">genRedOpts</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684430220"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Stm GPU
</span><a href="#local-6989586621684430212"><span class="hs-identifier hs-var">ker_snd</span></a></span><span>
</span><span id="line-91"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (Stms GPU)
</span><a href="#local-6989586621684430211"><span class="hs-identifier hs-var">mb_stms_after</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-92"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684430210"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684430210"><span class="hs-identifier hs-var">stms_after</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (Stms GPU) -&gt; GenRedM (Maybe (Stms GPU))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (Stms GPU) -&gt; GenRedM (Maybe (Stms GPU)))
-&gt; Maybe (Stms GPU) -&gt; GenRedM (Maybe (Stms GPU))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stms GPU -&gt; Maybe (Stms GPU)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Stms GPU -&gt; Maybe (Stms GPU)) -&gt; Stms GPU -&gt; Maybe (Stms GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684430213"><span class="hs-identifier hs-var">stms_before</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPU -&gt; Stms GPU -&gt; Stms GPU
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684430210"><span class="hs-identifier hs-var">stms_after</span></a></span><span>
</span><span id="line-93"></span><span>        </span><span class="annot"><span class="annottext">Maybe (Stms GPU)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (Stms GPU) -&gt; GenRedM (Maybe (Stms GPU))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (Stms GPU) -&gt; GenRedM (Maybe (Stms GPU)))
-&gt; Maybe (Stms GPU) -&gt; GenRedM (Maybe (Stms GPU))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stms GPU -&gt; Maybe (Stms GPU)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Stms GPU -&gt; Maybe (Stms GPU)) -&gt; Stms GPU -&gt; Maybe (Stms GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684430213"><span class="hs-identifier hs-var">stms_before</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPU -&gt; Stms GPU -&gt; Stms GPU
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Stm GPU -&gt; Stms GPU
forall rep. Stm rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#oneStm"><span class="hs-identifier hs-var">oneStm</span></a></span><span> </span><span class="annot"><span class="annottext">Stm GPU
</span><a href="#local-6989586621684430212"><span class="hs-identifier hs-var">ker_snd</span></a></span><span>
</span><span id="line-94"></span><span>
</span><span id="line-95"></span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#se1"><span class="hs-identifier hs-type">se1</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span>
</span><span id="line-96"></span><span id="se1"><span class="annot"><span class="annottext">se1 :: SubExp
</span><a href="Futhark.Optimise.GenRedOpt.html#se1"><span class="hs-identifier hs-var hs-var">se1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IntType -&gt; Integer -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#intConst"><span class="hs-identifier hs-var">intConst</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">1</span></span><span>
</span><span id="line-97"></span><span>
</span><span id="line-98"></span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#genRed2Tile2d"><span class="hs-identifier hs-type">genRed2Tile2d</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.TileLoops.Shared.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#GenRedM"><span class="hs-identifier hs-type">GenRedM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-99"></span><span id="genRed2Tile2d"><span class="annot"><span class="annottext">genRed2Tile2d :: Env -&gt; Stm GPU -&gt; GenRedM (Maybe (Stms GPU, Stm GPU))
</span><a href="Futhark.Optimise.GenRedOpt.html#genRed2Tile2d"><span class="hs-identifier hs-var hs-var">genRed2Tile2d</span></a></span></span><span> </span><span id="local-6989586621684430206"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684430206"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621684430205"><span class="annot"><span class="annottext">kerstm :: Stm GPU
</span><a href="#local-6989586621684430205"><span class="hs-identifier hs-var">kerstm</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684430204"><span class="annot"><span class="annottext">Pat GPU
</span><a href="#local-6989586621684430204"><span class="hs-identifier hs-var">pat_ker</span></a></span></span><span> </span><span id="local-6989586621684430203"><span class="annot"><span class="annottext">StmAux (ExpDec GPU)
</span><a href="#local-6989586621684430203"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SegOp"><span class="hs-identifier hs-type">SegOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#SegMap"><span class="hs-identifier hs-type">SegMap</span></a></span><span> </span><span id="local-6989586621684430202"><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684430202"><span class="hs-identifier hs-var">seg_thd</span></a></span></span><span> </span><span id="local-6989586621684430201"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684430201"><span class="hs-identifier hs-var">seg_space</span></a></span></span><span> </span><span id="local-6989586621684430200"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684430200"><span class="hs-identifier hs-var">kres_tps</span></a></span></span><span> </span><span id="local-6989586621684430199"><span class="annot"><span class="annottext">KernelBody GPU
</span><a href="#local-6989586621684430199"><span class="hs-identifier hs-var">old_kbody</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-100"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SegThread"><span class="hs-identifier hs-type">SegThread</span></a></span><span> </span><span class="annot"><span class="annottext">Count NumGroups SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684430198"><span class="annot"><span class="annottext">Count GroupSize SubExp
</span><a href="#local-6989586621684430198"><span class="hs-identifier hs-var">seg_group_size</span></a></span></span><span> </span><span id="local-6989586621684430197"><span class="annot"><span class="annottext">SegVirt
</span><a href="#local-6989586621684430197"><span class="hs-identifier hs-var">_novirt</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684430202"><span class="hs-identifier hs-var">seg_thd</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-101"></span><span>    </span><span class="hs-comment">--novirt == SegNoVirtFull || novirt == SegNoVirt,</span><span>
</span><span id="line-102"></span><span>    </span><span class="annot"><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-type">KernelBody</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span id="local-6989586621684430195"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684430195"><span class="hs-identifier hs-var">kstms</span></a></span></span><span> </span><span id="local-6989586621684430194"><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684430194"><span class="hs-identifier hs-var">kres</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">KernelBody GPU
</span><a href="#local-6989586621684430199"><span class="hs-identifier hs-var">old_kbody</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-103"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684430193"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684430193"><span class="hs-identifier hs-var">css</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684430192"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684430192"><span class="hs-identifier hs-var">r_ses</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[KernelResult] -&gt; Maybe ([VName], [SubExp])
</span><a href="Futhark.Optimise.GenRedOpt.html#allGoodReturns"><span class="hs-identifier hs-var">allGoodReturns</span></a></span><span> </span><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684430194"><span class="hs-identifier hs-var">kres</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-104"></span><span>    </span><span class="annot"><span class="annottext">[VName] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684430193"><span class="hs-identifier hs-var">css</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-105"></span><span>    </span><span class="hs-comment">-- build the variance table, that records, for</span><span>
</span><span id="line-106"></span><span>    </span><span class="hs-comment">-- each variable name, the variables it depends on</span><span>
</span><span id="line-107"></span><span>    </span><span id="local-6989586621684430189"><span class="annot"><span class="annottext">VarianceTable
</span><a href="#local-6989586621684430189"><span class="hs-identifier hs-var">initial_variance</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(NameInfo Any -&gt; Names)
-&gt; Map VName (NameInfo Any) -&gt; VarianceTable
forall a b k. (a -&gt; b) -&gt; Map k a -&gt; Map k b
</span><span class="hs-identifier hs-var">M.map</span></span><span> </span><span class="annot"><span class="annottext">NameInfo Any -&gt; Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">(Map VName (NameInfo Any) -&gt; VarianceTable)
-&gt; Map VName (NameInfo Any) -&gt; VarianceTable
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; Map VName (NameInfo Any)
forall rep. SegSpace -&gt; Scope rep
</span><a href="Futhark.IR.SegOp.html#scopeOfSegSpace"><span class="hs-identifier hs-var">scopeOfSegSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684430201"><span class="hs-identifier hs-var">seg_space</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-108"></span><span>    </span><span id="local-6989586621684430186"><span class="annot"><span class="annottext">VarianceTable
</span><a href="#local-6989586621684430186"><span class="hs-identifier hs-var">variance</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VarianceTable -&gt; Stms GPU -&gt; VarianceTable
</span><a href="Futhark.Optimise.TileLoops.Shared.html#varianceInStms"><span class="hs-identifier hs-var">varianceInStms</span></a></span><span> </span><span class="annot"><span class="annottext">VarianceTable
</span><a href="#local-6989586621684430189"><span class="hs-identifier hs-var">initial_variance</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684430195"><span class="hs-identifier hs-var">kstms</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-109"></span><span>    </span><span class="hs-comment">-- check that the code fits the pattern having:</span><span>
</span><span id="line-110"></span><span>    </span><span class="hs-comment">-- some `code1`, followed by one accumulation, followed by some `code2`</span><span>
</span><span id="line-111"></span><span>    </span><span class="hs-comment">-- UpdateAcc VName [SubExp] [SubExp]</span><span>
</span><span id="line-112"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684430184"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684430184"><span class="hs-identifier hs-var">code1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684430183"><span class="annot"><span class="annottext">Stm GPU
</span><a href="#local-6989586621684430183"><span class="hs-identifier hs-var">accum_stmt</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684430182"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684430182"><span class="hs-identifier hs-var">code2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Stms GPU -&gt; (Stms GPU, Maybe (Stm GPU), Stms GPU)
</span><a href="Futhark.Optimise.GenRedOpt.html#matchCodeAccumCode"><span class="hs-identifier hs-var">matchCodeAccumCode</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684430195"><span class="hs-identifier hs-var">kstms</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-113"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684430180"><span class="annot"><span class="annottext">Pat GPU
</span><a href="#local-6989586621684430180"><span class="hs-identifier hs-var">pat_accum</span></a></span></span><span> </span><span id="local-6989586621684430179"><span class="annot"><span class="annottext">StmAux (ExpDec GPU)
</span><a href="#local-6989586621684430179"><span class="hs-identifier hs-var">_aux_acc</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#UpdateAcc"><span class="hs-identifier hs-type">UpdateAcc</span></a></span><span> </span><span id="local-6989586621684430176"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684430176"><span class="hs-identifier hs-var">acc_nm</span></a></span></span><span> </span><span id="local-6989586621684430175"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684430175"><span class="hs-identifier hs-var">acc_inds</span></a></span></span><span> </span><span id="local-6989586621684430174"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684430174"><span class="hs-identifier hs-var">acc_vals</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Stm GPU
</span><a href="#local-6989586621684430183"><span class="hs-identifier hs-var">accum_stmt</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-114"></span><span>    </span><span class="hs-special">[</span><span id="local-6989586621684430173"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684430173"><span class="hs-identifier hs-var">pat_acc_nm</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PatT Type -&gt; [VName]
forall dec. PatT dec -&gt; [VName]
</span><a href="Futhark.IR.Prop.Patterns.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="annot"><span class="annottext">PatT Type
Pat GPU
</span><a href="#local-6989586621684430180"><span class="hs-identifier hs-var">pat_accum</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-115"></span><span>    </span><span class="hs-comment">-- check that the `acc_inds` are invariant to at least one</span><span>
</span><span id="line-116"></span><span>    </span><span class="hs-comment">-- parallel kernel dimensions, and return the innermost such one:</span><span>
</span><span id="line-117"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684430172"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684430172"><span class="hs-identifier hs-var">invar_gid</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684430171"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684430171"><span class="hs-identifier hs-var">gid_ind</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Names
-&gt; SegSpace -&gt; VarianceTable -&gt; [SubExp] -&gt; Maybe (VName, Int)
</span><a href="Futhark.Optimise.GenRedOpt.html#isInvarToParDim"><span class="hs-identifier hs-var">isInvarToParDim</span></a></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684430201"><span class="hs-identifier hs-var">seg_space</span></a></span><span> </span><span class="annot"><span class="annottext">VarianceTable
</span><a href="#local-6989586621684430186"><span class="hs-identifier hs-var">variance</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684430175"><span class="hs-identifier hs-var">acc_inds</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-118"></span><span>    </span><span id="local-6989586621684430169"><span class="annot"><span class="annottext">[(VName, SubExp)]
</span><a href="#local-6989586621684430169"><span class="hs-identifier hs-var">gid_dims_new</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((VName, SubExp) -&gt; Bool) -&gt; [(VName, SubExp)] -&gt; [(VName, SubExp)]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621684430168"><span class="annot"><span class="annottext">(VName, SubExp)
</span><a href="#local-6989586621684430168"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684430172"><span class="hs-identifier hs-var">invar_gid</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; VName -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">(VName, SubExp) -&gt; VName
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">(VName, SubExp)
</span><a href="#local-6989586621684430168"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegSpace -&gt; [(VName, SubExp)]
</span><a href="Futhark.IR.SegOp.html#unSegSpace"><span class="hs-identifier hs-var hs-var">unSegSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684430201"><span class="hs-identifier hs-var">seg_space</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-119"></span><span>    </span><span class="hs-comment">-- check that all global-memory accesses in `code1` on which</span><span>
</span><span id="line-120"></span><span>    </span><span class="hs-comment">--   `accum_stmt` depends on are invariant to at least one of</span><span>
</span><span id="line-121"></span><span>    </span><span class="hs-comment">--   the remaining parallel dimensions (i.e., excluding `invar_gid`)</span><span>
</span><span id="line-122"></span><span>    </span><span class="annot"><span class="annottext">(Stm GPU -&gt; Bool) -&gt; [Stm GPU] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
-&gt; [(VName, SubExp)] -&gt; VarianceTable -&gt; VName -&gt; Stm GPU -&gt; Bool
</span><a href="#local-6989586621684430164"><span class="hs-identifier hs-var">isTileable</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684430172"><span class="hs-identifier hs-var">invar_gid</span></a></span><span> </span><span class="annot"><span class="annottext">[(VName, SubExp)]
</span><a href="#local-6989586621684430169"><span class="hs-identifier hs-var">gid_dims_new</span></a></span><span> </span><span class="annot"><span class="annottext">VarianceTable
</span><a href="#local-6989586621684430186"><span class="hs-identifier hs-var">variance</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684430173"><span class="hs-identifier hs-var">pat_acc_nm</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms GPU -&gt; [Stm GPU]
forall rep. Stms rep -&gt; [Stm rep]
</span><a href="Futhark.IR.Syntax.html#stmsToList"><span class="hs-identifier hs-var">stmsToList</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684430184"><span class="hs-identifier hs-var">code1</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-123"></span><span>    </span><span class="hs-comment">-- need to establish a cost model for the stms that would now</span><span>
</span><span id="line-124"></span><span>    </span><span class="hs-comment">--   be redundantly executed by the two kernels. If any recurence</span><span>
</span><span id="line-125"></span><span>    </span><span class="hs-comment">--   is redundant than it is a no go. Otherwise we need to look at</span><span>
</span><span id="line-126"></span><span>    </span><span class="hs-comment">--   memory accesses: if more than two are re-executed, then we</span><span>
</span><span id="line-127"></span><span>    </span><span class="hs-comment">--   should abort.</span><span>
</span><span id="line-128"></span><span>    </span><span id="local-6989586621684430163"><span class="annot"><span class="annottext">Cost
</span><a href="#local-6989586621684430163"><span class="hs-identifier hs-var">cost</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VarianceTable -&gt; VName -&gt; [SubExp] -&gt; Stms GPU -&gt; Cost
</span><a href="Futhark.Optimise.GenRedOpt.html#costRedundantExecution"><span class="hs-identifier hs-var">costRedundantExecution</span></a></span><span> </span><span class="annot"><span class="annottext">VarianceTable
</span><a href="#local-6989586621684430186"><span class="hs-identifier hs-var">variance</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684430173"><span class="hs-identifier hs-var">pat_acc_nm</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684430192"><span class="hs-identifier hs-var">r_ses</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684430195"><span class="hs-identifier hs-var">kstms</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-129"></span><span>    </span><span class="hs-comment">--trace (&quot;Redundant cost is: &quot;++printCost cost) $</span><span>
</span><span id="line-130"></span><span>    </span><span class="annot"><span class="annottext">Cost -&gt; Cost -&gt; Cost
</span><a href="Futhark.Optimise.GenRedOpt.html#maxCost"><span class="hs-identifier hs-var">maxCost</span></a></span><span> </span><span class="annot"><span class="annottext">Cost
</span><a href="#local-6989586621684430163"><span class="hs-identifier hs-var">cost</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Cost
</span><a href="Futhark.Optimise.GenRedOpt.html#Small"><span class="hs-identifier hs-var">Small</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Cost -&gt; Cost -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Cost
</span><a href="Futhark.Optimise.GenRedOpt.html#Small"><span class="hs-identifier hs-var">Small</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-131"></span><span>    </span><span class="hs-comment">-- 1. create the first kernel</span><span>
</span><span id="line-132"></span><span>    </span><span id="local-6989586621684430159"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684430159"><span class="hs-identifier hs-var">acc_tp</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; ReaderT (Scope GPU) (State VNameSource) Type
forall rep (m :: * -&gt; *). HasScope rep m =&gt; VName -&gt; m Type
</span><a href="Futhark.IR.Prop.Scope.html#lookupType"><span class="hs-identifier hs-var">lookupType</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684430176"><span class="hs-identifier hs-var">acc_nm</span></a></span><span>
</span><span id="line-133"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684430157"><span class="annot"><span class="annottext">inv_dim_len :: SubExp
</span><a href="#local-6989586621684430157"><span class="hs-identifier hs-var hs-var">inv_dim_len</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; [SubExp]
</span><a href="Futhark.IR.SegOp.html#segSpaceDims"><span class="hs-identifier hs-var">segSpaceDims</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684430201"><span class="hs-identifier hs-var">seg_space</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; Int -&gt; SubExp
forall a. [a] -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">!!</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684430171"><span class="hs-identifier hs-var">gid_ind</span></a></span><span>
</span><span id="line-134"></span><span>        </span><span class="hs-comment">-- 1.1. get the accumulation operator</span><span>
</span><span id="line-135"></span><span>        </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621684430154"><span class="annot"><span class="annottext">Lambda GPU
</span><a href="#local-6989586621684430154"><span class="hs-identifier hs-var">redop0</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684430153"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684430153"><span class="hs-identifier hs-var">neutral</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621684430152"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684430152"><span class="hs-identifier hs-var">el_tps</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; ((Lambda GPU, [SubExp]), [Type])
</span><a href="#local-6989586621684430151"><span class="hs-identifier hs-var">getAccLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684430159"><span class="hs-identifier hs-var">acc_tp</span></a></span><span>
</span><span id="line-136"></span><span>    </span><span id="local-6989586621684430150"><span class="annot"><span class="annottext">Lambda GPU
</span><a href="#local-6989586621684430150"><span class="hs-identifier hs-var">redop</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Lambda GPU -&gt; ReaderT (Scope GPU) (State VNameSource) (Lambda GPU)
forall rep (m :: * -&gt; *).
(Renameable rep, MonadFreshNames m) =&gt;
Lambda rep -&gt; m (Lambda rep)
</span><a href="Futhark.Transform.Rename.html#renameLambda"><span class="hs-identifier hs-var">renameLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPU
</span><a href="#local-6989586621684430154"><span class="hs-identifier hs-var">redop0</span></a></span><span>
</span><span id="line-137"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684430148"><span class="annot"><span class="annottext">red :: Reduce GPU
</span><a href="#local-6989586621684430148"><span class="hs-identifier hs-var hs-var">red</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-138"></span><span>          </span><span class="annot"><span class="annottext">Reduce :: forall rep. Commutativity -&gt; Lambda rep -&gt; [SubExp] -&gt; Reduce rep
</span><a href="Futhark.IR.SOACS.SOAC.html#Reduce"><span class="hs-identifier hs-type">Reduce</span></a></span><span>
</span><span id="line-139"></span><span>            </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">redComm :: Commutativity
</span><a href="Futhark.IR.SOACS.SOAC.html#redComm"><span class="hs-identifier hs-var">redComm</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Commutativity
</span><a href="Futhark.IR.Syntax.Core.html#Commutative"><span class="hs-identifier hs-var">Commutative</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-140"></span><span>              </span><span class="annot"><span class="annottext">redLambda :: Lambda GPU
</span><a href="Futhark.IR.SOACS.SOAC.html#redLambda"><span class="hs-identifier hs-var">redLambda</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Lambda GPU
</span><a href="#local-6989586621684430150"><span class="hs-identifier hs-var">redop</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-141"></span><span>              </span><span class="annot"><span class="annottext">redNeutral :: [SubExp]
</span><a href="Futhark.IR.SOACS.SOAC.html#redNeutral"><span class="hs-identifier hs-var">redNeutral</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684430153"><span class="hs-identifier hs-var">neutral</span></a></span><span>
</span><span id="line-142"></span><span>            </span><span class="hs-special">}</span><span>
</span><span id="line-143"></span><span>        </span><span class="hs-comment">-- 1.2. build the sequential map-reduce screma</span><span>
</span><span id="line-144"></span><span>        </span><span id="local-6989586621684430142"><span class="annot"><span class="annottext">code1' :: Stms GPU
</span><a href="#local-6989586621684430142"><span class="hs-identifier hs-var hs-var">code1'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-145"></span><span>          </span><span class="annot"><span class="annottext">[Stm GPU] -&gt; Stms GPU
forall rep. [Stm rep] -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#stmsFromList"><span class="hs-identifier hs-var">stmsFromList</span></a></span><span> </span><span class="annot"><span class="annottext">([Stm GPU] -&gt; Stms GPU) -&gt; [Stm GPU] -&gt; Stms GPU
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-146"></span><span>            </span><span class="annot"><span class="annottext">(Stm GPU -&gt; Bool) -&gt; [Stm GPU] -&gt; [Stm GPU]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; VarianceTable -&gt; Stm GPU -&gt; Bool
forall {k} {rep}. Ord k =&gt; k -&gt; Map k Names -&gt; Stm rep -&gt; Bool
</span><a href="#local-6989586621684430140"><span class="hs-identifier hs-var">dependsOnAcc</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684430173"><span class="hs-identifier hs-var">pat_acc_nm</span></a></span><span> </span><span class="annot"><span class="annottext">VarianceTable
</span><a href="#local-6989586621684430186"><span class="hs-identifier hs-var">variance</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Stm GPU] -&gt; [Stm GPU]) -&gt; [Stm GPU] -&gt; [Stm GPU]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-147"></span><span>              </span><span class="annot"><span class="annottext">Stms GPU -&gt; [Stm GPU]
forall rep. Stms rep -&gt; [Stm rep]
</span><a href="Futhark.IR.Syntax.html#stmsToList"><span class="hs-identifier hs-var">stmsToList</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684430184"><span class="hs-identifier hs-var">code1</span></a></span><span>
</span><span id="line-148"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684430139"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684430139"><span class="hs-identifier hs-var">code1''</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684430138"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684430138"><span class="hs-identifier hs-var">code1_tr_host</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Names
-&gt; VarianceTable
-&gt; VName
-&gt; Stms GPU
-&gt; GenRedM (Stms GPU, Stms GPU)
</span><a href="Futhark.Optimise.GenRedOpt.html#transposeFVs"><span class="hs-identifier hs-var">transposeFVs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stm GPU -&gt; Names
forall a. FreeIn a =&gt; a -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#freeIn"><span class="hs-identifier hs-var">freeIn</span></a></span><span> </span><span class="annot"><span class="annottext">Stm GPU
</span><a href="#local-6989586621684430205"><span class="hs-identifier hs-var">kerstm</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VarianceTable
</span><a href="#local-6989586621684430186"><span class="hs-identifier hs-var">variance</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684430172"><span class="hs-identifier hs-var">invar_gid</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684430142"><span class="hs-identifier hs-var">code1'</span></a></span><span>
</span><span id="line-149"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684430135"><span class="annot"><span class="annottext">map_lam_body :: Body GPU
</span><a href="#local-6989586621684430135"><span class="hs-identifier hs-var hs-var">map_lam_body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stms GPU -&gt; Result -&gt; Body GPU
forall rep. Buildable rep =&gt; Stms rep -&gt; Result -&gt; Body rep
</span><a href="Futhark.Builder.Class.html#mkBody"><span class="hs-identifier hs-var">mkBody</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684430139"><span class="hs-identifier hs-var">code1''</span></a></span><span> </span><span class="annot"><span class="annottext">(Result -&gt; Body GPU) -&gt; Result -&gt; Body GPU
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; SubExpRes) -&gt; [SubExp] -&gt; Result
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Certs -&gt; SubExp -&gt; SubExpRes
</span><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-var">SubExpRes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; Certs
</span><a href="Futhark.IR.Syntax.Core.html#Certs"><span class="hs-identifier hs-var">Certs</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684430174"><span class="hs-identifier hs-var">acc_vals</span></a></span><span>
</span><span id="line-150"></span><span>        </span><span id="local-6989586621684430131"><span class="annot"><span class="annottext">map_lam0 :: Lambda GPU
</span><a href="#local-6989586621684430131"><span class="hs-identifier hs-var hs-var">map_lam0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[LParam GPU] -&gt; Body GPU -&gt; [Type] -&gt; Lambda GPU
forall rep. [LParam rep] -&gt; BodyT rep -&gt; [Type] -&gt; LambdaT rep
</span><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-var">Lambda</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Attrs -&gt; VName -&gt; Type -&gt; Param Type
forall dec. Attrs -&gt; VName -&gt; dec -&gt; Param dec
</span><a href="Futhark.IR.Syntax.Core.html#Param"><span class="hs-identifier hs-var">Param</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684430172"><span class="hs-identifier hs-var">invar_gid</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimType -&gt; Type
forall shape u. PrimType -&gt; TypeBase shape u
</span><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int64"><span class="hs-identifier hs-var">int64</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Body GPU
</span><a href="#local-6989586621684430135"><span class="hs-identifier hs-var">map_lam_body</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684430152"><span class="hs-identifier hs-var">el_tps</span></a></span><span>
</span><span id="line-151"></span><span>    </span><span id="local-6989586621684430126"><span class="annot"><span class="annottext">Lambda GPU
</span><a href="#local-6989586621684430126"><span class="hs-identifier hs-var">map_lam</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Lambda GPU -&gt; ReaderT (Scope GPU) (State VNameSource) (Lambda GPU)
forall rep (m :: * -&gt; *).
(Renameable rep, MonadFreshNames m) =&gt;
Lambda rep -&gt; m (Lambda rep)
</span><a href="Futhark.Transform.Rename.html#renameLambda"><span class="hs-identifier hs-var">renameLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPU
</span><a href="#local-6989586621684430131"><span class="hs-identifier hs-var">map_lam0</span></a></span><span>
</span><span id="line-152"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684430125"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684430125"><span class="hs-identifier hs-var">k1_res</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684430124"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684430124"><span class="hs-identifier hs-var">ker1_stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">BuilderT GPU (ReaderT (Scope GPU) (State VNameSource)) SubExp
-&gt; ReaderT (Scope GPU) (State VNameSource) (SubExp, Stms GPU)
forall (m :: * -&gt; *) somerep rep a.
(MonadFreshNames m, HasScope somerep m, SameScope somerep rep) =&gt;
BuilderT rep m a -&gt; m (a, Stms rep)
</span><a href="Futhark.Builder.html#runBuilderT%27"><span class="hs-identifier hs-var">runBuilderT'</span></a></span><span> </span><span class="annot"><span class="annottext">(BuilderT GPU (ReaderT (Scope GPU) (State VNameSource)) SubExp
 -&gt; ReaderT (Scope GPU) (State VNameSource) (SubExp, Stms GPU))
-&gt; BuilderT GPU (ReaderT (Scope GPU) (State VNameSource)) SubExp
-&gt; ReaderT (Scope GPU) (State VNameSource) (SubExp, Stms GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-153"></span><span>      </span><span id="local-6989586621684430122"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684430122"><span class="hs-identifier hs-var">iota</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String
-&gt; Exp
     (Rep (BuilderT GPU (ReaderT (Scope GPU) (State VNameSource))))
-&gt; BuilderT GPU (ReaderT (Scope GPU) (State VNameSource)) VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m VName
</span><a href="Futhark.Construct.html#letExp"><span class="hs-identifier hs-var">letExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;iota&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (BuilderT GPU (ReaderT (Scope GPU) (State VNameSource))))
 -&gt; BuilderT GPU (ReaderT (Scope GPU) (State VNameSource)) VName)
-&gt; Exp
     (Rep (BuilderT GPU (ReaderT (Scope GPU) (State VNameSource))))
-&gt; BuilderT GPU (ReaderT (Scope GPU) (State VNameSource)) VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT GPU
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT GPU) -&gt; BasicOp -&gt; ExpT GPU
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; SubExp -&gt; SubExp -&gt; IntType -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Iota"><span class="hs-identifier hs-var">Iota</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684430157"><span class="hs-identifier hs-var">inv_dim_len</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Integer -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#intConst"><span class="hs-identifier hs-var">intConst</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Integer -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#intConst"><span class="hs-identifier hs-var">intConst</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span>
</span><span id="line-154"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684430119"><span class="annot"><span class="annottext">op_exp :: ExpT GPU
</span><a href="#local-6989586621684430119"><span class="hs-identifier hs-var hs-var">op_exp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Op GPU -&gt; ExpT GPU
forall rep. Op rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-var">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SOAC GPU -&gt; HostOp GPU (SOAC GPU)
forall rep op. op -&gt; HostOp rep op
</span><a href="Futhark.IR.GPU.Op.html#OtherOp"><span class="hs-identifier hs-var">OtherOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp -&gt; [VName] -&gt; ScremaForm GPU -&gt; SOAC GPU
forall rep. SubExp -&gt; [VName] -&gt; ScremaForm rep -&gt; SOAC rep
</span><a href="Futhark.IR.SOACS.SOAC.html#Screma"><span class="hs-identifier hs-var">Screma</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684430157"><span class="hs-identifier hs-var">inv_dim_len</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684430122"><span class="hs-identifier hs-var">iota</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Scan GPU] -&gt; [Reduce GPU] -&gt; Lambda GPU -&gt; ScremaForm GPU
forall rep.
[Scan rep] -&gt; [Reduce rep] -&gt; Lambda rep -&gt; ScremaForm rep
</span><a href="Futhark.IR.SOACS.SOAC.html#ScremaForm"><span class="hs-identifier hs-var">ScremaForm</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Reduce GPU
</span><a href="#local-6989586621684430148"><span class="hs-identifier hs-var">red</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Lambda GPU
</span><a href="#local-6989586621684430126"><span class="hs-identifier hs-var">map_lam</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-155"></span><span>      </span><span id="local-6989586621684430115"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684430115"><span class="hs-identifier hs-var">res_redmap</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String
-&gt; Exp
     (Rep (BuilderT GPU (ReaderT (Scope GPU) (State VNameSource))))
-&gt; BuilderT GPU (ReaderT (Scope GPU) (State VNameSource)) [VName]
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m [VName]
</span><a href="Futhark.Construct.html#letTupExp"><span class="hs-identifier hs-var">letTupExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;res_mapred&quot;</span></span><span> </span><span class="annot"><span class="annottext">Exp (Rep (BuilderT GPU (ReaderT (Scope GPU) (State VNameSource))))
ExpT GPU
</span><a href="#local-6989586621684430119"><span class="hs-identifier hs-var">op_exp</span></a></span><span>
</span><span id="line-156"></span><span>      </span><span class="annot"><span class="annottext">String
-&gt; Exp
     (Rep (BuilderT GPU (ReaderT (Scope GPU) (State VNameSource))))
-&gt; BuilderT GPU (ReaderT (Scope GPU) (State VNameSource)) SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; String
</span><a href="Language.Futhark.Core.html#baseString"><span class="hs-identifier hs-var">baseString</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684430173"><span class="hs-identifier hs-var">pat_acc_nm</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_big_update&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (BuilderT GPU (ReaderT (Scope GPU) (State VNameSource))))
 -&gt; BuilderT GPU (ReaderT (Scope GPU) (State VNameSource)) SubExp)
-&gt; Exp
     (Rep (BuilderT GPU (ReaderT (Scope GPU) (State VNameSource))))
-&gt; BuilderT GPU (ReaderT (Scope GPU) (State VNameSource)) SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-157"></span><span>        </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT GPU
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; [SubExp] -&gt; [SubExp] -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#UpdateAcc"><span class="hs-identifier hs-var">UpdateAcc</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684430176"><span class="hs-identifier hs-var">acc_nm</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684430175"><span class="hs-identifier hs-var">acc_inds</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; BasicOp) -&gt; [SubExp] -&gt; BasicOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SubExp) -&gt; [VName] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684430115"><span class="hs-identifier hs-var">res_redmap</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-158"></span><span>    </span><span class="hs-comment">-- Let pat_accum aux (BasicOp (UpdateAcc acc_nm acc_inds res_redmap))</span><span>
</span><span id="line-159"></span><span>
</span><span id="line-160"></span><span>    </span><span class="hs-comment">-- 1.3. build the kernel expression and rename it!</span><span>
</span><span id="line-161"></span><span>    </span><span id="local-6989586621684430110"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684430110"><span class="hs-identifier hs-var">gid_flat_1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; ReaderT (Scope GPU) (State VNameSource) VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; String -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;gid_flat&quot;</span></span><span>
</span><span id="line-162"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684430108"><span class="annot"><span class="annottext">space1 :: SegSpace
</span><a href="#local-6989586621684430108"><span class="hs-identifier hs-var hs-var">space1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; [(VName, SubExp)] -&gt; SegSpace
</span><a href="Futhark.IR.SegOp.html#SegSpace"><span class="hs-identifier hs-var">SegSpace</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684430110"><span class="hs-identifier hs-var">gid_flat_1</span></a></span><span> </span><span class="annot"><span class="annottext">[(VName, SubExp)]
</span><a href="#local-6989586621684430169"><span class="hs-identifier hs-var">gid_dims_new</span></a></span><span>
</span><span id="line-163"></span><span>
</span><span id="line-164"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684430106"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684430106"><span class="hs-identifier hs-var">grid_size</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684430105"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684430105"><span class="hs-identifier hs-var">host_stms1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Builder GPU SubExp
-&gt; ReaderT (Scope GPU) (State VNameSource) (SubExp, Stms GPU)
forall (m :: * -&gt; *) somerep rep a.
(MonadFreshNames m, HasScope somerep m, SameScope somerep rep) =&gt;
Builder rep a -&gt; m (a, Stms rep)
</span><a href="Futhark.Builder.html#runBuilder"><span class="hs-identifier hs-var">runBuilder</span></a></span><span> </span><span class="annot"><span class="annottext">(Builder GPU SubExp
 -&gt; ReaderT (Scope GPU) (State VNameSource) (SubExp, Stms GPU))
-&gt; Builder GPU SubExp
-&gt; ReaderT (Scope GPU) (State VNameSource) (SubExp, Stms GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-165"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684430103"><span class="annot"><span class="annottext">grid_pexp :: TPrimExp Int64 VName
</span><a href="#local-6989586621684430103"><span class="hs-identifier hs-var hs-var">grid_pexp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName -&gt; SubExp -&gt; TPrimExp Int64 VName)
-&gt; TPrimExp Int64 VName -&gt; [SubExp] -&gt; TPrimExp Int64 VName
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621684430101"><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684430101"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621684430100"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684430100"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684430101"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TPrimExp Int64 VName
</span><a href="Futhark.Analysis.PrimExp.Convert.html#pe64"><span class="hs-identifier hs-var">pe64</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684430100"><span class="hs-identifier hs-var">d</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp -&gt; TPrimExp Int64 VName
</span><a href="Futhark.Analysis.PrimExp.Convert.html#pe64"><span class="hs-identifier hs-var">pe64</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="Futhark.Optimise.GenRedOpt.html#se1"><span class="hs-identifier hs-var">se1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; TPrimExp Int64 VName)
-&gt; [SubExp] -&gt; TPrimExp Int64 VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((VName, SubExp) -&gt; SubExp) -&gt; [(VName, SubExp)] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(VName, SubExp) -&gt; SubExp
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">[(VName, SubExp)]
</span><a href="#local-6989586621684430169"><span class="hs-identifier hs-var">gid_dims_new</span></a></span><span>
</span><span id="line-166"></span><span>      </span><span id="local-6989586621684430097"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684430097"><span class="hs-identifier hs-var">dim_prod</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String
-&gt; Exp (Rep (BuilderT GPU (State VNameSource)))
-&gt; Builder GPU SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;dim_prod&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ExpT GPU -&gt; Builder GPU SubExp)
-&gt; BuilderT GPU (State VNameSource) (ExpT GPU)
-&gt; Builder GPU SubExp
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; BuilderT
     GPU
     (State VNameSource)
     (Exp (Rep (BuilderT GPU (State VNameSource))))
forall a (m :: * -&gt; *).
(ToExp a, MonadBuilder m) =&gt;
a -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#toExp"><span class="hs-identifier hs-var">toExp</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684430103"><span class="hs-identifier hs-var">grid_pexp</span></a></span><span>
</span><span id="line-167"></span><span>      </span><span class="annot"><span class="annottext">String
-&gt; Exp (Rep (BuilderT GPU (State VNameSource)))
-&gt; Builder GPU SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;grid_size&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ExpT GPU -&gt; Builder GPU SubExp)
-&gt; BuilderT GPU (State VNameSource) (ExpT GPU)
-&gt; Builder GPU SubExp
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; SubExp -&gt; BuilderT GPU (State VNameSource) (ExpT GPU)
forall {f :: * -&gt; *} {rep}.
Applicative f =&gt;
SubExp -&gt; SubExp -&gt; f (ExpT rep)
</span><a href="#local-6989586621684430094"><span class="hs-identifier hs-var">ceilDiv</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684430097"><span class="hs-identifier hs-var">dim_prod</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Count GroupSize SubExp -&gt; SubExp
forall u e. Count u e -&gt; e
</span><a href="Futhark.IR.GPU.Sizes.html#unCount"><span class="hs-identifier hs-var hs-var">unCount</span></a></span><span> </span><span class="annot"><span class="annottext">Count GroupSize SubExp
</span><a href="#local-6989586621684430198"><span class="hs-identifier hs-var">seg_group_size</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-168"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684430092"><span class="annot"><span class="annottext">level1 :: SegLevel
</span><a href="#local-6989586621684430092"><span class="hs-identifier hs-var hs-var">level1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Count NumGroups SubExp
-&gt; Count GroupSize SubExp -&gt; SegVirt -&gt; SegLevel
</span><a href="Futhark.IR.GPU.Op.html#SegThread"><span class="hs-identifier hs-var">SegThread</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp -&gt; Count NumGroups SubExp
forall u e. e -&gt; Count u e
</span><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-var">Count</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684430106"><span class="hs-identifier hs-var">grid_size</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Count GroupSize SubExp
</span><a href="#local-6989586621684430198"><span class="hs-identifier hs-var">seg_group_size</span></a></span><span> </span><span class="annot"><span class="annottext">SegVirt
</span><a href="Futhark.IR.SegOp.html#SegNoVirtFull"><span class="hs-identifier hs-var">SegNoVirtFull</span></a></span><span> </span><span class="hs-comment">-- novirt ?</span><span>
</span><span id="line-169"></span><span>        </span><span id="local-6989586621684430089"><span class="annot"><span class="annottext">kbody1 :: KernelBody GPU
</span><a href="#local-6989586621684430089"><span class="hs-identifier hs-var hs-var">kbody1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BodyDec GPU -&gt; Stms GPU -&gt; [KernelResult] -&gt; KernelBody GPU
forall rep.
BodyDec rep -&gt; Stms rep -&gt; [KernelResult] -&gt; KernelBody rep
</span><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-var">KernelBody</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684430124"><span class="hs-identifier hs-var">ker1_stms</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">ResultManifest -&gt; Certs -&gt; SubExp -&gt; KernelResult
</span><a href="Futhark.IR.SegOp.html#Returns"><span class="hs-identifier hs-var">Returns</span></a></span><span> </span><span class="annot"><span class="annottext">ResultManifest
</span><a href="Futhark.IR.SegOp.html#ResultMaySimplify"><span class="hs-identifier hs-var">ResultMaySimplify</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; Certs
</span><a href="Futhark.IR.Syntax.Core.html#Certs"><span class="hs-identifier hs-var">Certs</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684430125"><span class="hs-identifier hs-var">k1_res</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-170"></span><span>
</span><span id="line-171"></span><span>    </span><span class="hs-comment">-- is it OK here to use the &quot;aux&quot; from the parrent kernel?</span><span>
</span><span id="line-172"></span><span>    </span><span id="local-6989586621684430086"><span class="annot"><span class="annottext">ExpT GPU
</span><a href="#local-6989586621684430086"><span class="hs-identifier hs-var">ker_exp</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ExpT GPU -&gt; ReaderT (Scope GPU) (State VNameSource) (ExpT GPU)
forall rep (m :: * -&gt; *).
(Renameable rep, MonadFreshNames m) =&gt;
Exp rep -&gt; m (Exp rep)
</span><a href="Futhark.Transform.Rename.html#renameExp"><span class="hs-identifier hs-var">renameExp</span></a></span><span> </span><span class="annot"><span class="annottext">(ExpT GPU -&gt; ReaderT (Scope GPU) (State VNameSource) (ExpT GPU))
-&gt; ExpT GPU -&gt; ReaderT (Scope GPU) (State VNameSource) (ExpT GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Op GPU -&gt; ExpT GPU
forall rep. Op rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-var">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegOp SegLevel GPU -&gt; HostOp GPU (SOAC GPU)
forall rep op. SegOp SegLevel rep -&gt; HostOp rep op
</span><a href="Futhark.IR.GPU.Op.html#SegOp"><span class="hs-identifier hs-var">SegOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegLevel
-&gt; SegSpace -&gt; [Type] -&gt; KernelBody GPU -&gt; SegOp SegLevel GPU
forall lvl rep.
lvl -&gt; SegSpace -&gt; [Type] -&gt; KernelBody rep -&gt; SegOp lvl rep
</span><a href="Futhark.IR.SegOp.html#SegMap"><span class="hs-identifier hs-var">SegMap</span></a></span><span> </span><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684430092"><span class="hs-identifier hs-var">level1</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684430108"><span class="hs-identifier hs-var">space1</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684430159"><span class="hs-identifier hs-var">acc_tp</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">KernelBody GPU
</span><a href="#local-6989586621684430089"><span class="hs-identifier hs-var">kbody1</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-173"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684430084"><span class="annot"><span class="annottext">ker1 :: Stm GPU
</span><a href="#local-6989586621684430084"><span class="hs-identifier hs-var hs-var">ker1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Pat GPU -&gt; StmAux (ExpDec GPU) -&gt; ExpT GPU -&gt; Stm GPU
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPU
</span><a href="#local-6989586621684430180"><span class="hs-identifier hs-var">pat_accum</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec GPU)
</span><a href="#local-6989586621684430203"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">ExpT GPU
</span><a href="#local-6989586621684430086"><span class="hs-identifier hs-var">ker_exp</span></a></span><span>
</span><span id="line-174"></span><span>
</span><span id="line-175"></span><span>    </span><span class="hs-comment">-- 2 build the second kernel</span><span>
</span><span id="line-176"></span><span>    </span><span class="hs-comment">-- Let pat_ker aux  (Op (SegOp (SegMap seg_thd seg_space kres_tps old_kbody)))</span><span>
</span><span id="line-177"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684430083"><span class="annot"><span class="annottext">ker2_body :: KernelBody GPU
</span><a href="#local-6989586621684430083"><span class="hs-identifier hs-var hs-var">ker2_body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">KernelBody GPU
</span><a href="#local-6989586621684430199"><span class="hs-identifier hs-var">old_kbody</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">kernelBodyStms :: Stms GPU
</span><a href="Futhark.IR.SegOp.html#kernelBodyStms"><span class="hs-identifier hs-var">kernelBodyStms</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684430184"><span class="hs-identifier hs-var">code1</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPU -&gt; Stms GPU -&gt; Stms GPU
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684430182"><span class="hs-identifier hs-var">code2</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-178"></span><span>    </span><span id="local-6989586621684430081"><span class="annot"><span class="annottext">ExpT GPU
</span><a href="#local-6989586621684430081"><span class="hs-identifier hs-var">ker2_exp</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ExpT GPU -&gt; ReaderT (Scope GPU) (State VNameSource) (ExpT GPU)
forall rep (m :: * -&gt; *).
(Renameable rep, MonadFreshNames m) =&gt;
Exp rep -&gt; m (Exp rep)
</span><a href="Futhark.Transform.Rename.html#renameExp"><span class="hs-identifier hs-var">renameExp</span></a></span><span> </span><span class="annot"><span class="annottext">(ExpT GPU -&gt; ReaderT (Scope GPU) (State VNameSource) (ExpT GPU))
-&gt; ExpT GPU -&gt; ReaderT (Scope GPU) (State VNameSource) (ExpT GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Op GPU -&gt; ExpT GPU
forall rep. Op rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-var">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegOp SegLevel GPU -&gt; HostOp GPU (SOAC GPU)
forall rep op. SegOp SegLevel rep -&gt; HostOp rep op
</span><a href="Futhark.IR.GPU.Op.html#SegOp"><span class="hs-identifier hs-var">SegOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegLevel
-&gt; SegSpace -&gt; [Type] -&gt; KernelBody GPU -&gt; SegOp SegLevel GPU
forall lvl rep.
lvl -&gt; SegSpace -&gt; [Type] -&gt; KernelBody rep -&gt; SegOp lvl rep
</span><a href="Futhark.IR.SegOp.html#SegMap"><span class="hs-identifier hs-var">SegMap</span></a></span><span> </span><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684430202"><span class="hs-identifier hs-var">seg_thd</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684430201"><span class="hs-identifier hs-var">seg_space</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684430200"><span class="hs-identifier hs-var">kres_tps</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody GPU
</span><a href="#local-6989586621684430083"><span class="hs-identifier hs-var">ker2_body</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-179"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684430080"><span class="annot"><span class="annottext">ker2 :: Stm GPU
</span><a href="#local-6989586621684430080"><span class="hs-identifier hs-var hs-var">ker2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Pat GPU -&gt; StmAux (ExpDec GPU) -&gt; ExpT GPU -&gt; Stm GPU
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPU
</span><a href="#local-6989586621684430204"><span class="hs-identifier hs-var">pat_ker</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec GPU)
</span><a href="#local-6989586621684430203"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">ExpT GPU
</span><a href="#local-6989586621684430081"><span class="hs-identifier hs-var">ker2_exp</span></a></span><span>
</span><span id="line-180"></span><span>    </span><span class="annot"><span class="annottext">Maybe (Stms GPU, Stm GPU) -&gt; GenRedM (Maybe (Stms GPU, Stm GPU))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (Stms GPU, Stm GPU) -&gt; GenRedM (Maybe (Stms GPU, Stm GPU)))
-&gt; Maybe (Stms GPU, Stm GPU) -&gt; GenRedM (Maybe (Stms GPU, Stm GPU))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-181"></span><span>      </span><span class="hs-comment">--trace (&quot;\nIdentified Potential for Optimizing Gen Red, acc-stm:\n&quot;++</span><span>
</span><span id="line-182"></span><span>      </span><span class="hs-comment">--       pretty accum_stmt++&quot;\n invar to:&quot;++pretty (invar_gid, gid_ind)++</span><span>
</span><span id="line-183"></span><span>      </span><span class="hs-comment">--       -- &quot;\nkernel code:\n&quot;++pretty kerstm++</span><span>
</span><span id="line-184"></span><span>      </span><span class="hs-comment">--       &quot;\n first redomap kernel:\n&quot;++pretty ker1++&quot;\n transpositions: &quot;++pretty code1_tr_host</span><span>
</span><span id="line-185"></span><span>      </span><span class="hs-comment">--      ) $</span><span>
</span><span id="line-186"></span><span>      </span><span class="annot"><span class="annottext">(Stms GPU, Stm GPU) -&gt; Maybe (Stms GPU, Stm GPU)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684430138"><span class="hs-identifier hs-var">code1_tr_host</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPU -&gt; Stms GPU -&gt; Stms GPU
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684430105"><span class="hs-identifier hs-var">host_stms1</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPU -&gt; Stms GPU -&gt; Stms GPU
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Stm GPU -&gt; Stms GPU
forall rep. Stm rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#oneStm"><span class="hs-identifier hs-var">oneStm</span></a></span><span> </span><span class="annot"><span class="annottext">Stm GPU
</span><a href="#local-6989586621684430084"><span class="hs-identifier hs-var">ker1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stm GPU
</span><a href="#local-6989586621684430080"><span class="hs-identifier hs-var">ker2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-187"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-188"></span><span>    </span><span id="local-6989586621684430094"><span class="annot"><span class="annottext">ceilDiv :: SubExp -&gt; SubExp -&gt; f (ExpT rep)
</span><a href="#local-6989586621684430094"><span class="hs-identifier hs-var hs-var">ceilDiv</span></a></span></span><span> </span><span id="local-6989586621684430077"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684430077"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621684430076"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684430076"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExpT rep -&gt; f (ExpT rep)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(ExpT rep -&gt; f (ExpT rep)) -&gt; ExpT rep -&gt; f (ExpT rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BinOp -&gt; SubExp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#BinOp"><span class="hs-identifier hs-var">BinOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Safety -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#SDivUp"><span class="hs-identifier hs-var">SDivUp</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Safety
</span><a href="Futhark.IR.Primitive.html#Unsafe"><span class="hs-identifier hs-var">Unsafe</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684430077"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684430076"><span class="hs-identifier hs-var">y</span></a></span><span>
</span><span id="line-189"></span><span>    </span><span id="local-6989586621684430151"><span class="annot"><span class="annottext">getAccLambda :: Type -&gt; ((Lambda GPU, [SubExp]), [Type])
</span><a href="#local-6989586621684430151"><span class="hs-identifier hs-var hs-var">getAccLambda</span></a></span></span><span> </span><span id="local-6989586621684430072"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684430072"><span class="hs-identifier hs-var">acc_tp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-190"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684430072"><span class="hs-identifier hs-var">acc_tp</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-191"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Acc"><span class="hs-identifier hs-type">Acc</span></a></span><span> </span><span id="local-6989586621684430070"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684430070"><span class="hs-identifier hs-var">tp_id</span></a></span></span><span> </span><span id="local-6989586621684430069"><span class="annot"><span class="annottext">ShapeBase SubExp
</span><a href="#local-6989586621684430069"><span class="hs-identifier hs-var">_shp</span></a></span></span><span> </span><span id="local-6989586621684430068"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684430068"><span class="hs-identifier hs-var">el_tps</span></a></span></span><span> </span><span class="annot"><span class="annottext">NoUniqueness
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-192"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">VName -&gt; WithEnv -&gt; Maybe (Lambda GPU, [SubExp])
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684430070"><span class="hs-identifier hs-var">tp_id</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Env -&gt; WithEnv
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684430206"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-193"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684430066"><span class="annot"><span class="annottext">(Lambda GPU, [SubExp])
</span><a href="#local-6989586621684430066"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Lambda GPU, [SubExp])
</span><a href="#local-6989586621684430066"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684430068"><span class="hs-identifier hs-var">el_tps</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-194"></span><span>            </span><span class="annot"><span class="annottext">Maybe (Lambda GPU, [SubExp])
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; ((Lambda GPU, [SubExp]), [Type])
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; ((Lambda GPU, [SubExp]), [Type]))
-&gt; String -&gt; ((Lambda GPU, [SubExp]), [Type])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Lookup in environment failed! &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684430070"><span class="hs-identifier hs-var">tp_id</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; env: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">WithEnv -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Env -&gt; WithEnv
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684430206"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-195"></span><span>        </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; ((Lambda GPU, [SubExp]), [Type])
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Illegal accumulator type!&quot;</span></span><span>
</span><span id="line-196"></span><span>    </span><span class="hs-comment">-- is a subexp invariant to a gid of a parallel dimension?</span><span>
</span><span id="line-197"></span><span>    </span><span id="local-6989586621684430060"><span class="annot"><span class="annottext">isSeInvar2 :: VarianceTable -&gt; VName -&gt; SubExp -&gt; Bool
</span><a href="#local-6989586621684430060"><span class="hs-identifier hs-var hs-var">isSeInvar2</span></a></span></span><span> </span><span id="local-6989586621684430059"><span class="annot"><span class="annottext">VarianceTable
</span><a href="#local-6989586621684430059"><span class="hs-identifier hs-var">variance</span></a></span></span><span> </span><span id="local-6989586621684430058"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684430058"><span class="hs-identifier hs-var">gid</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684430057"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684430057"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-198"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684430056"><span class="annot"><span class="annottext">x_deps :: Names
</span><a href="#local-6989586621684430056"><span class="hs-identifier hs-var hs-var">x_deps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Names -&gt; VName -&gt; VarianceTable -&gt; Names
forall k a. Ord k =&gt; a -&gt; k -&gt; Map k a -&gt; a
</span><span class="hs-identifier hs-var">M.findWithDefault</span></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684430057"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">VarianceTable
</span><a href="#local-6989586621684430059"><span class="hs-identifier hs-var">variance</span></a></span><span>
</span><span id="line-199"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684430058"><span class="hs-identifier hs-var">gid</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; VName -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684430057"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#nameIn"><span class="hs-identifier hs-var">nameIn</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684430058"><span class="hs-identifier hs-var">gid</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684430056"><span class="hs-identifier hs-var">x_deps</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-200"></span><span>    </span><span class="annot"><a href="#local-6989586621684430060"><span class="hs-identifier hs-var">isSeInvar2</span></a></span><span> </span><span class="annot"><span class="annottext">VarianceTable
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-201"></span><span>    </span><span class="hs-comment">-- is a DimIndex invar to a gid of a parallel dimension?</span><span>
</span><span id="line-202"></span><span>    </span><span id="local-6989586621684430050"><span class="annot"><span class="annottext">isDimIdxInvar2 :: VarianceTable -&gt; VName -&gt; DimIndex SubExp -&gt; Bool
</span><a href="#local-6989586621684430050"><span class="hs-identifier hs-var hs-var">isDimIdxInvar2</span></a></span></span><span> </span><span id="local-6989586621684430049"><span class="annot"><span class="annottext">VarianceTable
</span><a href="#local-6989586621684430049"><span class="hs-identifier hs-var">variance</span></a></span></span><span> </span><span id="local-6989586621684430048"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684430048"><span class="hs-identifier hs-var">gid</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-type">DimFix</span></a></span><span> </span><span id="local-6989586621684430046"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684430046"><span class="hs-identifier hs-var">d</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-203"></span><span>      </span><span class="annot"><span class="annottext">VarianceTable -&gt; VName -&gt; SubExp -&gt; Bool
</span><a href="#local-6989586621684430060"><span class="hs-identifier hs-var">isSeInvar2</span></a></span><span> </span><span class="annot"><span class="annottext">VarianceTable
</span><a href="#local-6989586621684430049"><span class="hs-identifier hs-var">variance</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684430048"><span class="hs-identifier hs-var">gid</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684430046"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-204"></span><span>    </span><span class="annot"><a href="#local-6989586621684430050"><span class="hs-identifier hs-var">isDimIdxInvar2</span></a></span><span> </span><span id="local-6989586621684430045"><span class="annot"><span class="annottext">VarianceTable
</span><a href="#local-6989586621684430045"><span class="hs-identifier hs-var">variance</span></a></span></span><span> </span><span id="local-6989586621684430044"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684430044"><span class="hs-identifier hs-var">gid</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#DimSlice"><span class="hs-identifier hs-type">DimSlice</span></a></span><span> </span><span id="local-6989586621684430042"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684430042"><span class="hs-identifier hs-var">d1</span></a></span></span><span> </span><span id="local-6989586621684430041"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684430041"><span class="hs-identifier hs-var">d2</span></a></span></span><span> </span><span id="local-6989586621684430040"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684430040"><span class="hs-identifier hs-var">d3</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-205"></span><span>      </span><span class="annot"><span class="annottext">(SubExp -&gt; Bool) -&gt; [SubExp] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarianceTable -&gt; VName -&gt; SubExp -&gt; Bool
</span><a href="#local-6989586621684430060"><span class="hs-identifier hs-var">isSeInvar2</span></a></span><span> </span><span class="annot"><span class="annottext">VarianceTable
</span><a href="#local-6989586621684430045"><span class="hs-identifier hs-var">variance</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684430044"><span class="hs-identifier hs-var">gid</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684430042"><span class="hs-identifier hs-var">d1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684430041"><span class="hs-identifier hs-var">d2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684430040"><span class="hs-identifier hs-var">d3</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-206"></span><span>    </span><span class="hs-comment">-- is an entire slice invariant to at least one gid of a parallel dimension</span><span>
</span><span id="line-207"></span><span>    </span><span id="local-6989586621684430036"><span class="annot"><span class="annottext">isSliceInvar2 :: VarianceTable -&gt; Slice SubExp -&gt; t VName -&gt; Bool
</span><a href="#local-6989586621684430036"><span class="hs-identifier hs-var hs-var">isSliceInvar2</span></a></span></span><span> </span><span id="local-6989586621684430035"><span class="annot"><span class="annottext">VarianceTable
</span><a href="#local-6989586621684430035"><span class="hs-identifier hs-var">variance</span></a></span></span><span> </span><span id="local-6989586621684430034"><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684430034"><span class="hs-identifier hs-var">slc</span></a></span></span><span> </span><span id="local-6989586621684430033"><span class="annot"><span class="annottext">t VName
</span><a href="#local-6989586621684430033"><span class="hs-identifier hs-var">gids</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-208"></span><span>      </span><span class="annot"><span class="annottext">(VName -&gt; Bool) -&gt; t VName -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621684430031"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684430031"><span class="hs-identifier hs-var">gid</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(DimIndex SubExp -&gt; Bool) -&gt; [DimIndex SubExp] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarianceTable -&gt; VName -&gt; DimIndex SubExp -&gt; Bool
</span><a href="#local-6989586621684430050"><span class="hs-identifier hs-var">isDimIdxInvar2</span></a></span><span> </span><span class="annot"><span class="annottext">VarianceTable
</span><a href="#local-6989586621684430035"><span class="hs-identifier hs-var">variance</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684430031"><span class="hs-identifier hs-var">gid</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Slice SubExp -&gt; [DimIndex SubExp]
forall d. Slice d -&gt; [DimIndex d]
</span><a href="Futhark.IR.Syntax.Core.html#unSlice"><span class="hs-identifier hs-var hs-var">unSlice</span></a></span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684430034"><span class="hs-identifier hs-var">slc</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">t VName
</span><a href="#local-6989586621684430033"><span class="hs-identifier hs-var">gids</span></a></span><span>
</span><span id="line-209"></span><span>    </span><span class="hs-comment">-- are all statements that touch memory invariant to at least one parallel dimension?</span><span>
</span><span id="line-210"></span><span>    </span><span class="annot"><a href="#local-6989586621684430164"><span class="hs-identifier hs-type">isTileable</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.TileLoops.Shared.html#VarianceTable"><span class="hs-identifier hs-type">VarianceTable</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-211"></span><span>    </span><span id="local-6989586621684430164"><span class="annot"><span class="annottext">isTileable :: VName
-&gt; [(VName, SubExp)] -&gt; VarianceTable -&gt; VName -&gt; Stm GPU -&gt; Bool
</span><a href="#local-6989586621684430164"><span class="hs-identifier hs-var hs-var">isTileable</span></a></span></span><span> </span><span id="local-6989586621684430029"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684430029"><span class="hs-identifier hs-var">seq_gid</span></a></span></span><span> </span><span id="local-6989586621684430028"><span class="annot"><span class="annottext">[(VName, SubExp)]
</span><a href="#local-6989586621684430028"><span class="hs-identifier hs-var">gid_dims</span></a></span></span><span> </span><span id="local-6989586621684430027"><span class="annot"><span class="annottext">VarianceTable
</span><a href="#local-6989586621684430027"><span class="hs-identifier hs-var">variance</span></a></span></span><span> </span><span id="local-6989586621684430026"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684430026"><span class="hs-identifier hs-var">acc_nm</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621684430024"><span class="annot"><span class="annottext">PatElemT (LetDec GPU)
</span><a href="#local-6989586621684430024"><span class="hs-identifier hs-var">pel</span></a></span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec GPU)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Index"><span class="hs-identifier hs-type">Index</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684430022"><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684430022"><span class="hs-identifier hs-var">slc</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-212"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621684430021"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684430021"><span class="hs-identifier hs-var">acc_deps</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Names -&gt; VName -&gt; VarianceTable -&gt; Names
forall k a. Ord k =&gt; a -&gt; k -&gt; Map k a -&gt; a
</span><span class="hs-identifier hs-var">M.findWithDefault</span></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684430026"><span class="hs-identifier hs-var">acc_nm</span></a></span><span> </span><span class="annot"><span class="annottext">VarianceTable
</span><a href="#local-6989586621684430027"><span class="hs-identifier hs-var">variance</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-213"></span><span>        </span><span class="annot"><span class="annottext">VName -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#nameIn"><span class="hs-identifier hs-var">nameIn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT Type -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT Type
PatElemT (LetDec GPU)
</span><a href="#local-6989586621684430024"><span class="hs-identifier hs-var">pel</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684430021"><span class="hs-identifier hs-var">acc_deps</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-214"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684430019"><span class="annot"><span class="annottext">invar_par :: Bool
</span><a href="#local-6989586621684430019"><span class="hs-identifier hs-var hs-var">invar_par</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarianceTable -&gt; Slice SubExp -&gt; [VName] -&gt; Bool
forall {t :: * -&gt; *}.
Foldable t =&gt;
VarianceTable -&gt; Slice SubExp -&gt; t VName -&gt; Bool
</span><a href="#local-6989586621684430036"><span class="hs-identifier hs-var">isSliceInvar2</span></a></span><span> </span><span class="annot"><span class="annottext">VarianceTable
</span><a href="#local-6989586621684430027"><span class="hs-identifier hs-var">variance</span></a></span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684430022"><span class="hs-identifier hs-var">slc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((VName, SubExp) -&gt; VName) -&gt; [(VName, SubExp)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(VName, SubExp) -&gt; VName
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(VName, SubExp)]
</span><a href="#local-6989586621684430028"><span class="hs-identifier hs-var">gid_dims</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-215"></span><span>            </span><span id="local-6989586621684430018"><span class="annot"><span class="annottext">invar_seq :: Bool
</span><a href="#local-6989586621684430018"><span class="hs-identifier hs-var hs-var">invar_seq</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarianceTable -&gt; Slice SubExp -&gt; [VName] -&gt; Bool
forall {t :: * -&gt; *}.
Foldable t =&gt;
VarianceTable -&gt; Slice SubExp -&gt; t VName -&gt; Bool
</span><a href="#local-6989586621684430036"><span class="hs-identifier hs-var">isSliceInvar2</span></a></span><span> </span><span class="annot"><span class="annottext">VarianceTable
</span><a href="#local-6989586621684430027"><span class="hs-identifier hs-var">variance</span></a></span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684430022"><span class="hs-identifier hs-var">slc</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684430029"><span class="hs-identifier hs-var">seq_gid</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-216"></span><span>         </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684430019"><span class="hs-identifier hs-var">invar_par</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684430018"><span class="hs-identifier hs-var">invar_seq</span></a></span><span>
</span><span id="line-217"></span><span>    </span><span class="hs-comment">--in  trace (&quot;!!!!!!!!!!!!!!Slice &quot;++pretty slc ++&quot; is invariant to: &quot;++pretty gid_dims++&quot; &quot;++</span><span>
</span><span id="line-218"></span><span>    </span><span class="hs-comment">--             pretty seq_gid++&quot; answer: &quot;++pretty invar_par++&quot; &quot;++pretty invar_seq) $</span><span>
</span><span id="line-219"></span><span>    </span><span class="hs-comment">--              invar_par || invar_seq</span><span>
</span><span id="line-220"></span><span>    </span><span class="hs-comment">-- this relies on the cost model, that currently accepts only</span><span>
</span><span id="line-221"></span><span>    </span><span class="hs-comment">-- global-memory reads, and for example rejects in-place updates</span><span>
</span><span id="line-222"></span><span>    </span><span class="hs-comment">-- or loops inside the code that is transformed in a redomap.</span><span>
</span><span id="line-223"></span><span>    </span><span class="annot"><a href="#local-6989586621684430164"><span class="hs-identifier hs-var">isTileable</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[(VName, SubExp)]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">VarianceTable
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Stm GPU
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-224"></span><span>    </span><span class="hs-comment">-- does the to-be-reduced accumulator depends on this statement?</span><span>
</span><span id="line-225"></span><span>    </span><span id="local-6989586621684430140"><span class="annot"><span class="annottext">dependsOnAcc :: k -&gt; Map k Names -&gt; Stm rep -&gt; Bool
</span><a href="#local-6989586621684430140"><span class="hs-identifier hs-var hs-var">dependsOnAcc</span></a></span></span><span> </span><span id="local-6989586621684430012"><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621684430012"><span class="hs-identifier hs-var">pat_acc_nm</span></a></span></span><span> </span><span id="local-6989586621684430011"><span class="annot"><span class="annottext">Map k Names
</span><a href="#local-6989586621684430011"><span class="hs-identifier hs-var">variance</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684430010"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684430010"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Exp rep
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-226"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684430009"><span class="annot"><span class="annottext">acc_deps :: Names
</span><a href="#local-6989586621684430009"><span class="hs-identifier hs-var hs-var">acc_deps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Names -&gt; k -&gt; Map k Names -&gt; Names
forall k a. Ord k =&gt; a -&gt; k -&gt; Map k a -&gt; a
</span><span class="hs-identifier hs-var">M.findWithDefault</span></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621684430012"><span class="hs-identifier hs-var">pat_acc_nm</span></a></span><span> </span><span class="annot"><span class="annottext">Map k Names
</span><a href="#local-6989586621684430011"><span class="hs-identifier hs-var">variance</span></a></span><span>
</span><span id="line-227"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Bool) -&gt; [VName] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#nameIn"><span class="hs-operator hs-var">`nameIn`</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684430009"><span class="hs-identifier hs-var">acc_deps</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; Bool) -&gt; [VName] -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat rep -&gt; [VName]
forall dec. PatT dec -&gt; [VName]
</span><a href="Futhark.IR.Prop.Patterns.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684430010"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-228"></span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#genRed2Tile2d"><span class="hs-identifier hs-var">genRed2Tile2d</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Stm GPU
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-229"></span><span>  </span><span class="annot"><span class="annottext">Maybe (Stms GPU, Stm GPU) -&gt; GenRedM (Maybe (Stms GPU, Stm GPU))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Stms GPU, Stm GPU)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-230"></span><span>
</span><span id="line-231"></span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#genRed2SegRed"><span class="hs-identifier hs-type">genRed2SegRed</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.TileLoops.Shared.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#GenRedM"><span class="hs-identifier hs-type">GenRedM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-232"></span><span id="genRed2SegRed"><span class="annot"><span class="annottext">genRed2SegRed :: Env -&gt; Stm GPU -&gt; GenRedM (Maybe (Stms GPU, Stm GPU))
</span><a href="Futhark.Optimise.GenRedOpt.html#genRed2SegRed"><span class="hs-identifier hs-var hs-var">genRed2SegRed</span></a></span></span><span> </span><span class="annot"><span class="annottext">Env
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Stm GPU
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-233"></span><span>  </span><span class="annot"><span class="annottext">Maybe (Stms GPU, Stm GPU) -&gt; GenRedM (Maybe (Stms GPU, Stm GPU))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Stms GPU, Stm GPU)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-234"></span><span>
</span><span id="line-235"></span><span class="hs-comment">-- M.Map VName ([Int], VName, Stms GPU)</span><span>
</span><span id="line-236"></span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#transposeFVs"><span class="hs-identifier hs-type">transposeFVs</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-237"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-238"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.TileLoops.Shared.html#VarianceTable"><span class="hs-identifier hs-type">VarianceTable</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-239"></span><span>  </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-240"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-241"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#GenRedM"><span class="hs-identifier hs-type">GenRedM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-242"></span><span id="transposeFVs"><span class="annot"><span class="annottext">transposeFVs :: Names
-&gt; VarianceTable
-&gt; VName
-&gt; Stms GPU
-&gt; GenRedM (Stms GPU, Stms GPU)
</span><a href="Futhark.Optimise.GenRedOpt.html#transposeFVs"><span class="hs-identifier hs-var hs-var">transposeFVs</span></a></span></span><span> </span><span id="local-6989586621684430008"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684430008"><span class="hs-identifier hs-var">fvs</span></a></span></span><span> </span><span id="local-6989586621684430007"><span class="annot"><span class="annottext">VarianceTable
</span><a href="#local-6989586621684430007"><span class="hs-identifier hs-var">variance</span></a></span></span><span> </span><span id="local-6989586621684430006"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684430006"><span class="hs-identifier hs-var">gid</span></a></span></span><span> </span><span id="local-6989586621684430005"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684430005"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-243"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684430004"><span class="annot"><span class="annottext">Map VName ([Int], VName, Stms GPU)
</span><a href="#local-6989586621684430004"><span class="hs-identifier hs-var">tab</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684430003"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684430003"><span class="hs-identifier hs-var">stms'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((Map VName ([Int], VName, Stms GPU), Stms GPU)
 -&gt; Stm GPU
 -&gt; ReaderT
      (Scope GPU)
      (State VNameSource)
      (Map VName ([Int], VName, Stms GPU), Stms GPU))
-&gt; (Map VName ([Int], VName, Stms GPU), Stms GPU)
-&gt; [Stm GPU]
-&gt; ReaderT
     (Scope GPU)
     (State VNameSource)
     (Map VName ([Int], VName, Stms GPU), Stms GPU)
forall (t :: * -&gt; *) (m :: * -&gt; *) b a.
(Foldable t, Monad m) =&gt;
(b -&gt; a -&gt; m b) -&gt; b -&gt; t a -&gt; m b
</span><span class="hs-identifier hs-var">foldM</span></span><span> </span><span class="annot"><span class="annottext">(Map VName ([Int], VName, Stms GPU), Stms GPU)
-&gt; Stm GPU
-&gt; ReaderT
     (Scope GPU)
     (State VNameSource)
     (Map VName ([Int], VName, Stms GPU), Stms GPU)
</span><a href="#local-6989586621684430002"><span class="hs-identifier hs-var">foldfun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName ([Int], VName, Stms GPU)
forall k a. Map k a
</span><span class="hs-identifier hs-var">M.empty</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stms GPU
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Stm GPU]
 -&gt; ReaderT
      (Scope GPU)
      (State VNameSource)
      (Map VName ([Int], VName, Stms GPU), Stms GPU))
-&gt; [Stm GPU]
-&gt; ReaderT
     (Scope GPU)
     (State VNameSource)
     (Map VName ([Int], VName, Stms GPU), Stms GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stms GPU -&gt; [Stm GPU]
forall rep. Stms rep -&gt; [Stm rep]
</span><a href="Futhark.IR.Syntax.html#stmsToList"><span class="hs-identifier hs-var">stmsToList</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684430005"><span class="hs-identifier hs-var">stms</span></a></span><span>
</span><span id="line-244"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684430001"><span class="annot"><span class="annottext">stms_host :: Stms GPU
</span><a href="#local-6989586621684430001"><span class="hs-identifier hs-var hs-var">stms_host</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(([Int], VName, Stms GPU) -&gt; Stms GPU -&gt; Stms GPU)
-&gt; Stms GPU -&gt; Map VName ([Int], VName, Stms GPU) -&gt; Stms GPU
forall a b k. (a -&gt; b -&gt; b) -&gt; b -&gt; Map k a -&gt; b
</span><span class="hs-identifier hs-var">M.foldr</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Int]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684429999"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684429999"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684429998"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684429998"><span class="hs-identifier hs-var">ss</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684429998"><span class="hs-identifier hs-var">ss</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPU -&gt; Stms GPU -&gt; Stms GPU
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684429999"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stms GPU
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">Map VName ([Int], VName, Stms GPU)
</span><a href="#local-6989586621684430004"><span class="hs-identifier hs-var">tab</span></a></span><span>
</span><span id="line-245"></span><span>  </span><span class="annot"><span class="annottext">(Stms GPU, Stms GPU) -&gt; GenRedM (Stms GPU, Stms GPU)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684430003"><span class="hs-identifier hs-var">stms'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684430001"><span class="hs-identifier hs-var">stms_host</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-246"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-247"></span><span>    </span><span id="local-6989586621684430002"><span class="annot"><span class="annottext">foldfun :: (Map VName ([Int], VName, Stms GPU), Stms GPU)
-&gt; Stm GPU
-&gt; ReaderT
     (Scope GPU)
     (State VNameSource)
     (Map VName ([Int], VName, Stms GPU), Stms GPU)
</span><a href="#local-6989586621684430002"><span class="hs-identifier hs-var hs-var">foldfun</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684429997"><span class="annot"><span class="annottext">Map VName ([Int], VName, Stms GPU)
</span><a href="#local-6989586621684429997"><span class="hs-identifier hs-var">tab</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684429996"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684429996"><span class="hs-identifier hs-var">all_stms</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684429995"><span class="annot"><span class="annottext">Stm GPU
</span><a href="#local-6989586621684429995"><span class="hs-identifier hs-var">stm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-248"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684429994"><span class="annot"><span class="annottext">Map VName ([Int], VName, Stms GPU)
</span><a href="#local-6989586621684429994"><span class="hs-identifier hs-var">tab'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684429993"><span class="annot"><span class="annottext">Stm GPU
</span><a href="#local-6989586621684429993"><span class="hs-identifier hs-var">stm'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Map VName ([Int], VName, Stms GPU), Stm GPU)
-&gt; ReaderT
     (Scope GPU)
     (State VNameSource)
     (Map VName ([Int], VName, Stms GPU), Stm GPU)
</span><a href="#local-6989586621684429992"><span class="hs-identifier hs-var">transposeFV</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName ([Int], VName, Stms GPU)
</span><a href="#local-6989586621684429997"><span class="hs-identifier hs-var">tab</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stm GPU
</span><a href="#local-6989586621684429995"><span class="hs-identifier hs-var">stm</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-249"></span><span>      </span><span class="annot"><span class="annottext">(Map VName ([Int], VName, Stms GPU), Stms GPU)
-&gt; ReaderT
     (Scope GPU)
     (State VNameSource)
     (Map VName ([Int], VName, Stms GPU), Stms GPU)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName ([Int], VName, Stms GPU)
</span><a href="#local-6989586621684429994"><span class="hs-identifier hs-var">tab'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684429996"><span class="hs-identifier hs-var">all_stms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPU -&gt; Stms GPU -&gt; Stms GPU
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Stm GPU -&gt; Stms GPU
forall rep. Stm rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#oneStm"><span class="hs-identifier hs-var">oneStm</span></a></span><span> </span><span class="annot"><span class="annottext">Stm GPU
</span><a href="#local-6989586621684429993"><span class="hs-identifier hs-var">stm'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-250"></span><span>    </span><span class="hs-comment">-- ToDo: currently handles only 2-dim arrays, please generalize</span><span>
</span><span id="line-251"></span><span>    </span><span id="local-6989586621684429992"><span class="annot"><span class="annottext">transposeFV :: (Map VName ([Int], VName, Stms GPU), Stm GPU)
-&gt; ReaderT
     (Scope GPU)
     (State VNameSource)
     (Map VName ([Int], VName, Stms GPU), Stm GPU)
</span><a href="#local-6989586621684429992"><span class="hs-identifier hs-var hs-var">transposeFV</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684429991"><span class="annot"><span class="annottext">Map VName ([Int], VName, Stms GPU)
</span><a href="#local-6989586621684429991"><span class="hs-identifier hs-var">tab</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684429990"><span class="annot"><span class="annottext">Pat GPU
</span><a href="#local-6989586621684429990"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684429989"><span class="annot"><span class="annottext">StmAux (ExpDec GPU)
</span><a href="#local-6989586621684429989"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Index"><span class="hs-identifier hs-type">Index</span></a></span><span> </span><span id="local-6989586621684429988"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684429988"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span id="local-6989586621684429987"><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684429987"><span class="hs-identifier hs-var">slc</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-252"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621684429986"><span class="annot"><span class="annottext">[DimIndex SubExp]
</span><a href="#local-6989586621684429986"><span class="hs-identifier hs-var">dims</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Slice SubExp -&gt; [DimIndex SubExp]
forall d. Slice d -&gt; [DimIndex d]
</span><a href="Futhark.IR.Syntax.Core.html#unSlice"><span class="hs-identifier hs-var hs-var">unSlice</span></a></span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684429987"><span class="hs-identifier hs-var">slc</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-253"></span><span>        </span><span class="annot"><span class="annottext">(DimIndex SubExp -&gt; Bool) -&gt; [DimIndex SubExp] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="annot"><span class="annottext">DimIndex SubExp -&gt; Bool
forall {d}. DimIndex d -&gt; Bool
</span><a href="#local-6989586621684429985"><span class="hs-identifier hs-var">isFixDim</span></a></span><span> </span><span class="annot"><span class="annottext">[DimIndex SubExp]
</span><a href="#local-6989586621684429986"><span class="hs-identifier hs-var">dims</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-254"></span><span>        </span><span class="annot"><span class="annottext">VName -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#nameIn"><span class="hs-identifier hs-var">nameIn</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684429988"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684430008"><span class="hs-identifier hs-var">fvs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-255"></span><span>        </span><span id="local-6989586621684429984"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684429984"><span class="hs-identifier hs-var">iis</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(DimIndex SubExp -&gt; Bool) -&gt; [DimIndex SubExp] -&gt; [Int]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [Int]
</span><span class="hs-identifier hs-var">L.findIndices</span></span><span> </span><span class="annot"><span class="annottext">DimIndex SubExp -&gt; Bool
</span><a href="#local-6989586621684429982"><span class="hs-identifier hs-var">depOnGid</span></a></span><span> </span><span class="annot"><span class="annottext">[DimIndex SubExp]
</span><a href="#local-6989586621684429986"><span class="hs-identifier hs-var">dims</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-256"></span><span>        </span><span class="hs-special">[</span><span id="local-6989586621684429981"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684429981"><span class="hs-identifier hs-var">ii</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684429984"><span class="hs-identifier hs-var">iis</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-257"></span><span>        </span><span class="hs-comment">-- generalize below: treat any rearange and add to tab if not there.</span><span>
</span><span id="line-258"></span><span>        </span><span class="annot"><span class="annottext">Maybe ([Int], VName, Stms GPU)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName
-&gt; Map VName ([Int], VName, Stms GPU)
-&gt; Maybe ([Int], VName, Stms GPU)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684429988"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName ([Int], VName, Stms GPU)
</span><a href="#local-6989586621684429991"><span class="hs-identifier hs-var">tab</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-259"></span><span>        </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684429981"><span class="hs-identifier hs-var">ii</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">[DimIndex SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[DimIndex SubExp]
</span><a href="#local-6989586621684429986"><span class="hs-identifier hs-var">dims</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">,</span><span>
</span><span id="line-260"></span><span>        </span><span id="local-6989586621684429979"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684429979"><span class="hs-identifier hs-var">perm</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684429981"><span class="hs-identifier hs-var">ii</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; [Int] -&gt; [Int]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684429981"><span class="hs-identifier hs-var">ii</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">[DimIndex SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[DimIndex SubExp]
</span><a href="#local-6989586621684429986"><span class="hs-identifier hs-var">dims</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; [Int] -&gt; [Int]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684429981"><span class="hs-identifier hs-var">ii</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-261"></span><span>        </span><span class="hs-comment">--        length dims == 2,</span><span>
</span><span id="line-262"></span><span>        </span><span class="hs-comment">--        ii == 0 = do</span><span>
</span><span id="line-263"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621684429977"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684429977"><span class="hs-identifier hs-var">arr_tr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684429976"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684429976"><span class="hs-identifier hs-var">stms_tr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">BuilderT GPU (ReaderT (Scope GPU) (State VNameSource)) VName
-&gt; ReaderT (Scope GPU) (State VNameSource) (VName, Stms GPU)
forall (m :: * -&gt; *) somerep rep a.
(MonadFreshNames m, HasScope somerep m, SameScope somerep rep) =&gt;
BuilderT rep m a -&gt; m (a, Stms rep)
</span><a href="Futhark.Builder.html#runBuilderT%27"><span class="hs-identifier hs-var">runBuilderT'</span></a></span><span> </span><span class="annot"><span class="annottext">(BuilderT GPU (ReaderT (Scope GPU) (State VNameSource)) VName
 -&gt; ReaderT (Scope GPU) (State VNameSource) (VName, Stms GPU))
-&gt; BuilderT GPU (ReaderT (Scope GPU) (State VNameSource)) VName
-&gt; ReaderT (Scope GPU) (State VNameSource) (VName, Stms GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-264"></span><span>          </span><span id="local-6989586621684429975"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684429975"><span class="hs-identifier hs-var">arr'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String
-&gt; Exp
     (Rep (BuilderT GPU (ReaderT (Scope GPU) (State VNameSource))))
-&gt; BuilderT GPU (ReaderT (Scope GPU) (State VNameSource)) VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m VName
</span><a href="Futhark.Construct.html#letExp"><span class="hs-identifier hs-var">letExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; String
</span><a href="Language.Futhark.Core.html#baseString"><span class="hs-identifier hs-var">baseString</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684429988"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_trsp&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (BuilderT GPU (ReaderT (Scope GPU) (State VNameSource))))
 -&gt; BuilderT GPU (ReaderT (Scope GPU) (State VNameSource)) VName)
-&gt; Exp
     (Rep (BuilderT GPU (ReaderT (Scope GPU) (State VNameSource))))
-&gt; BuilderT GPU (ReaderT (Scope GPU) (State VNameSource)) VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT GPU
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT GPU) -&gt; BasicOp -&gt; ExpT GPU
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; VName -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Rearrange"><span class="hs-identifier hs-var">Rearrange</span></a></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684429979"><span class="hs-identifier hs-var">perm</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684429988"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="hs-comment">--Manifest [1,0] arr</span><span>
</span><span id="line-265"></span><span>          </span><span class="annot"><span class="annottext">String
-&gt; Exp
     (Rep (BuilderT GPU (ReaderT (Scope GPU) (State VNameSource))))
-&gt; BuilderT GPU (ReaderT (Scope GPU) (State VNameSource)) VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m VName
</span><a href="Futhark.Construct.html#letExp"><span class="hs-identifier hs-var">letExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; String
</span><a href="Language.Futhark.Core.html#baseString"><span class="hs-identifier hs-var">baseString</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684429975"><span class="hs-identifier hs-var">arr'</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_opaque&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (BuilderT GPU (ReaderT (Scope GPU) (State VNameSource))))
 -&gt; BuilderT GPU (ReaderT (Scope GPU) (State VNameSource)) VName)
-&gt; Exp
     (Rep (BuilderT GPU (ReaderT (Scope GPU) (State VNameSource))))
-&gt; BuilderT GPU (ReaderT (Scope GPU) (State VNameSource)) VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT GPU
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT GPU) -&gt; BasicOp -&gt; ExpT GPU
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">OpaqueOp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Opaque"><span class="hs-identifier hs-var">Opaque</span></a></span><span> </span><span class="annot"><span class="annottext">OpaqueOp
</span><a href="Futhark.IR.Syntax.html#OpaqueNil"><span class="hs-identifier hs-var">OpaqueNil</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; BasicOp) -&gt; SubExp -&gt; BasicOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684429975"><span class="hs-identifier hs-var">arr'</span></a></span><span>
</span><span id="line-266"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684429971"><span class="annot"><span class="annottext">tab' :: Map VName ([Int], VName, Stms GPU)
</span><a href="#local-6989586621684429971"><span class="hs-identifier hs-var hs-var">tab'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName
-&gt; ([Int], VName, Stms GPU)
-&gt; Map VName ([Int], VName, Stms GPU)
-&gt; Map VName ([Int], VName, Stms GPU)
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684429988"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684429979"><span class="hs-identifier hs-var">perm</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684429977"><span class="hs-identifier hs-var">arr_tr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684429976"><span class="hs-identifier hs-var">stms_tr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map VName ([Int], VName, Stms GPU)
</span><a href="#local-6989586621684429991"><span class="hs-identifier hs-var">tab</span></a></span><span>
</span><span id="line-267"></span><span>            </span><span id="local-6989586621684429969"><span class="annot"><span class="annottext">slc' :: Slice SubExp
</span><a href="#local-6989586621684429969"><span class="hs-identifier hs-var hs-var">slc'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[DimIndex SubExp] -&gt; Slice SubExp
forall d. [DimIndex d] -&gt; Slice d
</span><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-var">Slice</span></a></span><span> </span><span class="annot"><span class="annottext">([DimIndex SubExp] -&gt; Slice SubExp)
-&gt; [DimIndex SubExp] -&gt; Slice SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; DimIndex SubExp) -&gt; [Int] -&gt; [DimIndex SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DimIndex SubExp]
</span><a href="#local-6989586621684429986"><span class="hs-identifier hs-var">dims</span></a></span><span> </span><span class="annot"><span class="annottext">[DimIndex SubExp] -&gt; Int -&gt; DimIndex SubExp
forall a. [a] -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">!!</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684429979"><span class="hs-identifier hs-var">perm</span></a></span><span>
</span><span id="line-268"></span><span>            </span><span id="local-6989586621684429967"><span class="annot"><span class="annottext">stm' :: Stm GPU
</span><a href="#local-6989586621684429967"><span class="hs-identifier hs-var hs-var">stm'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Pat GPU -&gt; StmAux (ExpDec GPU) -&gt; ExpT GPU -&gt; Stm GPU
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPU
</span><a href="#local-6989586621684429990"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec GPU)
</span><a href="#local-6989586621684429989"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">(ExpT GPU -&gt; Stm GPU) -&gt; ExpT GPU -&gt; Stm GPU
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT GPU
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT GPU) -&gt; BasicOp -&gt; ExpT GPU
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Slice SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Index"><span class="hs-identifier hs-var">Index</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684429977"><span class="hs-identifier hs-var">arr_tr</span></a></span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684429969"><span class="hs-identifier hs-var">slc'</span></a></span><span>
</span><span id="line-269"></span><span>        </span><span class="annot"><span class="annottext">(Map VName ([Int], VName, Stms GPU), Stm GPU)
-&gt; ReaderT
     (Scope GPU)
     (State VNameSource)
     (Map VName ([Int], VName, Stms GPU), Stm GPU)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName ([Int], VName, Stms GPU)
</span><a href="#local-6989586621684429971"><span class="hs-identifier hs-var">tab'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stm GPU
</span><a href="#local-6989586621684429967"><span class="hs-identifier hs-var">stm'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-270"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-271"></span><span>        </span><span id="local-6989586621684429985"><span class="annot"><span class="annottext">isFixDim :: DimIndex d -&gt; Bool
</span><a href="#local-6989586621684429985"><span class="hs-identifier hs-var hs-var">isFixDim</span></a></span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-type">DimFix</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-272"></span><span>        </span><span class="annot"><a href="#local-6989586621684429985"><span class="hs-identifier hs-var">isFixDim</span></a></span><span> </span><span class="annot"><span class="annottext">DimIndex d
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-273"></span><span>        </span><span id="local-6989586621684429982"><span class="annot"><span class="annottext">depOnGid :: DimIndex SubExp -&gt; Bool
</span><a href="#local-6989586621684429982"><span class="hs-identifier hs-var hs-var">depOnGid</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-type">DimFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684429966"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684429966"><span class="hs-identifier hs-var">nm</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-274"></span><span>          </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684430006"><span class="hs-identifier hs-var">gid</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; VName -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684429966"><span class="hs-identifier hs-var">nm</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#nameIn"><span class="hs-identifier hs-var">nameIn</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684430006"><span class="hs-identifier hs-var">gid</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Names -&gt; VName -&gt; VarianceTable -&gt; Names
forall k a. Ord k =&gt; a -&gt; k -&gt; Map k a -&gt; a
</span><span class="hs-identifier hs-var">M.findWithDefault</span></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684429966"><span class="hs-identifier hs-var">nm</span></a></span><span> </span><span class="annot"><span class="annottext">VarianceTable
</span><a href="#local-6989586621684430007"><span class="hs-identifier hs-var">variance</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-275"></span><span>        </span><span class="annot"><a href="#local-6989586621684429982"><span class="hs-identifier hs-var">depOnGid</span></a></span><span> </span><span class="annot"><span class="annottext">DimIndex SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-276"></span><span>    </span><span class="annot"><a href="#local-6989586621684429992"><span class="hs-identifier hs-var">transposeFV</span></a></span><span> </span><span id="local-6989586621684429965"><span class="annot"><span class="annottext">(Map VName ([Int], VName, Stms GPU), Stm GPU)
</span><a href="#local-6989586621684429965"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Map VName ([Int], VName, Stms GPU), Stm GPU)
-&gt; ReaderT
     (Scope GPU)
     (State VNameSource)
     (Map VName ([Int], VName, Stms GPU), Stm GPU)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Map VName ([Int], VName, Stms GPU), Stm GPU)
</span><a href="#local-6989586621684429965"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-277"></span><span>
</span><span id="line-278"></span><span class="hs-comment">-- | Tries to identify the following pattern:</span><span>
</span><span id="line-279"></span><span class="hs-comment">--   code followed by some UpdateAcc-statement</span><span>
</span><span id="line-280"></span><span class="hs-comment">--   followed by more code.</span><span>
</span><span id="line-281"></span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#matchCodeAccumCode"><span class="hs-identifier hs-type">matchCodeAccumCode</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-282"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-283"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-284"></span><span id="matchCodeAccumCode"><span class="annot"><span class="annottext">matchCodeAccumCode :: Stms GPU -&gt; (Stms GPU, Maybe (Stm GPU), Stms GPU)
</span><a href="Futhark.Optimise.GenRedOpt.html#matchCodeAccumCode"><span class="hs-identifier hs-var hs-var">matchCodeAccumCode</span></a></span></span><span> </span><span id="local-6989586621684429964"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684429964"><span class="hs-identifier hs-var">kstms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-285"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684429963"><span class="annot"><span class="annottext">[Stm GPU]
</span><a href="#local-6989586621684429963"><span class="hs-identifier hs-var">code1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684429962"><span class="annot"><span class="annottext">Maybe (Stm GPU)
</span><a href="#local-6989586621684429962"><span class="hs-identifier hs-var">screma</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684429961"><span class="annot"><span class="annottext">[Stm GPU]
</span><a href="#local-6989586621684429961"><span class="hs-identifier hs-var">code2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-286"></span><span>        </span><span class="annot"><span class="annottext">(([Stm GPU], Maybe (Stm GPU), [Stm GPU])
 -&gt; Stm GPU -&gt; ([Stm GPU], Maybe (Stm GPU), [Stm GPU]))
-&gt; ([Stm GPU], Maybe (Stm GPU), [Stm GPU])
-&gt; [Stm GPU]
-&gt; ([Stm GPU], Maybe (Stm GPU), [Stm GPU])
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl</span></span><span>
</span><span id="line-287"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684429960"><span class="annot"><span class="annottext">([Stm GPU], Maybe (Stm GPU), [Stm GPU])
</span><a href="#local-6989586621684429960"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621684429959"><span class="annot"><span class="annottext">Stm GPU
</span><a href="#local-6989586621684429959"><span class="hs-identifier hs-var">stmt</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-288"></span><span>              </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">([Stm GPU], Maybe (Stm GPU), [Stm GPU])
</span><a href="#local-6989586621684429960"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stm GPU
</span><a href="#local-6989586621684429959"><span class="hs-identifier hs-var">stmt</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-289"></span><span>                </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621684429958"><span class="annot"><span class="annottext">[Stm GPU]
</span><a href="#local-6989586621684429958"><span class="hs-identifier hs-var">cd1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (Stm GPU)
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684429957"><span class="annot"><span class="annottext">[Stm GPU]
</span><a href="#local-6989586621684429957"><span class="hs-identifier hs-var">cd2</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPU
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec GPU)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#UpdateAcc"><span class="hs-identifier hs-type">UpdateAcc</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-290"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Stm GPU]
</span><a href="#local-6989586621684429958"><span class="hs-identifier hs-var">cd1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stm GPU -&gt; Maybe (Stm GPU)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Stm GPU
</span><a href="#local-6989586621684429959"><span class="hs-identifier hs-var">stmt</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Stm GPU]
</span><a href="#local-6989586621684429957"><span class="hs-identifier hs-var">cd2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-291"></span><span>                </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621684429956"><span class="annot"><span class="annottext">[Stm GPU]
</span><a href="#local-6989586621684429956"><span class="hs-identifier hs-var">cd1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (Stm GPU)
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684429955"><span class="annot"><span class="annottext">[Stm GPU]
</span><a href="#local-6989586621684429955"><span class="hs-identifier hs-var">cd2</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stm GPU
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-292"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Stm GPU]
</span><a href="#local-6989586621684429956"><span class="hs-identifier hs-var">cd1</span></a></span><span> </span><span class="annot"><span class="annottext">[Stm GPU] -&gt; [Stm GPU] -&gt; [Stm GPU]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Stm GPU
</span><a href="#local-6989586621684429959"><span class="hs-identifier hs-var">stmt</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (Stm GPU)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Stm GPU]
</span><a href="#local-6989586621684429955"><span class="hs-identifier hs-var">cd2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-293"></span><span>                </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621684429954"><span class="annot"><span class="annottext">[Stm GPU]
</span><a href="#local-6989586621684429954"><span class="hs-identifier hs-var">cd1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684429953"><span class="annot"><span class="annottext">Stm GPU
</span><a href="#local-6989586621684429953"><span class="hs-identifier hs-var">strm</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684429952"><span class="annot"><span class="annottext">[Stm GPU]
</span><a href="#local-6989586621684429952"><span class="hs-identifier hs-var">cd2</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stm GPU
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-294"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Stm GPU]
</span><a href="#local-6989586621684429954"><span class="hs-identifier hs-var">cd1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stm GPU -&gt; Maybe (Stm GPU)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Stm GPU
</span><a href="#local-6989586621684429953"><span class="hs-identifier hs-var">strm</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Stm GPU]
</span><a href="#local-6989586621684429952"><span class="hs-identifier hs-var">cd2</span></a></span><span> </span><span class="annot"><span class="annottext">[Stm GPU] -&gt; [Stm GPU] -&gt; [Stm GPU]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Stm GPU
</span><a href="#local-6989586621684429959"><span class="hs-identifier hs-var">stmt</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-295"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-296"></span><span>          </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (Stm GPU)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-297"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms GPU -&gt; [Stm GPU]
forall rep. Stms rep -&gt; [Stm rep]
</span><a href="Futhark.IR.Syntax.html#stmsToList"><span class="hs-identifier hs-var">stmsToList</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684429964"><span class="hs-identifier hs-var">kstms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-298"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Stm GPU] -&gt; Stms GPU
forall rep. [Stm rep] -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#stmsFromList"><span class="hs-identifier hs-var">stmsFromList</span></a></span><span> </span><span class="annot"><span class="annottext">[Stm GPU]
</span><a href="#local-6989586621684429963"><span class="hs-identifier hs-var">code1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (Stm GPU)
</span><a href="#local-6989586621684429962"><span class="hs-identifier hs-var">screma</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Stm GPU] -&gt; Stms GPU
forall rep. [Stm rep] -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#stmsFromList"><span class="hs-identifier hs-var">stmsFromList</span></a></span><span> </span><span class="annot"><span class="annottext">[Stm GPU]
</span><a href="#local-6989586621684429961"><span class="hs-identifier hs-var">code2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-299"></span><span>
</span><span id="line-300"></span><span class="hs-comment">-- | Checks that there exist a parallel dimension (among `kids`),</span><span>
</span><span id="line-301"></span><span class="hs-comment">--     to which all the indices (`acc_inds`) are invariant to.</span><span>
</span><span id="line-302"></span><span class="hs-comment">--   It returns the innermost such parallel dimension, as a tuple</span><span>
</span><span id="line-303"></span><span class="hs-comment">--     of the pardim gid (`VName`) and its index (`Int`) in the</span><span>
</span><span id="line-304"></span><span class="hs-comment">--     parallel space.</span><span>
</span><span id="line-305"></span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#isInvarToParDim"><span class="hs-identifier hs-type">isInvarToParDim</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-306"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-307"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegSpace"><span class="hs-identifier hs-type">SegSpace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-308"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.TileLoops.Shared.html#VarianceTable"><span class="hs-identifier hs-type">VarianceTable</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-309"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-310"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span>
</span><span id="line-311"></span><span id="isInvarToParDim"><span class="annot"><span class="annottext">isInvarToParDim :: Names
-&gt; SegSpace -&gt; VarianceTable -&gt; [SubExp] -&gt; Maybe (VName, Int)
</span><a href="Futhark.Optimise.GenRedOpt.html#isInvarToParDim"><span class="hs-identifier hs-var hs-var">isInvarToParDim</span></a></span></span><span> </span><span id="local-6989586621684429951"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684429951"><span class="hs-identifier hs-var">branch_variant</span></a></span></span><span> </span><span id="local-6989586621684429950"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684429950"><span class="hs-identifier hs-var">kspace</span></a></span></span><span> </span><span id="local-6989586621684429949"><span class="annot"><span class="annottext">VarianceTable
</span><a href="#local-6989586621684429949"><span class="hs-identifier hs-var">variance</span></a></span></span><span> </span><span id="local-6989586621684429948"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684429948"><span class="hs-identifier hs-var">acc_inds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-312"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684429947"><span class="annot"><span class="annottext">ker_gids :: [VName]
</span><a href="#local-6989586621684429947"><span class="hs-identifier hs-var hs-var">ker_gids</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((VName, SubExp) -&gt; VName) -&gt; [(VName, SubExp)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(VName, SubExp) -&gt; VName
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">([(VName, SubExp)] -&gt; [VName]) -&gt; [(VName, SubExp)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; [(VName, SubExp)]
</span><a href="Futhark.IR.SegOp.html#unSegSpace"><span class="hs-identifier hs-var hs-var">unSegSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684429950"><span class="hs-identifier hs-var">kspace</span></a></span><span>
</span><span id="line-313"></span><span>      </span><span id="local-6989586621684429946"><span class="annot"><span class="annottext">branch_invariant :: Bool
</span><a href="#local-6989586621684429946"><span class="hs-identifier hs-var hs-var">branch_invariant</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Bool) -&gt; [VName] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#nameIn"><span class="hs-operator hs-var">`nameIn`</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684429951"><span class="hs-identifier hs-var">branch_variant</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684429947"><span class="hs-identifier hs-var">ker_gids</span></a></span><span>
</span><span id="line-314"></span><span>      </span><span id="local-6989586621684429945"><span class="annot"><span class="annottext">allvar2 :: Names
</span><a href="#local-6989586621684429945"><span class="hs-identifier hs-var hs-var">allvar2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; [VName] -&gt; Names
</span><a href="#local-6989586621684429944"><span class="hs-identifier hs-var">allvariant2</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684429948"><span class="hs-identifier hs-var">acc_inds</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684429947"><span class="hs-identifier hs-var">ker_gids</span></a></span><span>
</span><span id="line-315"></span><span>      </span><span id="local-6989586621684429943"><span class="annot"><span class="annottext">last_invar_dim :: Maybe (VName, Int)
</span><a href="#local-6989586621684429943"><span class="hs-identifier hs-var hs-var">last_invar_dim</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-316"></span><span>        </span><span class="annot"><span class="annottext">(Maybe (VName, Int) -&gt; (VName, Int) -&gt; Maybe (VName, Int))
-&gt; Maybe (VName, Int) -&gt; [(VName, Int)] -&gt; Maybe (VName, Int)
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Names -&gt; Maybe (VName, Int) -&gt; (VName, Int) -&gt; Maybe (VName, Int)
forall {b}.
Names -&gt; Maybe (VName, b) -&gt; (VName, b) -&gt; Maybe (VName, b)
</span><a href="#local-6989586621684429942"><span class="hs-identifier hs-var">lastNotIn</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684429945"><span class="hs-identifier hs-var">allvar2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe (VName, Int)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">([(VName, Int)] -&gt; Maybe (VName, Int))
-&gt; [(VName, Int)] -&gt; Maybe (VName, Int)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-317"></span><span>          </span><span class="annot"><span class="annottext">[VName] -&gt; [Int] -&gt; [(VName, Int)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684429947"><span class="hs-identifier hs-var">ker_gids</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684429947"><span class="hs-identifier hs-var">ker_gids</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span>
</span><span id="line-318"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684429946"><span class="hs-identifier hs-var">branch_invariant</span></a></span><span>
</span><span id="line-319"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Maybe (VName, Int)
</span><a href="#local-6989586621684429943"><span class="hs-identifier hs-var">last_invar_dim</span></a></span><span>
</span><span id="line-320"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Maybe (VName, Int)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-321"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-322"></span><span>    </span><span id="local-6989586621684429941"><span class="annot"><span class="annottext">variant2 :: SubExp -&gt; [VName] -&gt; [VName]
</span><a href="#local-6989586621684429941"><span class="hs-identifier hs-var hs-var">variant2</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684429940"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684429940"><span class="hs-identifier hs-var">ind</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684429939"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684429939"><span class="hs-identifier hs-var">kids</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-323"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684429938"><span class="annot"><span class="annottext">variant_to :: Names
</span><a href="#local-6989586621684429938"><span class="hs-identifier hs-var hs-var">variant_to</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-324"></span><span>            </span><span class="annot"><span class="annottext">Names -&gt; VName -&gt; VarianceTable -&gt; Names
forall k a. Ord k =&gt; a -&gt; k -&gt; Map k a -&gt; a
</span><span class="hs-identifier hs-var">M.findWithDefault</span></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684429940"><span class="hs-identifier hs-var">ind</span></a></span><span> </span><span class="annot"><span class="annottext">VarianceTable
</span><a href="#local-6989586621684429949"><span class="hs-identifier hs-var">variance</span></a></span><span>
</span><span id="line-325"></span><span>              </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684429940"><span class="hs-identifier hs-var">ind</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [VName] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684429939"><span class="hs-identifier hs-var">kids</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#oneName"><span class="hs-identifier hs-var">oneName</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684429940"><span class="hs-identifier hs-var">ind</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span>
</span><span id="line-326"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Bool) -&gt; [VName] -&gt; [VName]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#nameIn"><span class="hs-operator hs-var">`nameIn`</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684429938"><span class="hs-identifier hs-var">variant_to</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684429939"><span class="hs-identifier hs-var">kids</span></a></span><span>
</span><span id="line-327"></span><span>    </span><span class="annot"><a href="#local-6989586621684429941"><span class="hs-identifier hs-var">variant2</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-328"></span><span>    </span><span id="local-6989586621684429944"><span class="annot"><span class="annottext">allvariant2 :: [SubExp] -&gt; [VName] -&gt; Names
</span><a href="#local-6989586621684429944"><span class="hs-identifier hs-var hs-var">allvariant2</span></a></span></span><span> </span><span id="local-6989586621684429935"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684429935"><span class="hs-identifier hs-var">ind_ses</span></a></span></span><span> </span><span id="local-6989586621684429934"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684429934"><span class="hs-identifier hs-var">kids</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-329"></span><span>      </span><span class="annot"><span class="annottext">[VName] -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#namesFromList"><span class="hs-identifier hs-var">namesFromList</span></a></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; Names) -&gt; [VName] -&gt; Names
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; [VName]) -&gt; [SubExp] -&gt; [VName]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp -&gt; [VName] -&gt; [VName]
</span><a href="#local-6989586621684429941"><span class="hs-operator hs-var">`variant2`</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684429934"><span class="hs-identifier hs-var">kids</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684429935"><span class="hs-identifier hs-var">ind_ses</span></a></span><span>
</span><span id="line-330"></span><span>    </span><span id="local-6989586621684429942"><span class="annot"><span class="annottext">lastNotIn :: Names -&gt; Maybe (VName, b) -&gt; (VName, b) -&gt; Maybe (VName, b)
</span><a href="#local-6989586621684429942"><span class="hs-identifier hs-var hs-var">lastNotIn</span></a></span></span><span> </span><span id="local-6989586621684429931"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684429931"><span class="hs-identifier hs-var">allvar2</span></a></span></span><span> </span><span id="local-6989586621684429930"><span class="annot"><span class="annottext">Maybe (VName, b)
</span><a href="#local-6989586621684429930"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684429929"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684429929"><span class="hs-identifier hs-var">kid</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684429928"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684429928"><span class="hs-identifier hs-var">k</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-331"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#nameIn"><span class="hs-identifier hs-var">nameIn</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684429929"><span class="hs-identifier hs-var">kid</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684429931"><span class="hs-identifier hs-var">allvar2</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Maybe (VName, b)
</span><a href="#local-6989586621684429930"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">(VName, b) -&gt; Maybe (VName, b)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684429929"><span class="hs-identifier hs-var">kid</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684429928"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-332"></span><span>
</span><span id="line-333"></span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#allGoodReturns"><span class="hs-identifier hs-type">allGoodReturns</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.SegOp.html#KernelResult"><span class="hs-identifier hs-type">KernelResult</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-334"></span><span id="allGoodReturns"><span class="annot"><span class="annottext">allGoodReturns :: [KernelResult] -&gt; Maybe ([VName], [SubExp])
</span><a href="Futhark.Optimise.GenRedOpt.html#allGoodReturns"><span class="hs-identifier hs-var hs-var">allGoodReturns</span></a></span></span><span> </span><span id="local-6989586621684429927"><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684429927"><span class="hs-identifier hs-var">kres</span></a></span></span><span>
</span><span id="line-335"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">(KernelResult -&gt; Bool) -&gt; [KernelResult] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="annot"><span class="annottext">KernelResult -&gt; Bool
</span><a href="#local-6989586621684429926"><span class="hs-identifier hs-var">goodReturn</span></a></span><span> </span><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684429927"><span class="hs-identifier hs-var">kres</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-336"></span><span>    </span><span class="annot"><span class="annottext">([VName], [SubExp]) -&gt; Maybe ([VName], [SubExp])
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(([VName], [SubExp]) -&gt; Maybe ([VName], [SubExp]))
-&gt; ([VName], [SubExp]) -&gt; Maybe ([VName], [SubExp])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(([VName], [SubExp]) -&gt; KernelResult -&gt; ([VName], [SubExp]))
-&gt; ([VName], [SubExp]) -&gt; [KernelResult] -&gt; ([VName], [SubExp])
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl</span></span><span> </span><span class="annot"><span class="annottext">([VName], [SubExp]) -&gt; KernelResult -&gt; ([VName], [SubExp])
</span><a href="#local-6989586621684429925"><span class="hs-identifier hs-var">addCertAndRes</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684429927"><span class="hs-identifier hs-var">kres</span></a></span><span>
</span><span id="line-337"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-338"></span><span>    </span><span id="local-6989586621684429926"><span class="annot"><span class="annottext">goodReturn :: KernelResult -&gt; Bool
</span><a href="#local-6989586621684429926"><span class="hs-identifier hs-var hs-var">goodReturn</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#Returns"><span class="hs-identifier hs-type">Returns</span></a></span><span> </span><span class="annot"><span class="annottext">ResultManifest
</span><a href="Futhark.IR.SegOp.html#ResultMaySimplify"><span class="hs-identifier hs-var">ResultMaySimplify</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-339"></span><span>    </span><span class="annot"><a href="#local-6989586621684429926"><span class="hs-identifier hs-var">goodReturn</span></a></span><span> </span><span class="annot"><span class="annottext">KernelResult
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-340"></span><span>    </span><span id="local-6989586621684429925"><span class="annot"><span class="annottext">addCertAndRes :: ([VName], [SubExp]) -&gt; KernelResult -&gt; ([VName], [SubExp])
</span><a href="#local-6989586621684429925"><span class="hs-identifier hs-var hs-var">addCertAndRes</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684429922"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684429922"><span class="hs-identifier hs-var">cs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684429921"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684429921"><span class="hs-identifier hs-var">rs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#Returns"><span class="hs-identifier hs-type">Returns</span></a></span><span> </span><span class="annot"><span class="annottext">ResultManifest
</span><a href="Futhark.IR.SegOp.html#ResultMaySimplify"><span class="hs-identifier hs-var">ResultMaySimplify</span></a></span><span> </span><span id="local-6989586621684429920"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684429920"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span id="local-6989586621684429919"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684429919"><span class="hs-identifier hs-var">r_se</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-341"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684429922"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Certs -&gt; [VName]
</span><a href="Futhark.IR.Syntax.Core.html#unCerts"><span class="hs-identifier hs-var hs-var">unCerts</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684429920"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684429921"><span class="hs-identifier hs-var">rs</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; [SubExp] -&gt; [SubExp]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684429919"><span class="hs-identifier hs-var">r_se</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-342"></span><span>    </span><span class="annot"><a href="#local-6989586621684429925"><span class="hs-identifier hs-var">addCertAndRes</span></a></span><span> </span><span class="annot"><span class="annottext">([VName], [SubExp])
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">KernelResult
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-343"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; ([VName], [SubExp])
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Impossible case reached in GenRedOpt.hs, function allGoodReturns!&quot;</span></span><span>
</span><span id="line-344"></span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#allGoodReturns"><span class="hs-identifier hs-var">allGoodReturns</span></a></span><span> </span><span class="annot"><span class="annottext">[KernelResult]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe ([VName], [SubExp])
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-345"></span><span>
</span><span id="line-346"></span><span class="hs-comment">--------------------------</span><span>
</span><span id="line-347"></span><span class="hs-comment">--- Cost Model Helpers ---</span><span>
</span><span id="line-348"></span><span class="hs-comment">--------------------------</span><span>
</span><span id="line-349"></span><span>
</span><span id="line-350"></span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#costRedundantExecution"><span class="hs-identifier hs-type">costRedundantExecution</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-351"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.TileLoops.Shared.html#VarianceTable"><span class="hs-identifier hs-type">VarianceTable</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-352"></span><span>  </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-353"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-354"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-355"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#Cost"><span class="hs-identifier hs-type">Cost</span></a></span><span>
</span><span id="line-356"></span><span id="costRedundantExecution"><span class="annot"><span class="annottext">costRedundantExecution :: VarianceTable -&gt; VName -&gt; [SubExp] -&gt; Stms GPU -&gt; Cost
</span><a href="Futhark.Optimise.GenRedOpt.html#costRedundantExecution"><span class="hs-identifier hs-var hs-var">costRedundantExecution</span></a></span></span><span> </span><span id="local-6989586621684429917"><span class="annot"><span class="annottext">VarianceTable
</span><a href="#local-6989586621684429917"><span class="hs-identifier hs-var">variance</span></a></span></span><span> </span><span id="local-6989586621684429916"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684429916"><span class="hs-identifier hs-var">pat_acc_nm</span></a></span></span><span> </span><span id="local-6989586621684429915"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684429915"><span class="hs-identifier hs-var">r_ses</span></a></span></span><span> </span><span id="local-6989586621684429914"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684429914"><span class="hs-identifier hs-var">kstms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-357"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684429913"><span class="annot"><span class="annottext">acc_deps :: Names
</span><a href="#local-6989586621684429913"><span class="hs-identifier hs-var hs-var">acc_deps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Names -&gt; VName -&gt; VarianceTable -&gt; Names
forall k a. Ord k =&gt; a -&gt; k -&gt; Map k a -&gt; a
</span><span class="hs-identifier hs-var">M.findWithDefault</span></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684429916"><span class="hs-identifier hs-var">pat_acc_nm</span></a></span><span> </span><span class="annot"><span class="annottext">VarianceTable
</span><a href="#local-6989586621684429917"><span class="hs-identifier hs-var">variance</span></a></span><span>
</span><span id="line-358"></span><span>      </span><span id="local-6989586621684429912"><span class="annot"><span class="annottext">vartab_cut_acc :: VarianceTable
</span><a href="#local-6989586621684429912"><span class="hs-identifier hs-var hs-var">vartab_cut_acc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Names -&gt; VarianceTable -&gt; Stms GPU -&gt; VarianceTable
</span><a href="#local-6989586621684429911"><span class="hs-identifier hs-var">varianceInStmsWithout</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#oneName"><span class="hs-identifier hs-var">oneName</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684429916"><span class="hs-identifier hs-var">pat_acc_nm</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VarianceTable
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684429914"><span class="hs-identifier hs-var">kstms</span></a></span><span>
</span><span id="line-359"></span><span>      </span><span id="local-6989586621684429910"><span class="annot"><span class="annottext">res_deps :: Names
</span><a href="#local-6989586621684429910"><span class="hs-identifier hs-var hs-var">res_deps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Names] -&gt; Names
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">([Names] -&gt; Names) -&gt; [Names] -&gt; Names
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Names) -&gt; [VName] -&gt; [Names]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarianceTable -&gt; VName -&gt; Names
forall {k} {a}. (Ord k, Monoid a) =&gt; Map k a -&gt; k -&gt; a
</span><a href="#local-6989586621684429909"><span class="hs-identifier hs-var">findDeps</span></a></span><span> </span><span class="annot"><span class="annottext">VarianceTable
</span><a href="#local-6989586621684429912"><span class="hs-identifier hs-var">vartab_cut_acc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; [Names]) -&gt; [VName] -&gt; [Names]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; Maybe VName) -&gt; [SubExp] -&gt; [VName]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">mapMaybe</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Maybe VName
</span><a href="#local-6989586621684429907"><span class="hs-identifier hs-var">se2nm</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684429915"><span class="hs-identifier hs-var">r_ses</span></a></span><span>
</span><span id="line-360"></span><span>      </span><span id="local-6989586621684429906"><span class="annot"><span class="annottext">common_deps :: Names
</span><a href="#local-6989586621684429906"><span class="hs-identifier hs-var hs-var">common_deps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#namesIntersection"><span class="hs-identifier hs-var">namesIntersection</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684429910"><span class="hs-identifier hs-var">res_deps</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684429913"><span class="hs-identifier hs-var">acc_deps</span></a></span><span>
</span><span id="line-361"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="hs-comment">--trace (&quot;Common deps: &quot;++pretty common_deps) $</span><span>
</span><span id="line-362"></span><span>      </span><span class="annot"><span class="annottext">(Cost -&gt; Stm GPU -&gt; Cost) -&gt; Cost -&gt; Stms GPU -&gt; Cost
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Names -&gt; Cost -&gt; Stm GPU -&gt; Cost
</span><a href="#local-6989586621684429904"><span class="hs-identifier hs-var">addCostOfStmt</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684429906"><span class="hs-identifier hs-var">common_deps</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Cost
</span><a href="Futhark.Optimise.GenRedOpt.html#Small"><span class="hs-identifier hs-var">Small</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684429914"><span class="hs-identifier hs-var">kstms</span></a></span><span>
</span><span id="line-363"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-364"></span><span>    </span><span id="local-6989586621684429907"><span class="annot"><span class="annottext">se2nm :: SubExp -&gt; Maybe VName
</span><a href="#local-6989586621684429907"><span class="hs-identifier hs-var hs-var">se2nm</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684429903"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684429903"><span class="hs-identifier hs-var">nm</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Maybe VName
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684429903"><span class="hs-identifier hs-var">nm</span></a></span><span>
</span><span id="line-365"></span><span>    </span><span class="annot"><a href="#local-6989586621684429907"><span class="hs-identifier hs-var">se2nm</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe VName
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-366"></span><span>    </span><span id="local-6989586621684429909"><span class="annot"><span class="annottext">findDeps :: Map k a -&gt; k -&gt; a
</span><a href="#local-6989586621684429909"><span class="hs-identifier hs-var hs-var">findDeps</span></a></span></span><span> </span><span id="local-6989586621684429898"><span class="annot"><span class="annottext">Map k a
</span><a href="#local-6989586621684429898"><span class="hs-identifier hs-var">vartab</span></a></span></span><span> </span><span id="local-6989586621684429897"><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621684429897"><span class="hs-identifier hs-var">nm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; k -&gt; Map k a -&gt; a
forall k a. Ord k =&gt; a -&gt; k -&gt; Map k a -&gt; a
</span><span class="hs-identifier hs-var">M.findWithDefault</span></span><span> </span><span class="annot"><span class="annottext">a
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621684429897"><span class="hs-identifier hs-var">nm</span></a></span><span> </span><span class="annot"><span class="annottext">Map k a
</span><a href="#local-6989586621684429898"><span class="hs-identifier hs-var">vartab</span></a></span><span>
</span><span id="line-367"></span><span>    </span><span id="local-6989586621684429904"><span class="annot"><span class="annottext">addCostOfStmt :: Names -&gt; Cost -&gt; Stm GPU -&gt; Cost
</span><a href="#local-6989586621684429904"><span class="hs-identifier hs-var hs-var">addCostOfStmt</span></a></span></span><span> </span><span id="local-6989586621684429896"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684429896"><span class="hs-identifier hs-var">common_deps</span></a></span></span><span> </span><span id="local-6989586621684429895"><span class="annot"><span class="annottext">Cost
</span><a href="#local-6989586621684429895"><span class="hs-identifier hs-var">cur_cost</span></a></span></span><span> </span><span id="local-6989586621684429894"><span class="annot"><span class="annottext">Stm GPU
</span><a href="#local-6989586621684429894"><span class="hs-identifier hs-var">stm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-368"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684429893"><span class="annot"><span class="annottext">pat_nms :: [VName]
</span><a href="#local-6989586621684429893"><span class="hs-identifier hs-var hs-var">pat_nms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatT Type -&gt; [VName]
forall dec. PatT dec -&gt; [VName]
</span><a href="Futhark.IR.Prop.Patterns.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="annot"><span class="annottext">(PatT Type -&gt; [VName]) -&gt; PatT Type -&gt; [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stm GPU -&gt; Pat GPU
forall rep. Stm rep -&gt; Pat rep
</span><a href="Futhark.IR.Syntax.html#stmPat"><span class="hs-identifier hs-var hs-var">stmPat</span></a></span><span> </span><span class="annot"><span class="annottext">Stm GPU
</span><a href="#local-6989586621684429894"><span class="hs-identifier hs-var">stm</span></a></span><span>
</span><span id="line-369"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#namesIntersect"><span class="hs-identifier hs-var">namesIntersect</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#namesFromList"><span class="hs-identifier hs-var">namesFromList</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684429893"><span class="hs-identifier hs-var">pat_nms</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684429896"><span class="hs-identifier hs-var">common_deps</span></a></span><span>
</span><span id="line-370"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Cost -&gt; Cost -&gt; Cost
</span><a href="Futhark.Optimise.GenRedOpt.html#addCosts"><span class="hs-identifier hs-var">addCosts</span></a></span><span> </span><span class="annot"><span class="annottext">Cost
</span><a href="#local-6989586621684429895"><span class="hs-identifier hs-var">cur_cost</span></a></span><span> </span><span class="annot"><span class="annottext">(Cost -&gt; Cost) -&gt; Cost -&gt; Cost
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stm GPU -&gt; Cost
</span><a href="Futhark.Optimise.GenRedOpt.html#costRedundantStmt"><span class="hs-identifier hs-var">costRedundantStmt</span></a></span><span> </span><span class="annot"><span class="annottext">Stm GPU
</span><a href="#local-6989586621684429894"><span class="hs-identifier hs-var">stm</span></a></span><span>
</span><span id="line-371"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Cost
</span><a href="#local-6989586621684429895"><span class="hs-identifier hs-var">cur_cost</span></a></span><span>
</span><span id="line-372"></span><span>    </span><span class="annot"><a href="#local-6989586621684429911"><span class="hs-identifier hs-type">varianceInStmsWithout</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.TileLoops.Shared.html#VarianceTable"><span class="hs-identifier hs-type">VarianceTable</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.TileLoops.Shared.html#VarianceTable"><span class="hs-identifier hs-type">VarianceTable</span></a></span><span>
</span><span id="line-373"></span><span>    </span><span id="local-6989586621684429911"><span class="annot"><span class="annottext">varianceInStmsWithout :: Names -&gt; VarianceTable -&gt; Stms GPU -&gt; VarianceTable
</span><a href="#local-6989586621684429911"><span class="hs-identifier hs-var hs-var">varianceInStmsWithout</span></a></span></span><span> </span><span id="local-6989586621684429888"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684429888"><span class="hs-identifier hs-var">nms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VarianceTable -&gt; Stm GPU -&gt; VarianceTable)
-&gt; VarianceTable -&gt; Stms GPU -&gt; VarianceTable
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">L.foldl'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Names -&gt; VarianceTable -&gt; Stm GPU -&gt; VarianceTable
forall {rep}.
(FreeDec (ExpDec rep), FreeDec (BodyDec rep),
 FreeIn (FParamInfo rep), FreeIn (LParamInfo rep),
 FreeIn (LetDec rep), FreeIn (RetType rep), FreeIn (BranchType rep),
 FreeIn (Op rep)) =&gt;
Names -&gt; VarianceTable -&gt; Stm rep -&gt; VarianceTable
</span><a href="#local-6989586621684429886"><span class="hs-identifier hs-var">varianceInStmWithout</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684429888"><span class="hs-identifier hs-var">nms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-374"></span><span>    </span><span id="local-6989586621684429886"><span class="annot"><span class="annottext">varianceInStmWithout :: Names -&gt; VarianceTable -&gt; Stm rep -&gt; VarianceTable
</span><a href="#local-6989586621684429886"><span class="hs-identifier hs-var hs-var">varianceInStmWithout</span></a></span></span><span> </span><span id="local-6989586621684429833"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684429833"><span class="hs-identifier hs-var">cuts</span></a></span></span><span> </span><span id="local-6989586621684429832"><span class="annot"><span class="annottext">VarianceTable
</span><a href="#local-6989586621684429832"><span class="hs-identifier hs-var">vartab</span></a></span></span><span> </span><span id="local-6989586621684429831"><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684429831"><span class="hs-identifier hs-var">stm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-375"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684429830"><span class="annot"><span class="annottext">pat_nms :: [VName]
</span><a href="#local-6989586621684429830"><span class="hs-identifier hs-var hs-var">pat_nms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatT (LetDec rep) -&gt; [VName]
forall dec. PatT dec -&gt; [VName]
</span><a href="Futhark.IR.Prop.Patterns.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="annot"><span class="annottext">(PatT (LetDec rep) -&gt; [VName]) -&gt; PatT (LetDec rep) -&gt; [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; PatT (LetDec rep)
forall rep. Stm rep -&gt; Pat rep
</span><a href="Futhark.IR.Syntax.html#stmPat"><span class="hs-identifier hs-var hs-var">stmPat</span></a></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684429831"><span class="hs-identifier hs-var">stm</span></a></span><span>
</span><span id="line-376"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#namesIntersect"><span class="hs-identifier hs-var">namesIntersect</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#namesFromList"><span class="hs-identifier hs-var">namesFromList</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684429830"><span class="hs-identifier hs-var">pat_nms</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684429833"><span class="hs-identifier hs-var">cuts</span></a></span><span>
</span><span id="line-377"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">VarianceTable
</span><a href="#local-6989586621684429832"><span class="hs-identifier hs-var">vartab</span></a></span><span>
</span><span id="line-378"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">(VarianceTable -&gt; VName -&gt; VarianceTable)
-&gt; VarianceTable -&gt; [VName] -&gt; VarianceTable
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">L.foldl'</span></span><span> </span><span class="annot"><span class="annottext">VarianceTable -&gt; VName -&gt; VarianceTable
</span><a href="#local-6989586621684429829"><span class="hs-identifier hs-var">add</span></a></span><span> </span><span class="annot"><span class="annottext">VarianceTable
</span><a href="#local-6989586621684429832"><span class="hs-identifier hs-var">vartab</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684429830"><span class="hs-identifier hs-var">pat_nms</span></a></span><span>
</span><span id="line-379"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-380"></span><span>        </span><span id="local-6989586621684429829"><span class="annot"><span class="annottext">add :: VarianceTable -&gt; VName -&gt; VarianceTable
</span><a href="#local-6989586621684429829"><span class="hs-identifier hs-var hs-var">add</span></a></span></span><span> </span><span id="local-6989586621684429828"><span class="annot"><span class="annottext">VarianceTable
</span><a href="#local-6989586621684429828"><span class="hs-identifier hs-var">variance'</span></a></span></span><span> </span><span id="local-6989586621684429827"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684429827"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Names -&gt; VarianceTable -&gt; VarianceTable
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684429827"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684429826"><span class="hs-identifier hs-var">binding_variance</span></a></span><span> </span><span class="annot"><span class="annottext">VarianceTable
</span><a href="#local-6989586621684429828"><span class="hs-identifier hs-var">variance'</span></a></span><span>
</span><span id="line-381"></span><span>        </span><span id="local-6989586621684429822"><span class="annot"><span class="annottext">look :: VarianceTable -&gt; VName -&gt; Names
</span><a href="#local-6989586621684429822"><span class="hs-identifier hs-var hs-var">look</span></a></span></span><span> </span><span id="local-6989586621684429821"><span class="annot"><span class="annottext">VarianceTable
</span><a href="#local-6989586621684429821"><span class="hs-identifier hs-var">variance'</span></a></span></span><span> </span><span id="local-6989586621684429820"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684429820"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#oneName"><span class="hs-identifier hs-var">oneName</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684429820"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Names -&gt; VName -&gt; VarianceTable -&gt; Names
forall k a. Ord k =&gt; a -&gt; k -&gt; Map k a -&gt; a
</span><span class="hs-identifier hs-var">M.findWithDefault</span></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684429820"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">VarianceTable
</span><a href="#local-6989586621684429821"><span class="hs-identifier hs-var">variance'</span></a></span><span>
</span><span id="line-382"></span><span>        </span><span id="local-6989586621684429826"><span class="annot"><span class="annottext">binding_variance :: Names
</span><a href="#local-6989586621684429826"><span class="hs-identifier hs-var hs-var">binding_variance</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Names] -&gt; Names
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">([Names] -&gt; Names) -&gt; [Names] -&gt; Names
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Names) -&gt; [VName] -&gt; [Names]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarianceTable -&gt; VName -&gt; Names
</span><a href="#local-6989586621684429822"><span class="hs-identifier hs-var">look</span></a></span><span> </span><span class="annot"><span class="annottext">VarianceTable
</span><a href="#local-6989586621684429832"><span class="hs-identifier hs-var">vartab</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; [Names]) -&gt; [VName] -&gt; [Names]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Names -&gt; [VName]
</span><a href="Futhark.IR.Prop.Names.html#namesToList"><span class="hs-identifier hs-var">namesToList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stm rep -&gt; Names
forall a. FreeIn a =&gt; a -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#freeIn"><span class="hs-identifier hs-var">freeIn</span></a></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684429831"><span class="hs-identifier hs-var">stm</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-383"></span><span>
</span><span id="line-384"></span><span class="hs-keyword">data</span><span> </span><span id="Cost"><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#Cost"><span class="hs-identifier hs-var">Cost</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Small"><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#Small"><span class="hs-identifier hs-var">Small</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="Big"><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#Big"><span class="hs-identifier hs-var">Big</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="Break"><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#Break"><span class="hs-identifier hs-var">Break</span></a></span></span><span>
</span><span id="line-385"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684429812"><span id="local-6989586621684429815"><span class="annot"><span class="annottext">Cost -&gt; Cost -&gt; Bool
(Cost -&gt; Cost -&gt; Bool) -&gt; (Cost -&gt; Cost -&gt; Bool) -&gt; Eq Cost
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: Cost -&gt; Cost -&gt; Bool
$c/= :: Cost -&gt; Cost -&gt; Bool
== :: Cost -&gt; Cost -&gt; Bool
$c== :: Cost -&gt; Cost -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-386"></span><span>
</span><span id="line-387"></span><span class="hs-comment">{--
printCost :: Cost -&gt; String
printCost Big   = &quot;BIG&quot;
printCost Break = &quot;BREAK&quot;
printCost (Small i) = &quot;(Small &quot;++show i++&quot;)&quot;
--}</span><span>
</span><span id="line-393"></span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#addCosts"><span class="hs-identifier hs-type">addCosts</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#Cost"><span class="hs-identifier hs-type">Cost</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#Cost"><span class="hs-identifier hs-type">Cost</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#Cost"><span class="hs-identifier hs-type">Cost</span></a></span><span>
</span><span id="line-394"></span><span id="addCosts"><span class="annot"><span class="annottext">addCosts :: Cost -&gt; Cost -&gt; Cost
</span><a href="Futhark.Optimise.GenRedOpt.html#addCosts"><span class="hs-identifier hs-var hs-var">addCosts</span></a></span></span><span> </span><span class="annot"><span class="annottext">Cost
</span><a href="Futhark.Optimise.GenRedOpt.html#Break"><span class="hs-identifier hs-var">Break</span></a></span><span> </span><span class="annot"><span class="annottext">Cost
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cost
</span><a href="Futhark.Optimise.GenRedOpt.html#Break"><span class="hs-identifier hs-var">Break</span></a></span><span>
</span><span id="line-395"></span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#addCosts"><span class="hs-identifier hs-var">addCosts</span></a></span><span> </span><span class="annot"><span class="annottext">Cost
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Cost
</span><a href="Futhark.Optimise.GenRedOpt.html#Break"><span class="hs-identifier hs-var">Break</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cost
</span><a href="Futhark.Optimise.GenRedOpt.html#Break"><span class="hs-identifier hs-var">Break</span></a></span><span>
</span><span id="line-396"></span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#addCosts"><span class="hs-identifier hs-var">addCosts</span></a></span><span> </span><span class="annot"><span class="annottext">Cost
</span><a href="Futhark.Optimise.GenRedOpt.html#Big"><span class="hs-identifier hs-var">Big</span></a></span><span> </span><span class="annot"><span class="annottext">Cost
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cost
</span><a href="Futhark.Optimise.GenRedOpt.html#Big"><span class="hs-identifier hs-var">Big</span></a></span><span>
</span><span id="line-397"></span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#addCosts"><span class="hs-identifier hs-var">addCosts</span></a></span><span> </span><span class="annot"><span class="annottext">Cost
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Cost
</span><a href="Futhark.Optimise.GenRedOpt.html#Big"><span class="hs-identifier hs-var">Big</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cost
</span><a href="Futhark.Optimise.GenRedOpt.html#Big"><span class="hs-identifier hs-var">Big</span></a></span><span>
</span><span id="line-398"></span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#addCosts"><span class="hs-identifier hs-var">addCosts</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#Small"><span class="hs-identifier hs-type">Small</span></a></span><span> </span><span id="local-6989586621684429810"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684429810"><span class="hs-identifier hs-var">c1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#Small"><span class="hs-identifier hs-type">Small</span></a></span><span> </span><span id="local-6989586621684429809"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684429809"><span class="hs-identifier hs-var">c2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Cost
</span><a href="Futhark.Optimise.GenRedOpt.html#Small"><span class="hs-identifier hs-var">Small</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684429810"><span class="hs-identifier hs-var">c1</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684429809"><span class="hs-identifier hs-var">c2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-399"></span><span>
</span><span id="line-400"></span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#maxCost"><span class="hs-identifier hs-type">maxCost</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#Cost"><span class="hs-identifier hs-type">Cost</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#Cost"><span class="hs-identifier hs-type">Cost</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#Cost"><span class="hs-identifier hs-type">Cost</span></a></span><span>
</span><span id="line-401"></span><span id="maxCost"><span class="annot"><span class="annottext">maxCost :: Cost -&gt; Cost -&gt; Cost
</span><a href="Futhark.Optimise.GenRedOpt.html#maxCost"><span class="hs-identifier hs-var hs-var">maxCost</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#Small"><span class="hs-identifier hs-type">Small</span></a></span><span> </span><span id="local-6989586621684429808"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684429808"><span class="hs-identifier hs-var">c1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#Small"><span class="hs-identifier hs-type">Small</span></a></span><span> </span><span id="local-6989586621684429807"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684429807"><span class="hs-identifier hs-var">c2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Cost
</span><a href="Futhark.Optimise.GenRedOpt.html#Small"><span class="hs-identifier hs-var">Small</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">max</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684429808"><span class="hs-identifier hs-var">c1</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684429807"><span class="hs-identifier hs-var">c2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-402"></span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#maxCost"><span class="hs-identifier hs-var">maxCost</span></a></span><span> </span><span id="local-6989586621684429805"><span class="annot"><span class="annottext">Cost
</span><a href="#local-6989586621684429805"><span class="hs-identifier hs-var">c1</span></a></span></span><span> </span><span id="local-6989586621684429804"><span class="annot"><span class="annottext">Cost
</span><a href="#local-6989586621684429804"><span class="hs-identifier hs-var">c2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cost -&gt; Cost -&gt; Cost
</span><a href="Futhark.Optimise.GenRedOpt.html#addCosts"><span class="hs-identifier hs-var">addCosts</span></a></span><span> </span><span class="annot"><span class="annottext">Cost
</span><a href="#local-6989586621684429805"><span class="hs-identifier hs-var">c1</span></a></span><span> </span><span class="annot"><span class="annottext">Cost
</span><a href="#local-6989586621684429804"><span class="hs-identifier hs-var">c2</span></a></span><span>
</span><span id="line-403"></span><span>
</span><span id="line-404"></span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#costBody"><span class="hs-identifier hs-type">costBody</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#Cost"><span class="hs-identifier hs-type">Cost</span></a></span><span>
</span><span id="line-405"></span><span id="costBody"><span class="annot"><span class="annottext">costBody :: Body GPU -&gt; Cost
</span><a href="Futhark.Optimise.GenRedOpt.html#costBody"><span class="hs-identifier hs-var hs-var">costBody</span></a></span></span><span> </span><span id="local-6989586621684429802"><span class="annot"><span class="annottext">Body GPU
</span><a href="#local-6989586621684429802"><span class="hs-identifier hs-var">bdy</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-406"></span><span>  </span><span class="annot"><span class="annottext">(Cost -&gt; Cost -&gt; Cost) -&gt; Cost -&gt; [Cost] -&gt; Cost
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl</span></span><span> </span><span class="annot"><span class="annottext">Cost -&gt; Cost -&gt; Cost
</span><a href="Futhark.Optimise.GenRedOpt.html#addCosts"><span class="hs-identifier hs-var">addCosts</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Cost
</span><a href="Futhark.Optimise.GenRedOpt.html#Small"><span class="hs-identifier hs-var">Small</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Cost] -&gt; Cost) -&gt; [Cost] -&gt; Cost
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-407"></span><span>    </span><span class="annot"><span class="annottext">(Stm GPU -&gt; Cost) -&gt; [Stm GPU] -&gt; [Cost]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Stm GPU -&gt; Cost
</span><a href="Futhark.Optimise.GenRedOpt.html#costRedundantStmt"><span class="hs-identifier hs-var">costRedundantStmt</span></a></span><span> </span><span class="annot"><span class="annottext">([Stm GPU] -&gt; [Cost]) -&gt; [Stm GPU] -&gt; [Cost]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stms GPU -&gt; [Stm GPU]
forall rep. Stms rep -&gt; [Stm rep]
</span><a href="Futhark.IR.Syntax.html#stmsToList"><span class="hs-identifier hs-var">stmsToList</span></a></span><span> </span><span class="annot"><span class="annottext">(Stms GPU -&gt; [Stm GPU]) -&gt; Stms GPU -&gt; [Stm GPU]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Body GPU -&gt; Stms GPU
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">Body GPU
</span><a href="#local-6989586621684429802"><span class="hs-identifier hs-var">bdy</span></a></span><span>
</span><span id="line-408"></span><span>
</span><span id="line-409"></span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#costRedundantStmt"><span class="hs-identifier hs-type">costRedundantStmt</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#Cost"><span class="hs-identifier hs-type">Cost</span></a></span><span>
</span><span id="line-410"></span><span id="costRedundantStmt"><span class="annot"><span class="annottext">costRedundantStmt :: Stm GPU -&gt; Cost
</span><a href="Futhark.Optimise.GenRedOpt.html#costRedundantStmt"><span class="hs-identifier hs-var hs-var">costRedundantStmt</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPU
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec GPU)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="annot"><span class="annottext">Op GPU
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cost
</span><a href="Futhark.Optimise.GenRedOpt.html#Big"><span class="hs-identifier hs-var">Big</span></a></span><span>
</span><span id="line-411"></span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#costRedundantStmt"><span class="hs-identifier hs-var">costRedundantStmt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPU
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec GPU)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#DoLoop"><span class="hs-identifier hs-type">DoLoop</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cost
</span><a href="Futhark.Optimise.GenRedOpt.html#Big"><span class="hs-identifier hs-var">Big</span></a></span><span>
</span><span id="line-412"></span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#costRedundantStmt"><span class="hs-identifier hs-var">costRedundantStmt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPU
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec GPU)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Apply"><span class="hs-identifier hs-type">Apply</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cost
</span><a href="Futhark.Optimise.GenRedOpt.html#Big"><span class="hs-identifier hs-var">Big</span></a></span><span>
</span><span id="line-413"></span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#costRedundantStmt"><span class="hs-identifier hs-var">costRedundantStmt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPU
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec GPU)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#WithAcc"><span class="hs-identifier hs-type">WithAcc</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cost
</span><a href="Futhark.Optimise.GenRedOpt.html#Big"><span class="hs-identifier hs-var">Big</span></a></span><span>
</span><span id="line-414"></span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#costRedundantStmt"><span class="hs-identifier hs-var">costRedundantStmt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPU
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec GPU)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#If"><span class="hs-identifier hs-type">If</span></a></span><span> </span><span id="local-6989586621684429796"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684429796"><span class="hs-identifier hs-var">_cond</span></a></span></span><span> </span><span id="local-6989586621684429795"><span class="annot"><span class="annottext">Body GPU
</span><a href="#local-6989586621684429795"><span class="hs-identifier hs-var">b_then</span></a></span></span><span> </span><span id="local-6989586621684429794"><span class="annot"><span class="annottext">Body GPU
</span><a href="#local-6989586621684429794"><span class="hs-identifier hs-var">b_else</span></a></span></span><span> </span><span class="annot"><span class="annottext">IfDec (BranchType GPU)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-415"></span><span>  </span><span class="annot"><span class="annottext">Cost -&gt; Cost -&gt; Cost
</span><a href="Futhark.Optimise.GenRedOpt.html#maxCost"><span class="hs-identifier hs-var">maxCost</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Body GPU -&gt; Cost
</span><a href="Futhark.Optimise.GenRedOpt.html#costBody"><span class="hs-identifier hs-var">costBody</span></a></span><span> </span><span class="annot"><span class="annottext">Body GPU
</span><a href="#local-6989586621684429795"><span class="hs-identifier hs-var">b_then</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Body GPU -&gt; Cost
</span><a href="Futhark.Optimise.GenRedOpt.html#costBody"><span class="hs-identifier hs-var">costBody</span></a></span><span> </span><span class="annot"><span class="annottext">Body GPU
</span><a href="#local-6989586621684429794"><span class="hs-identifier hs-var">b_else</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-416"></span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#costRedundantStmt"><span class="hs-identifier hs-var">costRedundantStmt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPU
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec GPU)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#ArrayLit"><span class="hs-identifier hs-type">ArrayLit</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cost
</span><a href="Futhark.Optimise.GenRedOpt.html#Big"><span class="hs-identifier hs-var">Big</span></a></span><span>
</span><span id="line-417"></span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#costRedundantStmt"><span class="hs-identifier hs-var">costRedundantStmt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPU
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec GPU)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#ArrayLit"><span class="hs-identifier hs-type">ArrayLit</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Cost
</span><a href="Futhark.Optimise.GenRedOpt.html#Small"><span class="hs-identifier hs-var">Small</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-418"></span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#costRedundantStmt"><span class="hs-identifier hs-var">costRedundantStmt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPU
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec GPU)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Index"><span class="hs-identifier hs-type">Index</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684429791"><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684429791"><span class="hs-identifier hs-var">slc</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-419"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">(DimIndex SubExp -&gt; Bool) -&gt; [DimIndex SubExp] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="annot"><span class="annottext">DimIndex SubExp -&gt; Bool
forall {d}. DimIndex d -&gt; Bool
</span><a href="#local-6989586621684429790"><span class="hs-identifier hs-var">isFixDim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Slice SubExp -&gt; [DimIndex SubExp]
forall d. Slice d -&gt; [DimIndex d]
</span><a href="Futhark.IR.Syntax.Core.html#unSlice"><span class="hs-identifier hs-var hs-var">unSlice</span></a></span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684429791"><span class="hs-identifier hs-var">slc</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Cost
</span><a href="Futhark.Optimise.GenRedOpt.html#Small"><span class="hs-identifier hs-var">Small</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Cost
</span><a href="Futhark.Optimise.GenRedOpt.html#Small"><span class="hs-identifier hs-var">Small</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-420"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-421"></span><span>    </span><span id="local-6989586621684429790"><span class="annot"><span class="annottext">isFixDim :: DimIndex d -&gt; Bool
</span><a href="#local-6989586621684429790"><span class="hs-identifier hs-var hs-var">isFixDim</span></a></span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-type">DimFix</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-422"></span><span>    </span><span class="annot"><a href="#local-6989586621684429790"><span class="hs-identifier hs-var">isFixDim</span></a></span><span> </span><span class="annot"><span class="annottext">DimIndex d
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-423"></span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#costRedundantStmt"><span class="hs-identifier hs-var">costRedundantStmt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPU
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec GPU)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#FlatIndex"><span class="hs-identifier hs-type">FlatIndex</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Cost
</span><a href="Futhark.Optimise.GenRedOpt.html#Small"><span class="hs-identifier hs-var">Small</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-424"></span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#costRedundantStmt"><span class="hs-identifier hs-var">costRedundantStmt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPU
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec GPU)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Update"><span class="hs-identifier hs-type">Update</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cost
</span><a href="Futhark.Optimise.GenRedOpt.html#Break"><span class="hs-identifier hs-var">Break</span></a></span><span>
</span><span id="line-425"></span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#costRedundantStmt"><span class="hs-identifier hs-var">costRedundantStmt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPU
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec GPU)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#FlatUpdate"><span class="hs-identifier hs-type">FlatUpdate</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cost
</span><a href="Futhark.Optimise.GenRedOpt.html#Break"><span class="hs-identifier hs-var">Break</span></a></span><span>
</span><span id="line-426"></span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#costRedundantStmt"><span class="hs-identifier hs-var">costRedundantStmt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPU
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec GPU)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Concat"><span class="hs-identifier hs-type">Concat</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cost
</span><a href="Futhark.Optimise.GenRedOpt.html#Big"><span class="hs-identifier hs-var">Big</span></a></span><span>
</span><span id="line-427"></span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#costRedundantStmt"><span class="hs-identifier hs-var">costRedundantStmt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPU
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec GPU)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Copy"><span class="hs-identifier hs-type">Copy</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cost
</span><a href="Futhark.Optimise.GenRedOpt.html#Big"><span class="hs-identifier hs-var">Big</span></a></span><span>
</span><span id="line-428"></span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#costRedundantStmt"><span class="hs-identifier hs-var">costRedundantStmt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPU
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec GPU)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Manifest"><span class="hs-identifier hs-type">Manifest</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cost
</span><a href="Futhark.Optimise.GenRedOpt.html#Big"><span class="hs-identifier hs-var">Big</span></a></span><span>
</span><span id="line-429"></span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#costRedundantStmt"><span class="hs-identifier hs-var">costRedundantStmt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPU
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec GPU)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Replicate"><span class="hs-identifier hs-type">Replicate</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cost
</span><a href="Futhark.Optimise.GenRedOpt.html#Big"><span class="hs-identifier hs-var">Big</span></a></span><span>
</span><span id="line-430"></span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#costRedundantStmt"><span class="hs-identifier hs-var">costRedundantStmt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPU
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec GPU)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#UpdateAcc"><span class="hs-identifier hs-type">UpdateAcc</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cost
</span><a href="Futhark.Optimise.GenRedOpt.html#Break"><span class="hs-identifier hs-var">Break</span></a></span><span>
</span><span id="line-431"></span><span class="annot"><a href="Futhark.Optimise.GenRedOpt.html#costRedundantStmt"><span class="hs-identifier hs-var">costRedundantStmt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPU
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec GPU)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">BasicOp
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Cost
</span><a href="Futhark.Optimise.GenRedOpt.html#Small"><span class="hs-identifier hs-var">Small</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-432"></span><span>
</span><span id="line-433"></span><span class="hs-comment">-------------------------</span><span>
</span><span id="line-434"></span><span class="hs-comment">--- Diffs</span><span>
</span><span id="line-435"></span><span class="hs-comment">-------------------------</span><span>
</span><span id="line-436"></span><span class="hs-comment">-- 1. In src/Language/Futhark/Prop.hs</span><span>
</span><span id="line-437"></span><span class="hs-comment">--   -                   $ tupleRecord [Scalar t_b, Scalar t_b]</span><span>
</span><span id="line-438"></span><span class="hs-comment">--   +                   $ RetType [] . Scalar $ tupleRecord [Scalar t_b, Scalar t_b]</span><span>
</span><span id="line-439"></span><span class="hs-comment">-- and another like that</span><span>
</span><span id="line-440"></span><span class="hs-comment">--</span><span>
</span><span id="line-441"></span><span class="hs-comment">-- 2. In src/Futhark/Passes.hs</span><span>
</span><span id="line-442"></span><span class="hs-comment">--              tileLoops,</span><span>
</span><span id="line-443"></span><span class="hs-comment">--     +        simplifyGPU,</span><span>
</span><span id="line-444"></span><span class="hs-comment">--     +        --tileLoops,</span><span>
</span><span id="line-445"></span><span class="hs-comment">-- 3. src/Futhark/IR/GPU/Simplify.hs</span><span>
</span><span id="line-446"></span><span class="hs-comment">--   kernelRules =</span><span>
</span><span id="line-447"></span><span class="hs-comment">--     standardRules &lt;&gt; segOpRules</span><span>
</span><span id="line-448"></span><span class="hs-comment">--       &lt;&gt; ruleBook</span><span>
</span><span id="line-449"></span><span class="hs-comment">--  -      [ RuleOp redomapIotaToLoop,</span><span>
</span><span id="line-450"></span><span class="hs-comment">--  +      [ --RuleOp redomapIotaToLoop,</span><span>
</span><span id="line-451"></span><span class="hs-comment">--           RuleOp SOAC.simplifyKnownIterationSOAC,</span><span>
</span><span id="line-452"></span></pre></body></html>