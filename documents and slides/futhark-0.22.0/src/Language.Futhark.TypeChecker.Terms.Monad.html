<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span id="local-6989586621684557546"><span id="local-6989586621684557547"></span></span><span class="hs-pragma">{-# LANGUAGE DeriveFunctor #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE FlexibleInstances #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE Trustworthy #-}</span><span>
</span><span id="line-7"></span><span>
</span><span id="line-8"></span><span class="hs-comment">-- | Facilities for type-checking terms.  Factored out of</span><span>
</span><span id="line-9"></span><span class="hs-comment">-- &quot;Language.Futhark.TypeChecker.Terms&quot; to prevent the module from</span><span>
</span><span id="line-10"></span><span class="hs-comment">-- being gigantic.</span><span>
</span><span id="line-11"></span><span class="hs-comment">--</span><span>
</span><span id="line-12"></span><span class="hs-comment">-- Incidentally also a nice place to put Haddock comments to make the</span><span>
</span><span id="line-13"></span><span class="hs-comment">-- internal API of the type checker easier to browse.</span><span>
</span><span id="line-14"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Language.Futhark.TypeChecker.Terms.Monad</span><span>
</span><span id="line-15"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier">TermTypeM</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-16"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#runTermTypeM"><span class="hs-identifier">runTermTypeM</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-17"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#liftTypeM"><span class="hs-identifier">liftTypeM</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-18"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#ValBinding"><span class="hs-identifier">ValBinding</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-19"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Locality"><span class="hs-identifier">Locality</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-20"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#SizeSource"><span class="hs-identifier">SizeSource</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-21"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#NameReason"><span class="hs-identifier">NameReason</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-22"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#InferredType"><span class="hs-identifier">InferredType</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-23"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Checking"><span class="hs-identifier">Checking</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-24"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#withEnv"><span class="hs-identifier">withEnv</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-25"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#localScope"><span class="hs-identifier">localScope</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-26"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermEnv"><span class="hs-identifier">TermEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-27"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermScope"><span class="hs-identifier">TermScope</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-28"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeState"><span class="hs-identifier">TermTypeState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-29"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#onFailure"><span class="hs-identifier">onFailure</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-30"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#extSize"><span class="hs-identifier">extSize</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-31"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#expType"><span class="hs-identifier">expType</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-32"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#expTypeFully"><span class="hs-identifier">expTypeFully</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-33"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#constrain"><span class="hs-identifier">constrain</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-34"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#newArrayType"><span class="hs-identifier">newArrayType</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-35"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#allDimsFreshInType"><span class="hs-identifier">allDimsFreshInType</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-36"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#updateTypes"><span class="hs-identifier">updateTypes</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-37"></span><span>
</span><span id="line-38"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Primitive checking</span></span><span>
</span><span id="line-39"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#unifies"><span class="hs-identifier">unifies</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-40"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#require"><span class="hs-identifier">require</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-41"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#checkTypeExpNonrigid"><span class="hs-identifier">checkTypeExpNonrigid</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-42"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#checkTypeExpRigid"><span class="hs-identifier">checkTypeExpRigid</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-43"></span><span>
</span><span id="line-44"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Sizes</span></span><span>
</span><span id="line-45"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#isInt64"><span class="hs-identifier">isInt64</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-46"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#maybeDimFromExp"><span class="hs-identifier">maybeDimFromExp</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-47"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#dimFromExp"><span class="hs-identifier">dimFromExp</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-48"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#dimFromArg"><span class="hs-identifier">dimFromArg</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-49"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#noSizeEscape"><span class="hs-identifier">noSizeEscape</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-50"></span><span>
</span><span id="line-51"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Control flow</span></span><span>
</span><span id="line-52"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#collectOccurrences"><span class="hs-identifier">collectOccurrences</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-53"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#tapOccurrences"><span class="hs-identifier">tapOccurrences</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-54"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#alternative"><span class="hs-identifier">alternative</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-55"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#sequentially"><span class="hs-identifier">sequentially</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-56"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#incLevel"><span class="hs-identifier">incLevel</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-57"></span><span>
</span><span id="line-58"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Consumption and uniqueness</span></span><span>
</span><span id="line-59"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Names"><span class="hs-identifier">Names</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-60"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Occurrence"><span class="hs-identifier">Occurrence</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-61"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Occurrences"><span class="hs-identifier">Occurrences</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-62"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#onlySelfAliasing"><span class="hs-identifier">onlySelfAliasing</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-63"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#noUnique"><span class="hs-identifier">noUnique</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-64"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#removeSeminullOccurrences"><span class="hs-identifier">removeSeminullOccurrences</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-65"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#occur"><span class="hs-identifier">occur</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-66"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#observe"><span class="hs-identifier">observe</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-67"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#consume"><span class="hs-identifier">consume</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-68"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#consuming"><span class="hs-identifier">consuming</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-69"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#observation"><span class="hs-identifier">observation</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-70"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#consumption"><span class="hs-identifier">consumption</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-71"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#checkIfConsumable"><span class="hs-identifier">checkIfConsumable</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-72"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#seqOccurrences"><span class="hs-identifier">seqOccurrences</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-73"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#checkOccurrences"><span class="hs-identifier">checkOccurrences</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-74"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#allConsumed"><span class="hs-identifier">allConsumed</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-75"></span><span>
</span><span id="line-76"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Errors</span></span><span>
</span><span id="line-77"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#useAfterConsume"><span class="hs-identifier">useAfterConsume</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-78"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#unusedSize"><span class="hs-identifier">unusedSize</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-79"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#notConsumable"><span class="hs-identifier">notConsumable</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-80"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#unexpectedType"><span class="hs-identifier">unexpectedType</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-81"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#uniqueReturnAliased"><span class="hs-identifier">uniqueReturnAliased</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-82"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#returnAliased"><span class="hs-identifier">returnAliased</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-83"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#badLetWithValue"><span class="hs-identifier">badLetWithValue</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-84"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#anyConsumption"><span class="hs-identifier">anyConsumption</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-85"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#allOccurring"><span class="hs-identifier">allOccurring</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-86"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-87"></span><span class="hs-keyword">where</span><span>
</span><span id="line-88"></span><span>
</span><span id="line-89"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Except</span></span><span>
</span><span id="line-90"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Reader</span></span><span>
</span><span id="line-91"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.State</span></span><span>
</span><span id="line-92"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Bifunctor</span></span><span>
</span><span id="line-93"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Bitraversable</span></span><span>
</span><span id="line-94"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Char</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">isAscii</span></span><span class="hs-special">)</span><span>
</span><span id="line-95"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">find</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">isPrefixOf</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">sort</span></span><span class="hs-special">)</span><span>
</span><span id="line-96"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map.Strict</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-97"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span>
</span><span id="line-98"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S</span></span><span>
</span><span id="line-99"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Util.Pretty.html"><span class="hs-identifier">Futhark.Util.Pretty</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">bool</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">group</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">space</span></span><span class="hs-special">)</span><span>
</span><span id="line-100"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Language.Futhark.html"><span class="hs-identifier">Language.Futhark</span></a></span><span>
</span><span id="line-101"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Language.Futhark.Semantic.html"><span class="hs-identifier">Language.Futhark.Semantic</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Semantic.html#includeToFilePath"><span class="hs-identifier">includeToFilePath</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-102"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Language.Futhark.Traversals.html"><span class="hs-identifier">Language.Futhark.Traversals</span></a></span><span>
</span><span id="line-103"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Monad.html"><span class="hs-identifier">Language.Futhark.TypeChecker.Monad</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Semantic.html#BoundV"><span class="hs-identifier">BoundV</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-104"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Monad.html"><span class="hs-identifier">Language.Futhark.TypeChecker.Monad</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TypeM</span></span><span>
</span><span id="line-105"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html"><span class="hs-identifier">Language.Futhark.TypeChecker.Types</span></a></span><span>
</span><span id="line-106"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Unify.html"><span class="hs-identifier">Language.Futhark.TypeChecker.Unify</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Unify.html#Usage"><span class="hs-identifier">Usage</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-107"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Prelude</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">mod</span></span><span class="hs-special">)</span><span>
</span><span id="line-108"></span><span>
</span><span id="line-109"></span><span class="hs-comment">--- Uniqueness</span><span>
</span><span id="line-110"></span><span>
</span><span id="line-111"></span><span class="hs-keyword">data</span><span> </span><span id="Usage"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Usage"><span class="hs-identifier hs-var">Usage</span></a></span></span><span>
</span><span id="line-112"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="Consumed"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Consumed"><span class="hs-identifier hs-var">Consumed</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SrcLoc</span></span><span>
</span><span id="line-113"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="Observed"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Observed"><span class="hs-identifier hs-var">Observed</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SrcLoc</span></span><span>
</span><span id="line-114"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684557295"><span id="local-6989586621684557300"><span class="annot"><span class="annottext">Usage -&gt; Usage -&gt; Bool
(Usage -&gt; Usage -&gt; Bool) -&gt; (Usage -&gt; Usage -&gt; Bool) -&gt; Eq Usage
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: Usage -&gt; Usage -&gt; Bool
$c/= :: Usage -&gt; Usage -&gt; Bool
== :: Usage -&gt; Usage -&gt; Bool
$c== :: Usage -&gt; Usage -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684557271"><span id="local-6989586621684557273"><span id="local-6989586621684557276"><span id="local-6989586621684557279"><span id="local-6989586621684557282"><span id="local-6989586621684557286"><span id="local-6989586621684557290"><span class="annot"><span class="annottext">Eq Usage
Eq Usage
-&gt; (Usage -&gt; Usage -&gt; Ordering)
-&gt; (Usage -&gt; Usage -&gt; Bool)
-&gt; (Usage -&gt; Usage -&gt; Bool)
-&gt; (Usage -&gt; Usage -&gt; Bool)
-&gt; (Usage -&gt; Usage -&gt; Bool)
-&gt; (Usage -&gt; Usage -&gt; Usage)
-&gt; (Usage -&gt; Usage -&gt; Usage)
-&gt; Ord Usage
Usage -&gt; Usage -&gt; Bool
Usage -&gt; Usage -&gt; Ordering
Usage -&gt; Usage -&gt; Usage
forall a.
Eq a
-&gt; (a -&gt; a -&gt; Ordering)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; a)
-&gt; (a -&gt; a -&gt; a)
-&gt; Ord a
min :: Usage -&gt; Usage -&gt; Usage
$cmin :: Usage -&gt; Usage -&gt; Usage
max :: Usage -&gt; Usage -&gt; Usage
$cmax :: Usage -&gt; Usage -&gt; Usage
&gt;= :: Usage -&gt; Usage -&gt; Bool
$c&gt;= :: Usage -&gt; Usage -&gt; Bool
&gt; :: Usage -&gt; Usage -&gt; Bool
$c&gt; :: Usage -&gt; Usage -&gt; Bool
&lt;= :: Usage -&gt; Usage -&gt; Bool
$c&lt;= :: Usage -&gt; Usage -&gt; Bool
&lt; :: Usage -&gt; Usage -&gt; Bool
$c&lt; :: Usage -&gt; Usage -&gt; Bool
compare :: Usage -&gt; Usage -&gt; Ordering
$ccompare :: Usage -&gt; Usage -&gt; Ordering
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Ord</span></span></span></span></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684557258"><span id="local-6989586621684557260"><span id="local-6989586621684557268"><span class="annot"><span class="annottext">Int -&gt; Usage -&gt; ShowS
[Usage] -&gt; ShowS
Usage -&gt; [Char]
(Int -&gt; Usage -&gt; ShowS)
-&gt; (Usage -&gt; [Char]) -&gt; ([Usage] -&gt; ShowS) -&gt; Show Usage
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; [Char]) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [Usage] -&gt; ShowS
$cshowList :: [Usage] -&gt; ShowS
show :: Usage -&gt; [Char]
$cshow :: Usage -&gt; [Char]
showsPrec :: Int -&gt; Usage -&gt; ShowS
$cshowsPrec :: Int -&gt; Usage -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-115"></span><span>
</span><span id="line-116"></span><span class="hs-keyword">type</span><span> </span><span id="Names"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Names"><span class="hs-identifier hs-var">Names</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.Set</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span>
</span><span id="line-117"></span><span>
</span><span id="line-118"></span><span class="hs-comment">-- | The consumption set is a Maybe so we can distinguish whether a</span><span>
</span><span id="line-119"></span><span class="hs-comment">-- consumption took place, but the variable went out of scope since,</span><span>
</span><span id="line-120"></span><span class="hs-comment">-- or no consumption at all took place.</span><span>
</span><span id="line-121"></span><span class="hs-keyword">data</span><span> </span><span id="Occurrence"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Occurrence"><span class="hs-identifier hs-var">Occurrence</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Occurrence"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Occurrence"><span class="hs-identifier hs-var">Occurrence</span></a></span></span><span>
</span><span id="line-122"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="observed"><span class="annot"><span class="annottext">Occurrence -&gt; Names
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#observed"><span class="hs-identifier hs-var hs-var">observed</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-123"></span><span>    </span><span id="consumed"><span class="annot"><span class="annottext">Occurrence -&gt; Maybe Names
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#consumed"><span class="hs-identifier hs-var hs-var">consumed</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-124"></span><span>    </span><span id="location"><span class="annot"><span class="annottext">Occurrence -&gt; SrcLoc
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#location"><span class="hs-identifier hs-var hs-var">location</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SrcLoc</span></span><span>
</span><span id="line-125"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-126"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684557243"><span id="local-6989586621684557251"><span class="annot"><span class="annottext">Occurrence -&gt; Occurrence -&gt; Bool
(Occurrence -&gt; Occurrence -&gt; Bool)
-&gt; (Occurrence -&gt; Occurrence -&gt; Bool) -&gt; Eq Occurrence
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: Occurrence -&gt; Occurrence -&gt; Bool
$c/= :: Occurrence -&gt; Occurrence -&gt; Bool
== :: Occurrence -&gt; Occurrence -&gt; Bool
$c== :: Occurrence -&gt; Occurrence -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684557229"><span id="local-6989586621684557231"><span id="local-6989586621684557240"><span class="annot"><span class="annottext">Int -&gt; Occurrence -&gt; ShowS
Occurrences -&gt; ShowS
Occurrence -&gt; [Char]
(Int -&gt; Occurrence -&gt; ShowS)
-&gt; (Occurrence -&gt; [Char])
-&gt; (Occurrences -&gt; ShowS)
-&gt; Show Occurrence
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; [Char]) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: Occurrences -&gt; ShowS
$cshowList :: Occurrences -&gt; ShowS
show :: Occurrence -&gt; [Char]
$cshow :: Occurrence -&gt; [Char]
showsPrec :: Int -&gt; Occurrence -&gt; ShowS
$cshowsPrec :: Int -&gt; Occurrence -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-127"></span><span>
</span><span id="line-128"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621684557225"><span class="annot"><span class="hs-identifier hs-type">Located</span></span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Occurrence"><span class="hs-identifier hs-type">Occurrence</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-129"></span><span>  </span><span id="local-6989586621684557222"><span class="annot"><span class="annottext">locOf :: Occurrence -&gt; Loc
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">locOf</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SrcLoc -&gt; Loc
forall a. Located a =&gt; a -&gt; Loc
</span><span class="hs-identifier hs-var">locOf</span></span><span> </span><span class="annot"><span class="annottext">(SrcLoc -&gt; Loc) -&gt; (Occurrence -&gt; SrcLoc) -&gt; Occurrence -&gt; Loc
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Occurrence -&gt; SrcLoc
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#location"><span class="hs-identifier hs-var hs-var">location</span></a></span><span>
</span><span id="line-130"></span><span>
</span><span id="line-131"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#observation"><span class="hs-identifier hs-type">observation</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#Aliasing"><span class="hs-identifier hs-type">Aliasing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SrcLoc</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Occurrence"><span class="hs-identifier hs-type">Occurrence</span></a></span><span>
</span><span id="line-132"></span><span id="observation"><span class="annot"><span class="annottext">observation :: Aliasing -&gt; SrcLoc -&gt; Occurrence
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#observation"><span class="hs-identifier hs-var hs-var">observation</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Names -&gt; Maybe Names -&gt; SrcLoc -&gt; Occurrence)
-&gt; Maybe Names -&gt; Names -&gt; SrcLoc -&gt; Occurrence
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Maybe Names -&gt; SrcLoc -&gt; Occurrence
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Occurrence"><span class="hs-identifier hs-var">Occurrence</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Names
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">(Names -&gt; SrcLoc -&gt; Occurrence)
-&gt; (Aliasing -&gt; Names) -&gt; Aliasing -&gt; SrcLoc -&gt; Occurrence
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Alias -&gt; VName) -&gt; Aliasing -&gt; Names
forall b a. Ord b =&gt; (a -&gt; b) -&gt; Set a -&gt; Set b
</span><span class="hs-identifier hs-var">S.map</span></span><span> </span><span class="annot"><span class="annottext">Alias -&gt; VName
</span><a href="Language.Futhark.Syntax.html#aliasVar"><span class="hs-identifier hs-var hs-var">aliasVar</span></a></span><span>
</span><span id="line-133"></span><span>
</span><span id="line-134"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#consumption"><span class="hs-identifier hs-type">consumption</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#Aliasing"><span class="hs-identifier hs-type">Aliasing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SrcLoc</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Occurrence"><span class="hs-identifier hs-type">Occurrence</span></a></span><span>
</span><span id="line-135"></span><span id="consumption"><span class="annot"><span class="annottext">consumption :: Aliasing -&gt; SrcLoc -&gt; Occurrence
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#consumption"><span class="hs-identifier hs-var hs-var">consumption</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Names -&gt; Maybe Names -&gt; SrcLoc -&gt; Occurrence
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Occurrence"><span class="hs-identifier hs-var">Occurrence</span></a></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Set a
</span><span class="hs-identifier hs-var">S.empty</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Names -&gt; SrcLoc -&gt; Occurrence)
-&gt; (Aliasing -&gt; Maybe Names) -&gt; Aliasing -&gt; SrcLoc -&gt; Occurrence
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Maybe Names
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Names -&gt; Maybe Names)
-&gt; (Aliasing -&gt; Names) -&gt; Aliasing -&gt; Maybe Names
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Alias -&gt; VName) -&gt; Aliasing -&gt; Names
forall b a. Ord b =&gt; (a -&gt; b) -&gt; Set a -&gt; Set b
</span><span class="hs-identifier hs-var">S.map</span></span><span> </span><span class="annot"><span class="annottext">Alias -&gt; VName
</span><a href="Language.Futhark.Syntax.html#aliasVar"><span class="hs-identifier hs-var hs-var">aliasVar</span></a></span><span>
</span><span id="line-136"></span><span>
</span><span id="line-137"></span><span class="hs-comment">-- | A null occurence is one that we can remove without affecting</span><span>
</span><span id="line-138"></span><span class="hs-comment">-- anything.</span><span>
</span><span id="line-139"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#nullOccurrence"><span class="hs-identifier hs-type">nullOccurrence</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Occurrence"><span class="hs-identifier hs-type">Occurrence</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-140"></span><span id="nullOccurrence"><span class="annot"><span class="annottext">nullOccurrence :: Occurrence -&gt; Bool
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#nullOccurrence"><span class="hs-identifier hs-var hs-var">nullOccurrence</span></a></span></span><span> </span><span id="local-6989586621684557214"><span class="annot"><span class="annottext">Occurrence
</span><a href="#local-6989586621684557214"><span class="hs-identifier hs-var">occ</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Names -&gt; Bool
forall a. Set a -&gt; Bool
</span><span class="hs-identifier hs-var">S.null</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Occurrence -&gt; Names
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#observed"><span class="hs-identifier hs-var hs-var">observed</span></a></span><span> </span><span class="annot"><span class="annottext">Occurrence
</span><a href="#local-6989586621684557214"><span class="hs-identifier hs-var">occ</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Maybe Names -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isNothing</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Occurrence -&gt; Maybe Names
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#consumed"><span class="hs-identifier hs-var hs-var">consumed</span></a></span><span> </span><span class="annot"><span class="annottext">Occurrence
</span><a href="#local-6989586621684557214"><span class="hs-identifier hs-var">occ</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-141"></span><span>
</span><span id="line-142"></span><span class="hs-comment">-- | A seminull occurence is one that does not contain references to</span><span>
</span><span id="line-143"></span><span class="hs-comment">-- any variables in scope.  The big difference is that a seminull</span><span>
</span><span id="line-144"></span><span class="hs-comment">-- occurence may denote a consumption, as long as the array that was</span><span>
</span><span id="line-145"></span><span class="hs-comment">-- consumed is now out of scope.</span><span>
</span><span id="line-146"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#seminullOccurrence"><span class="hs-identifier hs-type">seminullOccurrence</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Occurrence"><span class="hs-identifier hs-type">Occurrence</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-147"></span><span id="seminullOccurrence"><span class="annot"><span class="annottext">seminullOccurrence :: Occurrence -&gt; Bool
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#seminullOccurrence"><span class="hs-identifier hs-var hs-var">seminullOccurrence</span></a></span></span><span> </span><span id="local-6989586621684557209"><span class="annot"><span class="annottext">Occurrence
</span><a href="#local-6989586621684557209"><span class="hs-identifier hs-var">occ</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Names -&gt; Bool
forall a. Set a -&gt; Bool
</span><span class="hs-identifier hs-var">S.null</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Occurrence -&gt; Names
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#observed"><span class="hs-identifier hs-var hs-var">observed</span></a></span><span> </span><span class="annot"><span class="annottext">Occurrence
</span><a href="#local-6989586621684557209"><span class="hs-identifier hs-var">occ</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; (Names -&gt; Bool) -&gt; Maybe Names -&gt; Bool
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Bool
forall a. Set a -&gt; Bool
</span><span class="hs-identifier hs-var">S.null</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Occurrence -&gt; Maybe Names
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#consumed"><span class="hs-identifier hs-var hs-var">consumed</span></a></span><span> </span><span class="annot"><span class="annottext">Occurrence
</span><a href="#local-6989586621684557209"><span class="hs-identifier hs-var">occ</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-148"></span><span>
</span><span id="line-149"></span><span class="hs-keyword">type</span><span> </span><span id="Occurrences"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Occurrences"><span class="hs-identifier hs-var">Occurrences</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Occurrence"><span class="hs-identifier hs-type">Occurrence</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-150"></span><span>
</span><span id="line-151"></span><span class="hs-keyword">type</span><span> </span><span id="UsageMap"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#UsageMap"><span class="hs-identifier hs-var">UsageMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Usage"><span class="hs-identifier hs-type">Usage</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-152"></span><span>
</span><span id="line-153"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#usageMap"><span class="hs-identifier hs-type">usageMap</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Occurrences"><span class="hs-identifier hs-type">Occurrences</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#UsageMap"><span class="hs-identifier hs-type">UsageMap</span></a></span><span>
</span><span id="line-154"></span><span id="usageMap"><span class="annot"><span class="annottext">usageMap :: Occurrences -&gt; UsageMap
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#usageMap"><span class="hs-identifier hs-var hs-var">usageMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(UsageMap -&gt; Occurrence -&gt; UsageMap)
-&gt; UsageMap -&gt; Occurrences -&gt; UsageMap
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl</span></span><span> </span><span class="annot"><span class="annottext">UsageMap -&gt; Occurrence -&gt; UsageMap
</span><a href="#local-6989586621684557205"><span class="hs-identifier hs-var">comb</span></a></span><span> </span><span class="annot"><span class="annottext">UsageMap
forall k a. Map k a
</span><span class="hs-identifier hs-var">M.empty</span></span><span>
</span><span id="line-155"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-156"></span><span>    </span><span id="local-6989586621684557205"><span class="annot"><span class="annottext">comb :: UsageMap -&gt; Occurrence -&gt; UsageMap
</span><a href="#local-6989586621684557205"><span class="hs-identifier hs-var hs-var">comb</span></a></span></span><span> </span><span id="local-6989586621684557201"><span class="annot"><span class="annottext">UsageMap
</span><a href="#local-6989586621684557201"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Occurrence"><span class="hs-identifier hs-type">Occurrence</span></a></span><span> </span><span id="local-6989586621684557200"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684557200"><span class="hs-identifier hs-var">obs</span></a></span></span><span> </span><span id="local-6989586621684557199"><span class="annot"><span class="annottext">Maybe Names
</span><a href="#local-6989586621684557199"><span class="hs-identifier hs-var">cons</span></a></span></span><span> </span><span id="local-6989586621684557198"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684557198"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-157"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684557196"><span class="annot"><span class="annottext">m' :: UsageMap
</span><a href="#local-6989586621684557196"><span class="hs-identifier hs-var hs-var">m'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(UsageMap -&gt; VName -&gt; UsageMap) -&gt; UsageMap -&gt; Names -&gt; UsageMap
forall a b. (a -&gt; b -&gt; a) -&gt; a -&gt; Set b -&gt; a
</span><span class="hs-identifier hs-var">S.foldl'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Usage -&gt; UsageMap -&gt; VName -&gt; UsageMap
forall {k} {a}. Ord k =&gt; a -&gt; Map k [a] -&gt; k -&gt; Map k [a]
</span><a href="#local-6989586621684557194"><span class="hs-identifier hs-var">ins</span></a></span><span> </span><span class="annot"><span class="annottext">(Usage -&gt; UsageMap -&gt; VName -&gt; UsageMap)
-&gt; Usage -&gt; UsageMap -&gt; VName -&gt; UsageMap
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc -&gt; Usage
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Observed"><span class="hs-identifier hs-var">Observed</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684557198"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">UsageMap
</span><a href="#local-6989586621684557201"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684557200"><span class="hs-identifier hs-var">obs</span></a></span><span>
</span><span id="line-158"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">(UsageMap -&gt; VName -&gt; UsageMap) -&gt; UsageMap -&gt; Names -&gt; UsageMap
forall a b. (a -&gt; b -&gt; a) -&gt; a -&gt; Set b -&gt; a
</span><span class="hs-identifier hs-var">S.foldl'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Usage -&gt; UsageMap -&gt; VName -&gt; UsageMap
forall {k} {a}. Ord k =&gt; a -&gt; Map k [a] -&gt; k -&gt; Map k [a]
</span><a href="#local-6989586621684557194"><span class="hs-identifier hs-var">ins</span></a></span><span> </span><span class="annot"><span class="annottext">(Usage -&gt; UsageMap -&gt; VName -&gt; UsageMap)
-&gt; Usage -&gt; UsageMap -&gt; VName -&gt; UsageMap
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc -&gt; Usage
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Consumed"><span class="hs-identifier hs-var">Consumed</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684557198"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">UsageMap
</span><a href="#local-6989586621684557196"><span class="hs-identifier hs-var">m'</span></a></span><span> </span><span class="annot"><span class="annottext">(Names -&gt; UsageMap) -&gt; Names -&gt; UsageMap
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Maybe Names -&gt; Names
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">Maybe Names
</span><a href="#local-6989586621684557199"><span class="hs-identifier hs-var">cons</span></a></span><span>
</span><span id="line-159"></span><span>    </span><span id="local-6989586621684557194"><span class="annot"><span class="annottext">ins :: a -&gt; Map k [a] -&gt; k -&gt; Map k [a]
</span><a href="#local-6989586621684557194"><span class="hs-identifier hs-var hs-var">ins</span></a></span></span><span> </span><span id="local-6989586621684557190"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684557190"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621684557189"><span class="annot"><span class="annottext">Map k [a]
</span><a href="#local-6989586621684557189"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span id="local-6989586621684557188"><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621684557188"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([a] -&gt; [a] -&gt; [a]) -&gt; k -&gt; [a] -&gt; Map k [a] -&gt; Map k [a]
forall k a. Ord k =&gt; (a -&gt; a -&gt; a) -&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insertWith</span></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [a] -&gt; [a]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">(++)</span></span><span> </span><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621684557188"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684557190"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Map k [a]
</span><a href="#local-6989586621684557189"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-160"></span><span>
</span><span id="line-161"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#combineOccurrences"><span class="hs-identifier hs-type">combineOccurrences</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Usage"><span class="hs-identifier hs-type">Usage</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Usage"><span class="hs-identifier hs-type">Usage</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Usage"><span class="hs-identifier hs-type">Usage</span></a></span><span>
</span><span id="line-162"></span><span id="combineOccurrences"><span class="annot"><span class="annottext">combineOccurrences :: VName -&gt; Usage -&gt; Usage -&gt; TermTypeM Usage
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#combineOccurrences"><span class="hs-identifier hs-var hs-var">combineOccurrences</span></a></span></span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Observed"><span class="hs-identifier hs-type">Observed</span></a></span><span> </span><span id="local-6989586621684557185"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684557185"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Observed"><span class="hs-identifier hs-type">Observed</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Usage -&gt; TermTypeM Usage
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Usage -&gt; TermTypeM Usage) -&gt; Usage -&gt; TermTypeM Usage
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc -&gt; Usage
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Observed"><span class="hs-identifier hs-var">Observed</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684557185"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-163"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#combineOccurrences"><span class="hs-identifier hs-var">combineOccurrences</span></a></span><span> </span><span id="local-6989586621684557184"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684557184"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Consumed"><span class="hs-identifier hs-type">Consumed</span></a></span><span> </span><span id="local-6989586621684557183"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684557183"><span class="hs-identifier hs-var">wloc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Observed"><span class="hs-identifier hs-type">Observed</span></a></span><span> </span><span id="local-6989586621684557182"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684557182"><span class="hs-identifier hs-var">rloc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-164"></span><span>  </span><span class="annot"><span class="annottext">VName -&gt; SrcLoc -&gt; SrcLoc -&gt; TermTypeM Usage
forall a. VName -&gt; SrcLoc -&gt; SrcLoc -&gt; TermTypeM a
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#useAfterConsume"><span class="hs-identifier hs-var">useAfterConsume</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684557184"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684557182"><span class="hs-identifier hs-var">rloc</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684557183"><span class="hs-identifier hs-var">wloc</span></a></span><span>
</span><span id="line-165"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#combineOccurrences"><span class="hs-identifier hs-var">combineOccurrences</span></a></span><span> </span><span id="local-6989586621684557181"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684557181"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Observed"><span class="hs-identifier hs-type">Observed</span></a></span><span> </span><span id="local-6989586621684557180"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684557180"><span class="hs-identifier hs-var">rloc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Consumed"><span class="hs-identifier hs-type">Consumed</span></a></span><span> </span><span id="local-6989586621684557179"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684557179"><span class="hs-identifier hs-var">wloc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-166"></span><span>  </span><span class="annot"><span class="annottext">VName -&gt; SrcLoc -&gt; SrcLoc -&gt; TermTypeM Usage
forall a. VName -&gt; SrcLoc -&gt; SrcLoc -&gt; TermTypeM a
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#useAfterConsume"><span class="hs-identifier hs-var">useAfterConsume</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684557181"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684557180"><span class="hs-identifier hs-var">rloc</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684557179"><span class="hs-identifier hs-var">wloc</span></a></span><span>
</span><span id="line-167"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#combineOccurrences"><span class="hs-identifier hs-var">combineOccurrences</span></a></span><span> </span><span id="local-6989586621684557178"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684557178"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Consumed"><span class="hs-identifier hs-type">Consumed</span></a></span><span> </span><span id="local-6989586621684557177"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684557177"><span class="hs-identifier hs-var">loc1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Consumed"><span class="hs-identifier hs-type">Consumed</span></a></span><span> </span><span id="local-6989586621684557176"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684557176"><span class="hs-identifier hs-var">loc2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-168"></span><span>  </span><span class="annot"><span class="annottext">VName -&gt; SrcLoc -&gt; SrcLoc -&gt; TermTypeM Usage
forall a. VName -&gt; SrcLoc -&gt; SrcLoc -&gt; TermTypeM a
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#useAfterConsume"><span class="hs-identifier hs-var">useAfterConsume</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684557178"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SrcLoc -&gt; SrcLoc -&gt; SrcLoc
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">max</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684557177"><span class="hs-identifier hs-var">loc1</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684557176"><span class="hs-identifier hs-var">loc2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SrcLoc -&gt; SrcLoc -&gt; SrcLoc
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">min</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684557177"><span class="hs-identifier hs-var">loc1</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684557176"><span class="hs-identifier hs-var">loc2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-169"></span><span>
</span><span id="line-170"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#checkOccurrences"><span class="hs-identifier hs-type">checkOccurrences</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Occurrences"><span class="hs-identifier hs-type">Occurrences</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-171"></span><span id="checkOccurrences"><span class="annot"><span class="annottext">checkOccurrences :: Occurrences -&gt; TermTypeM ()
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#checkOccurrences"><span class="hs-identifier hs-var hs-var">checkOccurrences</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TermTypeM (Map VName ()) -&gt; TermTypeM ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(TermTypeM (Map VName ()) -&gt; TermTypeM ())
-&gt; (Occurrences -&gt; TermTypeM (Map VName ()))
-&gt; Occurrences
-&gt; TermTypeM ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; [Usage] -&gt; TermTypeM ())
-&gt; UsageMap -&gt; TermTypeM (Map VName ())
forall (t :: * -&gt; *) k a b.
Applicative t =&gt;
(k -&gt; a -&gt; t b) -&gt; Map k a -&gt; t (Map k b)
</span><span class="hs-identifier hs-var">M.traverseWithKey</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [Usage] -&gt; TermTypeM ()
</span><a href="#local-6989586621684557171"><span class="hs-identifier hs-var">comb</span></a></span><span> </span><span class="annot"><span class="annottext">(UsageMap -&gt; TermTypeM (Map VName ()))
-&gt; (Occurrences -&gt; UsageMap)
-&gt; Occurrences
-&gt; TermTypeM (Map VName ())
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Occurrences -&gt; UsageMap
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#usageMap"><span class="hs-identifier hs-var">usageMap</span></a></span><span>
</span><span id="line-172"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-173"></span><span>    </span><span id="local-6989586621684557171"><span class="annot"><span class="annottext">comb :: VName -&gt; [Usage] -&gt; TermTypeM ()
</span><a href="#local-6989586621684557171"><span class="hs-identifier hs-var hs-var">comb</span></a></span></span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; TermTypeM ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-174"></span><span>    </span><span class="annot"><a href="#local-6989586621684557171"><span class="hs-identifier hs-var">comb</span></a></span><span> </span><span id="local-6989586621684557167"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684557167"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684557166"><span class="annot"><span class="annottext">Usage
</span><a href="#local-6989586621684557166"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684557165"><span class="annot"><span class="annottext">[Usage]
</span><a href="#local-6989586621684557165"><span class="hs-identifier hs-var">us</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Usage -&gt; Usage -&gt; TermTypeM Usage)
-&gt; Usage -&gt; [Usage] -&gt; TermTypeM ()
forall (t :: * -&gt; *) (m :: * -&gt; *) b a.
(Foldable t, Monad m) =&gt;
(b -&gt; a -&gt; m b) -&gt; b -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">foldM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Usage -&gt; Usage -&gt; TermTypeM Usage
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#combineOccurrences"><span class="hs-identifier hs-var">combineOccurrences</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684557167"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Usage
</span><a href="#local-6989586621684557166"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">[Usage]
</span><a href="#local-6989586621684557165"><span class="hs-identifier hs-var">us</span></a></span><span>
</span><span id="line-175"></span><span>
</span><span id="line-176"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#allObserved"><span class="hs-identifier hs-type">allObserved</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Occurrences"><span class="hs-identifier hs-type">Occurrences</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span>
</span><span id="line-177"></span><span id="allObserved"><span class="annot"><span class="annottext">allObserved :: Occurrences -&gt; Names
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#allObserved"><span class="hs-identifier hs-var hs-var">allObserved</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Names] -&gt; Names
forall (f :: * -&gt; *) a. (Foldable f, Ord a) =&gt; f (Set a) -&gt; Set a
</span><span class="hs-identifier hs-var">S.unions</span></span><span> </span><span class="annot"><span class="annottext">([Names] -&gt; Names)
-&gt; (Occurrences -&gt; [Names]) -&gt; Occurrences -&gt; Names
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Occurrence -&gt; Names) -&gt; Occurrences -&gt; [Names]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Occurrence -&gt; Names
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#observed"><span class="hs-identifier hs-var hs-var">observed</span></a></span><span>
</span><span id="line-178"></span><span>
</span><span id="line-179"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#allConsumed"><span class="hs-identifier hs-type">allConsumed</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Occurrences"><span class="hs-identifier hs-type">Occurrences</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span>
</span><span id="line-180"></span><span id="allConsumed"><span class="annot"><span class="annottext">allConsumed :: Occurrences -&gt; Names
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#allConsumed"><span class="hs-identifier hs-var hs-var">allConsumed</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Names] -&gt; Names
forall (f :: * -&gt; *) a. (Foldable f, Ord a) =&gt; f (Set a) -&gt; Set a
</span><span class="hs-identifier hs-var">S.unions</span></span><span> </span><span class="annot"><span class="annottext">([Names] -&gt; Names)
-&gt; (Occurrences -&gt; [Names]) -&gt; Occurrences -&gt; Names
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Occurrence -&gt; Names) -&gt; Occurrences -&gt; [Names]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Names -&gt; Maybe Names -&gt; Names
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Names -&gt; Names)
-&gt; (Occurrence -&gt; Maybe Names) -&gt; Occurrence -&gt; Names
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Occurrence -&gt; Maybe Names
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#consumed"><span class="hs-identifier hs-var hs-var">consumed</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-181"></span><span>
</span><span id="line-182"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#allOccurring"><span class="hs-identifier hs-type">allOccurring</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Occurrences"><span class="hs-identifier hs-type">Occurrences</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span>
</span><span id="line-183"></span><span id="allOccurring"><span class="annot"><span class="annottext">allOccurring :: Occurrences -&gt; Names
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#allOccurring"><span class="hs-identifier hs-var hs-var">allOccurring</span></a></span></span><span> </span><span id="local-6989586621684557161"><span class="annot"><span class="annottext">Occurrences
</span><a href="#local-6989586621684557161"><span class="hs-identifier hs-var">occs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Occurrences -&gt; Names
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#allConsumed"><span class="hs-identifier hs-var">allConsumed</span></a></span><span> </span><span class="annot"><span class="annottext">Occurrences
</span><a href="#local-6989586621684557161"><span class="hs-identifier hs-var">occs</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Occurrences -&gt; Names
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#allObserved"><span class="hs-identifier hs-var">allObserved</span></a></span><span> </span><span class="annot"><span class="annottext">Occurrences
</span><a href="#local-6989586621684557161"><span class="hs-identifier hs-var">occs</span></a></span><span>
</span><span id="line-184"></span><span>
</span><span id="line-185"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#anyConsumption"><span class="hs-identifier hs-type">anyConsumption</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Occurrences"><span class="hs-identifier hs-type">Occurrences</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Occurrence"><span class="hs-identifier hs-type">Occurrence</span></a></span><span>
</span><span id="line-186"></span><span id="anyConsumption"><span class="annot"><span class="annottext">anyConsumption :: Occurrences -&gt; Maybe Occurrence
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#anyConsumption"><span class="hs-identifier hs-var hs-var">anyConsumption</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Occurrence -&gt; Bool) -&gt; Occurrences -&gt; Maybe Occurrence
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Maybe a
</span><span class="hs-identifier hs-var">find</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe Names -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Names -&gt; Bool)
-&gt; (Occurrence -&gt; Maybe Names) -&gt; Occurrence -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Occurrence -&gt; Maybe Names
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#consumed"><span class="hs-identifier hs-var hs-var">consumed</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-187"></span><span>
</span><span id="line-188"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#seqOccurrences"><span class="hs-identifier hs-type">seqOccurrences</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Occurrences"><span class="hs-identifier hs-type">Occurrences</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Occurrences"><span class="hs-identifier hs-type">Occurrences</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Occurrences"><span class="hs-identifier hs-type">Occurrences</span></a></span><span>
</span><span id="line-189"></span><span id="seqOccurrences"><span class="annot"><span class="annottext">seqOccurrences :: Occurrences -&gt; Occurrences -&gt; Occurrences
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#seqOccurrences"><span class="hs-identifier hs-var hs-var">seqOccurrences</span></a></span></span><span> </span><span id="local-6989586621684557159"><span class="annot"><span class="annottext">Occurrences
</span><a href="#local-6989586621684557159"><span class="hs-identifier hs-var">occurs1</span></a></span></span><span> </span><span id="local-6989586621684557158"><span class="annot"><span class="annottext">Occurrences
</span><a href="#local-6989586621684557158"><span class="hs-identifier hs-var">occurs2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-190"></span><span>  </span><span class="annot"><span class="annottext">(Occurrence -&gt; Bool) -&gt; Occurrences -&gt; Occurrences
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; (Occurrence -&gt; Bool) -&gt; Occurrence -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Occurrence -&gt; Bool
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#nullOccurrence"><span class="hs-identifier hs-var">nullOccurrence</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Occurrences -&gt; Occurrences) -&gt; Occurrences -&gt; Occurrences
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Occurrence -&gt; Occurrence) -&gt; Occurrences -&gt; Occurrences
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Occurrence -&gt; Occurrence
</span><a href="#local-6989586621684557156"><span class="hs-identifier hs-var">filt</span></a></span><span> </span><span class="annot"><span class="annottext">Occurrences
</span><a href="#local-6989586621684557159"><span class="hs-identifier hs-var">occurs1</span></a></span><span> </span><span class="annot"><span class="annottext">Occurrences -&gt; Occurrences -&gt; Occurrences
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Occurrences
</span><a href="#local-6989586621684557158"><span class="hs-identifier hs-var">occurs2</span></a></span><span>
</span><span id="line-191"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-192"></span><span>    </span><span id="local-6989586621684557156"><span class="annot"><span class="annottext">filt :: Occurrence -&gt; Occurrence
</span><a href="#local-6989586621684557156"><span class="hs-identifier hs-var hs-var">filt</span></a></span></span><span> </span><span id="local-6989586621684557154"><span class="annot"><span class="annottext">Occurrence
</span><a href="#local-6989586621684557154"><span class="hs-identifier hs-var">occ</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-193"></span><span>      </span><span class="annot"><span class="annottext">Occurrence
</span><a href="#local-6989586621684557154"><span class="hs-identifier hs-var">occ</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">observed :: Names
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#observed"><span class="hs-identifier hs-var">observed</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Occurrence -&gt; Names
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#observed"><span class="hs-identifier hs-var hs-var">observed</span></a></span><span> </span><span class="annot"><span class="annottext">Occurrence
</span><a href="#local-6989586621684557154"><span class="hs-identifier hs-var">occ</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><span class="hs-operator hs-var">`S.difference`</span></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684557152"><span class="hs-identifier hs-var">postcons</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-194"></span><span>    </span><span id="local-6989586621684557152"><span class="annot"><span class="annottext">postcons :: Names
</span><a href="#local-6989586621684557152"><span class="hs-identifier hs-var hs-var">postcons</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Occurrences -&gt; Names
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#allConsumed"><span class="hs-identifier hs-var">allConsumed</span></a></span><span> </span><span class="annot"><span class="annottext">Occurrences
</span><a href="#local-6989586621684557158"><span class="hs-identifier hs-var">occurs2</span></a></span><span>
</span><span id="line-195"></span><span>
</span><span id="line-196"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#altOccurrences"><span class="hs-identifier hs-type">altOccurrences</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Occurrences"><span class="hs-identifier hs-type">Occurrences</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Occurrences"><span class="hs-identifier hs-type">Occurrences</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Occurrences"><span class="hs-identifier hs-type">Occurrences</span></a></span><span>
</span><span id="line-197"></span><span id="altOccurrences"><span class="annot"><span class="annottext">altOccurrences :: Occurrences -&gt; Occurrences -&gt; Occurrences
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#altOccurrences"><span class="hs-identifier hs-var hs-var">altOccurrences</span></a></span></span><span> </span><span id="local-6989586621684557150"><span class="annot"><span class="annottext">Occurrences
</span><a href="#local-6989586621684557150"><span class="hs-identifier hs-var">occurs1</span></a></span></span><span> </span><span id="local-6989586621684557149"><span class="annot"><span class="annottext">Occurrences
</span><a href="#local-6989586621684557149"><span class="hs-identifier hs-var">occurs2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-198"></span><span>  </span><span class="annot"><span class="annottext">(Occurrence -&gt; Bool) -&gt; Occurrences -&gt; Occurrences
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; (Occurrence -&gt; Bool) -&gt; Occurrence -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Occurrence -&gt; Bool
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#nullOccurrence"><span class="hs-identifier hs-var">nullOccurrence</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Occurrences -&gt; Occurrences) -&gt; Occurrences -&gt; Occurrences
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Occurrence -&gt; Occurrence) -&gt; Occurrences -&gt; Occurrences
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Occurrence -&gt; Occurrence
</span><a href="#local-6989586621684557148"><span class="hs-identifier hs-var">filt1</span></a></span><span> </span><span class="annot"><span class="annottext">Occurrences
</span><a href="#local-6989586621684557150"><span class="hs-identifier hs-var">occurs1</span></a></span><span> </span><span class="annot"><span class="annottext">Occurrences -&gt; Occurrences -&gt; Occurrences
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">(Occurrence -&gt; Occurrence) -&gt; Occurrences -&gt; Occurrences
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Occurrence -&gt; Occurrence
</span><a href="#local-6989586621684557147"><span class="hs-identifier hs-var">filt2</span></a></span><span> </span><span class="annot"><span class="annottext">Occurrences
</span><a href="#local-6989586621684557149"><span class="hs-identifier hs-var">occurs2</span></a></span><span>
</span><span id="line-199"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-200"></span><span>    </span><span id="local-6989586621684557148"><span class="annot"><span class="annottext">filt1 :: Occurrence -&gt; Occurrence
</span><a href="#local-6989586621684557148"><span class="hs-identifier hs-var hs-var">filt1</span></a></span></span><span> </span><span id="local-6989586621684557140"><span class="annot"><span class="annottext">Occurrence
</span><a href="#local-6989586621684557140"><span class="hs-identifier hs-var">occ</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-201"></span><span>      </span><span class="annot"><span class="annottext">Occurrence
</span><a href="#local-6989586621684557140"><span class="hs-identifier hs-var">occ</span></a></span><span>
</span><span id="line-202"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">consumed :: Maybe Names
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#consumed"><span class="hs-identifier hs-var">consumed</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><span class="hs-identifier hs-var">S.difference</span></span><span> </span><span class="annot"><span class="annottext">(Names -&gt; Names -&gt; Names) -&gt; Maybe Names -&gt; Maybe (Names -&gt; Names)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Occurrence -&gt; Maybe Names
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#consumed"><span class="hs-identifier hs-var hs-var">consumed</span></a></span><span> </span><span class="annot"><span class="annottext">Occurrence
</span><a href="#local-6989586621684557140"><span class="hs-identifier hs-var">occ</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Names -&gt; Names) -&gt; Maybe Names -&gt; Maybe Names
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Maybe Names
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684557138"><span class="hs-identifier hs-var">cons2</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-203"></span><span>          </span><span class="annot"><span class="annottext">observed :: Names
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#observed"><span class="hs-identifier hs-var">observed</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Occurrence -&gt; Names
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#observed"><span class="hs-identifier hs-var hs-var">observed</span></a></span><span> </span><span class="annot"><span class="annottext">Occurrence
</span><a href="#local-6989586621684557140"><span class="hs-identifier hs-var">occ</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><span class="hs-operator hs-var">`S.difference`</span></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684557138"><span class="hs-identifier hs-var">cons2</span></a></span><span>
</span><span id="line-204"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-205"></span><span>    </span><span id="local-6989586621684557147"><span class="annot"><span class="annottext">filt2 :: Occurrence -&gt; Occurrence
</span><a href="#local-6989586621684557147"><span class="hs-identifier hs-var hs-var">filt2</span></a></span></span><span> </span><span id="local-6989586621684557136"><span class="annot"><span class="annottext">Occurrence
</span><a href="#local-6989586621684557136"><span class="hs-identifier hs-var">occ</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-206"></span><span>      </span><span class="annot"><span class="annottext">Occurrence
</span><a href="#local-6989586621684557136"><span class="hs-identifier hs-var">occ</span></a></span><span>
</span><span id="line-207"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">consumed :: Maybe Names
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#consumed"><span class="hs-identifier hs-var">consumed</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Occurrence -&gt; Maybe Names
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#consumed"><span class="hs-identifier hs-var hs-var">consumed</span></a></span><span> </span><span class="annot"><span class="annottext">Occurrence
</span><a href="#local-6989586621684557136"><span class="hs-identifier hs-var">occ</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-208"></span><span>          </span><span class="annot"><span class="annottext">observed :: Names
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#observed"><span class="hs-identifier hs-var">observed</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Occurrence -&gt; Names
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#observed"><span class="hs-identifier hs-var hs-var">observed</span></a></span><span> </span><span class="annot"><span class="annottext">Occurrence
</span><a href="#local-6989586621684557136"><span class="hs-identifier hs-var">occ</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><span class="hs-operator hs-var">`S.difference`</span></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684557135"><span class="hs-identifier hs-var">cons1</span></a></span><span>
</span><span id="line-209"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-210"></span><span>    </span><span id="local-6989586621684557135"><span class="annot"><span class="annottext">cons1 :: Names
</span><a href="#local-6989586621684557135"><span class="hs-identifier hs-var hs-var">cons1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Occurrences -&gt; Names
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#allConsumed"><span class="hs-identifier hs-var">allConsumed</span></a></span><span> </span><span class="annot"><span class="annottext">Occurrences
</span><a href="#local-6989586621684557150"><span class="hs-identifier hs-var">occurs1</span></a></span><span>
</span><span id="line-211"></span><span>    </span><span id="local-6989586621684557138"><span class="annot"><span class="annottext">cons2 :: Names
</span><a href="#local-6989586621684557138"><span class="hs-identifier hs-var hs-var">cons2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Occurrences -&gt; Names
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#allConsumed"><span class="hs-identifier hs-var">allConsumed</span></a></span><span> </span><span class="annot"><span class="annottext">Occurrences
</span><a href="#local-6989586621684557149"><span class="hs-identifier hs-var">occurs2</span></a></span><span>
</span><span id="line-212"></span><span>
</span><span id="line-213"></span><span class="hs-comment">-- | Whether something is a global or a local variable.</span><span>
</span><span id="line-214"></span><span class="hs-keyword">data</span><span> </span><span id="Locality"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Locality"><span class="hs-identifier hs-var">Locality</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Local"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Local"><span class="hs-identifier hs-var">Local</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="Global"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Global"><span class="hs-identifier hs-var">Global</span></a></span></span><span>
</span><span id="line-215"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684557127"><span id="local-6989586621684557129"><span id="local-6989586621684557131"><span class="annot"><span class="annottext">Int -&gt; Locality -&gt; ShowS
[Locality] -&gt; ShowS
Locality -&gt; [Char]
(Int -&gt; Locality -&gt; ShowS)
-&gt; (Locality -&gt; [Char]) -&gt; ([Locality] -&gt; ShowS) -&gt; Show Locality
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; [Char]) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [Locality] -&gt; ShowS
$cshowList :: [Locality] -&gt; ShowS
show :: Locality -&gt; [Char]
$cshow :: Locality -&gt; [Char]
showsPrec :: Int -&gt; Locality -&gt; ShowS
$cshowsPrec :: Int -&gt; Locality -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-216"></span><span>
</span><span id="line-217"></span><span class="hs-keyword">data</span><span> </span><span id="ValBinding"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#ValBinding"><span class="hs-identifier hs-var">ValBinding</span></a></span></span><span>
</span><span id="line-218"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- | Aliases in parameters indicate the lexical</span><span>
</span><span id="line-219"></span><span>    </span><span class="hs-comment">-- closure.</span><span>
</span><span id="line-220"></span><span>    </span><span id="BoundV"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#BoundV"><span class="hs-identifier hs-var">BoundV</span></a></span></span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Locality"><span class="hs-identifier hs-type">Locality</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.html#TypeParam"><span class="hs-identifier hs-type">TypeParam</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#PatType"><span class="hs-identifier hs-type">PatType</span></a></span><span>
</span><span id="line-221"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="OverloadedF"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#OverloadedF"><span class="hs-identifier hs-var">OverloadedF</span></a></span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Syntax.html#PrimType"><span class="hs-identifier hs-type">PrimType</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#PrimType"><span class="hs-identifier hs-type">PrimType</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#PrimType"><span class="hs-identifier hs-type">PrimType</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-222"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="EqualityF"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#EqualityF"><span class="hs-identifier hs-var">EqualityF</span></a></span></span><span>
</span><span id="line-223"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="WasConsumed"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#WasConsumed"><span class="hs-identifier hs-var">WasConsumed</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SrcLoc</span></span><span>
</span><span id="line-224"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684557100"><span id="local-6989586621684557102"><span id="local-6989586621684557121"><span class="annot"><span class="annottext">Int -&gt; ValBinding -&gt; ShowS
[ValBinding] -&gt; ShowS
ValBinding -&gt; [Char]
(Int -&gt; ValBinding -&gt; ShowS)
-&gt; (ValBinding -&gt; [Char])
-&gt; ([ValBinding] -&gt; ShowS)
-&gt; Show ValBinding
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; [Char]) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [ValBinding] -&gt; ShowS
$cshowList :: [ValBinding] -&gt; ShowS
show :: ValBinding -&gt; [Char]
$cshow :: ValBinding -&gt; [Char]
showsPrec :: Int -&gt; ValBinding -&gt; ShowS
$cshowsPrec :: Int -&gt; ValBinding -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-225"></span><span>
</span><span id="line-226"></span><span class="hs-comment">--- Errors</span><span>
</span><span id="line-227"></span><span>
</span><span id="line-228"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#describeVar"><span class="hs-identifier hs-type">describeVar</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SrcLoc</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Doc</span></span><span>
</span><span id="line-229"></span><span id="describeVar"><span class="annot"><span class="annottext">describeVar :: SrcLoc -&gt; VName -&gt; TermTypeM Doc
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#describeVar"><span class="hs-identifier hs-var hs-var">describeVar</span></a></span></span><span> </span><span id="local-6989586621684557092"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684557092"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span id="local-6989586621684557091"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684557091"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-230"></span><span>  </span><span class="annot"><span class="annottext">(TermTypeState -&gt; Doc) -&gt; TermTypeM Doc
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">((TermTypeState -&gt; Doc) -&gt; TermTypeM Doc)
-&gt; (TermTypeState -&gt; Doc) -&gt; TermTypeM Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-231"></span><span>    </span><span class="annot"><span class="annottext">Doc -&gt; (NameReason -&gt; Doc) -&gt; Maybe NameReason -&gt; Doc
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;variable&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><a href="Language.Futhark.Core.html#pquote"><span class="hs-identifier hs-var">pquote</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Doc
forall v. IsName v =&gt; v -&gt; Doc
</span><a href="Language.Futhark.Pretty.html#pprName"><span class="hs-identifier hs-var">pprName</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684557091"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SrcLoc -&gt; NameReason -&gt; Doc
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#nameReason"><span class="hs-identifier hs-var">nameReason</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684557092"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-232"></span><span>      </span><span class="annot"><span class="annottext">(Maybe NameReason -&gt; Doc)
-&gt; (TermTypeState -&gt; Maybe NameReason) -&gt; TermTypeState -&gt; Doc
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Map VName NameReason -&gt; Maybe NameReason
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684557091"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-233"></span><span>      </span><span class="annot"><span class="annottext">(Map VName NameReason -&gt; Maybe NameReason)
-&gt; (TermTypeState -&gt; Map VName NameReason)
-&gt; TermTypeState
-&gt; Maybe NameReason
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TermTypeState -&gt; Map VName NameReason
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#stateNames"><span class="hs-identifier hs-var hs-var">stateNames</span></a></span><span>
</span><span id="line-234"></span><span>
</span><span id="line-235"></span><span id="local-6989586621684558029"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#useAfterConsume"><span class="hs-identifier hs-type">useAfterConsume</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SrcLoc</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SrcLoc</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684558029"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-236"></span><span id="useAfterConsume"><span class="annot"><span class="annottext">useAfterConsume :: forall a. VName -&gt; SrcLoc -&gt; SrcLoc -&gt; TermTypeM a
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#useAfterConsume"><span class="hs-identifier hs-var hs-var">useAfterConsume</span></a></span></span><span> </span><span id="local-6989586621684557071"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684557071"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621684557070"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684557070"><span class="hs-identifier hs-var">rloc</span></a></span></span><span> </span><span id="local-6989586621684557069"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684557069"><span class="hs-identifier hs-var">wloc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-237"></span><span>  </span><span id="local-6989586621684557068"><span class="annot"><span class="annottext">Doc
</span><a href="#local-6989586621684557068"><span class="hs-identifier hs-var">name'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SrcLoc -&gt; VName -&gt; TermTypeM Doc
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#describeVar"><span class="hs-identifier hs-var">describeVar</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684557070"><span class="hs-identifier hs-var">rloc</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684557071"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-238"></span><span>  </span><span class="annot"><span class="annottext">SrcLoc -&gt; Notes -&gt; Doc -&gt; TermTypeM a
forall (m :: * -&gt; *) loc a.
(MonadTypeChecker m, Located loc) =&gt;
loc -&gt; Notes -&gt; Doc -&gt; m a
</span><a href="Language.Futhark.TypeChecker.Monad.html#typeError"><span class="hs-identifier hs-var">typeError</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684557070"><span class="hs-identifier hs-var">rloc</span></a></span><span> </span><span class="annot"><span class="annottext">Notes
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; TermTypeM a) -&gt; (Doc -&gt; Doc) -&gt; Doc -&gt; TermTypeM a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><a href="Language.Futhark.TypeChecker.Monad.html#withIndexLink"><span class="hs-identifier hs-var">withIndexLink</span></a></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;use-after-consume&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; TermTypeM a) -&gt; Doc -&gt; TermTypeM a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-239"></span><span>    </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Using&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><a href="#local-6989586621684557068"><span class="hs-identifier hs-var">name'</span></a></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;, but this was consumed at&quot;</span></span><span>
</span><span id="line-240"></span><span>      </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Doc
</span><span class="hs-identifier hs-var">text</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SrcLoc -&gt; SrcLoc -&gt; [Char]
forall a b. (Located a, Located b) =&gt; a -&gt; b -&gt; [Char]
</span><a href="Language.Futhark.Core.html#locStrRel"><span class="hs-identifier hs-var">locStrRel</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684557070"><span class="hs-identifier hs-var">rloc</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684557069"><span class="hs-identifier hs-var">wloc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;.  (Possibly through aliasing.)&quot;</span></span><span>
</span><span id="line-241"></span><span>
</span><span id="line-242"></span><span id="local-6989586621684557979"><span id="local-6989586621684557980"><span id="local-6989586621684557981"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#badLetWithValue"><span class="hs-identifier hs-type">badLetWithValue</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Pretty</span></span><span> </span><span class="annot"><a href="#local-6989586621684557981"><span class="hs-identifier hs-type">arr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Pretty</span></span><span> </span><span class="annot"><a href="#local-6989586621684557980"><span class="hs-identifier hs-type">src</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684557981"><span class="hs-identifier hs-type">arr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684557980"><span class="hs-identifier hs-type">src</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SrcLoc</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684557979"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-243"></span><span id="badLetWithValue"><span class="annot"><span class="annottext">badLetWithValue :: forall arr src a.
(Pretty arr, Pretty src) =&gt;
arr -&gt; src -&gt; SrcLoc -&gt; TermTypeM a
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#badLetWithValue"><span class="hs-identifier hs-var hs-var">badLetWithValue</span></a></span></span><span> </span><span id="local-6989586621684557051"><span class="annot"><span class="annottext">arr
</span><a href="#local-6989586621684557051"><span class="hs-identifier hs-var">arre</span></a></span></span><span> </span><span id="local-6989586621684557050"><span class="annot"><span class="annottext">src
</span><a href="#local-6989586621684557050"><span class="hs-identifier hs-var">vale</span></a></span></span><span> </span><span id="local-6989586621684557049"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684557049"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-244"></span><span>  </span><span class="annot"><span class="annottext">SrcLoc -&gt; Notes -&gt; Doc -&gt; TermTypeM a
forall (m :: * -&gt; *) loc a.
(MonadTypeChecker m, Located loc) =&gt;
loc -&gt; Notes -&gt; Doc -&gt; m a
</span><a href="Language.Futhark.TypeChecker.Monad.html#typeError"><span class="hs-identifier hs-var">typeError</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684557049"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">Notes
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; TermTypeM a) -&gt; Doc -&gt; TermTypeM a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-245"></span><span>    </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Source array for in-place update&quot;</span></span><span>
</span><span id="line-246"></span><span>      </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Doc -&gt; Doc
</span><span class="hs-identifier hs-var">indent</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">arr -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">arr
</span><a href="#local-6989586621684557051"><span class="hs-identifier hs-var">arre</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-247"></span><span>      </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;might alias update value&quot;</span></span><span>
</span><span id="line-248"></span><span>      </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Doc -&gt; Doc
</span><span class="hs-identifier hs-var">indent</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">src -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">src
</span><a href="#local-6989586621684557050"><span class="hs-identifier hs-var">vale</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-249"></span><span>      </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Hint: use&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><a href="Language.Futhark.Core.html#pquote"><span class="hs-identifier hs-var">pquote</span></a></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;copy&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;to remove aliases from the value.&quot;</span></span><span>
</span><span id="line-250"></span><span>
</span><span id="line-251"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#returnAliased"><span class="hs-identifier hs-type">returnAliased</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SrcLoc</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-252"></span><span id="returnAliased"><span class="annot"><span class="annottext">returnAliased :: Name -&gt; SrcLoc -&gt; TermTypeM ()
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#returnAliased"><span class="hs-identifier hs-var hs-var">returnAliased</span></a></span></span><span> </span><span id="local-6989586621684557045"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684557045"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621684557044"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684557044"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-253"></span><span>  </span><span class="annot"><span class="annottext">SrcLoc -&gt; Notes -&gt; Doc -&gt; TermTypeM ()
forall (m :: * -&gt; *) loc a.
(MonadTypeChecker m, Located loc) =&gt;
loc -&gt; Notes -&gt; Doc -&gt; m a
</span><a href="Language.Futhark.TypeChecker.Monad.html#typeError"><span class="hs-identifier hs-var">typeError</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684557044"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">Notes
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; TermTypeM ()) -&gt; (Doc -&gt; Doc) -&gt; Doc -&gt; TermTypeM ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><a href="Language.Futhark.TypeChecker.Monad.html#withIndexLink"><span class="hs-identifier hs-var">withIndexLink</span></a></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;return-aliased&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; TermTypeM ()) -&gt; Doc -&gt; TermTypeM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-254"></span><span>    </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Unique-typed return value is aliased to&quot;</span></span><span>
</span><span id="line-255"></span><span>      </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><a href="Language.Futhark.Core.html#pquote"><span class="hs-identifier hs-var">pquote</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Doc
forall v. IsName v =&gt; v -&gt; Doc
</span><a href="Language.Futhark.Pretty.html#pprName"><span class="hs-identifier hs-var">pprName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684557045"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;, which is not consumable.&quot;</span></span><span>
</span><span id="line-256"></span><span>
</span><span id="line-257"></span><span id="local-6989586621684557974"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#uniqueReturnAliased"><span class="hs-identifier hs-type">uniqueReturnAliased</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SrcLoc</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684557974"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-258"></span><span id="uniqueReturnAliased"><span class="annot"><span class="annottext">uniqueReturnAliased :: forall a. SrcLoc -&gt; TermTypeM a
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#uniqueReturnAliased"><span class="hs-identifier hs-var hs-var">uniqueReturnAliased</span></a></span></span><span> </span><span id="local-6989586621684557038"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684557038"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-259"></span><span>  </span><span class="annot"><span class="annottext">SrcLoc -&gt; Notes -&gt; Doc -&gt; TermTypeM a
forall (m :: * -&gt; *) loc a.
(MonadTypeChecker m, Located loc) =&gt;
loc -&gt; Notes -&gt; Doc -&gt; m a
</span><a href="Language.Futhark.TypeChecker.Monad.html#typeError"><span class="hs-identifier hs-var">typeError</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684557038"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">Notes
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; TermTypeM a) -&gt; (Doc -&gt; Doc) -&gt; Doc -&gt; TermTypeM a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><a href="Language.Futhark.TypeChecker.Monad.html#withIndexLink"><span class="hs-identifier hs-var">withIndexLink</span></a></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;unique-return-aliased&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; TermTypeM a) -&gt; Doc -&gt; TermTypeM a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-260"></span><span>    </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;A unique-typed component of the return value is aliased to some other component.&quot;</span></span><span>
</span><span id="line-261"></span><span>
</span><span id="line-262"></span><span id="local-6989586621684557970"><span id="local-6989586621684557972"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#unexpectedType"><span class="hs-identifier hs-type">unexpectedType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Monad.html#MonadTypeChecker"><span class="hs-identifier hs-type">MonadTypeChecker</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684557972"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SrcLoc</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#StructType"><span class="hs-identifier hs-type">StructType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Syntax.html#StructType"><span class="hs-identifier hs-type">StructType</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684557972"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684557970"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-263"></span><span id="unexpectedType"><span class="annot"><span class="annottext">unexpectedType :: forall (m :: * -&gt; *) a.
MonadTypeChecker m =&gt;
SrcLoc -&gt; StructType -&gt; [StructType] -&gt; m a
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#unexpectedType"><span class="hs-identifier hs-var hs-var">unexpectedType</span></a></span></span><span> </span><span id="local-6989586621684557015"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684557015"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span class="annot"><span class="annottext">StructType
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-264"></span><span>  </span><span class="annot"><span class="annottext">SrcLoc -&gt; Notes -&gt; Doc -&gt; m a
forall (m :: * -&gt; *) loc a.
(MonadTypeChecker m, Located loc) =&gt;
loc -&gt; Notes -&gt; Doc -&gt; m a
</span><a href="Language.Futhark.TypeChecker.Monad.html#typeError"><span class="hs-identifier hs-var">typeError</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684557015"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">Notes
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; m a) -&gt; Doc -&gt; m a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-265"></span><span>    </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Type of expression at&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Doc
</span><span class="hs-identifier hs-var">text</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SrcLoc -&gt; [Char]
forall a. Located a =&gt; a -&gt; [Char]
</span><a href="Language.Futhark.Core.html#locStr"><span class="hs-identifier hs-var">locStr</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684557015"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-266"></span><span>      </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;cannot have any type - possibly a bug in the type checker.&quot;</span></span><span>
</span><span id="line-267"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#unexpectedType"><span class="hs-identifier hs-var">unexpectedType</span></a></span><span> </span><span id="local-6989586621684557013"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684557013"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span id="local-6989586621684557012"><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684557012"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621684557011"><span class="annot"><span class="annottext">[StructType]
</span><a href="#local-6989586621684557011"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-268"></span><span>  </span><span class="annot"><span class="annottext">SrcLoc -&gt; Notes -&gt; Doc -&gt; m a
forall (m :: * -&gt; *) loc a.
(MonadTypeChecker m, Located loc) =&gt;
loc -&gt; Notes -&gt; Doc -&gt; m a
</span><a href="Language.Futhark.TypeChecker.Monad.html#typeError"><span class="hs-identifier hs-var">typeError</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684557013"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">Notes
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; m a) -&gt; Doc -&gt; m a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-269"></span><span>    </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Type of expression at&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Doc
</span><span class="hs-identifier hs-var">text</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SrcLoc -&gt; [Char]
forall a. Located a =&gt; a -&gt; [Char]
</span><a href="Language.Futhark.Core.html#locStr"><span class="hs-identifier hs-var">locStr</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684557013"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;must be one of&quot;</span></span><span>
</span><span id="line-270"></span><span>      </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Doc] -&gt; Doc
</span><span class="hs-identifier hs-var">commasep</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(StructType -&gt; Doc) -&gt; [StructType] -&gt; [Doc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">StructType -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">[StructType]
</span><a href="#local-6989586621684557011"><span class="hs-identifier hs-var">ts</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;, but is&quot;</span></span><span>
</span><span id="line-271"></span><span>      </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">StructType -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684557012"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;.&quot;</span></span><span>
</span><span id="line-272"></span><span>
</span><span id="line-273"></span><span id="local-6989586621684557961"><span id="local-6989586621684557962"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#notConsumable"><span class="hs-identifier hs-type">notConsumable</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Monad.html#MonadTypeChecker"><span class="hs-identifier hs-type">MonadTypeChecker</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684557962"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SrcLoc</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Doc</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684557962"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684557961"><span class="hs-identifier hs-type">b</span></a></span></span></span><span>
</span><span id="line-274"></span><span id="notConsumable"><span class="annot"><span class="annottext">notConsumable :: forall (m :: * -&gt; *) b. MonadTypeChecker m =&gt; SrcLoc -&gt; Doc -&gt; m b
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#notConsumable"><span class="hs-identifier hs-var hs-var">notConsumable</span></a></span></span><span> </span><span id="local-6989586621684557001"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684557001"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span id="local-6989586621684557000"><span class="annot"><span class="annottext">Doc
</span><a href="#local-6989586621684557000"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-275"></span><span>  </span><span class="annot"><span class="annottext">SrcLoc -&gt; Notes -&gt; Doc -&gt; m b
forall (m :: * -&gt; *) loc a.
(MonadTypeChecker m, Located loc) =&gt;
loc -&gt; Notes -&gt; Doc -&gt; m a
</span><a href="Language.Futhark.TypeChecker.Monad.html#typeError"><span class="hs-identifier hs-var">typeError</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684557001"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">Notes
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; m b) -&gt; (Doc -&gt; Doc) -&gt; Doc -&gt; m b
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><a href="Language.Futhark.TypeChecker.Monad.html#withIndexLink"><span class="hs-identifier hs-var">withIndexLink</span></a></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;not-consumable&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; m b) -&gt; Doc -&gt; m b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-276"></span><span>    </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Would consume&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><a href="#local-6989586621684557000"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;, which is not consumable.&quot;</span></span><span>
</span><span id="line-277"></span><span>
</span><span id="line-278"></span><span id="local-6989586621684557956"><span id="local-6989586621684557958"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#unusedSize"><span class="hs-identifier hs-type">unusedSize</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Monad.html#MonadTypeChecker"><span class="hs-identifier hs-type">MonadTypeChecker</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684557958"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#SizeBinder"><span class="hs-identifier hs-type">SizeBinder</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684557958"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684557956"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-279"></span><span id="unusedSize"><span class="annot"><span class="annottext">unusedSize :: forall (m :: * -&gt; *) a.
MonadTypeChecker m =&gt;
SizeBinder VName -&gt; m a
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#unusedSize"><span class="hs-identifier hs-var hs-var">unusedSize</span></a></span></span><span> </span><span id="local-6989586621684556989"><span class="annot"><span class="annottext">SizeBinder VName
</span><a href="#local-6989586621684556989"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-280"></span><span>  </span><span class="annot"><span class="annottext">SizeBinder VName -&gt; Notes -&gt; Doc -&gt; m a
forall (m :: * -&gt; *) loc a.
(MonadTypeChecker m, Located loc) =&gt;
loc -&gt; Notes -&gt; Doc -&gt; m a
</span><a href="Language.Futhark.TypeChecker.Monad.html#typeError"><span class="hs-identifier hs-var">typeError</span></a></span><span> </span><span class="annot"><span class="annottext">SizeBinder VName
</span><a href="#local-6989586621684556989"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">Notes
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; m a) -&gt; (Doc -&gt; Doc) -&gt; Doc -&gt; m a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><a href="Language.Futhark.TypeChecker.Monad.html#withIndexLink"><span class="hs-identifier hs-var">withIndexLink</span></a></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;unused-size&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; m a) -&gt; Doc -&gt; m a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-281"></span><span>    </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Size&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">SizeBinder VName -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">SizeBinder VName
</span><a href="#local-6989586621684556989"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;unused in pattern.&quot;</span></span><span>
</span><span id="line-282"></span><span>
</span><span id="line-283"></span><span class="hs-comment">--- Scope management</span><span>
</span><span id="line-284"></span><span>
</span><span id="line-285"></span><span class="hs-keyword">data</span><span> </span><span id="InferredType"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#InferredType"><span class="hs-identifier hs-var">InferredType</span></a></span></span><span>
</span><span id="line-286"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="NoneInferred"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#NoneInferred"><span class="hs-identifier hs-var">NoneInferred</span></a></span></span><span>
</span><span id="line-287"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="Ascribed"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Ascribed"><span class="hs-identifier hs-var">Ascribed</span></a></span></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#PatType"><span class="hs-identifier hs-type">PatType</span></a></span><span>
</span><span id="line-288"></span><span>
</span><span id="line-289"></span><span class="hs-keyword">data</span><span> </span><span id="Checking"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Checking"><span class="hs-identifier hs-var">Checking</span></a></span></span><span>
</span><span id="line-290"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="CheckingApply"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#CheckingApply"><span class="hs-identifier hs-var">CheckingApply</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#QualName"><span class="hs-identifier hs-type">QualName</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Language.Futhark.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#StructType"><span class="hs-identifier hs-type">StructType</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#StructType"><span class="hs-identifier hs-type">StructType</span></a></span><span>
</span><span id="line-291"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="CheckingReturn"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#CheckingReturn"><span class="hs-identifier hs-var">CheckingReturn</span></a></span></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#StructType"><span class="hs-identifier hs-type">StructType</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#StructType"><span class="hs-identifier hs-type">StructType</span></a></span><span>
</span><span id="line-292"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="CheckingAscription"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#CheckingAscription"><span class="hs-identifier hs-var">CheckingAscription</span></a></span></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#StructType"><span class="hs-identifier hs-type">StructType</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#StructType"><span class="hs-identifier hs-type">StructType</span></a></span><span>
</span><span id="line-293"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="CheckingLetGeneralise"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#CheckingLetGeneralise"><span class="hs-identifier hs-var">CheckingLetGeneralise</span></a></span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span>
</span><span id="line-294"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="CheckingParams"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#CheckingParams"><span class="hs-identifier hs-var">CheckingParams</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-295"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="CheckingPat"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#CheckingPat"><span class="hs-identifier hs-var">CheckingPat</span></a></span></span><span> </span><span class="annot"><a href="Language.Futhark.Prop.html#UncheckedPat"><span class="hs-identifier hs-type">UncheckedPat</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#InferredType"><span class="hs-identifier hs-type">InferredType</span></a></span><span>
</span><span id="line-296"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="CheckingLoopBody"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#CheckingLoopBody"><span class="hs-identifier hs-var">CheckingLoopBody</span></a></span></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#StructType"><span class="hs-identifier hs-type">StructType</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#StructType"><span class="hs-identifier hs-type">StructType</span></a></span><span>
</span><span id="line-297"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="CheckingLoopInitial"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#CheckingLoopInitial"><span class="hs-identifier hs-var">CheckingLoopInitial</span></a></span></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#StructType"><span class="hs-identifier hs-type">StructType</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#StructType"><span class="hs-identifier hs-type">StructType</span></a></span><span>
</span><span id="line-298"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="CheckingRecordUpdate"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#CheckingRecordUpdate"><span class="hs-identifier hs-var">CheckingRecordUpdate</span></a></span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#StructType"><span class="hs-identifier hs-type">StructType</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#StructType"><span class="hs-identifier hs-type">StructType</span></a></span><span>
</span><span id="line-299"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="CheckingRequired"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#CheckingRequired"><span class="hs-identifier hs-var">CheckingRequired</span></a></span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Syntax.html#StructType"><span class="hs-identifier hs-type">StructType</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#StructType"><span class="hs-identifier hs-type">StructType</span></a></span><span>
</span><span id="line-300"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="CheckingBranches"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#CheckingBranches"><span class="hs-identifier hs-var">CheckingBranches</span></a></span></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#StructType"><span class="hs-identifier hs-type">StructType</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#StructType"><span class="hs-identifier hs-type">StructType</span></a></span><span>
</span><span id="line-301"></span><span>
</span><span id="line-302"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621684556971"><span id="local-6989586621684556973"><span class="annot"><span class="hs-identifier hs-type">Pretty</span></span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Checking"><span class="hs-identifier hs-type">Checking</span></a></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-303"></span><span>  </span><span id="local-6989586621684556900"><span class="annot"><span class="annottext">ppr :: Checking -&gt; Doc
</span><a href="#local-6989586621684556900"><span class="hs-identifier hs-var hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#CheckingApply"><span class="hs-identifier hs-type">CheckingApply</span></a></span><span> </span><span id="local-6989586621684556899"><span class="annot"><span class="annottext">Maybe (QualName VName)
</span><a href="#local-6989586621684556899"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621684556898"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684556898"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621684556897"><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684556897"><span class="hs-identifier hs-var">expected</span></a></span></span><span> </span><span id="local-6989586621684556896"><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684556896"><span class="hs-identifier hs-var">actual</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-304"></span><span>    </span><span class="annot"><span class="annottext">Doc
</span><a href="#local-6989586621684556895"><span class="hs-identifier hs-var">header</span></a></span><span>
</span><span id="line-305"></span><span>      </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Expected:&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><span class="hs-identifier hs-var">align</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StructType -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684556897"><span class="hs-identifier hs-var">expected</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-306"></span><span>      </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Actual:  &quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><span class="hs-identifier hs-var">align</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StructType -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684556896"><span class="hs-identifier hs-var">actual</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-307"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-308"></span><span>      </span><span id="local-6989586621684556895"><span class="annot"><span class="annottext">header :: Doc
</span><a href="#local-6989586621684556895"><span class="hs-identifier hs-var hs-var">header</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-309"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (QualName VName)
</span><a href="#local-6989586621684556899"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-310"></span><span>          </span><span class="annot"><span class="annottext">Maybe (QualName VName)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-311"></span><span>            </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Cannot apply function to&quot;</span></span><span>
</span><span id="line-312"></span><span>              </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><a href="Language.Futhark.Core.html#pquote"><span class="hs-identifier hs-var">pquote</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char] -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><a href="Futhark.Util.Pretty.html#shorten"><span class="hs-identifier hs-var">shorten</span></a></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; Doc) -&gt; [Char] -&gt; Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; [Char]
forall a. Pretty a =&gt; a -&gt; [Char]
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; [Char]) -&gt; Doc -&gt; [Char]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><span class="hs-identifier hs-var">flatten</span></span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; Doc) -&gt; Doc -&gt; Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684556898"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot; (invalid type).&quot;</span></span><span>
</span><span id="line-313"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684556867"><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684556867"><span class="hs-identifier hs-var">fname</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-314"></span><span>            </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Cannot apply&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><a href="Language.Futhark.Core.html#pquote"><span class="hs-identifier hs-var">pquote</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QualName VName -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684556867"><span class="hs-identifier hs-var">fname</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;to&quot;</span></span><span>
</span><span id="line-315"></span><span>              </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><a href="Language.Futhark.Core.html#pquote"><span class="hs-identifier hs-var">pquote</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char] -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><a href="Futhark.Util.Pretty.html#shorten"><span class="hs-identifier hs-var">shorten</span></a></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; Doc) -&gt; [Char] -&gt; Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; [Char]
forall a. Pretty a =&gt; a -&gt; [Char]
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; [Char]) -&gt; Doc -&gt; [Char]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><span class="hs-identifier hs-var">flatten</span></span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; Doc) -&gt; Doc -&gt; Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684556898"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot; (invalid type).&quot;</span></span><span>
</span><span id="line-316"></span><span>  </span><span class="annot"><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#CheckingReturn"><span class="hs-identifier hs-type">CheckingReturn</span></a></span><span> </span><span id="local-6989586621684556866"><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684556866"><span class="hs-identifier hs-var">expected</span></a></span></span><span> </span><span id="local-6989586621684556865"><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684556865"><span class="hs-identifier hs-var">actual</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-317"></span><span>    </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Function body does not have expected type.&quot;</span></span><span>
</span><span id="line-318"></span><span>      </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Expected:&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><span class="hs-identifier hs-var">align</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StructType -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684556866"><span class="hs-identifier hs-var">expected</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-319"></span><span>      </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Actual:  &quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><span class="hs-identifier hs-var">align</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StructType -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684556865"><span class="hs-identifier hs-var">actual</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-320"></span><span>  </span><span class="annot"><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#CheckingAscription"><span class="hs-identifier hs-type">CheckingAscription</span></a></span><span> </span><span id="local-6989586621684556864"><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684556864"><span class="hs-identifier hs-var">expected</span></a></span></span><span> </span><span id="local-6989586621684556863"><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684556863"><span class="hs-identifier hs-var">actual</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-321"></span><span>    </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Expression does not have expected type from explicit ascription.&quot;</span></span><span>
</span><span id="line-322"></span><span>      </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Expected:&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><span class="hs-identifier hs-var">align</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StructType -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684556864"><span class="hs-identifier hs-var">expected</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-323"></span><span>      </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Actual:  &quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><span class="hs-identifier hs-var">align</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StructType -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684556863"><span class="hs-identifier hs-var">actual</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-324"></span><span>  </span><span class="annot"><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#CheckingLetGeneralise"><span class="hs-identifier hs-type">CheckingLetGeneralise</span></a></span><span> </span><span id="local-6989586621684556862"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684556862"><span class="hs-identifier hs-var">fname</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-325"></span><span>    </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Cannot generalise type of&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><a href="Language.Futhark.Core.html#pquote"><span class="hs-identifier hs-var">pquote</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684556862"><span class="hs-identifier hs-var">fname</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;.&quot;</span></span><span>
</span><span id="line-326"></span><span>  </span><span class="annot"><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#CheckingParams"><span class="hs-identifier hs-type">CheckingParams</span></a></span><span> </span><span id="local-6989586621684556861"><span class="annot"><span class="annottext">Maybe Name
</span><a href="#local-6989586621684556861"><span class="hs-identifier hs-var">fname</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-327"></span><span>    </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Invalid use of parameters in&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><a href="Language.Futhark.Core.html#pquote"><span class="hs-identifier hs-var">pquote</span></a></span><span> </span><span class="annot"><span class="annottext">Doc
</span><a href="#local-6989586621684556860"><span class="hs-identifier hs-var">fname'</span></a></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;.&quot;</span></span><span>
</span><span id="line-328"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-329"></span><span>      </span><span id="local-6989586621684556860"><span class="annot"><span class="annottext">fname' :: Doc
</span><a href="#local-6989586621684556860"><span class="hs-identifier hs-var hs-var">fname'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Doc -&gt; (Name -&gt; Doc) -&gt; Maybe Name -&gt; Doc
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;anonymous function&quot;</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">Maybe Name
</span><a href="#local-6989586621684556861"><span class="hs-identifier hs-var">fname</span></a></span><span>
</span><span id="line-330"></span><span>  </span><span class="annot"><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#CheckingPat"><span class="hs-identifier hs-type">CheckingPat</span></a></span><span> </span><span id="local-6989586621684556857"><span class="annot"><span class="annottext">UncheckedPat
</span><a href="#local-6989586621684556857"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="annot"><span class="annottext">InferredType
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#NoneInferred"><span class="hs-identifier hs-var">NoneInferred</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-331"></span><span>    </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Invalid pattern&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><a href="Language.Futhark.Core.html#pquote"><span class="hs-identifier hs-var">pquote</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UncheckedPat -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">UncheckedPat
</span><a href="#local-6989586621684556857"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;.&quot;</span></span><span>
</span><span id="line-332"></span><span>  </span><span class="annot"><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#CheckingPat"><span class="hs-identifier hs-type">CheckingPat</span></a></span><span> </span><span id="local-6989586621684556856"><span class="annot"><span class="annottext">UncheckedPat
</span><a href="#local-6989586621684556856"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Ascribed"><span class="hs-identifier hs-type">Ascribed</span></a></span><span> </span><span id="local-6989586621684556855"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684556855"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-333"></span><span>    </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Pat&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><a href="Language.Futhark.Core.html#pquote"><span class="hs-identifier hs-var">pquote</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UncheckedPat -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">UncheckedPat
</span><a href="#local-6989586621684556856"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-334"></span><span>      </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;cannot match value of type&quot;</span></span><span>
</span><span id="line-335"></span><span>      </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Doc -&gt; Doc
</span><span class="hs-identifier hs-var">indent</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatType -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684556855"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-336"></span><span>  </span><span class="annot"><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#CheckingLoopBody"><span class="hs-identifier hs-type">CheckingLoopBody</span></a></span><span> </span><span id="local-6989586621684556854"><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684556854"><span class="hs-identifier hs-var">expected</span></a></span></span><span> </span><span id="local-6989586621684556853"><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684556853"><span class="hs-identifier hs-var">actual</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-337"></span><span>    </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Loop body does not have expected type.&quot;</span></span><span>
</span><span id="line-338"></span><span>      </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Expected:&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><span class="hs-identifier hs-var">align</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StructType -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684556854"><span class="hs-identifier hs-var">expected</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-339"></span><span>      </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Actual:  &quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><span class="hs-identifier hs-var">align</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StructType -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684556853"><span class="hs-identifier hs-var">actual</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-340"></span><span>  </span><span class="annot"><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#CheckingLoopInitial"><span class="hs-identifier hs-type">CheckingLoopInitial</span></a></span><span> </span><span id="local-6989586621684556852"><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684556852"><span class="hs-identifier hs-var">expected</span></a></span></span><span> </span><span id="local-6989586621684556851"><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684556851"><span class="hs-identifier hs-var">actual</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-341"></span><span>    </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Initial loop values do not have expected type.&quot;</span></span><span>
</span><span id="line-342"></span><span>      </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Expected:&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><span class="hs-identifier hs-var">align</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StructType -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684556852"><span class="hs-identifier hs-var">expected</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-343"></span><span>      </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Actual:  &quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><span class="hs-identifier hs-var">align</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StructType -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684556851"><span class="hs-identifier hs-var">actual</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-344"></span><span>  </span><span class="annot"><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#CheckingRecordUpdate"><span class="hs-identifier hs-type">CheckingRecordUpdate</span></a></span><span> </span><span id="local-6989586621684556850"><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621684556850"><span class="hs-identifier hs-var">fs</span></a></span></span><span> </span><span id="local-6989586621684556849"><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684556849"><span class="hs-identifier hs-var">expected</span></a></span></span><span> </span><span id="local-6989586621684556848"><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684556848"><span class="hs-identifier hs-var">actual</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-345"></span><span>    </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Type mismatch when updating record field&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><a href="Language.Futhark.Core.html#pquote"><span class="hs-identifier hs-var">pquote</span></a></span><span> </span><span class="annot"><span class="annottext">Doc
</span><a href="#local-6989586621684556847"><span class="hs-identifier hs-var">fs'</span></a></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;.&quot;</span></span><span>
</span><span id="line-346"></span><span>      </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Existing:&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><span class="hs-identifier hs-var">align</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StructType -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684556849"><span class="hs-identifier hs-var">expected</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-347"></span><span>      </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;New:     &quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><span class="hs-identifier hs-var">align</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StructType -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684556848"><span class="hs-identifier hs-var">actual</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-348"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-349"></span><span>      </span><span id="local-6989586621684556847"><span class="annot"><span class="annottext">fs' :: Doc
</span><a href="#local-6989586621684556847"><span class="hs-identifier hs-var hs-var">fs'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Doc] -&gt; Doc
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">([Doc] -&gt; Doc) -&gt; [Doc] -&gt; Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; [Doc] -&gt; [Doc]
</span><span class="hs-identifier hs-var">punctuate</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;.&quot;</span></span><span> </span><span class="annot"><span class="annottext">([Doc] -&gt; [Doc]) -&gt; [Doc] -&gt; [Doc]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Name -&gt; Doc) -&gt; [Name] -&gt; [Doc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621684556850"><span class="hs-identifier hs-var">fs</span></a></span><span>
</span><span id="line-350"></span><span>  </span><span class="annot"><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#CheckingRequired"><span class="hs-identifier hs-type">CheckingRequired</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621684556841"><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684556841"><span class="hs-identifier hs-var">expected</span></a></span></span><span class="hs-special">]</span><span> </span><span id="local-6989586621684556840"><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684556840"><span class="hs-identifier hs-var">actual</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-351"></span><span>    </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Expression must must have type&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">StructType -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684556841"><span class="hs-identifier hs-var">expected</span></a></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;.&quot;</span></span><span>
</span><span id="line-352"></span><span>      </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Actual type:&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><span class="hs-identifier hs-var">align</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StructType -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684556840"><span class="hs-identifier hs-var">actual</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-353"></span><span>  </span><span class="annot"><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#CheckingRequired"><span class="hs-identifier hs-type">CheckingRequired</span></a></span><span> </span><span id="local-6989586621684556839"><span class="annot"><span class="annottext">[StructType]
</span><a href="#local-6989586621684556839"><span class="hs-identifier hs-var">expected</span></a></span></span><span> </span><span id="local-6989586621684556838"><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684556838"><span class="hs-identifier hs-var">actual</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-354"></span><span>    </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Type of expression must must be one of &quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><a href="#local-6989586621684556837"><span class="hs-identifier hs-var">expected'</span></a></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;.&quot;</span></span><span>
</span><span id="line-355"></span><span>      </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Actual type:&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><span class="hs-identifier hs-var">align</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StructType -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684556838"><span class="hs-identifier hs-var">actual</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-356"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-357"></span><span>      </span><span id="local-6989586621684556837"><span class="annot"><span class="annottext">expected' :: Doc
</span><a href="#local-6989586621684556837"><span class="hs-identifier hs-var hs-var">expected'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Doc] -&gt; Doc
</span><span class="hs-identifier hs-var">commasep</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(StructType -&gt; Doc) -&gt; [StructType] -&gt; [Doc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">StructType -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">[StructType]
</span><a href="#local-6989586621684556839"><span class="hs-identifier hs-var">expected</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-358"></span><span>  </span><span class="annot"><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#CheckingBranches"><span class="hs-identifier hs-type">CheckingBranches</span></a></span><span> </span><span id="local-6989586621684556833"><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684556833"><span class="hs-identifier hs-var">t1</span></a></span></span><span> </span><span id="local-6989586621684556832"><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684556832"><span class="hs-identifier hs-var">t2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-359"></span><span>    </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Branches differ in type.&quot;</span></span><span>
</span><span id="line-360"></span><span>      </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Former:&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">StructType -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684556833"><span class="hs-identifier hs-var">t1</span></a></span><span>
</span><span id="line-361"></span><span>      </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Latter:&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">StructType -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684556832"><span class="hs-identifier hs-var">t2</span></a></span><span>
</span><span id="line-362"></span><span>
</span><span id="line-363"></span><span class="hs-comment">-- | Type checking happens with access to this environment.  The</span><span>
</span><span id="line-364"></span><span class="hs-comment">-- 'TermScope' will be extended during type-checking as bindings come into</span><span>
</span><span id="line-365"></span><span class="hs-comment">-- scope.</span><span>
</span><span id="line-366"></span><span class="hs-keyword">data</span><span> </span><span id="TermEnv"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermEnv"><span class="hs-identifier hs-var">TermEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="TermEnv"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermEnv"><span class="hs-identifier hs-var">TermEnv</span></a></span></span><span>
</span><span id="line-367"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="termScope"><span class="annot"><span class="annottext">TermEnv -&gt; TermScope
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#termScope"><span class="hs-identifier hs-var hs-var">termScope</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermScope"><span class="hs-identifier hs-type">TermScope</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-368"></span><span>    </span><span id="termChecking"><span class="annot"><span class="annottext">TermEnv -&gt; Maybe Checking
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#termChecking"><span class="hs-identifier hs-var hs-var">termChecking</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Checking"><span class="hs-identifier hs-type">Checking</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-369"></span><span>    </span><span id="termLevel"><span class="annot"><span class="annottext">TermEnv -&gt; Int
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#termLevel"><span class="hs-identifier hs-var hs-var">termLevel</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Unify.html#Level"><span class="hs-identifier hs-type">Level</span></a></span><span>
</span><span id="line-370"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-371"></span><span>
</span><span id="line-372"></span><span class="hs-keyword">data</span><span> </span><span id="TermScope"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermScope"><span class="hs-identifier hs-var">TermScope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="TermScope"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermScope"><span class="hs-identifier hs-var">TermScope</span></a></span></span><span>
</span><span id="line-373"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="scopeVtable"><span class="annot"><span class="annottext">TermScope -&gt; Map VName ValBinding
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#scopeVtable"><span class="hs-identifier hs-var hs-var">scopeVtable</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#ValBinding"><span class="hs-identifier hs-type">ValBinding</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-374"></span><span>    </span><span id="scopeTypeTable"><span class="annot"><span class="annottext">TermScope -&gt; Map VName TypeBinding
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#scopeTypeTable"><span class="hs-identifier hs-var hs-var">scopeTypeTable</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Semantic.html#TypeBinding"><span class="hs-identifier hs-type">TypeBinding</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-375"></span><span>    </span><span id="scopeModTable"><span class="annot"><span class="annottext">TermScope -&gt; Map VName Mod
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#scopeModTable"><span class="hs-identifier hs-var hs-var">scopeModTable</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Semantic.html#Mod"><span class="hs-identifier hs-type">Mod</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-376"></span><span>    </span><span id="scopeNameMap"><span class="annot"><span class="annottext">TermScope -&gt; NameMap
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#scopeNameMap"><span class="hs-identifier hs-var hs-var">scopeNameMap</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Semantic.html#NameMap"><span class="hs-identifier hs-type">NameMap</span></a></span><span>
</span><span id="line-377"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-378"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684556804"><span id="local-6989586621684556806"><span id="local-6989586621684556820"><span class="annot"><span class="annottext">Int -&gt; TermScope -&gt; ShowS
[TermScope] -&gt; ShowS
TermScope -&gt; [Char]
(Int -&gt; TermScope -&gt; ShowS)
-&gt; (TermScope -&gt; [Char])
-&gt; ([TermScope] -&gt; ShowS)
-&gt; Show TermScope
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; [Char]) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [TermScope] -&gt; ShowS
$cshowList :: [TermScope] -&gt; ShowS
show :: TermScope -&gt; [Char]
$cshow :: TermScope -&gt; [Char]
showsPrec :: Int -&gt; TermScope -&gt; ShowS
$cshowsPrec :: Int -&gt; TermScope -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-379"></span><span>
</span><span id="line-380"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621684556791"><span id="local-6989586621684556793"><span class="annot"><span class="hs-identifier hs-type">Semigroup</span></span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermScope"><span class="hs-identifier hs-type">TermScope</span></a></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-381"></span><span>  </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermScope"><span class="hs-identifier hs-type">TermScope</span></a></span><span> </span><span id="local-6989586621684556785"><span class="annot"><span class="annottext">Map VName ValBinding
</span><a href="#local-6989586621684556785"><span class="hs-identifier hs-var">vt1</span></a></span></span><span> </span><span id="local-6989586621684556784"><span class="annot"><span class="annottext">Map VName TypeBinding
</span><a href="#local-6989586621684556784"><span class="hs-identifier hs-var">tt1</span></a></span></span><span> </span><span id="local-6989586621684556783"><span class="annot"><span class="annottext">Map VName Mod
</span><a href="#local-6989586621684556783"><span class="hs-identifier hs-var">mt1</span></a></span></span><span> </span><span id="local-6989586621684556782"><span class="annot"><span class="annottext">NameMap
</span><a href="#local-6989586621684556782"><span class="hs-identifier hs-var">nt1</span></a></span></span><span> </span><span id="local-6989586621684556781"><span class="annot"><span class="annottext">&lt;&gt; :: TermScope -&gt; TermScope -&gt; TermScope
</span><span class="hs-operator hs-var hs-var hs-var hs-var">&lt;&gt;</span></span></span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermScope"><span class="hs-identifier hs-type">TermScope</span></a></span><span> </span><span id="local-6989586621684556780"><span class="annot"><span class="annottext">Map VName ValBinding
</span><a href="#local-6989586621684556780"><span class="hs-identifier hs-var">vt2</span></a></span></span><span> </span><span id="local-6989586621684556779"><span class="annot"><span class="annottext">Map VName TypeBinding
</span><a href="#local-6989586621684556779"><span class="hs-identifier hs-var">tt2</span></a></span></span><span> </span><span id="local-6989586621684556778"><span class="annot"><span class="annottext">Map VName Mod
</span><a href="#local-6989586621684556778"><span class="hs-identifier hs-var">mt2</span></a></span></span><span> </span><span id="local-6989586621684556777"><span class="annot"><span class="annottext">NameMap
</span><a href="#local-6989586621684556777"><span class="hs-identifier hs-var">nt2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-382"></span><span>    </span><span class="annot"><span class="annottext">Map VName ValBinding
-&gt; Map VName TypeBinding -&gt; Map VName Mod -&gt; NameMap -&gt; TermScope
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermScope"><span class="hs-identifier hs-var">TermScope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName ValBinding
</span><a href="#local-6989586621684556780"><span class="hs-identifier hs-var">vt2</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName ValBinding
-&gt; Map VName ValBinding -&gt; Map VName ValBinding
forall k a. Ord k =&gt; Map k a -&gt; Map k a -&gt; Map k a
</span><span class="hs-operator hs-var">`M.union`</span></span><span> </span><span class="annot"><span class="annottext">Map VName ValBinding
</span><a href="#local-6989586621684556785"><span class="hs-identifier hs-var">vt1</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName TypeBinding
</span><a href="#local-6989586621684556779"><span class="hs-identifier hs-var">tt2</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName TypeBinding
-&gt; Map VName TypeBinding -&gt; Map VName TypeBinding
forall k a. Ord k =&gt; Map k a -&gt; Map k a -&gt; Map k a
</span><span class="hs-operator hs-var">`M.union`</span></span><span> </span><span class="annot"><span class="annottext">Map VName TypeBinding
</span><a href="#local-6989586621684556784"><span class="hs-identifier hs-var">tt1</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName Mod
</span><a href="#local-6989586621684556783"><span class="hs-identifier hs-var">mt1</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName Mod -&gt; Map VName Mod -&gt; Map VName Mod
forall k a. Ord k =&gt; Map k a -&gt; Map k a -&gt; Map k a
</span><span class="hs-operator hs-var">`M.union`</span></span><span> </span><span class="annot"><span class="annottext">Map VName Mod
</span><a href="#local-6989586621684556778"><span class="hs-identifier hs-var">mt2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NameMap
</span><a href="#local-6989586621684556777"><span class="hs-identifier hs-var">nt2</span></a></span><span> </span><span class="annot"><span class="annottext">NameMap -&gt; NameMap -&gt; NameMap
forall k a. Ord k =&gt; Map k a -&gt; Map k a -&gt; Map k a
</span><span class="hs-operator hs-var">`M.union`</span></span><span> </span><span class="annot"><span class="annottext">NameMap
</span><a href="#local-6989586621684556782"><span class="hs-identifier hs-var">nt1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-383"></span><span>
</span><span id="line-384"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#envToTermScope"><span class="hs-identifier hs-type">envToTermScope</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Semantic.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermScope"><span class="hs-identifier hs-type">TermScope</span></a></span><span>
</span><span id="line-385"></span><span id="envToTermScope"><span class="annot"><span class="annottext">envToTermScope :: Env -&gt; TermScope
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#envToTermScope"><span class="hs-identifier hs-var hs-var">envToTermScope</span></a></span></span><span> </span><span id="local-6989586621684556774"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684556774"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-386"></span><span>  </span><span class="annot"><span class="annottext">TermScope :: Map VName ValBinding
-&gt; Map VName TypeBinding -&gt; Map VName Mod -&gt; NameMap -&gt; TermScope
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermScope"><span class="hs-identifier hs-type">TermScope</span></a></span><span>
</span><span id="line-387"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">scopeVtable :: Map VName ValBinding
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#scopeVtable"><span class="hs-identifier hs-var">scopeVtable</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map VName ValBinding
</span><a href="#local-6989586621684556773"><span class="hs-identifier hs-var">vtable</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-388"></span><span>      </span><span class="annot"><span class="annottext">scopeTypeTable :: Map VName TypeBinding
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#scopeTypeTable"><span class="hs-identifier hs-var">scopeTypeTable</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Env -&gt; Map VName TypeBinding
</span><a href="Language.Futhark.Semantic.html#envTypeTable"><span class="hs-identifier hs-var hs-var">envTypeTable</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684556774"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-389"></span><span>      </span><span class="annot"><span class="annottext">scopeNameMap :: NameMap
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#scopeNameMap"><span class="hs-identifier hs-var">scopeNameMap</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Env -&gt; NameMap
</span><a href="Language.Futhark.Semantic.html#envNameMap"><span class="hs-identifier hs-var hs-var">envNameMap</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684556774"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-390"></span><span>      </span><span class="annot"><span class="annottext">scopeModTable :: Map VName Mod
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#scopeModTable"><span class="hs-identifier hs-var">scopeModTable</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Env -&gt; Map VName Mod
</span><a href="Language.Futhark.Semantic.html#envModTable"><span class="hs-identifier hs-var hs-var">envModTable</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684556774"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-391"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-392"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-393"></span><span>    </span><span id="local-6989586621684556773"><span class="annot"><span class="annottext">vtable :: Map VName ValBinding
</span><a href="#local-6989586621684556773"><span class="hs-identifier hs-var hs-var">vtable</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; BoundV -&gt; ValBinding)
-&gt; Map VName BoundV -&gt; Map VName ValBinding
forall k a b. (k -&gt; a -&gt; b) -&gt; Map k a -&gt; Map k b
</span><span class="hs-identifier hs-var">M.mapWithKey</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; BoundV -&gt; ValBinding
</span><a href="#local-6989586621684556768"><span class="hs-identifier hs-var">valBinding</span></a></span><span> </span><span class="annot"><span class="annottext">(Map VName BoundV -&gt; Map VName ValBinding)
-&gt; Map VName BoundV -&gt; Map VName ValBinding
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Env -&gt; Map VName BoundV
</span><a href="Language.Futhark.Semantic.html#envVtable"><span class="hs-identifier hs-var hs-var">envVtable</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684556774"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-394"></span><span>    </span><span id="local-6989586621684556768"><span class="annot"><span class="annottext">valBinding :: VName -&gt; BoundV -&gt; ValBinding
</span><a href="#local-6989586621684556768"><span class="hs-identifier hs-var hs-var">valBinding</span></a></span></span><span> </span><span id="local-6989586621684556762"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684556762"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Semantic.html#BoundV"><span class="hs-identifier hs-type">TypeM.BoundV</span></a></span><span> </span><span id="local-6989586621684556761"><span class="annot"><span class="annottext">[TypeParam]
</span><a href="#local-6989586621684556761"><span class="hs-identifier hs-var">tps</span></a></span></span><span> </span><span id="local-6989586621684556760"><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684556760"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-395"></span><span>      </span><span class="annot"><span class="annottext">Locality -&gt; [TypeParam] -&gt; PatType -&gt; ValBinding
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#BoundV"><span class="hs-identifier hs-var">BoundV</span></a></span><span> </span><span class="annot"><span class="annottext">Locality
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Global"><span class="hs-identifier hs-var">Global</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeParam]
</span><a href="#local-6989586621684556761"><span class="hs-identifier hs-var">tps</span></a></span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; ValBinding) -&gt; PatType -&gt; ValBinding
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-396"></span><span>        </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684556760"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-397"></span><span>          </span><span class="annot"><span class="annottext">StructType -&gt; Aliasing -&gt; PatType
forall dim asf ast. TypeBase dim asf -&gt; ast -&gt; TypeBase dim ast
</span><a href="Language.Futhark.Prop.html#setAliases"><span class="hs-operator hs-var">`setAliases`</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">StructType -&gt; Int
forall dim as. TypeBase dim as -&gt; Int
</span><a href="Language.Futhark.Prop.html#arrayRank"><span class="hs-identifier hs-var">arrayRank</span></a></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684556760"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Alias -&gt; Aliasing
forall a. a -&gt; Set a
</span><span class="hs-identifier hs-var">S.singleton</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Alias
</span><a href="Language.Futhark.Syntax.html#AliasBound"><span class="hs-identifier hs-var">AliasBound</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684556762"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Aliasing
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span>
</span><span id="line-398"></span><span>
</span><span id="line-399"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#withEnv"><span class="hs-identifier hs-type">withEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermEnv"><span class="hs-identifier hs-type">TermEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.Semantic.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermEnv"><span class="hs-identifier hs-type">TermEnv</span></a></span><span>
</span><span id="line-400"></span><span id="withEnv"><span class="annot"><span class="annottext">withEnv :: TermEnv -&gt; Env -&gt; TermEnv
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#withEnv"><span class="hs-identifier hs-var hs-var">withEnv</span></a></span></span><span> </span><span id="local-6989586621684556754"><span class="annot"><span class="annottext">TermEnv
</span><a href="#local-6989586621684556754"><span class="hs-identifier hs-var">tenv</span></a></span></span><span> </span><span id="local-6989586621684556753"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684556753"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TermEnv
</span><a href="#local-6989586621684556754"><span class="hs-identifier hs-var">tenv</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">termScope :: TermScope
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#termScope"><span class="hs-identifier hs-var">termScope</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TermEnv -&gt; TermScope
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#termScope"><span class="hs-identifier hs-var hs-var">termScope</span></a></span><span> </span><span class="annot"><span class="annottext">TermEnv
</span><a href="#local-6989586621684556754"><span class="hs-identifier hs-var">tenv</span></a></span><span> </span><span class="annot"><span class="annottext">TermScope -&gt; TermScope -&gt; TermScope
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Env -&gt; TermScope
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#envToTermScope"><span class="hs-identifier hs-var">envToTermScope</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684556753"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-401"></span><span>
</span><span id="line-402"></span><span class="hs-comment">-- Wrap a function name to give it a vacuous Eq instance for SizeSource.</span><span>
</span><span id="line-403"></span><span class="hs-keyword">newtype</span><span> </span><span id="FName"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#FName"><span class="hs-identifier hs-var">FName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="FName"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#FName"><span class="hs-identifier hs-var">FName</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#QualName"><span class="hs-identifier hs-type">QualName</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-404"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684556743"><span id="local-6989586621684556745"><span id="local-6989586621684556750"><span class="annot"><span class="annottext">Int -&gt; FName -&gt; ShowS
[FName] -&gt; ShowS
FName -&gt; [Char]
(Int -&gt; FName -&gt; ShowS)
-&gt; (FName -&gt; [Char]) -&gt; ([FName] -&gt; ShowS) -&gt; Show FName
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; [Char]) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [FName] -&gt; ShowS
$cshowList :: [FName] -&gt; ShowS
show :: FName -&gt; [Char]
$cshow :: FName -&gt; [Char]
showsPrec :: Int -&gt; FName -&gt; ShowS
$cshowsPrec :: Int -&gt; FName -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-405"></span><span>
</span><span id="line-406"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621684556739"><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#FName"><span class="hs-identifier hs-type">FName</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-407"></span><span>  </span><span class="annot"><span class="annottext">FName
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684556738"><span class="annot"><span class="annottext">== :: FName -&gt; FName -&gt; Bool
</span><span class="hs-operator hs-var hs-var hs-var hs-var">==</span></span></span><span> </span><span class="annot"><span class="annottext">FName
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-408"></span><span>
</span><span id="line-409"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621684556723"><span id="local-6989586621684556725"><span id="local-6989586621684556727"><span id="local-6989586621684556729"><span id="local-6989586621684556731"><span id="local-6989586621684556733"><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#FName"><span class="hs-identifier hs-type">FName</span></a></span></span></span></span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-410"></span><span>  </span><span id="local-6989586621684556722"><span class="annot"><span class="annottext">compare :: FName -&gt; FName -&gt; Ordering
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">compare</span></span></span><span> </span><span class="annot"><span class="annottext">FName
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">FName
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ordering
</span><span class="hs-identifier hs-var">EQ</span></span><span>
</span><span id="line-411"></span><span>
</span><span id="line-412"></span><span class="hs-comment">-- | What was the source of some existential size?  This is used for</span><span>
</span><span id="line-413"></span><span class="hs-comment">-- using the same existential variable if the same source is</span><span>
</span><span id="line-414"></span><span class="hs-comment">-- encountered in multiple locations.</span><span>
</span><span id="line-415"></span><span class="hs-keyword">data</span><span> </span><span id="SizeSource"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#SizeSource"><span class="hs-identifier hs-var">SizeSource</span></a></span></span><span>
</span><span id="line-416"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="SourceArg"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#SourceArg"><span class="hs-identifier hs-var">SourceArg</span></a></span></span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#FName"><span class="hs-identifier hs-type">FName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#ExpBase"><span class="hs-identifier hs-type">ExpBase</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#NoInfo"><span class="hs-identifier hs-type">NoInfo</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-417"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="SourceBound"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#SourceBound"><span class="hs-identifier hs-var">SourceBound</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#ExpBase"><span class="hs-identifier hs-type">ExpBase</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#NoInfo"><span class="hs-identifier hs-type">NoInfo</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-418"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="SourceSlice"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#SourceSlice"><span class="hs-identifier hs-var">SourceSlice</span></a></span></span><span>
</span><span id="line-419"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#DimDecl"><span class="hs-identifier hs-type">DimDecl</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-420"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#ExpBase"><span class="hs-identifier hs-type">ExpBase</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#NoInfo"><span class="hs-identifier hs-type">NoInfo</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-421"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#ExpBase"><span class="hs-identifier hs-type">ExpBase</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#NoInfo"><span class="hs-identifier hs-type">NoInfo</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-422"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#ExpBase"><span class="hs-identifier hs-type">ExpBase</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#NoInfo"><span class="hs-identifier hs-type">NoInfo</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-423"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684556705"><span id="local-6989586621684556716"><span class="annot"><span class="annottext">SizeSource -&gt; SizeSource -&gt; Bool
(SizeSource -&gt; SizeSource -&gt; Bool)
-&gt; (SizeSource -&gt; SizeSource -&gt; Bool) -&gt; Eq SizeSource
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: SizeSource -&gt; SizeSource -&gt; Bool
$c/= :: SizeSource -&gt; SizeSource -&gt; Bool
== :: SizeSource -&gt; SizeSource -&gt; Bool
$c== :: SizeSource -&gt; SizeSource -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684556667"><span id="local-6989586621684556669"><span id="local-6989586621684556672"><span id="local-6989586621684556675"><span id="local-6989586621684556678"><span id="local-6989586621684556688"><span id="local-6989586621684556700"><span class="annot"><span class="annottext">Eq SizeSource
Eq SizeSource
-&gt; (SizeSource -&gt; SizeSource -&gt; Ordering)
-&gt; (SizeSource -&gt; SizeSource -&gt; Bool)
-&gt; (SizeSource -&gt; SizeSource -&gt; Bool)
-&gt; (SizeSource -&gt; SizeSource -&gt; Bool)
-&gt; (SizeSource -&gt; SizeSource -&gt; Bool)
-&gt; (SizeSource -&gt; SizeSource -&gt; SizeSource)
-&gt; (SizeSource -&gt; SizeSource -&gt; SizeSource)
-&gt; Ord SizeSource
SizeSource -&gt; SizeSource -&gt; Bool
SizeSource -&gt; SizeSource -&gt; Ordering
SizeSource -&gt; SizeSource -&gt; SizeSource
forall a.
Eq a
-&gt; (a -&gt; a -&gt; Ordering)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; a)
-&gt; (a -&gt; a -&gt; a)
-&gt; Ord a
min :: SizeSource -&gt; SizeSource -&gt; SizeSource
$cmin :: SizeSource -&gt; SizeSource -&gt; SizeSource
max :: SizeSource -&gt; SizeSource -&gt; SizeSource
$cmax :: SizeSource -&gt; SizeSource -&gt; SizeSource
&gt;= :: SizeSource -&gt; SizeSource -&gt; Bool
$c&gt;= :: SizeSource -&gt; SizeSource -&gt; Bool
&gt; :: SizeSource -&gt; SizeSource -&gt; Bool
$c&gt; :: SizeSource -&gt; SizeSource -&gt; Bool
&lt;= :: SizeSource -&gt; SizeSource -&gt; Bool
$c&lt;= :: SizeSource -&gt; SizeSource -&gt; Bool
&lt; :: SizeSource -&gt; SizeSource -&gt; Bool
$c&lt; :: SizeSource -&gt; SizeSource -&gt; Bool
compare :: SizeSource -&gt; SizeSource -&gt; Ordering
$ccompare :: SizeSource -&gt; SizeSource -&gt; Ordering
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Ord</span></span></span></span></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684556647"><span id="local-6989586621684556649"><span id="local-6989586621684556664"><span class="annot"><span class="annottext">Int -&gt; SizeSource -&gt; ShowS
[SizeSource] -&gt; ShowS
SizeSource -&gt; [Char]
(Int -&gt; SizeSource -&gt; ShowS)
-&gt; (SizeSource -&gt; [Char])
-&gt; ([SizeSource] -&gt; ShowS)
-&gt; Show SizeSource
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; [Char]) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [SizeSource] -&gt; ShowS
$cshowList :: [SizeSource] -&gt; ShowS
show :: SizeSource -&gt; [Char]
$cshow :: SizeSource -&gt; [Char]
showsPrec :: Int -&gt; SizeSource -&gt; ShowS
$cshowsPrec :: Int -&gt; SizeSource -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-424"></span><span>
</span><span id="line-425"></span><span class="hs-comment">-- | A description of where an artificial compiler-generated</span><span>
</span><span id="line-426"></span><span class="hs-comment">-- intermediate name came from.</span><span>
</span><span id="line-427"></span><span class="hs-keyword">data</span><span> </span><span id="NameReason"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#NameReason"><span class="hs-identifier hs-var">NameReason</span></a></span></span><span>
</span><span id="line-428"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- | Name is the result of a function application.</span><span>
</span><span id="line-429"></span><span>    </span><span id="NameAppRes"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#NameAppRes"><span class="hs-identifier hs-var">NameAppRes</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#QualName"><span class="hs-identifier hs-type">QualName</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SrcLoc</span></span><span>
</span><span id="line-430"></span><span>
</span><span id="line-431"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#nameReason"><span class="hs-identifier hs-type">nameReason</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SrcLoc</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#NameReason"><span class="hs-identifier hs-type">NameReason</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Doc</span></span><span>
</span><span id="line-432"></span><span id="nameReason"><span class="annot"><span class="annottext">nameReason :: SrcLoc -&gt; NameReason -&gt; Doc
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#nameReason"><span class="hs-identifier hs-var hs-var">nameReason</span></a></span></span><span> </span><span id="local-6989586621684556643"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684556643"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#NameAppRes"><span class="hs-identifier hs-type">NameAppRes</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (QualName VName)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span id="local-6989586621684556642"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684556642"><span class="hs-identifier hs-var">apploc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-433"></span><span>  </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;result of application at&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Doc
</span><span class="hs-identifier hs-var">text</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SrcLoc -&gt; SrcLoc -&gt; [Char]
forall a b. (Located a, Located b) =&gt; a -&gt; b -&gt; [Char]
</span><a href="Language.Futhark.Core.html#locStrRel"><span class="hs-identifier hs-var">locStrRel</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684556643"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684556642"><span class="hs-identifier hs-var">apploc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-434"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#nameReason"><span class="hs-identifier hs-var">nameReason</span></a></span><span> </span><span id="local-6989586621684556641"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684556641"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#NameAppRes"><span class="hs-identifier hs-type">NameAppRes</span></a></span><span> </span><span id="local-6989586621684556640"><span class="annot"><span class="annottext">Maybe (QualName VName)
</span><a href="#local-6989586621684556640"><span class="hs-identifier hs-var">fname</span></a></span></span><span> </span><span id="local-6989586621684556639"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684556639"><span class="hs-identifier hs-var">apploc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-435"></span><span>  </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;result of applying&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><a href="Language.Futhark.Core.html#pquote"><span class="hs-identifier hs-var">pquote</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (QualName VName) -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">Maybe (QualName VName)
</span><a href="#local-6989586621684556640"><span class="hs-identifier hs-var">fname</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-436"></span><span>    </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><span class="hs-identifier hs-var">parens</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;at&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Doc
</span><span class="hs-identifier hs-var">text</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SrcLoc -&gt; SrcLoc -&gt; [Char]
forall a b. (Located a, Located b) =&gt; a -&gt; b -&gt; [Char]
</span><a href="Language.Futhark.Core.html#locStrRel"><span class="hs-identifier hs-var">locStrRel</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684556641"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684556639"><span class="hs-identifier hs-var">apploc</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-437"></span><span>
</span><span id="line-438"></span><span class="hs-comment">-- | The state is a set of constraints and a counter for generating</span><span>
</span><span id="line-439"></span><span class="hs-comment">-- type names.  This is distinct from the usual counter we use for</span><span>
</span><span id="line-440"></span><span class="hs-comment">-- generating unique names, as these will be user-visible.</span><span>
</span><span id="line-441"></span><span class="hs-keyword">data</span><span> </span><span id="TermTypeState"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeState"><span class="hs-identifier hs-var">TermTypeState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="TermTypeState"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeState"><span class="hs-identifier hs-var">TermTypeState</span></a></span></span><span>
</span><span id="line-442"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="stateConstraints"><span class="annot"><span class="annottext">TermTypeState -&gt; Constraints
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#stateConstraints"><span class="hs-identifier hs-var hs-var">stateConstraints</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Unify.html#Constraints"><span class="hs-identifier hs-type">Constraints</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-443"></span><span>    </span><span id="stateCounter"><span class="annot"><span class="annottext">TermTypeState -&gt; Int
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#stateCounter"><span class="hs-identifier hs-var hs-var">stateCounter</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span>
</span><span id="line-444"></span><span>    </span><span class="hs-comment">-- | Mapping function arguments encountered to</span><span>
</span><span id="line-445"></span><span>    </span><span class="hs-comment">-- the sizes they ended up generating (when</span><span>
</span><span id="line-446"></span><span>    </span><span class="hs-comment">-- they could not be substituted directly).</span><span>
</span><span id="line-447"></span><span>    </span><span class="hs-comment">-- This happens for function arguments that are</span><span>
</span><span id="line-448"></span><span>    </span><span class="hs-comment">-- not constants or names.</span><span>
</span><span id="line-449"></span><span>    </span><span id="stateDimTable"><span class="annot"><span class="annottext">TermTypeState -&gt; Map SizeSource VName
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#stateDimTable"><span class="hs-identifier hs-var hs-var">stateDimTable</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#SizeSource"><span class="hs-identifier hs-type">SizeSource</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-450"></span><span>    </span><span id="stateNames"><span class="annot"><span class="annottext">TermTypeState -&gt; Map VName NameReason
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#stateNames"><span class="hs-identifier hs-var hs-var">stateNames</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#NameReason"><span class="hs-identifier hs-type">NameReason</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-451"></span><span>    </span><span id="stateOccs"><span class="annot"><span class="annottext">TermTypeState -&gt; Occurrences
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#stateOccs"><span class="hs-identifier hs-var hs-var">stateOccs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Occurrences"><span class="hs-identifier hs-type">Occurrences</span></a></span><span>
</span><span id="line-452"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-453"></span><span>
</span><span id="line-454"></span><span class="hs-keyword">newtype</span><span> </span><span id="TermTypeM"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-var">TermTypeM</span></a></span></span><span> </span><span id="local-6989586621684557824"><span class="annot"><a href="#local-6989586621684557824"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-455"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="TermTypeM"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-var">TermTypeM</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ReaderT</span></span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermEnv"><span class="hs-identifier hs-type">TermEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeState"><span class="hs-identifier hs-type">TermTypeState</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Monad.html#TypeM"><span class="hs-identifier hs-type">TypeM</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621684557824"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-456"></span><span>  </span><span class="hs-keyword">deriving</span><span>
</span><span id="line-457"></span><span>    </span><span class="hs-special">(</span><span> </span><span id="local-6989586621684556617"><span id="local-6989586621684556622"><span id="local-6989586621684556628"><span class="annot"><span class="annottext">Applicative TermTypeM
Applicative TermTypeM
-&gt; (forall a b. TermTypeM a -&gt; (a -&gt; TermTypeM b) -&gt; TermTypeM b)
-&gt; (forall a b. TermTypeM a -&gt; TermTypeM b -&gt; TermTypeM b)
-&gt; (forall a. a -&gt; TermTypeM a)
-&gt; Monad TermTypeM
forall a. a -&gt; TermTypeM a
forall a b. TermTypeM a -&gt; TermTypeM b -&gt; TermTypeM b
forall a b. TermTypeM a -&gt; (a -&gt; TermTypeM b) -&gt; TermTypeM b
forall (m :: * -&gt; *).
Applicative m
-&gt; (forall a b. m a -&gt; (a -&gt; m b) -&gt; m b)
-&gt; (forall a b. m a -&gt; m b -&gt; m b)
-&gt; (forall a. a -&gt; m a)
-&gt; Monad m
return :: forall a. a -&gt; TermTypeM a
$creturn :: forall a. a -&gt; TermTypeM a
&gt;&gt; :: forall a b. TermTypeM a -&gt; TermTypeM b -&gt; TermTypeM b
$c&gt;&gt; :: forall a b. TermTypeM a -&gt; TermTypeM b -&gt; TermTypeM b
&gt;&gt;= :: forall a b. TermTypeM a -&gt; (a -&gt; TermTypeM b) -&gt; TermTypeM b
$c&gt;&gt;= :: forall a b. TermTypeM a -&gt; (a -&gt; TermTypeM b) -&gt; TermTypeM b
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Monad</span></span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-458"></span><span>      </span><span id="local-6989586621684556600"><span id="local-6989586621684556606"><span class="annot"><span class="annottext">(forall a b. (a -&gt; b) -&gt; TermTypeM a -&gt; TermTypeM b)
-&gt; (forall a b. a -&gt; TermTypeM b -&gt; TermTypeM a)
-&gt; Functor TermTypeM
forall a b. a -&gt; TermTypeM b -&gt; TermTypeM a
forall a b. (a -&gt; b) -&gt; TermTypeM a -&gt; TermTypeM b
forall (f :: * -&gt; *).
(forall a b. (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b. a -&gt; f b -&gt; f a) -&gt; Functor f
&lt;$ :: forall a b. a -&gt; TermTypeM b -&gt; TermTypeM a
$c&lt;$ :: forall a b. a -&gt; TermTypeM b -&gt; TermTypeM a
fmap :: forall a b. (a -&gt; b) -&gt; TermTypeM a -&gt; TermTypeM b
$cfmap :: forall a b. (a -&gt; b) -&gt; TermTypeM a -&gt; TermTypeM b
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Functor</span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-459"></span><span>      </span><span id="local-6989586621684556567"><span id="local-6989586621684556572"><span id="local-6989586621684556577"><span id="local-6989586621684556582"><span id="local-6989586621684556588"><span class="annot"><span class="annottext">Functor TermTypeM
Functor TermTypeM
-&gt; (forall a. a -&gt; TermTypeM a)
-&gt; (forall a b. TermTypeM (a -&gt; b) -&gt; TermTypeM a -&gt; TermTypeM b)
-&gt; (forall a b c.
    (a -&gt; b -&gt; c) -&gt; TermTypeM a -&gt; TermTypeM b -&gt; TermTypeM c)
-&gt; (forall a b. TermTypeM a -&gt; TermTypeM b -&gt; TermTypeM b)
-&gt; (forall a b. TermTypeM a -&gt; TermTypeM b -&gt; TermTypeM a)
-&gt; Applicative TermTypeM
forall a. a -&gt; TermTypeM a
forall a b. TermTypeM a -&gt; TermTypeM b -&gt; TermTypeM a
forall a b. TermTypeM a -&gt; TermTypeM b -&gt; TermTypeM b
forall a b. TermTypeM (a -&gt; b) -&gt; TermTypeM a -&gt; TermTypeM b
forall a b c.
(a -&gt; b -&gt; c) -&gt; TermTypeM a -&gt; TermTypeM b -&gt; TermTypeM c
forall (f :: * -&gt; *).
Functor f
-&gt; (forall a. a -&gt; f a)
-&gt; (forall a b. f (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b c. (a -&gt; b -&gt; c) -&gt; f a -&gt; f b -&gt; f c)
-&gt; (forall a b. f a -&gt; f b -&gt; f b)
-&gt; (forall a b. f a -&gt; f b -&gt; f a)
-&gt; Applicative f
&lt;* :: forall a b. TermTypeM a -&gt; TermTypeM b -&gt; TermTypeM a
$c&lt;* :: forall a b. TermTypeM a -&gt; TermTypeM b -&gt; TermTypeM a
*&gt; :: forall a b. TermTypeM a -&gt; TermTypeM b -&gt; TermTypeM b
$c*&gt; :: forall a b. TermTypeM a -&gt; TermTypeM b -&gt; TermTypeM b
liftA2 :: forall a b c.
(a -&gt; b -&gt; c) -&gt; TermTypeM a -&gt; TermTypeM b -&gt; TermTypeM c
$cliftA2 :: forall a b c.
(a -&gt; b -&gt; c) -&gt; TermTypeM a -&gt; TermTypeM b -&gt; TermTypeM c
&lt;*&gt; :: forall a b. TermTypeM (a -&gt; b) -&gt; TermTypeM a -&gt; TermTypeM b
$c&lt;*&gt; :: forall a b. TermTypeM (a -&gt; b) -&gt; TermTypeM a -&gt; TermTypeM b
pure :: forall a. a -&gt; TermTypeM a
$cpure :: forall a. a -&gt; TermTypeM a
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Applicative</span></span></span></span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-460"></span><span>      </span><span id="local-6989586621684556537"><span id="local-6989586621684556542"><span id="local-6989586621684556548"><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermEnv"><span class="hs-identifier hs-type">TermEnv</span></a></span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-461"></span><span>      </span><span id="local-6989586621684556515"><span id="local-6989586621684556520"><span id="local-6989586621684556526"><span class="annot"><span class="hs-identifier hs-type">MonadState</span></span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeState"><span class="hs-identifier hs-type">TermTypeState</span></a></span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-462"></span><span>      </span><span id="local-6989586621684556497"><span id="local-6989586621684556503"><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Monad.html#TypeError"><span class="hs-identifier hs-type">TypeError</span></a></span></span></span><span>
</span><span id="line-463"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-464"></span><span>
</span><span id="line-465"></span><span id="local-6989586621684557829"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#liftTypeM"><span class="hs-identifier hs-type">liftTypeM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Monad.html#TypeM"><span class="hs-identifier hs-type">TypeM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684557829"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684557829"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-466"></span><span id="liftTypeM"><span class="annot"><span class="annottext">liftTypeM :: forall a. TypeM a -&gt; TermTypeM a
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#liftTypeM"><span class="hs-identifier hs-var hs-var">liftTypeM</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ReaderT TermEnv (StateT TermTypeState TypeM) a -&gt; TermTypeM a
forall a.
ReaderT TermEnv (StateT TermTypeState TypeM) a -&gt; TermTypeM a
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-var">TermTypeM</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT TermEnv (StateT TermTypeState TypeM) a -&gt; TermTypeM a)
-&gt; (TypeM a -&gt; ReaderT TermEnv (StateT TermTypeState TypeM) a)
-&gt; TypeM a
-&gt; TermTypeM a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">StateT TermTypeState TypeM a
-&gt; ReaderT TermEnv (StateT TermTypeState TypeM) a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(StateT TermTypeState TypeM a
 -&gt; ReaderT TermEnv (StateT TermTypeState TypeM) a)
-&gt; (TypeM a -&gt; StateT TermTypeState TypeM a)
-&gt; TypeM a
-&gt; ReaderT TermEnv (StateT TermTypeState TypeM) a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TypeM a -&gt; StateT TermTypeState TypeM a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span>
</span><span id="line-467"></span><span>
</span><span id="line-468"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#incCounter"><span class="hs-identifier hs-type">incCounter</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-469"></span><span id="incCounter"><span class="annot"><span class="annottext">incCounter :: TermTypeM Int
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#incCounter"><span class="hs-identifier hs-var hs-var">incCounter</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-470"></span><span>  </span><span id="local-6989586621684556478"><span class="annot"><span class="annottext">TermTypeState
</span><a href="#local-6989586621684556478"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TermTypeM TermTypeState
forall s (m :: * -&gt; *). MonadState s m =&gt; m s
</span><span class="hs-identifier hs-var">get</span></span><span>
</span><span id="line-471"></span><span>  </span><span class="annot"><span class="annottext">TermTypeState -&gt; TermTypeM ()
forall s (m :: * -&gt; *). MonadState s m =&gt; s -&gt; m ()
</span><span class="hs-identifier hs-var">put</span></span><span> </span><span class="annot"><span class="annottext">TermTypeState
</span><a href="#local-6989586621684556478"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">stateCounter :: Int
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#stateCounter"><span class="hs-identifier hs-var">stateCounter</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TermTypeState -&gt; Int
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#stateCounter"><span class="hs-identifier hs-var hs-var">stateCounter</span></a></span><span> </span><span class="annot"><span class="annottext">TermTypeState
</span><a href="#local-6989586621684556478"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">}</span><span>
</span><span id="line-472"></span><span>  </span><span class="annot"><span class="annottext">Int -&gt; TermTypeM Int
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; TermTypeM Int) -&gt; Int -&gt; TermTypeM Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TermTypeState -&gt; Int
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#stateCounter"><span class="hs-identifier hs-var hs-var">stateCounter</span></a></span><span> </span><span class="annot"><span class="annottext">TermTypeState
</span><a href="#local-6989586621684556478"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-473"></span><span>
</span><span id="line-474"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#constrain"><span class="hs-identifier hs-type">constrain</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Unify.html#Constraint"><span class="hs-identifier hs-type">Constraint</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-475"></span><span id="constrain"><span class="annot"><span class="annottext">constrain :: VName -&gt; Constraint -&gt; TermTypeM ()
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#constrain"><span class="hs-identifier hs-var hs-var">constrain</span></a></span></span><span> </span><span id="local-6989586621684556474"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684556474"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621684556473"><span class="annot"><span class="annottext">Constraint
</span><a href="#local-6989586621684556473"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-476"></span><span>  </span><span id="local-6989586621684556472"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684556472"><span class="hs-identifier hs-var">lvl</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TermTypeM Int
forall (m :: * -&gt; *). MonadUnify m =&gt; m Int
</span><a href="Language.Futhark.TypeChecker.Unify.html#curLevel"><span class="hs-identifier hs-var">curLevel</span></a></span><span>
</span><span id="line-477"></span><span>  </span><span class="annot"><span class="annottext">(Constraints -&gt; Constraints) -&gt; TermTypeM ()
forall (m :: * -&gt; *).
MonadUnify m =&gt;
(Constraints -&gt; Constraints) -&gt; m ()
</span><a href="Language.Futhark.TypeChecker.Unify.html#modifyConstraints"><span class="hs-identifier hs-var">modifyConstraints</span></a></span><span> </span><span class="annot"><span class="annottext">((Constraints -&gt; Constraints) -&gt; TermTypeM ())
-&gt; (Constraints -&gt; Constraints) -&gt; TermTypeM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; (Int, Constraint) -&gt; Constraints -&gt; Constraints
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684556474"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684556472"><span class="hs-identifier hs-var">lvl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Constraint
</span><a href="#local-6989586621684556473"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-478"></span><span>
</span><span id="line-479"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621684556463"><span class="annot"><a href="Language.Futhark.TypeChecker.Unify.html#MonadUnify"><span class="hs-identifier hs-type">MonadUnify</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-480"></span><span>  </span><span id="local-6989586621684556455"><span class="annot"><span class="annottext">getConstraints :: TermTypeM Constraints
</span><a href="Language.Futhark.TypeChecker.Unify.html#getConstraints"><span class="hs-identifier hs-var hs-var hs-var hs-var">getConstraints</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TermTypeState -&gt; Constraints) -&gt; TermTypeM Constraints
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">TermTypeState -&gt; Constraints
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#stateConstraints"><span class="hs-identifier hs-var hs-var">stateConstraints</span></a></span><span>
</span><span id="line-481"></span><span>  </span><span id="local-6989586621684556452"><span class="annot"><span class="annottext">putConstraints :: Constraints -&gt; TermTypeM ()
</span><a href="Language.Futhark.TypeChecker.Unify.html#putConstraints"><span class="hs-identifier hs-var hs-var hs-var hs-var">putConstraints</span></a></span></span><span> </span><span id="local-6989586621684556450"><span class="annot"><span class="annottext">Constraints
</span><a href="#local-6989586621684556450"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TermTypeState -&gt; TermTypeState) -&gt; TermTypeM ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((TermTypeState -&gt; TermTypeState) -&gt; TermTypeM ())
-&gt; (TermTypeState -&gt; TermTypeState) -&gt; TermTypeM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684556448"><span class="annot"><span class="annottext">TermTypeState
</span><a href="#local-6989586621684556448"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TermTypeState
</span><a href="#local-6989586621684556448"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">stateConstraints :: Constraints
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#stateConstraints"><span class="hs-identifier hs-var">stateConstraints</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Constraints
</span><a href="#local-6989586621684556450"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-482"></span><span>
</span><span id="line-483"></span><span>  </span><span id="local-6989586621684556440"><span class="annot"><span class="annottext">newTypeVar :: forall als dim.
Monoid als =&gt;
SrcLoc -&gt; Name -&gt; TermTypeM (TypeBase dim als)
</span><a href="Language.Futhark.TypeChecker.Unify.html#newTypeVar"><span class="hs-identifier hs-var hs-var hs-var hs-var">newTypeVar</span></a></span></span><span> </span><span id="local-6989586621684556438"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684556438"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span id="local-6989586621684556437"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684556437"><span class="hs-identifier hs-var">desc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-484"></span><span>    </span><span id="local-6989586621684556436"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684556436"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TermTypeM Int
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#incCounter"><span class="hs-identifier hs-var">incCounter</span></a></span><span>
</span><span id="line-485"></span><span>    </span><span id="local-6989586621684556435"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684556435"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; TermTypeM VName
forall (m :: * -&gt; *). MonadTypeChecker m =&gt; Name -&gt; m VName
</span><a href="Language.Futhark.TypeChecker.Monad.html#newID"><span class="hs-identifier hs-var">newID</span></a></span><span> </span><span class="annot"><span class="annottext">(Name -&gt; TermTypeM VName) -&gt; Name -&gt; TermTypeM VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Int -&gt; Name
</span><a href="Language.Futhark.TypeChecker.Monad.html#mkTypeVarName"><span class="hs-identifier hs-var">mkTypeVarName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684556437"><span class="hs-identifier hs-var">desc</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684556436"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-486"></span><span>    </span><span class="annot"><span class="annottext">VName -&gt; Constraint -&gt; TermTypeM ()
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#constrain"><span class="hs-identifier hs-var">constrain</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684556435"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">(Constraint -&gt; TermTypeM ()) -&gt; Constraint -&gt; TermTypeM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Liftedness -&gt; Usage -&gt; Constraint
</span><a href="Language.Futhark.TypeChecker.Unify.html#NoConstraint"><span class="hs-identifier hs-var">NoConstraint</span></a></span><span> </span><span class="annot"><span class="annottext">Liftedness
</span><a href="Language.Futhark.Syntax.html#Lifted"><span class="hs-identifier hs-var">Lifted</span></a></span><span> </span><span class="annot"><span class="annottext">(Usage -&gt; Constraint) -&gt; Usage -&gt; Constraint
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc -&gt; Usage
</span><a href="Language.Futhark.TypeChecker.Unify.html#mkUsage%27"><span class="hs-identifier hs-var">mkUsage'</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684556438"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-487"></span><span>    </span><span class="annot"><span class="annottext">TypeBase dim als -&gt; TermTypeM (TypeBase dim als)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(TypeBase dim als -&gt; TermTypeM (TypeBase dim als))
-&gt; TypeBase dim als -&gt; TermTypeM (TypeBase dim als)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ScalarTypeBase dim als -&gt; TypeBase dim als
forall dim as. ScalarTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-var">Scalar</span></a></span><span> </span><span class="annot"><span class="annottext">(ScalarTypeBase dim als -&gt; TypeBase dim als)
-&gt; ScalarTypeBase dim als -&gt; TypeBase dim als
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">als
-&gt; Uniqueness
-&gt; TypeName
-&gt; [TypeArg dim]
-&gt; ScalarTypeBase dim als
forall dim as.
as
-&gt; Uniqueness -&gt; TypeName -&gt; [TypeArg dim] -&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#TypeVar"><span class="hs-identifier hs-var">TypeVar</span></a></span><span> </span><span class="annot"><span class="annottext">als
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="Language.Futhark.Core.html#Nonunique"><span class="hs-identifier hs-var">Nonunique</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; TypeName
</span><a href="Language.Futhark.Prop.html#typeName"><span class="hs-identifier hs-var">typeName</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684556435"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-488"></span><span>
</span><span id="line-489"></span><span>  </span><span id="local-6989586621684556424"><span class="annot"><span class="annottext">curLevel :: TermTypeM Int
</span><a href="#local-6989586621684556424"><span class="hs-identifier hs-var hs-var hs-var hs-var">curLevel</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TermEnv -&gt; Int) -&gt; TermTypeM Int
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">TermEnv -&gt; Int
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#termLevel"><span class="hs-identifier hs-var hs-var">termLevel</span></a></span><span>
</span><span id="line-490"></span><span>
</span><span id="line-491"></span><span>  </span><span id="local-6989586621684556418"><span class="annot"><span class="annottext">newDimVar :: SrcLoc -&gt; Rigidity -&gt; Name -&gt; TermTypeM VName
</span><a href="Language.Futhark.TypeChecker.Unify.html#newDimVar"><span class="hs-identifier hs-var hs-var hs-var hs-var">newDimVar</span></a></span></span><span> </span><span id="local-6989586621684556416"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684556416"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span id="local-6989586621684556415"><span class="annot"><span class="annottext">Rigidity
</span><a href="#local-6989586621684556415"><span class="hs-identifier hs-var">rigidity</span></a></span></span><span> </span><span id="local-6989586621684556414"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684556414"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-492"></span><span>    </span><span id="local-6989586621684556413"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684556413"><span class="hs-identifier hs-var">dim</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; TermTypeM VName
forall (m :: * -&gt; *). MonadTypeChecker m =&gt; Name -&gt; m VName
</span><a href="Language.Futhark.TypeChecker.Monad.html#newTypeName"><span class="hs-identifier hs-var">newTypeName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684556414"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-493"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Rigidity
</span><a href="#local-6989586621684556415"><span class="hs-identifier hs-var">rigidity</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-494"></span><span>      </span><span class="annot"><a href="Language.Futhark.TypeChecker.Unify.html#Rigid"><span class="hs-identifier hs-type">Rigid</span></a></span><span> </span><span id="local-6989586621684556410"><span class="annot"><span class="annottext">RigidSource
</span><a href="#local-6989586621684556410"><span class="hs-identifier hs-var">rsrc</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Constraint -&gt; TermTypeM ()
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#constrain"><span class="hs-identifier hs-var">constrain</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684556413"><span class="hs-identifier hs-var">dim</span></a></span><span> </span><span class="annot"><span class="annottext">(Constraint -&gt; TermTypeM ()) -&gt; Constraint -&gt; TermTypeM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc -&gt; RigidSource -&gt; Constraint
</span><a href="Language.Futhark.TypeChecker.Unify.html#UnknowableSize"><span class="hs-identifier hs-var">UnknowableSize</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684556416"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">RigidSource
</span><a href="#local-6989586621684556410"><span class="hs-identifier hs-var">rsrc</span></a></span><span>
</span><span id="line-495"></span><span>      </span><span class="annot"><span class="annottext">Rigidity
</span><a href="Language.Futhark.TypeChecker.Unify.html#Nonrigid"><span class="hs-identifier hs-var">Nonrigid</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Constraint -&gt; TermTypeM ()
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#constrain"><span class="hs-identifier hs-var">constrain</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684556413"><span class="hs-identifier hs-var">dim</span></a></span><span> </span><span class="annot"><span class="annottext">(Constraint -&gt; TermTypeM ()) -&gt; Constraint -&gt; TermTypeM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (DimDecl VName) -&gt; Usage -&gt; Constraint
</span><a href="Language.Futhark.TypeChecker.Unify.html#Size"><span class="hs-identifier hs-var">Size</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (DimDecl VName)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">(Usage -&gt; Constraint) -&gt; Usage -&gt; Constraint
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc -&gt; Usage
</span><a href="Language.Futhark.TypeChecker.Unify.html#mkUsage%27"><span class="hs-identifier hs-var">mkUsage'</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684556416"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-496"></span><span>    </span><span class="annot"><span class="annottext">VName -&gt; TermTypeM VName
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684556413"><span class="hs-identifier hs-var">dim</span></a></span><span>
</span><span id="line-497"></span><span>
</span><span id="line-498"></span><span>  </span><span id="local-6989586621684556392"><span class="annot"><span class="annottext">unifyError :: forall loc a.
Located loc =&gt;
loc -&gt; Notes -&gt; BreadCrumbs -&gt; Doc -&gt; TermTypeM a
</span><a href="Language.Futhark.TypeChecker.Unify.html#unifyError"><span class="hs-identifier hs-var hs-var hs-var hs-var">unifyError</span></a></span></span><span> </span><span id="local-6989586621684556390"><span class="annot"><span class="annottext">loc
</span><a href="#local-6989586621684556390"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span id="local-6989586621684556389"><span class="annot"><span class="annottext">Notes
</span><a href="#local-6989586621684556389"><span class="hs-identifier hs-var">notes</span></a></span></span><span> </span><span id="local-6989586621684556388"><span class="annot"><span class="annottext">BreadCrumbs
</span><a href="#local-6989586621684556388"><span class="hs-identifier hs-var">bcs</span></a></span></span><span> </span><span id="local-6989586621684556387"><span class="annot"><span class="annottext">Doc
</span><a href="#local-6989586621684556387"><span class="hs-identifier hs-var">doc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-499"></span><span>    </span><span id="local-6989586621684556386"><span class="annot"><span class="annottext">Maybe Checking
</span><a href="#local-6989586621684556386"><span class="hs-identifier hs-var">checking</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TermEnv -&gt; Maybe Checking) -&gt; TermTypeM (Maybe Checking)
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">TermEnv -&gt; Maybe Checking
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#termChecking"><span class="hs-identifier hs-var hs-var">termChecking</span></a></span><span>
</span><span id="line-500"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Checking
</span><a href="#local-6989586621684556386"><span class="hs-identifier hs-var">checking</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-501"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684556385"><span class="annot"><span class="annottext">Checking
</span><a href="#local-6989586621684556385"><span class="hs-identifier hs-var">checking'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-502"></span><span>        </span><span class="annot"><span class="annottext">TypeError -&gt; TermTypeM a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(TypeError -&gt; TermTypeM a) -&gt; TypeError -&gt; TermTypeM a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-503"></span><span>          </span><span class="annot"><span class="annottext">SrcLoc -&gt; Notes -&gt; Doc -&gt; TypeError
</span><a href="Language.Futhark.TypeChecker.Monad.html#TypeError"><span class="hs-identifier hs-var">TypeError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">loc -&gt; SrcLoc
forall a. Located a =&gt; a -&gt; SrcLoc
</span><span class="hs-identifier hs-var">srclocOf</span></span><span> </span><span class="annot"><span class="annottext">loc
</span><a href="#local-6989586621684556390"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Notes
</span><a href="#local-6989586621684556389"><span class="hs-identifier hs-var">notes</span></a></span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; TypeError) -&gt; Doc -&gt; TypeError
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-504"></span><span>            </span><span class="annot"><span class="annottext">Checking -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">Checking
</span><a href="#local-6989586621684556385"><span class="hs-identifier hs-var">checking'</span></a></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-identifier hs-var">line</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><a href="#local-6989586621684556387"><span class="hs-identifier hs-var">doc</span></a></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">BreadCrumbs -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">BreadCrumbs
</span><a href="#local-6989586621684556388"><span class="hs-identifier hs-var">bcs</span></a></span><span>
</span><span id="line-505"></span><span>      </span><span class="annot"><span class="annottext">Maybe Checking
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-506"></span><span>        </span><span class="annot"><span class="annottext">TypeError -&gt; TermTypeM a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(TypeError -&gt; TermTypeM a) -&gt; TypeError -&gt; TermTypeM a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc -&gt; Notes -&gt; Doc -&gt; TypeError
</span><a href="Language.Futhark.TypeChecker.Monad.html#TypeError"><span class="hs-identifier hs-var">TypeError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">loc -&gt; SrcLoc
forall a. Located a =&gt; a -&gt; SrcLoc
</span><span class="hs-identifier hs-var">srclocOf</span></span><span> </span><span class="annot"><span class="annottext">loc
</span><a href="#local-6989586621684556390"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Notes
</span><a href="#local-6989586621684556389"><span class="hs-identifier hs-var">notes</span></a></span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; TypeError) -&gt; Doc -&gt; TypeError
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><a href="#local-6989586621684556387"><span class="hs-identifier hs-var">doc</span></a></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">BreadCrumbs -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">BreadCrumbs
</span><a href="#local-6989586621684556388"><span class="hs-identifier hs-var">bcs</span></a></span><span>
</span><span id="line-507"></span><span>
</span><span id="line-508"></span><span>  </span><span id="local-6989586621684556364"><span class="annot"><span class="annottext">matchError :: forall loc a.
Located loc =&gt;
loc
-&gt; Notes -&gt; BreadCrumbs -&gt; StructType -&gt; StructType -&gt; TermTypeM a
</span><a href="Language.Futhark.TypeChecker.Unify.html#matchError"><span class="hs-identifier hs-var hs-var hs-var hs-var">matchError</span></a></span></span><span> </span><span id="local-6989586621684556362"><span class="annot"><span class="annottext">loc
</span><a href="#local-6989586621684556362"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span id="local-6989586621684556361"><span class="annot"><span class="annottext">Notes
</span><a href="#local-6989586621684556361"><span class="hs-identifier hs-var">notes</span></a></span></span><span> </span><span id="local-6989586621684556360"><span class="annot"><span class="annottext">BreadCrumbs
</span><a href="#local-6989586621684556360"><span class="hs-identifier hs-var">bcs</span></a></span></span><span> </span><span id="local-6989586621684556359"><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684556359"><span class="hs-identifier hs-var">t1</span></a></span></span><span> </span><span id="local-6989586621684556358"><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684556358"><span class="hs-identifier hs-var">t2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-509"></span><span>    </span><span id="local-6989586621684556357"><span class="annot"><span class="annottext">Maybe Checking
</span><a href="#local-6989586621684556357"><span class="hs-identifier hs-var">checking</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TermEnv -&gt; Maybe Checking) -&gt; TermTypeM (Maybe Checking)
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">TermEnv -&gt; Maybe Checking
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#termChecking"><span class="hs-identifier hs-var hs-var">termChecking</span></a></span><span>
</span><span id="line-510"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Checking
</span><a href="#local-6989586621684556357"><span class="hs-identifier hs-var">checking</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-511"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684556356"><span class="annot"><span class="annottext">Checking
</span><a href="#local-6989586621684556356"><span class="hs-identifier hs-var">checking'</span></a></span></span><span>
</span><span id="line-512"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">BreadCrumbs -&gt; Bool
</span><a href="Language.Futhark.TypeChecker.Unify.html#hasNoBreadCrumbs"><span class="hs-identifier hs-var">hasNoBreadCrumbs</span></a></span><span> </span><span class="annot"><span class="annottext">BreadCrumbs
</span><a href="#local-6989586621684556360"><span class="hs-identifier hs-var">bcs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-513"></span><span>          </span><span class="annot"><span class="annottext">TypeError -&gt; TermTypeM a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(TypeError -&gt; TermTypeM a) -&gt; TypeError -&gt; TermTypeM a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-514"></span><span>            </span><span class="annot"><span class="annottext">SrcLoc -&gt; Notes -&gt; Doc -&gt; TypeError
</span><a href="Language.Futhark.TypeChecker.Monad.html#TypeError"><span class="hs-identifier hs-var">TypeError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">loc -&gt; SrcLoc
forall a. Located a =&gt; a -&gt; SrcLoc
</span><span class="hs-identifier hs-var">srclocOf</span></span><span> </span><span class="annot"><span class="annottext">loc
</span><a href="#local-6989586621684556362"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Notes
</span><a href="#local-6989586621684556361"><span class="hs-identifier hs-var">notes</span></a></span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; TypeError) -&gt; Doc -&gt; TypeError
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-515"></span><span>              </span><span class="annot"><span class="annottext">Checking -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">Checking
</span><a href="#local-6989586621684556356"><span class="hs-identifier hs-var">checking'</span></a></span><span>
</span><span id="line-516"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-517"></span><span>          </span><span class="annot"><span class="annottext">TypeError -&gt; TermTypeM a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(TypeError -&gt; TermTypeM a) -&gt; TypeError -&gt; TermTypeM a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-518"></span><span>            </span><span class="annot"><span class="annottext">SrcLoc -&gt; Notes -&gt; Doc -&gt; TypeError
</span><a href="Language.Futhark.TypeChecker.Monad.html#TypeError"><span class="hs-identifier hs-var">TypeError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">loc -&gt; SrcLoc
forall a. Located a =&gt; a -&gt; SrcLoc
</span><span class="hs-identifier hs-var">srclocOf</span></span><span> </span><span class="annot"><span class="annottext">loc
</span><a href="#local-6989586621684556362"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Notes
</span><a href="#local-6989586621684556361"><span class="hs-identifier hs-var">notes</span></a></span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; TypeError) -&gt; Doc -&gt; TypeError
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-519"></span><span>              </span><span class="annot"><span class="annottext">Checking -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">Checking
</span><a href="#local-6989586621684556356"><span class="hs-identifier hs-var">checking'</span></a></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-identifier hs-var">line</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><a href="#local-6989586621684556354"><span class="hs-identifier hs-var">doc</span></a></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">BreadCrumbs -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">BreadCrumbs
</span><a href="#local-6989586621684556360"><span class="hs-identifier hs-var">bcs</span></a></span><span>
</span><span id="line-520"></span><span>      </span><span class="annot"><span class="annottext">Maybe Checking
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-521"></span><span>        </span><span class="annot"><span class="annottext">TypeError -&gt; TermTypeM a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(TypeError -&gt; TermTypeM a) -&gt; TypeError -&gt; TermTypeM a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc -&gt; Notes -&gt; Doc -&gt; TypeError
</span><a href="Language.Futhark.TypeChecker.Monad.html#TypeError"><span class="hs-identifier hs-var">TypeError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">loc -&gt; SrcLoc
forall a. Located a =&gt; a -&gt; SrcLoc
</span><span class="hs-identifier hs-var">srclocOf</span></span><span> </span><span class="annot"><span class="annottext">loc
</span><a href="#local-6989586621684556362"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Notes
</span><a href="#local-6989586621684556361"><span class="hs-identifier hs-var">notes</span></a></span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; TypeError) -&gt; Doc -&gt; TypeError
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><a href="#local-6989586621684556354"><span class="hs-identifier hs-var">doc</span></a></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">BreadCrumbs -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">BreadCrumbs
</span><a href="#local-6989586621684556360"><span class="hs-identifier hs-var">bcs</span></a></span><span>
</span><span id="line-522"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-523"></span><span>      </span><span id="local-6989586621684556354"><span class="annot"><span class="annottext">doc :: Doc
</span><a href="#local-6989586621684556354"><span class="hs-identifier hs-var hs-var">doc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-524"></span><span>        </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Types&quot;</span></span><span>
</span><span id="line-525"></span><span>          </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Doc -&gt; Doc
</span><span class="hs-identifier hs-var">indent</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StructType -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684556359"><span class="hs-identifier hs-var">t1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-526"></span><span>          </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;and&quot;</span></span><span>
</span><span id="line-527"></span><span>          </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Doc -&gt; Doc
</span><span class="hs-identifier hs-var">indent</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StructType -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684556358"><span class="hs-identifier hs-var">t2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-528"></span><span>          </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;do not match.&quot;</span></span><span>
</span><span id="line-529"></span><span>
</span><span id="line-530"></span><span class="hs-comment">-- | Instantiate a type scheme with fresh type variables for its type</span><span>
</span><span id="line-531"></span><span class="hs-comment">-- parameters. Returns the names of the fresh type variables, the</span><span>
</span><span id="line-532"></span><span class="hs-comment">-- instance list, and the instantiated type.</span><span>
</span><span id="line-533"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#instantiateTypeScheme"><span class="hs-identifier hs-type">instantiateTypeScheme</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-534"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">SrcLoc</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-535"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.html#TypeParam"><span class="hs-identifier hs-type">TypeParam</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-536"></span><span>  </span><span class="annot"><a href="Language.Futhark.Syntax.html#PatType"><span class="hs-identifier hs-type">PatType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-537"></span><span>  </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#PatType"><span class="hs-identifier hs-type">PatType</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-538"></span><span id="instantiateTypeScheme"><span class="annot"><span class="annottext">instantiateTypeScheme :: SrcLoc -&gt; [TypeParam] -&gt; PatType -&gt; TermTypeM ([VName], PatType)
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#instantiateTypeScheme"><span class="hs-identifier hs-var hs-var">instantiateTypeScheme</span></a></span></span><span> </span><span id="local-6989586621684556345"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684556345"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span id="local-6989586621684556344"><span class="annot"><span class="annottext">[TypeParam]
</span><a href="#local-6989586621684556344"><span class="hs-identifier hs-var">tparams</span></a></span></span><span> </span><span id="local-6989586621684556343"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684556343"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-539"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684556342"><span class="annot"><span class="annottext">tnames :: [VName]
</span><a href="#local-6989586621684556342"><span class="hs-identifier hs-var hs-var">tnames</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TypeParam -&gt; VName) -&gt; [TypeParam] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TypeParam -&gt; VName
forall vn. TypeParamBase vn -&gt; vn
</span><a href="Language.Futhark.Syntax.html#typeParamName"><span class="hs-identifier hs-var">typeParamName</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeParam]
</span><a href="#local-6989586621684556344"><span class="hs-identifier hs-var">tparams</span></a></span><span>
</span><span id="line-540"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684556340"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684556340"><span class="hs-identifier hs-var">tparam_names</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684556339"><span class="annot"><span class="annottext">[Subst (RetTypeBase (DimDecl VName) ())]
</span><a href="#local-6989586621684556339"><span class="hs-identifier hs-var">tparam_substs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(VName, Subst (RetTypeBase (DimDecl VName) ()))]
-&gt; ([VName], [Subst (RetTypeBase (DimDecl VName) ())])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(VName, Subst (RetTypeBase (DimDecl VName) ()))]
 -&gt; ([VName], [Subst (RetTypeBase (DimDecl VName) ())]))
-&gt; TermTypeM [(VName, Subst (RetTypeBase (DimDecl VName) ()))]
-&gt; TermTypeM ([VName], [Subst (RetTypeBase (DimDecl VName) ())])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(TypeParam
 -&gt; TermTypeM (VName, Subst (RetTypeBase (DimDecl VName) ())))
-&gt; [TypeParam]
-&gt; TermTypeM [(VName, Subst (RetTypeBase (DimDecl VName) ()))]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SrcLoc
-&gt; TypeParam
-&gt; TermTypeM (VName, Subst (RetTypeBase (DimDecl VName) ()))
forall as dim.
Monoid as =&gt;
SrcLoc
-&gt; TypeParam -&gt; TermTypeM (VName, Subst (RetTypeBase dim as))
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#instantiateTypeParam"><span class="hs-identifier hs-var">instantiateTypeParam</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684556345"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TypeParam]
</span><a href="#local-6989586621684556344"><span class="hs-identifier hs-var">tparams</span></a></span><span>
</span><span id="line-541"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684556334"><span class="annot"><span class="annottext">substs :: Map VName (Subst (RetTypeBase (DimDecl VName) ()))
</span><a href="#local-6989586621684556334"><span class="hs-identifier hs-var hs-var">substs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VName, Subst (RetTypeBase (DimDecl VName) ()))]
-&gt; Map VName (Subst (RetTypeBase (DimDecl VName) ()))
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="annot"><span class="annottext">([(VName, Subst (RetTypeBase (DimDecl VName) ()))]
 -&gt; Map VName (Subst (RetTypeBase (DimDecl VName) ())))
-&gt; [(VName, Subst (RetTypeBase (DimDecl VName) ()))]
-&gt; Map VName (Subst (RetTypeBase (DimDecl VName) ()))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName]
-&gt; [Subst (RetTypeBase (DimDecl VName) ())]
-&gt; [(VName, Subst (RetTypeBase (DimDecl VName) ()))]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684556342"><span class="hs-identifier hs-var">tnames</span></a></span><span> </span><span class="annot"><span class="annottext">[Subst (RetTypeBase (DimDecl VName) ())]
</span><a href="#local-6989586621684556339"><span class="hs-identifier hs-var">tparam_substs</span></a></span><span>
</span><span id="line-542"></span><span>      </span><span id="local-6989586621684556330"><span class="annot"><span class="annottext">t' :: PatType
</span><a href="#local-6989586621684556330"><span class="hs-identifier hs-var hs-var">t'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeSubs -&gt; PatType -&gt; PatType
forall a. Substitutable a =&gt; TypeSubs -&gt; a -&gt; a
</span><a href="Language.Futhark.TypeChecker.Types.html#applySubst"><span class="hs-identifier hs-var">applySubst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
-&gt; Map VName (Subst (RetTypeBase (DimDecl VName) ()))
-&gt; Maybe (Subst (RetTypeBase (DimDecl VName) ()))
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-operator hs-var">`M.lookup`</span></span><span> </span><span class="annot"><span class="annottext">Map VName (Subst (RetTypeBase (DimDecl VName) ()))
</span><a href="#local-6989586621684556334"><span class="hs-identifier hs-var">substs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684556343"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-543"></span><span>  </span><span class="annot"><span class="annottext">([VName], PatType) -&gt; TermTypeM ([VName], PatType)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684556340"><span class="hs-identifier hs-var">tparam_names</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684556330"><span class="hs-identifier hs-var">t'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-544"></span><span>
</span><span id="line-545"></span><span class="hs-comment">-- | Create a new type name and insert it (unconstrained) in the</span><span>
</span><span id="line-546"></span><span class="hs-comment">-- substitution map.</span><span>
</span><span id="line-547"></span><span id="local-6989586621684557776"><span id="local-6989586621684557777"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#instantiateTypeParam"><span class="hs-identifier hs-type">instantiateTypeParam</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-548"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Monoid</span></span><span> </span><span class="annot"><a href="#local-6989586621684557777"><span class="hs-keyword hs-type">as</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-549"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">SrcLoc</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-550"></span><span>  </span><span class="annot"><a href="Language.Futhark.html#TypeParam"><span class="hs-identifier hs-type">TypeParam</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-551"></span><span>  </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#RetTypeBase"><span class="hs-identifier hs-type">RetTypeBase</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684557776"><span class="hs-identifier hs-type">dim</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684557777"><span class="hs-keyword hs-type">as</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-552"></span><span id="instantiateTypeParam"><span class="annot"><span class="annottext">instantiateTypeParam :: forall as dim.
Monoid as =&gt;
SrcLoc
-&gt; TypeParam -&gt; TermTypeM (VName, Subst (RetTypeBase dim as))
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#instantiateTypeParam"><span class="hs-identifier hs-var hs-var">instantiateTypeParam</span></a></span></span><span> </span><span id="local-6989586621684556319"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684556319"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span id="local-6989586621684556318"><span class="annot"><span class="annottext">TypeParam
</span><a href="#local-6989586621684556318"><span class="hs-identifier hs-var">tparam</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-553"></span><span>  </span><span id="local-6989586621684556317"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684556317"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TermTypeM Int
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#incCounter"><span class="hs-identifier hs-var">incCounter</span></a></span><span>
</span><span id="line-554"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684556316"><span class="annot"><span class="annottext">name :: Name
</span><a href="#local-6989586621684556316"><span class="hs-identifier hs-var hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Name
</span><a href="Language.Futhark.Core.html#nameFromString"><span class="hs-identifier hs-var">nameFromString</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Char -&gt; Bool) -&gt; ShowS
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">takeWhile</span></span><span> </span><span class="annot"><span class="annottext">Char -&gt; Bool
</span><span class="hs-identifier hs-var">isAscii</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; [Char]
</span><a href="Language.Futhark.Core.html#baseString"><span class="hs-identifier hs-var">baseString</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeParam -&gt; VName
forall vn. TypeParamBase vn -&gt; vn
</span><a href="Language.Futhark.Syntax.html#typeParamName"><span class="hs-identifier hs-var">typeParamName</span></a></span><span> </span><span class="annot"><span class="annottext">TypeParam
</span><a href="#local-6989586621684556318"><span class="hs-identifier hs-var">tparam</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-555"></span><span>  </span><span id="local-6989586621684556312"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684556312"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; TermTypeM VName
forall (m :: * -&gt; *). MonadTypeChecker m =&gt; Name -&gt; m VName
</span><a href="Language.Futhark.TypeChecker.Monad.html#newID"><span class="hs-identifier hs-var">newID</span></a></span><span> </span><span class="annot"><span class="annottext">(Name -&gt; TermTypeM VName) -&gt; Name -&gt; TermTypeM VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Int -&gt; Name
</span><a href="Language.Futhark.TypeChecker.Monad.html#mkTypeVarName"><span class="hs-identifier hs-var">mkTypeVarName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684556316"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684556317"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-556"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TypeParam
</span><a href="#local-6989586621684556318"><span class="hs-identifier hs-var">tparam</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-557"></span><span>    </span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeParamType"><span class="hs-identifier hs-type">TypeParamType</span></a></span><span> </span><span id="local-6989586621684556310"><span class="annot"><span class="annottext">Liftedness
</span><a href="#local-6989586621684556310"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-558"></span><span>      </span><span class="annot"><span class="annottext">VName -&gt; Constraint -&gt; TermTypeM ()
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#constrain"><span class="hs-identifier hs-var">constrain</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684556312"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">(Constraint -&gt; TermTypeM ()) -&gt; Constraint -&gt; TermTypeM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Liftedness -&gt; Usage -&gt; Constraint
</span><a href="Language.Futhark.TypeChecker.Unify.html#NoConstraint"><span class="hs-identifier hs-var">NoConstraint</span></a></span><span> </span><span class="annot"><span class="annottext">Liftedness
</span><a href="#local-6989586621684556310"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">(Usage -&gt; Constraint) -&gt; Usage -&gt; Constraint
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc -&gt; Usage
</span><a href="Language.Futhark.TypeChecker.Unify.html#mkUsage%27"><span class="hs-identifier hs-var">mkUsage'</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684556319"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-559"></span><span>      </span><span class="annot"><span class="annottext">(VName, Subst (RetTypeBase dim as))
-&gt; TermTypeM (VName, Subst (RetTypeBase dim as))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684556312"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TypeParam] -&gt; RetTypeBase dim as -&gt; Subst (RetTypeBase dim as)
forall t. [TypeParam] -&gt; t -&gt; Subst t
</span><a href="Language.Futhark.TypeChecker.Types.html#Subst"><span class="hs-identifier hs-var">Subst</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(RetTypeBase dim as -&gt; Subst (RetTypeBase dim as))
-&gt; RetTypeBase dim as -&gt; Subst (RetTypeBase dim as)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; TypeBase dim as -&gt; RetTypeBase dim as
forall dim as. [VName] -&gt; TypeBase dim as -&gt; RetTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-var">RetType</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(TypeBase dim as -&gt; RetTypeBase dim as)
-&gt; TypeBase dim as -&gt; RetTypeBase dim as
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ScalarTypeBase dim as -&gt; TypeBase dim as
forall dim as. ScalarTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-var">Scalar</span></a></span><span> </span><span class="annot"><span class="annottext">(ScalarTypeBase dim as -&gt; TypeBase dim as)
-&gt; ScalarTypeBase dim as -&gt; TypeBase dim as
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">as
-&gt; Uniqueness -&gt; TypeName -&gt; [TypeArg dim] -&gt; ScalarTypeBase dim as
forall dim as.
as
-&gt; Uniqueness -&gt; TypeName -&gt; [TypeArg dim] -&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#TypeVar"><span class="hs-identifier hs-var">TypeVar</span></a></span><span> </span><span class="annot"><span class="annottext">as
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="Language.Futhark.Core.html#Nonunique"><span class="hs-identifier hs-var">Nonunique</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; TypeName
</span><a href="Language.Futhark.Prop.html#typeName"><span class="hs-identifier hs-var">typeName</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684556312"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-560"></span><span>    </span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeParamDim"><span class="hs-identifier hs-type">TypeParamDim</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-561"></span><span>      </span><span class="annot"><span class="annottext">VName -&gt; Constraint -&gt; TermTypeM ()
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#constrain"><span class="hs-identifier hs-var">constrain</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684556312"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">(Constraint -&gt; TermTypeM ()) -&gt; Constraint -&gt; TermTypeM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (DimDecl VName) -&gt; Usage -&gt; Constraint
</span><a href="Language.Futhark.TypeChecker.Unify.html#Size"><span class="hs-identifier hs-var">Size</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (DimDecl VName)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">(Usage -&gt; Constraint) -&gt; Usage -&gt; Constraint
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc -&gt; Usage
</span><a href="Language.Futhark.TypeChecker.Unify.html#mkUsage%27"><span class="hs-identifier hs-var">mkUsage'</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684556319"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-562"></span><span>      </span><span class="annot"><span class="annottext">(VName, Subst (RetTypeBase dim as))
-&gt; TermTypeM (VName, Subst (RetTypeBase dim as))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684556312"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DimDecl VName -&gt; Subst (RetTypeBase dim as)
forall t. DimDecl VName -&gt; Subst t
</span><a href="Language.Futhark.TypeChecker.Types.html#SizeSubst"><span class="hs-identifier hs-var">SizeSubst</span></a></span><span> </span><span class="annot"><span class="annottext">(DimDecl VName -&gt; Subst (RetTypeBase dim as))
-&gt; DimDecl VName -&gt; Subst (RetTypeBase dim as)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">QualName VName -&gt; DimDecl VName
forall vn. QualName vn -&gt; DimDecl vn
</span><a href="Language.Futhark.Syntax.html#NamedDim"><span class="hs-identifier hs-var">NamedDim</span></a></span><span> </span><span class="annot"><span class="annottext">(QualName VName -&gt; DimDecl VName)
-&gt; QualName VName -&gt; DimDecl VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; QualName VName
forall v. v -&gt; QualName v
</span><a href="Language.Futhark.Prop.html#qualName"><span class="hs-identifier hs-var">qualName</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684556312"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-563"></span><span>
</span><span id="line-564"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#checkQualNameWithEnv"><span class="hs-identifier hs-type">checkQualNameWithEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Semantic.html#Namespace"><span class="hs-identifier hs-type">Namespace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#QualName"><span class="hs-identifier hs-type">QualName</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SrcLoc</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermScope"><span class="hs-identifier hs-type">TermScope</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#QualName"><span class="hs-identifier hs-type">QualName</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-565"></span><span id="checkQualNameWithEnv"><span class="annot"><span class="annottext">checkQualNameWithEnv :: Namespace
-&gt; QualName Name -&gt; SrcLoc -&gt; TermTypeM (TermScope, QualName VName)
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#checkQualNameWithEnv"><span class="hs-identifier hs-var hs-var">checkQualNameWithEnv</span></a></span></span><span> </span><span id="local-6989586621684556302"><span class="annot"><span class="annottext">Namespace
</span><a href="#local-6989586621684556302"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684556301"><span class="annot"><span class="annottext">qn :: QualName Name
</span><a href="#local-6989586621684556301"><span class="hs-identifier hs-var">qn</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#QualName"><span class="hs-identifier hs-type">QualName</span></a></span><span> </span><span id="local-6989586621684556299"><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621684556299"><span class="hs-identifier hs-var">quals</span></a></span></span><span> </span><span id="local-6989586621684556298"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684556298"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684556297"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684556297"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-566"></span><span>  </span><span id="local-6989586621684556296"><span class="annot"><span class="annottext">TermScope
</span><a href="#local-6989586621684556296"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TermEnv -&gt; TermScope) -&gt; TermTypeM TermScope
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">TermEnv -&gt; TermScope
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#termScope"><span class="hs-identifier hs-var hs-var">termScope</span></a></span><span>
</span><span id="line-567"></span><span>  </span><span class="annot"><span class="annottext">TermScope -&gt; [Name] -&gt; TermTypeM (TermScope, QualName VName)
</span><a href="#local-6989586621684556295"><span class="hs-identifier hs-var">descend</span></a></span><span> </span><span class="annot"><span class="annottext">TermScope
</span><a href="#local-6989586621684556296"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621684556299"><span class="hs-identifier hs-var">quals</span></a></span><span>
</span><span id="line-568"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-569"></span><span>    </span><span id="local-6989586621684556295"><span class="annot"><span class="annottext">descend :: TermScope -&gt; [Name] -&gt; TermTypeM (TermScope, QualName VName)
</span><a href="#local-6989586621684556295"><span class="hs-identifier hs-var hs-var">descend</span></a></span></span><span> </span><span id="local-6989586621684556282"><span class="annot"><span class="annottext">TermScope
</span><a href="#local-6989586621684556282"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-570"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684556281"><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684556281"><span class="hs-identifier hs-var">name'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Namespace, Name) -&gt; NameMap -&gt; Maybe (QualName VName)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Namespace
</span><a href="#local-6989586621684556302"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684556298"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(NameMap -&gt; Maybe (QualName VName))
-&gt; NameMap -&gt; Maybe (QualName VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TermScope -&gt; NameMap
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#scopeNameMap"><span class="hs-identifier hs-var hs-var">scopeNameMap</span></a></span><span> </span><span class="annot"><span class="annottext">TermScope
</span><a href="#local-6989586621684556282"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-571"></span><span>        </span><span class="annot"><span class="annottext">(TermScope, QualName VName)
-&gt; TermTypeM (TermScope, QualName VName)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TermScope
</span><a href="#local-6989586621684556282"><span class="hs-identifier hs-var">scope</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684556281"><span class="hs-identifier hs-var">name'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-572"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-573"></span><span>        </span><span class="annot"><span class="annottext">Namespace
-&gt; QualName Name -&gt; SrcLoc -&gt; TermTypeM (TermScope, QualName VName)
forall (m :: * -&gt; *) a.
MonadTypeChecker m =&gt;
Namespace -&gt; QualName Name -&gt; SrcLoc -&gt; m a
</span><a href="Language.Futhark.TypeChecker.Monad.html#unknownVariable"><span class="hs-identifier hs-var">unknownVariable</span></a></span><span> </span><span class="annot"><span class="annottext">Namespace
</span><a href="#local-6989586621684556302"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">QualName Name
</span><a href="#local-6989586621684556301"><span class="hs-identifier hs-var">qn</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684556297"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-574"></span><span>    </span><span class="annot"><a href="#local-6989586621684556295"><span class="hs-identifier hs-var">descend</span></a></span><span> </span><span id="local-6989586621684556279"><span class="annot"><span class="annottext">TermScope
</span><a href="#local-6989586621684556279"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684556278"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684556278"><span class="hs-identifier hs-var">q</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684556277"><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621684556277"><span class="hs-identifier hs-var">qs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-575"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#QualName"><span class="hs-identifier hs-type">QualName</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684556276"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684556276"><span class="hs-identifier hs-var">q'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Namespace, Name) -&gt; NameMap -&gt; Maybe (QualName VName)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Namespace
</span><a href="Language.Futhark.Semantic.html#Term"><span class="hs-identifier hs-var">Term</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684556278"><span class="hs-identifier hs-var">q</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(NameMap -&gt; Maybe (QualName VName))
-&gt; NameMap -&gt; Maybe (QualName VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TermScope -&gt; NameMap
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#scopeNameMap"><span class="hs-identifier hs-var hs-var">scopeNameMap</span></a></span><span> </span><span class="annot"><span class="annottext">TermScope
</span><a href="#local-6989586621684556279"><span class="hs-identifier hs-var">scope</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-576"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684556274"><span class="annot"><span class="annottext">Mod
</span><a href="#local-6989586621684556274"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Map VName Mod -&gt; Maybe Mod
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684556276"><span class="hs-identifier hs-var">q'</span></a></span><span> </span><span class="annot"><span class="annottext">(Map VName Mod -&gt; Maybe Mod) -&gt; Map VName Mod -&gt; Maybe Mod
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TermScope -&gt; Map VName Mod
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#scopeModTable"><span class="hs-identifier hs-var hs-var">scopeModTable</span></a></span><span> </span><span class="annot"><span class="annottext">TermScope
</span><a href="#local-6989586621684556279"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-577"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Mod
</span><a href="#local-6989586621684556274"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-578"></span><span>          </span><span class="hs-comment">-- Check if we are referring to the magical intrinsics</span><span>
</span><span id="line-579"></span><span>          </span><span class="hs-comment">-- module.</span><span>
</span><span id="line-580"></span><span>          </span><span class="annot"><span class="annottext">Mod
</span><span class="hs-identifier">_</span></span><span>
</span><span id="line-581"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Int
</span><a href="Language.Futhark.Core.html#baseTag"><span class="hs-identifier hs-var">baseTag</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684556276"><span class="hs-identifier hs-var">q'</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="Language.Futhark.Prop.html#maxIntrinsicTag"><span class="hs-identifier hs-var">maxIntrinsicTag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-582"></span><span>              </span><span class="annot"><span class="annottext">Namespace
-&gt; QualName Name -&gt; SrcLoc -&gt; TermTypeM (TermScope, QualName VName)
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#checkIntrinsic"><span class="hs-identifier hs-var">checkIntrinsic</span></a></span><span> </span><span class="annot"><span class="annottext">Namespace
</span><a href="#local-6989586621684556302"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">QualName Name
</span><a href="#local-6989586621684556301"><span class="hs-identifier hs-var">qn</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684556297"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-583"></span><span>          </span><span class="annot"><a href="Language.Futhark.Semantic.html#ModEnv"><span class="hs-identifier hs-type">ModEnv</span></a></span><span> </span><span id="local-6989586621684556268"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684556268"><span class="hs-identifier hs-var">q_scope</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-584"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621684556267"><span class="annot"><span class="annottext">TermScope
</span><a href="#local-6989586621684556267"><span class="hs-identifier hs-var">scope'</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#QualName"><span class="hs-identifier hs-type">QualName</span></a></span><span> </span><span id="local-6989586621684556266"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684556266"><span class="hs-identifier hs-var">qs'</span></a></span></span><span> </span><span id="local-6989586621684556265"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684556265"><span class="hs-identifier hs-var">name'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TermScope -&gt; [Name] -&gt; TermTypeM (TermScope, QualName VName)
</span><a href="#local-6989586621684556295"><span class="hs-identifier hs-var">descend</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Env -&gt; TermScope
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#envToTermScope"><span class="hs-identifier hs-var">envToTermScope</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684556268"><span class="hs-identifier hs-var">q_scope</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621684556277"><span class="hs-identifier hs-var">qs</span></a></span><span>
</span><span id="line-585"></span><span>            </span><span class="annot"><span class="annottext">(TermScope, QualName VName)
-&gt; TermTypeM (TermScope, QualName VName)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TermScope
</span><a href="#local-6989586621684556267"><span class="hs-identifier hs-var">scope'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; VName -&gt; QualName VName
forall vn. [vn] -&gt; vn -&gt; QualName vn
</span><a href="Language.Futhark.Syntax.html#QualName"><span class="hs-identifier hs-var">QualName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684556276"><span class="hs-identifier hs-var">q'</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [VName] -&gt; [VName]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684556266"><span class="hs-identifier hs-var">qs'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684556265"><span class="hs-identifier hs-var">name'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-586"></span><span>          </span><span class="annot"><a href="Language.Futhark.Semantic.html#ModFun"><span class="hs-identifier hs-type">ModFun</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SrcLoc -&gt; TermTypeM (TermScope, QualName VName)
forall (m :: * -&gt; *) a. MonadTypeChecker m =&gt; SrcLoc -&gt; m a
</span><a href="Language.Futhark.TypeChecker.Monad.html#unappliedFunctor"><span class="hs-identifier hs-var">unappliedFunctor</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684556297"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-587"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-588"></span><span>        </span><span class="annot"><span class="annottext">Namespace
-&gt; QualName Name -&gt; SrcLoc -&gt; TermTypeM (TermScope, QualName VName)
forall (m :: * -&gt; *) a.
MonadTypeChecker m =&gt;
Namespace -&gt; QualName Name -&gt; SrcLoc -&gt; m a
</span><a href="Language.Futhark.TypeChecker.Monad.html#unknownVariable"><span class="hs-identifier hs-var">unknownVariable</span></a></span><span> </span><span class="annot"><span class="annottext">Namespace
</span><a href="#local-6989586621684556302"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">QualName Name
</span><a href="#local-6989586621684556301"><span class="hs-identifier hs-var">qn</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684556297"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-589"></span><span>
</span><span id="line-590"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#checkIntrinsic"><span class="hs-identifier hs-type">checkIntrinsic</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Semantic.html#Namespace"><span class="hs-identifier hs-type">Namespace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#QualName"><span class="hs-identifier hs-type">QualName</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SrcLoc</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermScope"><span class="hs-identifier hs-type">TermScope</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#QualName"><span class="hs-identifier hs-type">QualName</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-591"></span><span id="checkIntrinsic"><span class="annot"><span class="annottext">checkIntrinsic :: Namespace
-&gt; QualName Name -&gt; SrcLoc -&gt; TermTypeM (TermScope, QualName VName)
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#checkIntrinsic"><span class="hs-identifier hs-var hs-var">checkIntrinsic</span></a></span></span><span> </span><span id="local-6989586621684556262"><span class="annot"><span class="annottext">Namespace
</span><a href="#local-6989586621684556262"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684556261"><span class="annot"><span class="annottext">qn :: QualName Name
</span><a href="#local-6989586621684556261"><span class="hs-identifier hs-var">qn</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#QualName"><span class="hs-identifier hs-type">QualName</span></a></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684556260"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684556260"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684556259"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684556259"><span class="hs-identifier hs-var">loc</span></a></span></span><span>
</span><span id="line-592"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684556258"><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684556258"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Namespace, Name) -&gt; NameMap -&gt; Maybe (QualName VName)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Namespace
</span><a href="#local-6989586621684556262"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684556260"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">NameMap
</span><a href="Language.Futhark.TypeChecker.Monad.html#intrinsicsNameMap"><span class="hs-identifier hs-var">intrinsicsNameMap</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-593"></span><span>    </span><span id="local-6989586621684556256"><span class="annot"><span class="annottext">ImportName
</span><a href="#local-6989586621684556256"><span class="hs-identifier hs-var">me</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TypeM ImportName -&gt; TermTypeM ImportName
forall a. TypeM a -&gt; TermTypeM a
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#liftTypeM"><span class="hs-identifier hs-var">liftTypeM</span></a></span><span> </span><span class="annot"><span class="annottext">TypeM ImportName
</span><a href="Language.Futhark.TypeChecker.Monad.html#askImportName"><span class="hs-identifier hs-var">askImportName</span></a></span><span>
</span><span id="line-594"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; TermTypeM () -&gt; TermTypeM ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;/prelude&quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; Bool
forall a. Eq a =&gt; [a] -&gt; [a] -&gt; Bool
</span><span class="hs-operator hs-var">`isPrefixOf`</span></span><span> </span><span class="annot"><span class="annottext">ImportName -&gt; [Char]
</span><a href="Language.Futhark.Semantic.html#includeToFilePath"><span class="hs-identifier hs-var">includeToFilePath</span></a></span><span> </span><span class="annot"><span class="annottext">ImportName
</span><a href="#local-6989586621684556256"><span class="hs-identifier hs-var">me</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TermTypeM () -&gt; TermTypeM ()) -&gt; TermTypeM () -&gt; TermTypeM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-595"></span><span>      </span><span class="annot"><span class="annottext">SrcLoc -&gt; Doc -&gt; TermTypeM ()
forall (m :: * -&gt; *) loc.
(MonadTypeChecker m, Located loc) =&gt;
loc -&gt; Doc -&gt; m ()
</span><a href="Language.Futhark.TypeChecker.Monad.html#warn"><span class="hs-identifier hs-var">warn</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684556259"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Using intrinsic functions directly can easily crash the compiler or result in wrong code generation.&quot;</span></span><span>
</span><span id="line-596"></span><span>    </span><span id="local-6989586621684556252"><span class="annot"><span class="annottext">TermScope
</span><a href="#local-6989586621684556252"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TermEnv -&gt; TermScope) -&gt; TermTypeM TermScope
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">TermEnv -&gt; TermScope
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#termScope"><span class="hs-identifier hs-var hs-var">termScope</span></a></span><span>
</span><span id="line-597"></span><span>    </span><span class="annot"><span class="annottext">(TermScope, QualName VName)
-&gt; TermTypeM (TermScope, QualName VName)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TermScope
</span><a href="#local-6989586621684556252"><span class="hs-identifier hs-var">scope</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684556258"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-598"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-599"></span><span>    </span><span class="annot"><span class="annottext">Namespace
-&gt; QualName Name -&gt; SrcLoc -&gt; TermTypeM (TermScope, QualName VName)
forall (m :: * -&gt; *) a.
MonadTypeChecker m =&gt;
Namespace -&gt; QualName Name -&gt; SrcLoc -&gt; m a
</span><a href="Language.Futhark.TypeChecker.Monad.html#unknownVariable"><span class="hs-identifier hs-var">unknownVariable</span></a></span><span> </span><span class="annot"><span class="annottext">Namespace
</span><a href="#local-6989586621684556262"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">QualName Name
</span><a href="#local-6989586621684556261"><span class="hs-identifier hs-var">qn</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684556259"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-600"></span><span>
</span><span id="line-601"></span><span id="local-6989586621684557755"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#localScope"><span class="hs-identifier hs-type">localScope</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermScope"><span class="hs-identifier hs-type">TermScope</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermScope"><span class="hs-identifier hs-type">TermScope</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684557755"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684557755"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-602"></span><span id="localScope"><span class="annot"><span class="annottext">localScope :: forall a. (TermScope -&gt; TermScope) -&gt; TermTypeM a -&gt; TermTypeM a
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#localScope"><span class="hs-identifier hs-var hs-var">localScope</span></a></span></span><span> </span><span id="local-6989586621684556250"><span class="annot"><span class="annottext">TermScope -&gt; TermScope
</span><a href="#local-6989586621684556250"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TermEnv -&gt; TermEnv) -&gt; TermTypeM a -&gt; TermTypeM a
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; r) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">local</span></span><span> </span><span class="annot"><span class="annottext">((TermEnv -&gt; TermEnv) -&gt; TermTypeM a -&gt; TermTypeM a)
-&gt; (TermEnv -&gt; TermEnv) -&gt; TermTypeM a -&gt; TermTypeM a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684556248"><span class="annot"><span class="annottext">TermEnv
</span><a href="#local-6989586621684556248"><span class="hs-identifier hs-var">tenv</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TermEnv
</span><a href="#local-6989586621684556248"><span class="hs-identifier hs-var">tenv</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">termScope :: TermScope
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#termScope"><span class="hs-identifier hs-var">termScope</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TermScope -&gt; TermScope
</span><a href="#local-6989586621684556250"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">(TermScope -&gt; TermScope) -&gt; TermScope -&gt; TermScope
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TermEnv -&gt; TermScope
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#termScope"><span class="hs-identifier hs-var hs-var">termScope</span></a></span><span> </span><span class="annot"><span class="annottext">TermEnv
</span><a href="#local-6989586621684556248"><span class="hs-identifier hs-var">tenv</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-603"></span><span>
</span><span id="line-604"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Monad.html#MonadTypeChecker"><span class="hs-identifier hs-type">MonadTypeChecker</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-605"></span><span>  </span><span id="local-6989586621684556228"><span class="annot"><span class="annottext">warn :: forall loc. Located loc =&gt; loc -&gt; Doc -&gt; TermTypeM ()
</span><a href="#local-6989586621684556228"><span class="hs-identifier hs-var hs-var hs-var hs-var">warn</span></a></span></span><span> </span><span id="local-6989586621684556227"><span class="annot"><span class="annottext">loc
</span><a href="#local-6989586621684556227"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span id="local-6989586621684556226"><span class="annot"><span class="annottext">Doc
</span><a href="#local-6989586621684556226"><span class="hs-identifier hs-var">problem</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeM () -&gt; TermTypeM ()
forall a. TypeM a -&gt; TermTypeM a
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#liftTypeM"><span class="hs-identifier hs-var">liftTypeM</span></a></span><span> </span><span class="annot"><span class="annottext">(TypeM () -&gt; TermTypeM ()) -&gt; TypeM () -&gt; TermTypeM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">loc -&gt; Doc -&gt; TypeM ()
forall (m :: * -&gt; *) loc.
(MonadTypeChecker m, Located loc) =&gt;
loc -&gt; Doc -&gt; m ()
</span><a href="Language.Futhark.TypeChecker.Monad.html#warn"><span class="hs-identifier hs-var">warn</span></a></span><span> </span><span class="annot"><span class="annottext">loc
</span><a href="#local-6989586621684556227"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">Doc
</span><a href="#local-6989586621684556226"><span class="hs-identifier hs-var">problem</span></a></span><span>
</span><span id="line-606"></span><span>  </span><span id="local-6989586621684556224"><span class="annot"><span class="annottext">newName :: VName -&gt; TermTypeM VName
</span><a href="Language.Futhark.TypeChecker.Monad.html#newName"><span class="hs-identifier hs-var hs-var hs-var hs-var">newName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeM VName -&gt; TermTypeM VName
forall a. TypeM a -&gt; TermTypeM a
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#liftTypeM"><span class="hs-identifier hs-var">liftTypeM</span></a></span><span> </span><span class="annot"><span class="annottext">(TypeM VName -&gt; TermTypeM VName)
-&gt; (VName -&gt; TypeM VName) -&gt; VName -&gt; TermTypeM VName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TypeM VName
forall (m :: * -&gt; *). MonadTypeChecker m =&gt; VName -&gt; m VName
</span><a href="Language.Futhark.TypeChecker.Monad.html#newName"><span class="hs-identifier hs-var">newName</span></a></span><span>
</span><span id="line-607"></span><span>  </span><span id="local-6989586621684556221"><span class="annot"><span class="annottext">newID :: Name -&gt; TermTypeM VName
</span><a href="#local-6989586621684556221"><span class="hs-identifier hs-var hs-var hs-var hs-var">newID</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeM VName -&gt; TermTypeM VName
forall a. TypeM a -&gt; TermTypeM a
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#liftTypeM"><span class="hs-identifier hs-var">liftTypeM</span></a></span><span> </span><span class="annot"><span class="annottext">(TypeM VName -&gt; TermTypeM VName)
-&gt; (Name -&gt; TypeM VName) -&gt; Name -&gt; TermTypeM VName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; TypeM VName
forall (m :: * -&gt; *). MonadTypeChecker m =&gt; Name -&gt; m VName
</span><a href="Language.Futhark.TypeChecker.Monad.html#newID"><span class="hs-identifier hs-var">newID</span></a></span><span>
</span><span id="line-608"></span><span>
</span><span id="line-609"></span><span>  </span><span id="local-6989586621684556218"><span class="annot"><span class="annottext">newTypeName :: Name -&gt; TermTypeM VName
</span><a href="#local-6989586621684556218"><span class="hs-identifier hs-var hs-var hs-var hs-var">newTypeName</span></a></span></span><span> </span><span id="local-6989586621684556217"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684556217"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-610"></span><span>    </span><span id="local-6989586621684556216"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684556216"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TermTypeM Int
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#incCounter"><span class="hs-identifier hs-var">incCounter</span></a></span><span>
</span><span id="line-611"></span><span>    </span><span class="annot"><span class="annottext">Name -&gt; TermTypeM VName
forall (m :: * -&gt; *). MonadTypeChecker m =&gt; Name -&gt; m VName
</span><a href="Language.Futhark.TypeChecker.Monad.html#newID"><span class="hs-identifier hs-var">newID</span></a></span><span> </span><span class="annot"><span class="annottext">(Name -&gt; TermTypeM VName) -&gt; Name -&gt; TermTypeM VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Int -&gt; Name
</span><a href="Language.Futhark.TypeChecker.Monad.html#mkTypeVarName"><span class="hs-identifier hs-var">mkTypeVarName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684556217"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684556216"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-612"></span><span>
</span><span id="line-613"></span><span>  </span><span id="local-6989586621684556214"><span class="annot"><span class="annottext">checkQualName :: Namespace -&gt; QualName Name -&gt; SrcLoc -&gt; TermTypeM (QualName VName)
</span><a href="Language.Futhark.TypeChecker.Monad.html#checkQualName"><span class="hs-identifier hs-var hs-var hs-var hs-var">checkQualName</span></a></span></span><span> </span><span id="local-6989586621684556212"><span class="annot"><span class="annottext">Namespace
</span><a href="#local-6989586621684556212"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684556211"><span class="annot"><span class="annottext">QualName Name
</span><a href="#local-6989586621684556211"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621684556210"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684556210"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TermScope, QualName VName) -&gt; QualName VName
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">((TermScope, QualName VName) -&gt; QualName VName)
-&gt; TermTypeM (TermScope, QualName VName)
-&gt; TermTypeM (QualName VName)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Namespace
-&gt; QualName Name -&gt; SrcLoc -&gt; TermTypeM (TermScope, QualName VName)
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#checkQualNameWithEnv"><span class="hs-identifier hs-var">checkQualNameWithEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Namespace
</span><a href="#local-6989586621684556212"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">QualName Name
</span><a href="#local-6989586621684556211"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684556210"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-614"></span><span>
</span><span id="line-615"></span><span>  </span><span id="local-6989586621684556207"><span class="annot"><span class="annottext">bindNameMap :: forall a. NameMap -&gt; TermTypeM a -&gt; TermTypeM a
</span><a href="Language.Futhark.TypeChecker.Monad.html#bindNameMap"><span class="hs-identifier hs-var hs-var hs-var hs-var">bindNameMap</span></a></span></span><span> </span><span id="local-6989586621684556205"><span class="annot"><span class="annottext">NameMap
</span><a href="#local-6989586621684556205"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TermScope -&gt; TermScope) -&gt; TermTypeM a -&gt; TermTypeM a
forall a. (TermScope -&gt; TermScope) -&gt; TermTypeM a -&gt; TermTypeM a
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#localScope"><span class="hs-identifier hs-var">localScope</span></a></span><span> </span><span class="annot"><span class="annottext">((TermScope -&gt; TermScope) -&gt; TermTypeM a -&gt; TermTypeM a)
-&gt; (TermScope -&gt; TermScope) -&gt; TermTypeM a -&gt; TermTypeM a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684556204"><span class="annot"><span class="annottext">TermScope
</span><a href="#local-6989586621684556204"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-616"></span><span>    </span><span class="annot"><span class="annottext">TermScope
</span><a href="#local-6989586621684556204"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">scopeNameMap :: NameMap
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#scopeNameMap"><span class="hs-identifier hs-var">scopeNameMap</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NameMap
</span><a href="#local-6989586621684556205"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">NameMap -&gt; NameMap -&gt; NameMap
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">TermScope -&gt; NameMap
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#scopeNameMap"><span class="hs-identifier hs-var hs-var">scopeNameMap</span></a></span><span> </span><span class="annot"><span class="annottext">TermScope
</span><a href="#local-6989586621684556204"><span class="hs-identifier hs-var">scope</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-617"></span><span>
</span><span id="line-618"></span><span>  </span><span id="local-6989586621684556202"><span class="annot"><span class="annottext">bindVal :: forall a. VName -&gt; BoundV -&gt; TermTypeM a -&gt; TermTypeM a
</span><a href="Language.Futhark.TypeChecker.Monad.html#bindVal"><span class="hs-identifier hs-var hs-var hs-var hs-var">bindVal</span></a></span></span><span> </span><span id="local-6989586621684556200"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684556200"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Semantic.html#BoundV"><span class="hs-identifier hs-type">TypeM.BoundV</span></a></span><span> </span><span id="local-6989586621684556199"><span class="annot"><span class="annottext">[TypeParam]
</span><a href="#local-6989586621684556199"><span class="hs-identifier hs-var">tps</span></a></span></span><span> </span><span id="local-6989586621684556198"><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684556198"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TermScope -&gt; TermScope) -&gt; TermTypeM a -&gt; TermTypeM a
forall a. (TermScope -&gt; TermScope) -&gt; TermTypeM a -&gt; TermTypeM a
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#localScope"><span class="hs-identifier hs-var">localScope</span></a></span><span> </span><span class="annot"><span class="annottext">((TermScope -&gt; TermScope) -&gt; TermTypeM a -&gt; TermTypeM a)
-&gt; (TermScope -&gt; TermScope) -&gt; TermTypeM a -&gt; TermTypeM a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684556197"><span class="annot"><span class="annottext">TermScope
</span><a href="#local-6989586621684556197"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-619"></span><span>    </span><span class="annot"><span class="annottext">TermScope
</span><a href="#local-6989586621684556197"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">scopeVtable :: Map VName ValBinding
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#scopeVtable"><span class="hs-identifier hs-var">scopeVtable</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; ValBinding -&gt; Map VName ValBinding -&gt; Map VName ValBinding
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684556200"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">ValBinding
</span><a href="#local-6989586621684556196"><span class="hs-identifier hs-var">vb</span></a></span><span> </span><span class="annot"><span class="annottext">(Map VName ValBinding -&gt; Map VName ValBinding)
-&gt; Map VName ValBinding -&gt; Map VName ValBinding
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TermScope -&gt; Map VName ValBinding
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#scopeVtable"><span class="hs-identifier hs-var hs-var">scopeVtable</span></a></span><span> </span><span class="annot"><span class="annottext">TermScope
</span><a href="#local-6989586621684556197"><span class="hs-identifier hs-var">scope</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-620"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-621"></span><span>      </span><span id="local-6989586621684556196"><span class="annot"><span class="annottext">vb :: ValBinding
</span><a href="#local-6989586621684556196"><span class="hs-identifier hs-var hs-var">vb</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Locality -&gt; [TypeParam] -&gt; PatType -&gt; ValBinding
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#BoundV"><span class="hs-identifier hs-var">BoundV</span></a></span><span> </span><span class="annot"><span class="annottext">Locality
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Local"><span class="hs-identifier hs-var">Local</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeParam]
</span><a href="#local-6989586621684556199"><span class="hs-identifier hs-var">tps</span></a></span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; ValBinding) -&gt; PatType -&gt; ValBinding
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">StructType -&gt; PatType
forall dim as. TypeBase dim as -&gt; TypeBase dim Aliasing
</span><a href="Language.Futhark.Prop.html#fromStruct"><span class="hs-identifier hs-var">fromStruct</span></a></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684556198"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-622"></span><span>
</span><span id="line-623"></span><span>  </span><span id="local-6989586621684556189"><span class="annot"><span class="annottext">lookupType :: SrcLoc
-&gt; QualName Name
-&gt; TermTypeM
     (QualName VName, [TypeParam], RetTypeBase (DimDecl VName) (),
      Liftedness)
</span><a href="Language.Futhark.TypeChecker.Monad.html#lookupType"><span class="hs-identifier hs-var hs-var hs-var hs-var">lookupType</span></a></span></span><span> </span><span id="local-6989586621684556187"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684556187"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span id="local-6989586621684556186"><span class="annot"><span class="annottext">QualName Name
</span><a href="#local-6989586621684556186"><span class="hs-identifier hs-var">qn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-624"></span><span>    </span><span id="local-6989586621684556185"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684556185"><span class="hs-identifier hs-var">outer_env</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TypeM Env -&gt; TermTypeM Env
forall a. TypeM a -&gt; TermTypeM a
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#liftTypeM"><span class="hs-identifier hs-var">liftTypeM</span></a></span><span> </span><span class="annot"><span class="annottext">TypeM Env
</span><a href="Language.Futhark.TypeChecker.Monad.html#askEnv"><span class="hs-identifier hs-var">askEnv</span></a></span><span>
</span><span id="line-625"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684556183"><span class="annot"><span class="annottext">TermScope
</span><a href="#local-6989586621684556183"><span class="hs-identifier hs-var">scope</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684556182"><span class="annot"><span class="annottext">qn' :: QualName VName
</span><a href="#local-6989586621684556182"><span class="hs-identifier hs-var">qn'</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#QualName"><span class="hs-identifier hs-type">QualName</span></a></span><span> </span><span id="local-6989586621684556181"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684556181"><span class="hs-identifier hs-var">qs</span></a></span></span><span> </span><span id="local-6989586621684556180"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684556180"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Namespace
-&gt; QualName Name -&gt; SrcLoc -&gt; TermTypeM (TermScope, QualName VName)
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#checkQualNameWithEnv"><span class="hs-identifier hs-var">checkQualNameWithEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Namespace
</span><a href="Language.Futhark.Semantic.html#Type"><span class="hs-identifier hs-var">Type</span></a></span><span> </span><span class="annot"><span class="annottext">QualName Name
</span><a href="#local-6989586621684556186"><span class="hs-identifier hs-var">qn</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684556187"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-626"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Map VName TypeBinding -&gt; Maybe TypeBinding
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684556180"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">(Map VName TypeBinding -&gt; Maybe TypeBinding)
-&gt; Map VName TypeBinding -&gt; Maybe TypeBinding
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TermScope -&gt; Map VName TypeBinding
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#scopeTypeTable"><span class="hs-identifier hs-var hs-var">scopeTypeTable</span></a></span><span> </span><span class="annot"><span class="annottext">TermScope
</span><a href="#local-6989586621684556183"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-627"></span><span>      </span><span class="annot"><span class="annottext">Maybe TypeBinding
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SrcLoc
-&gt; QualName Name
-&gt; TermTypeM
     (QualName VName, [TypeParam], RetTypeBase (DimDecl VName) (),
      Liftedness)
forall (m :: * -&gt; *) a.
MonadTypeChecker m =&gt;
SrcLoc -&gt; QualName Name -&gt; m a
</span><a href="Language.Futhark.TypeChecker.Monad.html#unknownType"><span class="hs-identifier hs-var">unknownType</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684556187"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">QualName Name
</span><a href="#local-6989586621684556186"><span class="hs-identifier hs-var">qn</span></a></span><span>
</span><span id="line-628"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Semantic.html#TypeAbbr"><span class="hs-identifier hs-type">TypeAbbr</span></a></span><span> </span><span id="local-6989586621684556176"><span class="annot"><span class="annottext">Liftedness
</span><a href="#local-6989586621684556176"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span id="local-6989586621684556175"><span class="annot"><span class="annottext">[TypeParam]
</span><a href="#local-6989586621684556175"><span class="hs-identifier hs-var">ps</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-type">RetType</span></a></span><span> </span><span id="local-6989586621684556174"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684556174"><span class="hs-identifier hs-var">dims</span></a></span></span><span> </span><span id="local-6989586621684556173"><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684556173"><span class="hs-identifier hs-var">def</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-629"></span><span>        </span><span class="annot"><span class="annottext">(QualName VName, [TypeParam], RetTypeBase (DimDecl VName) (),
 Liftedness)
-&gt; TermTypeM
     (QualName VName, [TypeParam], RetTypeBase (DimDecl VName) (),
      Liftedness)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-630"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684556182"><span class="hs-identifier hs-var">qn'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-631"></span><span>            </span><span class="annot"><span class="annottext">[TypeParam]
</span><a href="#local-6989586621684556175"><span class="hs-identifier hs-var">ps</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-632"></span><span>            </span><span class="annot"><span class="annottext">[VName] -&gt; StructType -&gt; RetTypeBase (DimDecl VName) ()
forall dim as. [VName] -&gt; TypeBase dim as -&gt; RetTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-var">RetType</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684556174"><span class="hs-identifier hs-var">dims</span></a></span><span> </span><span class="annot"><span class="annottext">(StructType -&gt; RetTypeBase (DimDecl VName) ())
-&gt; StructType -&gt; RetTypeBase (DimDecl VName) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Env -&gt; [VName] -&gt; [VName] -&gt; StructType -&gt; StructType
forall as.
Env
-&gt; [VName]
-&gt; [VName]
-&gt; TypeBase (DimDecl VName) as
-&gt; TypeBase (DimDecl VName) as
</span><a href="Language.Futhark.TypeChecker.Monad.html#qualifyTypeVars"><span class="hs-identifier hs-var">qualifyTypeVars</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684556185"><span class="hs-identifier hs-var">outer_env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TypeParam -&gt; VName) -&gt; [TypeParam] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TypeParam -&gt; VName
forall vn. TypeParamBase vn -&gt; vn
</span><a href="Language.Futhark.Syntax.html#typeParamName"><span class="hs-identifier hs-var">typeParamName</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeParam]
</span><a href="#local-6989586621684556175"><span class="hs-identifier hs-var">ps</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684556181"><span class="hs-identifier hs-var">qs</span></a></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684556173"><span class="hs-identifier hs-var">def</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-633"></span><span>            </span><span class="annot"><span class="annottext">Liftedness
</span><a href="#local-6989586621684556176"><span class="hs-identifier hs-var">l</span></a></span><span>
</span><span id="line-634"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-635"></span><span>
</span><span id="line-636"></span><span>  </span><span id="local-6989586621684556167"><span class="annot"><span class="annottext">lookupMod :: SrcLoc -&gt; QualName Name -&gt; TermTypeM (QualName VName, Mod)
</span><a href="Language.Futhark.TypeChecker.Monad.html#lookupMod"><span class="hs-identifier hs-var hs-var hs-var hs-var">lookupMod</span></a></span></span><span> </span><span id="local-6989586621684556165"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684556165"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span id="local-6989586621684556164"><span class="annot"><span class="annottext">QualName Name
</span><a href="#local-6989586621684556164"><span class="hs-identifier hs-var">qn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-637"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684556163"><span class="annot"><span class="annottext">TermScope
</span><a href="#local-6989586621684556163"><span class="hs-identifier hs-var">scope</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684556162"><span class="annot"><span class="annottext">qn' :: QualName VName
</span><a href="#local-6989586621684556162"><span class="hs-identifier hs-var">qn'</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#QualName"><span class="hs-identifier hs-type">QualName</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684556161"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684556161"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Namespace
-&gt; QualName Name -&gt; SrcLoc -&gt; TermTypeM (TermScope, QualName VName)
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#checkQualNameWithEnv"><span class="hs-identifier hs-var">checkQualNameWithEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Namespace
</span><a href="Language.Futhark.Semantic.html#Term"><span class="hs-identifier hs-var">Term</span></a></span><span> </span><span class="annot"><span class="annottext">QualName Name
</span><a href="#local-6989586621684556164"><span class="hs-identifier hs-var">qn</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684556165"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-638"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Map VName Mod -&gt; Maybe Mod
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684556161"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">(Map VName Mod -&gt; Maybe Mod) -&gt; Map VName Mod -&gt; Maybe Mod
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TermScope -&gt; Map VName Mod
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#scopeModTable"><span class="hs-identifier hs-var hs-var">scopeModTable</span></a></span><span> </span><span class="annot"><span class="annottext">TermScope
</span><a href="#local-6989586621684556163"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-639"></span><span>      </span><span class="annot"><span class="annottext">Maybe Mod
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Namespace
-&gt; QualName Name -&gt; SrcLoc -&gt; TermTypeM (QualName VName, Mod)
forall (m :: * -&gt; *) a.
MonadTypeChecker m =&gt;
Namespace -&gt; QualName Name -&gt; SrcLoc -&gt; m a
</span><a href="Language.Futhark.TypeChecker.Monad.html#unknownVariable"><span class="hs-identifier hs-var">unknownVariable</span></a></span><span> </span><span class="annot"><span class="annottext">Namespace
</span><a href="Language.Futhark.Semantic.html#Term"><span class="hs-identifier hs-var">Term</span></a></span><span> </span><span class="annot"><span class="annottext">QualName Name
</span><a href="#local-6989586621684556164"><span class="hs-identifier hs-var">qn</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684556165"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-640"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684556160"><span class="annot"><span class="annottext">Mod
</span><a href="#local-6989586621684556160"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(QualName VName, Mod) -&gt; TermTypeM (QualName VName, Mod)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684556162"><span class="hs-identifier hs-var">qn'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Mod
</span><a href="#local-6989586621684556160"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-641"></span><span>
</span><span id="line-642"></span><span>  </span><span id="local-6989586621684556121"><span class="annot"><span class="annottext">lookupVar :: SrcLoc -&gt; QualName Name -&gt; TermTypeM (QualName VName, PatType)
</span><a href="Language.Futhark.TypeChecker.Monad.html#lookupVar"><span class="hs-identifier hs-var hs-var hs-var hs-var">lookupVar</span></a></span></span><span> </span><span id="local-6989586621684556119"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684556119"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span id="local-6989586621684556118"><span class="annot"><span class="annottext">QualName Name
</span><a href="#local-6989586621684556118"><span class="hs-identifier hs-var">qn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-643"></span><span>    </span><span id="local-6989586621684556117"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684556117"><span class="hs-identifier hs-var">outer_env</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TypeM Env -&gt; TermTypeM Env
forall a. TypeM a -&gt; TermTypeM a
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#liftTypeM"><span class="hs-identifier hs-var">liftTypeM</span></a></span><span> </span><span class="annot"><span class="annottext">TypeM Env
</span><a href="Language.Futhark.TypeChecker.Monad.html#askEnv"><span class="hs-identifier hs-var">askEnv</span></a></span><span>
</span><span id="line-644"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684556116"><span class="annot"><span class="annottext">TermScope
</span><a href="#local-6989586621684556116"><span class="hs-identifier hs-var">scope</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684556115"><span class="annot"><span class="annottext">qn' :: QualName VName
</span><a href="#local-6989586621684556115"><span class="hs-identifier hs-var">qn'</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#QualName"><span class="hs-identifier hs-type">QualName</span></a></span><span> </span><span id="local-6989586621684556114"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684556114"><span class="hs-identifier hs-var">qs</span></a></span></span><span> </span><span id="local-6989586621684556113"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684556113"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Namespace
-&gt; QualName Name -&gt; SrcLoc -&gt; TermTypeM (TermScope, QualName VName)
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#checkQualNameWithEnv"><span class="hs-identifier hs-var">checkQualNameWithEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Namespace
</span><a href="Language.Futhark.Semantic.html#Term"><span class="hs-identifier hs-var">Term</span></a></span><span> </span><span class="annot"><span class="annottext">QualName Name
</span><a href="#local-6989586621684556118"><span class="hs-identifier hs-var">qn</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684556119"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-645"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684556108"><span class="annot"><span class="annottext">usage :: Usage
</span><a href="#local-6989586621684556108"><span class="hs-identifier hs-var hs-var">usage</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SrcLoc -&gt; [Char] -&gt; Usage
</span><a href="Language.Futhark.TypeChecker.Unify.html#mkUsage"><span class="hs-identifier hs-var">mkUsage</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684556119"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; Usage) -&gt; [Char] -&gt; Usage
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;use of &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">ShowS
</span><a href="Language.Futhark.Core.html#quote"><span class="hs-identifier hs-var">quote</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QualName Name -&gt; [Char]
forall a. Pretty a =&gt; a -&gt; [Char]
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">QualName Name
</span><a href="#local-6989586621684556118"><span class="hs-identifier hs-var">qn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-646"></span><span>
</span><span id="line-647"></span><span>    </span><span id="local-6989586621684556105"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684556105"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Map VName ValBinding -&gt; Maybe ValBinding
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684556113"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">(Map VName ValBinding -&gt; Maybe ValBinding)
-&gt; Map VName ValBinding -&gt; Maybe ValBinding
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TermScope -&gt; Map VName ValBinding
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#scopeVtable"><span class="hs-identifier hs-var hs-var">scopeVtable</span></a></span><span> </span><span class="annot"><span class="annottext">TermScope
</span><a href="#local-6989586621684556116"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-648"></span><span>      </span><span class="annot"><span class="annottext">Maybe ValBinding
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-649"></span><span>        </span><span class="annot"><span class="annottext">SrcLoc -&gt; Notes -&gt; Doc -&gt; TermTypeM PatType
forall (m :: * -&gt; *) loc a.
(MonadTypeChecker m, Located loc) =&gt;
loc -&gt; Notes -&gt; Doc -&gt; m a
</span><a href="Language.Futhark.TypeChecker.Monad.html#typeError"><span class="hs-identifier hs-var">typeError</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684556119"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">Notes
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; TermTypeM PatType) -&gt; Doc -&gt; TermTypeM PatType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-650"></span><span>          </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Unknown variable&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><a href="Language.Futhark.Core.html#pquote"><span class="hs-identifier hs-var">pquote</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QualName Name -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">QualName Name
</span><a href="#local-6989586621684556118"><span class="hs-identifier hs-var">qn</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;.&quot;</span></span><span>
</span><span id="line-651"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#WasConsumed"><span class="hs-identifier hs-type">WasConsumed</span></a></span><span> </span><span id="local-6989586621684556104"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684556104"><span class="hs-identifier hs-var">wloc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">VName -&gt; SrcLoc -&gt; SrcLoc -&gt; TermTypeM PatType
forall a. VName -&gt; SrcLoc -&gt; SrcLoc -&gt; TermTypeM a
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#useAfterConsume"><span class="hs-identifier hs-var">useAfterConsume</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684556113"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684556119"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684556104"><span class="hs-identifier hs-var">wloc</span></a></span><span>
</span><span id="line-652"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#BoundV"><span class="hs-identifier hs-type">BoundV</span></a></span><span> </span><span class="annot"><span class="annottext">Locality
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684556103"><span class="annot"><span class="annottext">[TypeParam]
</span><a href="#local-6989586621684556103"><span class="hs-identifier hs-var">tparams</span></a></span></span><span> </span><span id="local-6989586621684556102"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684556102"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-653"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;_&quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; Bool
forall a. Eq a =&gt; [a] -&gt; [a] -&gt; Bool
</span><span class="hs-operator hs-var">`isPrefixOf`</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [Char]
</span><a href="Language.Futhark.Core.html#baseString"><span class="hs-identifier hs-var">baseString</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684556113"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SrcLoc -&gt; QualName Name -&gt; TermTypeM PatType
forall (m :: * -&gt; *) a.
MonadTypeChecker m =&gt;
SrcLoc -&gt; QualName Name -&gt; m a
</span><a href="Language.Futhark.TypeChecker.Monad.html#underscoreUse"><span class="hs-identifier hs-var">underscoreUse</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684556119"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">QualName Name
</span><a href="#local-6989586621684556118"><span class="hs-identifier hs-var">qn</span></a></span><span>
</span><span id="line-654"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-655"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621684556100"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684556100"><span class="hs-identifier hs-var">tnames</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684556099"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684556099"><span class="hs-identifier hs-var">t'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SrcLoc -&gt; [TypeParam] -&gt; PatType -&gt; TermTypeM ([VName], PatType)
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#instantiateTypeScheme"><span class="hs-identifier hs-var">instantiateTypeScheme</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684556119"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeParam]
</span><a href="#local-6989586621684556103"><span class="hs-identifier hs-var">tparams</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684556102"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-656"></span><span>          </span><span class="annot"><span class="annottext">PatType -&gt; TermTypeM PatType
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; TermTypeM PatType) -&gt; PatType -&gt; TermTypeM PatType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Env -&gt; [VName] -&gt; [VName] -&gt; PatType -&gt; PatType
forall as.
Env
-&gt; [VName]
-&gt; [VName]
-&gt; TypeBase (DimDecl VName) as
-&gt; TypeBase (DimDecl VName) as
</span><a href="Language.Futhark.TypeChecker.Monad.html#qualifyTypeVars"><span class="hs-identifier hs-var">qualifyTypeVars</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684556117"><span class="hs-identifier hs-var">outer_env</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684556100"><span class="hs-identifier hs-var">tnames</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684556114"><span class="hs-identifier hs-var">qs</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684556099"><span class="hs-identifier hs-var">t'</span></a></span><span>
</span><span id="line-657"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">ValBinding
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#EqualityF"><span class="hs-identifier hs-var">EqualityF</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-658"></span><span>        </span><span id="local-6989586621684556098"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684556098"><span class="hs-identifier hs-var">argtype</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SrcLoc -&gt; Name -&gt; TermTypeM PatType
forall (m :: * -&gt; *) als dim.
(MonadUnify m, Monoid als) =&gt;
SrcLoc -&gt; Name -&gt; m (TypeBase dim als)
</span><a href="Language.Futhark.TypeChecker.Unify.html#newTypeVar"><span class="hs-identifier hs-var">newTypeVar</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684556119"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-string">&quot;t&quot;</span></span><span>
</span><span id="line-659"></span><span>        </span><span class="annot"><span class="annottext">Usage -&gt; PatType -&gt; TermTypeM ()
forall (m :: * -&gt; *) dim as.
(MonadUnify m, Pretty (ShapeDecl dim), Monoid as) =&gt;
Usage -&gt; TypeBase dim as -&gt; m ()
</span><a href="Language.Futhark.TypeChecker.Unify.html#equalityType"><span class="hs-identifier hs-var">equalityType</span></a></span><span> </span><span class="annot"><span class="annottext">Usage
</span><a href="#local-6989586621684556108"><span class="hs-identifier hs-var">usage</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684556098"><span class="hs-identifier hs-var">argtype</span></a></span><span>
</span><span id="line-660"></span><span>        </span><span class="annot"><span class="annottext">PatType -&gt; TermTypeM PatType
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; TermTypeM PatType) -&gt; PatType -&gt; TermTypeM PatType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-661"></span><span>          </span><span class="annot"><span class="annottext">ScalarTypeBase (DimDecl VName) Aliasing -&gt; PatType
forall dim as. ScalarTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-var">Scalar</span></a></span><span> </span><span class="annot"><span class="annottext">(ScalarTypeBase (DimDecl VName) Aliasing -&gt; PatType)
-&gt; (PatType -&gt; ScalarTypeBase (DimDecl VName) Aliasing)
-&gt; PatType
-&gt; PatType
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Aliasing
-&gt; PName
-&gt; PatType
-&gt; RetTypeBase (DimDecl VName) Aliasing
-&gt; ScalarTypeBase (DimDecl VName) Aliasing
forall dim as.
as
-&gt; PName
-&gt; TypeBase dim as
-&gt; RetTypeBase dim as
-&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Arrow"><span class="hs-identifier hs-var">Arrow</span></a></span><span> </span><span class="annot"><span class="annottext">Aliasing
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">PName
</span><a href="Language.Futhark.Syntax.html#Unnamed"><span class="hs-identifier hs-var">Unnamed</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684556098"><span class="hs-identifier hs-var">argtype</span></a></span><span> </span><span class="annot"><span class="annottext">(RetTypeBase (DimDecl VName) Aliasing
 -&gt; ScalarTypeBase (DimDecl VName) Aliasing)
-&gt; (PatType -&gt; RetTypeBase (DimDecl VName) Aliasing)
-&gt; PatType
-&gt; ScalarTypeBase (DimDecl VName) Aliasing
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; PatType -&gt; RetTypeBase (DimDecl VName) Aliasing
forall dim as. [VName] -&gt; TypeBase dim as -&gt; RetTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-var">RetType</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; PatType) -&gt; PatType -&gt; PatType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-662"></span><span>            </span><span class="annot"><span class="annottext">ScalarTypeBase (DimDecl VName) Aliasing -&gt; PatType
forall dim as. ScalarTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-var">Scalar</span></a></span><span> </span><span class="annot"><span class="annottext">(ScalarTypeBase (DimDecl VName) Aliasing -&gt; PatType)
-&gt; ScalarTypeBase (DimDecl VName) Aliasing -&gt; PatType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Aliasing
-&gt; PName
-&gt; PatType
-&gt; RetTypeBase (DimDecl VName) Aliasing
-&gt; ScalarTypeBase (DimDecl VName) Aliasing
forall dim as.
as
-&gt; PName
-&gt; TypeBase dim as
-&gt; RetTypeBase dim as
-&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Arrow"><span class="hs-identifier hs-var">Arrow</span></a></span><span> </span><span class="annot"><span class="annottext">Aliasing
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">PName
</span><a href="Language.Futhark.Syntax.html#Unnamed"><span class="hs-identifier hs-var">Unnamed</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684556098"><span class="hs-identifier hs-var">argtype</span></a></span><span> </span><span class="annot"><span class="annottext">(RetTypeBase (DimDecl VName) Aliasing
 -&gt; ScalarTypeBase (DimDecl VName) Aliasing)
-&gt; RetTypeBase (DimDecl VName) Aliasing
-&gt; ScalarTypeBase (DimDecl VName) Aliasing
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; PatType -&gt; RetTypeBase (DimDecl VName) Aliasing
forall dim as. [VName] -&gt; TypeBase dim as -&gt; RetTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-var">RetType</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; RetTypeBase (DimDecl VName) Aliasing)
-&gt; PatType -&gt; RetTypeBase (DimDecl VName) Aliasing
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ScalarTypeBase (DimDecl VName) Aliasing -&gt; PatType
forall dim as. ScalarTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-var">Scalar</span></a></span><span> </span><span class="annot"><span class="annottext">(ScalarTypeBase (DimDecl VName) Aliasing -&gt; PatType)
-&gt; ScalarTypeBase (DimDecl VName) Aliasing -&gt; PatType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; ScalarTypeBase (DimDecl VName) Aliasing
forall dim as. PrimType -&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Language.Futhark.Syntax.html#Bool"><span class="hs-identifier hs-var">Bool</span></a></span><span>
</span><span id="line-663"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#OverloadedF"><span class="hs-identifier hs-type">OverloadedF</span></a></span><span> </span><span id="local-6989586621684556092"><span class="annot"><span class="annottext">[PrimType]
</span><a href="#local-6989586621684556092"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span id="local-6989586621684556091"><span class="annot"><span class="annottext">[Maybe PrimType]
</span><a href="#local-6989586621684556091"><span class="hs-identifier hs-var">pts</span></a></span></span><span> </span><span id="local-6989586621684556090"><span class="annot"><span class="annottext">Maybe PrimType
</span><a href="#local-6989586621684556090"><span class="hs-identifier hs-var">rt</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-664"></span><span>        </span><span id="local-6989586621684556089"><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684556089"><span class="hs-identifier hs-var">argtype</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SrcLoc -&gt; Name -&gt; TermTypeM StructType
forall (m :: * -&gt; *) als dim.
(MonadUnify m, Monoid als) =&gt;
SrcLoc -&gt; Name -&gt; m (TypeBase dim als)
</span><a href="Language.Futhark.TypeChecker.Unify.html#newTypeVar"><span class="hs-identifier hs-var">newTypeVar</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684556119"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-string">&quot;t&quot;</span></span><span>
</span><span id="line-665"></span><span>        </span><span class="annot"><span class="annottext">[PrimType] -&gt; Usage -&gt; StructType -&gt; TermTypeM ()
forall (m :: * -&gt; *).
MonadUnify m =&gt;
[PrimType] -&gt; Usage -&gt; StructType -&gt; m ()
</span><a href="Language.Futhark.TypeChecker.Unify.html#mustBeOneOf"><span class="hs-identifier hs-var">mustBeOneOf</span></a></span><span> </span><span class="annot"><span class="annottext">[PrimType]
</span><a href="#local-6989586621684556092"><span class="hs-identifier hs-var">ts</span></a></span><span> </span><span class="annot"><span class="annottext">Usage
</span><a href="#local-6989586621684556108"><span class="hs-identifier hs-var">usage</span></a></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684556089"><span class="hs-identifier hs-var">argtype</span></a></span><span>
</span><span id="line-666"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684556087"><span class="annot"><span class="annottext">[StructType]
</span><a href="#local-6989586621684556087"><span class="hs-identifier hs-var">pts'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684556086"><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684556086"><span class="hs-identifier hs-var">rt'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StructType
-&gt; [Maybe PrimType] -&gt; Maybe PrimType -&gt; ([StructType], StructType)
forall {dim} {as}.
TypeBase dim as
-&gt; [Maybe PrimType]
-&gt; Maybe PrimType
-&gt; ([TypeBase dim ()], TypeBase dim ())
</span><a href="#local-6989586621684556085"><span class="hs-identifier hs-var">instOverloaded</span></a></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684556089"><span class="hs-identifier hs-var">argtype</span></a></span><span> </span><span class="annot"><span class="annottext">[Maybe PrimType]
</span><a href="#local-6989586621684556091"><span class="hs-identifier hs-var">pts</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe PrimType
</span><a href="#local-6989586621684556090"><span class="hs-identifier hs-var">rt</span></a></span><span>
</span><span id="line-667"></span><span>            </span><span id="local-6989586621684556082"><span class="annot"><span class="annottext">arrow :: TypeBase dim as -&gt; TypeBase dim as -&gt; TypeBase dim as
</span><a href="#local-6989586621684556082"><span class="hs-identifier hs-var hs-var">arrow</span></a></span></span><span> </span><span id="local-6989586621684556081"><span class="annot"><span class="annottext">TypeBase dim as
</span><a href="#local-6989586621684556081"><span class="hs-identifier hs-var">xt</span></a></span></span><span> </span><span id="local-6989586621684556080"><span class="annot"><span class="annottext">TypeBase dim as
</span><a href="#local-6989586621684556080"><span class="hs-identifier hs-var">yt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScalarTypeBase dim as -&gt; TypeBase dim as
forall dim as. ScalarTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-var">Scalar</span></a></span><span> </span><span class="annot"><span class="annottext">(ScalarTypeBase dim as -&gt; TypeBase dim as)
-&gt; ScalarTypeBase dim as -&gt; TypeBase dim as
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">as
-&gt; PName
-&gt; TypeBase dim as
-&gt; RetTypeBase dim as
-&gt; ScalarTypeBase dim as
forall dim as.
as
-&gt; PName
-&gt; TypeBase dim as
-&gt; RetTypeBase dim as
-&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Arrow"><span class="hs-identifier hs-var">Arrow</span></a></span><span> </span><span class="annot"><span class="annottext">as
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">PName
</span><a href="Language.Futhark.Syntax.html#Unnamed"><span class="hs-identifier hs-var">Unnamed</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase dim as
</span><a href="#local-6989586621684556081"><span class="hs-identifier hs-var">xt</span></a></span><span> </span><span class="annot"><span class="annottext">(RetTypeBase dim as -&gt; ScalarTypeBase dim as)
-&gt; RetTypeBase dim as -&gt; ScalarTypeBase dim as
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; TypeBase dim as -&gt; RetTypeBase dim as
forall dim as. [VName] -&gt; TypeBase dim as -&gt; RetTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-var">RetType</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">TypeBase dim as
</span><a href="#local-6989586621684556080"><span class="hs-identifier hs-var">yt</span></a></span><span>
</span><span id="line-668"></span><span>        </span><span class="annot"><span class="annottext">PatType -&gt; TermTypeM PatType
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; TermTypeM PatType) -&gt; PatType -&gt; TermTypeM PatType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">StructType -&gt; PatType
forall dim as. TypeBase dim as -&gt; TypeBase dim Aliasing
</span><a href="Language.Futhark.Prop.html#fromStruct"><span class="hs-identifier hs-var">fromStruct</span></a></span><span> </span><span class="annot"><span class="annottext">(StructType -&gt; PatType) -&gt; StructType -&gt; PatType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(StructType -&gt; StructType -&gt; StructType)
-&gt; StructType -&gt; [StructType] -&gt; StructType
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldr</span></span><span> </span><span class="annot"><span class="annottext">StructType -&gt; StructType -&gt; StructType
forall {as} {dim}.
Monoid as =&gt;
TypeBase dim as -&gt; TypeBase dim as -&gt; TypeBase dim as
</span><a href="#local-6989586621684556082"><span class="hs-identifier hs-var">arrow</span></a></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684556086"><span class="hs-identifier hs-var">rt'</span></a></span><span> </span><span class="annot"><span class="annottext">[StructType]
</span><a href="#local-6989586621684556087"><span class="hs-identifier hs-var">pts'</span></a></span><span>
</span><span id="line-669"></span><span>
</span><span id="line-670"></span><span>    </span><span class="annot"><span class="annottext">Ident -&gt; TermTypeM ()
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#observe"><span class="hs-identifier hs-var">observe</span></a></span><span> </span><span class="annot"><span class="annottext">(Ident -&gt; TermTypeM ()) -&gt; Ident -&gt; TermTypeM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Info PatType -&gt; SrcLoc -&gt; Ident
forall (f :: * -&gt; *) vn.
vn -&gt; f PatType -&gt; SrcLoc -&gt; IdentBase f vn
</span><a href="Language.Futhark.Syntax.html#Ident"><span class="hs-identifier hs-var">Ident</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684556113"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatType -&gt; Info PatType
forall a. a -&gt; Info a
</span><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-var">Info</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684556105"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684556119"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-671"></span><span>    </span><span class="annot"><span class="annottext">(QualName VName, PatType) -&gt; TermTypeM (QualName VName, PatType)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684556115"><span class="hs-identifier hs-var">qn'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684556105"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-672"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-673"></span><span>      </span><span id="local-6989586621684556085"><span class="annot"><span class="annottext">instOverloaded :: TypeBase dim as
-&gt; [Maybe PrimType]
-&gt; Maybe PrimType
-&gt; ([TypeBase dim ()], TypeBase dim ())
</span><a href="#local-6989586621684556085"><span class="hs-identifier hs-var hs-var">instOverloaded</span></a></span></span><span> </span><span id="local-6989586621684556076"><span class="annot"><span class="annottext">TypeBase dim as
</span><a href="#local-6989586621684556076"><span class="hs-identifier hs-var">argtype</span></a></span></span><span> </span><span id="local-6989586621684556075"><span class="annot"><span class="annottext">[Maybe PrimType]
</span><a href="#local-6989586621684556075"><span class="hs-identifier hs-var">pts</span></a></span></span><span> </span><span id="local-6989586621684556074"><span class="annot"><span class="annottext">Maybe PrimType
</span><a href="#local-6989586621684556074"><span class="hs-identifier hs-var">rt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-674"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">(Maybe PrimType -&gt; TypeBase dim ())
-&gt; [Maybe PrimType] -&gt; [TypeBase dim ()]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeBase dim ()
-&gt; (PrimType -&gt; TypeBase dim ())
-&gt; Maybe PrimType
-&gt; TypeBase dim ()
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeBase dim as -&gt; TypeBase dim ()
forall dim as. TypeBase dim as -&gt; TypeBase dim ()
</span><a href="Language.Futhark.Prop.html#toStruct"><span class="hs-identifier hs-var">toStruct</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase dim as
</span><a href="#local-6989586621684556076"><span class="hs-identifier hs-var">argtype</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScalarTypeBase dim () -&gt; TypeBase dim ()
forall dim as. ScalarTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-var">Scalar</span></a></span><span> </span><span class="annot"><span class="annottext">(ScalarTypeBase dim () -&gt; TypeBase dim ())
-&gt; (PrimType -&gt; ScalarTypeBase dim ())
-&gt; PrimType
-&gt; TypeBase dim ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; ScalarTypeBase dim ()
forall dim as. PrimType -&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Maybe PrimType]
</span><a href="#local-6989586621684556075"><span class="hs-identifier hs-var">pts</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-675"></span><span>          </span><span class="annot"><span class="annottext">TypeBase dim ()
-&gt; (PrimType -&gt; TypeBase dim ())
-&gt; Maybe PrimType
-&gt; TypeBase dim ()
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeBase dim as -&gt; TypeBase dim ()
forall dim as. TypeBase dim as -&gt; TypeBase dim ()
</span><a href="Language.Futhark.Prop.html#toStruct"><span class="hs-identifier hs-var">toStruct</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase dim as
</span><a href="#local-6989586621684556076"><span class="hs-identifier hs-var">argtype</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScalarTypeBase dim () -&gt; TypeBase dim ()
forall dim as. ScalarTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-var">Scalar</span></a></span><span> </span><span class="annot"><span class="annottext">(ScalarTypeBase dim () -&gt; TypeBase dim ())
-&gt; (PrimType -&gt; ScalarTypeBase dim ())
-&gt; PrimType
-&gt; TypeBase dim ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; ScalarTypeBase dim ()
forall dim as. PrimType -&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe PrimType
</span><a href="#local-6989586621684556074"><span class="hs-identifier hs-var">rt</span></a></span><span>
</span><span id="line-676"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-677"></span><span>
</span><span id="line-678"></span><span>  </span><span id="local-6989586621684556067"><span class="annot"><span class="annottext">checkNamedDim :: SrcLoc -&gt; QualName Name -&gt; TermTypeM (QualName VName)
</span><a href="Language.Futhark.TypeChecker.Monad.html#checkNamedDim"><span class="hs-identifier hs-var hs-var hs-var hs-var">checkNamedDim</span></a></span></span><span> </span><span id="local-6989586621684556065"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684556065"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span id="local-6989586621684556064"><span class="annot"><span class="annottext">QualName Name
</span><a href="#local-6989586621684556064"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-679"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684556063"><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684556063"><span class="hs-identifier hs-var">v'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684556062"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684556062"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SrcLoc -&gt; QualName Name -&gt; TermTypeM (QualName VName, PatType)
forall (m :: * -&gt; *).
MonadTypeChecker m =&gt;
SrcLoc -&gt; QualName Name -&gt; m (QualName VName, PatType)
</span><a href="Language.Futhark.TypeChecker.Monad.html#lookupVar"><span class="hs-identifier hs-var">lookupVar</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684556065"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">QualName Name
</span><a href="#local-6989586621684556064"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-680"></span><span>    </span><span class="annot"><span class="annottext">Checking -&gt; TermTypeM () -&gt; TermTypeM ()
forall a. Checking -&gt; TermTypeM a -&gt; TermTypeM a
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#onFailure"><span class="hs-identifier hs-var">onFailure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[StructType] -&gt; StructType -&gt; Checking
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#CheckingRequired"><span class="hs-identifier hs-var">CheckingRequired</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">ScalarTypeBase (DimDecl VName) () -&gt; StructType
forall dim as. ScalarTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-var">Scalar</span></a></span><span> </span><span class="annot"><span class="annottext">(ScalarTypeBase (DimDecl VName) () -&gt; StructType)
-&gt; ScalarTypeBase (DimDecl VName) () -&gt; StructType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; ScalarTypeBase (DimDecl VName) ()
forall dim as. PrimType -&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimType -&gt; ScalarTypeBase (DimDecl VName) ())
-&gt; PrimType -&gt; ScalarTypeBase (DimDecl VName) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IntType -&gt; PrimType
</span><a href="Language.Futhark.Syntax.html#Signed"><span class="hs-identifier hs-var">Signed</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatType -&gt; StructType
forall dim as. TypeBase dim as -&gt; TypeBase dim ()
</span><a href="Language.Futhark.Prop.html#toStruct"><span class="hs-identifier hs-var">toStruct</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684556062"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TermTypeM () -&gt; TermTypeM ()) -&gt; TermTypeM () -&gt; TermTypeM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-681"></span><span>      </span><span class="annot"><span class="annottext">Usage -&gt; StructType -&gt; StructType -&gt; TermTypeM ()
forall (m :: * -&gt; *).
MonadUnify m =&gt;
Usage -&gt; StructType -&gt; StructType -&gt; m ()
</span><a href="Language.Futhark.TypeChecker.Unify.html#unify"><span class="hs-identifier hs-var">unify</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SrcLoc -&gt; [Char] -&gt; Usage
</span><a href="Language.Futhark.TypeChecker.Unify.html#mkUsage"><span class="hs-identifier hs-var">mkUsage</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684556065"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;use as array size&quot;</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatType -&gt; StructType
forall dim as. TypeBase dim as -&gt; TypeBase dim ()
</span><a href="Language.Futhark.Prop.html#toStruct"><span class="hs-identifier hs-var">toStruct</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684556062"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(StructType -&gt; TermTypeM ()) -&gt; StructType -&gt; TermTypeM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-682"></span><span>        </span><span class="annot"><span class="annottext">ScalarTypeBase (DimDecl VName) () -&gt; StructType
forall dim as. ScalarTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-var">Scalar</span></a></span><span> </span><span class="annot"><span class="annottext">(ScalarTypeBase (DimDecl VName) () -&gt; StructType)
-&gt; ScalarTypeBase (DimDecl VName) () -&gt; StructType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; ScalarTypeBase (DimDecl VName) ()
forall dim as. PrimType -&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimType -&gt; ScalarTypeBase (DimDecl VName) ())
-&gt; PrimType -&gt; ScalarTypeBase (DimDecl VName) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IntType -&gt; PrimType
</span><a href="Language.Futhark.Syntax.html#Signed"><span class="hs-identifier hs-var">Signed</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span>
</span><span id="line-683"></span><span>    </span><span class="annot"><span class="annottext">QualName VName -&gt; TermTypeM (QualName VName)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684556063"><span class="hs-identifier hs-var">v'</span></a></span><span>
</span><span id="line-684"></span><span>
</span><span id="line-685"></span><span>  </span><span id="local-6989586621684556049"><span class="annot"><span class="annottext">typeError :: forall loc a. Located loc =&gt; loc -&gt; Notes -&gt; Doc -&gt; TermTypeM a
</span><a href="#local-6989586621684556049"><span class="hs-identifier hs-var hs-var hs-var hs-var">typeError</span></a></span></span><span> </span><span id="local-6989586621684556048"><span class="annot"><span class="annottext">loc
</span><a href="#local-6989586621684556048"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span id="local-6989586621684556047"><span class="annot"><span class="annottext">Notes
</span><a href="#local-6989586621684556047"><span class="hs-identifier hs-var">notes</span></a></span></span><span> </span><span id="local-6989586621684556046"><span class="annot"><span class="annottext">Doc
</span><a href="#local-6989586621684556046"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-686"></span><span>    </span><span id="local-6989586621684556045"><span class="annot"><span class="annottext">Maybe Checking
</span><a href="#local-6989586621684556045"><span class="hs-identifier hs-var">checking</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TermEnv -&gt; Maybe Checking) -&gt; TermTypeM (Maybe Checking)
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">TermEnv -&gt; Maybe Checking
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#termChecking"><span class="hs-identifier hs-var hs-var">termChecking</span></a></span><span>
</span><span id="line-687"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Checking
</span><a href="#local-6989586621684556045"><span class="hs-identifier hs-var">checking</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-688"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684556044"><span class="annot"><span class="annottext">Checking
</span><a href="#local-6989586621684556044"><span class="hs-identifier hs-var">checking'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-689"></span><span>        </span><span class="annot"><span class="annottext">TypeError -&gt; TermTypeM a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(TypeError -&gt; TermTypeM a) -&gt; TypeError -&gt; TermTypeM a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc -&gt; Notes -&gt; Doc -&gt; TypeError
</span><a href="Language.Futhark.TypeChecker.Monad.html#TypeError"><span class="hs-identifier hs-var">TypeError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">loc -&gt; SrcLoc
forall a. Located a =&gt; a -&gt; SrcLoc
</span><span class="hs-identifier hs-var">srclocOf</span></span><span> </span><span class="annot"><span class="annottext">loc
</span><a href="#local-6989586621684556048"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Notes
</span><a href="#local-6989586621684556047"><span class="hs-identifier hs-var">notes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Checking -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">Checking
</span><a href="#local-6989586621684556044"><span class="hs-identifier hs-var">checking'</span></a></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-identifier hs-var">line</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><a href="#local-6989586621684556046"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-690"></span><span>      </span><span class="annot"><span class="annottext">Maybe Checking
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-691"></span><span>        </span><span class="annot"><span class="annottext">TypeError -&gt; TermTypeM a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(TypeError -&gt; TermTypeM a) -&gt; TypeError -&gt; TermTypeM a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc -&gt; Notes -&gt; Doc -&gt; TypeError
</span><a href="Language.Futhark.TypeChecker.Monad.html#TypeError"><span class="hs-identifier hs-var">TypeError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">loc -&gt; SrcLoc
forall a. Located a =&gt; a -&gt; SrcLoc
</span><span class="hs-identifier hs-var">srclocOf</span></span><span> </span><span class="annot"><span class="annottext">loc
</span><a href="#local-6989586621684556048"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Notes
</span><a href="#local-6989586621684556047"><span class="hs-identifier hs-var">notes</span></a></span><span> </span><span class="annot"><span class="annottext">Doc
</span><a href="#local-6989586621684556046"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-692"></span><span>
</span><span id="line-693"></span><span id="local-6989586621684557721"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#onFailure"><span class="hs-identifier hs-type">onFailure</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Checking"><span class="hs-identifier hs-type">Checking</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684557721"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684557721"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-694"></span><span id="onFailure"><span class="annot"><span class="annottext">onFailure :: forall a. Checking -&gt; TermTypeM a -&gt; TermTypeM a
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#onFailure"><span class="hs-identifier hs-var hs-var">onFailure</span></a></span></span><span> </span><span id="local-6989586621684556042"><span class="annot"><span class="annottext">Checking
</span><a href="#local-6989586621684556042"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TermEnv -&gt; TermEnv) -&gt; TermTypeM a -&gt; TermTypeM a
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; r) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">local</span></span><span> </span><span class="annot"><span class="annottext">((TermEnv -&gt; TermEnv) -&gt; TermTypeM a -&gt; TermTypeM a)
-&gt; (TermEnv -&gt; TermEnv) -&gt; TermTypeM a -&gt; TermTypeM a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684556041"><span class="annot"><span class="annottext">TermEnv
</span><a href="#local-6989586621684556041"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TermEnv
</span><a href="#local-6989586621684556041"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">termChecking :: Maybe Checking
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#termChecking"><span class="hs-identifier hs-var">termChecking</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Checking -&gt; Maybe Checking
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Checking
</span><a href="#local-6989586621684556042"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-695"></span><span>
</span><span id="line-696"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#extSize"><span class="hs-identifier hs-type">extSize</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SrcLoc</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#SizeSource"><span class="hs-identifier hs-type">SizeSource</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#DimDecl"><span class="hs-identifier hs-type">DimDecl</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-697"></span><span id="extSize"><span class="annot"><span class="annottext">extSize :: SrcLoc -&gt; SizeSource -&gt; TermTypeM (DimDecl VName, Maybe VName)
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#extSize"><span class="hs-identifier hs-var hs-var">extSize</span></a></span></span><span> </span><span id="local-6989586621684556040"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684556040"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span id="local-6989586621684556039"><span class="annot"><span class="annottext">SizeSource
</span><a href="#local-6989586621684556039"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-698"></span><span>  </span><span id="local-6989586621684556038"><span class="annot"><span class="annottext">Maybe VName
</span><a href="#local-6989586621684556038"><span class="hs-identifier hs-var">prev</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TermTypeState -&gt; Maybe VName) -&gt; TermTypeM (Maybe VName)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">((TermTypeState -&gt; Maybe VName) -&gt; TermTypeM (Maybe VName))
-&gt; (TermTypeState -&gt; Maybe VName) -&gt; TermTypeM (Maybe VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SizeSource -&gt; Map SizeSource VName -&gt; Maybe VName
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">SizeSource
</span><a href="#local-6989586621684556039"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">(Map SizeSource VName -&gt; Maybe VName)
-&gt; (TermTypeState -&gt; Map SizeSource VName)
-&gt; TermTypeState
-&gt; Maybe VName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TermTypeState -&gt; Map SizeSource VName
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#stateDimTable"><span class="hs-identifier hs-var hs-var">stateDimTable</span></a></span><span>
</span><span id="line-699"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe VName
</span><a href="#local-6989586621684556038"><span class="hs-identifier hs-var">prev</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-700"></span><span>    </span><span class="annot"><span class="annottext">Maybe VName
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-701"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684556030"><span class="annot"><span class="annottext">rsrc :: RigidSource
</span><a href="#local-6989586621684556030"><span class="hs-identifier hs-var hs-var">rsrc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SizeSource
</span><a href="#local-6989586621684556039"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-702"></span><span>            </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#SourceArg"><span class="hs-identifier hs-type">SourceArg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#FName"><span class="hs-identifier hs-type">FName</span></a></span><span> </span><span id="local-6989586621684556029"><span class="annot"><span class="annottext">Maybe (QualName VName)
</span><a href="#local-6989586621684556029"><span class="hs-identifier hs-var">fname</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684556028"><span class="annot"><span class="annottext">ExpBase NoInfo VName
</span><a href="#local-6989586621684556028"><span class="hs-identifier hs-var">e'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-703"></span><span>              </span><span class="annot"><span class="annottext">Maybe (QualName VName) -&gt; [Char] -&gt; RigidSource
</span><a href="Language.Futhark.TypeChecker.Unify.html#RigidArg"><span class="hs-identifier hs-var">RigidArg</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (QualName VName)
</span><a href="#local-6989586621684556029"><span class="hs-identifier hs-var">fname</span></a></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; RigidSource) -&gt; [Char] -&gt; RigidSource
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ExpBase NoInfo VName -&gt; [Char]
forall a. Pretty a =&gt; a -&gt; [Char]
</span><a href="Futhark.Util.Pretty.html#prettyOneLine"><span class="hs-identifier hs-var">prettyOneLine</span></a></span><span> </span><span class="annot"><span class="annottext">ExpBase NoInfo VName
</span><a href="#local-6989586621684556028"><span class="hs-identifier hs-var">e'</span></a></span><span>
</span><span id="line-704"></span><span>            </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#SourceBound"><span class="hs-identifier hs-type">SourceBound</span></a></span><span> </span><span id="local-6989586621684556025"><span class="annot"><span class="annottext">ExpBase NoInfo VName
</span><a href="#local-6989586621684556025"><span class="hs-identifier hs-var">e'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-705"></span><span>              </span><span class="annot"><span class="annottext">[Char] -&gt; RigidSource
</span><a href="Language.Futhark.TypeChecker.Unify.html#RigidBound"><span class="hs-identifier hs-var">RigidBound</span></a></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; RigidSource) -&gt; [Char] -&gt; RigidSource
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ExpBase NoInfo VName -&gt; [Char]
forall a. Pretty a =&gt; a -&gt; [Char]
</span><a href="Futhark.Util.Pretty.html#prettyOneLine"><span class="hs-identifier hs-var">prettyOneLine</span></a></span><span> </span><span class="annot"><span class="annottext">ExpBase NoInfo VName
</span><a href="#local-6989586621684556025"><span class="hs-identifier hs-var">e'</span></a></span><span>
</span><span id="line-706"></span><span>            </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#SourceSlice"><span class="hs-identifier hs-type">SourceSlice</span></a></span><span> </span><span id="local-6989586621684556023"><span class="annot"><span class="annottext">Maybe (DimDecl VName)
</span><a href="#local-6989586621684556023"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span id="local-6989586621684556022"><span class="annot"><span class="annottext">Maybe (ExpBase NoInfo VName)
</span><a href="#local-6989586621684556022"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621684556021"><span class="annot"><span class="annottext">Maybe (ExpBase NoInfo VName)
</span><a href="#local-6989586621684556021"><span class="hs-identifier hs-var">j</span></a></span></span><span> </span><span id="local-6989586621684556020"><span class="annot"><span class="annottext">Maybe (ExpBase NoInfo VName)
</span><a href="#local-6989586621684556020"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-707"></span><span>              </span><span class="annot"><span class="annottext">Maybe (DimDecl VName) -&gt; [Char] -&gt; RigidSource
</span><a href="Language.Futhark.TypeChecker.Unify.html#RigidSlice"><span class="hs-identifier hs-var">RigidSlice</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (DimDecl VName)
</span><a href="#local-6989586621684556023"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; RigidSource) -&gt; [Char] -&gt; RigidSource
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DimIndexBase NoInfo VName -&gt; [Char]
forall a. Pretty a =&gt; a -&gt; [Char]
</span><a href="Futhark.Util.Pretty.html#prettyOneLine"><span class="hs-identifier hs-var">prettyOneLine</span></a></span><span> </span><span class="annot"><span class="annottext">(DimIndexBase NoInfo VName -&gt; [Char])
-&gt; DimIndexBase NoInfo VName -&gt; [Char]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (ExpBase NoInfo VName)
-&gt; Maybe (ExpBase NoInfo VName)
-&gt; Maybe (ExpBase NoInfo VName)
-&gt; DimIndexBase NoInfo VName
forall (f :: * -&gt; *) vn.
Maybe (ExpBase f vn)
-&gt; Maybe (ExpBase f vn)
-&gt; Maybe (ExpBase f vn)
-&gt; DimIndexBase f vn
</span><a href="Language.Futhark.Syntax.html#DimSlice"><span class="hs-identifier hs-var">DimSlice</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (ExpBase NoInfo VName)
</span><a href="#local-6989586621684556022"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (ExpBase NoInfo VName)
</span><a href="#local-6989586621684556021"><span class="hs-identifier hs-var">j</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (ExpBase NoInfo VName)
</span><a href="#local-6989586621684556020"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-708"></span><span>      </span><span id="local-6989586621684556017"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684556017"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SrcLoc -&gt; Rigidity -&gt; Name -&gt; TermTypeM VName
forall (m :: * -&gt; *).
MonadUnify m =&gt;
SrcLoc -&gt; Rigidity -&gt; Name -&gt; m VName
</span><a href="Language.Futhark.TypeChecker.Unify.html#newDimVar"><span class="hs-identifier hs-var">newDimVar</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684556040"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RigidSource -&gt; Rigidity
</span><a href="Language.Futhark.TypeChecker.Unify.html#Rigid"><span class="hs-identifier hs-var">Rigid</span></a></span><span> </span><span class="annot"><span class="annottext">RigidSource
</span><a href="#local-6989586621684556030"><span class="hs-identifier hs-var">rsrc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-string">&quot;n&quot;</span></span><span>
</span><span id="line-709"></span><span>      </span><span class="annot"><span class="annottext">(TermTypeState -&gt; TermTypeState) -&gt; TermTypeM ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((TermTypeState -&gt; TermTypeState) -&gt; TermTypeM ())
-&gt; (TermTypeState -&gt; TermTypeState) -&gt; TermTypeM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684556016"><span class="annot"><span class="annottext">TermTypeState
</span><a href="#local-6989586621684556016"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TermTypeState
</span><a href="#local-6989586621684556016"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">stateDimTable :: Map SizeSource VName
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#stateDimTable"><span class="hs-identifier hs-var">stateDimTable</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SizeSource -&gt; VName -&gt; Map SizeSource VName -&gt; Map SizeSource VName
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">SizeSource
</span><a href="#local-6989586621684556039"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684556017"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">(Map SizeSource VName -&gt; Map SizeSource VName)
-&gt; Map SizeSource VName -&gt; Map SizeSource VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TermTypeState -&gt; Map SizeSource VName
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#stateDimTable"><span class="hs-identifier hs-var hs-var">stateDimTable</span></a></span><span> </span><span class="annot"><span class="annottext">TermTypeState
</span><a href="#local-6989586621684556016"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-710"></span><span>      </span><span class="annot"><span class="annottext">(DimDecl VName, Maybe VName)
-&gt; TermTypeM (DimDecl VName, Maybe VName)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-711"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">QualName VName -&gt; DimDecl VName
forall vn. QualName vn -&gt; DimDecl vn
</span><a href="Language.Futhark.Syntax.html#NamedDim"><span class="hs-identifier hs-var">NamedDim</span></a></span><span> </span><span class="annot"><span class="annottext">(QualName VName -&gt; DimDecl VName)
-&gt; QualName VName -&gt; DimDecl VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; QualName VName
forall v. v -&gt; QualName v
</span><a href="Language.Futhark.Prop.html#qualName"><span class="hs-identifier hs-var">qualName</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684556017"><span class="hs-identifier hs-var">d</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-712"></span><span>          </span><span class="annot"><span class="annottext">VName -&gt; Maybe VName
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684556017"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-713"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-714"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684556015"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684556015"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-715"></span><span>      </span><span class="annot"><span class="annottext">(DimDecl VName, Maybe VName)
-&gt; TermTypeM (DimDecl VName, Maybe VName)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-716"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">QualName VName -&gt; DimDecl VName
forall vn. QualName vn -&gt; DimDecl vn
</span><a href="Language.Futhark.Syntax.html#NamedDim"><span class="hs-identifier hs-var">NamedDim</span></a></span><span> </span><span class="annot"><span class="annottext">(QualName VName -&gt; DimDecl VName)
-&gt; QualName VName -&gt; DimDecl VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; QualName VName
forall v. v -&gt; QualName v
</span><a href="Language.Futhark.Prop.html#qualName"><span class="hs-identifier hs-var">qualName</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684556015"><span class="hs-identifier hs-var">d</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-717"></span><span>          </span><span class="annot"><span class="annottext">VName -&gt; Maybe VName
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684556015"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-718"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-719"></span><span>
</span><span id="line-720"></span><span id="local-6989586621684557710"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#incLevel"><span class="hs-identifier hs-type">incLevel</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684557710"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684557710"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-721"></span><span id="incLevel"><span class="annot"><span class="annottext">incLevel :: forall a. TermTypeM a -&gt; TermTypeM a
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#incLevel"><span class="hs-identifier hs-var hs-var">incLevel</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TermEnv -&gt; TermEnv) -&gt; TermTypeM a -&gt; TermTypeM a
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; r) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">local</span></span><span> </span><span class="annot"><span class="annottext">((TermEnv -&gt; TermEnv) -&gt; TermTypeM a -&gt; TermTypeM a)
-&gt; (TermEnv -&gt; TermEnv) -&gt; TermTypeM a -&gt; TermTypeM a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684556011"><span class="annot"><span class="annottext">TermEnv
</span><a href="#local-6989586621684556011"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TermEnv
</span><a href="#local-6989586621684556011"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">termLevel :: Int
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#termLevel"><span class="hs-identifier hs-var">termLevel</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TermEnv -&gt; Int
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#termLevel"><span class="hs-identifier hs-var hs-var">termLevel</span></a></span><span> </span><span class="annot"><span class="annottext">TermEnv
</span><a href="#local-6989586621684556011"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">}</span><span>
</span><span id="line-722"></span><span>
</span><span id="line-723"></span><span class="hs-comment">-- | Get the type of an expression, with top level type variables</span><span>
</span><span id="line-724"></span><span class="hs-comment">-- substituted.  Never call 'typeOf' directly (except in a few</span><span>
</span><span id="line-725"></span><span class="hs-comment">-- carefully inspected locations)!</span><span>
</span><span id="line-726"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#expType"><span class="hs-identifier hs-type">expType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#PatType"><span class="hs-identifier hs-type">PatType</span></a></span><span>
</span><span id="line-727"></span><span id="expType"><span class="annot"><span class="annottext">expType :: Exp -&gt; TermTypeM PatType
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#expType"><span class="hs-identifier hs-var hs-var">expType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatType -&gt; TermTypeM PatType
forall (m :: * -&gt; *). MonadUnify m =&gt; PatType -&gt; m PatType
</span><a href="Language.Futhark.TypeChecker.Unify.html#normPatType"><span class="hs-identifier hs-var">normPatType</span></a></span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; TermTypeM PatType)
-&gt; (Exp -&gt; PatType) -&gt; Exp -&gt; TermTypeM PatType
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; PatType
</span><a href="Language.Futhark.Prop.html#typeOf"><span class="hs-identifier hs-var">typeOf</span></a></span><span>
</span><span id="line-728"></span><span>
</span><span id="line-729"></span><span class="hs-comment">-- | Get the type of an expression, with all type variables</span><span>
</span><span id="line-730"></span><span class="hs-comment">-- substituted.  Slower than 'expType', but sometimes necessary.</span><span>
</span><span id="line-731"></span><span class="hs-comment">-- Never call 'typeOf' directly (except in a few carefully inspected</span><span>
</span><span id="line-732"></span><span class="hs-comment">-- locations)!</span><span>
</span><span id="line-733"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#expTypeFully"><span class="hs-identifier hs-type">expTypeFully</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#PatType"><span class="hs-identifier hs-type">PatType</span></a></span><span>
</span><span id="line-734"></span><span id="expTypeFully"><span class="annot"><span class="annottext">expTypeFully :: Exp -&gt; TermTypeM PatType
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#expTypeFully"><span class="hs-identifier hs-var hs-var">expTypeFully</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatType -&gt; TermTypeM PatType
forall a (m :: * -&gt; *). (Substitutable a, MonadUnify m) =&gt; a -&gt; m a
</span><a href="Language.Futhark.TypeChecker.Unify.html#normTypeFully"><span class="hs-identifier hs-var">normTypeFully</span></a></span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; TermTypeM PatType)
-&gt; (Exp -&gt; PatType) -&gt; Exp -&gt; TermTypeM PatType
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; PatType
</span><a href="Language.Futhark.Prop.html#typeOf"><span class="hs-identifier hs-var">typeOf</span></a></span><span>
</span><span id="line-735"></span><span>
</span><span id="line-736"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#newArrayType"><span class="hs-identifier hs-type">newArrayType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SrcLoc</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#StructType"><span class="hs-identifier hs-type">StructType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#StructType"><span class="hs-identifier hs-type">StructType</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-737"></span><span id="newArrayType"><span class="annot"><span class="annottext">newArrayType :: SrcLoc -&gt; Name -&gt; Int -&gt; TermTypeM (StructType, StructType)
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#newArrayType"><span class="hs-identifier hs-var hs-var">newArrayType</span></a></span></span><span> </span><span id="local-6989586621684556007"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684556007"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span id="local-6989586621684556006"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684556006"><span class="hs-identifier hs-var">desc</span></a></span></span><span> </span><span id="local-6989586621684556005"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684556005"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-738"></span><span>  </span><span id="local-6989586621684556004"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684556004"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; TermTypeM VName
forall (m :: * -&gt; *). MonadTypeChecker m =&gt; Name -&gt; m VName
</span><a href="Language.Futhark.TypeChecker.Monad.html#newTypeName"><span class="hs-identifier hs-var">newTypeName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684556006"><span class="hs-identifier hs-var">desc</span></a></span><span>
</span><span id="line-739"></span><span>  </span><span class="annot"><span class="annottext">VName -&gt; Constraint -&gt; TermTypeM ()
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#constrain"><span class="hs-identifier hs-var">constrain</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684556004"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">(Constraint -&gt; TermTypeM ()) -&gt; Constraint -&gt; TermTypeM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Liftedness -&gt; Usage -&gt; Constraint
</span><a href="Language.Futhark.TypeChecker.Unify.html#NoConstraint"><span class="hs-identifier hs-var">NoConstraint</span></a></span><span> </span><span class="annot"><span class="annottext">Liftedness
</span><a href="Language.Futhark.Syntax.html#Unlifted"><span class="hs-identifier hs-var">Unlifted</span></a></span><span> </span><span class="annot"><span class="annottext">(Usage -&gt; Constraint) -&gt; Usage -&gt; Constraint
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc -&gt; Usage
</span><a href="Language.Futhark.TypeChecker.Unify.html#mkUsage%27"><span class="hs-identifier hs-var">mkUsage'</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684556007"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-740"></span><span>  </span><span id="local-6989586621684556002"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684556002"><span class="hs-identifier hs-var">dims</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; TermTypeM VName -&gt; TermTypeM [VName]
forall (m :: * -&gt; *) a. Applicative m =&gt; Int -&gt; m a -&gt; m [a]
</span><span class="hs-identifier hs-var">replicateM</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684556005"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">(TermTypeM VName -&gt; TermTypeM [VName])
-&gt; TermTypeM VName -&gt; TermTypeM [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc -&gt; Rigidity -&gt; Name -&gt; TermTypeM VName
forall (m :: * -&gt; *).
MonadUnify m =&gt;
SrcLoc -&gt; Rigidity -&gt; Name -&gt; m VName
</span><a href="Language.Futhark.TypeChecker.Unify.html#newDimVar"><span class="hs-identifier hs-var">newDimVar</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684556007"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">Rigidity
</span><a href="Language.Futhark.TypeChecker.Unify.html#Nonrigid"><span class="hs-identifier hs-var">Nonrigid</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-string">&quot;dim&quot;</span></span><span>
</span><span id="line-741"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684556000"><span class="annot"><span class="annottext">rowt :: ScalarTypeBase dim ()
</span><a href="#local-6989586621684556000"><span class="hs-identifier hs-var hs-var">rowt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">()
-&gt; Uniqueness -&gt; TypeName -&gt; [TypeArg dim] -&gt; ScalarTypeBase dim ()
forall dim as.
as
-&gt; Uniqueness -&gt; TypeName -&gt; [TypeArg dim] -&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#TypeVar"><span class="hs-identifier hs-var">TypeVar</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="Language.Futhark.Core.html#Nonunique"><span class="hs-identifier hs-var">Nonunique</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; TypeName
</span><a href="Language.Futhark.Prop.html#typeName"><span class="hs-identifier hs-var">typeName</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684556004"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-742"></span><span>  </span><span class="annot"><span class="annottext">(StructType, StructType) -&gt; TermTypeM (StructType, StructType)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-743"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">()
-&gt; Uniqueness
-&gt; ScalarTypeBase (DimDecl VName) ()
-&gt; ShapeDecl (DimDecl VName)
-&gt; StructType
forall dim as.
as
-&gt; Uniqueness
-&gt; ScalarTypeBase dim ()
-&gt; ShapeDecl dim
-&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Array"><span class="hs-identifier hs-var">Array</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="Language.Futhark.Core.html#Nonunique"><span class="hs-identifier hs-var">Nonunique</span></a></span><span> </span><span class="annot"><span class="annottext">ScalarTypeBase (DimDecl VName) ()
forall {dim}. ScalarTypeBase dim ()
</span><a href="#local-6989586621684556000"><span class="hs-identifier hs-var">rowt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DimDecl VName] -&gt; ShapeDecl (DimDecl VName)
forall dim. [dim] -&gt; ShapeDecl dim
</span><a href="Language.Futhark.Syntax.html#ShapeDecl"><span class="hs-identifier hs-var">ShapeDecl</span></a></span><span> </span><span class="annot"><span class="annottext">([DimDecl VName] -&gt; ShapeDecl (DimDecl VName))
-&gt; [DimDecl VName] -&gt; ShapeDecl (DimDecl VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; DimDecl VName) -&gt; [VName] -&gt; [DimDecl VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QualName VName -&gt; DimDecl VName
forall vn. QualName vn -&gt; DimDecl vn
</span><a href="Language.Futhark.Syntax.html#NamedDim"><span class="hs-identifier hs-var">NamedDim</span></a></span><span> </span><span class="annot"><span class="annottext">(QualName VName -&gt; DimDecl VName)
-&gt; (VName -&gt; QualName VName) -&gt; VName -&gt; DimDecl VName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; QualName VName
forall v. v -&gt; QualName v
</span><a href="Language.Futhark.Prop.html#qualName"><span class="hs-identifier hs-var">qualName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684556002"><span class="hs-identifier hs-var">dims</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-744"></span><span>      </span><span class="annot"><span class="annottext">ScalarTypeBase (DimDecl VName) () -&gt; StructType
forall dim as. ScalarTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-var">Scalar</span></a></span><span> </span><span class="annot"><span class="annottext">ScalarTypeBase (DimDecl VName) ()
forall {dim}. ScalarTypeBase dim ()
</span><a href="#local-6989586621684556000"><span class="hs-identifier hs-var">rowt</span></a></span><span>
</span><span id="line-745"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-746"></span><span>
</span><span id="line-747"></span><span class="hs-comment">-- | Replace *all* dimensions with distinct fresh size variables.</span><span>
</span><span id="line-748"></span><span id="local-6989586621684557701"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#allDimsFreshInType"><span class="hs-identifier hs-type">allDimsFreshInType</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-749"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">SrcLoc</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-750"></span><span>  </span><span class="annot"><a href="Language.Futhark.TypeChecker.Unify.html#Rigidity"><span class="hs-identifier hs-type">Rigidity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-751"></span><span>  </span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-752"></span><span>  </span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeBase"><span class="hs-identifier hs-type">TypeBase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#DimDecl"><span class="hs-identifier hs-type">DimDecl</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621684557701"><span class="hs-identifier hs-type">als</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-753"></span><span>  </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeBase"><span class="hs-identifier hs-type">TypeBase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#DimDecl"><span class="hs-identifier hs-type">DimDecl</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621684557701"><span class="hs-identifier hs-type">als</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#DimDecl"><span class="hs-identifier hs-type">DimDecl</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-754"></span><span id="allDimsFreshInType"><span class="annot"><span class="annottext">allDimsFreshInType :: forall als.
SrcLoc
-&gt; Rigidity
-&gt; Name
-&gt; TypeBase (DimDecl VName) als
-&gt; TermTypeM
     (TypeBase (DimDecl VName) als, Map VName (DimDecl VName))
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#allDimsFreshInType"><span class="hs-identifier hs-var hs-var">allDimsFreshInType</span></a></span></span><span> </span><span id="local-6989586621684555989"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684555989"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span id="local-6989586621684555988"><span class="annot"><span class="annottext">Rigidity
</span><a href="#local-6989586621684555988"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span id="local-6989586621684555987"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684555987"><span class="hs-identifier hs-var">desc</span></a></span></span><span> </span><span id="local-6989586621684555986"><span class="annot"><span class="annottext">TypeBase (DimDecl VName) als
</span><a href="#local-6989586621684555986"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-755"></span><span>  </span><span class="annot"><span class="annottext">StateT
  (Map VName (DimDecl VName))
  TermTypeM
  (TypeBase (DimDecl VName) als)
-&gt; Map VName (DimDecl VName)
-&gt; TermTypeM
     (TypeBase (DimDecl VName) als, Map VName (DimDecl VName))
forall s (m :: * -&gt; *) a. StateT s m a -&gt; s -&gt; m (a, s)
</span><span class="hs-identifier hs-var hs-var">runStateT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(DimDecl VName
 -&gt; StateT (Map VName (DimDecl VName)) TermTypeM (DimDecl VName))
-&gt; (als -&gt; StateT (Map VName (DimDecl VName)) TermTypeM als)
-&gt; TypeBase (DimDecl VName) als
-&gt; StateT
     (Map VName (DimDecl VName))
     TermTypeM
     (TypeBase (DimDecl VName) als)
forall (t :: * -&gt; * -&gt; *) (f :: * -&gt; *) a c b d.
(Bitraversable t, Applicative f) =&gt;
(a -&gt; f c) -&gt; (b -&gt; f d) -&gt; t a b -&gt; f (t c d)
</span><span class="hs-identifier hs-var">bitraverse</span></span><span> </span><span class="annot"><span class="annottext">DimDecl VName
-&gt; StateT (Map VName (DimDecl VName)) TermTypeM (DimDecl VName)
forall {t :: (* -&gt; *) -&gt; * -&gt; *} {m :: * -&gt; *} {a}.
(MonadTrans t, MonadUnify m, MonadState (Map VName a) (t m)) =&gt;
a -&gt; t m (DimDecl VName)
</span><a href="#local-6989586621684555983"><span class="hs-identifier hs-var">onDim</span></a></span><span> </span><span class="annot"><span class="annottext">als -&gt; StateT (Map VName (DimDecl VName)) TermTypeM als
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) als
</span><a href="#local-6989586621684555986"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map VName (DimDecl VName)
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-756"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-757"></span><span>    </span><span id="local-6989586621684555983"><span class="annot"><span class="annottext">onDim :: a -&gt; t m (DimDecl VName)
</span><a href="#local-6989586621684555983"><span class="hs-identifier hs-var hs-var">onDim</span></a></span></span><span> </span><span id="local-6989586621684555965"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684555965"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-758"></span><span>      </span><span id="local-6989586621684555964"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684555964"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m VName -&gt; t m VName
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(m VName -&gt; t m VName) -&gt; m VName -&gt; t m VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc -&gt; Rigidity -&gt; Name -&gt; m VName
forall (m :: * -&gt; *).
MonadUnify m =&gt;
SrcLoc -&gt; Rigidity -&gt; Name -&gt; m VName
</span><a href="Language.Futhark.TypeChecker.Unify.html#newDimVar"><span class="hs-identifier hs-var">newDimVar</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684555989"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">Rigidity
</span><a href="#local-6989586621684555988"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684555987"><span class="hs-identifier hs-var">desc</span></a></span><span>
</span><span id="line-759"></span><span>      </span><span class="annot"><span class="annottext">(Map VName a -&gt; Map VName a) -&gt; t m ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((Map VName a -&gt; Map VName a) -&gt; t m ())
-&gt; (Map VName a -&gt; Map VName a) -&gt; t m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; a -&gt; Map VName a -&gt; Map VName a
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684555964"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684555965"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-760"></span><span>      </span><span class="annot"><span class="annottext">DimDecl VName -&gt; t m (DimDecl VName)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(DimDecl VName -&gt; t m (DimDecl VName))
-&gt; DimDecl VName -&gt; t m (DimDecl VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">QualName VName -&gt; DimDecl VName
forall vn. QualName vn -&gt; DimDecl vn
</span><a href="Language.Futhark.Syntax.html#NamedDim"><span class="hs-identifier hs-var">NamedDim</span></a></span><span> </span><span class="annot"><span class="annottext">(QualName VName -&gt; DimDecl VName)
-&gt; QualName VName -&gt; DimDecl VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; QualName VName
forall v. v -&gt; QualName v
</span><a href="Language.Futhark.Prop.html#qualName"><span class="hs-identifier hs-var">qualName</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684555964"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-761"></span><span>
</span><span id="line-762"></span><span class="hs-comment">-- | Replace all type variables with their concrete types.</span><span>
</span><span id="line-763"></span><span id="local-6989586621684557686"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#updateTypes"><span class="hs-identifier hs-type">updateTypes</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Traversals.html#ASTMappable"><span class="hs-identifier hs-type">ASTMappable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684557686"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684557686"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684557686"><span class="hs-identifier hs-type">e</span></a></span></span><span>
</span><span id="line-764"></span><span id="updateTypes"><span class="annot"><span class="annottext">updateTypes :: forall e. ASTMappable e =&gt; e -&gt; TermTypeM e
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#updateTypes"><span class="hs-identifier hs-var hs-var">updateTypes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ASTMapper TermTypeM -&gt; e -&gt; TermTypeM e
forall x (m :: * -&gt; *).
(ASTMappable x, Monad m) =&gt;
ASTMapper m -&gt; x -&gt; m x
</span><a href="Language.Futhark.Traversals.html#astMap"><span class="hs-identifier hs-var">astMap</span></a></span><span> </span><span class="annot"><span class="annottext">ASTMapper TermTypeM
</span><a href="#local-6989586621684555959"><span class="hs-identifier hs-var">tv</span></a></span><span>
</span><span id="line-765"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-766"></span><span>    </span><span id="local-6989586621684555959"><span class="annot"><span class="annottext">tv :: ASTMapper TermTypeM
</span><a href="#local-6989586621684555959"><span class="hs-identifier hs-var hs-var">tv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-767"></span><span>      </span><span class="annot"><span class="annottext">ASTMapper :: forall (m :: * -&gt; *).
(Exp -&gt; m Exp)
-&gt; (VName -&gt; m VName)
-&gt; (QualName VName -&gt; m (QualName VName))
-&gt; (StructType -&gt; m StructType)
-&gt; (PatType -&gt; m PatType)
-&gt; (RetTypeBase (DimDecl VName) ()
    -&gt; m (RetTypeBase (DimDecl VName) ()))
-&gt; (RetTypeBase (DimDecl VName) Aliasing
    -&gt; m (RetTypeBase (DimDecl VName) Aliasing))
-&gt; ASTMapper m
</span><a href="Language.Futhark.Traversals.html#ASTMapper"><span class="hs-identifier hs-type">ASTMapper</span></a></span><span>
</span><span id="line-768"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">mapOnExp :: Exp -&gt; TermTypeM Exp
</span><a href="Language.Futhark.Traversals.html#mapOnExp"><span class="hs-identifier hs-var">mapOnExp</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ASTMapper TermTypeM -&gt; Exp -&gt; TermTypeM Exp
forall x (m :: * -&gt; *).
(ASTMappable x, Monad m) =&gt;
ASTMapper m -&gt; x -&gt; m x
</span><a href="Language.Futhark.Traversals.html#astMap"><span class="hs-identifier hs-var">astMap</span></a></span><span> </span><span class="annot"><span class="annottext">ASTMapper TermTypeM
</span><a href="#local-6989586621684555959"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-769"></span><span>          </span><span class="annot"><span class="annottext">mapOnName :: VName -&gt; TermTypeM VName
</span><a href="Language.Futhark.Traversals.html#mapOnName"><span class="hs-identifier hs-var">mapOnName</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; TermTypeM VName
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span class="hs-special">,</span><span>
</span><span id="line-770"></span><span>          </span><span class="annot"><span class="annottext">mapOnQualName :: QualName VName -&gt; TermTypeM (QualName VName)
</span><a href="Language.Futhark.Traversals.html#mapOnQualName"><span class="hs-identifier hs-var">mapOnQualName</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QualName VName -&gt; TermTypeM (QualName VName)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span class="hs-special">,</span><span>
</span><span id="line-771"></span><span>          </span><span class="annot"><span class="annottext">mapOnStructType :: StructType -&gt; TermTypeM StructType
</span><a href="Language.Futhark.Traversals.html#mapOnStructType"><span class="hs-identifier hs-var">mapOnStructType</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StructType -&gt; TermTypeM StructType
forall a (m :: * -&gt; *). (Substitutable a, MonadUnify m) =&gt; a -&gt; m a
</span><a href="Language.Futhark.TypeChecker.Unify.html#normTypeFully"><span class="hs-identifier hs-var">normTypeFully</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-772"></span><span>          </span><span class="annot"><span class="annottext">mapOnPatType :: PatType -&gt; TermTypeM PatType
</span><a href="Language.Futhark.Traversals.html#mapOnPatType"><span class="hs-identifier hs-var">mapOnPatType</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatType -&gt; TermTypeM PatType
forall a (m :: * -&gt; *). (Substitutable a, MonadUnify m) =&gt; a -&gt; m a
</span><a href="Language.Futhark.TypeChecker.Unify.html#normTypeFully"><span class="hs-identifier hs-var">normTypeFully</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-773"></span><span>          </span><span class="annot"><span class="annottext">mapOnStructRetType :: RetTypeBase (DimDecl VName) ()
-&gt; TermTypeM (RetTypeBase (DimDecl VName) ())
</span><a href="Language.Futhark.Traversals.html#mapOnStructRetType"><span class="hs-identifier hs-var">mapOnStructRetType</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RetTypeBase (DimDecl VName) ()
-&gt; TermTypeM (RetTypeBase (DimDecl VName) ())
forall a (m :: * -&gt; *). (Substitutable a, MonadUnify m) =&gt; a -&gt; m a
</span><a href="Language.Futhark.TypeChecker.Unify.html#normTypeFully"><span class="hs-identifier hs-var">normTypeFully</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-774"></span><span>          </span><span class="annot"><span class="annottext">mapOnPatRetType :: RetTypeBase (DimDecl VName) Aliasing
-&gt; TermTypeM (RetTypeBase (DimDecl VName) Aliasing)
</span><a href="Language.Futhark.Traversals.html#mapOnPatRetType"><span class="hs-identifier hs-var">mapOnPatRetType</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RetTypeBase (DimDecl VName) Aliasing
-&gt; TermTypeM (RetTypeBase (DimDecl VName) Aliasing)
forall a (m :: * -&gt; *). (Substitutable a, MonadUnify m) =&gt; a -&gt; m a
</span><a href="Language.Futhark.TypeChecker.Unify.html#normTypeFully"><span class="hs-identifier hs-var">normTypeFully</span></a></span><span>
</span><span id="line-775"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-776"></span><span>
</span><span id="line-777"></span><span class="hs-comment">--- Basic checking</span><span>
</span><span id="line-778"></span><span>
</span><span id="line-779"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#unifies"><span class="hs-identifier hs-type">unifies</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#StructType"><span class="hs-identifier hs-type">StructType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span>
</span><span id="line-780"></span><span id="unifies"><span class="annot"><span class="annottext">unifies :: [Char] -&gt; StructType -&gt; Exp -&gt; TermTypeM Exp
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#unifies"><span class="hs-identifier hs-var hs-var">unifies</span></a></span></span><span> </span><span id="local-6989586621684555934"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684555934"><span class="hs-identifier hs-var">why</span></a></span></span><span> </span><span id="local-6989586621684555933"><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684555933"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621684555932"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684555932"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-781"></span><span>  </span><span class="annot"><span class="annottext">Usage -&gt; StructType -&gt; StructType -&gt; TermTypeM ()
forall (m :: * -&gt; *).
MonadUnify m =&gt;
Usage -&gt; StructType -&gt; StructType -&gt; m ()
</span><a href="Language.Futhark.TypeChecker.Unify.html#unify"><span class="hs-identifier hs-var">unify</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SrcLoc -&gt; [Char] -&gt; Usage
</span><a href="Language.Futhark.TypeChecker.Unify.html#mkUsage"><span class="hs-identifier hs-var">mkUsage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp -&gt; SrcLoc
forall a. Located a =&gt; a -&gt; SrcLoc
</span><span class="hs-identifier hs-var">srclocOf</span></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684555932"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684555934"><span class="hs-identifier hs-var">why</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684555933"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">(StructType -&gt; TermTypeM ())
-&gt; (PatType -&gt; StructType) -&gt; PatType -&gt; TermTypeM ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PatType -&gt; StructType
forall dim as. TypeBase dim as -&gt; TypeBase dim ()
</span><a href="Language.Futhark.Prop.html#toStruct"><span class="hs-identifier hs-var">toStruct</span></a></span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; TermTypeM ()) -&gt; TermTypeM PatType -&gt; TermTypeM ()
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; TermTypeM PatType
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#expType"><span class="hs-identifier hs-var">expType</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684555932"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-782"></span><span>  </span><span class="annot"><span class="annottext">Exp -&gt; TermTypeM Exp
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684555932"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-783"></span><span>
</span><span id="line-784"></span><span class="hs-comment">-- | @require ts e@ causes a 'TypeError' if @expType e@ is not one of</span><span>
</span><span id="line-785"></span><span class="hs-comment">-- the types in @ts@.  Otherwise, simply returns @e@.</span><span>
</span><span id="line-786"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#require"><span class="hs-identifier hs-type">require</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Syntax.html#PrimType"><span class="hs-identifier hs-type">PrimType</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span>
</span><span id="line-787"></span><span id="require"><span class="annot"><span class="annottext">require :: [Char] -&gt; [PrimType] -&gt; Exp -&gt; TermTypeM Exp
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#require"><span class="hs-identifier hs-var hs-var">require</span></a></span></span><span> </span><span id="local-6989586621684555930"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684555930"><span class="hs-identifier hs-var">why</span></a></span></span><span> </span><span id="local-6989586621684555929"><span class="annot"><span class="annottext">[PrimType]
</span><a href="#local-6989586621684555929"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span id="local-6989586621684555928"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684555928"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-788"></span><span>  </span><span class="annot"><span class="annottext">[PrimType] -&gt; Usage -&gt; StructType -&gt; TermTypeM ()
forall (m :: * -&gt; *).
MonadUnify m =&gt;
[PrimType] -&gt; Usage -&gt; StructType -&gt; m ()
</span><a href="Language.Futhark.TypeChecker.Unify.html#mustBeOneOf"><span class="hs-identifier hs-var">mustBeOneOf</span></a></span><span> </span><span class="annot"><span class="annottext">[PrimType]
</span><a href="#local-6989586621684555929"><span class="hs-identifier hs-var">ts</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SrcLoc -&gt; [Char] -&gt; Usage
</span><a href="Language.Futhark.TypeChecker.Unify.html#mkUsage"><span class="hs-identifier hs-var">mkUsage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp -&gt; SrcLoc
forall a. Located a =&gt; a -&gt; SrcLoc
</span><span class="hs-identifier hs-var">srclocOf</span></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684555928"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684555930"><span class="hs-identifier hs-var">why</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(StructType -&gt; TermTypeM ())
-&gt; (PatType -&gt; StructType) -&gt; PatType -&gt; TermTypeM ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PatType -&gt; StructType
forall dim as. TypeBase dim as -&gt; TypeBase dim ()
</span><a href="Language.Futhark.Prop.html#toStruct"><span class="hs-identifier hs-var">toStruct</span></a></span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; TermTypeM ()) -&gt; TermTypeM PatType -&gt; TermTypeM ()
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; TermTypeM PatType
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#expType"><span class="hs-identifier hs-var">expType</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684555928"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-789"></span><span>  </span><span class="annot"><span class="annottext">Exp -&gt; TermTypeM Exp
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684555928"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-790"></span><span>
</span><span id="line-791"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#termCheckTypeExp"><span class="hs-identifier hs-type">termCheckTypeExp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeExp"><span class="hs-identifier hs-type">TypeExp</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeExp"><span class="hs-identifier hs-type">TypeExp</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#StructRetType"><span class="hs-identifier hs-type">StructRetType</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-792"></span><span id="termCheckTypeExp"><span class="annot"><span class="annottext">termCheckTypeExp :: TypeExp Name
-&gt; TermTypeM
     (TypeExp VName, [VName], RetTypeBase (DimDecl VName) ())
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#termCheckTypeExp"><span class="hs-identifier hs-var hs-var">termCheckTypeExp</span></a></span></span><span> </span><span id="local-6989586621684555925"><span class="annot"><span class="annottext">TypeExp Name
</span><a href="#local-6989586621684555925"><span class="hs-identifier hs-var">te</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-793"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684555924"><span class="annot"><span class="annottext">TypeExp VName
</span><a href="#local-6989586621684555924"><span class="hs-identifier hs-var">te'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684555923"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684555923"><span class="hs-identifier hs-var">svars</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684555922"><span class="annot"><span class="annottext">RetTypeBase (DimDecl VName) ()
</span><a href="#local-6989586621684555922"><span class="hs-identifier hs-var">rettype</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684555921"><span class="annot"><span class="annottext">Liftedness
</span><a href="#local-6989586621684555921"><span class="hs-identifier hs-var">_l</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TypeExp Name
-&gt; TermTypeM
     (TypeExp VName, [VName], RetTypeBase (DimDecl VName) (),
      Liftedness)
forall (m :: * -&gt; *).
MonadTypeChecker m =&gt;
TypeExp Name
-&gt; m (TypeExp VName, [VName], RetTypeBase (DimDecl VName) (),
      Liftedness)
</span><a href="Language.Futhark.TypeChecker.Types.html#checkTypeExp"><span class="hs-identifier hs-var">checkTypeExp</span></a></span><span> </span><span class="annot"><span class="annottext">TypeExp Name
</span><a href="#local-6989586621684555925"><span class="hs-identifier hs-var">te</span></a></span><span>
</span><span id="line-794"></span><span>
</span><span id="line-795"></span><span>  </span><span class="hs-comment">-- No guarantee that the locally bound sizes in rettype are globally</span><span>
</span><span id="line-796"></span><span>  </span><span class="hs-comment">-- unique, but we want to turn them into size variables, so let's</span><span>
</span><span id="line-797"></span><span>  </span><span class="hs-comment">-- give them some unique names.  Maybe this should be done below,</span><span>
</span><span id="line-798"></span><span>  </span><span class="hs-comment">-- where we actually turn these into size variables?</span><span>
</span><span id="line-799"></span><span>  </span><span class="annot"><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-type">RetType</span></a></span><span> </span><span id="local-6989586621684555919"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684555919"><span class="hs-identifier hs-var">dims</span></a></span></span><span> </span><span id="local-6989586621684555918"><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684555918"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RetTypeBase (DimDecl VName) ()
-&gt; TermTypeM (RetTypeBase (DimDecl VName) ())
forall (m :: * -&gt; *).
MonadTypeChecker m =&gt;
RetTypeBase (DimDecl VName) ()
-&gt; m (RetTypeBase (DimDecl VName) ())
</span><a href="Language.Futhark.TypeChecker.Types.html#renameRetType"><span class="hs-identifier hs-var">renameRetType</span></a></span><span> </span><span class="annot"><span class="annottext">RetTypeBase (DimDecl VName) ()
</span><a href="#local-6989586621684555922"><span class="hs-identifier hs-var">rettype</span></a></span><span>
</span><span id="line-800"></span><span>
</span><span id="line-801"></span><span>  </span><span class="hs-comment">-- Observe the sizes so we do not get any warnings about them not</span><span>
</span><span id="line-802"></span><span>  </span><span class="hs-comment">-- being used.</span><span>
</span><span id="line-803"></span><span>  </span><span class="annot"><span class="annottext">(DimDecl VName -&gt; TermTypeM ()) -&gt; [DimDecl VName] -&gt; TermTypeM ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="annot"><span class="annottext">DimDecl VName -&gt; TermTypeM ()
</span><a href="#local-6989586621684555915"><span class="hs-identifier hs-var">observeDim</span></a></span><span> </span><span class="annot"><span class="annottext">([DimDecl VName] -&gt; TermTypeM ())
-&gt; [DimDecl VName] -&gt; TermTypeM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">StructType -&gt; [DimDecl VName]
forall as. TypeBase (DimDecl VName) as -&gt; [DimDecl VName]
</span><a href="Language.Futhark.Prop.html#nestedDims"><span class="hs-identifier hs-var">nestedDims</span></a></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684555918"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-804"></span><span>  </span><span class="annot"><span class="annottext">(TypeExp VName, [VName], RetTypeBase (DimDecl VName) ())
-&gt; TermTypeM
     (TypeExp VName, [VName], RetTypeBase (DimDecl VName) ())
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeExp VName
</span><a href="#local-6989586621684555924"><span class="hs-identifier hs-var">te'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684555923"><span class="hs-identifier hs-var">svars</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; StructType -&gt; RetTypeBase (DimDecl VName) ()
forall dim as. [VName] -&gt; TypeBase dim as -&gt; RetTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-var">RetType</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684555919"><span class="hs-identifier hs-var">dims</span></a></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684555918"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-805"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-806"></span><span>    </span><span id="local-6989586621684555915"><span class="annot"><span class="annottext">observeDim :: DimDecl VName -&gt; TermTypeM ()
</span><a href="#local-6989586621684555915"><span class="hs-identifier hs-var hs-var">observeDim</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#NamedDim"><span class="hs-identifier hs-type">NamedDim</span></a></span><span> </span><span id="local-6989586621684555910"><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684555910"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-807"></span><span>      </span><span class="annot"><span class="annottext">Ident -&gt; TermTypeM ()
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#observe"><span class="hs-identifier hs-var">observe</span></a></span><span> </span><span class="annot"><span class="annottext">(Ident -&gt; TermTypeM ()) -&gt; Ident -&gt; TermTypeM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Info PatType -&gt; SrcLoc -&gt; Ident
forall (f :: * -&gt; *) vn.
vn -&gt; f PatType -&gt; SrcLoc -&gt; IdentBase f vn
</span><a href="Language.Futhark.Syntax.html#Ident"><span class="hs-identifier hs-var">Ident</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QualName VName -&gt; VName
forall vn. QualName vn -&gt; vn
</span><a href="Language.Futhark.Syntax.html#qualLeaf"><span class="hs-identifier hs-var hs-var">qualLeaf</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684555910"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatType -&gt; Info PatType
forall a. a -&gt; Info a
</span><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-var">Info</span></a></span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; Info PatType) -&gt; PatType -&gt; Info PatType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ScalarTypeBase (DimDecl VName) Aliasing -&gt; PatType
forall dim as. ScalarTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-var">Scalar</span></a></span><span> </span><span class="annot"><span class="annottext">(ScalarTypeBase (DimDecl VName) Aliasing -&gt; PatType)
-&gt; ScalarTypeBase (DimDecl VName) Aliasing -&gt; PatType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; ScalarTypeBase (DimDecl VName) Aliasing
forall dim as. PrimType -&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimType -&gt; ScalarTypeBase (DimDecl VName) Aliasing)
-&gt; PrimType -&gt; ScalarTypeBase (DimDecl VName) Aliasing
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IntType -&gt; PrimType
</span><a href="Language.Futhark.Syntax.html#Signed"><span class="hs-identifier hs-var">Signed</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-808"></span><span>    </span><span class="annot"><a href="#local-6989586621684555915"><span class="hs-identifier hs-var">observeDim</span></a></span><span> </span><span class="annot"><span class="annottext">DimDecl VName
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; TermTypeM ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-809"></span><span>
</span><span id="line-810"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#checkTypeExpNonrigid"><span class="hs-identifier hs-type">checkTypeExpNonrigid</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeExp"><span class="hs-identifier hs-type">TypeExp</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeExp"><span class="hs-identifier hs-type">TypeExp</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#StructType"><span class="hs-identifier hs-type">StructType</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-811"></span><span id="checkTypeExpNonrigid"><span class="annot"><span class="annottext">checkTypeExpNonrigid :: TypeExp Name -&gt; TermTypeM (TypeExp VName, StructType, [VName])
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#checkTypeExpNonrigid"><span class="hs-identifier hs-var hs-var">checkTypeExpNonrigid</span></a></span></span><span> </span><span id="local-6989586621684555908"><span class="annot"><span class="annottext">TypeExp Name
</span><a href="#local-6989586621684555908"><span class="hs-identifier hs-var">te</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-812"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684555907"><span class="annot"><span class="annottext">TypeExp VName
</span><a href="#local-6989586621684555907"><span class="hs-identifier hs-var">te'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684555906"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684555906"><span class="hs-identifier hs-var">svars</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-type">RetType</span></a></span><span> </span><span id="local-6989586621684555905"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684555905"><span class="hs-identifier hs-var">dims</span></a></span></span><span> </span><span id="local-6989586621684555904"><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684555904"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TypeExp Name
-&gt; TermTypeM
     (TypeExp VName, [VName], RetTypeBase (DimDecl VName) ())
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#termCheckTypeExp"><span class="hs-identifier hs-var">termCheckTypeExp</span></a></span><span> </span><span class="annot"><span class="annottext">TypeExp Name
</span><a href="#local-6989586621684555908"><span class="hs-identifier hs-var">te</span></a></span><span>
</span><span id="line-813"></span><span>  </span><span class="annot"><span class="annottext">[VName] -&gt; (VName -&gt; TermTypeM ()) -&gt; TermTypeM ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684555906"><span class="hs-identifier hs-var">svars</span></a></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684555905"><span class="hs-identifier hs-var">dims</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((VName -&gt; TermTypeM ()) -&gt; TermTypeM ())
-&gt; (VName -&gt; TermTypeM ()) -&gt; TermTypeM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684555902"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684555902"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-814"></span><span>    </span><span class="annot"><span class="annottext">VName -&gt; Constraint -&gt; TermTypeM ()
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#constrain"><span class="hs-identifier hs-var">constrain</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684555902"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">(Constraint -&gt; TermTypeM ()) -&gt; Constraint -&gt; TermTypeM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (DimDecl VName) -&gt; Usage -&gt; Constraint
</span><a href="Language.Futhark.TypeChecker.Unify.html#Size"><span class="hs-identifier hs-var">Size</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (DimDecl VName)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">(Usage -&gt; Constraint) -&gt; Usage -&gt; Constraint
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc -&gt; Usage
</span><a href="Language.Futhark.TypeChecker.Unify.html#mkUsage%27"><span class="hs-identifier hs-var">mkUsage'</span></a></span><span> </span><span class="annot"><span class="annottext">(SrcLoc -&gt; Usage) -&gt; SrcLoc -&gt; Usage
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TypeExp Name -&gt; SrcLoc
forall a. Located a =&gt; a -&gt; SrcLoc
</span><span class="hs-identifier hs-var">srclocOf</span></span><span> </span><span class="annot"><span class="annottext">TypeExp Name
</span><a href="#local-6989586621684555908"><span class="hs-identifier hs-var">te</span></a></span><span>
</span><span id="line-815"></span><span>  </span><span class="annot"><span class="annottext">(TypeExp VName, StructType, [VName])
-&gt; TermTypeM (TypeExp VName, StructType, [VName])
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeExp VName
</span><a href="#local-6989586621684555907"><span class="hs-identifier hs-var">te'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684555904"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684555906"><span class="hs-identifier hs-var">svars</span></a></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684555905"><span class="hs-identifier hs-var">dims</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-816"></span><span>
</span><span id="line-817"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#checkTypeExpRigid"><span class="hs-identifier hs-type">checkTypeExpRigid</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-818"></span><span>  </span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeExp"><span class="hs-identifier hs-type">TypeExp</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-819"></span><span>  </span><span class="annot"><a href="Language.Futhark.TypeChecker.Unify.html#RigidSource"><span class="hs-identifier hs-type">RigidSource</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-820"></span><span>  </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeExp"><span class="hs-identifier hs-type">TypeExp</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#StructType"><span class="hs-identifier hs-type">StructType</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-821"></span><span id="checkTypeExpRigid"><span class="annot"><span class="annottext">checkTypeExpRigid :: TypeExp Name
-&gt; RigidSource -&gt; TermTypeM (TypeExp VName, StructType, [VName])
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#checkTypeExpRigid"><span class="hs-identifier hs-var hs-var">checkTypeExpRigid</span></a></span></span><span> </span><span id="local-6989586621684555901"><span class="annot"><span class="annottext">TypeExp Name
</span><a href="#local-6989586621684555901"><span class="hs-identifier hs-var">te</span></a></span></span><span> </span><span id="local-6989586621684555900"><span class="annot"><span class="annottext">RigidSource
</span><a href="#local-6989586621684555900"><span class="hs-identifier hs-var">rsrc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-822"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684555899"><span class="annot"><span class="annottext">TypeExp VName
</span><a href="#local-6989586621684555899"><span class="hs-identifier hs-var">te'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684555898"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684555898"><span class="hs-identifier hs-var">svars</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-type">RetType</span></a></span><span> </span><span id="local-6989586621684555897"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684555897"><span class="hs-identifier hs-var">dims</span></a></span></span><span> </span><span id="local-6989586621684555896"><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684555896"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TypeExp Name
-&gt; TermTypeM
     (TypeExp VName, [VName], RetTypeBase (DimDecl VName) ())
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#termCheckTypeExp"><span class="hs-identifier hs-var">termCheckTypeExp</span></a></span><span> </span><span class="annot"><span class="annottext">TypeExp Name
</span><a href="#local-6989586621684555901"><span class="hs-identifier hs-var">te</span></a></span><span>
</span><span id="line-823"></span><span>  </span><span class="annot"><span class="annottext">[VName] -&gt; (VName -&gt; TermTypeM ()) -&gt; TermTypeM ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684555898"><span class="hs-identifier hs-var">svars</span></a></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684555897"><span class="hs-identifier hs-var">dims</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((VName -&gt; TermTypeM ()) -&gt; TermTypeM ())
-&gt; (VName -&gt; TermTypeM ()) -&gt; TermTypeM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684555895"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684555895"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-824"></span><span>    </span><span class="annot"><span class="annottext">VName -&gt; Constraint -&gt; TermTypeM ()
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#constrain"><span class="hs-identifier hs-var">constrain</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684555895"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">(Constraint -&gt; TermTypeM ()) -&gt; Constraint -&gt; TermTypeM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc -&gt; RigidSource -&gt; Constraint
</span><a href="Language.Futhark.TypeChecker.Unify.html#UnknowableSize"><span class="hs-identifier hs-var">UnknowableSize</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeExp Name -&gt; SrcLoc
forall a. Located a =&gt; a -&gt; SrcLoc
</span><span class="hs-identifier hs-var">srclocOf</span></span><span> </span><span class="annot"><span class="annottext">TypeExp Name
</span><a href="#local-6989586621684555901"><span class="hs-identifier hs-var">te</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">RigidSource
</span><a href="#local-6989586621684555900"><span class="hs-identifier hs-var">rsrc</span></a></span><span>
</span><span id="line-825"></span><span>  </span><span class="annot"><span class="annottext">(TypeExp VName, StructType, [VName])
-&gt; TermTypeM (TypeExp VName, StructType, [VName])
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeExp VName
</span><a href="#local-6989586621684555899"><span class="hs-identifier hs-var">te'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684555896"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684555898"><span class="hs-identifier hs-var">svars</span></a></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684555897"><span class="hs-identifier hs-var">dims</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-826"></span><span>
</span><span id="line-827"></span><span class="hs-comment">--- Sizes</span><span>
</span><span id="line-828"></span><span>
</span><span id="line-829"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#isInt64"><span class="hs-identifier hs-type">isInt64</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span>
</span><span id="line-830"></span><span id="isInt64"><span class="annot"><span class="annottext">isInt64 :: Exp -&gt; Maybe Int64
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#isInt64"><span class="hs-identifier hs-var hs-var">isInt64</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Literal"><span class="hs-identifier hs-type">Literal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#SignedValue"><span class="hs-identifier hs-type">SignedValue</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Primitive.html#Int64Value"><span class="hs-identifier hs-type">Int64Value</span></a></span><span> </span><span id="local-6989586621684555891"><span class="annot"><span class="annottext">Int64
</span><a href="#local-6989586621684555891"><span class="hs-identifier hs-var">k'</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int64 -&gt; Maybe Int64
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Int64 -&gt; Maybe Int64) -&gt; Int64 -&gt; Maybe Int64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int64 -&gt; Int64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Int64
</span><a href="#local-6989586621684555891"><span class="hs-identifier hs-var">k'</span></a></span><span>
</span><span id="line-831"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#isInt64"><span class="hs-identifier hs-var">isInt64</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#IntLit"><span class="hs-identifier hs-type">IntLit</span></a></span><span> </span><span id="local-6989586621684555889"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621684555889"><span class="hs-identifier hs-var">k'</span></a></span></span><span> </span><span class="annot"><span class="annottext">Info PatType
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int64 -&gt; Maybe Int64
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Int64 -&gt; Maybe Int64) -&gt; Int64 -&gt; Maybe Int64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Int64
forall a. Num a =&gt; Integer -&gt; a
</span><span class="hs-identifier hs-var">fromInteger</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621684555889"><span class="hs-identifier hs-var">k'</span></a></span><span>
</span><span id="line-832"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#isInt64"><span class="hs-identifier hs-var">isInt64</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Negate"><span class="hs-identifier hs-type">Negate</span></a></span><span> </span><span id="local-6989586621684555887"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684555887"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int64 -&gt; Int64
forall a. Num a =&gt; a -&gt; a
</span><span class="hs-identifier hs-var">negate</span></span><span> </span><span class="annot"><span class="annottext">(Int64 -&gt; Int64) -&gt; Maybe Int64 -&gt; Maybe Int64
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Maybe Int64
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#isInt64"><span class="hs-identifier hs-var">isInt64</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684555887"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-833"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#isInt64"><span class="hs-identifier hs-var">isInt64</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Int64
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-834"></span><span>
</span><span id="line-835"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#maybeDimFromExp"><span class="hs-identifier hs-type">maybeDimFromExp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#DimDecl"><span class="hs-identifier hs-type">DimDecl</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-836"></span><span id="maybeDimFromExp"><span class="annot"><span class="annottext">maybeDimFromExp :: Exp -&gt; Maybe (DimDecl VName)
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#maybeDimFromExp"><span class="hs-identifier hs-var hs-var">maybeDimFromExp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684555885"><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684555885"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="annot"><span class="annottext">Info PatType
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DimDecl VName -&gt; Maybe (DimDecl VName)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(DimDecl VName -&gt; Maybe (DimDecl VName))
-&gt; DimDecl VName -&gt; Maybe (DimDecl VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">QualName VName -&gt; DimDecl VName
forall vn. QualName vn -&gt; DimDecl vn
</span><a href="Language.Futhark.Syntax.html#NamedDim"><span class="hs-identifier hs-var">NamedDim</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684555885"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-837"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#maybeDimFromExp"><span class="hs-identifier hs-var">maybeDimFromExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Parens"><span class="hs-identifier hs-type">Parens</span></a></span><span> </span><span id="local-6989586621684555883"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684555883"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Maybe (DimDecl VName)
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#maybeDimFromExp"><span class="hs-identifier hs-var">maybeDimFromExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684555883"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-838"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#maybeDimFromExp"><span class="hs-identifier hs-var">maybeDimFromExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#QualParens"><span class="hs-identifier hs-type">QualParens</span></a></span><span> </span><span class="annot"><span class="annottext">(QualName VName, SrcLoc)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684555881"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684555881"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Maybe (DimDecl VName)
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#maybeDimFromExp"><span class="hs-identifier hs-var">maybeDimFromExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684555881"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-839"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#maybeDimFromExp"><span class="hs-identifier hs-var">maybeDimFromExp</span></a></span><span> </span><span id="local-6989586621684555880"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684555880"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; DimDecl VName
forall vn. Int -&gt; DimDecl vn
</span><a href="Language.Futhark.Syntax.html#ConstDim"><span class="hs-identifier hs-var">ConstDim</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; DimDecl VName) -&gt; (Int64 -&gt; Int) -&gt; Int64 -&gt; DimDecl VName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Int64 -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">(Int64 -&gt; DimDecl VName) -&gt; Maybe Int64 -&gt; Maybe (DimDecl VName)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Maybe Int64
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#isInt64"><span class="hs-identifier hs-var">isInt64</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684555880"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-840"></span><span>
</span><span id="line-841"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#dimFromExp"><span class="hs-identifier hs-type">dimFromExp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#SizeSource"><span class="hs-identifier hs-type">SizeSource</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#DimDecl"><span class="hs-identifier hs-type">DimDecl</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-842"></span><span id="dimFromExp"><span class="annot"><span class="annottext">dimFromExp :: (Exp -&gt; SizeSource)
-&gt; Exp -&gt; TermTypeM (DimDecl VName, Maybe VName)
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#dimFromExp"><span class="hs-identifier hs-var hs-var">dimFromExp</span></a></span></span><span> </span><span id="local-6989586621684555878"><span class="annot"><span class="annottext">Exp -&gt; SizeSource
</span><a href="#local-6989586621684555878"><span class="hs-identifier hs-var">rf</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Parens"><span class="hs-identifier hs-type">Parens</span></a></span><span> </span><span id="local-6989586621684555877"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684555877"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; SizeSource)
-&gt; Exp -&gt; TermTypeM (DimDecl VName, Maybe VName)
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#dimFromExp"><span class="hs-identifier hs-var">dimFromExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; SizeSource
</span><a href="#local-6989586621684555878"><span class="hs-identifier hs-var">rf</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684555877"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-843"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#dimFromExp"><span class="hs-identifier hs-var">dimFromExp</span></a></span><span> </span><span id="local-6989586621684555876"><span class="annot"><span class="annottext">Exp -&gt; SizeSource
</span><a href="#local-6989586621684555876"><span class="hs-identifier hs-var">rf</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#QualParens"><span class="hs-identifier hs-type">QualParens</span></a></span><span> </span><span class="annot"><span class="annottext">(QualName VName, SrcLoc)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684555875"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684555875"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; SizeSource)
-&gt; Exp -&gt; TermTypeM (DimDecl VName, Maybe VName)
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#dimFromExp"><span class="hs-identifier hs-var">dimFromExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; SizeSource
</span><a href="#local-6989586621684555876"><span class="hs-identifier hs-var">rf</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684555875"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-844"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#dimFromExp"><span class="hs-identifier hs-var">dimFromExp</span></a></span><span> </span><span id="local-6989586621684555874"><span class="annot"><span class="annottext">Exp -&gt; SizeSource
</span><a href="#local-6989586621684555874"><span class="hs-identifier hs-var">rf</span></a></span></span><span> </span><span id="local-6989586621684555873"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684555873"><span class="hs-identifier hs-var">e</span></a></span></span><span>
</span><span id="line-845"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684555872"><span class="annot"><span class="annottext">DimDecl VName
</span><a href="#local-6989586621684555872"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Maybe (DimDecl VName)
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#maybeDimFromExp"><span class="hs-identifier hs-var">maybeDimFromExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684555873"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-846"></span><span>    </span><span class="annot"><span class="annottext">(DimDecl VName, Maybe VName)
-&gt; TermTypeM (DimDecl VName, Maybe VName)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DimDecl VName
</span><a href="#local-6989586621684555872"><span class="hs-identifier hs-var">d</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe VName
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-847"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-848"></span><span>    </span><span class="annot"><span class="annottext">SrcLoc -&gt; SizeSource -&gt; TermTypeM (DimDecl VName, Maybe VName)
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#extSize"><span class="hs-identifier hs-var">extSize</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp -&gt; SrcLoc
forall a. Located a =&gt; a -&gt; SrcLoc
</span><span class="hs-identifier hs-var">srclocOf</span></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684555873"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SizeSource -&gt; TermTypeM (DimDecl VName, Maybe VName))
-&gt; SizeSource -&gt; TermTypeM (DimDecl VName, Maybe VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; SizeSource
</span><a href="#local-6989586621684555874"><span class="hs-identifier hs-var">rf</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684555873"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-849"></span><span>
</span><span id="line-850"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#dimFromArg"><span class="hs-identifier hs-type">dimFromArg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#QualName"><span class="hs-identifier hs-type">QualName</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#DimDecl"><span class="hs-identifier hs-type">DimDecl</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-851"></span><span id="dimFromArg"><span class="annot"><span class="annottext">dimFromArg :: Maybe (QualName VName)
-&gt; Exp -&gt; TermTypeM (DimDecl VName, Maybe VName)
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#dimFromArg"><span class="hs-identifier hs-var hs-var">dimFromArg</span></a></span></span><span> </span><span id="local-6989586621684555871"><span class="annot"><span class="annottext">Maybe (QualName VName)
</span><a href="#local-6989586621684555871"><span class="hs-identifier hs-var">fname</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; SizeSource)
-&gt; Exp -&gt; TermTypeM (DimDecl VName, Maybe VName)
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#dimFromExp"><span class="hs-identifier hs-var">dimFromExp</span></a></span><span> </span><span class="annot"><span class="annottext">((Exp -&gt; SizeSource)
 -&gt; Exp -&gt; TermTypeM (DimDecl VName, Maybe VName))
-&gt; (Exp -&gt; SizeSource)
-&gt; Exp
-&gt; TermTypeM (DimDecl VName, Maybe VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FName -&gt; ExpBase NoInfo VName -&gt; SizeSource
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#SourceArg"><span class="hs-identifier hs-var">SourceArg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (QualName VName) -&gt; FName
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#FName"><span class="hs-identifier hs-var">FName</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (QualName VName)
</span><a href="#local-6989586621684555871"><span class="hs-identifier hs-var">fname</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ExpBase NoInfo VName -&gt; SizeSource)
-&gt; (Exp -&gt; ExpBase NoInfo VName) -&gt; Exp -&gt; SizeSource
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; ExpBase NoInfo VName
</span><a href="Language.Futhark.Traversals.html#bareExp"><span class="hs-identifier hs-var">bareExp</span></a></span><span>
</span><span id="line-852"></span><span>
</span><span id="line-853"></span><span class="hs-comment">-- | Any argument sizes created with 'extSize' inside the given action</span><span>
</span><span id="line-854"></span><span class="hs-comment">-- will be removed once the action finishes.  This is to ensure that</span><span>
</span><span id="line-855"></span><span class="hs-comment">-- just because e.g. @n+1@ appears as a size in one branch of a</span><span>
</span><span id="line-856"></span><span class="hs-comment">-- conditional, that doesn't mean it's also available in the other</span><span>
</span><span id="line-857"></span><span class="hs-comment">-- branch.</span><span>
</span><span id="line-858"></span><span id="local-6989586621684555869"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#noSizeEscape"><span class="hs-identifier hs-type">noSizeEscape</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684555869"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684555869"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-859"></span><span id="noSizeEscape"><span class="annot"><span class="annottext">noSizeEscape :: forall a. TermTypeM a -&gt; TermTypeM a
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#noSizeEscape"><span class="hs-identifier hs-var hs-var">noSizeEscape</span></a></span></span><span> </span><span id="local-6989586621684555862"><span class="annot"><span class="annottext">TermTypeM a
</span><a href="#local-6989586621684555862"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-860"></span><span>  </span><span id="local-6989586621684555861"><span class="annot"><span class="annottext">Map SizeSource VName
</span><a href="#local-6989586621684555861"><span class="hs-identifier hs-var">dimtable</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TermTypeState -&gt; Map SizeSource VName)
-&gt; TermTypeM (Map SizeSource VName)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">TermTypeState -&gt; Map SizeSource VName
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#stateDimTable"><span class="hs-identifier hs-var hs-var">stateDimTable</span></a></span><span>
</span><span id="line-861"></span><span>  </span><span id="local-6989586621684555860"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684555860"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TermTypeM a
</span><a href="#local-6989586621684555862"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-862"></span><span>  </span><span class="annot"><span class="annottext">(TermTypeState -&gt; TermTypeState) -&gt; TermTypeM ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((TermTypeState -&gt; TermTypeState) -&gt; TermTypeM ())
-&gt; (TermTypeState -&gt; TermTypeState) -&gt; TermTypeM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684555859"><span class="annot"><span class="annottext">TermTypeState
</span><a href="#local-6989586621684555859"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TermTypeState
</span><a href="#local-6989586621684555859"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">stateDimTable :: Map SizeSource VName
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#stateDimTable"><span class="hs-identifier hs-var">stateDimTable</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map SizeSource VName
</span><a href="#local-6989586621684555861"><span class="hs-identifier hs-var">dimtable</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-863"></span><span>  </span><span class="annot"><span class="annottext">a -&gt; TermTypeM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684555860"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-864"></span><span>
</span><span id="line-865"></span><span class="hs-comment">--- Control flow</span><span>
</span><span id="line-866"></span><span>
</span><span id="line-867"></span><span id="local-6989586621684557660"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#tapOccurrences"><span class="hs-identifier hs-type">tapOccurrences</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684557660"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621684557660"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Occurrences"><span class="hs-identifier hs-type">Occurrences</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-868"></span><span id="tapOccurrences"><span class="annot"><span class="annottext">tapOccurrences :: forall a. TermTypeM a -&gt; TermTypeM (a, Occurrences)
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#tapOccurrences"><span class="hs-identifier hs-var hs-var">tapOccurrences</span></a></span></span><span> </span><span id="local-6989586621684555855"><span class="annot"><span class="annottext">TermTypeM a
</span><a href="#local-6989586621684555855"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-869"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684555854"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684555854"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684555853"><span class="annot"><span class="annottext">Occurrences
</span><a href="#local-6989586621684555853"><span class="hs-identifier hs-var">occs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TermTypeM a -&gt; TermTypeM (a, Occurrences)
forall a. TermTypeM a -&gt; TermTypeM (a, Occurrences)
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#collectOccurrences"><span class="hs-identifier hs-var">collectOccurrences</span></a></span><span> </span><span class="annot"><span class="annottext">TermTypeM a
</span><a href="#local-6989586621684555855"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-870"></span><span>  </span><span class="annot"><span class="annottext">Occurrences -&gt; TermTypeM ()
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#occur"><span class="hs-identifier hs-var">occur</span></a></span><span> </span><span class="annot"><span class="annottext">Occurrences
</span><a href="#local-6989586621684555853"><span class="hs-identifier hs-var">occs</span></a></span><span>
</span><span id="line-871"></span><span>  </span><span class="annot"><span class="annottext">(a, Occurrences) -&gt; TermTypeM (a, Occurrences)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684555854"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Occurrences
</span><a href="#local-6989586621684555853"><span class="hs-identifier hs-var">occs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-872"></span><span>
</span><span id="line-873"></span><span id="local-6989586621684555852"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#collectOccurrences"><span class="hs-identifier hs-type">collectOccurrences</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684555852"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621684555852"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Occurrences"><span class="hs-identifier hs-type">Occurrences</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-874"></span><span id="collectOccurrences"><span class="annot"><span class="annottext">collectOccurrences :: forall a. TermTypeM a -&gt; TermTypeM (a, Occurrences)
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#collectOccurrences"><span class="hs-identifier hs-var hs-var">collectOccurrences</span></a></span></span><span> </span><span id="local-6989586621684555839"><span class="annot"><span class="annottext">TermTypeM a
</span><a href="#local-6989586621684555839"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-875"></span><span>  </span><span id="local-6989586621684555838"><span class="annot"><span class="annottext">Occurrences
</span><a href="#local-6989586621684555838"><span class="hs-identifier hs-var">old</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TermTypeState -&gt; Occurrences) -&gt; TermTypeM Occurrences
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">TermTypeState -&gt; Occurrences
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#stateOccs"><span class="hs-identifier hs-var hs-var">stateOccs</span></a></span><span>
</span><span id="line-876"></span><span>  </span><span class="annot"><span class="annottext">(TermTypeState -&gt; TermTypeState) -&gt; TermTypeM ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((TermTypeState -&gt; TermTypeState) -&gt; TermTypeM ())
-&gt; (TermTypeState -&gt; TermTypeState) -&gt; TermTypeM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684555837"><span class="annot"><span class="annottext">TermTypeState
</span><a href="#local-6989586621684555837"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TermTypeState
</span><a href="#local-6989586621684555837"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">stateOccs :: Occurrences
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#stateOccs"><span class="hs-identifier hs-var">stateOccs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Occurrences
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">}</span><span>
</span><span id="line-877"></span><span>  </span><span id="local-6989586621684555836"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684555836"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TermTypeM a
</span><a href="#local-6989586621684555839"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-878"></span><span>  </span><span id="local-6989586621684555835"><span class="annot"><span class="annottext">Occurrences
</span><a href="#local-6989586621684555835"><span class="hs-identifier hs-var">new</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TermTypeState -&gt; Occurrences) -&gt; TermTypeM Occurrences
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">TermTypeState -&gt; Occurrences
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#stateOccs"><span class="hs-identifier hs-var hs-var">stateOccs</span></a></span><span>
</span><span id="line-879"></span><span>  </span><span class="annot"><span class="annottext">(TermTypeState -&gt; TermTypeState) -&gt; TermTypeM ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((TermTypeState -&gt; TermTypeState) -&gt; TermTypeM ())
-&gt; (TermTypeState -&gt; TermTypeState) -&gt; TermTypeM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684555834"><span class="annot"><span class="annottext">TermTypeState
</span><a href="#local-6989586621684555834"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TermTypeState
</span><a href="#local-6989586621684555834"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">stateOccs :: Occurrences
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#stateOccs"><span class="hs-identifier hs-var">stateOccs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Occurrences
</span><a href="#local-6989586621684555838"><span class="hs-identifier hs-var">old</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-880"></span><span>  </span><span class="annot"><span class="annottext">(a, Occurrences) -&gt; TermTypeM (a, Occurrences)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684555836"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Occurrences
</span><a href="#local-6989586621684555835"><span class="hs-identifier hs-var">new</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-881"></span><span>
</span><span id="line-882"></span><span id="local-6989586621684557655"><span id="local-6989586621684557656"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#alternative"><span class="hs-identifier hs-type">alternative</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684557656"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684557655"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621684557656"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621684557655"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-883"></span><span id="alternative"><span class="annot"><span class="annottext">alternative :: forall a b. TermTypeM a -&gt; TermTypeM b -&gt; TermTypeM (a, b)
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#alternative"><span class="hs-identifier hs-var hs-var">alternative</span></a></span></span><span> </span><span id="local-6989586621684555827"><span class="annot"><span class="annottext">TermTypeM a
</span><a href="#local-6989586621684555827"><span class="hs-identifier hs-var">m1</span></a></span></span><span> </span><span id="local-6989586621684555826"><span class="annot"><span class="annottext">TermTypeM b
</span><a href="#local-6989586621684555826"><span class="hs-identifier hs-var">m2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-884"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684555825"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684555825"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684555824"><span class="annot"><span class="annottext">Occurrences
</span><a href="#local-6989586621684555824"><span class="hs-identifier hs-var">occurs1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TermTypeM a -&gt; TermTypeM (a, Occurrences)
forall a. TermTypeM a -&gt; TermTypeM (a, Occurrences)
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#collectOccurrences"><span class="hs-identifier hs-var">collectOccurrences</span></a></span><span> </span><span class="annot"><span class="annottext">(TermTypeM a -&gt; TermTypeM (a, Occurrences))
-&gt; TermTypeM a -&gt; TermTypeM (a, Occurrences)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TermTypeM a -&gt; TermTypeM a
forall a. TermTypeM a -&gt; TermTypeM a
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#noSizeEscape"><span class="hs-identifier hs-var">noSizeEscape</span></a></span><span> </span><span class="annot"><span class="annottext">TermTypeM a
</span><a href="#local-6989586621684555827"><span class="hs-identifier hs-var">m1</span></a></span><span>
</span><span id="line-885"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684555823"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684555823"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684555822"><span class="annot"><span class="annottext">Occurrences
</span><a href="#local-6989586621684555822"><span class="hs-identifier hs-var">occurs2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TermTypeM b -&gt; TermTypeM (b, Occurrences)
forall a. TermTypeM a -&gt; TermTypeM (a, Occurrences)
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#collectOccurrences"><span class="hs-identifier hs-var">collectOccurrences</span></a></span><span> </span><span class="annot"><span class="annottext">(TermTypeM b -&gt; TermTypeM (b, Occurrences))
-&gt; TermTypeM b -&gt; TermTypeM (b, Occurrences)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TermTypeM b -&gt; TermTypeM b
forall a. TermTypeM a -&gt; TermTypeM a
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#noSizeEscape"><span class="hs-identifier hs-var">noSizeEscape</span></a></span><span> </span><span class="annot"><span class="annottext">TermTypeM b
</span><a href="#local-6989586621684555826"><span class="hs-identifier hs-var">m2</span></a></span><span>
</span><span id="line-886"></span><span>  </span><span class="annot"><span class="annottext">Occurrences -&gt; TermTypeM ()
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#checkOccurrences"><span class="hs-identifier hs-var">checkOccurrences</span></a></span><span> </span><span class="annot"><span class="annottext">Occurrences
</span><a href="#local-6989586621684555824"><span class="hs-identifier hs-var">occurs1</span></a></span><span>
</span><span id="line-887"></span><span>  </span><span class="annot"><span class="annottext">Occurrences -&gt; TermTypeM ()
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#checkOccurrences"><span class="hs-identifier hs-var">checkOccurrences</span></a></span><span> </span><span class="annot"><span class="annottext">Occurrences
</span><a href="#local-6989586621684555822"><span class="hs-identifier hs-var">occurs2</span></a></span><span>
</span><span id="line-888"></span><span>  </span><span class="annot"><span class="annottext">Occurrences -&gt; TermTypeM ()
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#occur"><span class="hs-identifier hs-var">occur</span></a></span><span> </span><span class="annot"><span class="annottext">(Occurrences -&gt; TermTypeM ()) -&gt; Occurrences -&gt; TermTypeM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Occurrences
</span><a href="#local-6989586621684555824"><span class="hs-identifier hs-var">occurs1</span></a></span><span> </span><span class="annot"><span class="annottext">Occurrences -&gt; Occurrences -&gt; Occurrences
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#altOccurrences"><span class="hs-operator hs-var">`altOccurrences`</span></a></span><span> </span><span class="annot"><span class="annottext">Occurrences
</span><a href="#local-6989586621684555822"><span class="hs-identifier hs-var">occurs2</span></a></span><span>
</span><span id="line-889"></span><span>  </span><span class="annot"><span class="annottext">(a, b) -&gt; TermTypeM (a, b)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684555825"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684555823"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-890"></span><span>
</span><span id="line-891"></span><span id="local-6989586621684557651"><span id="local-6989586621684557652"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#sequentially"><span class="hs-identifier hs-type">sequentially</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684557652"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621684557652"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Occurrences"><span class="hs-identifier hs-type">Occurrences</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684557651"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684557651"><span class="hs-identifier hs-type">b</span></a></span></span></span><span>
</span><span id="line-892"></span><span id="sequentially"><span class="annot"><span class="annottext">sequentially :: forall a b.
TermTypeM a -&gt; (a -&gt; Occurrences -&gt; TermTypeM b) -&gt; TermTypeM b
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#sequentially"><span class="hs-identifier hs-var hs-var">sequentially</span></a></span></span><span> </span><span id="local-6989586621684555817"><span class="annot"><span class="annottext">TermTypeM a
</span><a href="#local-6989586621684555817"><span class="hs-identifier hs-var">m1</span></a></span></span><span> </span><span id="local-6989586621684555816"><span class="annot"><span class="annottext">a -&gt; Occurrences -&gt; TermTypeM b
</span><a href="#local-6989586621684555816"><span class="hs-identifier hs-var">m2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-893"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684555815"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684555815"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684555814"><span class="annot"><span class="annottext">Occurrences
</span><a href="#local-6989586621684555814"><span class="hs-identifier hs-var">m1flow</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TermTypeM a -&gt; TermTypeM (a, Occurrences)
forall a. TermTypeM a -&gt; TermTypeM (a, Occurrences)
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#collectOccurrences"><span class="hs-identifier hs-var">collectOccurrences</span></a></span><span> </span><span class="annot"><span class="annottext">TermTypeM a
</span><a href="#local-6989586621684555817"><span class="hs-identifier hs-var">m1</span></a></span><span>
</span><span id="line-894"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684555813"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684555813"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684555812"><span class="annot"><span class="annottext">Occurrences
</span><a href="#local-6989586621684555812"><span class="hs-identifier hs-var">m2flow</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TermTypeM b -&gt; TermTypeM (b, Occurrences)
forall a. TermTypeM a -&gt; TermTypeM (a, Occurrences)
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#collectOccurrences"><span class="hs-identifier hs-var">collectOccurrences</span></a></span><span> </span><span class="annot"><span class="annottext">(TermTypeM b -&gt; TermTypeM (b, Occurrences))
-&gt; TermTypeM b -&gt; TermTypeM (b, Occurrences)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Occurrences -&gt; TermTypeM b
</span><a href="#local-6989586621684555816"><span class="hs-identifier hs-var">m2</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684555815"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">Occurrences
</span><a href="#local-6989586621684555814"><span class="hs-identifier hs-var">m1flow</span></a></span><span>
</span><span id="line-895"></span><span>  </span><span class="annot"><span class="annottext">Occurrences -&gt; TermTypeM ()
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#occur"><span class="hs-identifier hs-var">occur</span></a></span><span> </span><span class="annot"><span class="annottext">(Occurrences -&gt; TermTypeM ()) -&gt; Occurrences -&gt; TermTypeM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Occurrences
</span><a href="#local-6989586621684555814"><span class="hs-identifier hs-var">m1flow</span></a></span><span> </span><span class="annot"><span class="annottext">Occurrences -&gt; Occurrences -&gt; Occurrences
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#seqOccurrences"><span class="hs-operator hs-var">`seqOccurrences`</span></a></span><span> </span><span class="annot"><span class="annottext">Occurrences
</span><a href="#local-6989586621684555812"><span class="hs-identifier hs-var">m2flow</span></a></span><span>
</span><span id="line-896"></span><span>  </span><span class="annot"><span class="annottext">b -&gt; TermTypeM b
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684555813"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-897"></span><span>
</span><span id="line-898"></span><span class="hs-comment">--- Consumption</span><span>
</span><span id="line-899"></span><span>
</span><span id="line-900"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#occur"><span class="hs-identifier hs-type">occur</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Occurrences"><span class="hs-identifier hs-type">Occurrences</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-901"></span><span id="occur"><span class="annot"><span class="annottext">occur :: Occurrences -&gt; TermTypeM ()
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#occur"><span class="hs-identifier hs-var hs-var">occur</span></a></span></span><span> </span><span id="local-6989586621684555811"><span class="annot"><span class="annottext">Occurrences
</span><a href="#local-6989586621684555811"><span class="hs-identifier hs-var">occs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TermTypeState -&gt; TermTypeState) -&gt; TermTypeM ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((TermTypeState -&gt; TermTypeState) -&gt; TermTypeM ())
-&gt; (TermTypeState -&gt; TermTypeState) -&gt; TermTypeM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684555810"><span class="annot"><span class="annottext">TermTypeState
</span><a href="#local-6989586621684555810"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TermTypeState
</span><a href="#local-6989586621684555810"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">stateOccs :: Occurrences
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#stateOccs"><span class="hs-identifier hs-var">stateOccs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TermTypeState -&gt; Occurrences
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#stateOccs"><span class="hs-identifier hs-var hs-var">stateOccs</span></a></span><span> </span><span class="annot"><span class="annottext">TermTypeState
</span><a href="#local-6989586621684555810"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">Occurrences -&gt; Occurrences -&gt; Occurrences
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Occurrences
</span><a href="#local-6989586621684555811"><span class="hs-identifier hs-var">occs</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-902"></span><span>
</span><span id="line-903"></span><span class="hs-comment">-- | Proclaim that we have made read-only use of the given variable.</span><span>
</span><span id="line-904"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#observe"><span class="hs-identifier hs-type">observe</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.html#Ident"><span class="hs-identifier hs-type">Ident</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-905"></span><span id="observe"><span class="annot"><span class="annottext">observe :: Ident -&gt; TermTypeM ()
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#observe"><span class="hs-identifier hs-var hs-var">observe</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Ident"><span class="hs-identifier hs-type">Ident</span></a></span><span> </span><span id="local-6989586621684555809"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684555809"><span class="hs-identifier hs-var">nm</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-type">Info</span></a></span><span> </span><span id="local-6989586621684555808"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684555808"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684555807"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684555807"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-906"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684555804"><span class="annot"><span class="annottext">als :: Aliasing
</span><a href="#local-6989586621684555804"><span class="hs-identifier hs-var hs-var">als</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Alias
</span><a href="Language.Futhark.Syntax.html#AliasBound"><span class="hs-identifier hs-var">AliasBound</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684555809"><span class="hs-identifier hs-var">nm</span></a></span><span> </span><span class="annot"><span class="annottext">Alias -&gt; Aliasing -&gt; Aliasing
forall a. Ord a =&gt; a -&gt; Set a -&gt; Set a
</span><span class="hs-operator hs-var">`S.insert`</span></span><span> </span><span class="annot"><span class="annottext">PatType -&gt; Aliasing
forall as shape. Monoid as =&gt; TypeBase shape as -&gt; as
</span><a href="Language.Futhark.Prop.html#aliases"><span class="hs-identifier hs-var">aliases</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684555808"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-907"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Occurrences -&gt; TermTypeM ()
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#occur"><span class="hs-identifier hs-var">occur</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Aliasing -&gt; SrcLoc -&gt; Occurrence
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#observation"><span class="hs-identifier hs-var">observation</span></a></span><span> </span><span class="annot"><span class="annottext">Aliasing
</span><a href="#local-6989586621684555804"><span class="hs-identifier hs-var">als</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684555807"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-908"></span><span>
</span><span id="line-909"></span><span id="local-6989586621684555801"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#onlySelfAliasing"><span class="hs-identifier hs-type">onlySelfAliasing</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684555801"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684555801"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-910"></span><span id="onlySelfAliasing"><span class="annot"><span class="annottext">onlySelfAliasing :: forall a. TermTypeM a -&gt; TermTypeM a
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#onlySelfAliasing"><span class="hs-identifier hs-var hs-var">onlySelfAliasing</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TermScope -&gt; TermScope) -&gt; TermTypeM a -&gt; TermTypeM a
forall a. (TermScope -&gt; TermScope) -&gt; TermTypeM a -&gt; TermTypeM a
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#localScope"><span class="hs-identifier hs-var">localScope</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621684555800"><span class="annot"><span class="annottext">TermScope
</span><a href="#local-6989586621684555800"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TermScope
</span><a href="#local-6989586621684555800"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">scopeVtable :: Map VName ValBinding
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#scopeVtable"><span class="hs-identifier hs-var">scopeVtable</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; ValBinding -&gt; ValBinding)
-&gt; Map VName ValBinding -&gt; Map VName ValBinding
forall k a b. (k -&gt; a -&gt; b) -&gt; Map k a -&gt; Map k b
</span><span class="hs-identifier hs-var">M.mapWithKey</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; ValBinding -&gt; ValBinding
</span><a href="#local-6989586621684555799"><span class="hs-identifier hs-var">set</span></a></span><span> </span><span class="annot"><span class="annottext">(Map VName ValBinding -&gt; Map VName ValBinding)
-&gt; Map VName ValBinding -&gt; Map VName ValBinding
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TermScope -&gt; Map VName ValBinding
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#scopeVtable"><span class="hs-identifier hs-var hs-var">scopeVtable</span></a></span><span> </span><span class="annot"><span class="annottext">TermScope
</span><a href="#local-6989586621684555800"><span class="hs-identifier hs-var">scope</span></a></span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-911"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-912"></span><span>    </span><span id="local-6989586621684555799"><span class="annot"><span class="annottext">set :: VName -&gt; ValBinding -&gt; ValBinding
</span><a href="#local-6989586621684555799"><span class="hs-identifier hs-var hs-var">set</span></a></span></span><span> </span><span id="local-6989586621684555797"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684555797"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#BoundV"><span class="hs-identifier hs-type">BoundV</span></a></span><span> </span><span id="local-6989586621684555796"><span class="annot"><span class="annottext">Locality
</span><a href="#local-6989586621684555796"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span id="local-6989586621684555795"><span class="annot"><span class="annottext">[TypeParam]
</span><a href="#local-6989586621684555795"><span class="hs-identifier hs-var">tparams</span></a></span></span><span> </span><span id="local-6989586621684555794"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684555794"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-913"></span><span>      </span><span class="annot"><span class="annottext">Locality -&gt; [TypeParam] -&gt; PatType -&gt; ValBinding
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#BoundV"><span class="hs-identifier hs-var">BoundV</span></a></span><span> </span><span class="annot"><span class="annottext">Locality
</span><a href="#local-6989586621684555796"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeParam]
</span><a href="#local-6989586621684555795"><span class="hs-identifier hs-var">tparams</span></a></span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; ValBinding) -&gt; PatType -&gt; ValBinding
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-914"></span><span>        </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684555794"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">PatType -&gt; (Aliasing -&gt; Aliasing) -&gt; PatType
forall dim asf ast.
TypeBase dim asf -&gt; (asf -&gt; ast) -&gt; TypeBase dim ast
</span><a href="Language.Futhark.Prop.html#addAliases"><span class="hs-operator hs-var">`addAliases`</span></a></span><span> </span><span class="annot"><span class="annottext">Aliasing -&gt; Aliasing -&gt; Aliasing
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><span class="hs-identifier hs-var">S.intersection</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Alias -&gt; Aliasing
forall a. a -&gt; Set a
</span><span class="hs-identifier hs-var">S.singleton</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Alias
</span><a href="Language.Futhark.Syntax.html#AliasBound"><span class="hs-identifier hs-var">AliasBound</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684555797"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-915"></span><span>    </span><span class="annot"><a href="#local-6989586621684555799"><span class="hs-identifier hs-var">set</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#OverloadedF"><span class="hs-identifier hs-type">OverloadedF</span></a></span><span> </span><span id="local-6989586621684555791"><span class="annot"><span class="annottext">[PrimType]
</span><a href="#local-6989586621684555791"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span id="local-6989586621684555790"><span class="annot"><span class="annottext">[Maybe PrimType]
</span><a href="#local-6989586621684555790"><span class="hs-identifier hs-var">pts</span></a></span></span><span> </span><span id="local-6989586621684555789"><span class="annot"><span class="annottext">Maybe PrimType
</span><a href="#local-6989586621684555789"><span class="hs-identifier hs-var">rt</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[PrimType] -&gt; [Maybe PrimType] -&gt; Maybe PrimType -&gt; ValBinding
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#OverloadedF"><span class="hs-identifier hs-var">OverloadedF</span></a></span><span> </span><span class="annot"><span class="annottext">[PrimType]
</span><a href="#local-6989586621684555791"><span class="hs-identifier hs-var">ts</span></a></span><span> </span><span class="annot"><span class="annottext">[Maybe PrimType]
</span><a href="#local-6989586621684555790"><span class="hs-identifier hs-var">pts</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe PrimType
</span><a href="#local-6989586621684555789"><span class="hs-identifier hs-var">rt</span></a></span><span>
</span><span id="line-916"></span><span>    </span><span class="annot"><a href="#local-6989586621684555799"><span class="hs-identifier hs-var">set</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ValBinding
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#EqualityF"><span class="hs-identifier hs-var">EqualityF</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ValBinding
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#EqualityF"><span class="hs-identifier hs-var">EqualityF</span></a></span><span>
</span><span id="line-917"></span><span>    </span><span class="annot"><a href="#local-6989586621684555799"><span class="hs-identifier hs-var">set</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#WasConsumed"><span class="hs-identifier hs-type">WasConsumed</span></a></span><span> </span><span id="local-6989586621684555788"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684555788"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SrcLoc -&gt; ValBinding
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#WasConsumed"><span class="hs-identifier hs-var">WasConsumed</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684555788"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-918"></span><span>
</span><span id="line-919"></span><span class="hs-comment">-- | Enter a context where nothing outside can be consumed (i.e. the</span><span>
</span><span id="line-920"></span><span class="hs-comment">-- body of a function definition).</span><span>
</span><span id="line-921"></span><span id="local-6989586621684555787"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#noUnique"><span class="hs-identifier hs-type">noUnique</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684555787"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684555787"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-922"></span><span id="noUnique"><span class="annot"><span class="annottext">noUnique :: forall a. TermTypeM a -&gt; TermTypeM a
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#noUnique"><span class="hs-identifier hs-var hs-var">noUnique</span></a></span></span><span> </span><span id="local-6989586621684555782"><span class="annot"><span class="annottext">TermTypeM a
</span><a href="#local-6989586621684555782"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-923"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684555781"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684555781"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684555780"><span class="annot"><span class="annottext">Occurrences
</span><a href="#local-6989586621684555780"><span class="hs-identifier hs-var">occs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TermTypeM a -&gt; TermTypeM (a, Occurrences)
forall a. TermTypeM a -&gt; TermTypeM (a, Occurrences)
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#collectOccurrences"><span class="hs-identifier hs-var">collectOccurrences</span></a></span><span> </span><span class="annot"><span class="annottext">(TermTypeM a -&gt; TermTypeM (a, Occurrences))
-&gt; TermTypeM a -&gt; TermTypeM (a, Occurrences)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(TermScope -&gt; TermScope) -&gt; TermTypeM a -&gt; TermTypeM a
forall a. (TermScope -&gt; TermScope) -&gt; TermTypeM a -&gt; TermTypeM a
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#localScope"><span class="hs-identifier hs-var">localScope</span></a></span><span> </span><span class="annot"><span class="annottext">TermScope -&gt; TermScope
</span><a href="#local-6989586621684555779"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">TermTypeM a
</span><a href="#local-6989586621684555782"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-924"></span><span>  </span><span class="annot"><span class="annottext">Occurrences -&gt; TermTypeM ()
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#checkOccurrences"><span class="hs-identifier hs-var">checkOccurrences</span></a></span><span> </span><span class="annot"><span class="annottext">Occurrences
</span><a href="#local-6989586621684555780"><span class="hs-identifier hs-var">occs</span></a></span><span>
</span><span id="line-925"></span><span>  </span><span class="annot"><span class="annottext">Occurrences -&gt; TermTypeM ()
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#occur"><span class="hs-identifier hs-var">occur</span></a></span><span> </span><span class="annot"><span class="annottext">(Occurrences -&gt; TermTypeM ()) -&gt; Occurrences -&gt; TermTypeM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Occurrences, Occurrences) -&gt; Occurrences
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">((Occurrences, Occurrences) -&gt; Occurrences)
-&gt; (Occurrences, Occurrences) -&gt; Occurrences
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Occurrences -&gt; (Occurrences, Occurrences)
</span><a href="#local-6989586621684555778"><span class="hs-identifier hs-var">split</span></a></span><span> </span><span class="annot"><span class="annottext">Occurrences
</span><a href="#local-6989586621684555780"><span class="hs-identifier hs-var">occs</span></a></span><span>
</span><span id="line-926"></span><span>  </span><span class="annot"><span class="annottext">a -&gt; TermTypeM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684555781"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-927"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-928"></span><span>    </span><span id="local-6989586621684555779"><span class="annot"><span class="annottext">f :: TermScope -&gt; TermScope
</span><a href="#local-6989586621684555779"><span class="hs-identifier hs-var hs-var">f</span></a></span></span><span> </span><span id="local-6989586621684555777"><span class="annot"><span class="annottext">TermScope
</span><a href="#local-6989586621684555777"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TermScope
</span><a href="#local-6989586621684555777"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">scopeVtable :: Map VName ValBinding
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#scopeVtable"><span class="hs-identifier hs-var">scopeVtable</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ValBinding -&gt; ValBinding)
-&gt; Map VName ValBinding -&gt; Map VName ValBinding
forall a b k. (a -&gt; b) -&gt; Map k a -&gt; Map k b
</span><span class="hs-identifier hs-var">M.map</span></span><span> </span><span class="annot"><span class="annottext">ValBinding -&gt; ValBinding
</span><a href="#local-6989586621684555775"><span class="hs-identifier hs-var">set</span></a></span><span> </span><span class="annot"><span class="annottext">(Map VName ValBinding -&gt; Map VName ValBinding)
-&gt; Map VName ValBinding -&gt; Map VName ValBinding
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TermScope -&gt; Map VName ValBinding
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#scopeVtable"><span class="hs-identifier hs-var hs-var">scopeVtable</span></a></span><span> </span><span class="annot"><span class="annottext">TermScope
</span><a href="#local-6989586621684555777"><span class="hs-identifier hs-var">scope</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-929"></span><span>
</span><span id="line-930"></span><span>    </span><span id="local-6989586621684555775"><span class="annot"><span class="annottext">set :: ValBinding -&gt; ValBinding
</span><a href="#local-6989586621684555775"><span class="hs-identifier hs-var hs-var">set</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#BoundV"><span class="hs-identifier hs-type">BoundV</span></a></span><span> </span><span id="local-6989586621684555774"><span class="annot"><span class="annottext">Locality
</span><a href="#local-6989586621684555774"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span id="local-6989586621684555773"><span class="annot"><span class="annottext">[TypeParam]
</span><a href="#local-6989586621684555773"><span class="hs-identifier hs-var">tparams</span></a></span></span><span> </span><span id="local-6989586621684555772"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684555772"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Locality -&gt; [TypeParam] -&gt; PatType -&gt; ValBinding
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#BoundV"><span class="hs-identifier hs-var">BoundV</span></a></span><span> </span><span class="annot"><span class="annottext">Locality
</span><a href="#local-6989586621684555774"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeParam]
</span><a href="#local-6989586621684555773"><span class="hs-identifier hs-var">tparams</span></a></span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; ValBinding) -&gt; PatType -&gt; ValBinding
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684555772"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">PatType -&gt; Uniqueness -&gt; PatType
forall dim as. TypeBase dim as -&gt; Uniqueness -&gt; TypeBase dim as
</span><a href="Language.Futhark.Prop.html#setUniqueness"><span class="hs-operator hs-var">`setUniqueness`</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="Language.Futhark.Core.html#Nonunique"><span class="hs-identifier hs-var">Nonunique</span></a></span><span>
</span><span id="line-931"></span><span>    </span><span class="annot"><a href="#local-6989586621684555775"><span class="hs-identifier hs-var">set</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#OverloadedF"><span class="hs-identifier hs-type">OverloadedF</span></a></span><span> </span><span id="local-6989586621684555770"><span class="annot"><span class="annottext">[PrimType]
</span><a href="#local-6989586621684555770"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span id="local-6989586621684555769"><span class="annot"><span class="annottext">[Maybe PrimType]
</span><a href="#local-6989586621684555769"><span class="hs-identifier hs-var">pts</span></a></span></span><span> </span><span id="local-6989586621684555768"><span class="annot"><span class="annottext">Maybe PrimType
</span><a href="#local-6989586621684555768"><span class="hs-identifier hs-var">rt</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[PrimType] -&gt; [Maybe PrimType] -&gt; Maybe PrimType -&gt; ValBinding
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#OverloadedF"><span class="hs-identifier hs-var">OverloadedF</span></a></span><span> </span><span class="annot"><span class="annottext">[PrimType]
</span><a href="#local-6989586621684555770"><span class="hs-identifier hs-var">ts</span></a></span><span> </span><span class="annot"><span class="annottext">[Maybe PrimType]
</span><a href="#local-6989586621684555769"><span class="hs-identifier hs-var">pts</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe PrimType
</span><a href="#local-6989586621684555768"><span class="hs-identifier hs-var">rt</span></a></span><span>
</span><span id="line-932"></span><span>    </span><span class="annot"><a href="#local-6989586621684555775"><span class="hs-identifier hs-var">set</span></a></span><span> </span><span class="annot"><span class="annottext">ValBinding
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#EqualityF"><span class="hs-identifier hs-var">EqualityF</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ValBinding
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#EqualityF"><span class="hs-identifier hs-var">EqualityF</span></a></span><span>
</span><span id="line-933"></span><span>    </span><span class="annot"><a href="#local-6989586621684555775"><span class="hs-identifier hs-var">set</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#WasConsumed"><span class="hs-identifier hs-type">WasConsumed</span></a></span><span> </span><span id="local-6989586621684555767"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684555767"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SrcLoc -&gt; ValBinding
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#WasConsumed"><span class="hs-identifier hs-var">WasConsumed</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684555767"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-934"></span><span>
</span><span id="line-935"></span><span>    </span><span id="local-6989586621684555778"><span class="annot"><span class="annottext">split :: Occurrences -&gt; (Occurrences, Occurrences)
</span><a href="#local-6989586621684555778"><span class="hs-identifier hs-var hs-var">split</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Occurrence, Occurrence)] -&gt; (Occurrences, Occurrences)
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(Occurrence, Occurrence)] -&gt; (Occurrences, Occurrences))
-&gt; (Occurrences -&gt; [(Occurrence, Occurrence)])
-&gt; Occurrences
-&gt; (Occurrences, Occurrences)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Occurrence -&gt; (Occurrence, Occurrence))
-&gt; Occurrences -&gt; [(Occurrence, Occurrence)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621684555761"><span class="annot"><span class="annottext">Occurrence
</span><a href="#local-6989586621684555761"><span class="hs-identifier hs-var">occ</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Occurrence
</span><a href="#local-6989586621684555761"><span class="hs-identifier hs-var">occ</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">consumed :: Maybe Names
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#consumed"><span class="hs-identifier hs-var">consumed</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Occurrence
</span><a href="#local-6989586621684555761"><span class="hs-identifier hs-var">occ</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">observed :: Names
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#observed"><span class="hs-identifier hs-var">observed</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-936"></span><span>
</span><span id="line-937"></span><span id="local-6989586621684555760"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#removeSeminullOccurrences"><span class="hs-identifier hs-type">removeSeminullOccurrences</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684555760"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684555760"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-938"></span><span id="removeSeminullOccurrences"><span class="annot"><span class="annottext">removeSeminullOccurrences :: forall a. TermTypeM a -&gt; TermTypeM a
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#removeSeminullOccurrences"><span class="hs-identifier hs-var hs-var">removeSeminullOccurrences</span></a></span></span><span> </span><span id="local-6989586621684555756"><span class="annot"><span class="annottext">TermTypeM a
</span><a href="#local-6989586621684555756"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-939"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684555755"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684555755"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684555754"><span class="annot"><span class="annottext">Occurrences
</span><a href="#local-6989586621684555754"><span class="hs-identifier hs-var">occs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TermTypeM a -&gt; TermTypeM (a, Occurrences)
forall a. TermTypeM a -&gt; TermTypeM (a, Occurrences)
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#collectOccurrences"><span class="hs-identifier hs-var">collectOccurrences</span></a></span><span> </span><span class="annot"><span class="annottext">TermTypeM a
</span><a href="#local-6989586621684555756"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-940"></span><span>  </span><span class="annot"><span class="annottext">Occurrences -&gt; TermTypeM ()
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#occur"><span class="hs-identifier hs-var">occur</span></a></span><span> </span><span class="annot"><span class="annottext">(Occurrences -&gt; TermTypeM ()) -&gt; Occurrences -&gt; TermTypeM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Occurrence -&gt; Bool) -&gt; Occurrences -&gt; Occurrences
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; (Occurrence -&gt; Bool) -&gt; Occurrence -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Occurrence -&gt; Bool
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#seminullOccurrence"><span class="hs-identifier hs-var">seminullOccurrence</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Occurrences
</span><a href="#local-6989586621684555754"><span class="hs-identifier hs-var">occs</span></a></span><span>
</span><span id="line-941"></span><span>  </span><span class="annot"><span class="annottext">a -&gt; TermTypeM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684555755"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-942"></span><span>
</span><span id="line-943"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#checkIfConsumable"><span class="hs-identifier hs-type">checkIfConsumable</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SrcLoc</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#Aliasing"><span class="hs-identifier hs-type">Aliasing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-944"></span><span id="checkIfConsumable"><span class="annot"><span class="annottext">checkIfConsumable :: SrcLoc -&gt; Aliasing -&gt; TermTypeM ()
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#checkIfConsumable"><span class="hs-identifier hs-var hs-var">checkIfConsumable</span></a></span></span><span> </span><span id="local-6989586621684555753"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684555753"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span id="local-6989586621684555752"><span class="annot"><span class="annottext">Aliasing
</span><a href="#local-6989586621684555752"><span class="hs-identifier hs-var">als</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-945"></span><span>  </span><span id="local-6989586621684555751"><span class="annot"><span class="annottext">Map VName ValBinding
</span><a href="#local-6989586621684555751"><span class="hs-identifier hs-var">vtable</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TermEnv -&gt; Map VName ValBinding)
-&gt; TermTypeM (Map VName ValBinding)
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">((TermEnv -&gt; Map VName ValBinding)
 -&gt; TermTypeM (Map VName ValBinding))
-&gt; (TermEnv -&gt; Map VName ValBinding)
-&gt; TermTypeM (Map VName ValBinding)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TermScope -&gt; Map VName ValBinding
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#scopeVtable"><span class="hs-identifier hs-var hs-var">scopeVtable</span></a></span><span> </span><span class="annot"><span class="annottext">(TermScope -&gt; Map VName ValBinding)
-&gt; (TermEnv -&gt; TermScope) -&gt; TermEnv -&gt; Map VName ValBinding
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TermEnv -&gt; TermScope
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#termScope"><span class="hs-identifier hs-var hs-var">termScope</span></a></span><span>
</span><span id="line-946"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684555747"><span class="annot"><span class="annottext">consumable :: VName -&gt; Bool
</span><a href="#local-6989586621684555747"><span class="hs-identifier hs-var hs-var">consumable</span></a></span></span><span> </span><span id="local-6989586621684555746"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684555746"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Map VName ValBinding -&gt; Maybe ValBinding
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684555746"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName ValBinding
</span><a href="#local-6989586621684555751"><span class="hs-identifier hs-var">vtable</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-947"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#BoundV"><span class="hs-identifier hs-type">BoundV</span></a></span><span> </span><span class="annot"><span class="annottext">Locality
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Local"><span class="hs-identifier hs-var">Local</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeParam]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684555745"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684555745"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-948"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">PatType -&gt; Int
forall dim as. TypeBase dim as -&gt; Int
</span><a href="Language.Futhark.Prop.html#arrayRank"><span class="hs-identifier hs-var">arrayRank</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684555745"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">PatType -&gt; Bool
forall shape as. TypeBase shape as -&gt; Bool
</span><a href="Language.Futhark.Prop.html#unique"><span class="hs-identifier hs-var">unique</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684555745"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-949"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeVar"><span class="hs-identifier hs-type">TypeVar</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684555745"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">PatType -&gt; Bool
forall shape as. TypeBase shape as -&gt; Bool
</span><a href="Language.Futhark.Prop.html#unique"><span class="hs-identifier hs-var">unique</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684555745"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-950"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#Arrow"><span class="hs-identifier hs-type">Arrow</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684555745"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-951"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-952"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#BoundV"><span class="hs-identifier hs-type">BoundV</span></a></span><span> </span><span class="annot"><span class="annottext">Locality
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Global"><span class="hs-identifier hs-var">Global</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeParam]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">PatType
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-953"></span><span>        </span><span class="annot"><span class="annottext">Maybe ValBinding
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-954"></span><span>  </span><span class="hs-comment">-- The sort ensures that AliasBound vars are shown before AliasFree.</span><span>
</span><span id="line-955"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(Alias -&gt; VName) -&gt; [Alias] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Alias -&gt; VName
</span><a href="Language.Futhark.Syntax.html#aliasVar"><span class="hs-identifier hs-var hs-var">aliasVar</span></a></span><span> </span><span class="annot"><span class="annottext">([Alias] -&gt; [VName]) -&gt; [Alias] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Alias] -&gt; [Alias]
forall a. Ord a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">sort</span></span><span> </span><span class="annot"><span class="annottext">([Alias] -&gt; [Alias]) -&gt; [Alias] -&gt; [Alias]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Alias -&gt; Bool) -&gt; [Alias] -&gt; [Alias]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; (Alias -&gt; Bool) -&gt; Alias -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Bool
</span><a href="#local-6989586621684555747"><span class="hs-identifier hs-var">consumable</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Bool) -&gt; (Alias -&gt; VName) -&gt; Alias -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Alias -&gt; VName
</span><a href="Language.Futhark.Syntax.html#aliasVar"><span class="hs-identifier hs-var hs-var">aliasVar</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Alias] -&gt; [Alias]) -&gt; [Alias] -&gt; [Alias]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Aliasing -&gt; [Alias]
forall a. Set a -&gt; [a]
</span><span class="hs-identifier hs-var">S.toList</span></span><span> </span><span class="annot"><span class="annottext">Aliasing
</span><a href="#local-6989586621684555752"><span class="hs-identifier hs-var">als</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-956"></span><span>    </span><span id="local-6989586621684555742"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684555742"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SrcLoc -&gt; Doc -&gt; TermTypeM ()
forall (m :: * -&gt; *) b. MonadTypeChecker m =&gt; SrcLoc -&gt; Doc -&gt; m b
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#notConsumable"><span class="hs-identifier hs-var">notConsumable</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684555753"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; TermTypeM ()) -&gt; TermTypeM Doc -&gt; TermTypeM ()
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc -&gt; VName -&gt; TermTypeM Doc
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#describeVar"><span class="hs-identifier hs-var">describeVar</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684555753"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684555742"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-957"></span><span>    </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; TermTypeM ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-958"></span><span>
</span><span id="line-959"></span><span class="hs-comment">-- | Proclaim that we have written to the given variable.</span><span>
</span><span id="line-960"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#consume"><span class="hs-identifier hs-type">consume</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SrcLoc</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#Aliasing"><span class="hs-identifier hs-type">Aliasing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-961"></span><span id="consume"><span class="annot"><span class="annottext">consume :: SrcLoc -&gt; Aliasing -&gt; TermTypeM ()
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#consume"><span class="hs-identifier hs-var hs-var">consume</span></a></span></span><span> </span><span id="local-6989586621684555741"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684555741"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span id="local-6989586621684555740"><span class="annot"><span class="annottext">Aliasing
</span><a href="#local-6989586621684555740"><span class="hs-identifier hs-var">als</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-962"></span><span>  </span><span class="annot"><span class="annottext">SrcLoc -&gt; Aliasing -&gt; TermTypeM ()
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#checkIfConsumable"><span class="hs-identifier hs-var">checkIfConsumable</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684555741"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">Aliasing
</span><a href="#local-6989586621684555740"><span class="hs-identifier hs-var">als</span></a></span><span>
</span><span id="line-963"></span><span>  </span><span class="annot"><span class="annottext">Occurrences -&gt; TermTypeM ()
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#occur"><span class="hs-identifier hs-var">occur</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Aliasing -&gt; SrcLoc -&gt; Occurrence
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#consumption"><span class="hs-identifier hs-var">consumption</span></a></span><span> </span><span class="annot"><span class="annottext">Aliasing
</span><a href="#local-6989586621684555740"><span class="hs-identifier hs-var">als</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684555741"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-964"></span><span>
</span><span id="line-965"></span><span class="hs-comment">-- | Proclaim that we have written to the given variable, and mark</span><span>
</span><span id="line-966"></span><span class="hs-comment">-- accesses to it and all of its aliases as invalid inside the given</span><span>
</span><span id="line-967"></span><span class="hs-comment">-- computation.</span><span>
</span><span id="line-968"></span><span id="local-6989586621684557627"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#consuming"><span class="hs-identifier hs-type">consuming</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.html#Ident"><span class="hs-identifier hs-type">Ident</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684557627"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684557627"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-969"></span><span id="consuming"><span class="annot"><span class="annottext">consuming :: forall a. Ident -&gt; TermTypeM a -&gt; TermTypeM a
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#consuming"><span class="hs-identifier hs-var hs-var">consuming</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Ident"><span class="hs-identifier hs-type">Ident</span></a></span><span> </span><span id="local-6989586621684555733"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684555733"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-type">Info</span></a></span><span> </span><span id="local-6989586621684555732"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684555732"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684555731"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684555731"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684555730"><span class="annot"><span class="annottext">TermTypeM a
</span><a href="#local-6989586621684555730"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-970"></span><span>  </span><span id="local-6989586621684555729"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684555729"><span class="hs-identifier hs-var">t'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PatType -&gt; TermTypeM PatType
forall a (m :: * -&gt; *). (Substitutable a, MonadUnify m) =&gt; a -&gt; m a
</span><a href="Language.Futhark.TypeChecker.Unify.html#normTypeFully"><span class="hs-identifier hs-var">normTypeFully</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684555732"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-971"></span><span>  </span><span class="annot"><span class="annottext">SrcLoc -&gt; Aliasing -&gt; TermTypeM ()
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#consume"><span class="hs-identifier hs-var">consume</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684555731"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">(Aliasing -&gt; TermTypeM ()) -&gt; Aliasing -&gt; TermTypeM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Alias
</span><a href="Language.Futhark.Syntax.html#AliasBound"><span class="hs-identifier hs-var">AliasBound</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684555733"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Alias -&gt; Aliasing -&gt; Aliasing
forall a. Ord a =&gt; a -&gt; Set a -&gt; Set a
</span><span class="hs-operator hs-var">`S.insert`</span></span><span> </span><span class="annot"><span class="annottext">PatType -&gt; Aliasing
forall as shape. Monoid as =&gt; TypeBase shape as -&gt; as
</span><a href="Language.Futhark.Prop.html#aliases"><span class="hs-identifier hs-var">aliases</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684555729"><span class="hs-identifier hs-var">t'</span></a></span><span>
</span><span id="line-972"></span><span>  </span><span class="annot"><span class="annottext">(TermScope -&gt; TermScope) -&gt; TermTypeM a -&gt; TermTypeM a
forall a. (TermScope -&gt; TermScope) -&gt; TermTypeM a -&gt; TermTypeM a
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#localScope"><span class="hs-identifier hs-var">localScope</span></a></span><span> </span><span class="annot"><span class="annottext">TermScope -&gt; TermScope
</span><a href="#local-6989586621684555728"><span class="hs-identifier hs-var">consume'</span></a></span><span> </span><span class="annot"><span class="annottext">TermTypeM a
</span><a href="#local-6989586621684555730"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-973"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-974"></span><span>    </span><span id="local-6989586621684555728"><span class="annot"><span class="annottext">consume' :: TermScope -&gt; TermScope
</span><a href="#local-6989586621684555728"><span class="hs-identifier hs-var hs-var">consume'</span></a></span></span><span> </span><span id="local-6989586621684555726"><span class="annot"><span class="annottext">TermScope
</span><a href="#local-6989586621684555726"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-975"></span><span>      </span><span class="annot"><span class="annottext">TermScope
</span><a href="#local-6989586621684555726"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">scopeVtable :: Map VName ValBinding
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#scopeVtable"><span class="hs-identifier hs-var">scopeVtable</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; ValBinding -&gt; Map VName ValBinding -&gt; Map VName ValBinding
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684555733"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SrcLoc -&gt; ValBinding
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#WasConsumed"><span class="hs-identifier hs-var">WasConsumed</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684555731"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Map VName ValBinding -&gt; Map VName ValBinding)
-&gt; Map VName ValBinding -&gt; Map VName ValBinding
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TermScope -&gt; Map VName ValBinding
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#scopeVtable"><span class="hs-identifier hs-var hs-var">scopeVtable</span></a></span><span> </span><span class="annot"><span class="annottext">TermScope
</span><a href="#local-6989586621684555726"><span class="hs-identifier hs-var">scope</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-976"></span><span>
</span><span id="line-977"></span><span class="hs-comment">-- Running</span><span>
</span><span id="line-978"></span><span>
</span><span id="line-979"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#initialTermScope"><span class="hs-identifier hs-type">initialTermScope</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermScope"><span class="hs-identifier hs-type">TermScope</span></a></span><span>
</span><span id="line-980"></span><span id="initialTermScope"><span class="annot"><span class="annottext">initialTermScope :: TermScope
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#initialTermScope"><span class="hs-identifier hs-var hs-var">initialTermScope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-981"></span><span>  </span><span class="annot"><span class="annottext">TermScope :: Map VName ValBinding
-&gt; Map VName TypeBinding -&gt; Map VName Mod -&gt; NameMap -&gt; TermScope
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermScope"><span class="hs-identifier hs-type">TermScope</span></a></span><span>
</span><span id="line-982"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">scopeVtable :: Map VName ValBinding
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#scopeVtable"><span class="hs-identifier hs-var">scopeVtable</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map VName ValBinding
</span><a href="#local-6989586621684555724"><span class="hs-identifier hs-var">initialVtable</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-983"></span><span>      </span><span class="annot"><span class="annottext">scopeTypeTable :: Map VName TypeBinding
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#scopeTypeTable"><span class="hs-identifier hs-var">scopeTypeTable</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map VName TypeBinding
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">,</span><span>
</span><span id="line-984"></span><span>      </span><span class="annot"><span class="annottext">scopeNameMap :: NameMap
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#scopeNameMap"><span class="hs-identifier hs-var">scopeNameMap</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NameMap
</span><a href="Language.Futhark.TypeChecker.Monad.html#topLevelNameMap"><span class="hs-identifier hs-var">topLevelNameMap</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-985"></span><span>      </span><span class="annot"><span class="annottext">scopeModTable :: Map VName Mod
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#scopeModTable"><span class="hs-identifier hs-var">scopeModTable</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map VName Mod
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-986"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-987"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-988"></span><span>    </span><span id="local-6989586621684555724"><span class="annot"><span class="annottext">initialVtable :: Map VName ValBinding
</span><a href="#local-6989586621684555724"><span class="hs-identifier hs-var hs-var">initialVtable</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VName, ValBinding)] -&gt; Map VName ValBinding
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="annot"><span class="annottext">([(VName, ValBinding)] -&gt; Map VName ValBinding)
-&gt; [(VName, ValBinding)] -&gt; Map VName ValBinding
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((VName, Intrinsic) -&gt; Maybe (VName, ValBinding))
-&gt; [(VName, Intrinsic)] -&gt; [(VName, ValBinding)]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">mapMaybe</span></span><span> </span><span class="annot"><span class="annottext">(VName, Intrinsic) -&gt; Maybe (VName, ValBinding)
forall {a}. (a, Intrinsic) -&gt; Maybe (a, ValBinding)
</span><a href="#local-6989586621684555720"><span class="hs-identifier hs-var">addIntrinsicF</span></a></span><span> </span><span class="annot"><span class="annottext">([(VName, Intrinsic)] -&gt; [(VName, ValBinding)])
-&gt; [(VName, Intrinsic)] -&gt; [(VName, ValBinding)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Map VName Intrinsic -&gt; [(VName, Intrinsic)]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">M.toList</span></span><span> </span><span class="annot"><span class="annottext">Map VName Intrinsic
</span><a href="Language.Futhark.Prop.html#intrinsics"><span class="hs-identifier hs-var">intrinsics</span></a></span><span>
</span><span id="line-989"></span><span>
</span><span id="line-990"></span><span>    </span><span id="local-6989586621684555717"><span class="annot"><span class="annottext">prim :: PrimType -&gt; TypeBase dim as
</span><a href="#local-6989586621684555717"><span class="hs-keyword hs-var hs-var">prim</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScalarTypeBase dim as -&gt; TypeBase dim as
forall dim as. ScalarTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-var">Scalar</span></a></span><span> </span><span class="annot"><span class="annottext">(ScalarTypeBase dim as -&gt; TypeBase dim as)
-&gt; (PrimType -&gt; ScalarTypeBase dim as)
-&gt; PrimType
-&gt; TypeBase dim as
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; ScalarTypeBase dim as
forall dim as. PrimType -&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span>
</span><span id="line-991"></span><span>    </span><span id="local-6989586621684555714"><span class="annot"><span class="annottext">arrow :: TypeBase dim as -&gt; RetTypeBase dim as -&gt; TypeBase dim as
</span><a href="#local-6989586621684555714"><span class="hs-identifier hs-var hs-var">arrow</span></a></span></span><span> </span><span id="local-6989586621684555713"><span class="annot"><span class="annottext">TypeBase dim as
</span><a href="#local-6989586621684555713"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621684555712"><span class="annot"><span class="annottext">RetTypeBase dim as
</span><a href="#local-6989586621684555712"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScalarTypeBase dim as -&gt; TypeBase dim as
forall dim as. ScalarTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-var">Scalar</span></a></span><span> </span><span class="annot"><span class="annottext">(ScalarTypeBase dim as -&gt; TypeBase dim as)
-&gt; ScalarTypeBase dim as -&gt; TypeBase dim as
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">as
-&gt; PName
-&gt; TypeBase dim as
-&gt; RetTypeBase dim as
-&gt; ScalarTypeBase dim as
forall dim as.
as
-&gt; PName
-&gt; TypeBase dim as
-&gt; RetTypeBase dim as
-&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Arrow"><span class="hs-identifier hs-var">Arrow</span></a></span><span> </span><span class="annot"><span class="annottext">as
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">PName
</span><a href="Language.Futhark.Syntax.html#Unnamed"><span class="hs-identifier hs-var">Unnamed</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase dim as
</span><a href="#local-6989586621684555713"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">RetTypeBase dim as
</span><a href="#local-6989586621684555712"><span class="hs-identifier hs-var">y</span></a></span><span>
</span><span id="line-992"></span><span>
</span><span id="line-993"></span><span>    </span><span id="local-6989586621684555720"><span class="annot"><span class="annottext">addIntrinsicF :: (a, Intrinsic) -&gt; Maybe (a, ValBinding)
</span><a href="#local-6989586621684555720"><span class="hs-identifier hs-var hs-var">addIntrinsicF</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684555708"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684555708"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.Prop.html#IntrinsicMonoFun"><span class="hs-identifier hs-type">IntrinsicMonoFun</span></a></span><span> </span><span id="local-6989586621684555706"><span class="annot"><span class="annottext">[PrimType]
</span><a href="#local-6989586621684555706"><span class="hs-identifier hs-var">pts</span></a></span></span><span> </span><span id="local-6989586621684555705"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684555705"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-994"></span><span>      </span><span class="annot"><span class="annottext">(a, ValBinding) -&gt; Maybe (a, ValBinding)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684555708"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Locality -&gt; [TypeParam] -&gt; PatType -&gt; ValBinding
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#BoundV"><span class="hs-identifier hs-var">BoundV</span></a></span><span> </span><span class="annot"><span class="annottext">Locality
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Global"><span class="hs-identifier hs-var">Global</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; ValBinding) -&gt; PatType -&gt; ValBinding
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatType -&gt; RetTypeBase (DimDecl VName) Aliasing -&gt; PatType
forall {as} {dim}.
Monoid as =&gt;
TypeBase dim as -&gt; RetTypeBase dim as -&gt; TypeBase dim as
</span><a href="#local-6989586621684555714"><span class="hs-identifier hs-var">arrow</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
forall {dim} {as}. TypeBase dim as
</span><a href="#local-6989586621684555704"><span class="hs-identifier hs-var">pts'</span></a></span><span> </span><span class="annot"><span class="annottext">(RetTypeBase (DimDecl VName) Aliasing -&gt; PatType)
-&gt; RetTypeBase (DimDecl VName) Aliasing -&gt; PatType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; PatType -&gt; RetTypeBase (DimDecl VName) Aliasing
forall dim as. [VName] -&gt; TypeBase dim as -&gt; RetTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-var">RetType</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; RetTypeBase (DimDecl VName) Aliasing)
-&gt; PatType -&gt; RetTypeBase (DimDecl VName) Aliasing
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; PatType
forall {dim} {as}. PrimType -&gt; TypeBase dim as
</span><a href="#local-6989586621684555717"><span class="hs-keyword hs-var">prim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684555705"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-995"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-996"></span><span>        </span><span id="local-6989586621684555704"><span class="annot"><span class="annottext">pts' :: TypeBase dim as
</span><a href="#local-6989586621684555704"><span class="hs-identifier hs-var hs-var">pts'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[PrimType]
</span><a href="#local-6989586621684555706"><span class="hs-identifier hs-var">pts</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-997"></span><span>          </span><span class="hs-special">[</span><span id="local-6989586621684555703"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684555703"><span class="hs-identifier hs-var">pt</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; TypeBase dim as
forall {dim} {as}. PrimType -&gt; TypeBase dim as
</span><a href="#local-6989586621684555717"><span class="hs-keyword hs-var">prim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684555703"><span class="hs-identifier hs-var">pt</span></a></span><span>
</span><span id="line-998"></span><span>          </span><span class="annot"><span class="annottext">[PrimType]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ScalarTypeBase dim as -&gt; TypeBase dim as
forall dim as. ScalarTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-var">Scalar</span></a></span><span> </span><span class="annot"><span class="annottext">(ScalarTypeBase dim as -&gt; TypeBase dim as)
-&gt; ScalarTypeBase dim as -&gt; TypeBase dim as
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TypeBase dim as] -&gt; ScalarTypeBase dim as
forall dim as. [TypeBase dim as] -&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Prop.html#tupleRecord"><span class="hs-identifier hs-var">tupleRecord</span></a></span><span> </span><span class="annot"><span class="annottext">([TypeBase dim as] -&gt; ScalarTypeBase dim as)
-&gt; [TypeBase dim as] -&gt; ScalarTypeBase dim as
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(PrimType -&gt; TypeBase dim as) -&gt; [PrimType] -&gt; [TypeBase dim as]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; TypeBase dim as
forall {dim} {as}. PrimType -&gt; TypeBase dim as
</span><a href="#local-6989586621684555717"><span class="hs-keyword hs-var">prim</span></a></span><span> </span><span class="annot"><span class="annottext">[PrimType]
</span><a href="#local-6989586621684555706"><span class="hs-identifier hs-var">pts</span></a></span><span>
</span><span id="line-999"></span><span>    </span><span class="annot"><a href="#local-6989586621684555720"><span class="hs-identifier hs-var">addIntrinsicF</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684555701"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684555701"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.Prop.html#IntrinsicOverloadedFun"><span class="hs-identifier hs-type">IntrinsicOverloadedFun</span></a></span><span> </span><span id="local-6989586621684555699"><span class="annot"><span class="annottext">[PrimType]
</span><a href="#local-6989586621684555699"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span id="local-6989586621684555698"><span class="annot"><span class="annottext">[Maybe PrimType]
</span><a href="#local-6989586621684555698"><span class="hs-identifier hs-var">pts</span></a></span></span><span> </span><span id="local-6989586621684555697"><span class="annot"><span class="annottext">Maybe PrimType
</span><a href="#local-6989586621684555697"><span class="hs-identifier hs-var">rts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1000"></span><span>      </span><span class="annot"><span class="annottext">(a, ValBinding) -&gt; Maybe (a, ValBinding)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684555701"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[PrimType] -&gt; [Maybe PrimType] -&gt; Maybe PrimType -&gt; ValBinding
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#OverloadedF"><span class="hs-identifier hs-var">OverloadedF</span></a></span><span> </span><span class="annot"><span class="annottext">[PrimType]
</span><a href="#local-6989586621684555699"><span class="hs-identifier hs-var">ts</span></a></span><span> </span><span class="annot"><span class="annottext">[Maybe PrimType]
</span><a href="#local-6989586621684555698"><span class="hs-identifier hs-var">pts</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe PrimType
</span><a href="#local-6989586621684555697"><span class="hs-identifier hs-var">rts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1001"></span><span>    </span><span class="annot"><a href="#local-6989586621684555720"><span class="hs-identifier hs-var">addIntrinsicF</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684555696"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684555696"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.Prop.html#IntrinsicPolyFun"><span class="hs-identifier hs-type">IntrinsicPolyFun</span></a></span><span> </span><span id="local-6989586621684555694"><span class="annot"><span class="annottext">[TypeParam]
</span><a href="#local-6989586621684555694"><span class="hs-identifier hs-var">tvs</span></a></span></span><span> </span><span id="local-6989586621684555693"><span class="annot"><span class="annottext">[StructType]
</span><a href="#local-6989586621684555693"><span class="hs-identifier hs-var">pts</span></a></span></span><span> </span><span id="local-6989586621684555692"><span class="annot"><span class="annottext">RetTypeBase (DimDecl VName) ()
</span><a href="#local-6989586621684555692"><span class="hs-identifier hs-var">rt</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1002"></span><span>      </span><span class="annot"><span class="annottext">(a, ValBinding) -&gt; Maybe (a, ValBinding)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span>
</span><span id="line-1003"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684555696"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1004"></span><span>          </span><span class="annot"><span class="annottext">Locality -&gt; [TypeParam] -&gt; PatType -&gt; ValBinding
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#BoundV"><span class="hs-identifier hs-var">BoundV</span></a></span><span> </span><span class="annot"><span class="annottext">Locality
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Global"><span class="hs-identifier hs-var">Global</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeParam]
</span><a href="#local-6989586621684555694"><span class="hs-identifier hs-var">tvs</span></a></span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; ValBinding) -&gt; PatType -&gt; ValBinding
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1005"></span><span>            </span><span class="annot"><span class="annottext">StructType -&gt; PatType
forall dim as. TypeBase dim as -&gt; TypeBase dim Aliasing
</span><a href="Language.Futhark.Prop.html#fromStruct"><span class="hs-identifier hs-var">fromStruct</span></a></span><span> </span><span class="annot"><span class="annottext">(StructType -&gt; PatType) -&gt; StructType -&gt; PatType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ScalarTypeBase (DimDecl VName) () -&gt; StructType
forall dim as. ScalarTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-var">Scalar</span></a></span><span> </span><span class="annot"><span class="annottext">(ScalarTypeBase (DimDecl VName) () -&gt; StructType)
-&gt; ScalarTypeBase (DimDecl VName) () -&gt; StructType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">()
-&gt; PName
-&gt; StructType
-&gt; RetTypeBase (DimDecl VName) ()
-&gt; ScalarTypeBase (DimDecl VName) ()
forall dim as.
as
-&gt; PName
-&gt; TypeBase dim as
-&gt; RetTypeBase dim as
-&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Arrow"><span class="hs-identifier hs-var">Arrow</span></a></span><span> </span><span class="annot"><span class="annottext">()
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">PName
</span><a href="Language.Futhark.Syntax.html#Unnamed"><span class="hs-identifier hs-var">Unnamed</span></a></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684555691"><span class="hs-identifier hs-var">pts'</span></a></span><span> </span><span class="annot"><span class="annottext">RetTypeBase (DimDecl VName) ()
</span><a href="#local-6989586621684555692"><span class="hs-identifier hs-var">rt</span></a></span><span>
</span><span id="line-1006"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-1007"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-1008"></span><span>        </span><span id="local-6989586621684555691"><span class="annot"><span class="annottext">pts' :: StructType
</span><a href="#local-6989586621684555691"><span class="hs-identifier hs-var hs-var">pts'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[StructType]
</span><a href="#local-6989586621684555693"><span class="hs-identifier hs-var">pts</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1009"></span><span>          </span><span class="hs-special">[</span><span id="local-6989586621684555690"><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684555690"><span class="hs-identifier hs-var">pt</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684555690"><span class="hs-identifier hs-var">pt</span></a></span><span>
</span><span id="line-1010"></span><span>          </span><span class="annot"><span class="annottext">[StructType]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ScalarTypeBase (DimDecl VName) () -&gt; StructType
forall dim as. ScalarTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-var">Scalar</span></a></span><span> </span><span class="annot"><span class="annottext">(ScalarTypeBase (DimDecl VName) () -&gt; StructType)
-&gt; ScalarTypeBase (DimDecl VName) () -&gt; StructType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[StructType] -&gt; ScalarTypeBase (DimDecl VName) ()
forall dim as. [TypeBase dim as] -&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Prop.html#tupleRecord"><span class="hs-identifier hs-var">tupleRecord</span></a></span><span> </span><span class="annot"><span class="annottext">[StructType]
</span><a href="#local-6989586621684555693"><span class="hs-identifier hs-var">pts</span></a></span><span>
</span><span id="line-1011"></span><span>    </span><span class="annot"><a href="#local-6989586621684555720"><span class="hs-identifier hs-var">addIntrinsicF</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684555689"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684555689"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Intrinsic
</span><a href="Language.Futhark.Prop.html#IntrinsicEquality"><span class="hs-identifier hs-var">IntrinsicEquality</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1012"></span><span>      </span><span class="annot"><span class="annottext">(a, ValBinding) -&gt; Maybe (a, ValBinding)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684555689"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ValBinding
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#EqualityF"><span class="hs-identifier hs-var">EqualityF</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1013"></span><span>    </span><span class="annot"><a href="#local-6989586621684555720"><span class="hs-identifier hs-var">addIntrinsicF</span></a></span><span> </span><span class="annot"><span class="annottext">(a, Intrinsic)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (a, ValBinding)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1014"></span><span>
</span><span id="line-1015"></span><span id="local-6989586621684557611"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#runTermTypeM"><span class="hs-identifier hs-type">runTermTypeM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684557611"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Monad.html#TypeM"><span class="hs-identifier hs-type">TypeM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621684557611"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Occurrences"><span class="hs-identifier hs-type">Occurrences</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-1016"></span><span id="runTermTypeM"><span class="annot"><span class="annottext">runTermTypeM :: forall a. TermTypeM a -&gt; TypeM (a, Occurrences)
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#runTermTypeM"><span class="hs-identifier hs-var hs-var">runTermTypeM</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span id="local-6989586621684555677"><span class="annot"><span class="annottext">ReaderT TermEnv (StateT TermTypeState TypeM) a
</span><a href="#local-6989586621684555677"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1017"></span><span>  </span><span id="local-6989586621684555676"><span class="annot"><span class="annottext">TermScope
</span><a href="#local-6989586621684555676"><span class="hs-identifier hs-var">initial_scope</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TermScope
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#initialTermScope"><span class="hs-identifier hs-var">initialTermScope</span></a></span><span> </span><span class="annot"><span class="annottext">TermScope -&gt; TermScope -&gt; TermScope
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TermScope -&gt; TermScope) -&gt; (Env -&gt; TermScope) -&gt; Env -&gt; TermScope
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Env -&gt; TermScope
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#envToTermScope"><span class="hs-identifier hs-var">envToTermScope</span></a></span><span> </span><span class="annot"><span class="annottext">(Env -&gt; TermScope) -&gt; TypeM Env -&gt; TypeM TermScope
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">TypeM Env
</span><a href="Language.Futhark.TypeChecker.Monad.html#askEnv"><span class="hs-identifier hs-var">askEnv</span></a></span><span>
</span><span id="line-1018"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684555675"><span class="annot"><span class="annottext">initial_tenv :: TermEnv
</span><a href="#local-6989586621684555675"><span class="hs-identifier hs-var hs-var">initial_tenv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1019"></span><span>        </span><span class="annot"><span class="annottext">TermEnv :: TermScope -&gt; Maybe Checking -&gt; Int -&gt; TermEnv
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermEnv"><span class="hs-identifier hs-type">TermEnv</span></a></span><span>
</span><span id="line-1020"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">termScope :: TermScope
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#termScope"><span class="hs-identifier hs-var">termScope</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TermScope
</span><a href="#local-6989586621684555676"><span class="hs-identifier hs-var">initial_scope</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1021"></span><span>            </span><span class="annot"><span class="annottext">termChecking :: Maybe Checking
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#termChecking"><span class="hs-identifier hs-var">termChecking</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Checking
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span>
</span><span id="line-1022"></span><span>            </span><span class="annot"><span class="annottext">termLevel :: Int
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#termLevel"><span class="hs-identifier hs-var">termLevel</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-1023"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-1024"></span><span>  </span><span class="annot"><span class="annottext">(TermTypeState -&gt; Occurrences)
-&gt; (a, TermTypeState) -&gt; (a, Occurrences)
forall (p :: * -&gt; * -&gt; *) b c a.
Bifunctor p =&gt;
(b -&gt; c) -&gt; p a b -&gt; p a c
</span><span class="hs-identifier hs-var">second</span></span><span> </span><span class="annot"><span class="annottext">TermTypeState -&gt; Occurrences
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#stateOccs"><span class="hs-identifier hs-var hs-var">stateOccs</span></a></span><span>
</span><span id="line-1025"></span><span>    </span><span class="annot"><span class="annottext">((a, TermTypeState) -&gt; (a, Occurrences))
-&gt; TypeM (a, TermTypeState) -&gt; TypeM (a, Occurrences)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">StateT TermTypeState TypeM a
-&gt; TermTypeState -&gt; TypeM (a, TermTypeState)
forall s (m :: * -&gt; *) a. StateT s m a -&gt; s -&gt; m (a, s)
</span><span class="hs-identifier hs-var hs-var">runStateT</span></span><span>
</span><span id="line-1026"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ReaderT TermEnv (StateT TermTypeState TypeM) a
-&gt; TermEnv -&gt; StateT TermTypeState TypeM a
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var hs-var">runReaderT</span></span><span> </span><span class="annot"><span class="annottext">ReaderT TermEnv (StateT TermTypeState TypeM) a
</span><a href="#local-6989586621684555677"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">TermEnv
</span><a href="#local-6989586621684555675"><span class="hs-identifier hs-var">initial_tenv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1027"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Constraints
-&gt; Int
-&gt; Map SizeSource VName
-&gt; Map VName NameReason
-&gt; Occurrences
-&gt; TermTypeState
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeState"><span class="hs-identifier hs-var">TermTypeState</span></a></span><span> </span><span class="annot"><span class="annottext">Constraints
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Map SizeSource VName
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">Map VName NameReason
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">Occurrences
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span>
</span><span id="line-1028"></span></pre></body></html>