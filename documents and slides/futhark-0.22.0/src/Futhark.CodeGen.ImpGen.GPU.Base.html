<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-4"></span><span>
</span><span id="line-5"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Futhark.CodeGen.ImpGen.GPU.Base</span><span>
</span><span id="line-6"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#KernelConstants"><span class="hs-identifier">KernelConstants</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-7"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#keyWithEntryPoint"><span class="hs-identifier">keyWithEntryPoint</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-8"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#CallKernelGen"><span class="hs-identifier">CallKernelGen</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-9"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#InKernelGen"><span class="hs-identifier">InKernelGen</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-10"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#Locks"><span class="hs-identifier">Locks</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-11"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#HostEnv"><span class="hs-identifier">HostEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-12"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#Target"><span class="hs-identifier">Target</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-13"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#KernelEnv"><span class="hs-identifier">KernelEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-14"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#computeThreadChunkSize"><span class="hs-identifier">computeThreadChunkSize</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-15"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#groupReduce"><span class="hs-identifier">groupReduce</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-16"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#groupScan"><span class="hs-identifier">groupScan</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-17"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#isActive"><span class="hs-identifier">isActive</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-18"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#sKernelThread"><span class="hs-identifier">sKernelThread</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-19"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#sKernelGroup"><span class="hs-identifier">sKernelGroup</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-20"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#sReplicate"><span class="hs-identifier">sReplicate</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-21"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#sIota"><span class="hs-identifier">sIota</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-22"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#sCopy"><span class="hs-identifier">sCopy</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-23"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileThreadResult"><span class="hs-identifier">compileThreadResult</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-24"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileGroupResult"><span class="hs-identifier">compileGroupResult</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-25"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#virtualiseGroups"><span class="hs-identifier">virtualiseGroups</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-26"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#groupLoop"><span class="hs-identifier">groupLoop</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-27"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelLoop"><span class="hs-identifier">kernelLoop</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-28"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#groupCoverSpace"><span class="hs-identifier">groupCoverSpace</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-29"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#precomputeSegOpIDs"><span class="hs-identifier">precomputeSegOpIDs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-30"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#atomicUpdateLocking"><span class="hs-identifier">atomicUpdateLocking</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-31"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#AtomicBinOp"><span class="hs-identifier">AtomicBinOp</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-32"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#Locking"><span class="hs-identifier">Locking</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-33"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#AtomicUpdate"><span class="hs-identifier">AtomicUpdate</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-34"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#DoAtomicUpdate"><span class="hs-identifier">DoAtomicUpdate</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-35"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-36"></span><span class="hs-keyword">where</span><span>
</span><span id="line-37"></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Except</span></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">foldl'</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">zip4</span></span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map.Strict</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S</span></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.GPU.html"><span class="hs-identifier">Futhark.CodeGen.ImpCode.GPU</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Imp</span></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html"><span class="hs-identifier">Futhark.CodeGen.ImpGen</span></a></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Error.html"><span class="hs-identifier">Futhark.Error</span></a></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html"><span class="hs-identifier">Futhark.IR.GPUMem</span></a></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html"><span class="hs-identifier">Futhark.IR.Mem.IxFun</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">IxFun</span></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.MonadFreshNames.html"><span class="hs-identifier">Futhark.MonadFreshNames</span></a></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Transform.Rename.html"><span class="hs-identifier">Futhark.Transform.Rename</span></a></span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Util.html"><span class="hs-identifier">Futhark.Util</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Util.html#chunks"><span class="hs-identifier">chunks</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Util.html#dropLast"><span class="hs-identifier">dropLast</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Util.html#mapAccumLM"><span class="hs-identifier">mapAccumLM</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Util.html#nubOrd"><span class="hs-identifier">nubOrd</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Util.html#takeLast"><span class="hs-identifier">takeLast</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Util.IntegralExp.html"><span class="hs-identifier">Futhark.Util.IntegralExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Util.IntegralExp.html#divUp"><span class="hs-identifier">divUp</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Util.IntegralExp.html#quot"><span class="hs-identifier">quot</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Util.IntegralExp.html#rem"><span class="hs-identifier">rem</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Prelude</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">quot</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">rem</span></span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span>
</span><span id="line-54"></span><span class="hs-comment">-- | Which target are we ultimately generating code for?  While most</span><span>
</span><span id="line-55"></span><span class="hs-comment">-- of the kernels code is the same, there are some cases where we</span><span>
</span><span id="line-56"></span><span class="hs-comment">-- generate special code based on the ultimate low-level API we are</span><span>
</span><span id="line-57"></span><span class="hs-comment">-- targeting.</span><span>
</span><span id="line-58"></span><span class="hs-keyword">data</span><span> </span><span id="Target"><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#Target"><span class="hs-identifier hs-var">Target</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="CUDA"><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#CUDA"><span class="hs-identifier hs-var">CUDA</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="OpenCL"><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#OpenCL"><span class="hs-identifier hs-var">OpenCL</span></a></span></span><span>
</span><span id="line-59"></span><span>
</span><span id="line-60"></span><span class="hs-comment">-- | Information about the locks available for accumulators.</span><span>
</span><span id="line-61"></span><span class="hs-keyword">data</span><span> </span><span id="Locks"><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#Locks"><span class="hs-identifier hs-var">Locks</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Locks"><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#Locks"><span class="hs-identifier hs-var">Locks</span></a></span></span><span>
</span><span id="line-62"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="locksArray"><span class="annot"><span class="annottext">Locks -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#locksArray"><span class="hs-identifier hs-var hs-var">locksArray</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-63"></span><span>    </span><span id="locksCount"><span class="annot"><span class="annottext">Locks -&gt; Int
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#locksCount"><span class="hs-identifier hs-var hs-var">locksCount</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-64"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-65"></span><span>
</span><span id="line-66"></span><span class="hs-keyword">data</span><span> </span><span id="HostEnv"><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#HostEnv"><span class="hs-identifier hs-var">HostEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="HostEnv"><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#HostEnv"><span class="hs-identifier hs-var">HostEnv</span></a></span></span><span>
</span><span id="line-67"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="hostAtomics"><span class="annot"><span class="annottext">HostEnv -&gt; AtomicBinOp
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#hostAtomics"><span class="hs-identifier hs-var hs-var">hostAtomics</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#AtomicBinOp"><span class="hs-identifier hs-type">AtomicBinOp</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-68"></span><span>    </span><span id="hostTarget"><span class="annot"><span class="annottext">HostEnv -&gt; Target
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#hostTarget"><span class="hs-identifier hs-var hs-var">hostTarget</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#Target"><span class="hs-identifier hs-type">Target</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-69"></span><span>    </span><span id="hostLocks"><span class="annot"><span class="annottext">HostEnv -&gt; Map VName Locks
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#hostLocks"><span class="hs-identifier hs-var hs-var">hostLocks</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#Locks"><span class="hs-identifier hs-type">Locks</span></a></span><span>
</span><span id="line-70"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-71"></span><span>
</span><span id="line-72"></span><span class="hs-keyword">data</span><span> </span><span id="KernelEnv"><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#KernelEnv"><span class="hs-identifier hs-var">KernelEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="KernelEnv"><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#KernelEnv"><span class="hs-identifier hs-var">KernelEnv</span></a></span></span><span>
</span><span id="line-73"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="kernelAtomics"><span class="annot"><span class="annottext">KernelEnv -&gt; AtomicBinOp
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelAtomics"><span class="hs-identifier hs-var hs-var">kernelAtomics</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#AtomicBinOp"><span class="hs-identifier hs-type">AtomicBinOp</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-74"></span><span>    </span><span id="kernelConstants"><span class="annot"><span class="annottext">KernelEnv -&gt; KernelConstants
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelConstants"><span class="hs-identifier hs-var hs-var">kernelConstants</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#KernelConstants"><span class="hs-identifier hs-type">KernelConstants</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-75"></span><span>    </span><span id="kernelLocks"><span class="annot"><span class="annottext">KernelEnv -&gt; Map VName Locks
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelLocks"><span class="hs-identifier hs-var hs-var">kernelLocks</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#Locks"><span class="hs-identifier hs-type">Locks</span></a></span><span>
</span><span id="line-76"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-77"></span><span>
</span><span id="line-78"></span><span class="hs-keyword">type</span><span> </span><span id="CallKernelGen"><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#CallKernelGen"><span class="hs-identifier hs-var">CallKernelGen</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#HostEnv"><span class="hs-identifier hs-type">HostEnv</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.GPU.html#HostOp"><span class="hs-identifier hs-type">Imp.HostOp</span></a></span><span>
</span><span id="line-79"></span><span>
</span><span id="line-80"></span><span class="hs-keyword">type</span><span> </span><span id="InKernelGen"><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#InKernelGen"><span class="hs-identifier hs-var">InKernelGen</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#KernelEnv"><span class="hs-identifier hs-type">KernelEnv</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.GPU.html#KernelOp"><span class="hs-identifier hs-type">Imp.KernelOp</span></a></span><span>
</span><span id="line-81"></span><span>
</span><span id="line-82"></span><span class="hs-keyword">data</span><span> </span><span id="KernelConstants"><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#KernelConstants"><span class="hs-identifier hs-var">KernelConstants</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="KernelConstants"><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#KernelConstants"><span class="hs-identifier hs-var">KernelConstants</span></a></span></span><span>
</span><span id="line-83"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="kernelGlobalThreadId"><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelGlobalThreadId"><span class="hs-identifier hs-var hs-var">kernelGlobalThreadId</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span class="hs-special">,</span><span>
</span><span id="line-84"></span><span>    </span><span id="kernelLocalThreadId"><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelLocalThreadId"><span class="hs-identifier hs-var hs-var">kernelLocalThreadId</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span class="hs-special">,</span><span>
</span><span id="line-85"></span><span>    </span><span id="kernelGroupId"><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelGroupId"><span class="hs-identifier hs-var hs-var">kernelGroupId</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span class="hs-special">,</span><span>
</span><span id="line-86"></span><span>    </span><span id="kernelGlobalThreadIdVar"><span class="annot"><span class="annottext">KernelConstants -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelGlobalThreadIdVar"><span class="hs-identifier hs-var hs-var">kernelGlobalThreadIdVar</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-87"></span><span>    </span><span id="kernelLocalThreadIdVar"><span class="annot"><span class="annottext">KernelConstants -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelLocalThreadIdVar"><span class="hs-identifier hs-var hs-var">kernelLocalThreadIdVar</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-88"></span><span>    </span><span id="kernelGroupIdVar"><span class="annot"><span class="annottext">KernelConstants -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelGroupIdVar"><span class="hs-identifier hs-var hs-var">kernelGroupIdVar</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-89"></span><span>    </span><span id="kernelNumGroups"><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelNumGroups"><span class="hs-identifier hs-var hs-var">kernelNumGroups</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">,</span><span>
</span><span id="line-90"></span><span>    </span><span id="kernelGroupSize"><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelGroupSize"><span class="hs-identifier hs-var hs-var">kernelGroupSize</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">,</span><span>
</span><span id="line-91"></span><span>    </span><span id="kernelNumThreads"><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelNumThreads"><span class="hs-identifier hs-var hs-var">kernelNumThreads</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span class="hs-special">,</span><span>
</span><span id="line-92"></span><span>    </span><span id="kernelWaveSize"><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelWaveSize"><span class="hs-identifier hs-var hs-var">kernelWaveSize</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span class="hs-special">,</span><span>
</span><span id="line-93"></span><span>    </span><span id="kernelThreadActive"><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Bool
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelThreadActive"><span class="hs-identifier hs-var hs-var">kernelThreadActive</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">,</span><span>
</span><span id="line-94"></span><span>    </span><span class="hs-comment">-- | A mapping from dimensions of nested SegOps to already</span><span>
</span><span id="line-95"></span><span>    </span><span class="hs-comment">-- computed local thread IDs.</span><span>
</span><span id="line-96"></span><span>    </span><span id="kernelLocalIdMap"><span class="annot"><span class="annottext">KernelConstants -&gt; Map [SubExp] [TExp Int32]
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelLocalIdMap"><span class="hs-identifier hs-var hs-var">kernelLocalIdMap</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span class="hs-special">]</span><span>
</span><span id="line-97"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-98"></span><span>
</span><span id="line-99"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#segOpSizes"><span class="hs-identifier hs-type">segOpSizes</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.Set</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-100"></span><span id="segOpSizes"><span class="annot"><span class="annottext">segOpSizes :: Stms GPUMem -&gt; Set [SubExp]
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#segOpSizes"><span class="hs-identifier hs-var hs-var">segOpSizes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stms GPUMem -&gt; Set [SubExp]
</span><a href="#local-6989586621684537444"><span class="hs-identifier hs-var">onStms</span></a></span><span>
</span><span id="line-101"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-102"></span><span>    </span><span id="local-6989586621684537444"><span class="annot"><span class="annottext">onStms :: Stms GPUMem -&gt; Set [SubExp]
</span><a href="#local-6989586621684537444"><span class="hs-identifier hs-var hs-var">onStms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Stm GPUMem -&gt; Set [SubExp]) -&gt; Stms GPUMem -&gt; Set [SubExp]
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp GPUMem -&gt; Set [SubExp]
</span><a href="#local-6989586621684537433"><span class="hs-identifier hs-var">onExp</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp GPUMem -&gt; Set [SubExp])
-&gt; (Stm GPUMem -&gt; Exp GPUMem) -&gt; Stm GPUMem -&gt; Set [SubExp]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Stm GPUMem -&gt; Exp GPUMem
forall rep. Stm rep -&gt; Exp rep
</span><a href="Futhark.IR.Syntax.html#stmExp"><span class="hs-identifier hs-var hs-var">stmExp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-103"></span><span>    </span><span id="local-6989586621684537433"><span class="annot"><span class="annottext">onExp :: Exp GPUMem -&gt; Set [SubExp]
</span><a href="#local-6989586621684537433"><span class="hs-identifier hs-var hs-var">onExp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SegOp"><span class="hs-identifier hs-type">SegOp</span></a></span><span> </span><span id="local-6989586621684537427"><span class="annot"><span class="annottext">SegOp SegLevel GPUMem
</span><a href="#local-6989586621684537427"><span class="hs-identifier hs-var">op</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-104"></span><span>      </span><span class="annot"><span class="annottext">[SubExp] -&gt; Set [SubExp]
forall a. a -&gt; Set a
</span><span class="hs-identifier hs-var">S.singleton</span></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; Set [SubExp]) -&gt; [SubExp] -&gt; Set [SubExp]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((VName, SubExp) -&gt; SubExp) -&gt; [(VName, SubExp)] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(VName, SubExp) -&gt; SubExp
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">([(VName, SubExp)] -&gt; [SubExp]) -&gt; [(VName, SubExp)] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; [(VName, SubExp)]
</span><a href="Futhark.IR.SegOp.html#unSegSpace"><span class="hs-identifier hs-var hs-var">unSegSpace</span></a></span><span> </span><span class="annot"><span class="annottext">(SegSpace -&gt; [(VName, SubExp)]) -&gt; SegSpace -&gt; [(VName, SubExp)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegOp SegLevel GPUMem -&gt; SegSpace
forall lvl rep. SegOp lvl rep -&gt; SegSpace
</span><a href="Futhark.IR.SegOp.html#segSpace"><span class="hs-identifier hs-var">segSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SegOp SegLevel GPUMem
</span><a href="#local-6989586621684537427"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-105"></span><span>    </span><span class="annot"><a href="#local-6989586621684537433"><span class="hs-identifier hs-var">onExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#If"><span class="hs-identifier hs-type">If</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684537422"><span class="annot"><span class="annottext">BodyT GPUMem
</span><a href="#local-6989586621684537422"><span class="hs-identifier hs-var">tbranch</span></a></span></span><span> </span><span id="local-6989586621684537421"><span class="annot"><span class="annottext">BodyT GPUMem
</span><a href="#local-6989586621684537421"><span class="hs-identifier hs-var">fbranch</span></a></span></span><span> </span><span class="annot"><span class="annottext">IfDec (BranchType GPUMem)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-106"></span><span>      </span><span class="annot"><span class="annottext">Stms GPUMem -&gt; Set [SubExp]
</span><a href="#local-6989586621684537444"><span class="hs-identifier hs-var">onStms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BodyT GPUMem -&gt; Stms GPUMem
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT GPUMem
</span><a href="#local-6989586621684537422"><span class="hs-identifier hs-var">tbranch</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Set [SubExp] -&gt; Set [SubExp] -&gt; Set [SubExp]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Stms GPUMem -&gt; Set [SubExp]
</span><a href="#local-6989586621684537444"><span class="hs-identifier hs-var">onStms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BodyT GPUMem -&gt; Stms GPUMem
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT GPUMem
</span><a href="#local-6989586621684537421"><span class="hs-identifier hs-var">fbranch</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-107"></span><span>    </span><span class="annot"><a href="#local-6989586621684537433"><span class="hs-identifier hs-var">onExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#DoLoop"><span class="hs-identifier hs-type">DoLoop</span></a></span><span> </span><span class="annot"><span class="annottext">[(FParam GPUMem, SubExp)]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">LoopForm GPUMem
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684537418"><span class="annot"><span class="annottext">BodyT GPUMem
</span><a href="#local-6989586621684537418"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-108"></span><span>      </span><span class="annot"><span class="annottext">Stms GPUMem -&gt; Set [SubExp]
</span><a href="#local-6989586621684537444"><span class="hs-identifier hs-var">onStms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BodyT GPUMem -&gt; Stms GPUMem
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT GPUMem
</span><a href="#local-6989586621684537418"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-109"></span><span>    </span><span class="annot"><a href="#local-6989586621684537433"><span class="hs-identifier hs-var">onExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp GPUMem
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set [SubExp]
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-110"></span><span>
</span><span id="line-111"></span><span id="local-6989586621684538945"><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#precomputeSegOpIDs"><span class="hs-identifier hs-type">precomputeSegOpIDs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#InKernelGen"><span class="hs-identifier hs-type">InKernelGen</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684538945"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#InKernelGen"><span class="hs-identifier hs-type">InKernelGen</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684538945"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-112"></span><span id="precomputeSegOpIDs"><span class="annot"><span class="annottext">precomputeSegOpIDs :: forall a. Stms GPUMem -&gt; InKernelGen a -&gt; InKernelGen a
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#precomputeSegOpIDs"><span class="hs-identifier hs-var hs-var">precomputeSegOpIDs</span></a></span></span><span> </span><span id="local-6989586621684537408"><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684537408"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span id="local-6989586621684537407"><span class="annot"><span class="annottext">InKernelGen a
</span><a href="#local-6989586621684537407"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-113"></span><span>  </span><span id="local-6989586621684537406"><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684537406"><span class="hs-identifier hs-var">ltid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelLocalThreadId"><span class="hs-identifier hs-var hs-var">kernelLocalThreadId</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelConstants -&gt; TExp Int32)
-&gt; (KernelEnv -&gt; KernelConstants) -&gt; KernelEnv -&gt; TExp Int32
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">KernelEnv -&gt; KernelConstants
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelConstants"><span class="hs-identifier hs-var hs-var">kernelConstants</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelEnv -&gt; TExp Int32)
-&gt; ImpM GPUMem KernelEnv KernelOp KernelEnv
-&gt; ImpM GPUMem KernelEnv KernelOp (TExp Int32)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ImpM GPUMem KernelEnv KernelOp KernelEnv
forall rep r op. ImpM rep r op r
</span><a href="Futhark.CodeGen.ImpGen.html#askEnv"><span class="hs-identifier hs-var">askEnv</span></a></span><span>
</span><span id="line-114"></span><span>  </span><span id="local-6989586621684537403"><span class="annot"><span class="annottext">Map [SubExp] [TExp Int32]
</span><a href="#local-6989586621684537403"><span class="hs-identifier hs-var">new_ids</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[([SubExp], [TExp Int32])] -&gt; Map [SubExp] [TExp Int32]
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="annot"><span class="annottext">([([SubExp], [TExp Int32])] -&gt; Map [SubExp] [TExp Int32])
-&gt; ImpM GPUMem KernelEnv KernelOp [([SubExp], [TExp Int32])]
-&gt; ImpM GPUMem KernelEnv KernelOp (Map [SubExp] [TExp Int32])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">([SubExp]
 -&gt; ImpM GPUMem KernelEnv KernelOp ([SubExp], [TExp Int32]))
-&gt; [[SubExp]]
-&gt; ImpM GPUMem KernelEnv KernelOp [([SubExp], [TExp Int32])]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int32
-&gt; [SubExp]
-&gt; ImpM GPUMem KernelEnv KernelOp ([SubExp], [TExp Int32])
forall {a} {t} {rep} {r} {op}.
(ToExp a, IntExp t) =&gt;
TPrimExp t VName -&gt; [a] -&gt; ImpM rep r op ([a], [TExp Int32])
</span><a href="#local-6989586621684537400"><span class="hs-identifier hs-var">mkMap</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684537406"><span class="hs-identifier hs-var">ltid</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set [SubExp] -&gt; [[SubExp]]
forall a. Set a -&gt; [a]
</span><span class="hs-identifier hs-var">S.toList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms GPUMem -&gt; Set [SubExp]
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#segOpSizes"><span class="hs-identifier hs-var">segOpSizes</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684537408"><span class="hs-identifier hs-var">stms</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-115"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684537398"><span class="annot"><span class="annottext">f :: KernelEnv -&gt; KernelEnv
</span><a href="#local-6989586621684537398"><span class="hs-identifier hs-var hs-var">f</span></a></span></span><span> </span><span id="local-6989586621684537397"><span class="annot"><span class="annottext">KernelEnv
</span><a href="#local-6989586621684537397"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-116"></span><span>        </span><span class="annot"><span class="annottext">KernelEnv
</span><a href="#local-6989586621684537397"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-117"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">kernelConstants :: KernelConstants
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelConstants"><span class="hs-identifier hs-var">kernelConstants</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-118"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelEnv -&gt; KernelConstants
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelConstants"><span class="hs-identifier hs-var hs-var">kernelConstants</span></a></span><span> </span><span class="annot"><span class="annottext">KernelEnv
</span><a href="#local-6989586621684537397"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">kernelLocalIdMap :: Map [SubExp] [TExp Int32]
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelLocalIdMap"><span class="hs-identifier hs-var">kernelLocalIdMap</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map [SubExp] [TExp Int32]
</span><a href="#local-6989586621684537403"><span class="hs-identifier hs-var">new_ids</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-119"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-120"></span><span>  </span><span class="annot"><span class="annottext">(KernelEnv -&gt; KernelEnv) -&gt; InKernelGen a -&gt; InKernelGen a
forall r rep op a. (r -&gt; r) -&gt; ImpM rep r op a -&gt; ImpM rep r op a
</span><a href="Futhark.CodeGen.ImpGen.html#localEnv"><span class="hs-identifier hs-var">localEnv</span></a></span><span> </span><span class="annot"><span class="annottext">KernelEnv -&gt; KernelEnv
</span><a href="#local-6989586621684537398"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">InKernelGen a
</span><a href="#local-6989586621684537407"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-121"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-122"></span><span>    </span><span id="local-6989586621684537400"><span class="annot"><span class="annottext">mkMap :: TPrimExp t VName -&gt; [a] -&gt; ImpM rep r op ([a], [TExp Int32])
</span><a href="#local-6989586621684537400"><span class="hs-identifier hs-var hs-var">mkMap</span></a></span></span><span> </span><span id="local-6989586621684537388"><span class="annot"><span class="annottext">TPrimExp t VName
</span><a href="#local-6989586621684537388"><span class="hs-identifier hs-var">ltid</span></a></span></span><span> </span><span id="local-6989586621684537387"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684537387"><span class="hs-identifier hs-var">dims</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-123"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684537386"><span class="annot"><span class="annottext">dims' :: [TExp Int64]
</span><a href="#local-6989586621684537386"><span class="hs-identifier hs-var hs-var">dims'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(a -&gt; TExp Int64) -&gt; [a] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684537387"><span class="hs-identifier hs-var">dims</span></a></span><span>
</span><span id="line-124"></span><span>      </span><span id="local-6989586621684537384"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684537384"><span class="hs-identifier hs-var">ids'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; [TExp Int64] -&gt; TExp Int64 -&gt; ImpM rep r op [TExp Int64]
forall rep r op.
String -&gt; [TExp Int64] -&gt; TExp Int64 -&gt; ImpM rep r op [TExp Int64]
</span><a href="Futhark.CodeGen.ImpGen.html#dIndexSpace%27"><span class="hs-identifier hs-var">dIndexSpace'</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ltid_pre&quot;</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684537386"><span class="hs-identifier hs-var">dims'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TPrimExp t VName -&gt; TExp Int64
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp t VName
</span><a href="#local-6989586621684537388"><span class="hs-identifier hs-var">ltid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-125"></span><span>      </span><span class="annot"><span class="annottext">([a], [TExp Int32]) -&gt; ImpM rep r op ([a], [TExp Int32])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684537387"><span class="hs-identifier hs-var">dims</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; TExp Int32) -&gt; [TExp Int64] -&gt; [TExp Int32]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int32
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int32 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt32"><span class="hs-identifier hs-var">sExt32</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684537384"><span class="hs-identifier hs-var">ids'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-126"></span><span>
</span><span id="line-127"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#keyWithEntryPoint"><span class="hs-identifier hs-type">keyWithEntryPoint</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span>
</span><span id="line-128"></span><span id="keyWithEntryPoint"><span class="annot"><span class="annottext">keyWithEntryPoint :: Maybe Name -&gt; Name -&gt; Name
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#keyWithEntryPoint"><span class="hs-identifier hs-var hs-var">keyWithEntryPoint</span></a></span></span><span> </span><span id="local-6989586621684537380"><span class="annot"><span class="annottext">Maybe Name
</span><a href="#local-6989586621684537380"><span class="hs-identifier hs-var">fname</span></a></span></span><span> </span><span id="local-6989586621684537379"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684537379"><span class="hs-identifier hs-var">key</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-129"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; Name
</span><a href="Language.Futhark.Core.html#nameFromString"><span class="hs-identifier hs-var">nameFromString</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Name) -&gt; String -&gt; Name
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; (Name -&gt; String) -&gt; Maybe Name -&gt; String
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;.&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(String -&gt; String) -&gt; (Name -&gt; String) -&gt; Name -&gt; String
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; String
</span><a href="Language.Futhark.Core.html#nameToString"><span class="hs-identifier hs-var">nameToString</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe Name
</span><a href="#local-6989586621684537380"><span class="hs-identifier hs-var">fname</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; String
</span><a href="Language.Futhark.Core.html#nameToString"><span class="hs-identifier hs-var">nameToString</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684537379"><span class="hs-identifier hs-var">key</span></a></span><span>
</span><span id="line-130"></span><span>
</span><span id="line-131"></span><span id="local-6989586621684538906"><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#allocLocal"><span class="hs-identifier hs-type">allocLocal</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#AllocCompiler"><span class="hs-identifier hs-type">AllocCompiler</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684538906"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.GPU.html#KernelOp"><span class="hs-identifier hs-type">Imp.KernelOp</span></a></span></span><span>
</span><span id="line-132"></span><span id="allocLocal"><span class="annot"><span class="annottext">allocLocal :: forall r. AllocCompiler GPUMem r KernelOp
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#allocLocal"><span class="hs-identifier hs-var hs-var">allocLocal</span></a></span></span><span> </span><span id="local-6989586621684537374"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684537374"><span class="hs-identifier hs-var">mem</span></a></span></span><span> </span><span id="local-6989586621684537373"><span class="annot"><span class="annottext">Count Bytes (TExp Int64)
</span><a href="#local-6989586621684537373"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-133"></span><span>  </span><span class="annot"><span class="annottext">KernelOp -&gt; ImpM GPUMem r KernelOp ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelOp -&gt; ImpM GPUMem r KernelOp ())
-&gt; KernelOp -&gt; ImpM GPUMem r KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Count Bytes (TExp Int64) -&gt; KernelOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#LocalAlloc"><span class="hs-identifier hs-var">Imp.LocalAlloc</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684537374"><span class="hs-identifier hs-var">mem</span></a></span><span> </span><span class="annot"><span class="annottext">Count Bytes (TExp Int64)
</span><a href="#local-6989586621684537373"><span class="hs-identifier hs-var">size</span></a></span><span>
</span><span id="line-134"></span><span>
</span><span id="line-135"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelAlloc"><span class="hs-identifier hs-type">kernelAlloc</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-136"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-137"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-138"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-139"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#InKernelGen"><span class="hs-identifier hs-type">InKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-140"></span><span id="kernelAlloc"><span class="annot"><span class="annottext">kernelAlloc :: Pat GPUMem -&gt; SubExp -&gt; Space -&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelAlloc"><span class="hs-identifier hs-var hs-var">kernelAlloc</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
</span><span class="hs-identifier">_</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#ScalarSpace"><span class="hs-identifier hs-type">ScalarSpace</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-141"></span><span>  </span><span class="hs-comment">-- Handled by the declaration of the memory block, which is then</span><span>
</span><span id="line-142"></span><span>  </span><span class="hs-comment">-- translated to an actual scalar variable during C code generation.</span><span>
</span><span id="line-143"></span><span>  </span><span class="annot"><span class="annottext">() -&gt; InKernelGen ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-144"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelAlloc"><span class="hs-identifier hs-var">kernelAlloc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621684537367"><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
</span><a href="#local-6989586621684537367"><span class="hs-identifier hs-var">mem</span></a></span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span id="local-6989586621684537366"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684537366"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;local&quot;</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-145"></span><span>  </span><span class="annot"><span class="annottext">AllocCompiler GPUMem KernelEnv KernelOp
forall r. AllocCompiler GPUMem r KernelOp
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#allocLocal"><span class="hs-identifier hs-var">allocLocal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
PatElemT LParamMem
</span><a href="#local-6989586621684537367"><span class="hs-identifier hs-var">mem</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Count Bytes (TExp Int64) -&gt; InKernelGen ())
-&gt; Count Bytes (TExp Int64) -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; Count Bytes (TExp Int64)
forall a. a -&gt; Count Bytes a
</span><a href="Futhark.CodeGen.ImpCode.html#bytes"><span class="hs-identifier hs-var">Imp.bytes</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; Count Bytes (TExp Int64))
-&gt; TExp Int64 -&gt; Count Bytes (TExp Int64)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684537366"><span class="hs-identifier hs-var">size</span></a></span><span>
</span><span id="line-146"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelAlloc"><span class="hs-identifier hs-var">kernelAlloc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621684537362"><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
</span><a href="#local-6989586621684537362"><span class="hs-identifier hs-var">mem</span></a></span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Space
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-147"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; InKernelGen ()
forall a. String -&gt; a
</span><a href="Futhark.Error.html#compilerLimitationS"><span class="hs-identifier hs-var">compilerLimitationS</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; InKernelGen ()) -&gt; String -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Cannot allocate memory block &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
PatElemT LParamMem
</span><a href="#local-6989586621684537362"><span class="hs-identifier hs-var">mem</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; in kernel.&quot;</span></span><span>
</span><span id="line-148"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelAlloc"><span class="hs-identifier hs-var">kernelAlloc</span></a></span><span> </span><span id="local-6989586621684537359"><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684537359"><span class="hs-identifier hs-var">dest</span></a></span></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Space
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-149"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; InKernelGen ()
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; InKernelGen ()) -&gt; String -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Invalid target for in-kernel allocation: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">PatT LParamMem -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem
PatT LParamMem
</span><a href="#local-6989586621684537359"><span class="hs-identifier hs-var">dest</span></a></span><span>
</span><span id="line-150"></span><span>
</span><span id="line-151"></span><span id="local-6989586621684538883"><span id="local-6989586621684538884"><span id="local-6989586621684538885"><span id="local-6989586621684538887"><span id="local-6989586621684538888"><span id="local-6989586621684538889"><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#splitSpace"><span class="hs-identifier hs-type">splitSpace</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-152"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ToExp"><span class="hs-identifier hs-type">ToExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684538889"><span class="hs-identifier hs-type">w</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ToExp"><span class="hs-identifier hs-type">ToExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684538888"><span class="hs-identifier hs-type">i</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ToExp"><span class="hs-identifier hs-type">ToExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684538887"><span class="hs-identifier hs-type">elems_per_thread</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-153"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-154"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#SplitOrdering"><span class="hs-identifier hs-type">SplitOrdering</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-155"></span><span>  </span><span class="annot"><a href="#local-6989586621684538889"><span class="hs-identifier hs-type">w</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-156"></span><span>  </span><span class="annot"><a href="#local-6989586621684538888"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-157"></span><span>  </span><span class="annot"><a href="#local-6989586621684538887"><span class="hs-identifier hs-type">elems_per_thread</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-158"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684538885"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684538884"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684538883"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span></span></span></span><span>
</span><span id="line-159"></span><span id="splitSpace"><span class="annot"><span class="annottext">splitSpace :: forall w i elems_per_thread rep r op.
(ToExp w, ToExp i, ToExp elems_per_thread) =&gt;
Pat GPUMem
-&gt; SplitOrdering -&gt; w -&gt; i -&gt; elems_per_thread -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#splitSpace"><span class="hs-identifier hs-var hs-var">splitSpace</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621684537342"><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
</span><a href="#local-6989586621684537342"><span class="hs-identifier hs-var">size</span></a></span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span id="local-6989586621684537341"><span class="annot"><span class="annottext">SplitOrdering
</span><a href="#local-6989586621684537341"><span class="hs-identifier hs-var">o</span></a></span></span><span> </span><span id="local-6989586621684537340"><span class="annot"><span class="annottext">w
</span><a href="#local-6989586621684537340"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684537339"><span class="annot"><span class="annottext">i
</span><a href="#local-6989586621684537339"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621684537338"><span class="annot"><span class="annottext">elems_per_thread
</span><a href="#local-6989586621684537338"><span class="hs-identifier hs-var">elems_per_thread</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-160"></span><span>  </span><span id="local-6989586621684537337"><span class="annot"><span class="annottext">Count Elements (TExp Int64)
</span><a href="#local-6989586621684537337"><span class="hs-identifier hs-var">num_elements</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; Count Elements (TExp Int64)
forall a. a -&gt; Count Elements a
</span><a href="Futhark.CodeGen.ImpCode.html#elements"><span class="hs-identifier hs-var">Imp.elements</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; Count Elements (TExp Int64))
-&gt; (PrimExp VName -&gt; TExp Int64)
-&gt; PrimExp VName
-&gt; Count Elements (TExp Int64)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PrimExp VName -&gt; TExp Int64
forall t v. PrimExp v -&gt; TPrimExp t v
</span><a href="Futhark.Analysis.PrimExp.html#TPrimExp"><span class="hs-identifier hs-var">TPrimExp</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimExp VName -&gt; Count Elements (TExp Int64))
-&gt; ImpM rep r op (PrimExp VName)
-&gt; ImpM rep r op (Count Elements (TExp Int64))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">w -&gt; ImpM rep r op (PrimExp VName)
forall a rep r op. ToExp a =&gt; a -&gt; ImpM rep r op (PrimExp VName)
</span><a href="Futhark.CodeGen.ImpGen.html#toExp"><span class="hs-identifier hs-var">toExp</span></a></span><span> </span><span class="annot"><span class="annottext">w
</span><a href="#local-6989586621684537340"><span class="hs-identifier hs-var">w</span></a></span><span>
</span><span id="line-161"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684537333"><span class="annot"><span class="annottext">i' :: TExp Int64
</span><a href="#local-6989586621684537333"><span class="hs-identifier hs-var hs-var">i'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">i -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">i
</span><a href="#local-6989586621684537339"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-162"></span><span>  </span><span id="local-6989586621684537332"><span class="annot"><span class="annottext">Count Elements (TExp Int64)
</span><a href="#local-6989586621684537332"><span class="hs-identifier hs-var">elems_per_thread'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; Count Elements (TExp Int64)
forall a. a -&gt; Count Elements a
</span><a href="Futhark.CodeGen.ImpCode.html#elements"><span class="hs-identifier hs-var">Imp.elements</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; Count Elements (TExp Int64))
-&gt; (PrimExp VName -&gt; TExp Int64)
-&gt; PrimExp VName
-&gt; Count Elements (TExp Int64)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PrimExp VName -&gt; TExp Int64
forall t v. PrimExp v -&gt; TPrimExp t v
</span><a href="Futhark.Analysis.PrimExp.html#TPrimExp"><span class="hs-identifier hs-var">TPrimExp</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimExp VName -&gt; Count Elements (TExp Int64))
-&gt; ImpM rep r op (PrimExp VName)
-&gt; ImpM rep r op (Count Elements (TExp Int64))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">elems_per_thread -&gt; ImpM rep r op (PrimExp VName)
forall a rep r op. ToExp a =&gt; a -&gt; ImpM rep r op (PrimExp VName)
</span><a href="Futhark.CodeGen.ImpGen.html#toExp"><span class="hs-identifier hs-var">toExp</span></a></span><span> </span><span class="annot"><span class="annottext">elems_per_thread
</span><a href="#local-6989586621684537338"><span class="hs-identifier hs-var">elems_per_thread</span></a></span><span>
</span><span id="line-163"></span><span>  </span><span class="annot"><span class="annottext">SplitOrdering
-&gt; TExp Int64
-&gt; Count Elements (TExp Int64)
-&gt; Count Elements (TExp Int64)
-&gt; TV Int64
-&gt; ImpM rep r op ()
forall rep r op.
SplitOrdering
-&gt; TExp Int64
-&gt; Count Elements (TExp Int64)
-&gt; Count Elements (TExp Int64)
-&gt; TV Int64
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#computeThreadChunkSize"><span class="hs-identifier hs-var">computeThreadChunkSize</span></a></span><span> </span><span class="annot"><span class="annottext">SplitOrdering
</span><a href="#local-6989586621684537341"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684537333"><span class="hs-identifier hs-var">i'</span></a></span><span> </span><span class="annot"><span class="annottext">Count Elements (TExp Int64)
</span><a href="#local-6989586621684537332"><span class="hs-identifier hs-var">elems_per_thread'</span></a></span><span> </span><span class="annot"><span class="annottext">Count Elements (TExp Int64)
</span><a href="#local-6989586621684537337"><span class="hs-identifier hs-var">num_elements</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; TV Int64
forall t. VName -&gt; PrimType -&gt; TV t
</span><a href="Futhark.CodeGen.ImpGen.html#mkTV"><span class="hs-identifier hs-var">mkTV</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
PatElemT LParamMem
</span><a href="#local-6989586621684537342"><span class="hs-identifier hs-var">size</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int64"><span class="hs-identifier hs-var">int64</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-164"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#splitSpace"><span class="hs-identifier hs-var">splitSpace</span></a></span><span> </span><span id="local-6989586621684537329"><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684537329"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="annot"><span class="annottext">SplitOrdering
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">w
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">i
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">elems_per_thread
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-165"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; ImpM rep r op ()
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; ImpM rep r op ()) -&gt; String -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Invalid target for splitSpace: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">PatT LParamMem -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem
PatT LParamMem
</span><a href="#local-6989586621684537329"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-166"></span><span>
</span><span id="line-167"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#updateAcc"><span class="hs-identifier hs-type">updateAcc</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#InKernelGen"><span class="hs-identifier hs-type">InKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-168"></span><span id="updateAcc"><span class="annot"><span class="annottext">updateAcc :: VName -&gt; [SubExp] -&gt; [SubExp] -&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#updateAcc"><span class="hs-identifier hs-var hs-var">updateAcc</span></a></span></span><span> </span><span id="local-6989586621684537327"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684537327"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621684537326"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684537326"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span id="local-6989586621684537325"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684537325"><span class="hs-identifier hs-var">vs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;UpdateAcc&quot;</span></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-169"></span><span>  </span><span class="hs-comment">-- See the ImpGen implementation of UpdateAcc for general notes.</span><span>
</span><span id="line-170"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684537323"><span class="annot"><span class="annottext">is' :: [TExp Int64]
</span><a href="#local-6989586621684537323"><span class="hs-identifier hs-var hs-var">is'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684537326"><span class="hs-identifier hs-var">is</span></a></span><span>
</span><span id="line-171"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684537322"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684537322"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684537321"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684537321"><span class="hs-identifier hs-var">space</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684537320"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684537320"><span class="hs-identifier hs-var">arrs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684537319"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684537319"><span class="hs-identifier hs-var">dims</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684537318"><span class="annot"><span class="annottext">Maybe (Lambda GPUMem)
</span><a href="#local-6989586621684537318"><span class="hs-identifier hs-var">op</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName
-&gt; [TExp Int64]
-&gt; ImpM
     GPUMem
     KernelEnv
     KernelOp
     (VName, Space, [VName], [TExp Int64], Maybe (Lambda GPUMem))
forall rep r op.
VName
-&gt; [TExp Int64]
-&gt; ImpM
     rep r op (VName, Space, [VName], [TExp Int64], Maybe (Lambda rep))
</span><a href="Futhark.CodeGen.ImpGen.html#lookupAcc"><span class="hs-identifier hs-var">lookupAcc</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684537327"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684537323"><span class="hs-identifier hs-var">is'</span></a></span><span>
</span><span id="line-172"></span><span>  </span><span class="annot"><span class="annottext">TExp Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Slice (TExp Int64) -&gt; [TExp Int64] -&gt; TExp Bool
</span><a href="Futhark.CodeGen.ImpGen.html#inBounds"><span class="hs-identifier hs-var">inBounds</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DimIndex (TExp Int64)] -&gt; Slice (TExp Int64)
forall d. [DimIndex d] -&gt; Slice d
</span><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-var">Slice</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TExp Int64 -&gt; DimIndex (TExp Int64))
-&gt; [TExp Int64] -&gt; [DimIndex (TExp Int64)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; DimIndex (TExp Int64)
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684537323"><span class="hs-identifier hs-var">is'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684537319"><span class="hs-identifier hs-var">dims</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-173"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (Lambda GPUMem)
</span><a href="#local-6989586621684537318"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-174"></span><span>      </span><span class="annot"><span class="annottext">Maybe (Lambda GPUMem)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-175"></span><span>        </span><span class="annot"><span class="annottext">[(VName, SubExp)]
-&gt; ((VName, SubExp) -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; [SubExp] -&gt; [(VName, SubExp)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684537320"><span class="hs-identifier hs-var">arrs</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684537325"><span class="hs-identifier hs-var">vs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((VName, SubExp) -&gt; InKernelGen ()) -&gt; InKernelGen ())
-&gt; ((VName, SubExp) -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684537311"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684537311"><span class="hs-identifier hs-var">arr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684537310"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684537310"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; InKernelGen ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684537311"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684537323"><span class="hs-identifier hs-var">is'</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684537310"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-176"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684537308"><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684537308"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-177"></span><span>        </span><span class="annot"><span class="annottext">[LParam GPUMem] -&gt; InKernelGen ()
forall rep inner r op.
Mem rep inner =&gt;
[LParam rep] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dLParams"><span class="hs-identifier hs-var">dLParams</span></a></span><span> </span><span class="annot"><span class="annottext">([LParam GPUMem] -&gt; InKernelGen ())
-&gt; [LParam GPUMem] -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem -&gt; [LParam GPUMem]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684537308"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-178"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684537305"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684537305"><span class="hs-identifier hs-var">_x_params</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684537304"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684537304"><span class="hs-identifier hs-var">y_params</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-179"></span><span>              </span><span class="annot"><span class="annottext">Int -&gt; [VName] -&gt; ([VName], [VName])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684537325"><span class="hs-identifier hs-var">vs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; ([VName], [VName])) -&gt; [VName] -&gt; ([VName], [VName])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Param LParamMem -&gt; VName) -&gt; [Param LParamMem] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">([Param LParamMem] -&gt; [VName]) -&gt; [Param LParamMem] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem -&gt; [LParam GPUMem]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684537308"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-180"></span><span>        </span><span class="annot"><span class="annottext">[(VName, SubExp)]
-&gt; ((VName, SubExp) -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; [SubExp] -&gt; [(VName, SubExp)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684537304"><span class="hs-identifier hs-var">y_params</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684537325"><span class="hs-identifier hs-var">vs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((VName, SubExp) -&gt; InKernelGen ()) -&gt; InKernelGen ())
-&gt; ((VName, SubExp) -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684537300"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684537300"><span class="hs-identifier hs-var">yp</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684537299"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684537299"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; InKernelGen ()
forall rep r op.
VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-var">copyDWIM</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684537300"><span class="hs-identifier hs-var">yp</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684537299"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-181"></span><span>        </span><span id="local-6989586621684537297"><span class="annot"><span class="annottext">AtomicBinOp
</span><a href="#local-6989586621684537297"><span class="hs-identifier hs-var">atomics</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">KernelEnv -&gt; AtomicBinOp
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelAtomics"><span class="hs-identifier hs-var hs-var">kernelAtomics</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelEnv -&gt; AtomicBinOp)
-&gt; ImpM GPUMem KernelEnv KernelOp KernelEnv
-&gt; ImpM GPUMem KernelEnv KernelOp AtomicBinOp
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ImpM GPUMem KernelEnv KernelOp KernelEnv
forall rep r op. ImpM rep r op r
</span><a href="Futhark.CodeGen.ImpGen.html#askEnv"><span class="hs-identifier hs-var">askEnv</span></a></span><span>
</span><span id="line-182"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">AtomicBinOp -&gt; Lambda GPUMem -&gt; AtomicUpdate GPUMem KernelEnv
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#atomicUpdateLocking"><span class="hs-identifier hs-var">atomicUpdateLocking</span></a></span><span> </span><span class="annot"><span class="annottext">AtomicBinOp
</span><a href="#local-6989586621684537297"><span class="hs-identifier hs-var">atomics</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684537308"><span class="hs-identifier hs-var">lam</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-183"></span><span>          </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#AtomicPrim"><span class="hs-identifier hs-type">AtomicPrim</span></a></span><span> </span><span id="local-6989586621684537295"><span class="annot"><span class="annottext">DoAtomicUpdate GPUMem KernelEnv
</span><a href="#local-6989586621684537295"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DoAtomicUpdate GPUMem KernelEnv
</span><a href="#local-6989586621684537295"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684537321"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684537320"><span class="hs-identifier hs-var">arrs</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684537323"><span class="hs-identifier hs-var">is'</span></a></span><span>
</span><span id="line-184"></span><span>          </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#AtomicCAS"><span class="hs-identifier hs-type">AtomicCAS</span></a></span><span> </span><span id="local-6989586621684537293"><span class="annot"><span class="annottext">DoAtomicUpdate GPUMem KernelEnv
</span><a href="#local-6989586621684537293"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DoAtomicUpdate GPUMem KernelEnv
</span><a href="#local-6989586621684537293"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684537321"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684537320"><span class="hs-identifier hs-var">arrs</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684537323"><span class="hs-identifier hs-var">is'</span></a></span><span>
</span><span id="line-185"></span><span>          </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#AtomicLocking"><span class="hs-identifier hs-type">AtomicLocking</span></a></span><span> </span><span id="local-6989586621684537291"><span class="annot"><span class="annottext">Locking -&gt; DoAtomicUpdate GPUMem KernelEnv
</span><a href="#local-6989586621684537291"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-186"></span><span>            </span><span id="local-6989586621684537290"><span class="annot"><span class="annottext">Maybe Locks
</span><a href="#local-6989586621684537290"><span class="hs-identifier hs-var">c_locks</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Map VName Locks -&gt; Maybe Locks
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684537322"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">(Map VName Locks -&gt; Maybe Locks)
-&gt; (KernelEnv -&gt; Map VName Locks) -&gt; KernelEnv -&gt; Maybe Locks
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">KernelEnv -&gt; Map VName Locks
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelLocks"><span class="hs-identifier hs-var hs-var">kernelLocks</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelEnv -&gt; Maybe Locks)
-&gt; ImpM GPUMem KernelEnv KernelOp KernelEnv
-&gt; ImpM GPUMem KernelEnv KernelOp (Maybe Locks)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ImpM GPUMem KernelEnv KernelOp KernelEnv
forall rep r op. ImpM rep r op r
</span><a href="Futhark.CodeGen.ImpGen.html#askEnv"><span class="hs-identifier hs-var">askEnv</span></a></span><span>
</span><span id="line-187"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Locks
</span><a href="#local-6989586621684537290"><span class="hs-identifier hs-var">c_locks</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-188"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#Locks"><span class="hs-identifier hs-type">Locks</span></a></span><span> </span><span id="local-6989586621684537288"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684537288"><span class="hs-identifier hs-var">locks</span></a></span></span><span> </span><span id="local-6989586621684537287"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684537287"><span class="hs-identifier hs-var">num_locks</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-189"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684537286"><span class="annot"><span class="annottext">locking :: Locking
</span><a href="#local-6989586621684537286"><span class="hs-identifier hs-var hs-var">locking</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-190"></span><span>                      </span><span class="annot"><span class="annottext">VName
-&gt; TExp Int32
-&gt; TExp Int32
-&gt; TExp Int32
-&gt; ([TExp Int64] -&gt; [TExp Int64])
-&gt; Locking
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#Locking"><span class="hs-identifier hs-var">Locking</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684537288"><span class="hs-identifier hs-var">locks</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">(([TExp Int64] -&gt; [TExp Int64]) -&gt; Locking)
-&gt; ([TExp Int64] -&gt; [TExp Int64]) -&gt; Locking
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-191"></span><span>                        </span><span class="annot"><span class="annottext">TExp Int64 -&gt; [TExp Int64]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; [TExp Int64])
-&gt; ([TExp Int64] -&gt; TExp Int64) -&gt; [TExp Int64] -&gt; [TExp Int64]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall e. IntegralExp e =&gt; e -&gt; e -&gt; e
</span><a href="Futhark.Util.IntegralExp.html#rem"><span class="hs-operator hs-var">`rem`</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; TExp Int64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684537287"><span class="hs-identifier hs-var">num_locks</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; TExp Int64)
-&gt; ([TExp Int64] -&gt; TExp Int64) -&gt; [TExp Int64] -&gt; TExp Int64
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; [TExp Int64] -&gt; TExp Int64
forall num. IntegralExp num =&gt; [num] -&gt; [num] -&gt; num
</span><a href="Futhark.IR.Prop.Reshape.html#flattenIndex"><span class="hs-identifier hs-var">flattenIndex</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684537319"><span class="hs-identifier hs-var">dims</span></a></span><span>
</span><span id="line-192"></span><span>                </span><span class="annot"><span class="annottext">Locking -&gt; DoAtomicUpdate GPUMem KernelEnv
</span><a href="#local-6989586621684537291"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Locking
</span><a href="#local-6989586621684537286"><span class="hs-identifier hs-var">locking</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684537321"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684537320"><span class="hs-identifier hs-var">arrs</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684537323"><span class="hs-identifier hs-var">is'</span></a></span><span>
</span><span id="line-193"></span><span>              </span><span class="annot"><span class="annottext">Maybe Locks
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-194"></span><span>                </span><span class="annot"><span class="annottext">String -&gt; InKernelGen ()
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; InKernelGen ()) -&gt; String -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Missing locks for &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684537327"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-195"></span><span>
</span><span id="line-196"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileThreadExp"><span class="hs-identifier hs-type">compileThreadExp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ExpCompiler"><span class="hs-identifier hs-type">ExpCompiler</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#KernelEnv"><span class="hs-identifier hs-type">KernelEnv</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.GPU.html#KernelOp"><span class="hs-identifier hs-type">Imp.KernelOp</span></a></span><span>
</span><span id="line-197"></span><span id="compileThreadExp"><span class="annot"><span class="annottext">compileThreadExp :: ExpCompiler GPUMem KernelEnv KernelOp
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileThreadExp"><span class="hs-identifier hs-var hs-var">compileThreadExp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621684537282"><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
</span><a href="#local-6989586621684537282"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Opaque"><span class="hs-identifier hs-type">Opaque</span></a></span><span> </span><span class="annot"><span class="annottext">OpaqueOp
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684537279"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684537279"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-198"></span><span>  </span><span class="hs-comment">-- Cannot print in GPU code.</span><span>
</span><span id="line-199"></span><span>  </span><span class="annot"><span class="annottext">VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; InKernelGen ()
forall rep r op.
VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-var">copyDWIM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
PatElemT LParamMem
</span><a href="#local-6989586621684537282"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684537279"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-200"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileThreadExp"><span class="hs-identifier hs-var">compileThreadExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621684537278"><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
</span><a href="#local-6989586621684537278"><span class="hs-identifier hs-var">dest</span></a></span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#ArrayLit"><span class="hs-identifier hs-type">ArrayLit</span></a></span><span> </span><span id="local-6989586621684537276"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684537276"><span class="hs-identifier hs-var">es</span></a></span></span><span> </span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-201"></span><span>  </span><span class="annot"><span class="annottext">[(Int64, SubExp)]
-&gt; ((Int64, SubExp) -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Int64] -&gt; [SubExp] -&gt; [(Int64, SubExp)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int64
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">..</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684537276"><span class="hs-identifier hs-var">es</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Int64, SubExp) -&gt; InKernelGen ()) -&gt; InKernelGen ())
-&gt; ((Int64, SubExp) -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684537275"><span class="annot"><span class="annottext">Int64
</span><a href="#local-6989586621684537275"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684537274"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684537274"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-202"></span><span>    </span><span class="annot"><span class="annottext">VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; InKernelGen ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
PatElemT LParamMem
</span><a href="#local-6989586621684537278"><span class="hs-identifier hs-var">dest</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int64 -&gt; TExp Int64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int64
</span><a href="#local-6989586621684537275"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684537274"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-203"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileThreadExp"><span class="hs-identifier hs-var">compileThreadExp</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#UpdateAcc"><span class="hs-identifier hs-type">UpdateAcc</span></a></span><span> </span><span id="local-6989586621684537272"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684537272"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621684537271"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684537271"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span id="local-6989586621684537270"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684537270"><span class="hs-identifier hs-var">vs</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-204"></span><span>  </span><span class="annot"><span class="annottext">VName -&gt; [SubExp] -&gt; [SubExp] -&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#updateAcc"><span class="hs-identifier hs-var">updateAcc</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684537272"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684537271"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684537270"><span class="hs-identifier hs-var">vs</span></a></span><span>
</span><span id="line-205"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileThreadExp"><span class="hs-identifier hs-var">compileThreadExp</span></a></span><span> </span><span id="local-6989586621684537269"><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684537269"><span class="hs-identifier hs-var">dest</span></a></span></span><span> </span><span id="local-6989586621684537268"><span class="annot"><span class="annottext">Exp GPUMem
</span><a href="#local-6989586621684537268"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-206"></span><span>  </span><span class="annot"><span class="annottext">ExpCompiler GPUMem KernelEnv KernelOp
forall rep inner r op.
Mem rep inner =&gt;
Pat rep -&gt; Exp rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#defCompileExp"><span class="hs-identifier hs-var">defCompileExp</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684537269"><span class="hs-identifier hs-var">dest</span></a></span><span> </span><span class="annot"><span class="annottext">Exp GPUMem
</span><a href="#local-6989586621684537268"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-207"></span><span>
</span><span id="line-208"></span><span class="hs-comment">-- | Assign iterations of a for-loop to all threads in the kernel.</span><span>
</span><span id="line-209"></span><span class="hs-comment">-- The passed-in function is invoked with the (symbolic) iteration.</span><span>
</span><span id="line-210"></span><span class="hs-comment">-- 'threadOperations' will be in effect in the body.  For</span><span>
</span><span id="line-211"></span><span class="hs-comment">-- multidimensional loops, use 'groupCoverSpace'.</span><span>
</span><span id="line-212"></span><span id="local-6989586621684538810"><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelLoop"><span class="hs-identifier hs-type">kernelLoop</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-213"></span><span>  </span><span class="annot"><a href="Futhark.Analysis.PrimExp.html#IntExp"><span class="hs-identifier hs-type">IntExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684538810"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-214"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684538810"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-215"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684538810"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-216"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684538810"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-217"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684538810"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#InKernelGen"><span class="hs-identifier hs-type">InKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-218"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#InKernelGen"><span class="hs-identifier hs-type">InKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-219"></span><span id="kernelLoop"><span class="annot"><span class="annottext">kernelLoop :: forall t.
IntExp t =&gt;
TExp t
-&gt; TExp t -&gt; TExp t -&gt; (TExp t -&gt; InKernelGen ()) -&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelLoop"><span class="hs-identifier hs-var hs-var">kernelLoop</span></a></span></span><span> </span><span id="local-6989586621684537258"><span class="annot"><span class="annottext">TExp t
</span><a href="#local-6989586621684537258"><span class="hs-identifier hs-var">tid</span></a></span></span><span> </span><span id="local-6989586621684537257"><span class="annot"><span class="annottext">TExp t
</span><a href="#local-6989586621684537257"><span class="hs-identifier hs-var">num_threads</span></a></span></span><span> </span><span id="local-6989586621684537256"><span class="annot"><span class="annottext">TExp t
</span><a href="#local-6989586621684537256"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621684537255"><span class="annot"><span class="annottext">TExp t -&gt; InKernelGen ()
</span><a href="#local-6989586621684537255"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-220"></span><span>  </span><span class="annot"><span class="annottext">Operations GPUMem KernelEnv KernelOp
-&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op a.
Operations rep r op -&gt; ImpM rep r op a -&gt; ImpM rep r op a
</span><a href="Futhark.CodeGen.ImpGen.html#localOps"><span class="hs-identifier hs-var">localOps</span></a></span><span> </span><span class="annot"><span class="annottext">Operations GPUMem KernelEnv KernelOp
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#threadOperations"><span class="hs-identifier hs-var">threadOperations</span></a></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-221"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">TExp t
</span><a href="#local-6989586621684537256"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">TExp t -&gt; TExp t -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">TExp t
</span><a href="#local-6989586621684537257"><span class="hs-identifier hs-var">num_threads</span></a></span><span>
</span><span id="line-222"></span><span>      </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">TExp t -&gt; InKernelGen ()
</span><a href="#local-6989586621684537255"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">TExp t
</span><a href="#local-6989586621684537258"><span class="hs-identifier hs-var">tid</span></a></span><span>
</span><span id="line-223"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-224"></span><span>        </span><span class="hs-comment">-- Compute how many elements this thread is responsible for.</span><span>
</span><span id="line-225"></span><span>        </span><span class="hs-comment">-- Formula: (n - tid) / num_threads (rounded up).</span><span>
</span><span id="line-226"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684537252"><span class="annot"><span class="annottext">elems_for_this :: TExp t
</span><a href="#local-6989586621684537252"><span class="hs-identifier hs-var hs-var">elems_for_this</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp t
</span><a href="#local-6989586621684537256"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">TExp t -&gt; TExp t -&gt; TExp t
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">TExp t
</span><a href="#local-6989586621684537258"><span class="hs-identifier hs-var">tid</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TExp t -&gt; TExp t -&gt; TExp t
forall e. IntegralExp e =&gt; e -&gt; e -&gt; e
</span><a href="Futhark.Util.IntegralExp.html#divUp"><span class="hs-operator hs-var">`divUp`</span></a></span><span> </span><span class="annot"><span class="annottext">TExp t
</span><a href="#local-6989586621684537257"><span class="hs-identifier hs-var">num_threads</span></a></span><span>
</span><span id="line-227"></span><span>
</span><span id="line-228"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; TExp t -&gt; (TExp t -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall t rep r op.
String
-&gt; TExp t -&gt; (TExp t -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sFor"><span class="hs-identifier hs-var">sFor</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;i&quot;</span></span><span> </span><span class="annot"><span class="annottext">TExp t
</span><a href="#local-6989586621684537252"><span class="hs-identifier hs-var">elems_for_this</span></a></span><span> </span><span class="annot"><span class="annottext">((TExp t -&gt; InKernelGen ()) -&gt; InKernelGen ())
-&gt; (TExp t -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684537250"><span class="annot"><span class="annottext">TExp t
</span><a href="#local-6989586621684537250"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TExp t -&gt; InKernelGen ()
</span><a href="#local-6989586621684537255"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp t -&gt; InKernelGen ()) -&gt; TExp t -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp t
</span><a href="#local-6989586621684537250"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">TExp t -&gt; TExp t -&gt; TExp t
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TExp t
</span><a href="#local-6989586621684537257"><span class="hs-identifier hs-var">num_threads</span></a></span><span> </span><span class="annot"><span class="annottext">TExp t -&gt; TExp t -&gt; TExp t
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TExp t
</span><a href="#local-6989586621684537258"><span class="hs-identifier hs-var">tid</span></a></span><span>
</span><span id="line-229"></span><span>
</span><span id="line-230"></span><span class="hs-comment">-- | Assign iterations of a for-loop to threads in the workgroup.  The</span><span>
</span><span id="line-231"></span><span class="hs-comment">-- passed-in function is invoked with the (symbolic) iteration.  For</span><span>
</span><span id="line-232"></span><span class="hs-comment">-- multidimensional loops, use 'groupCoverSpace'.</span><span>
</span><span id="line-233"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#groupLoop"><span class="hs-identifier hs-type">groupLoop</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-234"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-235"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#InKernelGen"><span class="hs-identifier hs-type">InKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-236"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#InKernelGen"><span class="hs-identifier hs-type">InKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-237"></span><span id="groupLoop"><span class="annot"><span class="annottext">groupLoop :: TExp Int64 -&gt; (TExp Int64 -&gt; InKernelGen ()) -&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#groupLoop"><span class="hs-identifier hs-var hs-var">groupLoop</span></a></span></span><span> </span><span id="local-6989586621684537247"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684537247"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621684537246"><span class="annot"><span class="annottext">TExp Int64 -&gt; InKernelGen ()
</span><a href="#local-6989586621684537246"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-238"></span><span>  </span><span id="local-6989586621684537245"><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684537245"><span class="hs-identifier hs-var">constants</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">KernelEnv -&gt; KernelConstants
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelConstants"><span class="hs-identifier hs-var hs-var">kernelConstants</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelEnv -&gt; KernelConstants)
-&gt; ImpM GPUMem KernelEnv KernelOp KernelEnv
-&gt; ImpM GPUMem KernelEnv KernelOp KernelConstants
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ImpM GPUMem KernelEnv KernelOp KernelEnv
forall rep r op. ImpM rep r op r
</span><a href="Futhark.CodeGen.ImpGen.html#askEnv"><span class="hs-identifier hs-var">askEnv</span></a></span><span>
</span><span id="line-239"></span><span>  </span><span class="annot"><span class="annottext">TExp Int64
-&gt; TExp Int64
-&gt; TExp Int64
-&gt; (TExp Int64 -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall t.
IntExp t =&gt;
TExp t
-&gt; TExp t -&gt; TExp t -&gt; (TExp t -&gt; InKernelGen ()) -&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelLoop"><span class="hs-identifier hs-var">kernelLoop</span></a></span><span>
</span><span id="line-240"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int64
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int32 -&gt; TExp Int64) -&gt; TExp Int32 -&gt; TExp Int64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelLocalThreadId"><span class="hs-identifier hs-var hs-var">kernelLocalThreadId</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684537245"><span class="hs-identifier hs-var">constants</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-241"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelGroupSize"><span class="hs-identifier hs-var hs-var">kernelGroupSize</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684537245"><span class="hs-identifier hs-var">constants</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-242"></span><span>    </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684537247"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-243"></span><span>    </span><span class="annot"><span class="annottext">TExp Int64 -&gt; InKernelGen ()
</span><a href="#local-6989586621684537246"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-244"></span><span>
</span><span id="line-245"></span><span class="hs-comment">-- | Iterate collectively though a multidimensional space, such that</span><span>
</span><span id="line-246"></span><span class="hs-comment">-- all threads in the group participate.  The passed-in function is</span><span>
</span><span id="line-247"></span><span class="hs-comment">-- invoked with a (symbolic) point in the index space.</span><span>
</span><span id="line-248"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#groupCoverSpace"><span class="hs-identifier hs-type">groupCoverSpace</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-249"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-250"></span><span>  </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#InKernelGen"><span class="hs-identifier hs-type">InKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-251"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#InKernelGen"><span class="hs-identifier hs-type">InKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-252"></span><span id="groupCoverSpace"><span class="annot"><span class="annottext">groupCoverSpace :: [TExp Int64] -&gt; ([TExp Int64] -&gt; InKernelGen ()) -&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#groupCoverSpace"><span class="hs-identifier hs-var hs-var">groupCoverSpace</span></a></span></span><span> </span><span id="local-6989586621684537244"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684537244"><span class="hs-identifier hs-var">ds</span></a></span></span><span> </span><span id="local-6989586621684537243"><span class="annot"><span class="annottext">[TExp Int64] -&gt; InKernelGen ()
</span><a href="#local-6989586621684537243"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-253"></span><span>  </span><span class="annot"><span class="annottext">TExp Int64 -&gt; (TExp Int64 -&gt; InKernelGen ()) -&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#groupLoop"><span class="hs-identifier hs-var">groupLoop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TExp Int64] -&gt; TExp Int64
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">product</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684537244"><span class="hs-identifier hs-var">ds</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((TExp Int64 -&gt; InKernelGen ()) -&gt; InKernelGen ())
-&gt; (TExp Int64 -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; InKernelGen ()
</span><a href="#local-6989586621684537243"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">([TExp Int64] -&gt; InKernelGen ())
-&gt; (TExp Int64 -&gt; [TExp Int64]) -&gt; TExp Int64 -&gt; InKernelGen ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; TExp Int64 -&gt; [TExp Int64]
forall num. IntegralExp num =&gt; [num] -&gt; num -&gt; [num]
</span><a href="Futhark.IR.Prop.Reshape.html#unflattenIndex"><span class="hs-identifier hs-var">unflattenIndex</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684537244"><span class="hs-identifier hs-var">ds</span></a></span><span>
</span><span id="line-254"></span><span>
</span><span id="line-255"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileGroupExp"><span class="hs-identifier hs-type">compileGroupExp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ExpCompiler"><span class="hs-identifier hs-type">ExpCompiler</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#KernelEnv"><span class="hs-identifier hs-type">KernelEnv</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.GPU.html#KernelOp"><span class="hs-identifier hs-type">Imp.KernelOp</span></a></span><span>
</span><span id="line-256"></span><span id="compileGroupExp"><span class="annot"><span class="annottext">compileGroupExp :: ExpCompiler GPUMem KernelEnv KernelOp
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileGroupExp"><span class="hs-identifier hs-var hs-var">compileGroupExp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621684537239"><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
</span><a href="#local-6989586621684537239"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Opaque"><span class="hs-identifier hs-type">Opaque</span></a></span><span> </span><span class="annot"><span class="annottext">OpaqueOp
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684537238"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684537238"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-257"></span><span>  </span><span class="hs-comment">-- Cannot print in GPU code.</span><span>
</span><span id="line-258"></span><span>  </span><span class="annot"><span class="annottext">VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; InKernelGen ()
forall rep r op.
VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-var">copyDWIM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
PatElemT LParamMem
</span><a href="#local-6989586621684537239"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684537238"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-259"></span><span class="hs-comment">-- The static arrays stuff does not work inside kernels.</span><span>
</span><span id="line-260"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileGroupExp"><span class="hs-identifier hs-var">compileGroupExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621684537237"><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
</span><a href="#local-6989586621684537237"><span class="hs-identifier hs-var">dest</span></a></span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#ArrayLit"><span class="hs-identifier hs-type">ArrayLit</span></a></span><span> </span><span id="local-6989586621684537236"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684537236"><span class="hs-identifier hs-var">es</span></a></span></span><span> </span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-261"></span><span>  </span><span class="annot"><span class="annottext">[(Int64, SubExp)]
-&gt; ((Int64, SubExp) -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Int64] -&gt; [SubExp] -&gt; [(Int64, SubExp)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int64
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">..</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684537236"><span class="hs-identifier hs-var">es</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Int64, SubExp) -&gt; InKernelGen ()) -&gt; InKernelGen ())
-&gt; ((Int64, SubExp) -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684537235"><span class="annot"><span class="annottext">Int64
</span><a href="#local-6989586621684537235"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684537234"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684537234"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-262"></span><span>    </span><span class="annot"><span class="annottext">VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; InKernelGen ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
PatElemT LParamMem
</span><a href="#local-6989586621684537237"><span class="hs-identifier hs-var">dest</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int64 -&gt; TExp Int64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int64
</span><a href="#local-6989586621684537235"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684537234"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-263"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileGroupExp"><span class="hs-identifier hs-var">compileGroupExp</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#UpdateAcc"><span class="hs-identifier hs-type">UpdateAcc</span></a></span><span> </span><span id="local-6989586621684537233"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684537233"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621684537232"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684537232"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span id="local-6989586621684537231"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684537231"><span class="hs-identifier hs-var">vs</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-264"></span><span>  </span><span class="annot"><span class="annottext">VName -&gt; [SubExp] -&gt; [SubExp] -&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#updateAcc"><span class="hs-identifier hs-var">updateAcc</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684537233"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684537232"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684537231"><span class="hs-identifier hs-var">vs</span></a></span><span>
</span><span id="line-265"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileGroupExp"><span class="hs-identifier hs-var">compileGroupExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621684537230"><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
</span><a href="#local-6989586621684537230"><span class="hs-identifier hs-var">dest</span></a></span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Replicate"><span class="hs-identifier hs-type">Replicate</span></a></span><span> </span><span id="local-6989586621684537228"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684537228"><span class="hs-identifier hs-var">ds</span></a></span></span><span> </span><span id="local-6989586621684537227"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684537227"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-266"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684537226"><span class="annot"><span class="annottext">ds' :: [TExp Int64]
</span><a href="#local-6989586621684537226"><span class="hs-identifier hs-var hs-var">ds'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [TExp Int64]) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Shape -&gt; [SubExp]
forall d. ShapeBase d -&gt; [d]
</span><a href="Futhark.IR.Syntax.Core.html#shapeDims"><span class="hs-identifier hs-var hs-var">shapeDims</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684537228"><span class="hs-identifier hs-var">ds</span></a></span><span>
</span><span id="line-267"></span><span>  </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; ([TExp Int64] -&gt; InKernelGen ()) -&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#groupCoverSpace"><span class="hs-identifier hs-var">groupCoverSpace</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684537226"><span class="hs-identifier hs-var">ds'</span></a></span><span> </span><span class="annot"><span class="annottext">(([TExp Int64] -&gt; InKernelGen ()) -&gt; InKernelGen ())
-&gt; ([TExp Int64] -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684537224"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684537224"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-268"></span><span>    </span><span class="annot"><span class="annottext">VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; InKernelGen ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
PatElemT LParamMem
</span><a href="#local-6989586621684537230"><span class="hs-identifier hs-var">dest</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684537224"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684537227"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; [TExp Int64] -&gt; [TExp Int64]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Shape -&gt; Int
forall a. ArrayShape a =&gt; a -&gt; Int
</span><a href="Futhark.IR.Syntax.Core.html#shapeRank"><span class="hs-identifier hs-var">shapeRank</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684537228"><span class="hs-identifier hs-var">ds</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684537224"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-269"></span><span>  </span><span class="annot"><span class="annottext">KernelOp -&gt; InKernelGen ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelOp -&gt; InKernelGen ()) -&gt; KernelOp -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Fence -&gt; KernelOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#Barrier"><span class="hs-identifier hs-var">Imp.Barrier</span></a></span><span> </span><span class="annot"><span class="annottext">Fence
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#FenceLocal"><span class="hs-identifier hs-var">Imp.FenceLocal</span></a></span><span>
</span><span id="line-270"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileGroupExp"><span class="hs-identifier hs-var">compileGroupExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621684537219"><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
</span><a href="#local-6989586621684537219"><span class="hs-identifier hs-var">dest</span></a></span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Iota"><span class="hs-identifier hs-type">Iota</span></a></span><span> </span><span id="local-6989586621684537217"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684537217"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621684537216"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684537216"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621684537215"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684537215"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621684537214"><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684537214"><span class="hs-identifier hs-var">it</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-271"></span><span>  </span><span id="local-6989586621684537213"><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684537213"><span class="hs-identifier hs-var">n'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; ImpM GPUMem KernelEnv KernelOp (PrimExp VName)
forall a rep r op. ToExp a =&gt; a -&gt; ImpM rep r op (PrimExp VName)
</span><a href="Futhark.CodeGen.ImpGen.html#toExp"><span class="hs-identifier hs-var">toExp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684537217"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-272"></span><span>  </span><span id="local-6989586621684537212"><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684537212"><span class="hs-identifier hs-var">e'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; ImpM GPUMem KernelEnv KernelOp (PrimExp VName)
forall a rep r op. ToExp a =&gt; a -&gt; ImpM rep r op (PrimExp VName)
</span><a href="Futhark.CodeGen.ImpGen.html#toExp"><span class="hs-identifier hs-var">toExp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684537216"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-273"></span><span>  </span><span id="local-6989586621684537211"><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684537211"><span class="hs-identifier hs-var">s'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; ImpM GPUMem KernelEnv KernelOp (PrimExp VName)
forall a rep r op. ToExp a =&gt; a -&gt; ImpM rep r op (PrimExp VName)
</span><a href="Futhark.CodeGen.ImpGen.html#toExp"><span class="hs-identifier hs-var">toExp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684537215"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-274"></span><span>  </span><span class="annot"><span class="annottext">TExp Int64 -&gt; (TExp Int64 -&gt; InKernelGen ()) -&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#groupLoop"><span class="hs-identifier hs-var">groupLoop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimExp VName -&gt; TExp Int64
forall t v. PrimExp v -&gt; TPrimExp t v
</span><a href="Futhark.Analysis.PrimExp.html#TPrimExp"><span class="hs-identifier hs-var">TPrimExp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684537213"><span class="hs-identifier hs-var">n'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((TExp Int64 -&gt; InKernelGen ()) -&gt; InKernelGen ())
-&gt; (TExp Int64 -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684537210"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684537210"><span class="hs-identifier hs-var">i'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-275"></span><span>    </span><span id="local-6989586621684537209"><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684537209"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-276"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; TExp Any -&gt; ImpM GPUMem KernelEnv KernelOp (TV Any)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV"><span class="hs-identifier hs-var">dPrimV</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;x&quot;</span></span><span> </span><span class="annot"><span class="annottext">(TExp Any -&gt; ImpM GPUMem KernelEnv KernelOp (TV Any))
-&gt; TExp Any -&gt; ImpM GPUMem KernelEnv KernelOp (TV Any)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-277"></span><span>        </span><span class="annot"><span class="annottext">PrimExp VName -&gt; TExp Any
forall t v. PrimExp v -&gt; TPrimExp t v
</span><a href="Futhark.Analysis.PrimExp.html#TPrimExp"><span class="hs-identifier hs-var">TPrimExp</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimExp VName -&gt; TExp Any) -&gt; PrimExp VName -&gt; TExp Any
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-278"></span><span>          </span><span class="annot"><span class="annottext">BinOp -&gt; PrimExp VName -&gt; PrimExp VName -&gt; PrimExp VName
forall v. BinOp -&gt; PrimExp v -&gt; PrimExp v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#BinOpExp"><span class="hs-identifier hs-var">BinOpExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Overflow -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#Add"><span class="hs-identifier hs-var">Add</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684537214"><span class="hs-identifier hs-var">it</span></a></span><span> </span><span class="annot"><span class="annottext">Overflow
</span><a href="Futhark.IR.Primitive.html#OverflowUndef"><span class="hs-identifier hs-var">OverflowUndef</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684537212"><span class="hs-identifier hs-var">e'</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimExp VName -&gt; PrimExp VName) -&gt; PrimExp VName -&gt; PrimExp VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-279"></span><span>            </span><span class="annot"><span class="annottext">BinOp -&gt; PrimExp VName -&gt; PrimExp VName -&gt; PrimExp VName
forall v. BinOp -&gt; PrimExp v -&gt; PrimExp v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#BinOpExp"><span class="hs-identifier hs-var">BinOpExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Overflow -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#Mul"><span class="hs-identifier hs-var">Mul</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684537214"><span class="hs-identifier hs-var">it</span></a></span><span> </span><span class="annot"><span class="annottext">Overflow
</span><a href="Futhark.IR.Primitive.html#OverflowUndef"><span class="hs-identifier hs-var">OverflowUndef</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int64 -&gt; PrimExp VName
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684537210"><span class="hs-identifier hs-var">i'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684537211"><span class="hs-identifier hs-var">s'</span></a></span><span>
</span><span id="line-280"></span><span>    </span><span class="annot"><span class="annottext">VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; InKernelGen ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
PatElemT LParamMem
</span><a href="#local-6989586621684537219"><span class="hs-identifier hs-var">dest</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684537210"><span class="hs-identifier hs-var">i'</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Any -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684537209"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-281"></span><span>  </span><span class="annot"><span class="annottext">KernelOp -&gt; InKernelGen ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelOp -&gt; InKernelGen ()) -&gt; KernelOp -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Fence -&gt; KernelOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#Barrier"><span class="hs-identifier hs-var">Imp.Barrier</span></a></span><span> </span><span class="annot"><span class="annottext">Fence
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#FenceLocal"><span class="hs-identifier hs-var">Imp.FenceLocal</span></a></span><span>
</span><span id="line-282"></span><span>
</span><span id="line-283"></span><span class="hs-comment">-- When generating code for a scalar in-place update, we must make</span><span>
</span><span id="line-284"></span><span class="hs-comment">-- sure that only one thread performs the write.  When writing an</span><span>
</span><span id="line-285"></span><span class="hs-comment">-- array, the group-level copy code will take care of doing the right</span><span>
</span><span id="line-286"></span><span class="hs-comment">-- thing.</span><span>
</span><span id="line-287"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileGroupExp"><span class="hs-identifier hs-var">compileGroupExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621684537200"><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
</span><a href="#local-6989586621684537200"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Update"><span class="hs-identifier hs-type">Update</span></a></span><span> </span><span id="local-6989586621684537198"><span class="annot"><span class="annottext">Safety
</span><a href="#local-6989586621684537198"><span class="hs-identifier hs-var">safety</span></a></span></span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684537197"><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684537197"><span class="hs-identifier hs-var">slice</span></a></span></span><span> </span><span id="local-6989586621684537196"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684537196"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-288"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; Bool) -&gt; [SubExp] -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Slice SubExp -&gt; [SubExp]
forall d. Slice d -&gt; [d]
</span><a href="Futhark.IR.Syntax.Core.html#sliceDims"><span class="hs-identifier hs-var">sliceDims</span></a></span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684537197"><span class="hs-identifier hs-var">slice</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-289"></span><span>    </span><span class="annot"><span class="annottext">KernelOp -&gt; InKernelGen ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelOp -&gt; InKernelGen ()) -&gt; KernelOp -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Fence -&gt; KernelOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#Barrier"><span class="hs-identifier hs-var">Imp.Barrier</span></a></span><span> </span><span class="annot"><span class="annottext">Fence
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#FenceLocal"><span class="hs-identifier hs-var">Imp.FenceLocal</span></a></span><span>
</span><span id="line-290"></span><span>    </span><span id="local-6989586621684537193"><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684537193"><span class="hs-identifier hs-var">ltid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelLocalThreadId"><span class="hs-identifier hs-var hs-var">kernelLocalThreadId</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelConstants -&gt; TExp Int32)
-&gt; (KernelEnv -&gt; KernelConstants) -&gt; KernelEnv -&gt; TExp Int32
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">KernelEnv -&gt; KernelConstants
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelConstants"><span class="hs-identifier hs-var hs-var">kernelConstants</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelEnv -&gt; TExp Int32)
-&gt; ImpM GPUMem KernelEnv KernelOp KernelEnv
-&gt; ImpM GPUMem KernelEnv KernelOp (TExp Int32)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ImpM GPUMem KernelEnv KernelOp KernelEnv
forall rep r op. ImpM rep r op r
</span><a href="Futhark.CodeGen.ImpGen.html#askEnv"><span class="hs-identifier hs-var">askEnv</span></a></span><span>
</span><span id="line-291"></span><span>    </span><span class="annot"><span class="annottext">TExp Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684537193"><span class="hs-identifier hs-var">ltid</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3D%3D."><span class="hs-operator hs-var">.==.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-292"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Safety
</span><a href="#local-6989586621684537198"><span class="hs-identifier hs-var">safety</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-293"></span><span>        </span><span class="annot"><span class="annottext">Safety
</span><a href="Futhark.IR.Primitive.html#Unsafe"><span class="hs-identifier hs-var">Unsafe</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684537190"><span class="hs-identifier hs-var">write</span></a></span><span>
</span><span id="line-294"></span><span>        </span><span class="annot"><span class="annottext">Safety
</span><a href="Futhark.IR.Primitive.html#Safe"><span class="hs-identifier hs-var">Safe</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TExp Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Slice (TExp Int64) -&gt; [TExp Int64] -&gt; TExp Bool
</span><a href="Futhark.CodeGen.ImpGen.html#inBounds"><span class="hs-identifier hs-var">inBounds</span></a></span><span> </span><span class="annot"><span class="annottext">Slice (TExp Int64)
</span><a href="#local-6989586621684537188"><span class="hs-identifier hs-var">slice'</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684537187"><span class="hs-identifier hs-var">dims</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684537190"><span class="hs-identifier hs-var">write</span></a></span><span>
</span><span id="line-295"></span><span>    </span><span class="annot"><span class="annottext">KernelOp -&gt; InKernelGen ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelOp -&gt; InKernelGen ()) -&gt; KernelOp -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Fence -&gt; KernelOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#Barrier"><span class="hs-identifier hs-var">Imp.Barrier</span></a></span><span> </span><span class="annot"><span class="annottext">Fence
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#FenceLocal"><span class="hs-identifier hs-var">Imp.FenceLocal</span></a></span><span>
</span><span id="line-296"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-297"></span><span>    </span><span id="local-6989586621684537188"><span class="annot"><span class="annottext">slice' :: Slice (TExp Int64)
</span><a href="#local-6989586621684537188"><span class="hs-identifier hs-var hs-var">slice'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64) -&gt; Slice SubExp -&gt; Slice (TExp Int64)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684537197"><span class="hs-identifier hs-var">slice</span></a></span><span>
</span><span id="line-298"></span><span>    </span><span id="local-6989586621684537187"><span class="annot"><span class="annottext">dims :: [TExp Int64]
</span><a href="#local-6989586621684537187"><span class="hs-identifier hs-var hs-var">dims</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [TExp Int64]) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness -&gt; [SubExp]
forall u. TypeBase Shape u -&gt; [SubExp]
</span><a href="Futhark.IR.Prop.Types.html#arrayDims"><span class="hs-identifier hs-var">arrayDims</span></a></span><span> </span><span class="annot"><span class="annottext">(TypeBase Shape NoUniqueness -&gt; [SubExp])
-&gt; TypeBase Shape NoUniqueness -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; TypeBase Shape NoUniqueness
forall dec.
Typed dec =&gt;
PatElemT dec -&gt; TypeBase Shape NoUniqueness
</span><a href="Futhark.IR.Prop.Patterns.html#patElemType"><span class="hs-identifier hs-var">patElemType</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
PatElemT LParamMem
</span><a href="#local-6989586621684537200"><span class="hs-identifier hs-var">pe</span></a></span><span>
</span><span id="line-299"></span><span>    </span><span id="local-6989586621684537190"><span class="annot"><span class="annottext">write :: InKernelGen ()
</span><a href="#local-6989586621684537190"><span class="hs-identifier hs-var hs-var">write</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; InKernelGen ()
forall rep r op.
VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-var">copyDWIM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
PatElemT LParamMem
</span><a href="#local-6989586621684537200"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Slice (TExp Int64) -&gt; [DimIndex (TExp Int64)]
forall d. Slice d -&gt; [DimIndex d]
</span><a href="Futhark.IR.Syntax.Core.html#unSlice"><span class="hs-identifier hs-var hs-var">unSlice</span></a></span><span> </span><span class="annot"><span class="annottext">Slice (TExp Int64)
</span><a href="#local-6989586621684537188"><span class="hs-identifier hs-var">slice'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684537196"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-300"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileGroupExp"><span class="hs-identifier hs-var">compileGroupExp</span></a></span><span> </span><span id="local-6989586621684537183"><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684537183"><span class="hs-identifier hs-var">dest</span></a></span></span><span> </span><span id="local-6989586621684537182"><span class="annot"><span class="annottext">Exp GPUMem
</span><a href="#local-6989586621684537182"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-301"></span><span>  </span><span class="annot"><span class="annottext">ExpCompiler GPUMem KernelEnv KernelOp
forall rep inner r op.
Mem rep inner =&gt;
Pat rep -&gt; Exp rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#defCompileExp"><span class="hs-identifier hs-var">defCompileExp</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684537183"><span class="hs-identifier hs-var">dest</span></a></span><span> </span><span class="annot"><span class="annottext">Exp GPUMem
</span><a href="#local-6989586621684537182"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-302"></span><span>
</span><span id="line-303"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#sanityCheckLevel"><span class="hs-identifier hs-type">sanityCheckLevel</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SegLevel"><span class="hs-identifier hs-type">SegLevel</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#InKernelGen"><span class="hs-identifier hs-type">InKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-304"></span><span id="sanityCheckLevel"><span class="annot"><span class="annottext">sanityCheckLevel :: SegLevel -&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#sanityCheckLevel"><span class="hs-identifier hs-var hs-var">sanityCheckLevel</span></a></span></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SegThread"><span class="hs-identifier hs-type">SegThread</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; InKernelGen ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-305"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#sanityCheckLevel"><span class="hs-identifier hs-var">sanityCheckLevel</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SegGroup"><span class="hs-identifier hs-type">SegGroup</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-306"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; InKernelGen ()
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;compileGroupOp: unexpected group-level SegOp.&quot;</span></span><span>
</span><span id="line-307"></span><span>
</span><span id="line-308"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#localThreadIDs"><span class="hs-identifier hs-type">localThreadIDs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#InKernelGen"><span class="hs-identifier hs-type">InKernelGen</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">]</span><span>
</span><span id="line-309"></span><span id="localThreadIDs"><span class="annot"><span class="annottext">localThreadIDs :: [SubExp] -&gt; InKernelGen [TExp Int64]
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#localThreadIDs"><span class="hs-identifier hs-var hs-var">localThreadIDs</span></a></span></span><span> </span><span id="local-6989586621684537177"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684537177"><span class="hs-identifier hs-var">dims</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-310"></span><span>  </span><span id="local-6989586621684537176"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684537176"><span class="hs-identifier hs-var">ltid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int64
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int32 -&gt; TExp Int64)
-&gt; (KernelEnv -&gt; TExp Int32) -&gt; KernelEnv -&gt; TExp Int64
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelLocalThreadId"><span class="hs-identifier hs-var hs-var">kernelLocalThreadId</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelConstants -&gt; TExp Int32)
-&gt; (KernelEnv -&gt; KernelConstants) -&gt; KernelEnv -&gt; TExp Int32
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">KernelEnv -&gt; KernelConstants
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelConstants"><span class="hs-identifier hs-var hs-var">kernelConstants</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelEnv -&gt; TExp Int64)
-&gt; ImpM GPUMem KernelEnv KernelOp KernelEnv
-&gt; ImpM GPUMem KernelEnv KernelOp (TExp Int64)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ImpM GPUMem KernelEnv KernelOp KernelEnv
forall rep r op. ImpM rep r op r
</span><a href="Futhark.CodeGen.ImpGen.html#askEnv"><span class="hs-identifier hs-var">askEnv</span></a></span><span>
</span><span id="line-311"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684537175"><span class="annot"><span class="annottext">dims' :: [TExp Int64]
</span><a href="#local-6989586621684537175"><span class="hs-identifier hs-var hs-var">dims'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684537177"><span class="hs-identifier hs-var">dims</span></a></span><span>
</span><span id="line-312"></span><span>  </span><span class="annot"><span class="annottext">[TExp Int64]
-&gt; ([TExp Int32] -&gt; [TExp Int64])
-&gt; Maybe [TExp Int32]
-&gt; [TExp Int64]
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TExp Int64] -&gt; TExp Int64 -&gt; [TExp Int64]
forall num. IntegralExp num =&gt; [num] -&gt; num -&gt; [num]
</span><a href="Futhark.IR.Prop.Reshape.html#unflattenIndex"><span class="hs-identifier hs-var">unflattenIndex</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684537175"><span class="hs-identifier hs-var">dims'</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684537176"><span class="hs-identifier hs-var">ltid</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TExp Int32 -&gt; TExp Int64) -&gt; [TExp Int32] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int64
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-313"></span><span>    </span><span class="annot"><span class="annottext">(Maybe [TExp Int32] -&gt; [TExp Int64])
-&gt; (KernelEnv -&gt; Maybe [TExp Int32]) -&gt; KernelEnv -&gt; [TExp Int64]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; Map [SubExp] [TExp Int32] -&gt; Maybe [TExp Int32]
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684537177"><span class="hs-identifier hs-var">dims</span></a></span><span>
</span><span id="line-314"></span><span>    </span><span class="annot"><span class="annottext">(Map [SubExp] [TExp Int32] -&gt; Maybe [TExp Int32])
-&gt; (KernelEnv -&gt; Map [SubExp] [TExp Int32])
-&gt; KernelEnv
-&gt; Maybe [TExp Int32]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; Map [SubExp] [TExp Int32]
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelLocalIdMap"><span class="hs-identifier hs-var hs-var">kernelLocalIdMap</span></a></span><span>
</span><span id="line-315"></span><span>    </span><span class="annot"><span class="annottext">(KernelConstants -&gt; Map [SubExp] [TExp Int32])
-&gt; (KernelEnv -&gt; KernelConstants)
-&gt; KernelEnv
-&gt; Map [SubExp] [TExp Int32]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">KernelEnv -&gt; KernelConstants
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelConstants"><span class="hs-identifier hs-var hs-var">kernelConstants</span></a></span><span>
</span><span id="line-316"></span><span>    </span><span class="annot"><span class="annottext">(KernelEnv -&gt; [TExp Int64])
-&gt; ImpM GPUMem KernelEnv KernelOp KernelEnv
-&gt; InKernelGen [TExp Int64]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ImpM GPUMem KernelEnv KernelOp KernelEnv
forall rep r op. ImpM rep r op r
</span><a href="Futhark.CodeGen.ImpGen.html#askEnv"><span class="hs-identifier hs-var">askEnv</span></a></span><span>
</span><span id="line-317"></span><span>
</span><span id="line-318"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileGroupSpace"><span class="hs-identifier hs-type">compileGroupSpace</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SegLevel"><span class="hs-identifier hs-type">SegLevel</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegSpace"><span class="hs-identifier hs-type">SegSpace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#InKernelGen"><span class="hs-identifier hs-type">InKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-319"></span><span id="compileGroupSpace"><span class="annot"><span class="annottext">compileGroupSpace :: SegLevel -&gt; SegSpace -&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileGroupSpace"><span class="hs-identifier hs-var hs-var">compileGroupSpace</span></a></span></span><span> </span><span id="local-6989586621684537173"><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684537173"><span class="hs-identifier hs-var">lvl</span></a></span></span><span> </span><span id="local-6989586621684537172"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684537172"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-320"></span><span>  </span><span class="annot"><span class="annottext">SegLevel -&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#sanityCheckLevel"><span class="hs-identifier hs-var">sanityCheckLevel</span></a></span><span> </span><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684537173"><span class="hs-identifier hs-var">lvl</span></a></span><span>
</span><span id="line-321"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684537171"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684537171"><span class="hs-identifier hs-var">ltids</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684537170"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684537170"><span class="hs-identifier hs-var">dims</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VName, SubExp)] -&gt; ([VName], [SubExp])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(VName, SubExp)] -&gt; ([VName], [SubExp]))
-&gt; [(VName, SubExp)] -&gt; ([VName], [SubExp])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; [(VName, SubExp)]
</span><a href="Futhark.IR.SegOp.html#unSegSpace"><span class="hs-identifier hs-var hs-var">unSegSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684537172"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-322"></span><span>  </span><span class="annot"><span class="annottext">(VName -&gt; TExp Int64 -&gt; InKernelGen ())
-&gt; [VName] -&gt; [TExp Int64] -&gt; InKernelGen ()
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m ()
</span><span class="hs-identifier hs-var">zipWithM_</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TExp Int64 -&gt; InKernelGen ()
forall t rep r op. VName -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV_"><span class="hs-identifier hs-var">dPrimV_</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684537171"><span class="hs-identifier hs-var">ltids</span></a></span><span> </span><span class="annot"><span class="annottext">([TExp Int64] -&gt; InKernelGen ())
-&gt; InKernelGen [TExp Int64] -&gt; InKernelGen ()
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; InKernelGen [TExp Int64]
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#localThreadIDs"><span class="hs-identifier hs-var">localThreadIDs</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684537170"><span class="hs-identifier hs-var">dims</span></a></span><span>
</span><span id="line-323"></span><span>  </span><span id="local-6989586621684537165"><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684537165"><span class="hs-identifier hs-var">ltid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelLocalThreadId"><span class="hs-identifier hs-var hs-var">kernelLocalThreadId</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelConstants -&gt; TExp Int32)
-&gt; (KernelEnv -&gt; KernelConstants) -&gt; KernelEnv -&gt; TExp Int32
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">KernelEnv -&gt; KernelConstants
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelConstants"><span class="hs-identifier hs-var hs-var">kernelConstants</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelEnv -&gt; TExp Int32)
-&gt; ImpM GPUMem KernelEnv KernelOp KernelEnv
-&gt; ImpM GPUMem KernelEnv KernelOp (TExp Int32)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ImpM GPUMem KernelEnv KernelOp KernelEnv
forall rep r op. ImpM rep r op r
</span><a href="Futhark.CodeGen.ImpGen.html#askEnv"><span class="hs-identifier hs-var">askEnv</span></a></span><span>
</span><span id="line-324"></span><span>  </span><span class="annot"><span class="annottext">VName -&gt; TExp Int32 -&gt; InKernelGen ()
forall t rep r op. VName -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV_"><span class="hs-identifier hs-var">dPrimV_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegSpace -&gt; VName
</span><a href="Futhark.IR.SegOp.html#segFlat"><span class="hs-identifier hs-var hs-var">segFlat</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684537172"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684537165"><span class="hs-identifier hs-var">ltid</span></a></span><span>
</span><span id="line-325"></span><span>
</span><span id="line-326"></span><span class="hs-comment">-- Construct the necessary lock arrays for an intra-group histogram.</span><span>
</span><span id="line-327"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#prepareIntraGroupSegHist"><span class="hs-identifier hs-type">prepareIntraGroupSegHist</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-328"></span><span>  </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-type">Count</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#GroupSize"><span class="hs-identifier hs-type">GroupSize</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-329"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.SegOp.html#HistOp"><span class="hs-identifier hs-type">HistOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-330"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#InKernelGen"><span class="hs-identifier hs-type">InKernelGen</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#InKernelGen"><span class="hs-identifier hs-type">InKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-331"></span><span id="prepareIntraGroupSegHist"><span class="annot"><span class="annottext">prepareIntraGroupSegHist :: Count GroupSize SubExp
-&gt; [HistOp GPUMem] -&gt; InKernelGen [[TExp Int64] -&gt; InKernelGen ()]
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#prepareIntraGroupSegHist"><span class="hs-identifier hs-var hs-var">prepareIntraGroupSegHist</span></a></span></span><span> </span><span id="local-6989586621684537162"><span class="annot"><span class="annottext">Count GroupSize SubExp
</span><a href="#local-6989586621684537162"><span class="hs-identifier hs-var">group_size</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-332"></span><span>  </span><span class="annot"><span class="annottext">((Maybe Locking, [[TExp Int64] -&gt; InKernelGen ()])
 -&gt; [[TExp Int64] -&gt; InKernelGen ()])
-&gt; ImpM
     GPUMem
     KernelEnv
     KernelOp
     (Maybe Locking, [[TExp Int64] -&gt; InKernelGen ()])
-&gt; InKernelGen [[TExp Int64] -&gt; InKernelGen ()]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Locking, [[TExp Int64] -&gt; InKernelGen ()])
-&gt; [[TExp Int64] -&gt; InKernelGen ()]
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">(ImpM
   GPUMem
   KernelEnv
   KernelOp
   (Maybe Locking, [[TExp Int64] -&gt; InKernelGen ()])
 -&gt; InKernelGen [[TExp Int64] -&gt; InKernelGen ()])
-&gt; ([HistOp GPUMem]
    -&gt; ImpM
         GPUMem
         KernelEnv
         KernelOp
         (Maybe Locking, [[TExp Int64] -&gt; InKernelGen ()]))
-&gt; [HistOp GPUMem]
-&gt; InKernelGen [[TExp Int64] -&gt; InKernelGen ()]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Locking
 -&gt; HistOp GPUMem
 -&gt; ImpM
      GPUMem
      KernelEnv
      KernelOp
      (Maybe Locking, [TExp Int64] -&gt; InKernelGen ()))
-&gt; Maybe Locking
-&gt; [HistOp GPUMem]
-&gt; ImpM
     GPUMem
     KernelEnv
     KernelOp
     (Maybe Locking, [[TExp Int64] -&gt; InKernelGen ()])
forall (m :: * -&gt; *) acc x y.
Monad m =&gt;
(acc -&gt; x -&gt; m (acc, y)) -&gt; acc -&gt; [x] -&gt; m (acc, [y])
</span><a href="Futhark.Util.html#mapAccumLM"><span class="hs-identifier hs-var">mapAccumLM</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Locking
-&gt; HistOp GPUMem
-&gt; ImpM
     GPUMem
     KernelEnv
     KernelOp
     (Maybe Locking, [TExp Int64] -&gt; InKernelGen ())
</span><a href="#local-6989586621684537161"><span class="hs-identifier hs-var">onOp</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Locking
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-333"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-334"></span><span>    </span><span id="local-6989586621684537161"><span class="annot"><span class="annottext">onOp :: Maybe Locking
-&gt; HistOp GPUMem
-&gt; ImpM
     GPUMem
     KernelEnv
     KernelOp
     (Maybe Locking, [TExp Int64] -&gt; InKernelGen ())
</span><a href="#local-6989586621684537161"><span class="hs-identifier hs-var hs-var">onOp</span></a></span></span><span> </span><span id="local-6989586621684537160"><span class="annot"><span class="annottext">Maybe Locking
</span><a href="#local-6989586621684537160"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span id="local-6989586621684537159"><span class="annot"><span class="annottext">HistOp GPUMem
</span><a href="#local-6989586621684537159"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-335"></span><span>      </span><span id="local-6989586621684537158"><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684537158"><span class="hs-identifier hs-var">constants</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">KernelEnv -&gt; KernelConstants
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelConstants"><span class="hs-identifier hs-var hs-var">kernelConstants</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelEnv -&gt; KernelConstants)
-&gt; ImpM GPUMem KernelEnv KernelOp KernelEnv
-&gt; ImpM GPUMem KernelEnv KernelOp KernelConstants
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ImpM GPUMem KernelEnv KernelOp KernelEnv
forall rep r op. ImpM rep r op r
</span><a href="Futhark.CodeGen.ImpGen.html#askEnv"><span class="hs-identifier hs-var">askEnv</span></a></span><span>
</span><span id="line-336"></span><span>      </span><span id="local-6989586621684537157"><span class="annot"><span class="annottext">AtomicBinOp
</span><a href="#local-6989586621684537157"><span class="hs-identifier hs-var">atomicBinOp</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">KernelEnv -&gt; AtomicBinOp
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelAtomics"><span class="hs-identifier hs-var hs-var">kernelAtomics</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelEnv -&gt; AtomicBinOp)
-&gt; ImpM GPUMem KernelEnv KernelOp KernelEnv
-&gt; ImpM GPUMem KernelEnv KernelOp AtomicBinOp
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ImpM GPUMem KernelEnv KernelOp KernelEnv
forall rep r op. ImpM rep r op r
</span><a href="Futhark.CodeGen.ImpGen.html#askEnv"><span class="hs-identifier hs-var">askEnv</span></a></span><span>
</span><span id="line-337"></span><span>
</span><span id="line-338"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684537156"><span class="annot"><span class="annottext">local_subhistos :: [VName]
</span><a href="#local-6989586621684537156"><span class="hs-identifier hs-var hs-var">local_subhistos</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HistOp GPUMem -&gt; [VName]
forall rep. HistOp rep -&gt; [VName]
</span><a href="Futhark.IR.SegOp.html#histDest"><span class="hs-identifier hs-var hs-var">histDest</span></a></span><span> </span><span class="annot"><span class="annottext">HistOp GPUMem
</span><a href="#local-6989586621684537159"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-339"></span><span>
</span><span id="line-340"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe Locking
</span><a href="#local-6989586621684537160"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AtomicBinOp -&gt; Lambda GPUMem -&gt; AtomicUpdate GPUMem KernelEnv
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#atomicUpdateLocking"><span class="hs-identifier hs-var">atomicUpdateLocking</span></a></span><span> </span><span class="annot"><span class="annottext">AtomicBinOp
</span><a href="#local-6989586621684537157"><span class="hs-identifier hs-var">atomicBinOp</span></a></span><span> </span><span class="annot"><span class="annottext">(Lambda GPUMem -&gt; AtomicUpdate GPUMem KernelEnv)
-&gt; Lambda GPUMem -&gt; AtomicUpdate GPUMem KernelEnv
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HistOp GPUMem -&gt; Lambda GPUMem
forall rep. HistOp rep -&gt; Lambda rep
</span><a href="Futhark.IR.SegOp.html#histOp"><span class="hs-identifier hs-var hs-var">histOp</span></a></span><span> </span><span class="annot"><span class="annottext">HistOp GPUMem
</span><a href="#local-6989586621684537159"><span class="hs-identifier hs-var">op</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-341"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe Locking
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#AtomicPrim"><span class="hs-identifier hs-type">AtomicPrim</span></a></span><span> </span><span id="local-6989586621684537153"><span class="annot"><span class="annottext">DoAtomicUpdate GPUMem KernelEnv
</span><a href="#local-6989586621684537153"><span class="hs-identifier hs-var">f</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Maybe Locking, [TExp Int64] -&gt; InKernelGen ())
-&gt; ImpM
     GPUMem
     KernelEnv
     KernelOp
     (Maybe Locking, [TExp Int64] -&gt; InKernelGen ())
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe Locking
</span><a href="#local-6989586621684537160"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DoAtomicUpdate GPUMem KernelEnv
</span><a href="#local-6989586621684537153"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Space
</span><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-var">Space</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;local&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684537156"><span class="hs-identifier hs-var">local_subhistos</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-342"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe Locking
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#AtomicCAS"><span class="hs-identifier hs-type">AtomicCAS</span></a></span><span> </span><span id="local-6989586621684537152"><span class="annot"><span class="annottext">DoAtomicUpdate GPUMem KernelEnv
</span><a href="#local-6989586621684537152"><span class="hs-identifier hs-var">f</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Maybe Locking, [TExp Int64] -&gt; InKernelGen ())
-&gt; ImpM
     GPUMem
     KernelEnv
     KernelOp
     (Maybe Locking, [TExp Int64] -&gt; InKernelGen ())
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe Locking
</span><a href="#local-6989586621684537160"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DoAtomicUpdate GPUMem KernelEnv
</span><a href="#local-6989586621684537152"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Space
</span><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-var">Space</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;local&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684537156"><span class="hs-identifier hs-var">local_subhistos</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-343"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684537151"><span class="annot"><span class="annottext">Locking
</span><a href="#local-6989586621684537151"><span class="hs-identifier hs-var">l'</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#AtomicLocking"><span class="hs-identifier hs-type">AtomicLocking</span></a></span><span> </span><span id="local-6989586621684537150"><span class="annot"><span class="annottext">Locking -&gt; DoAtomicUpdate GPUMem KernelEnv
</span><a href="#local-6989586621684537150"><span class="hs-identifier hs-var">f</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Maybe Locking, [TExp Int64] -&gt; InKernelGen ())
-&gt; ImpM
     GPUMem
     KernelEnv
     KernelOp
     (Maybe Locking, [TExp Int64] -&gt; InKernelGen ())
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe Locking
</span><a href="#local-6989586621684537160"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Locking -&gt; DoAtomicUpdate GPUMem KernelEnv
</span><a href="#local-6989586621684537150"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Locking
</span><a href="#local-6989586621684537151"><span class="hs-identifier hs-var">l'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Space
</span><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-var">Space</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;local&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684537156"><span class="hs-identifier hs-var">local_subhistos</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-344"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe Locking
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#AtomicLocking"><span class="hs-identifier hs-type">AtomicLocking</span></a></span><span> </span><span id="local-6989586621684537149"><span class="annot"><span class="annottext">Locking -&gt; DoAtomicUpdate GPUMem KernelEnv
</span><a href="#local-6989586621684537149"><span class="hs-identifier hs-var">f</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-345"></span><span>          </span><span id="local-6989586621684537148"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684537148"><span class="hs-identifier hs-var">locks</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; ImpM GPUMem KernelEnv KernelOp VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; String -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;locks&quot;</span></span><span>
</span><span id="line-346"></span><span>
</span><span id="line-347"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684537146"><span class="annot"><span class="annottext">num_locks :: TExp Int64
</span><a href="#local-6989586621684537146"><span class="hs-identifier hs-var hs-var">num_locks</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64) -&gt; SubExp -&gt; TExp Int64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Count GroupSize SubExp -&gt; SubExp
forall u e. Count u e -&gt; e
</span><a href="Futhark.IR.GPU.Sizes.html#unCount"><span class="hs-identifier hs-var hs-var">unCount</span></a></span><span> </span><span class="annot"><span class="annottext">Count GroupSize SubExp
</span><a href="#local-6989586621684537162"><span class="hs-identifier hs-var">group_size</span></a></span><span>
</span><span id="line-348"></span><span>              </span><span id="local-6989586621684537144"><span class="annot"><span class="annottext">dims :: [TExp Int64]
</span><a href="#local-6989586621684537144"><span class="hs-identifier hs-var hs-var">dims</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [TExp Int64]) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Shape -&gt; [SubExp]
forall d. ShapeBase d -&gt; [d]
</span><a href="Futhark.IR.Syntax.Core.html#shapeDims"><span class="hs-identifier hs-var hs-var">shapeDims</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HistOp GPUMem -&gt; Shape
forall rep. HistOp rep -&gt; Shape
</span><a href="Futhark.IR.SegOp.html#histOpShape"><span class="hs-identifier hs-var hs-var">histOpShape</span></a></span><span> </span><span class="annot"><span class="annottext">HistOp GPUMem
</span><a href="#local-6989586621684537159"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="annot"><span class="annottext">Shape -&gt; Shape -&gt; Shape
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">HistOp GPUMem -&gt; Shape
forall rep. HistOp rep -&gt; Shape
</span><a href="Futhark.IR.SegOp.html#histShape"><span class="hs-identifier hs-var hs-var">histShape</span></a></span><span> </span><span class="annot"><span class="annottext">HistOp GPUMem
</span><a href="#local-6989586621684537159"><span class="hs-identifier hs-var">op</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-349"></span><span>              </span><span id="local-6989586621684537141"><span class="annot"><span class="annottext">l' :: Locking
</span><a href="#local-6989586621684537141"><span class="hs-identifier hs-var hs-var">l'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName
-&gt; TExp Int32
-&gt; TExp Int32
-&gt; TExp Int32
-&gt; ([TExp Int64] -&gt; [TExp Int64])
-&gt; Locking
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#Locking"><span class="hs-identifier hs-var">Locking</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684537148"><span class="hs-identifier hs-var">locks</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">0</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int64 -&gt; [TExp Int64]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; [TExp Int64])
-&gt; ([TExp Int64] -&gt; TExp Int64) -&gt; [TExp Int64] -&gt; [TExp Int64]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall e. IntegralExp e =&gt; e -&gt; e -&gt; e
</span><a href="Futhark.Util.IntegralExp.html#rem"><span class="hs-operator hs-var">`rem`</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684537146"><span class="hs-identifier hs-var">num_locks</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; TExp Int64)
-&gt; ([TExp Int64] -&gt; TExp Int64) -&gt; [TExp Int64] -&gt; TExp Int64
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; [TExp Int64] -&gt; TExp Int64
forall num. IntegralExp num =&gt; [num] -&gt; [num] -&gt; num
</span><a href="Futhark.IR.Prop.Reshape.html#flattenIndex"><span class="hs-identifier hs-var">flattenIndex</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684537144"><span class="hs-identifier hs-var">dims</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-350"></span><span>              </span><span id="local-6989586621684537140"><span class="annot"><span class="annottext">locks_t :: TypeBase Shape NoUniqueness
</span><a href="#local-6989586621684537140"><span class="hs-identifier hs-var hs-var">locks_t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; Shape -&gt; NoUniqueness -&gt; TypeBase Shape NoUniqueness
forall shape u. PrimType -&gt; shape -&gt; u -&gt; TypeBase shape u
</span><a href="Futhark.IR.Syntax.Core.html#Array"><span class="hs-identifier hs-var">Array</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int32"><span class="hs-identifier hs-var">int32</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Shape
forall d. [d] -&gt; ShapeBase d
</span><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-var">Shape</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Count GroupSize SubExp -&gt; SubExp
forall u e. Count u e -&gt; e
</span><a href="Futhark.IR.GPU.Sizes.html#unCount"><span class="hs-identifier hs-var hs-var">unCount</span></a></span><span> </span><span class="annot"><span class="annottext">Count GroupSize SubExp
</span><a href="#local-6989586621684537162"><span class="hs-identifier hs-var">group_size</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">NoUniqueness
</span><a href="Futhark.IR.Syntax.Core.html#NoUniqueness"><span class="hs-identifier hs-var">NoUniqueness</span></a></span><span>
</span><span id="line-351"></span><span>
</span><span id="line-352"></span><span>          </span><span id="local-6989586621684537135"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684537135"><span class="hs-identifier hs-var">locks_mem</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String
-&gt; Count Bytes (TExp Int64)
-&gt; Space
-&gt; ImpM GPUMem KernelEnv KernelOp VName
forall rep r op.
String -&gt; Count Bytes (TExp Int64) -&gt; Space -&gt; ImpM rep r op VName
</span><a href="Futhark.CodeGen.ImpGen.html#sAlloc"><span class="hs-identifier hs-var">sAlloc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;locks_mem&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness -&gt; Count Bytes (TExp Int64)
</span><a href="Futhark.CodeGen.ImpGen.html#typeSize"><span class="hs-identifier hs-var">typeSize</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness
</span><a href="#local-6989586621684537140"><span class="hs-identifier hs-var">locks_t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Space -&gt; ImpM GPUMem KernelEnv KernelOp VName)
-&gt; Space -&gt; ImpM GPUMem KernelEnv KernelOp VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Space
</span><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-var">Space</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;local&quot;</span></span><span>
</span><span id="line-353"></span><span>          </span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; Shape -&gt; VName -&gt; IxFun -&gt; InKernelGen ()
forall rep r op.
VName -&gt; PrimType -&gt; Shape -&gt; VName -&gt; IxFun -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dArray"><span class="hs-identifier hs-var">dArray</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684537148"><span class="hs-identifier hs-var">locks</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int32"><span class="hs-identifier hs-var">int32</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness -&gt; Shape
forall shape u. ArrayShape shape =&gt; TypeBase shape u -&gt; shape
</span><a href="Futhark.IR.Prop.Types.html#arrayShape"><span class="hs-identifier hs-var">arrayShape</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness
</span><a href="#local-6989586621684537140"><span class="hs-identifier hs-var">locks_t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684537135"><span class="hs-identifier hs-var">locks_mem</span></a></span><span> </span><span class="annot"><span class="annottext">(IxFun -&gt; InKernelGen ()) -&gt; IxFun -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-354"></span><span>            </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; IxFun
forall num. IntegralExp num =&gt; Shape num -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#iota"><span class="hs-identifier hs-var">IxFun.iota</span></a></span><span> </span><span class="annot"><span class="annottext">([TExp Int64] -&gt; IxFun) -&gt; [TExp Int64] -&gt; IxFun
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
</span><a href="Futhark.Analysis.PrimExp.Convert.html#pe64"><span class="hs-identifier hs-var">pe64</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [TExp Int64]) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness -&gt; [SubExp]
forall u. TypeBase Shape u -&gt; [SubExp]
</span><a href="Futhark.IR.Prop.Types.html#arrayDims"><span class="hs-identifier hs-var">arrayDims</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness
</span><a href="#local-6989586621684537140"><span class="hs-identifier hs-var">locks_t</span></a></span><span>
</span><span id="line-355"></span><span>
</span><span id="line-356"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;All locks start out unlocked&quot;</span></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-357"></span><span>            </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; ([TExp Int64] -&gt; InKernelGen ()) -&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#groupCoverSpace"><span class="hs-identifier hs-var">groupCoverSpace</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelGroupSize"><span class="hs-identifier hs-var hs-var">kernelGroupSize</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684537158"><span class="hs-identifier hs-var">constants</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(([TExp Int64] -&gt; InKernelGen ()) -&gt; InKernelGen ())
-&gt; ([TExp Int64] -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684537128"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684537128"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-358"></span><span>              </span><span class="annot"><span class="annottext">VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; InKernelGen ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684537148"><span class="hs-identifier hs-var">locks</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684537128"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Integer -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#intConst"><span class="hs-identifier hs-var">intConst</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int32"><span class="hs-identifier hs-var">Int32</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-359"></span><span>
</span><span id="line-360"></span><span>          </span><span class="annot"><span class="annottext">(Maybe Locking, [TExp Int64] -&gt; InKernelGen ())
-&gt; ImpM
     GPUMem
     KernelEnv
     KernelOp
     (Maybe Locking, [TExp Int64] -&gt; InKernelGen ())
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Locking -&gt; Maybe Locking
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Locking
</span><a href="#local-6989586621684537141"><span class="hs-identifier hs-var">l'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Locking -&gt; DoAtomicUpdate GPUMem KernelEnv
</span><a href="#local-6989586621684537149"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Locking
</span><a href="#local-6989586621684537141"><span class="hs-identifier hs-var">l'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Space
</span><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-var">Space</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;local&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684537156"><span class="hs-identifier hs-var">local_subhistos</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-361"></span><span>
</span><span id="line-362"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#whenActive"><span class="hs-identifier hs-type">whenActive</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SegLevel"><span class="hs-identifier hs-type">SegLevel</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegSpace"><span class="hs-identifier hs-type">SegSpace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#InKernelGen"><span class="hs-identifier hs-type">InKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#InKernelGen"><span class="hs-identifier hs-type">InKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-363"></span><span id="whenActive"><span class="annot"><span class="annottext">whenActive :: SegLevel -&gt; SegSpace -&gt; InKernelGen () -&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#whenActive"><span class="hs-identifier hs-var hs-var">whenActive</span></a></span></span><span> </span><span id="local-6989586621684537124"><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684537124"><span class="hs-identifier hs-var">lvl</span></a></span></span><span> </span><span id="local-6989586621684537123"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684537123"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684537122"><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684537122"><span class="hs-identifier hs-var">m</span></a></span></span><span>
</span><span id="line-364"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">SegVirt
</span><a href="Futhark.IR.SegOp.html#SegNoVirtFull"><span class="hs-identifier hs-var">SegNoVirtFull</span></a></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SegLevel -&gt; SegVirt
</span><a href="Futhark.IR.GPU.Op.html#segVirt"><span class="hs-identifier hs-var hs-var">segVirt</span></a></span><span> </span><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684537124"><span class="hs-identifier hs-var">lvl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684537122"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-365"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-366"></span><span>    </span><span id="local-6989586621684537119"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684537119"><span class="hs-identifier hs-var">group_size</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelGroupSize"><span class="hs-identifier hs-var hs-var">kernelGroupSize</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelConstants -&gt; TExp Int64)
-&gt; (KernelEnv -&gt; KernelConstants) -&gt; KernelEnv -&gt; TExp Int64
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">KernelEnv -&gt; KernelConstants
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelConstants"><span class="hs-identifier hs-var hs-var">kernelConstants</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelEnv -&gt; TExp Int64)
-&gt; ImpM GPUMem KernelEnv KernelOp KernelEnv
-&gt; ImpM GPUMem KernelEnv KernelOp (TExp Int64)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ImpM GPUMem KernelEnv KernelOp KernelEnv
forall rep r op. ImpM rep r op r
</span><a href="Futhark.CodeGen.ImpGen.html#askEnv"><span class="hs-identifier hs-var">askEnv</span></a></span><span>
</span><span id="line-367"></span><span>    </span><span class="hs-comment">-- XXX: the following check is too naive - we should also handle</span><span>
</span><span id="line-368"></span><span>    </span><span class="hs-comment">-- the multi-dimensional case.</span><span>
</span><span id="line-369"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684537119"><span class="hs-identifier hs-var">group_size</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; [TExp Int64] -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">((VName, SubExp) -&gt; TExp Int64)
-&gt; [(VName, SubExp)] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64)
-&gt; ((VName, SubExp) -&gt; SubExp) -&gt; (VName, SubExp) -&gt; TExp Int64
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(VName, SubExp) -&gt; SubExp
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegSpace -&gt; [(VName, SubExp)]
</span><a href="Futhark.IR.SegOp.html#unSegSpace"><span class="hs-identifier hs-var hs-var">unSegSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684537123"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-370"></span><span>      </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684537122"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-371"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">TExp Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(VName, SubExp)] -&gt; TExp Bool
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#isActive"><span class="hs-identifier hs-var">isActive</span></a></span><span> </span><span class="annot"><span class="annottext">([(VName, SubExp)] -&gt; TExp Bool) -&gt; [(VName, SubExp)] -&gt; TExp Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; [(VName, SubExp)]
</span><a href="Futhark.IR.SegOp.html#unSegSpace"><span class="hs-identifier hs-var hs-var">unSegSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684537123"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684537122"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-372"></span><span>
</span><span id="line-373"></span><span class="hs-comment">-- Which fence do we need to protect shared access to this memory space?</span><span>
</span><span id="line-374"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#fenceForSpace"><span class="hs-identifier hs-type">fenceForSpace</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.GPU.html#Fence"><span class="hs-identifier hs-type">Imp.Fence</span></a></span><span>
</span><span id="line-375"></span><span id="fenceForSpace"><span class="annot"><span class="annottext">fenceForSpace :: Space -&gt; Fence
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#fenceForSpace"><span class="hs-identifier hs-var hs-var">fenceForSpace</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;local&quot;</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Fence
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#FenceLocal"><span class="hs-identifier hs-var">Imp.FenceLocal</span></a></span><span>
</span><span id="line-376"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#fenceForSpace"><span class="hs-identifier hs-var">fenceForSpace</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Fence
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#FenceGlobal"><span class="hs-identifier hs-var">Imp.FenceGlobal</span></a></span><span>
</span><span id="line-377"></span><span>
</span><span id="line-378"></span><span class="hs-comment">-- If we are touching these arrays, which kind of fence do we need?</span><span>
</span><span id="line-379"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#fenceForArrays"><span class="hs-identifier hs-type">fenceForArrays</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#InKernelGen"><span class="hs-identifier hs-type">InKernelGen</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.GPU.html#Fence"><span class="hs-identifier hs-type">Imp.Fence</span></a></span><span>
</span><span id="line-380"></span><span id="fenceForArrays"><span class="annot"><span class="annottext">fenceForArrays :: [VName] -&gt; InKernelGen Fence
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#fenceForArrays"><span class="hs-identifier hs-var hs-var">fenceForArrays</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([Fence] -&gt; Fence)
-&gt; ImpM GPUMem KernelEnv KernelOp [Fence] -&gt; InKernelGen Fence
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Fence -&gt; Fence -&gt; Fence) -&gt; Fence -&gt; [Fence] -&gt; Fence
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span> </span><span class="annot"><span class="annottext">Fence -&gt; Fence -&gt; Fence
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">max</span></span><span> </span><span class="annot"><span class="annottext">Fence
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#FenceLocal"><span class="hs-identifier hs-var">Imp.FenceLocal</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp [Fence] -&gt; InKernelGen Fence)
-&gt; ([VName] -&gt; ImpM GPUMem KernelEnv KernelOp [Fence])
-&gt; [VName]
-&gt; InKernelGen Fence
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; InKernelGen Fence)
-&gt; [VName] -&gt; ImpM GPUMem KernelEnv KernelOp [Fence]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; InKernelGen Fence
forall {rep} {r} {op}. VName -&gt; ImpM rep r op Fence
</span><a href="#local-6989586621684537114"><span class="hs-identifier hs-var">need</span></a></span><span>
</span><span id="line-381"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-382"></span><span>    </span><span id="local-6989586621684537114"><span class="annot"><span class="annottext">need :: VName -&gt; ImpM rep r op Fence
</span><a href="#local-6989586621684537114"><span class="hs-identifier hs-var hs-var">need</span></a></span></span><span> </span><span id="local-6989586621684537111"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684537111"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-383"></span><span>      </span><span class="annot"><span class="annottext">(MemEntry -&gt; Fence)
-&gt; ImpM rep r op MemEntry -&gt; ImpM rep r op Fence
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Space -&gt; Fence
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#fenceForSpace"><span class="hs-identifier hs-var">fenceForSpace</span></a></span><span> </span><span class="annot"><span class="annottext">(Space -&gt; Fence) -&gt; (MemEntry -&gt; Space) -&gt; MemEntry -&gt; Fence
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">MemEntry -&gt; Space
</span><a href="Futhark.CodeGen.ImpGen.html#entryMemSpace"><span class="hs-identifier hs-var hs-var">entryMemSpace</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM rep r op MemEntry -&gt; ImpM rep r op Fence)
-&gt; (ArrayEntry -&gt; ImpM rep r op MemEntry)
-&gt; ArrayEntry
-&gt; ImpM rep r op Fence
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; ImpM rep r op MemEntry
forall rep r op. VName -&gt; ImpM rep r op MemEntry
</span><a href="Futhark.CodeGen.ImpGen.html#lookupMemory"><span class="hs-identifier hs-var">lookupMemory</span></a></span><span>
</span><span id="line-384"></span><span>        </span><span class="annot"><span class="annottext">(VName -&gt; ImpM rep r op MemEntry)
-&gt; (ArrayEntry -&gt; VName) -&gt; ArrayEntry -&gt; ImpM rep r op MemEntry
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">MemLoc -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#memLocName"><span class="hs-identifier hs-var hs-var">memLocName</span></a></span><span>
</span><span id="line-385"></span><span>        </span><span class="annot"><span class="annottext">(MemLoc -&gt; VName) -&gt; (ArrayEntry -&gt; MemLoc) -&gt; ArrayEntry -&gt; VName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ArrayEntry -&gt; MemLoc
</span><a href="Futhark.CodeGen.ImpGen.html#entryArrayLoc"><span class="hs-identifier hs-var hs-var">entryArrayLoc</span></a></span><span>
</span><span id="line-386"></span><span>        </span><span class="annot"><span class="annottext">(ArrayEntry -&gt; ImpM rep r op Fence)
-&gt; ImpM rep r op ArrayEntry -&gt; ImpM rep r op Fence
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; ImpM rep r op ArrayEntry
forall rep r op. VName -&gt; ImpM rep r op ArrayEntry
</span><a href="Futhark.CodeGen.ImpGen.html#lookupArray"><span class="hs-identifier hs-var">lookupArray</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684537111"><span class="hs-identifier hs-var">arr</span></a></span><span>
</span><span id="line-387"></span><span>
</span><span id="line-388"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileGroupOp"><span class="hs-identifier hs-type">compileGroupOp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#OpCompiler"><span class="hs-identifier hs-type">OpCompiler</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#KernelEnv"><span class="hs-identifier hs-type">KernelEnv</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.GPU.html#KernelOp"><span class="hs-identifier hs-type">Imp.KernelOp</span></a></span><span>
</span><span id="line-389"></span><span id="compileGroupOp"><span class="annot"><span class="annottext">compileGroupOp :: OpCompiler GPUMem KernelEnv KernelOp
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileGroupOp"><span class="hs-identifier hs-var hs-var">compileGroupOp</span></a></span></span><span> </span><span id="local-6989586621684537104"><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684537104"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#Alloc"><span class="hs-identifier hs-type">Alloc</span></a></span><span> </span><span id="local-6989586621684537102"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684537102"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span id="local-6989586621684537101"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684537101"><span class="hs-identifier hs-var">space</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-390"></span><span>  </span><span class="annot"><span class="annottext">Pat GPUMem -&gt; SubExp -&gt; Space -&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelAlloc"><span class="hs-identifier hs-var">kernelAlloc</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684537104"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684537102"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684537101"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-391"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileGroupOp"><span class="hs-identifier hs-var">compileGroupOp</span></a></span><span> </span><span id="local-6989586621684537100"><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684537100"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SizeOp"><span class="hs-identifier hs-type">SizeOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SplitSpace"><span class="hs-identifier hs-type">SplitSpace</span></a></span><span> </span><span id="local-6989586621684537097"><span class="annot"><span class="annottext">SplitOrdering
</span><a href="#local-6989586621684537097"><span class="hs-identifier hs-var">o</span></a></span></span><span> </span><span id="local-6989586621684537096"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684537096"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684537095"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684537095"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621684537094"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684537094"><span class="hs-identifier hs-var">elems_per_thread</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-392"></span><span>  </span><span class="annot"><span class="annottext">Pat GPUMem
-&gt; SplitOrdering -&gt; SubExp -&gt; SubExp -&gt; SubExp -&gt; InKernelGen ()
forall w i elems_per_thread rep r op.
(ToExp w, ToExp i, ToExp elems_per_thread) =&gt;
Pat GPUMem
-&gt; SplitOrdering -&gt; w -&gt; i -&gt; elems_per_thread -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#splitSpace"><span class="hs-identifier hs-var">splitSpace</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684537100"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">SplitOrdering
</span><a href="#local-6989586621684537097"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684537096"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684537095"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684537094"><span class="hs-identifier hs-var">elems_per_thread</span></a></span><span>
</span><span id="line-393"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileGroupOp"><span class="hs-identifier hs-var">compileGroupOp</span></a></span><span> </span><span id="local-6989586621684537093"><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684537093"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SegOp"><span class="hs-identifier hs-type">SegOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#SegMap"><span class="hs-identifier hs-type">SegMap</span></a></span><span> </span><span id="local-6989586621684537091"><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684537091"><span class="hs-identifier hs-var">lvl</span></a></span></span><span> </span><span id="local-6989586621684537090"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684537090"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span class="annot"><span class="annottext">[TypeBase Shape NoUniqueness]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684537089"><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684537089"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-394"></span><span>  </span><span class="annot"><span class="annottext">InKernelGen () -&gt; InKernelGen ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegLevel -&gt; SegSpace -&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileGroupSpace"><span class="hs-identifier hs-var">compileGroupSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684537091"><span class="hs-identifier hs-var">lvl</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684537090"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-395"></span><span>
</span><span id="line-396"></span><span>  </span><span class="annot"><span class="annottext">SegLevel -&gt; SegSpace -&gt; InKernelGen () -&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#whenActive"><span class="hs-identifier hs-var">whenActive</span></a></span><span> </span><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684537091"><span class="hs-identifier hs-var">lvl</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684537090"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; (InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen ()
-&gt; InKernelGen ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Operations GPUMem KernelEnv KernelOp
-&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op a.
Operations rep r op -&gt; ImpM rep r op a -&gt; ImpM rep r op a
</span><a href="Futhark.CodeGen.ImpGen.html#localOps"><span class="hs-identifier hs-var">localOps</span></a></span><span> </span><span class="annot"><span class="annottext">Operations GPUMem KernelEnv KernelOp
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#threadOperations"><span class="hs-identifier hs-var">threadOperations</span></a></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-397"></span><span>    </span><span class="annot"><span class="annottext">Names -&gt; Stms GPUMem -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op.
Names -&gt; Stms rep -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileStms"><span class="hs-identifier hs-var">compileStms</span></a></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelBody GPUMem -&gt; Stms GPUMem
forall rep. KernelBody rep -&gt; Stms rep
</span><a href="Futhark.IR.SegOp.html#kernelBodyStms"><span class="hs-identifier hs-var hs-var">kernelBodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684537089"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-398"></span><span>      </span><span class="annot"><span class="annottext">(PatElemT LParamMem -&gt; KernelResult -&gt; InKernelGen ())
-&gt; [PatElemT LParamMem] -&gt; [KernelResult] -&gt; InKernelGen ()
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m ()
</span><span class="hs-identifier hs-var">zipWithM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegSpace
-&gt; PatElemT (LetDec GPUMem) -&gt; KernelResult -&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileThreadResult"><span class="hs-identifier hs-var">compileThreadResult</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684537090"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatT LParamMem -&gt; [PatElemT LParamMem]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem
PatT LParamMem
</span><a href="#local-6989586621684537093"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([KernelResult] -&gt; InKernelGen ())
-&gt; [KernelResult] -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-399"></span><span>        </span><span class="annot"><span class="annottext">KernelBody GPUMem -&gt; [KernelResult]
forall rep. KernelBody rep -&gt; [KernelResult]
</span><a href="Futhark.IR.SegOp.html#kernelBodyResult"><span class="hs-identifier hs-var hs-var">kernelBodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684537089"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-400"></span><span>
</span><span id="line-401"></span><span>  </span><span class="annot"><span class="annottext">KernelOp -&gt; InKernelGen ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelOp -&gt; InKernelGen ()) -&gt; KernelOp -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Fence -&gt; KernelOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#ErrorSync"><span class="hs-identifier hs-var">Imp.ErrorSync</span></a></span><span> </span><span class="annot"><span class="annottext">Fence
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#FenceLocal"><span class="hs-identifier hs-var">Imp.FenceLocal</span></a></span><span>
</span><span id="line-402"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileGroupOp"><span class="hs-identifier hs-var">compileGroupOp</span></a></span><span> </span><span id="local-6989586621684537082"><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684537082"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SegOp"><span class="hs-identifier hs-type">SegOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#SegScan"><span class="hs-identifier hs-type">SegScan</span></a></span><span> </span><span id="local-6989586621684537080"><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684537080"><span class="hs-identifier hs-var">lvl</span></a></span></span><span> </span><span id="local-6989586621684537079"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684537079"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684537078"><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684537078"><span class="hs-identifier hs-var">scans</span></a></span></span><span> </span><span class="annot"><span class="annottext">[TypeBase Shape NoUniqueness]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684537077"><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684537077"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-403"></span><span>  </span><span class="annot"><span class="annottext">SegLevel -&gt; SegSpace -&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileGroupSpace"><span class="hs-identifier hs-var">compileGroupSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684537080"><span class="hs-identifier hs-var">lvl</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684537079"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-404"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684537076"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684537076"><span class="hs-identifier hs-var">ltids</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684537075"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684537075"><span class="hs-identifier hs-var">dims</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VName, SubExp)] -&gt; ([VName], [SubExp])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(VName, SubExp)] -&gt; ([VName], [SubExp]))
-&gt; [(VName, SubExp)] -&gt; ([VName], [SubExp])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; [(VName, SubExp)]
</span><a href="Futhark.IR.SegOp.html#unSegSpace"><span class="hs-identifier hs-var hs-var">unSegSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684537079"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-405"></span><span>      </span><span id="local-6989586621684537074"><span class="annot"><span class="annottext">dims' :: [TExp Int64]
</span><a href="#local-6989586621684537074"><span class="hs-identifier hs-var hs-var">dims'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684537075"><span class="hs-identifier hs-var">dims</span></a></span><span>
</span><span id="line-406"></span><span>
</span><span id="line-407"></span><span>  </span><span class="annot"><span class="annottext">SegLevel -&gt; SegSpace -&gt; InKernelGen () -&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#whenActive"><span class="hs-identifier hs-var">whenActive</span></a></span><span> </span><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684537080"><span class="hs-identifier hs-var">lvl</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684537079"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; (InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen ()
-&gt; InKernelGen ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Operations GPUMem KernelEnv KernelOp
-&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op a.
Operations rep r op -&gt; ImpM rep r op a -&gt; ImpM rep r op a
</span><a href="Futhark.CodeGen.ImpGen.html#localOps"><span class="hs-identifier hs-var">localOps</span></a></span><span> </span><span class="annot"><span class="annottext">Operations GPUMem KernelEnv KernelOp
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#threadOperations"><span class="hs-identifier hs-var">threadOperations</span></a></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-408"></span><span>    </span><span class="annot"><span class="annottext">Names -&gt; Stms GPUMem -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op.
Names -&gt; Stms rep -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileStms"><span class="hs-identifier hs-var">compileStms</span></a></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelBody GPUMem -&gt; Stms GPUMem
forall rep. KernelBody rep -&gt; Stms rep
</span><a href="Futhark.IR.SegOp.html#kernelBodyStms"><span class="hs-identifier hs-var hs-var">kernelBodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684537077"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-409"></span><span>      </span><span class="annot"><span class="annottext">[(VName, KernelResult)]
-&gt; ((VName, KernelResult) -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; [KernelResult] -&gt; [(VName, KernelResult)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatT LParamMem -&gt; [VName]
forall dec. PatT dec -&gt; [VName]
</span><a href="Futhark.IR.Prop.Patterns.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem
PatT LParamMem
</span><a href="#local-6989586621684537082"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([KernelResult] -&gt; [(VName, KernelResult)])
-&gt; [KernelResult] -&gt; [(VName, KernelResult)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem -&gt; [KernelResult]
forall rep. KernelBody rep -&gt; [KernelResult]
</span><a href="Futhark.IR.SegOp.html#kernelBodyResult"><span class="hs-identifier hs-var hs-var">kernelBodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684537077"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((VName, KernelResult) -&gt; InKernelGen ()) -&gt; InKernelGen ())
-&gt; ((VName, KernelResult) -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684537072"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684537072"><span class="hs-identifier hs-var">dest</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684537071"><span class="annot"><span class="annottext">KernelResult
</span><a href="#local-6989586621684537071"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-410"></span><span>        </span><span class="annot"><span class="annottext">VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; InKernelGen ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span>
</span><span id="line-411"></span><span>          </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684537072"><span class="hs-identifier hs-var">dest</span></a></span><span>
</span><span id="line-412"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(VName -&gt; TExp Int64) -&gt; [VName] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TExp Int64
forall a. a -&gt; TPrimExp Int64 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le64"><span class="hs-identifier hs-var">Imp.le64</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684537076"><span class="hs-identifier hs-var">ltids</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-413"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelResult -&gt; SubExp
</span><a href="Futhark.IR.SegOp.html#kernelResultSubExp"><span class="hs-identifier hs-var">kernelResultSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">KernelResult
</span><a href="#local-6989586621684537071"><span class="hs-identifier hs-var">res</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-414"></span><span>          </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-415"></span><span>
</span><span id="line-416"></span><span>  </span><span id="local-6989586621684537068"><span class="annot"><span class="annottext">Fence
</span><a href="#local-6989586621684537068"><span class="hs-identifier hs-var">fence</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; InKernelGen Fence
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#fenceForArrays"><span class="hs-identifier hs-var">fenceForArrays</span></a></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; InKernelGen Fence) -&gt; [VName] -&gt; InKernelGen Fence
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatT LParamMem -&gt; [VName]
forall dec. PatT dec -&gt; [VName]
</span><a href="Futhark.IR.Prop.Patterns.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem
PatT LParamMem
</span><a href="#local-6989586621684537082"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-417"></span><span>  </span><span class="annot"><span class="annottext">KernelOp -&gt; InKernelGen ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelOp -&gt; InKernelGen ()) -&gt; KernelOp -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Fence -&gt; KernelOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#ErrorSync"><span class="hs-identifier hs-var">Imp.ErrorSync</span></a></span><span> </span><span class="annot"><span class="annottext">Fence
</span><a href="#local-6989586621684537068"><span class="hs-identifier hs-var">fence</span></a></span><span>
</span><span id="line-418"></span><span>
</span><span id="line-419"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684537067"><span class="annot"><span class="annottext">segment_size :: TExp Int64
</span><a href="#local-6989586621684537067"><span class="hs-identifier hs-var hs-var">segment_size</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; TExp Int64
forall a. [a] -&gt; a
</span><span class="hs-identifier hs-var">last</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684537074"><span class="hs-identifier hs-var">dims'</span></a></span><span>
</span><span id="line-420"></span><span>      </span><span id="local-6989586621684537065"><span class="annot"><span class="annottext">crossesSegment :: TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool
</span><a href="#local-6989586621684537065"><span class="hs-identifier hs-var hs-var">crossesSegment</span></a></span></span><span> </span><span id="local-6989586621684537064"><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684537064"><span class="hs-identifier hs-var">from</span></a></span></span><span> </span><span id="local-6989586621684537063"><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684537063"><span class="hs-identifier hs-var">to</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-421"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int64
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684537063"><span class="hs-identifier hs-var">to</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int64
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684537064"><span class="hs-identifier hs-var">from</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Bool
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3E."><span class="hs-operator hs-var">.&gt;.</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int64
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684537063"><span class="hs-identifier hs-var">to</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall e. IntegralExp e =&gt; e -&gt; e -&gt; e
</span><a href="Futhark.Util.IntegralExp.html#rem"><span class="hs-operator hs-var">`rem`</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684537067"><span class="hs-identifier hs-var">segment_size</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-422"></span><span>
</span><span id="line-423"></span><span>  </span><span class="hs-comment">-- groupScan needs to treat the scan output as a one-dimensional</span><span>
</span><span id="line-424"></span><span>  </span><span class="hs-comment">-- array of scan elements, so we invent some new flattened arrays</span><span>
</span><span id="line-425"></span><span>  </span><span class="hs-comment">-- here.</span><span>
</span><span id="line-426"></span><span>  </span><span id="local-6989586621684537061"><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684537061"><span class="hs-identifier hs-var">dims_flat</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; TExp Int64 -&gt; ImpM GPUMem KernelEnv KernelOp (TV Int64)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV"><span class="hs-identifier hs-var">dPrimV</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;dims_flat&quot;</span></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; ImpM GPUMem KernelEnv KernelOp (TV Int64))
-&gt; TExp Int64 -&gt; ImpM GPUMem KernelEnv KernelOp (TV Int64)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; TExp Int64
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">product</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684537074"><span class="hs-identifier hs-var">dims'</span></a></span><span>
</span><span id="line-427"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684537060"><span class="annot"><span class="annottext">flattened :: PatElemT LParamMem -&gt; ImpM GPUMem KernelEnv KernelOp VName
</span><a href="#local-6989586621684537060"><span class="hs-identifier hs-var hs-var">flattened</span></a></span></span><span> </span><span id="local-6989586621684537059"><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684537059"><span class="hs-identifier hs-var">pe</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-428"></span><span>        </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemLoc"><span class="hs-identifier hs-type">MemLoc</span></a></span><span> </span><span id="local-6989586621684537057"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684537057"><span class="hs-identifier hs-var">mem</span></a></span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684537056"><span class="annot"><span class="annottext">IxFun
</span><a href="#local-6989586621684537056"><span class="hs-identifier hs-var">ixfun</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-429"></span><span>          </span><span class="annot"><span class="annottext">ArrayEntry -&gt; MemLoc
</span><a href="Futhark.CodeGen.ImpGen.html#entryArrayLoc"><span class="hs-identifier hs-var hs-var">entryArrayLoc</span></a></span><span> </span><span class="annot"><span class="annottext">(ArrayEntry -&gt; MemLoc)
-&gt; ImpM GPUMem KernelEnv KernelOp ArrayEntry
-&gt; ImpM GPUMem KernelEnv KernelOp MemLoc
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; ImpM GPUMem KernelEnv KernelOp ArrayEntry
forall rep r op. VName -&gt; ImpM rep r op ArrayEntry
</span><a href="Futhark.CodeGen.ImpGen.html#lookupArray"><span class="hs-identifier hs-var">lookupArray</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684537059"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-430"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684537055"><span class="annot"><span class="annottext">pe_t :: TypeBase Shape NoUniqueness
</span><a href="#local-6989586621684537055"><span class="hs-identifier hs-var hs-var">pe_t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; TypeBase Shape NoUniqueness
forall t. Typed t =&gt; t -&gt; TypeBase Shape NoUniqueness
</span><a href="Futhark.IR.Prop.Types.html#typeOf"><span class="hs-identifier hs-var">typeOf</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684537059"><span class="hs-identifier hs-var">pe</span></a></span><span>
</span><span id="line-431"></span><span>            </span><span id="local-6989586621684537053"><span class="annot"><span class="annottext">arr_dims :: [SubExp]
</span><a href="#local-6989586621684537053"><span class="hs-identifier hs-var hs-var">arr_dims</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int64 -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684537061"><span class="hs-identifier hs-var">dims_flat</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; [SubExp] -&gt; [SubExp]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [SubExp] -&gt; [SubExp]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TExp Int64] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684537074"><span class="hs-identifier hs-var">dims'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness -&gt; [SubExp]
forall u. TypeBase Shape u -&gt; [SubExp]
</span><a href="Futhark.IR.Prop.Types.html#arrayDims"><span class="hs-identifier hs-var">arrayDims</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness
</span><a href="#local-6989586621684537055"><span class="hs-identifier hs-var">pe_t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-432"></span><span>        </span><span class="annot"><span class="annottext">String
-&gt; PrimType
-&gt; Shape
-&gt; VName
-&gt; IxFun
-&gt; ImpM GPUMem KernelEnv KernelOp VName
forall rep r op.
String
-&gt; PrimType -&gt; Shape -&gt; VName -&gt; IxFun -&gt; ImpM rep r op VName
</span><a href="Futhark.CodeGen.ImpGen.html#sArray"><span class="hs-identifier hs-var">sArray</span></a></span><span>
</span><span id="line-433"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; String
</span><a href="Language.Futhark.Core.html#baseString"><span class="hs-identifier hs-var">baseString</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684537059"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_flat&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-434"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness -&gt; PrimType
forall shape u. TypeBase shape u -&gt; PrimType
</span><a href="Futhark.IR.Prop.Types.html#elemType"><span class="hs-identifier hs-var">elemType</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness
</span><a href="#local-6989586621684537055"><span class="hs-identifier hs-var">pe_t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-435"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Shape
forall d. [d] -&gt; ShapeBase d
</span><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-var">Shape</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684537053"><span class="hs-identifier hs-var">arr_dims</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-436"></span><span>          </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684537057"><span class="hs-identifier hs-var">mem</span></a></span><span>
</span><span id="line-437"></span><span>          </span><span class="annot"><span class="annottext">(IxFun -&gt; ImpM GPUMem KernelEnv KernelOp VName)
-&gt; IxFun -&gt; ImpM GPUMem KernelEnv KernelOp VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IxFun -&gt; ShapeChange (TExp Int64) -&gt; IxFun
forall num.
(Eq num, IntegralExp num) =&gt;
IxFun num -&gt; ShapeChange num -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#reshape"><span class="hs-identifier hs-var">IxFun.reshape</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun
</span><a href="#local-6989586621684537056"><span class="hs-identifier hs-var">ixfun</span></a></span><span> </span><span class="annot"><span class="annottext">(ShapeChange (TExp Int64) -&gt; IxFun)
-&gt; ShapeChange (TExp Int64) -&gt; IxFun
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; DimChange (TExp Int64))
-&gt; [SubExp] -&gt; ShapeChange (TExp Int64)
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int64 -&gt; DimChange (TExp Int64)
forall d. d -&gt; DimChange d
</span><a href="Futhark.IR.Syntax.html#DimNew"><span class="hs-identifier hs-var">DimNew</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; DimChange (TExp Int64))
-&gt; (SubExp -&gt; TExp Int64) -&gt; SubExp -&gt; DimChange (TExp Int64)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
</span><a href="Futhark.Analysis.PrimExp.Convert.html#pe64"><span class="hs-identifier hs-var">pe64</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684537053"><span class="hs-identifier hs-var">arr_dims</span></a></span><span>
</span><span id="line-438"></span><span>
</span><span id="line-439"></span><span>      </span><span id="local-6989586621684537047"><span class="annot"><span class="annottext">num_scan_results :: Int
</span><a href="#local-6989586621684537047"><span class="hs-identifier hs-var hs-var">num_scan_results</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; Int
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">sum</span></span><span> </span><span class="annot"><span class="annottext">([Int] -&gt; Int) -&gt; [Int] -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SegBinOp GPUMem -&gt; Int) -&gt; [SegBinOp GPUMem] -&gt; [Int]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; Int)
-&gt; (SegBinOp GPUMem -&gt; [SubExp]) -&gt; SegBinOp GPUMem -&gt; Int
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SegBinOp GPUMem -&gt; [SubExp]
forall rep. SegBinOp rep -&gt; [SubExp]
</span><a href="Futhark.IR.SegOp.html#segBinOpNeutral"><span class="hs-identifier hs-var hs-var">segBinOpNeutral</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684537078"><span class="hs-identifier hs-var">scans</span></a></span><span>
</span><span id="line-440"></span><span>
</span><span id="line-441"></span><span>  </span><span id="local-6989586621684537044"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684537044"><span class="hs-identifier hs-var">arrs_flat</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(PatElemT LParamMem -&gt; ImpM GPUMem KernelEnv KernelOp VName)
-&gt; [PatElemT LParamMem] -&gt; ImpM GPUMem KernelEnv KernelOp [VName]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; ImpM GPUMem KernelEnv KernelOp VName
</span><a href="#local-6989586621684537060"><span class="hs-identifier hs-var">flattened</span></a></span><span> </span><span class="annot"><span class="annottext">([PatElemT LParamMem] -&gt; ImpM GPUMem KernelEnv KernelOp [VName])
-&gt; [PatElemT LParamMem] -&gt; ImpM GPUMem KernelEnv KernelOp [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [PatElemT LParamMem] -&gt; [PatElemT LParamMem]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">take</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684537047"><span class="hs-identifier hs-var">num_scan_results</span></a></span><span> </span><span class="annot"><span class="annottext">([PatElemT LParamMem] -&gt; [PatElemT LParamMem])
-&gt; [PatElemT LParamMem] -&gt; [PatElemT LParamMem]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatT LParamMem -&gt; [PatElemT LParamMem]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem
PatT LParamMem
</span><a href="#local-6989586621684537082"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-442"></span><span>
</span><span id="line-443"></span><span>  </span><span class="annot"><span class="annottext">[SegBinOp GPUMem]
-&gt; (SegBinOp GPUMem -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684537078"><span class="hs-identifier hs-var">scans</span></a></span><span> </span><span class="annot"><span class="annottext">((SegBinOp GPUMem -&gt; InKernelGen ()) -&gt; InKernelGen ())
-&gt; (SegBinOp GPUMem -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684537042"><span class="annot"><span class="annottext">SegBinOp GPUMem
</span><a href="#local-6989586621684537042"><span class="hs-identifier hs-var">scan</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-444"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684537041"><span class="annot"><span class="annottext">scan_op :: Lambda GPUMem
</span><a href="#local-6989586621684537041"><span class="hs-identifier hs-var hs-var">scan_op</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SegBinOp GPUMem -&gt; Lambda GPUMem
forall rep. SegBinOp rep -&gt; Lambda rep
</span><a href="Futhark.IR.SegOp.html#segBinOpLambda"><span class="hs-identifier hs-var hs-var">segBinOpLambda</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp GPUMem
</span><a href="#local-6989586621684537042"><span class="hs-identifier hs-var">scan</span></a></span><span>
</span><span id="line-445"></span><span>    </span><span class="annot"><span class="annottext">Maybe (TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool)
-&gt; TExp Int64
-&gt; TExp Int64
-&gt; Lambda GPUMem
-&gt; [VName]
-&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#groupScan"><span class="hs-identifier hs-var">groupScan</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool)
-&gt; Maybe (TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool
</span><a href="#local-6989586621684537065"><span class="hs-identifier hs-var">crossesSegment</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TExp Int64] -&gt; TExp Int64
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">product</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684537074"><span class="hs-identifier hs-var">dims'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TExp Int64] -&gt; TExp Int64
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">product</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684537074"><span class="hs-identifier hs-var">dims'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684537041"><span class="hs-identifier hs-var">scan_op</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684537044"><span class="hs-identifier hs-var">arrs_flat</span></a></span><span>
</span><span id="line-446"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileGroupOp"><span class="hs-identifier hs-var">compileGroupOp</span></a></span><span> </span><span id="local-6989586621684537039"><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684537039"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SegOp"><span class="hs-identifier hs-type">SegOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#SegRed"><span class="hs-identifier hs-type">SegRed</span></a></span><span> </span><span id="local-6989586621684537037"><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684537037"><span class="hs-identifier hs-var">lvl</span></a></span></span><span> </span><span id="local-6989586621684537036"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684537036"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684537035"><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684537035"><span class="hs-identifier hs-var">ops</span></a></span></span><span> </span><span class="annot"><span class="annottext">[TypeBase Shape NoUniqueness]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684537034"><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684537034"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-447"></span><span>  </span><span class="annot"><span class="annottext">SegLevel -&gt; SegSpace -&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileGroupSpace"><span class="hs-identifier hs-var">compileGroupSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684537037"><span class="hs-identifier hs-var">lvl</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684537036"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-448"></span><span>
</span><span id="line-449"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684537033"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684537033"><span class="hs-identifier hs-var">ltids</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684537032"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684537032"><span class="hs-identifier hs-var">dims</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VName, SubExp)] -&gt; ([VName], [SubExp])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(VName, SubExp)] -&gt; ([VName], [SubExp]))
-&gt; [(VName, SubExp)] -&gt; ([VName], [SubExp])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; [(VName, SubExp)]
</span><a href="Futhark.IR.SegOp.html#unSegSpace"><span class="hs-identifier hs-var hs-var">unSegSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684537036"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-450"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684537031"><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684537031"><span class="hs-identifier hs-var">red_pes</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684537030"><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684537030"><span class="hs-identifier hs-var">map_pes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-451"></span><span>        </span><span class="annot"><span class="annottext">Int
-&gt; [PatElemT LParamMem]
-&gt; ([PatElemT LParamMem], [PatElemT LParamMem])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SegBinOp GPUMem] -&gt; Int
forall rep. [SegBinOp rep] -&gt; Int
</span><a href="Futhark.IR.SegOp.html#segBinOpResults"><span class="hs-identifier hs-var">segBinOpResults</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684537035"><span class="hs-identifier hs-var">ops</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([PatElemT LParamMem]
 -&gt; ([PatElemT LParamMem], [PatElemT LParamMem]))
-&gt; [PatElemT LParamMem]
-&gt; ([PatElemT LParamMem], [PatElemT LParamMem])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatT LParamMem -&gt; [PatElemT LParamMem]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem
PatT LParamMem
</span><a href="#local-6989586621684537039"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-452"></span><span>
</span><span id="line-453"></span><span>      </span><span id="local-6989586621684537028"><span class="annot"><span class="annottext">dims' :: [TExp Int64]
</span><a href="#local-6989586621684537028"><span class="hs-identifier hs-var hs-var">dims'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684537032"><span class="hs-identifier hs-var">dims</span></a></span><span>
</span><span id="line-454"></span><span>
</span><span id="line-455"></span><span>      </span><span id="local-6989586621684537027"><span class="annot"><span class="annottext">mkTempArr :: TypeBase Shape NoUniqueness -&gt; ImpM GPUMem KernelEnv KernelOp VName
</span><a href="#local-6989586621684537027"><span class="hs-identifier hs-var hs-var">mkTempArr</span></a></span></span><span> </span><span id="local-6989586621684537026"><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness
</span><a href="#local-6989586621684537026"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-456"></span><span>        </span><span class="annot"><span class="annottext">String
-&gt; PrimType
-&gt; Shape
-&gt; Space
-&gt; ImpM GPUMem KernelEnv KernelOp VName
forall rep r op.
String -&gt; PrimType -&gt; Shape -&gt; Space -&gt; ImpM rep r op VName
</span><a href="Futhark.CodeGen.ImpGen.html#sAllocArray"><span class="hs-identifier hs-var">sAllocArray</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;red_arr&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness -&gt; PrimType
forall shape u. TypeBase shape u -&gt; PrimType
</span><a href="Futhark.IR.Prop.Types.html#elemType"><span class="hs-identifier hs-var">elemType</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness
</span><a href="#local-6989586621684537026"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Shape
forall d. [d] -&gt; ShapeBase d
</span><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-var">Shape</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684537032"><span class="hs-identifier hs-var">dims</span></a></span><span> </span><span class="annot"><span class="annottext">Shape -&gt; Shape -&gt; Shape
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness -&gt; Shape
forall shape u. ArrayShape shape =&gt; TypeBase shape u -&gt; shape
</span><a href="Futhark.IR.Prop.Types.html#arrayShape"><span class="hs-identifier hs-var">arrayShape</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness
</span><a href="#local-6989586621684537026"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Space -&gt; ImpM GPUMem KernelEnv KernelOp VName)
-&gt; Space -&gt; ImpM GPUMem KernelEnv KernelOp VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Space
</span><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-var">Space</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;local&quot;</span></span><span>
</span><span id="line-457"></span><span>
</span><span id="line-458"></span><span>  </span><span id="local-6989586621684537024"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684537024"><span class="hs-identifier hs-var">tmp_arrs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TypeBase Shape NoUniqueness
 -&gt; ImpM GPUMem KernelEnv KernelOp VName)
-&gt; [TypeBase Shape NoUniqueness]
-&gt; ImpM GPUMem KernelEnv KernelOp [VName]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness -&gt; ImpM GPUMem KernelEnv KernelOp VName
</span><a href="#local-6989586621684537027"><span class="hs-identifier hs-var">mkTempArr</span></a></span><span> </span><span class="annot"><span class="annottext">([TypeBase Shape NoUniqueness]
 -&gt; ImpM GPUMem KernelEnv KernelOp [VName])
-&gt; [TypeBase Shape NoUniqueness]
-&gt; ImpM GPUMem KernelEnv KernelOp [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SegBinOp GPUMem -&gt; [TypeBase Shape NoUniqueness])
-&gt; [SegBinOp GPUMem] -&gt; [TypeBase Shape NoUniqueness]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda GPUMem -&gt; [TypeBase Shape NoUniqueness]
forall rep. LambdaT rep -&gt; [TypeBase Shape NoUniqueness]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">(Lambda GPUMem -&gt; [TypeBase Shape NoUniqueness])
-&gt; (SegBinOp GPUMem -&gt; Lambda GPUMem)
-&gt; SegBinOp GPUMem
-&gt; [TypeBase Shape NoUniqueness]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SegBinOp GPUMem -&gt; Lambda GPUMem
forall rep. SegBinOp rep -&gt; Lambda rep
</span><a href="Futhark.IR.SegOp.html#segBinOpLambda"><span class="hs-identifier hs-var hs-var">segBinOpLambda</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684537035"><span class="hs-identifier hs-var">ops</span></a></span><span>
</span><span id="line-459"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684537021"><span class="annot"><span class="annottext">tmps_for_ops :: [[VName]]
</span><a href="#local-6989586621684537021"><span class="hs-identifier hs-var hs-var">tmps_for_ops</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; [VName] -&gt; [[VName]]
forall a. [Int] -&gt; [a] -&gt; [[a]]
</span><a href="Futhark.Util.html#chunks"><span class="hs-identifier hs-var">chunks</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SegBinOp GPUMem -&gt; Int) -&gt; [SegBinOp GPUMem] -&gt; [Int]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; Int)
-&gt; (SegBinOp GPUMem -&gt; [SubExp]) -&gt; SegBinOp GPUMem -&gt; Int
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SegBinOp GPUMem -&gt; [SubExp]
forall rep. SegBinOp rep -&gt; [SubExp]
</span><a href="Futhark.IR.SegOp.html#segBinOpNeutral"><span class="hs-identifier hs-var hs-var">segBinOpNeutral</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684537035"><span class="hs-identifier hs-var">ops</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684537024"><span class="hs-identifier hs-var">tmp_arrs</span></a></span><span>
</span><span id="line-460"></span><span>
</span><span id="line-461"></span><span>  </span><span class="annot"><span class="annottext">SegLevel -&gt; SegSpace -&gt; InKernelGen () -&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#whenActive"><span class="hs-identifier hs-var">whenActive</span></a></span><span> </span><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684537037"><span class="hs-identifier hs-var">lvl</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684537036"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; (InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen ()
-&gt; InKernelGen ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Operations GPUMem KernelEnv KernelOp
-&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op a.
Operations rep r op -&gt; ImpM rep r op a -&gt; ImpM rep r op a
</span><a href="Futhark.CodeGen.ImpGen.html#localOps"><span class="hs-identifier hs-var">localOps</span></a></span><span> </span><span class="annot"><span class="annottext">Operations GPUMem KernelEnv KernelOp
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#threadOperations"><span class="hs-identifier hs-var">threadOperations</span></a></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-462"></span><span>    </span><span class="annot"><span class="annottext">Names -&gt; Stms GPUMem -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op.
Names -&gt; Stms rep -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileStms"><span class="hs-identifier hs-var">compileStms</span></a></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelBody GPUMem -&gt; Stms GPUMem
forall rep. KernelBody rep -&gt; Stms rep
</span><a href="Futhark.IR.SegOp.html#kernelBodyStms"><span class="hs-identifier hs-var hs-var">kernelBodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684537034"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-463"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684537020"><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684537020"><span class="hs-identifier hs-var">red_res</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684537019"><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684537019"><span class="hs-identifier hs-var">map_res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-464"></span><span>            </span><span class="annot"><span class="annottext">Int -&gt; [KernelResult] -&gt; ([KernelResult], [KernelResult])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SegBinOp GPUMem] -&gt; Int
forall rep. [SegBinOp rep] -&gt; Int
</span><a href="Futhark.IR.SegOp.html#segBinOpResults"><span class="hs-identifier hs-var">segBinOpResults</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684537035"><span class="hs-identifier hs-var">ops</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([KernelResult] -&gt; ([KernelResult], [KernelResult]))
-&gt; [KernelResult] -&gt; ([KernelResult], [KernelResult])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem -&gt; [KernelResult]
forall rep. KernelBody rep -&gt; [KernelResult]
</span><a href="Futhark.IR.SegOp.html#kernelBodyResult"><span class="hs-identifier hs-var hs-var">kernelBodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684537034"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-465"></span><span>      </span><span class="annot"><span class="annottext">[(VName, KernelResult)]
-&gt; ((VName, KernelResult) -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; [KernelResult] -&gt; [(VName, KernelResult)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684537024"><span class="hs-identifier hs-var">tmp_arrs</span></a></span><span> </span><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684537020"><span class="hs-identifier hs-var">red_res</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((VName, KernelResult) -&gt; InKernelGen ()) -&gt; InKernelGen ())
-&gt; ((VName, KernelResult) -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684537018"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684537018"><span class="hs-identifier hs-var">dest</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684537017"><span class="annot"><span class="annottext">KernelResult
</span><a href="#local-6989586621684537017"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-466"></span><span>        </span><span class="annot"><span class="annottext">VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; InKernelGen ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684537018"><span class="hs-identifier hs-var">dest</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(VName -&gt; TExp Int64) -&gt; [VName] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TExp Int64
forall a. a -&gt; TPrimExp Int64 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le64"><span class="hs-identifier hs-var">Imp.le64</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684537033"><span class="hs-identifier hs-var">ltids</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelResult -&gt; SubExp
</span><a href="Futhark.IR.SegOp.html#kernelResultSubExp"><span class="hs-identifier hs-var">kernelResultSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">KernelResult
</span><a href="#local-6989586621684537017"><span class="hs-identifier hs-var">res</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-467"></span><span>      </span><span class="annot"><span class="annottext">(PatElemT LParamMem -&gt; KernelResult -&gt; InKernelGen ())
-&gt; [PatElemT LParamMem] -&gt; [KernelResult] -&gt; InKernelGen ()
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m ()
</span><span class="hs-identifier hs-var">zipWithM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegSpace
-&gt; PatElemT (LetDec GPUMem) -&gt; KernelResult -&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileThreadResult"><span class="hs-identifier hs-var">compileThreadResult</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684537036"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684537030"><span class="hs-identifier hs-var">map_pes</span></a></span><span> </span><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684537019"><span class="hs-identifier hs-var">map_res</span></a></span><span>
</span><span id="line-468"></span><span>
</span><span id="line-469"></span><span>  </span><span class="annot"><span class="annottext">KernelOp -&gt; InKernelGen ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelOp -&gt; InKernelGen ()) -&gt; KernelOp -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Fence -&gt; KernelOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#ErrorSync"><span class="hs-identifier hs-var">Imp.ErrorSync</span></a></span><span> </span><span class="annot"><span class="annottext">Fence
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#FenceLocal"><span class="hs-identifier hs-var">Imp.FenceLocal</span></a></span><span>
</span><span id="line-470"></span><span>
</span><span id="line-471"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684537028"><span class="hs-identifier hs-var">dims'</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-472"></span><span>    </span><span class="hs-comment">-- Nonsegmented case (or rather, a single segment) - this we can</span><span>
</span><span id="line-473"></span><span>    </span><span class="hs-comment">-- handle directly with a group-level reduction.</span><span>
</span><span id="line-474"></span><span>    </span><span class="hs-special">[</span><span id="local-6989586621684537016"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684537016"><span class="hs-identifier hs-var">dim'</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-475"></span><span>      </span><span class="annot"><span class="annottext">[(SegBinOp GPUMem, [VName])]
-&gt; ((SegBinOp GPUMem, [VName]) -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SegBinOp GPUMem] -&gt; [[VName]] -&gt; [(SegBinOp GPUMem, [VName])]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684537035"><span class="hs-identifier hs-var">ops</span></a></span><span> </span><span class="annot"><span class="annottext">[[VName]]
</span><a href="#local-6989586621684537021"><span class="hs-identifier hs-var">tmps_for_ops</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((SegBinOp GPUMem, [VName]) -&gt; InKernelGen ()) -&gt; InKernelGen ())
-&gt; ((SegBinOp GPUMem, [VName]) -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684537015"><span class="annot"><span class="annottext">SegBinOp GPUMem
</span><a href="#local-6989586621684537015"><span class="hs-identifier hs-var">op</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684537014"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684537014"><span class="hs-identifier hs-var">tmps</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-476"></span><span>        </span><span class="annot"><span class="annottext">TExp Int32 -&gt; Lambda GPUMem -&gt; [VName] -&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#groupReduce"><span class="hs-identifier hs-var">groupReduce</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int32
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int32 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt32"><span class="hs-identifier hs-var">sExt32</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684537016"><span class="hs-identifier hs-var">dim'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOp GPUMem -&gt; Lambda GPUMem
forall rep. SegBinOp rep -&gt; Lambda rep
</span><a href="Futhark.IR.SegOp.html#segBinOpLambda"><span class="hs-identifier hs-var hs-var">segBinOpLambda</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp GPUMem
</span><a href="#local-6989586621684537015"><span class="hs-identifier hs-var">op</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684537014"><span class="hs-identifier hs-var">tmps</span></a></span><span>
</span><span id="line-477"></span><span>
</span><span id="line-478"></span><span>      </span><span class="annot"><span class="annottext">KernelOp -&gt; InKernelGen ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelOp -&gt; InKernelGen ()) -&gt; KernelOp -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Fence -&gt; KernelOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#ErrorSync"><span class="hs-identifier hs-var">Imp.ErrorSync</span></a></span><span> </span><span class="annot"><span class="annottext">Fence
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#FenceLocal"><span class="hs-identifier hs-var">Imp.FenceLocal</span></a></span><span>
</span><span id="line-479"></span><span>
</span><span id="line-480"></span><span>      </span><span class="annot"><span class="annottext">[(PatElemT LParamMem, VName)]
-&gt; ((PatElemT LParamMem, VName) -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PatElemT LParamMem] -&gt; [VName] -&gt; [(PatElemT LParamMem, VName)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684537031"><span class="hs-identifier hs-var">red_pes</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684537024"><span class="hs-identifier hs-var">tmp_arrs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((PatElemT LParamMem, VName) -&gt; InKernelGen ()) -&gt; InKernelGen ())
-&gt; ((PatElemT LParamMem, VName) -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684537013"><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684537013"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684537012"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684537012"><span class="hs-identifier hs-var">arr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-481"></span><span>        </span><span class="annot"><span class="annottext">VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; InKernelGen ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684537013"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684537012"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TExp Int64
</span><span class="hs-number">0</span></span><span class="hs-special">]</span><span>
</span><span id="line-482"></span><span>    </span><span class="annot"><span class="annottext">[TExp Int64]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-483"></span><span>      </span><span class="hs-comment">-- Segmented intra-group reductions are turned into (regular)</span><span>
</span><span id="line-484"></span><span>      </span><span class="hs-comment">-- segmented scans.  It is possible that this can be done</span><span>
</span><span id="line-485"></span><span>      </span><span class="hs-comment">-- better, but at least this approach is simple.</span><span>
</span><span id="line-486"></span><span>
</span><span id="line-487"></span><span>      </span><span class="hs-comment">-- groupScan operates on flattened arrays.  This does not</span><span>
</span><span id="line-488"></span><span>      </span><span class="hs-comment">-- involve copying anything; merely playing with the index</span><span>
</span><span id="line-489"></span><span>      </span><span class="hs-comment">-- function.</span><span>
</span><span id="line-490"></span><span>      </span><span id="local-6989586621684537011"><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684537011"><span class="hs-identifier hs-var">dims_flat</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; TExp Int64 -&gt; ImpM GPUMem KernelEnv KernelOp (TV Int64)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV"><span class="hs-identifier hs-var">dPrimV</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;dims_flat&quot;</span></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; ImpM GPUMem KernelEnv KernelOp (TV Int64))
-&gt; TExp Int64 -&gt; ImpM GPUMem KernelEnv KernelOp (TV Int64)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; TExp Int64
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">product</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684537028"><span class="hs-identifier hs-var">dims'</span></a></span><span>
</span><span id="line-491"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684537010"><span class="annot"><span class="annottext">flatten :: VName -&gt; ImpM GPUMem KernelEnv KernelOp VName
</span><a href="#local-6989586621684537010"><span class="hs-identifier hs-var hs-var">flatten</span></a></span></span><span> </span><span id="local-6989586621684537009"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684537009"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-492"></span><span>            </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ArrayEntry"><span class="hs-identifier hs-type">ArrayEntry</span></a></span><span> </span><span id="local-6989586621684537007"><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684537007"><span class="hs-identifier hs-var">arr_loc</span></a></span></span><span> </span><span id="local-6989586621684537006"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684537006"><span class="hs-identifier hs-var">pt</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; ImpM GPUMem KernelEnv KernelOp ArrayEntry
forall rep r op. VName -&gt; ImpM rep r op ArrayEntry
</span><a href="Futhark.CodeGen.ImpGen.html#lookupArray"><span class="hs-identifier hs-var">lookupArray</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684537009"><span class="hs-identifier hs-var">arr</span></a></span><span>
</span><span id="line-493"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684537005"><span class="annot"><span class="annottext">flat_shape :: Shape
</span><a href="#local-6989586621684537005"><span class="hs-identifier hs-var hs-var">flat_shape</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-494"></span><span>                  </span><span class="annot"><span class="annottext">[SubExp] -&gt; Shape
forall d. [d] -&gt; ShapeBase d
</span><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-var">Shape</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; Shape) -&gt; [SubExp] -&gt; Shape
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-495"></span><span>                    </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int64 -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684537011"><span class="hs-identifier hs-var">dims_flat</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; [SubExp] -&gt; [SubExp]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span>
</span><span id="line-496"></span><span>                    </span><span class="annot"><span class="annottext">Int -&gt; [SubExp] -&gt; [SubExp]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684537033"><span class="hs-identifier hs-var">ltids</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MemLoc -&gt; [SubExp]
</span><a href="Futhark.CodeGen.ImpGen.html#memLocShape"><span class="hs-identifier hs-var hs-var">memLocShape</span></a></span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684537007"><span class="hs-identifier hs-var">arr_loc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-497"></span><span>            </span><span class="annot"><span class="annottext">String
-&gt; PrimType
-&gt; Shape
-&gt; VName
-&gt; IxFun
-&gt; ImpM GPUMem KernelEnv KernelOp VName
forall rep r op.
String
-&gt; PrimType -&gt; Shape -&gt; VName -&gt; IxFun -&gt; ImpM rep r op VName
</span><a href="Futhark.CodeGen.ImpGen.html#sArray"><span class="hs-identifier hs-var">sArray</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;red_arr_flat&quot;</span></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684537006"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684537005"><span class="hs-identifier hs-var">flat_shape</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MemLoc -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#memLocName"><span class="hs-identifier hs-var hs-var">memLocName</span></a></span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684537007"><span class="hs-identifier hs-var">arr_loc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IxFun -&gt; ImpM GPUMem KernelEnv KernelOp VName)
-&gt; IxFun -&gt; ImpM GPUMem KernelEnv KernelOp VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-498"></span><span>              </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; IxFun
forall num. IntegralExp num =&gt; Shape num -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#iota"><span class="hs-identifier hs-var">IxFun.iota</span></a></span><span> </span><span class="annot"><span class="annottext">([TExp Int64] -&gt; IxFun) -&gt; [TExp Int64] -&gt; IxFun
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
</span><a href="Futhark.Analysis.PrimExp.Convert.html#pe64"><span class="hs-identifier hs-var">pe64</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [TExp Int64]) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Shape -&gt; [SubExp]
forall d. ShapeBase d -&gt; [d]
</span><a href="Futhark.IR.Syntax.Core.html#shapeDims"><span class="hs-identifier hs-var hs-var">shapeDims</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684537005"><span class="hs-identifier hs-var">flat_shape</span></a></span><span>
</span><span id="line-499"></span><span>
</span><span id="line-500"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684537003"><span class="annot"><span class="annottext">segment_size :: TExp Int64
</span><a href="#local-6989586621684537003"><span class="hs-identifier hs-var hs-var">segment_size</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; TExp Int64
forall a. [a] -&gt; a
</span><span class="hs-identifier hs-var">last</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684537028"><span class="hs-identifier hs-var">dims'</span></a></span><span>
</span><span id="line-501"></span><span>          </span><span id="local-6989586621684537002"><span class="annot"><span class="annottext">crossesSegment :: TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool
</span><a href="#local-6989586621684537002"><span class="hs-identifier hs-var hs-var">crossesSegment</span></a></span></span><span> </span><span id="local-6989586621684537001"><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684537001"><span class="hs-identifier hs-var">from</span></a></span></span><span> </span><span id="local-6989586621684537000"><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684537000"><span class="hs-identifier hs-var">to</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-502"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int64
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684537000"><span class="hs-identifier hs-var">to</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int64
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684537001"><span class="hs-identifier hs-var">from</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Bool
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3E."><span class="hs-operator hs-var">.&gt;.</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int64
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684537000"><span class="hs-identifier hs-var">to</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall e. IntegralExp e =&gt; e -&gt; e -&gt; e
</span><a href="Futhark.Util.IntegralExp.html#rem"><span class="hs-operator hs-var">`rem`</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684537003"><span class="hs-identifier hs-var">segment_size</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-503"></span><span>
</span><span id="line-504"></span><span>      </span><span class="annot"><span class="annottext">[(SegBinOp GPUMem, [VName])]
-&gt; ((SegBinOp GPUMem, [VName]) -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SegBinOp GPUMem] -&gt; [[VName]] -&gt; [(SegBinOp GPUMem, [VName])]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684537035"><span class="hs-identifier hs-var">ops</span></a></span><span> </span><span class="annot"><span class="annottext">[[VName]]
</span><a href="#local-6989586621684537021"><span class="hs-identifier hs-var">tmps_for_ops</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((SegBinOp GPUMem, [VName]) -&gt; InKernelGen ()) -&gt; InKernelGen ())
-&gt; ((SegBinOp GPUMem, [VName]) -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684536999"><span class="annot"><span class="annottext">SegBinOp GPUMem
</span><a href="#local-6989586621684536999"><span class="hs-identifier hs-var">op</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684536998"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684536998"><span class="hs-identifier hs-var">tmps</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-505"></span><span>        </span><span id="local-6989586621684536997"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684536997"><span class="hs-identifier hs-var">tmps_flat</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; ImpM GPUMem KernelEnv KernelOp VName)
-&gt; [VName] -&gt; ImpM GPUMem KernelEnv KernelOp [VName]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; ImpM GPUMem KernelEnv KernelOp VName
</span><a href="#local-6989586621684537010"><span class="hs-identifier hs-var">flatten</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684536998"><span class="hs-identifier hs-var">tmps</span></a></span><span>
</span><span id="line-506"></span><span>        </span><span class="annot"><span class="annottext">Maybe (TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool)
-&gt; TExp Int64
-&gt; TExp Int64
-&gt; Lambda GPUMem
-&gt; [VName]
-&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#groupScan"><span class="hs-identifier hs-var">groupScan</span></a></span><span>
</span><span id="line-507"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool)
-&gt; Maybe (TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool
</span><a href="#local-6989586621684537002"><span class="hs-identifier hs-var">crossesSegment</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-508"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TExp Int64] -&gt; TExp Int64
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">product</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684537028"><span class="hs-identifier hs-var">dims'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-509"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TExp Int64] -&gt; TExp Int64
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">product</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684537028"><span class="hs-identifier hs-var">dims'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-510"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOp GPUMem -&gt; Lambda GPUMem
forall rep. SegBinOp rep -&gt; Lambda rep
</span><a href="Futhark.IR.SegOp.html#segBinOpLambda"><span class="hs-identifier hs-var hs-var">segBinOpLambda</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp GPUMem
</span><a href="#local-6989586621684536999"><span class="hs-identifier hs-var">op</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-511"></span><span>          </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684536997"><span class="hs-identifier hs-var">tmps_flat</span></a></span><span>
</span><span id="line-512"></span><span>
</span><span id="line-513"></span><span>      </span><span class="annot"><span class="annottext">KernelOp -&gt; InKernelGen ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelOp -&gt; InKernelGen ()) -&gt; KernelOp -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Fence -&gt; KernelOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#ErrorSync"><span class="hs-identifier hs-var">Imp.ErrorSync</span></a></span><span> </span><span class="annot"><span class="annottext">Fence
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#FenceLocal"><span class="hs-identifier hs-var">Imp.FenceLocal</span></a></span><span>
</span><span id="line-514"></span><span>
</span><span id="line-515"></span><span>      </span><span class="annot"><span class="annottext">[(PatElemT LParamMem, VName)]
-&gt; ((PatElemT LParamMem, VName) -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PatElemT LParamMem] -&gt; [VName] -&gt; [(PatElemT LParamMem, VName)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684537031"><span class="hs-identifier hs-var">red_pes</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684537024"><span class="hs-identifier hs-var">tmp_arrs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((PatElemT LParamMem, VName) -&gt; InKernelGen ()) -&gt; InKernelGen ())
-&gt; ((PatElemT LParamMem, VName) -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684536996"><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684536996"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684536995"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536995"><span class="hs-identifier hs-var">arr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-516"></span><span>        </span><span class="annot"><span class="annottext">VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; InKernelGen ()
forall rep r op.
VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-var">copyDWIM</span></a></span><span>
</span><span id="line-517"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684536996"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-518"></span><span>          </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-519"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536995"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-520"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TExp Int64 -&gt; DimIndex (TExp Int64))
-&gt; [TExp Int64] -&gt; [DimIndex (TExp Int64)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; DimIndex (TExp Int64)
forall d. Num d =&gt; d -&gt; d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#unitSlice"><span class="hs-identifier hs-var">unitSlice</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TExp Int64] -&gt; [TExp Int64]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">init</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684537028"><span class="hs-identifier hs-var">dims'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DimIndex (TExp Int64)]
-&gt; [DimIndex (TExp Int64)] -&gt; [DimIndex (TExp Int64)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TExp Int64 -&gt; DimIndex (TExp Int64)
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; DimIndex (TExp Int64))
-&gt; TExp Int64 -&gt; DimIndex (TExp Int64)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; TExp Int64
forall a. [a] -&gt; a
</span><span class="hs-identifier hs-var">last</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684537028"><span class="hs-identifier hs-var">dims'</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span class="annot"><span class="annottext">TExp Int64
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-521"></span><span>
</span><span id="line-522"></span><span>      </span><span class="annot"><span class="annottext">KernelOp -&gt; InKernelGen ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelOp -&gt; InKernelGen ()) -&gt; KernelOp -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Fence -&gt; KernelOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#Barrier"><span class="hs-identifier hs-var">Imp.Barrier</span></a></span><span> </span><span class="annot"><span class="annottext">Fence
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#FenceLocal"><span class="hs-identifier hs-var">Imp.FenceLocal</span></a></span><span>
</span><span id="line-523"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileGroupOp"><span class="hs-identifier hs-var">compileGroupOp</span></a></span><span> </span><span id="local-6989586621684536992"><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684536992"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SegOp"><span class="hs-identifier hs-type">SegOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#SegHist"><span class="hs-identifier hs-type">SegHist</span></a></span><span> </span><span id="local-6989586621684536990"><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684536990"><span class="hs-identifier hs-var">lvl</span></a></span></span><span> </span><span id="local-6989586621684536989"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684536989"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684536988"><span class="annot"><span class="annottext">[HistOp GPUMem]
</span><a href="#local-6989586621684536988"><span class="hs-identifier hs-var">ops</span></a></span></span><span> </span><span class="annot"><span class="annottext">[TypeBase Shape NoUniqueness]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684536987"><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684536987"><span class="hs-identifier hs-var">kbody</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-524"></span><span>  </span><span class="annot"><span class="annottext">SegLevel -&gt; SegSpace -&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileGroupSpace"><span class="hs-identifier hs-var">compileGroupSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684536990"><span class="hs-identifier hs-var">lvl</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684536989"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-525"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684536986"><span class="annot"><span class="annottext">ltids :: [VName]
</span><a href="#local-6989586621684536986"><span class="hs-identifier hs-var hs-var">ltids</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((VName, SubExp) -&gt; VName) -&gt; [(VName, SubExp)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(VName, SubExp) -&gt; VName
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">([(VName, SubExp)] -&gt; [VName]) -&gt; [(VName, SubExp)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; [(VName, SubExp)]
</span><a href="Futhark.IR.SegOp.html#unSegSpace"><span class="hs-identifier hs-var hs-var">unSegSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684536989"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-526"></span><span>
</span><span id="line-527"></span><span>  </span><span class="hs-comment">-- We don't need the red_pes, because it is guaranteed by our type</span><span>
</span><span id="line-528"></span><span>  </span><span class="hs-comment">-- rules that they occupy the same memory as the destinations for</span><span>
</span><span id="line-529"></span><span>  </span><span class="hs-comment">-- the ops.</span><span>
</span><span id="line-530"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684536985"><span class="annot"><span class="annottext">num_red_res :: Int
</span><a href="#local-6989586621684536985"><span class="hs-identifier hs-var hs-var">num_red_res</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[HistOp GPUMem] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[HistOp GPUMem]
</span><a href="#local-6989586621684536988"><span class="hs-identifier hs-var">ops</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; Int
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">sum</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(HistOp GPUMem -&gt; Int) -&gt; [HistOp GPUMem] -&gt; [Int]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; Int)
-&gt; (HistOp GPUMem -&gt; [SubExp]) -&gt; HistOp GPUMem -&gt; Int
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">HistOp GPUMem -&gt; [SubExp]
forall rep. HistOp rep -&gt; [SubExp]
</span><a href="Futhark.IR.SegOp.html#histNeutral"><span class="hs-identifier hs-var hs-var">histNeutral</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[HistOp GPUMem]
</span><a href="#local-6989586621684536988"><span class="hs-identifier hs-var">ops</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-531"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684536983"><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684536983"><span class="hs-identifier hs-var">_red_pes</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684536982"><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684536982"><span class="hs-identifier hs-var">map_pes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-532"></span><span>        </span><span class="annot"><span class="annottext">Int
-&gt; [PatElemT LParamMem]
-&gt; ([PatElemT LParamMem], [PatElemT LParamMem])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684536985"><span class="hs-identifier hs-var">num_red_res</span></a></span><span> </span><span class="annot"><span class="annottext">([PatElemT LParamMem]
 -&gt; ([PatElemT LParamMem], [PatElemT LParamMem]))
-&gt; [PatElemT LParamMem]
-&gt; ([PatElemT LParamMem], [PatElemT LParamMem])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatT LParamMem -&gt; [PatElemT LParamMem]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem
PatT LParamMem
</span><a href="#local-6989586621684536992"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-533"></span><span>
</span><span id="line-534"></span><span>  </span><span id="local-6989586621684536981"><span class="annot"><span class="annottext">[[TExp Int64] -&gt; InKernelGen ()]
</span><a href="#local-6989586621684536981"><span class="hs-identifier hs-var">ops'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Count GroupSize SubExp
-&gt; [HistOp GPUMem] -&gt; InKernelGen [[TExp Int64] -&gt; InKernelGen ()]
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#prepareIntraGroupSegHist"><span class="hs-identifier hs-var">prepareIntraGroupSegHist</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegLevel -&gt; Count GroupSize SubExp
</span><a href="Futhark.IR.GPU.Op.html#segGroupSize"><span class="hs-identifier hs-var hs-var">segGroupSize</span></a></span><span> </span><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684536990"><span class="hs-identifier hs-var">lvl</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[HistOp GPUMem]
</span><a href="#local-6989586621684536988"><span class="hs-identifier hs-var">ops</span></a></span><span>
</span><span id="line-535"></span><span>
</span><span id="line-536"></span><span>  </span><span class="hs-comment">-- Ensure that all locks have been initialised.</span><span>
</span><span id="line-537"></span><span>  </span><span class="annot"><span class="annottext">KernelOp -&gt; InKernelGen ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelOp -&gt; InKernelGen ()) -&gt; KernelOp -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Fence -&gt; KernelOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#Barrier"><span class="hs-identifier hs-var">Imp.Barrier</span></a></span><span> </span><span class="annot"><span class="annottext">Fence
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#FenceLocal"><span class="hs-identifier hs-var">Imp.FenceLocal</span></a></span><span>
</span><span id="line-538"></span><span>
</span><span id="line-539"></span><span>  </span><span class="annot"><span class="annottext">SegLevel -&gt; SegSpace -&gt; InKernelGen () -&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#whenActive"><span class="hs-identifier hs-var">whenActive</span></a></span><span> </span><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684536990"><span class="hs-identifier hs-var">lvl</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684536989"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; (InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen ()
-&gt; InKernelGen ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Operations GPUMem KernelEnv KernelOp
-&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op a.
Operations rep r op -&gt; ImpM rep r op a -&gt; ImpM rep r op a
</span><a href="Futhark.CodeGen.ImpGen.html#localOps"><span class="hs-identifier hs-var">localOps</span></a></span><span> </span><span class="annot"><span class="annottext">Operations GPUMem KernelEnv KernelOp
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#threadOperations"><span class="hs-identifier hs-var">threadOperations</span></a></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-540"></span><span>    </span><span class="annot"><span class="annottext">Names -&gt; Stms GPUMem -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op.
Names -&gt; Stms rep -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileStms"><span class="hs-identifier hs-var">compileStms</span></a></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelBody GPUMem -&gt; Stms GPUMem
forall rep. KernelBody rep -&gt; Stms rep
</span><a href="Futhark.IR.SegOp.html#kernelBodyStms"><span class="hs-identifier hs-var hs-var">kernelBodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684536987"><span class="hs-identifier hs-var">kbody</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-541"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684536979"><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684536979"><span class="hs-identifier hs-var">red_res</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684536978"><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684536978"><span class="hs-identifier hs-var">map_res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [KernelResult] -&gt; ([KernelResult], [KernelResult])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684536985"><span class="hs-identifier hs-var">num_red_res</span></a></span><span> </span><span class="annot"><span class="annottext">([KernelResult] -&gt; ([KernelResult], [KernelResult]))
-&gt; [KernelResult] -&gt; ([KernelResult], [KernelResult])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem -&gt; [KernelResult]
forall rep. KernelBody rep -&gt; [KernelResult]
</span><a href="Futhark.IR.SegOp.html#kernelBodyResult"><span class="hs-identifier hs-var hs-var">kernelBodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684536987"><span class="hs-identifier hs-var">kbody</span></a></span><span>
</span><span id="line-542"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621684536977"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684536977"><span class="hs-identifier hs-var">red_is</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684536976"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684536976"><span class="hs-identifier hs-var">red_vs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [SubExp] -&gt; ([SubExp], [SubExp])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[HistOp GPUMem] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[HistOp GPUMem]
</span><a href="#local-6989586621684536988"><span class="hs-identifier hs-var">ops</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; ([SubExp], [SubExp]))
-&gt; [SubExp] -&gt; ([SubExp], [SubExp])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(KernelResult -&gt; SubExp) -&gt; [KernelResult] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">KernelResult -&gt; SubExp
</span><a href="Futhark.IR.SegOp.html#kernelResultSubExp"><span class="hs-identifier hs-var">kernelResultSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684536979"><span class="hs-identifier hs-var">red_res</span></a></span><span>
</span><span id="line-543"></span><span>      </span><span class="annot"><span class="annottext">(PatElemT LParamMem -&gt; KernelResult -&gt; InKernelGen ())
-&gt; [PatElemT LParamMem] -&gt; [KernelResult] -&gt; InKernelGen ()
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m ()
</span><span class="hs-identifier hs-var">zipWithM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegSpace
-&gt; PatElemT (LetDec GPUMem) -&gt; KernelResult -&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileThreadResult"><span class="hs-identifier hs-var">compileThreadResult</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684536989"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684536982"><span class="hs-identifier hs-var">map_pes</span></a></span><span> </span><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684536978"><span class="hs-identifier hs-var">map_res</span></a></span><span>
</span><span id="line-544"></span><span>
</span><span id="line-545"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684536975"><span class="annot"><span class="annottext">vs_per_op :: [[SubExp]]
</span><a href="#local-6989586621684536975"><span class="hs-identifier hs-var hs-var">vs_per_op</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; [SubExp] -&gt; [[SubExp]]
forall a. [Int] -&gt; [a] -&gt; [[a]]
</span><a href="Futhark.Util.html#chunks"><span class="hs-identifier hs-var">chunks</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(HistOp GPUMem -&gt; Int) -&gt; [HistOp GPUMem] -&gt; [Int]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; Int)
-&gt; (HistOp GPUMem -&gt; [VName]) -&gt; HistOp GPUMem -&gt; Int
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">HistOp GPUMem -&gt; [VName]
forall rep. HistOp rep -&gt; [VName]
</span><a href="Futhark.IR.SegOp.html#histDest"><span class="hs-identifier hs-var hs-var">histDest</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[HistOp GPUMem]
</span><a href="#local-6989586621684536988"><span class="hs-identifier hs-var">ops</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684536976"><span class="hs-identifier hs-var">red_vs</span></a></span><span>
</span><span id="line-546"></span><span>
</span><span id="line-547"></span><span>      </span><span class="annot"><span class="annottext">[(SubExp, [SubExp], [TExp Int64] -&gt; InKernelGen (), HistOp GPUMem)]
-&gt; ((SubExp, [SubExp], [TExp Int64] -&gt; InKernelGen (),
     HistOp GPUMem)
    -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp]
-&gt; [[SubExp]]
-&gt; [[TExp Int64] -&gt; InKernelGen ()]
-&gt; [HistOp GPUMem]
-&gt; [(SubExp, [SubExp], [TExp Int64] -&gt; InKernelGen (),
     HistOp GPUMem)]
forall a b c d. [a] -&gt; [b] -&gt; [c] -&gt; [d] -&gt; [(a, b, c, d)]
</span><span class="hs-identifier hs-var">zip4</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684536977"><span class="hs-identifier hs-var">red_is</span></a></span><span> </span><span class="annot"><span class="annottext">[[SubExp]]
</span><a href="#local-6989586621684536975"><span class="hs-identifier hs-var">vs_per_op</span></a></span><span> </span><span class="annot"><span class="annottext">[[TExp Int64] -&gt; InKernelGen ()]
</span><a href="#local-6989586621684536981"><span class="hs-identifier hs-var">ops'</span></a></span><span> </span><span class="annot"><span class="annottext">[HistOp GPUMem]
</span><a href="#local-6989586621684536988"><span class="hs-identifier hs-var">ops</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((SubExp, [SubExp], [TExp Int64] -&gt; InKernelGen (), HistOp GPUMem)
  -&gt; InKernelGen ())
 -&gt; InKernelGen ())
-&gt; ((SubExp, [SubExp], [TExp Int64] -&gt; InKernelGen (),
     HistOp GPUMem)
    -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-548"></span><span>        </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684536974"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684536974"><span class="hs-identifier hs-var">bin</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684536973"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684536973"><span class="hs-identifier hs-var">op_vs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684536972"><span class="annot"><span class="annottext">[TExp Int64] -&gt; InKernelGen ()
</span><a href="#local-6989586621684536972"><span class="hs-identifier hs-var">do_op</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.SegOp.html#HistOp"><span class="hs-identifier hs-type">HistOp</span></a></span><span> </span><span id="local-6989586621684536970"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684536970"><span class="hs-identifier hs-var">dest_shape</span></a></span></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684536969"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684536969"><span class="hs-identifier hs-var">shape</span></a></span></span><span> </span><span id="local-6989586621684536968"><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684536968"><span class="hs-identifier hs-var">lam</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-549"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684536967"><span class="annot"><span class="annottext">bin' :: TExp Int64
</span><a href="#local-6989586621684536967"><span class="hs-identifier hs-var hs-var">bin'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684536974"><span class="hs-identifier hs-var">bin</span></a></span><span>
</span><span id="line-550"></span><span>              </span><span id="local-6989586621684536966"><span class="annot"><span class="annottext">dest_shape' :: [TExp Int64]
</span><a href="#local-6989586621684536966"><span class="hs-identifier hs-var hs-var">dest_shape'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [TExp Int64]) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Shape -&gt; [SubExp]
forall d. ShapeBase d -&gt; [d]
</span><a href="Futhark.IR.Syntax.Core.html#shapeDims"><span class="hs-identifier hs-var hs-var">shapeDims</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684536970"><span class="hs-identifier hs-var">dest_shape</span></a></span><span>
</span><span id="line-551"></span><span>              </span><span id="local-6989586621684536965"><span class="annot"><span class="annottext">bin_in_bounds :: TExp Bool
</span><a href="#local-6989586621684536965"><span class="hs-identifier hs-var hs-var">bin_in_bounds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Slice (TExp Int64) -&gt; [TExp Int64] -&gt; TExp Bool
</span><a href="Futhark.CodeGen.ImpGen.html#inBounds"><span class="hs-identifier hs-var">inBounds</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DimIndex (TExp Int64)] -&gt; Slice (TExp Int64)
forall d. [DimIndex d] -&gt; Slice d
</span><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-var">Slice</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TExp Int64 -&gt; DimIndex (TExp Int64))
-&gt; [TExp Int64] -&gt; [DimIndex (TExp Int64)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; DimIndex (TExp Int64)
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536967"><span class="hs-identifier hs-var">bin'</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536966"><span class="hs-identifier hs-var">dest_shape'</span></a></span><span>
</span><span id="line-552"></span><span>              </span><span id="local-6989586621684536964"><span class="annot"><span class="annottext">bin_is :: [TExp Int64]
</span><a href="#local-6989586621684536964"><span class="hs-identifier hs-var hs-var">bin_is</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; TExp Int64) -&gt; [VName] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TExp Int64
forall a. a -&gt; TPrimExp Int64 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le64"><span class="hs-identifier hs-var">Imp.le64</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; [VName]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">init</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684536986"><span class="hs-identifier hs-var">ltids</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; [TExp Int64] -&gt; [TExp Int64]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536967"><span class="hs-identifier hs-var">bin'</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-553"></span><span>              </span><span id="local-6989586621684536963"><span class="annot"><span class="annottext">vs_params :: [Param LParamMem]
</span><a href="#local-6989586621684536963"><span class="hs-identifier hs-var hs-var">vs_params</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Param LParamMem] -&gt; [Param LParamMem]
forall a. Int -&gt; [a] -&gt; [a]
</span><a href="Futhark.Util.html#takeLast"><span class="hs-identifier hs-var">takeLast</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684536973"><span class="hs-identifier hs-var">op_vs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Param LParamMem] -&gt; [Param LParamMem])
-&gt; [Param LParamMem] -&gt; [Param LParamMem]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem -&gt; [LParam GPUMem]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684536968"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-554"></span><span>
</span><span id="line-555"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;perform atomic updates&quot;</span></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-556"></span><span>            </span><span class="annot"><span class="annottext">TExp Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684536965"><span class="hs-identifier hs-var">bin_in_bounds</span></a></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-557"></span><span>              </span><span class="annot"><span class="annottext">[LParam GPUMem] -&gt; InKernelGen ()
forall rep inner r op.
Mem rep inner =&gt;
[LParam rep] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dLParams"><span class="hs-identifier hs-var">dLParams</span></a></span><span> </span><span class="annot"><span class="annottext">([LParam GPUMem] -&gt; InKernelGen ())
-&gt; [LParam GPUMem] -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem -&gt; [LParam GPUMem]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684536968"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-558"></span><span>              </span><span class="annot"><span class="annottext">Shape -&gt; ([TExp Int64] -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall rep r op.
Shape -&gt; ([TExp Int64] -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sLoopNest"><span class="hs-identifier hs-var">sLoopNest</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684536969"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">(([TExp Int64] -&gt; InKernelGen ()) -&gt; InKernelGen ())
-&gt; ([TExp Int64] -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684536961"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536961"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-559"></span><span>                </span><span class="annot"><span class="annottext">[(Param LParamMem, SubExp)]
-&gt; ((Param LParamMem, SubExp) -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param LParamMem] -&gt; [SubExp] -&gt; [(Param LParamMem, SubExp)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684536963"><span class="hs-identifier hs-var">vs_params</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684536973"><span class="hs-identifier hs-var">op_vs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Param LParamMem, SubExp) -&gt; InKernelGen ()) -&gt; InKernelGen ())
-&gt; ((Param LParamMem, SubExp) -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684536960"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536960"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684536959"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684536959"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-560"></span><span>                  </span><span class="annot"><span class="annottext">VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; InKernelGen ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536960"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684536959"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536961"><span class="hs-identifier hs-var">is</span></a></span><span>
</span><span id="line-561"></span><span>                </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; InKernelGen ()
</span><a href="#local-6989586621684536972"><span class="hs-identifier hs-var">do_op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536964"><span class="hs-identifier hs-var">bin_is</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; [TExp Int64] -&gt; [TExp Int64]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536961"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-562"></span><span>
</span><span id="line-563"></span><span>  </span><span class="annot"><span class="annottext">KernelOp -&gt; InKernelGen ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelOp -&gt; InKernelGen ()) -&gt; KernelOp -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Fence -&gt; KernelOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#ErrorSync"><span class="hs-identifier hs-var">Imp.ErrorSync</span></a></span><span> </span><span class="annot"><span class="annottext">Fence
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#FenceLocal"><span class="hs-identifier hs-var">Imp.FenceLocal</span></a></span><span>
</span><span id="line-564"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileGroupOp"><span class="hs-identifier hs-var">compileGroupOp</span></a></span><span> </span><span id="local-6989586621684536958"><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684536958"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="annot"><span class="annottext">Op GPUMem
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-565"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; InKernelGen ()
forall a. String -&gt; a
</span><a href="Futhark.Error.html#compilerBugS"><span class="hs-identifier hs-var">compilerBugS</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; InKernelGen ()) -&gt; String -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;compileGroupOp: cannot compile rhs of binding &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">PatT LParamMem -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem
PatT LParamMem
</span><a href="#local-6989586621684536958"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-566"></span><span>
</span><span id="line-567"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileThreadOp"><span class="hs-identifier hs-type">compileThreadOp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#OpCompiler"><span class="hs-identifier hs-type">OpCompiler</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#KernelEnv"><span class="hs-identifier hs-type">KernelEnv</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.GPU.html#KernelOp"><span class="hs-identifier hs-type">Imp.KernelOp</span></a></span><span>
</span><span id="line-568"></span><span id="compileThreadOp"><span class="annot"><span class="annottext">compileThreadOp :: OpCompiler GPUMem KernelEnv KernelOp
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileThreadOp"><span class="hs-identifier hs-var hs-var">compileThreadOp</span></a></span></span><span> </span><span id="local-6989586621684536955"><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684536955"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#Alloc"><span class="hs-identifier hs-type">Alloc</span></a></span><span> </span><span id="local-6989586621684536954"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684536954"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span id="local-6989586621684536953"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684536953"><span class="hs-identifier hs-var">space</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-569"></span><span>  </span><span class="annot"><span class="annottext">Pat GPUMem -&gt; SubExp -&gt; Space -&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelAlloc"><span class="hs-identifier hs-var">kernelAlloc</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684536955"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684536954"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684536953"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-570"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileThreadOp"><span class="hs-identifier hs-var">compileThreadOp</span></a></span><span> </span><span id="local-6989586621684536952"><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684536952"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SizeOp"><span class="hs-identifier hs-type">SizeOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SplitSpace"><span class="hs-identifier hs-type">SplitSpace</span></a></span><span> </span><span id="local-6989586621684536951"><span class="annot"><span class="annottext">SplitOrdering
</span><a href="#local-6989586621684536951"><span class="hs-identifier hs-var">o</span></a></span></span><span> </span><span id="local-6989586621684536950"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684536950"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684536949"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684536949"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621684536948"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684536948"><span class="hs-identifier hs-var">elems_per_thread</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-571"></span><span>  </span><span class="annot"><span class="annottext">Pat GPUMem
-&gt; SplitOrdering -&gt; SubExp -&gt; SubExp -&gt; SubExp -&gt; InKernelGen ()
forall w i elems_per_thread rep r op.
(ToExp w, ToExp i, ToExp elems_per_thread) =&gt;
Pat GPUMem
-&gt; SplitOrdering -&gt; w -&gt; i -&gt; elems_per_thread -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#splitSpace"><span class="hs-identifier hs-var">splitSpace</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684536952"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">SplitOrdering
</span><a href="#local-6989586621684536951"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684536950"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684536949"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684536948"><span class="hs-identifier hs-var">elems_per_thread</span></a></span><span>
</span><span id="line-572"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileThreadOp"><span class="hs-identifier hs-var">compileThreadOp</span></a></span><span> </span><span id="local-6989586621684536947"><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684536947"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="annot"><span class="annottext">Op GPUMem
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-573"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; InKernelGen ()
forall a. String -&gt; a
</span><a href="Futhark.Error.html#compilerBugS"><span class="hs-identifier hs-var">compilerBugS</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; InKernelGen ()) -&gt; String -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;compileThreadOp: cannot compile rhs of binding &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">PatT LParamMem -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem
PatT LParamMem
</span><a href="#local-6989586621684536947"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-574"></span><span>
</span><span id="line-575"></span><span class="hs-comment">-- | Locking strategy used for an atomic update.</span><span>
</span><span id="line-576"></span><span class="hs-keyword">data</span><span> </span><span id="Locking"><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#Locking"><span class="hs-identifier hs-var">Locking</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Locking"><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#Locking"><span class="hs-identifier hs-var">Locking</span></a></span></span><span>
</span><span id="line-577"></span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- | Array containing the lock.</span><span>
</span><span id="line-578"></span><span>    </span><span id="lockingArray"><span class="annot"><span class="annottext">Locking -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#lockingArray"><span class="hs-identifier hs-var hs-var">lockingArray</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-579"></span><span>    </span><span class="hs-comment">-- | Value for us to consider the lock free.</span><span>
</span><span id="line-580"></span><span>    </span><span id="lockingIsUnlocked"><span class="annot"><span class="annottext">Locking -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#lockingIsUnlocked"><span class="hs-identifier hs-var hs-var">lockingIsUnlocked</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span class="hs-special">,</span><span>
</span><span id="line-581"></span><span>    </span><span class="hs-comment">-- | What to write when we lock it.</span><span>
</span><span id="line-582"></span><span>    </span><span id="lockingToLock"><span class="annot"><span class="annottext">Locking -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#lockingToLock"><span class="hs-identifier hs-var hs-var">lockingToLock</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span class="hs-special">,</span><span>
</span><span id="line-583"></span><span>    </span><span class="hs-comment">-- | What to write when we unlock it.</span><span>
</span><span id="line-584"></span><span>    </span><span id="lockingToUnlock"><span class="annot"><span class="annottext">Locking -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#lockingToUnlock"><span class="hs-identifier hs-var hs-var">lockingToUnlock</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span class="hs-special">,</span><span>
</span><span id="line-585"></span><span>    </span><span class="hs-comment">-- | A transformation from the logical lock index to the</span><span>
</span><span id="line-586"></span><span>    </span><span class="hs-comment">-- physical position in the array.  This can also be used</span><span>
</span><span id="line-587"></span><span>    </span><span class="hs-comment">-- to make the lock array smaller.</span><span>
</span><span id="line-588"></span><span>    </span><span id="lockingMapping"><span class="annot"><span class="annottext">Locking -&gt; [TExp Int64] -&gt; [TExp Int64]
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#lockingMapping"><span class="hs-identifier hs-var hs-var">lockingMapping</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">]</span><span>
</span><span id="line-589"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-590"></span><span>
</span><span id="line-591"></span><span class="hs-comment">-- | A function for generating code for an atomic update.  Assumes</span><span>
</span><span id="line-592"></span><span class="hs-comment">-- that the bucket is in-bounds.</span><span>
</span><span id="line-593"></span><span class="hs-keyword">type</span><span> </span><span id="DoAtomicUpdate"><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#DoAtomicUpdate"><span class="hs-identifier hs-var">DoAtomicUpdate</span></a></span></span><span> </span><span id="local-6989586621684536941"><span class="annot"><a href="#local-6989586621684536941"><span class="hs-identifier hs-type">rep</span></a></span></span><span> </span><span id="local-6989586621684536940"><span class="annot"><a href="#local-6989586621684536940"><span class="hs-identifier hs-type">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-594"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684536941"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684536940"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.GPU.html#KernelOp"><span class="hs-identifier hs-type">Imp.KernelOp</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-595"></span><span>
</span><span id="line-596"></span><span class="hs-comment">-- | The mechanism that will be used for performing the atomic update.</span><span>
</span><span id="line-597"></span><span class="hs-comment">-- Approximates how efficient it will be.  Ordered from most to least</span><span>
</span><span id="line-598"></span><span class="hs-comment">-- efficient.</span><span>
</span><span id="line-599"></span><span class="hs-keyword">data</span><span> </span><span id="AtomicUpdate"><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#AtomicUpdate"><span class="hs-identifier hs-var">AtomicUpdate</span></a></span></span><span> </span><span id="local-6989586621684538661"><span class="annot"><a href="#local-6989586621684538661"><span class="hs-identifier hs-type">rep</span></a></span></span><span> </span><span id="local-6989586621684538660"><span class="annot"><a href="#local-6989586621684538660"><span class="hs-identifier hs-type">r</span></a></span></span><span>
</span><span id="line-600"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- | Supported directly by primitive.</span><span>
</span><span id="line-601"></span><span>    </span><span id="AtomicPrim"><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#AtomicPrim"><span class="hs-identifier hs-var">AtomicPrim</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#DoAtomicUpdate"><span class="hs-identifier hs-type">DoAtomicUpdate</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684538661"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684538660"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-602"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-comment">-- | Can be done by efficient swaps.</span><span>
</span><span id="line-603"></span><span>    </span><span id="AtomicCAS"><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#AtomicCAS"><span class="hs-identifier hs-var">AtomicCAS</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#DoAtomicUpdate"><span class="hs-identifier hs-type">DoAtomicUpdate</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684538661"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684538660"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-604"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-comment">-- | Requires explicit locking.</span><span>
</span><span id="line-605"></span><span>    </span><span id="AtomicLocking"><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#AtomicLocking"><span class="hs-identifier hs-var">AtomicLocking</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#Locking"><span class="hs-identifier hs-type">Locking</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#DoAtomicUpdate"><span class="hs-identifier hs-type">DoAtomicUpdate</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684538661"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684538660"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-606"></span><span>
</span><span id="line-607"></span><span class="hs-comment">-- | Is there an atomic t'BinOp' corresponding to this t'BinOp'?</span><span>
</span><span id="line-608"></span><span class="hs-keyword">type</span><span> </span><span id="AtomicBinOp"><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#AtomicBinOp"><span class="hs-identifier hs-var">AtomicBinOp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-609"></span><span>  </span><span class="annot"><a href="Futhark.IR.Primitive.html#BinOp"><span class="hs-identifier hs-type">BinOp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-610"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-type">Count</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#Elements"><span class="hs-identifier hs-type">Imp.Elements</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#Exp"><span class="hs-identifier hs-type">Imp.Exp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.GPU.html#AtomicOp"><span class="hs-identifier hs-type">Imp.AtomicOp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-611"></span><span>
</span><span id="line-612"></span><span class="hs-comment">-- | Do an atomic update corresponding to a binary operator lambda.</span><span>
</span><span id="line-613"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#atomicUpdateLocking"><span class="hs-identifier hs-type">atomicUpdateLocking</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-614"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#AtomicBinOp"><span class="hs-identifier hs-type">AtomicBinOp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-615"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-616"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#AtomicUpdate"><span class="hs-identifier hs-type">AtomicUpdate</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#KernelEnv"><span class="hs-identifier hs-type">KernelEnv</span></a></span><span>
</span><span id="line-617"></span><span id="atomicUpdateLocking"><span class="annot"><span class="annottext">atomicUpdateLocking :: AtomicBinOp -&gt; Lambda GPUMem -&gt; AtomicUpdate GPUMem KernelEnv
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#atomicUpdateLocking"><span class="hs-identifier hs-var hs-var">atomicUpdateLocking</span></a></span></span><span> </span><span id="local-6989586621684536938"><span class="annot"><span class="annottext">AtomicBinOp
</span><a href="#local-6989586621684536938"><span class="hs-identifier hs-var">atomicBinOp</span></a></span></span><span> </span><span id="local-6989586621684536937"><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684536937"><span class="hs-identifier hs-var">lam</span></a></span></span><span>
</span><span id="line-618"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684536936"><span class="annot"><span class="annottext">[(BinOp, PrimType, VName, VName)]
</span><a href="#local-6989586621684536936"><span class="hs-identifier hs-var">ops_and_ts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem -&gt; Maybe [(BinOp, PrimType, VName, VName)]
forall rep.
ASTRep rep =&gt;
Lambda rep -&gt; Maybe [(BinOp, PrimType, VName, VName)]
</span><a href="Futhark.IR.Prop.html#lamIsBinOp"><span class="hs-identifier hs-var">lamIsBinOp</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684536937"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-619"></span><span>    </span><span class="annot"><span class="annottext">((BinOp, PrimType, VName, VName) -&gt; Bool)
-&gt; [(BinOp, PrimType, VName, VName)] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="annottext">BinOp
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684536933"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684536933"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; Int
</span><a href="Futhark.IR.Primitive.html#primBitSize"><span class="hs-identifier hs-var">primBitSize</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684536933"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Int] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">32</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">64</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(BinOp, PrimType, VName, VName)]
</span><a href="#local-6989586621684536936"><span class="hs-identifier hs-var">ops_and_ts</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-620"></span><span>    </span><span class="annot"><span class="annottext">[(BinOp, PrimType, VName, VName)]
-&gt; DoAtomicUpdate GPUMem KernelEnv -&gt; AtomicUpdate GPUMem KernelEnv
</span><a href="#local-6989586621684536930"><span class="hs-identifier hs-var">primOrCas</span></a></span><span> </span><span class="annot"><span class="annottext">[(BinOp, PrimType, VName, VName)]
</span><a href="#local-6989586621684536936"><span class="hs-identifier hs-var">ops_and_ts</span></a></span><span> </span><span class="annot"><span class="annottext">(DoAtomicUpdate GPUMem KernelEnv -&gt; AtomicUpdate GPUMem KernelEnv)
-&gt; DoAtomicUpdate GPUMem KernelEnv -&gt; AtomicUpdate GPUMem KernelEnv
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684536929"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684536929"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684536928"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684536928"><span class="hs-identifier hs-var">arrs</span></a></span></span><span> </span><span id="local-6989586621684536927"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536927"><span class="hs-identifier hs-var">bucket</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-621"></span><span>      </span><span class="hs-comment">-- If the operator is a vectorised binary operator on 32/64-bit</span><span>
</span><span id="line-622"></span><span>      </span><span class="hs-comment">-- values, we can use a particularly efficient</span><span>
</span><span id="line-623"></span><span>      </span><span class="hs-comment">-- implementation. If the operator has an atomic implementation</span><span>
</span><span id="line-624"></span><span>      </span><span class="hs-comment">-- we use that, otherwise it is still a binary operator which</span><span>
</span><span id="line-625"></span><span>      </span><span class="hs-comment">-- can be implemented by atomic compare-and-swap if 32/64 bits.</span><span>
</span><span id="line-626"></span><span>      </span><span class="annot"><span class="annottext">[(VName, (BinOp, PrimType, VName, VName))]
-&gt; ((VName, (BinOp, PrimType, VName, VName)) -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName]
-&gt; [(BinOp, PrimType, VName, VName)]
-&gt; [(VName, (BinOp, PrimType, VName, VName))]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684536928"><span class="hs-identifier hs-var">arrs</span></a></span><span> </span><span class="annot"><span class="annottext">[(BinOp, PrimType, VName, VName)]
</span><a href="#local-6989586621684536936"><span class="hs-identifier hs-var">ops_and_ts</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((VName, (BinOp, PrimType, VName, VName)) -&gt; InKernelGen ())
 -&gt; InKernelGen ())
-&gt; ((VName, (BinOp, PrimType, VName, VName)) -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684536926"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536926"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684536925"><span class="annot"><span class="annottext">BinOp
</span><a href="#local-6989586621684536925"><span class="hs-identifier hs-var">op</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684536924"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684536924"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684536923"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536923"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684536922"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536922"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-627"></span><span>        </span><span class="hs-comment">-- Common variables.</span><span>
</span><span id="line-628"></span><span>        </span><span id="local-6989586621684536921"><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684536921"><span class="hs-identifier hs-var">old</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; PrimType -&gt; ImpM GPUMem KernelEnv KernelOp (TV Any)
forall rep r op t. String -&gt; PrimType -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrim"><span class="hs-identifier hs-var">dPrim</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;old&quot;</span></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684536924"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-629"></span><span>
</span><span id="line-630"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621684536919"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536919"><span class="hs-identifier hs-var">arr'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684536918"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684536918"><span class="hs-identifier hs-var">_a_space</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684536917"><span class="annot"><span class="annottext">Count Elements (TExp Int64)
</span><a href="#local-6989586621684536917"><span class="hs-identifier hs-var">bucket_offset</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName
-&gt; [TExp Int64]
-&gt; ImpM
     GPUMem
     KernelEnv
     KernelOp
     (VName, Space, Count Elements (TExp Int64))
forall rep r op.
VName
-&gt; [TExp Int64]
-&gt; ImpM rep r op (VName, Space, Count Elements (TExp Int64))
</span><a href="Futhark.CodeGen.ImpGen.html#fullyIndexArray"><span class="hs-identifier hs-var">fullyIndexArray</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536926"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536927"><span class="hs-identifier hs-var">bucket</span></a></span><span>
</span><span id="line-631"></span><span>
</span><span id="line-632"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Space
-&gt; VName
-&gt; VName
-&gt; Count Elements (TExp Int64)
-&gt; BinOp
-&gt; Maybe (PrimExp VName -&gt; KernelOp)
</span><a href="#local-6989586621684536915"><span class="hs-identifier hs-var">opHasAtomicSupport</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684536929"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Any -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684536921"><span class="hs-identifier hs-var">old</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536919"><span class="hs-identifier hs-var">arr'</span></a></span><span> </span><span class="annot"><span class="annottext">Count Elements (TExp Int64)
</span><a href="#local-6989586621684536917"><span class="hs-identifier hs-var">bucket_offset</span></a></span><span> </span><span class="annot"><span class="annottext">BinOp
</span><a href="#local-6989586621684536925"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-633"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684536914"><span class="annot"><span class="annottext">PrimExp VName -&gt; KernelOp
</span><a href="#local-6989586621684536914"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">KernelOp -&gt; InKernelGen ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelOp -&gt; InKernelGen ()) -&gt; KernelOp -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimExp VName -&gt; KernelOp
</span><a href="#local-6989586621684536914"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimExp VName -&gt; KernelOp) -&gt; PrimExp VName -&gt; KernelOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; PrimExp VName
</span><a href="Futhark.CodeGen.ImpCode.html#var"><span class="hs-identifier hs-var">Imp.var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536922"><span class="hs-identifier hs-var">y</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684536924"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-634"></span><span>          </span><span class="annot"><span class="annottext">Maybe (PrimExp VName -&gt; KernelOp)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-635"></span><span>            </span><span class="annot"><span class="annottext">Space
-&gt; PrimType
-&gt; VName
-&gt; VName
-&gt; [TExp Int64]
-&gt; VName
-&gt; InKernelGen ()
-&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#atomicUpdateCAS"><span class="hs-identifier hs-var">atomicUpdateCAS</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684536929"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684536924"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536926"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Any -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684536921"><span class="hs-identifier hs-var">old</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536927"><span class="hs-identifier hs-var">bucket</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536923"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-636"></span><span>              </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536923"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; PrimExp VName -&gt; InKernelGen ()
forall rep r op. VName -&gt; PrimExp VName -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#%3C~~"><span class="hs-operator hs-var">&lt;~~</span></a></span><span> </span><span class="annot"><span class="annottext">BinOp -&gt; PrimExp VName -&gt; PrimExp VName -&gt; PrimExp VName
forall v. BinOp -&gt; PrimExp v -&gt; PrimExp v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#BinOpExp"><span class="hs-identifier hs-var">Imp.BinOpExp</span></a></span><span> </span><span class="annot"><span class="annottext">BinOp
</span><a href="#local-6989586621684536925"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; PrimExp VName
</span><a href="Futhark.CodeGen.ImpCode.html#var"><span class="hs-identifier hs-var">Imp.var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536923"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684536924"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; PrimExp VName
</span><a href="Futhark.CodeGen.ImpCode.html#var"><span class="hs-identifier hs-var">Imp.var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536922"><span class="hs-identifier hs-var">y</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684536924"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-637"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-638"></span><span>    </span><span id="local-6989586621684536915"><span class="annot"><span class="annottext">opHasAtomicSupport :: Space
-&gt; VName
-&gt; VName
-&gt; Count Elements (TExp Int64)
-&gt; BinOp
-&gt; Maybe (PrimExp VName -&gt; KernelOp)
</span><a href="#local-6989586621684536915"><span class="hs-identifier hs-var hs-var">opHasAtomicSupport</span></a></span></span><span> </span><span id="local-6989586621684536910"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684536910"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684536909"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536909"><span class="hs-identifier hs-var">old</span></a></span></span><span> </span><span id="local-6989586621684536908"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536908"><span class="hs-identifier hs-var">arr'</span></a></span></span><span> </span><span id="local-6989586621684536907"><span class="annot"><span class="annottext">Count Elements (TExp Int64)
</span><a href="#local-6989586621684536907"><span class="hs-identifier hs-var">bucket'</span></a></span></span><span> </span><span id="local-6989586621684536906"><span class="annot"><span class="annottext">BinOp
</span><a href="#local-6989586621684536906"><span class="hs-identifier hs-var">bop</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-639"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684536905"><span class="annot"><span class="annottext">atomic :: (VName
 -&gt; VName
 -&gt; Count Elements (TExp Int64)
 -&gt; PrimExp VName
 -&gt; AtomicOp)
-&gt; PrimExp VName -&gt; KernelOp
</span><a href="#local-6989586621684536905"><span class="hs-identifier hs-var hs-var">atomic</span></a></span></span><span> </span><span id="local-6989586621684536904"><span class="annot"><span class="annottext">VName
-&gt; VName
-&gt; Count Elements (TExp Int64)
-&gt; PrimExp VName
-&gt; AtomicOp
</span><a href="#local-6989586621684536904"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Space -&gt; AtomicOp -&gt; KernelOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#Atomic"><span class="hs-identifier hs-var">Imp.Atomic</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684536910"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">(AtomicOp -&gt; KernelOp)
-&gt; (PrimExp VName -&gt; AtomicOp) -&gt; PrimExp VName -&gt; KernelOp
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">VName
-&gt; VName
-&gt; Count Elements (TExp Int64)
-&gt; PrimExp VName
-&gt; AtomicOp
</span><a href="#local-6989586621684536904"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536909"><span class="hs-identifier hs-var">old</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536908"><span class="hs-identifier hs-var">arr'</span></a></span><span> </span><span class="annot"><span class="annottext">Count Elements (TExp Int64)
</span><a href="#local-6989586621684536907"><span class="hs-identifier hs-var">bucket'</span></a></span><span>
</span><span id="line-640"></span><span>      </span><span class="annot"><span class="annottext">(VName
 -&gt; VName
 -&gt; Count Elements (TExp Int64)
 -&gt; PrimExp VName
 -&gt; AtomicOp)
-&gt; PrimExp VName -&gt; KernelOp
</span><a href="#local-6989586621684536905"><span class="hs-identifier hs-var">atomic</span></a></span><span> </span><span class="annot"><span class="annottext">((VName
  -&gt; VName
  -&gt; Count Elements (TExp Int64)
  -&gt; PrimExp VName
  -&gt; AtomicOp)
 -&gt; PrimExp VName -&gt; KernelOp)
-&gt; Maybe
     (VName
      -&gt; VName
      -&gt; Count Elements (TExp Int64)
      -&gt; PrimExp VName
      -&gt; AtomicOp)
-&gt; Maybe (PrimExp VName -&gt; KernelOp)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">AtomicBinOp
</span><a href="#local-6989586621684536938"><span class="hs-identifier hs-var">atomicBinOp</span></a></span><span> </span><span class="annot"><span class="annottext">BinOp
</span><a href="#local-6989586621684536906"><span class="hs-identifier hs-var">bop</span></a></span><span>
</span><span id="line-641"></span><span>
</span><span id="line-642"></span><span>    </span><span id="local-6989586621684536930"><span class="annot"><span class="annottext">primOrCas :: [(BinOp, PrimType, VName, VName)]
-&gt; DoAtomicUpdate GPUMem KernelEnv -&gt; AtomicUpdate GPUMem KernelEnv
</span><a href="#local-6989586621684536930"><span class="hs-identifier hs-var hs-var">primOrCas</span></a></span></span><span> </span><span id="local-6989586621684536902"><span class="annot"><span class="annottext">[(BinOp, PrimType, VName, VName)]
</span><a href="#local-6989586621684536902"><span class="hs-identifier hs-var">ops</span></a></span></span><span>
</span><span id="line-643"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">((BinOp, PrimType, VName, VName) -&gt; Bool)
-&gt; [(BinOp, PrimType, VName, VName)] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="annot"><span class="annottext">(BinOp, PrimType, VName, VName) -&gt; Bool
</span><a href="#local-6989586621684536901"><span class="hs-identifier hs-var">isPrim</span></a></span><span> </span><span class="annot"><span class="annottext">[(BinOp, PrimType, VName, VName)]
</span><a href="#local-6989586621684536902"><span class="hs-identifier hs-var">ops</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DoAtomicUpdate GPUMem KernelEnv -&gt; AtomicUpdate GPUMem KernelEnv
forall rep r. DoAtomicUpdate rep r -&gt; AtomicUpdate rep r
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#AtomicPrim"><span class="hs-identifier hs-var">AtomicPrim</span></a></span><span>
</span><span id="line-644"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DoAtomicUpdate GPUMem KernelEnv -&gt; AtomicUpdate GPUMem KernelEnv
forall rep r. DoAtomicUpdate rep r -&gt; AtomicUpdate rep r
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#AtomicCAS"><span class="hs-identifier hs-var">AtomicCAS</span></a></span><span>
</span><span id="line-645"></span><span>
</span><span id="line-646"></span><span>    </span><span id="local-6989586621684536901"><span class="annot"><span class="annottext">isPrim :: (BinOp, PrimType, VName, VName) -&gt; Bool
</span><a href="#local-6989586621684536901"><span class="hs-identifier hs-var hs-var">isPrim</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684536900"><span class="annot"><span class="annottext">BinOp
</span><a href="#local-6989586621684536900"><span class="hs-identifier hs-var">op</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PrimType
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe
  (VName
   -&gt; VName
   -&gt; Count Elements (TExp Int64)
   -&gt; PrimExp VName
   -&gt; AtomicOp)
-&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="annot"><span class="annottext">(Maybe
   (VName
    -&gt; VName
    -&gt; Count Elements (TExp Int64)
    -&gt; PrimExp VName
    -&gt; AtomicOp)
 -&gt; Bool)
-&gt; Maybe
     (VName
      -&gt; VName
      -&gt; Count Elements (TExp Int64)
      -&gt; PrimExp VName
      -&gt; AtomicOp)
-&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">AtomicBinOp
</span><a href="#local-6989586621684536938"><span class="hs-identifier hs-var">atomicBinOp</span></a></span><span> </span><span class="annot"><span class="annottext">BinOp
</span><a href="#local-6989586621684536900"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-647"></span><span>
</span><span id="line-648"></span><span class="hs-comment">-- If the operator functions purely on single 32/64-bit values, we can</span><span>
</span><span id="line-649"></span><span class="hs-comment">-- use an implementation based on CAS, no matter what the operator</span><span>
</span><span id="line-650"></span><span class="hs-comment">-- does.</span><span>
</span><span id="line-651"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#atomicUpdateLocking"><span class="hs-identifier hs-var">atomicUpdateLocking</span></a></span><span> </span><span class="annot"><span class="annottext">AtomicBinOp
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684536898"><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684536898"><span class="hs-identifier hs-var">op</span></a></span></span><span>
</span><span id="line-652"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-type">Prim</span></a></span><span> </span><span id="local-6989586621684536896"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684536896"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem -&gt; [TypeBase Shape NoUniqueness]
forall rep. LambdaT rep -&gt; [TypeBase Shape NoUniqueness]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684536898"><span class="hs-identifier hs-var">op</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-653"></span><span>    </span><span class="hs-special">[</span><span id="local-6989586621684536895"><span class="annot"><span class="annottext">LParam GPUMem
</span><a href="#local-6989586621684536895"><span class="hs-identifier hs-var">xp</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">LParam GPUMem
</span><span class="hs-identifier">_</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem -&gt; [LParam GPUMem]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684536898"><span class="hs-identifier hs-var">op</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-654"></span><span>    </span><span class="annot"><span class="annottext">PrimType -&gt; Int
</span><a href="Futhark.IR.Primitive.html#primBitSize"><span class="hs-identifier hs-var">primBitSize</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684536896"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Int] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">32</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">64</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DoAtomicUpdate GPUMem KernelEnv -&gt; AtomicUpdate GPUMem KernelEnv
forall rep r. DoAtomicUpdate rep r -&gt; AtomicUpdate rep r
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#AtomicCAS"><span class="hs-identifier hs-var">AtomicCAS</span></a></span><span> </span><span class="annot"><span class="annottext">(DoAtomicUpdate GPUMem KernelEnv -&gt; AtomicUpdate GPUMem KernelEnv)
-&gt; DoAtomicUpdate GPUMem KernelEnv -&gt; AtomicUpdate GPUMem KernelEnv
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684536894"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684536894"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span class="hs-special">[</span><span id="local-6989586621684536893"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536893"><span class="hs-identifier hs-var">arr</span></a></span></span><span class="hs-special">]</span><span> </span><span id="local-6989586621684536892"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536892"><span class="hs-identifier hs-var">bucket</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-655"></span><span>    </span><span id="local-6989586621684536891"><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684536891"><span class="hs-identifier hs-var">old</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; PrimType -&gt; ImpM GPUMem KernelEnv KernelOp (TV Any)
forall rep r op t. String -&gt; PrimType -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrim"><span class="hs-identifier hs-var">dPrim</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;old&quot;</span></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684536896"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-656"></span><span>    </span><span class="annot"><span class="annottext">Space
-&gt; PrimType
-&gt; VName
-&gt; VName
-&gt; [TExp Int64]
-&gt; VName
-&gt; InKernelGen ()
-&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#atomicUpdateCAS"><span class="hs-identifier hs-var">atomicUpdateCAS</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684536894"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684536896"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536893"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Any -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684536891"><span class="hs-identifier hs-var">old</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536892"><span class="hs-identifier hs-var">bucket</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">LParam GPUMem
Param LParamMem
</span><a href="#local-6989586621684536895"><span class="hs-identifier hs-var">xp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-657"></span><span>      </span><span class="annot"><span class="annottext">[Param LParamMem] -&gt; BodyT GPUMem -&gt; InKernelGen ()
forall dec rep r op. [Param dec] -&gt; Body rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileBody%27"><span class="hs-identifier hs-var">compileBody'</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">LParam GPUMem
Param LParamMem
</span><a href="#local-6989586621684536895"><span class="hs-identifier hs-var">xp</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(BodyT GPUMem -&gt; InKernelGen ()) -&gt; BodyT GPUMem -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem -&gt; BodyT GPUMem
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684536898"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-658"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#atomicUpdateLocking"><span class="hs-identifier hs-var">atomicUpdateLocking</span></a></span><span> </span><span class="annot"><span class="annottext">AtomicBinOp
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684536888"><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684536888"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Locking -&gt; DoAtomicUpdate GPUMem KernelEnv)
-&gt; AtomicUpdate GPUMem KernelEnv
forall rep r.
(Locking -&gt; DoAtomicUpdate rep r) -&gt; AtomicUpdate rep r
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#AtomicLocking"><span class="hs-identifier hs-var">AtomicLocking</span></a></span><span> </span><span class="annot"><span class="annottext">((Locking -&gt; DoAtomicUpdate GPUMem KernelEnv)
 -&gt; AtomicUpdate GPUMem KernelEnv)
-&gt; (Locking -&gt; DoAtomicUpdate GPUMem KernelEnv)
-&gt; AtomicUpdate GPUMem KernelEnv
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684536887"><span class="annot"><span class="annottext">Locking
</span><a href="#local-6989586621684536887"><span class="hs-identifier hs-var">locking</span></a></span></span><span> </span><span id="local-6989586621684536886"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684536886"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684536885"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684536885"><span class="hs-identifier hs-var">arrs</span></a></span></span><span> </span><span id="local-6989586621684536884"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536884"><span class="hs-identifier hs-var">bucket</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-659"></span><span>  </span><span id="local-6989586621684536883"><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684536883"><span class="hs-identifier hs-var">old</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; PrimType -&gt; ImpM GPUMem KernelEnv KernelOp (TV Int32)
forall rep r op t. String -&gt; PrimType -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrim"><span class="hs-identifier hs-var">dPrim</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;old&quot;</span></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int32"><span class="hs-identifier hs-var">int32</span></a></span><span>
</span><span id="line-660"></span><span>  </span><span id="local-6989586621684536882"><span class="annot"><span class="annottext">TV Bool
</span><a href="#local-6989586621684536882"><span class="hs-identifier hs-var">continue</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String
-&gt; PrimType
-&gt; TExp Bool
-&gt; ImpM GPUMem KernelEnv KernelOp (TV Bool)
forall t rep r op.
String -&gt; PrimType -&gt; TExp t -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimVol"><span class="hs-identifier hs-var">dPrimVol</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;continue&quot;</span></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Primitive.html#Bool"><span class="hs-identifier hs-var">Bool</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool
forall v. TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#true"><span class="hs-identifier hs-var">true</span></a></span><span>
</span><span id="line-661"></span><span>
</span><span id="line-662"></span><span>  </span><span class="hs-comment">-- Correctly index into locks.</span><span>
</span><span id="line-663"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684536878"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536878"><span class="hs-identifier hs-var">locks'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684536877"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684536877"><span class="hs-identifier hs-var">_locks_space</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684536876"><span class="annot"><span class="annottext">Count Elements (TExp Int64)
</span><a href="#local-6989586621684536876"><span class="hs-identifier hs-var">locks_offset</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-664"></span><span>    </span><span class="annot"><span class="annottext">VName
-&gt; [TExp Int64]
-&gt; ImpM
     GPUMem
     KernelEnv
     KernelOp
     (VName, Space, Count Elements (TExp Int64))
forall rep r op.
VName
-&gt; [TExp Int64]
-&gt; ImpM rep r op (VName, Space, Count Elements (TExp Int64))
</span><a href="Futhark.CodeGen.ImpGen.html#fullyIndexArray"><span class="hs-identifier hs-var">fullyIndexArray</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Locking -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#lockingArray"><span class="hs-identifier hs-var hs-var">lockingArray</span></a></span><span> </span><span class="annot"><span class="annottext">Locking
</span><a href="#local-6989586621684536887"><span class="hs-identifier hs-var">locking</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([TExp Int64]
 -&gt; ImpM
      GPUMem
      KernelEnv
      KernelOp
      (VName, Space, Count Elements (TExp Int64)))
-&gt; [TExp Int64]
-&gt; ImpM
     GPUMem
     KernelEnv
     KernelOp
     (VName, Space, Count Elements (TExp Int64))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Locking -&gt; [TExp Int64] -&gt; [TExp Int64]
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#lockingMapping"><span class="hs-identifier hs-var hs-var">lockingMapping</span></a></span><span> </span><span class="annot"><span class="annottext">Locking
</span><a href="#local-6989586621684536887"><span class="hs-identifier hs-var">locking</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536884"><span class="hs-identifier hs-var">bucket</span></a></span><span>
</span><span id="line-665"></span><span>
</span><span id="line-666"></span><span>  </span><span class="hs-comment">-- Critical section</span><span>
</span><span id="line-667"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684536875"><span class="annot"><span class="annottext">try_acquire_lock :: InKernelGen ()
</span><a href="#local-6989586621684536875"><span class="hs-identifier hs-var hs-var">try_acquire_lock</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-668"></span><span>        </span><span class="annot"><span class="annottext">KernelOp -&gt; InKernelGen ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelOp -&gt; InKernelGen ()) -&gt; KernelOp -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-669"></span><span>          </span><span class="annot"><span class="annottext">Space -&gt; AtomicOp -&gt; KernelOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#Atomic"><span class="hs-identifier hs-var">Imp.Atomic</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684536886"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">(AtomicOp -&gt; KernelOp) -&gt; AtomicOp -&gt; KernelOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-670"></span><span>            </span><span class="annot"><span class="annottext">PrimType
-&gt; VName
-&gt; VName
-&gt; Count Elements (TExp Int64)
-&gt; PrimExp VName
-&gt; PrimExp VName
-&gt; AtomicOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#AtomicCmpXchg"><span class="hs-identifier hs-var">Imp.AtomicCmpXchg</span></a></span><span>
</span><span id="line-671"></span><span>              </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int32"><span class="hs-identifier hs-var">int32</span></a></span><span>
</span><span id="line-672"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int32 -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684536883"><span class="hs-identifier hs-var">old</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-673"></span><span>              </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536878"><span class="hs-identifier hs-var">locks'</span></a></span><span>
</span><span id="line-674"></span><span>              </span><span class="annot"><span class="annottext">Count Elements (TExp Int64)
</span><a href="#local-6989586621684536876"><span class="hs-identifier hs-var">locks_offset</span></a></span><span>
</span><span id="line-675"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int32 -&gt; PrimExp VName
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int32 -&gt; PrimExp VName) -&gt; TExp Int32 -&gt; PrimExp VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Locking -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#lockingIsUnlocked"><span class="hs-identifier hs-var hs-var">lockingIsUnlocked</span></a></span><span> </span><span class="annot"><span class="annottext">Locking
</span><a href="#local-6989586621684536887"><span class="hs-identifier hs-var">locking</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-676"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int32 -&gt; PrimExp VName
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int32 -&gt; PrimExp VName) -&gt; TExp Int32 -&gt; PrimExp VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Locking -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#lockingToLock"><span class="hs-identifier hs-var hs-var">lockingToLock</span></a></span><span> </span><span class="annot"><span class="annottext">Locking
</span><a href="#local-6989586621684536887"><span class="hs-identifier hs-var">locking</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-677"></span><span>      </span><span id="local-6989586621684536873"><span class="annot"><span class="annottext">lock_acquired :: TExp Bool
</span><a href="#local-6989586621684536873"><span class="hs-identifier hs-var hs-var">lock_acquired</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TV Int32 -&gt; TExp Int32
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684536883"><span class="hs-identifier hs-var">old</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3D%3D."><span class="hs-operator hs-var">.==.</span></a></span><span> </span><span class="annot"><span class="annottext">Locking -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#lockingIsUnlocked"><span class="hs-identifier hs-var hs-var">lockingIsUnlocked</span></a></span><span> </span><span class="annot"><span class="annottext">Locking
</span><a href="#local-6989586621684536887"><span class="hs-identifier hs-var">locking</span></a></span><span>
</span><span id="line-678"></span><span>      </span><span class="hs-comment">-- Even the releasing is done with an atomic rather than a</span><span>
</span><span id="line-679"></span><span>      </span><span class="hs-comment">-- simple write, for memory coherency reasons.</span><span>
</span><span id="line-680"></span><span>      </span><span id="local-6989586621684536871"><span class="annot"><span class="annottext">release_lock :: InKernelGen ()
</span><a href="#local-6989586621684536871"><span class="hs-identifier hs-var hs-var">release_lock</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-681"></span><span>        </span><span class="annot"><span class="annottext">KernelOp -&gt; InKernelGen ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelOp -&gt; InKernelGen ()) -&gt; KernelOp -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-682"></span><span>          </span><span class="annot"><span class="annottext">Space -&gt; AtomicOp -&gt; KernelOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#Atomic"><span class="hs-identifier hs-var">Imp.Atomic</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684536886"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">(AtomicOp -&gt; KernelOp) -&gt; AtomicOp -&gt; KernelOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-683"></span><span>            </span><span class="annot"><span class="annottext">PrimType
-&gt; VName
-&gt; VName
-&gt; Count Elements (TExp Int64)
-&gt; PrimExp VName
-&gt; PrimExp VName
-&gt; AtomicOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#AtomicCmpXchg"><span class="hs-identifier hs-var">Imp.AtomicCmpXchg</span></a></span><span>
</span><span id="line-684"></span><span>              </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int32"><span class="hs-identifier hs-var">int32</span></a></span><span>
</span><span id="line-685"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int32 -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684536883"><span class="hs-identifier hs-var">old</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-686"></span><span>              </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536878"><span class="hs-identifier hs-var">locks'</span></a></span><span>
</span><span id="line-687"></span><span>              </span><span class="annot"><span class="annottext">Count Elements (TExp Int64)
</span><a href="#local-6989586621684536876"><span class="hs-identifier hs-var">locks_offset</span></a></span><span>
</span><span id="line-688"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int32 -&gt; PrimExp VName
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int32 -&gt; PrimExp VName) -&gt; TExp Int32 -&gt; PrimExp VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Locking -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#lockingToLock"><span class="hs-identifier hs-var hs-var">lockingToLock</span></a></span><span> </span><span class="annot"><span class="annottext">Locking
</span><a href="#local-6989586621684536887"><span class="hs-identifier hs-var">locking</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-689"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int32 -&gt; PrimExp VName
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int32 -&gt; PrimExp VName) -&gt; TExp Int32 -&gt; PrimExp VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Locking -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#lockingToUnlock"><span class="hs-identifier hs-var hs-var">lockingToUnlock</span></a></span><span> </span><span class="annot"><span class="annottext">Locking
</span><a href="#local-6989586621684536887"><span class="hs-identifier hs-var">locking</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-690"></span><span>      </span><span id="local-6989586621684536870"><span class="annot"><span class="annottext">break_loop :: InKernelGen ()
</span><a href="#local-6989586621684536870"><span class="hs-identifier hs-var hs-var">break_loop</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TV Bool
</span><a href="#local-6989586621684536882"><span class="hs-identifier hs-var">continue</span></a></span><span> </span><span class="annot"><span class="annottext">TV Bool -&gt; TExp Bool -&gt; InKernelGen ()
forall t rep r op. TV t -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#%3C--"><span class="hs-operator hs-var">&lt;--</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool
forall v. TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#false"><span class="hs-identifier hs-var">false</span></a></span><span>
</span><span id="line-691"></span><span>
</span><span id="line-692"></span><span>  </span><span class="hs-comment">-- Preparing parameters. It is assumed that the caller has already</span><span>
</span><span id="line-693"></span><span>  </span><span class="hs-comment">-- filled the arr_params. We copy the current value to the</span><span>
</span><span id="line-694"></span><span>  </span><span class="hs-comment">-- accumulator parameters.</span><span>
</span><span id="line-695"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-696"></span><span>  </span><span class="hs-comment">-- Note the use of 'everythingVolatile' when reading and writing the</span><span>
</span><span id="line-697"></span><span>  </span><span class="hs-comment">-- buckets.  This was necessary to ensure correct execution on a</span><span>
</span><span id="line-698"></span><span>  </span><span class="hs-comment">-- newer NVIDIA GPU (RTX 2080).  The 'volatile' modifiers likely</span><span>
</span><span id="line-699"></span><span>  </span><span class="hs-comment">-- make the writes pass through the (SM-local) L1 cache, which is</span><span>
</span><span id="line-700"></span><span>  </span><span class="hs-comment">-- necessary here, because we are really doing device-wide</span><span>
</span><span id="line-701"></span><span>  </span><span class="hs-comment">-- synchronisation without atomics (naughty!).</span><span>
</span><span id="line-702"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684536867"><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684536867"><span class="hs-identifier hs-var">acc_params</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684536866"><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684536866"><span class="hs-identifier hs-var">_arr_params</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Param LParamMem] -&gt; ([Param LParamMem], [Param LParamMem])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684536885"><span class="hs-identifier hs-var">arrs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Param LParamMem] -&gt; ([Param LParamMem], [Param LParamMem]))
-&gt; [Param LParamMem] -&gt; ([Param LParamMem], [Param LParamMem])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem -&gt; [LParam GPUMem]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684536888"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-703"></span><span>      </span><span id="local-6989586621684536865"><span class="annot"><span class="annottext">bind_acc_params :: InKernelGen ()
</span><a href="#local-6989586621684536865"><span class="hs-identifier hs-var hs-var">bind_acc_params</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-704"></span><span>        </span><span class="annot"><span class="annottext">InKernelGen () -&gt; InKernelGen ()
forall rep r op a. ImpM rep r op a -&gt; ImpM rep r op a
</span><a href="Futhark.CodeGen.ImpGen.html#everythingVolatile"><span class="hs-identifier hs-var">everythingVolatile</span></a></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-705"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;bind lhs&quot;</span></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-706"></span><span>            </span><span class="annot"><span class="annottext">[(Param LParamMem, VName)]
-&gt; ((Param LParamMem, VName) -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param LParamMem] -&gt; [VName] -&gt; [(Param LParamMem, VName)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684536867"><span class="hs-identifier hs-var">acc_params</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684536885"><span class="hs-identifier hs-var">arrs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Param LParamMem, VName) -&gt; InKernelGen ()) -&gt; InKernelGen ())
-&gt; ((Param LParamMem, VName) -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684536863"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536863"><span class="hs-identifier hs-var">acc_p</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684536862"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536862"><span class="hs-identifier hs-var">arr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-707"></span><span>              </span><span class="annot"><span class="annottext">VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; InKernelGen ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536863"><span class="hs-identifier hs-var">acc_p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536862"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536884"><span class="hs-identifier hs-var">bucket</span></a></span><span>
</span><span id="line-708"></span><span>
</span><span id="line-709"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684536861"><span class="annot"><span class="annottext">op_body :: InKernelGen ()
</span><a href="#local-6989586621684536861"><span class="hs-identifier hs-var hs-var">op_body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-710"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;execute operation&quot;</span></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-711"></span><span>          </span><span class="annot"><span class="annottext">[Param LParamMem] -&gt; BodyT GPUMem -&gt; InKernelGen ()
forall dec rep r op. [Param dec] -&gt; Body rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileBody%27"><span class="hs-identifier hs-var">compileBody'</span></a></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684536867"><span class="hs-identifier hs-var">acc_params</span></a></span><span> </span><span class="annot"><span class="annottext">(BodyT GPUMem -&gt; InKernelGen ()) -&gt; BodyT GPUMem -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem -&gt; BodyT GPUMem
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684536888"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-712"></span><span>
</span><span id="line-713"></span><span>      </span><span id="local-6989586621684536860"><span class="annot"><span class="annottext">do_hist :: InKernelGen ()
</span><a href="#local-6989586621684536860"><span class="hs-identifier hs-var hs-var">do_hist</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-714"></span><span>        </span><span class="annot"><span class="annottext">InKernelGen () -&gt; InKernelGen ()
forall rep r op a. ImpM rep r op a -&gt; ImpM rep r op a
</span><a href="Futhark.CodeGen.ImpGen.html#everythingVolatile"><span class="hs-identifier hs-var">everythingVolatile</span></a></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-715"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;update global result&quot;</span></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-716"></span><span>            </span><span class="annot"><span class="annottext">(VName -&gt; SubExp -&gt; InKernelGen ())
-&gt; [VName] -&gt; [SubExp] -&gt; InKernelGen ()
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m ()
</span><span class="hs-identifier hs-var">zipWithM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TExp Int64] -&gt; VName -&gt; SubExp -&gt; InKernelGen ()
forall {rep} {r} {op}.
[TExp Int64] -&gt; VName -&gt; SubExp -&gt; ImpM rep r op ()
</span><a href="#local-6989586621684536859"><span class="hs-identifier hs-var">writeArray</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536884"><span class="hs-identifier hs-var">bucket</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684536885"><span class="hs-identifier hs-var">arrs</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; InKernelGen ()) -&gt; [SubExp] -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Param LParamMem -&gt; SubExp) -&gt; [Param LParamMem] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SubExp)
-&gt; (Param LParamMem -&gt; VName) -&gt; Param LParamMem -&gt; SubExp
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684536867"><span class="hs-identifier hs-var">acc_params</span></a></span><span>
</span><span id="line-717"></span><span>
</span><span id="line-718"></span><span>      </span><span id="local-6989586621684536858"><span class="annot"><span class="annottext">fence :: InKernelGen ()
</span><a href="#local-6989586621684536858"><span class="hs-identifier hs-var hs-var">fence</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">KernelOp -&gt; InKernelGen ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelOp -&gt; InKernelGen ()) -&gt; KernelOp -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Fence -&gt; KernelOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#MemFence"><span class="hs-identifier hs-var">Imp.MemFence</span></a></span><span> </span><span class="annot"><span class="annottext">(Fence -&gt; KernelOp) -&gt; Fence -&gt; KernelOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Space -&gt; Fence
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#fenceForSpace"><span class="hs-identifier hs-var">fenceForSpace</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684536886"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-719"></span><span>
</span><span id="line-720"></span><span>  </span><span class="hs-comment">-- While-loop: Try to insert your value</span><span>
</span><span id="line-721"></span><span>  </span><span class="annot"><span class="annottext">TExp Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhile"><span class="hs-identifier hs-var">sWhile</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Bool -&gt; TExp Bool
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Bool
</span><a href="#local-6989586621684536882"><span class="hs-identifier hs-var">continue</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-722"></span><span>    </span><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684536875"><span class="hs-identifier hs-var">try_acquire_lock</span></a></span><span>
</span><span id="line-723"></span><span>    </span><span class="annot"><span class="annottext">TExp Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684536873"><span class="hs-identifier hs-var">lock_acquired</span></a></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-724"></span><span>      </span><span class="annot"><span class="annottext">[LParam GPUMem] -&gt; InKernelGen ()
forall rep inner r op.
Mem rep inner =&gt;
[LParam rep] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dLParams"><span class="hs-identifier hs-var">dLParams</span></a></span><span> </span><span class="annot"><span class="annottext">[LParam GPUMem]
[Param LParamMem]
</span><a href="#local-6989586621684536867"><span class="hs-identifier hs-var">acc_params</span></a></span><span>
</span><span id="line-725"></span><span>      </span><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684536865"><span class="hs-identifier hs-var">bind_acc_params</span></a></span><span>
</span><span id="line-726"></span><span>      </span><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684536861"><span class="hs-identifier hs-var">op_body</span></a></span><span>
</span><span id="line-727"></span><span>      </span><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684536860"><span class="hs-identifier hs-var">do_hist</span></a></span><span>
</span><span id="line-728"></span><span>      </span><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684536858"><span class="hs-identifier hs-var">fence</span></a></span><span>
</span><span id="line-729"></span><span>      </span><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684536871"><span class="hs-identifier hs-var">release_lock</span></a></span><span>
</span><span id="line-730"></span><span>      </span><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684536870"><span class="hs-identifier hs-var">break_loop</span></a></span><span>
</span><span id="line-731"></span><span>    </span><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684536858"><span class="hs-identifier hs-var">fence</span></a></span><span>
</span><span id="line-732"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-733"></span><span>    </span><span id="local-6989586621684536859"><span class="annot"><span class="annottext">writeArray :: [TExp Int64] -&gt; VName -&gt; SubExp -&gt; ImpM rep r op ()
</span><a href="#local-6989586621684536859"><span class="hs-identifier hs-var hs-var">writeArray</span></a></span></span><span> </span><span id="local-6989586621684536855"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536855"><span class="hs-identifier hs-var">bucket</span></a></span></span><span> </span><span id="local-6989586621684536854"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536854"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span id="local-6989586621684536853"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684536853"><span class="hs-identifier hs-var">val</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536854"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536855"><span class="hs-identifier hs-var">bucket</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684536853"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-734"></span><span>
</span><span id="line-735"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#atomicUpdateCAS"><span class="hs-identifier hs-type">atomicUpdateCAS</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-736"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-737"></span><span>  </span><span class="annot"><a href="Futhark.IR.Primitive.html#PrimType"><span class="hs-identifier hs-type">PrimType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-738"></span><span>  </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-739"></span><span>  </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-740"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-741"></span><span>  </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-742"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#InKernelGen"><span class="hs-identifier hs-type">InKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-743"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#InKernelGen"><span class="hs-identifier hs-type">InKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-744"></span><span id="atomicUpdateCAS"><span class="annot"><span class="annottext">atomicUpdateCAS :: Space
-&gt; PrimType
-&gt; VName
-&gt; VName
-&gt; [TExp Int64]
-&gt; VName
-&gt; InKernelGen ()
-&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#atomicUpdateCAS"><span class="hs-identifier hs-var hs-var">atomicUpdateCAS</span></a></span></span><span> </span><span id="local-6989586621684536852"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684536852"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684536851"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684536851"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621684536850"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536850"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span id="local-6989586621684536849"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536849"><span class="hs-identifier hs-var">old</span></a></span></span><span> </span><span id="local-6989586621684536848"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536848"><span class="hs-identifier hs-var">bucket</span></a></span></span><span> </span><span id="local-6989586621684536847"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536847"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621684536846"><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684536846"><span class="hs-identifier hs-var">do_op</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-745"></span><span>  </span><span class="hs-comment">-- Code generation target:</span><span>
</span><span id="line-746"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-747"></span><span>  </span><span class="hs-comment">-- old = d_his[idx];</span><span>
</span><span id="line-748"></span><span>  </span><span class="hs-comment">-- do {</span><span>
</span><span id="line-749"></span><span>  </span><span class="hs-comment">--   assumed = old;</span><span>
</span><span id="line-750"></span><span>  </span><span class="hs-comment">--   x = do_op(assumed, y);</span><span>
</span><span id="line-751"></span><span>  </span><span class="hs-comment">--   old = atomicCAS(&amp;d_his[idx], assumed, tmp);</span><span>
</span><span id="line-752"></span><span>  </span><span class="hs-comment">-- } while(assumed != old);</span><span>
</span><span id="line-753"></span><span>  </span><span id="local-6989586621684536845"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536845"><span class="hs-identifier hs-var">assumed</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TV Any -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">(TV Any -&gt; VName)
-&gt; ImpM GPUMem KernelEnv KernelOp (TV Any)
-&gt; ImpM GPUMem KernelEnv KernelOp VName
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; PrimType -&gt; ImpM GPUMem KernelEnv KernelOp (TV Any)
forall rep r op t. String -&gt; PrimType -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrim"><span class="hs-identifier hs-var">dPrim</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;assumed&quot;</span></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684536851"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-754"></span><span>  </span><span id="local-6989586621684536844"><span class="annot"><span class="annottext">TV Bool
</span><a href="#local-6989586621684536844"><span class="hs-identifier hs-var">run_loop</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; TExp Bool -&gt; ImpM GPUMem KernelEnv KernelOp (TV Bool)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV"><span class="hs-identifier hs-var">dPrimV</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;run_loop&quot;</span></span><span> </span><span class="annot"><span class="annottext">TExp Bool
forall v. TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#true"><span class="hs-identifier hs-var">true</span></a></span><span>
</span><span id="line-755"></span><span>
</span><span id="line-756"></span><span>  </span><span class="hs-comment">-- XXX: CUDA may generate really bad code if this is not a volatile</span><span>
</span><span id="line-757"></span><span>  </span><span class="hs-comment">-- read.  Unclear why.  The later reads are volatile, so maybe</span><span>
</span><span id="line-758"></span><span>  </span><span class="hs-comment">-- that's it.</span><span>
</span><span id="line-759"></span><span>  </span><span class="annot"><span class="annottext">InKernelGen () -&gt; InKernelGen ()
forall rep r op a. ImpM rep r op a -&gt; ImpM rep r op a
</span><a href="Futhark.CodeGen.ImpGen.html#everythingVolatile"><span class="hs-identifier hs-var">everythingVolatile</span></a></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; InKernelGen ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536849"><span class="hs-identifier hs-var">old</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536850"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536848"><span class="hs-identifier hs-var">bucket</span></a></span><span>
</span><span id="line-760"></span><span>
</span><span id="line-761"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684536843"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536843"><span class="hs-identifier hs-var">arr'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684536842"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684536842"><span class="hs-identifier hs-var">_a_space</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684536841"><span class="annot"><span class="annottext">Count Elements (TExp Int64)
</span><a href="#local-6989586621684536841"><span class="hs-identifier hs-var">bucket_offset</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName
-&gt; [TExp Int64]
-&gt; ImpM
     GPUMem
     KernelEnv
     KernelOp
     (VName, Space, Count Elements (TExp Int64))
forall rep r op.
VName
-&gt; [TExp Int64]
-&gt; ImpM rep r op (VName, Space, Count Elements (TExp Int64))
</span><a href="Futhark.CodeGen.ImpGen.html#fullyIndexArray"><span class="hs-identifier hs-var">fullyIndexArray</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536850"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536848"><span class="hs-identifier hs-var">bucket</span></a></span><span>
</span><span id="line-762"></span><span>
</span><span id="line-763"></span><span>  </span><span class="hs-comment">-- While-loop: Try to insert your value</span><span>
</span><span id="line-764"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684536840"><span class="annot"><span class="annottext">PrimExp VName -&gt; PrimExp VName
</span><a href="#local-6989586621684536840"><span class="hs-identifier hs-var">toBits</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684536839"><span class="annot"><span class="annottext">PrimExp VName -&gt; PrimExp VName
</span><a href="#local-6989586621684536839"><span class="hs-identifier hs-var">fromBits</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-765"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684536851"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-766"></span><span>          </span><span class="annot"><a href="Futhark.IR.Primitive.html#FloatType"><span class="hs-identifier hs-type">FloatType</span></a></span><span> </span><span class="annot"><span class="annottext">FloatType
</span><a href="Futhark.IR.Primitive.html#Float16"><span class="hs-identifier hs-var">Float16</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-767"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684536836"><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684536836"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; [PrimExp VName] -&gt; PrimType -&gt; PrimExp VName
forall v. String -&gt; [PrimExp v] -&gt; PrimType -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#FunExp"><span class="hs-identifier hs-var">Imp.FunExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;to_bits16&quot;</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684536836"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int16"><span class="hs-identifier hs-var">int16</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-768"></span><span>              </span><span class="hs-glyph">\</span><span id="local-6989586621684536833"><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684536833"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; [PrimExp VName] -&gt; PrimType -&gt; PrimExp VName
forall v. String -&gt; [PrimExp v] -&gt; PrimType -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#FunExp"><span class="hs-identifier hs-var">Imp.FunExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;from_bits16&quot;</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684536833"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684536851"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-769"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-770"></span><span>          </span><span class="annot"><a href="Futhark.IR.Primitive.html#FloatType"><span class="hs-identifier hs-type">FloatType</span></a></span><span> </span><span class="annot"><span class="annottext">FloatType
</span><a href="Futhark.IR.Primitive.html#Float32"><span class="hs-identifier hs-var">Float32</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-771"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684536831"><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684536831"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; [PrimExp VName] -&gt; PrimType -&gt; PrimExp VName
forall v. String -&gt; [PrimExp v] -&gt; PrimType -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#FunExp"><span class="hs-identifier hs-var">Imp.FunExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;to_bits32&quot;</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684536831"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int32"><span class="hs-identifier hs-var">int32</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-772"></span><span>              </span><span class="hs-glyph">\</span><span id="local-6989586621684536830"><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684536830"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; [PrimExp VName] -&gt; PrimType -&gt; PrimExp VName
forall v. String -&gt; [PrimExp v] -&gt; PrimType -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#FunExp"><span class="hs-identifier hs-var">Imp.FunExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;from_bits32&quot;</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684536830"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684536851"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-773"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-774"></span><span>          </span><span class="annot"><a href="Futhark.IR.Primitive.html#FloatType"><span class="hs-identifier hs-type">FloatType</span></a></span><span> </span><span class="annot"><span class="annottext">FloatType
</span><a href="Futhark.IR.Primitive.html#Float64"><span class="hs-identifier hs-var">Float64</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-775"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684536828"><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684536828"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; [PrimExp VName] -&gt; PrimType -&gt; PrimExp VName
forall v. String -&gt; [PrimExp v] -&gt; PrimType -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#FunExp"><span class="hs-identifier hs-var">Imp.FunExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;to_bits64&quot;</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684536828"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int64"><span class="hs-identifier hs-var">int64</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-776"></span><span>              </span><span class="hs-glyph">\</span><span id="local-6989586621684536827"><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684536827"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; [PrimExp VName] -&gt; PrimType -&gt; PrimExp VName
forall v. String -&gt; [PrimExp v] -&gt; PrimType -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#FunExp"><span class="hs-identifier hs-var">Imp.FunExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;from_bits64&quot;</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684536827"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684536851"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-777"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-778"></span><span>          </span><span class="annot"><span class="annottext">PrimType
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimExp VName -&gt; PrimExp VName
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PrimExp VName -&gt; PrimExp VName
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span class="hs-special">)</span><span>
</span><span id="line-779"></span><span>
</span><span id="line-780"></span><span>      </span><span id="local-6989586621684536825"><span class="annot"><span class="annottext">int :: PrimType
</span><a href="#local-6989586621684536825"><span class="hs-identifier hs-var hs-var">int</span></a></span></span><span>
</span><span id="line-781"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; Int
</span><a href="Futhark.IR.Primitive.html#primBitSize"><span class="hs-identifier hs-var">primBitSize</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684536851"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">16</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int16"><span class="hs-identifier hs-var">int16</span></a></span><span>
</span><span id="line-782"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; Int
</span><a href="Futhark.IR.Primitive.html#primBitSize"><span class="hs-identifier hs-var">primBitSize</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684536851"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">32</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int32"><span class="hs-identifier hs-var">int32</span></a></span><span>
</span><span id="line-783"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int64"><span class="hs-identifier hs-var">int64</span></a></span><span>
</span><span id="line-784"></span><span>
</span><span id="line-785"></span><span>  </span><span class="annot"><span class="annottext">TExp Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhile"><span class="hs-identifier hs-var">sWhile</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Bool -&gt; TExp Bool
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Bool
</span><a href="#local-6989586621684536844"><span class="hs-identifier hs-var">run_loop</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-786"></span><span>    </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536845"><span class="hs-identifier hs-var">assumed</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; PrimExp VName -&gt; InKernelGen ()
forall rep r op. VName -&gt; PrimExp VName -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#%3C~~"><span class="hs-operator hs-var">&lt;~~</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; PrimExp VName
</span><a href="Futhark.CodeGen.ImpCode.html#var"><span class="hs-identifier hs-var">Imp.var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536849"><span class="hs-identifier hs-var">old</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684536851"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-787"></span><span>    </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536847"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; PrimExp VName -&gt; InKernelGen ()
forall rep r op. VName -&gt; PrimExp VName -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#%3C~~"><span class="hs-operator hs-var">&lt;~~</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; PrimExp VName
</span><a href="Futhark.CodeGen.ImpCode.html#var"><span class="hs-identifier hs-var">Imp.var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536845"><span class="hs-identifier hs-var">assumed</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684536851"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-788"></span><span>    </span><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684536846"><span class="hs-identifier hs-var">do_op</span></a></span><span>
</span><span id="line-789"></span><span>    </span><span id="local-6989586621684536824"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536824"><span class="hs-identifier hs-var">old_bits_v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; ImpM GPUMem KernelEnv KernelOp VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; String -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;old_bits&quot;</span></span><span>
</span><span id="line-790"></span><span>    </span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; InKernelGen ()
forall rep r op. VName -&gt; PrimType -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dPrim_"><span class="hs-identifier hs-var">dPrim_</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536824"><span class="hs-identifier hs-var">old_bits_v</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684536825"><span class="hs-identifier hs-var">int</span></a></span><span>
</span><span id="line-791"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684536822"><span class="annot"><span class="annottext">old_bits :: PrimExp VName
</span><a href="#local-6989586621684536822"><span class="hs-identifier hs-var hs-var">old_bits</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; PrimExp VName
</span><a href="Futhark.CodeGen.ImpCode.html#var"><span class="hs-identifier hs-var">Imp.var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536824"><span class="hs-identifier hs-var">old_bits_v</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684536825"><span class="hs-identifier hs-var">int</span></a></span><span>
</span><span id="line-792"></span><span>    </span><span class="annot"><span class="annottext">KernelOp -&gt; InKernelGen ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelOp -&gt; InKernelGen ())
-&gt; (AtomicOp -&gt; KernelOp) -&gt; AtomicOp -&gt; InKernelGen ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Space -&gt; AtomicOp -&gt; KernelOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#Atomic"><span class="hs-identifier hs-var">Imp.Atomic</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684536852"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">(AtomicOp -&gt; InKernelGen ()) -&gt; AtomicOp -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-793"></span><span>      </span><span class="annot"><span class="annottext">PrimType
-&gt; VName
-&gt; VName
-&gt; Count Elements (TExp Int64)
-&gt; PrimExp VName
-&gt; PrimExp VName
-&gt; AtomicOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#AtomicCmpXchg"><span class="hs-identifier hs-var">Imp.AtomicCmpXchg</span></a></span><span>
</span><span id="line-794"></span><span>        </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684536825"><span class="hs-identifier hs-var">int</span></a></span><span>
</span><span id="line-795"></span><span>        </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536824"><span class="hs-identifier hs-var">old_bits_v</span></a></span><span>
</span><span id="line-796"></span><span>        </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536843"><span class="hs-identifier hs-var">arr'</span></a></span><span>
</span><span id="line-797"></span><span>        </span><span class="annot"><span class="annottext">Count Elements (TExp Int64)
</span><a href="#local-6989586621684536841"><span class="hs-identifier hs-var">bucket_offset</span></a></span><span>
</span><span id="line-798"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimExp VName -&gt; PrimExp VName
</span><a href="#local-6989586621684536840"><span class="hs-identifier hs-var">toBits</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; PrimExp VName
</span><a href="Futhark.CodeGen.ImpCode.html#var"><span class="hs-identifier hs-var">Imp.var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536845"><span class="hs-identifier hs-var">assumed</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684536851"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-799"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimExp VName -&gt; PrimExp VName
</span><a href="#local-6989586621684536840"><span class="hs-identifier hs-var">toBits</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; PrimExp VName
</span><a href="Futhark.CodeGen.ImpCode.html#var"><span class="hs-identifier hs-var">Imp.var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536847"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684536851"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-800"></span><span>    </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536849"><span class="hs-identifier hs-var">old</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; PrimExp VName -&gt; InKernelGen ()
forall rep r op. VName -&gt; PrimExp VName -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#%3C~~"><span class="hs-operator hs-var">&lt;~~</span></a></span><span> </span><span class="annot"><span class="annottext">PrimExp VName -&gt; PrimExp VName
</span><a href="#local-6989586621684536839"><span class="hs-identifier hs-var">fromBits</span></a></span><span> </span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684536822"><span class="hs-identifier hs-var">old_bits</span></a></span><span>
</span><span id="line-801"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684536821"><span class="annot"><span class="annottext">won :: PrimExp VName
</span><a href="#local-6989586621684536821"><span class="hs-identifier hs-var hs-var">won</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CmpOp -&gt; PrimExp VName -&gt; PrimExp VName -&gt; PrimExp VName
forall v. CmpOp -&gt; PrimExp v -&gt; PrimExp v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#CmpOpExp"><span class="hs-identifier hs-var">CmpOpExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimType -&gt; CmpOp
</span><a href="Futhark.IR.Primitive.html#CmpEq"><span class="hs-identifier hs-var">CmpEq</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684536825"><span class="hs-identifier hs-var">int</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimExp VName -&gt; PrimExp VName
</span><a href="#local-6989586621684536840"><span class="hs-identifier hs-var">toBits</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; PrimExp VName
</span><a href="Futhark.CodeGen.ImpCode.html#var"><span class="hs-identifier hs-var">Imp.var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536845"><span class="hs-identifier hs-var">assumed</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684536851"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684536822"><span class="hs-identifier hs-var">old_bits</span></a></span><span>
</span><span id="line-802"></span><span>    </span><span class="annot"><span class="annottext">TExp Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimExp VName -&gt; TExp Bool
forall v. PrimExp v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#isBool"><span class="hs-identifier hs-var">isBool</span></a></span><span> </span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684536821"><span class="hs-identifier hs-var">won</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Bool
</span><a href="#local-6989586621684536844"><span class="hs-identifier hs-var">run_loop</span></a></span><span> </span><span class="annot"><span class="annottext">TV Bool -&gt; TExp Bool -&gt; InKernelGen ()
forall t rep r op. TV t -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#%3C--"><span class="hs-operator hs-var">&lt;--</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool
forall v. TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#false"><span class="hs-identifier hs-var">false</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-803"></span><span>
</span><span id="line-804"></span><span id="local-6989586621684538629"><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#computeKernelUses"><span class="hs-identifier hs-type">computeKernelUses</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-805"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#FreeIn"><span class="hs-identifier hs-type">FreeIn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684538629"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-806"></span><span>  </span><span class="annot"><a href="#local-6989586621684538629"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-807"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-808"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#CallKernelGen"><span class="hs-identifier hs-type">CallKernelGen</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.GPU.html#KernelUse"><span class="hs-identifier hs-type">Imp.KernelUse</span></a></span><span class="hs-special">]</span></span><span>
</span><span id="line-809"></span><span id="computeKernelUses"><span class="annot"><span class="annottext">computeKernelUses :: forall a. FreeIn a =&gt; a -&gt; [VName] -&gt; CallKernelGen [KernelUse]
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#computeKernelUses"><span class="hs-identifier hs-var hs-var">computeKernelUses</span></a></span></span><span> </span><span id="local-6989586621684536811"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684536811"><span class="hs-identifier hs-var">kernel_body</span></a></span></span><span> </span><span id="local-6989586621684536810"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684536810"><span class="hs-identifier hs-var">bound_in_kernel</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-810"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684536809"><span class="annot"><span class="annottext">actually_free :: Names
</span><a href="#local-6989586621684536809"><span class="hs-identifier hs-var hs-var">actually_free</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; Names
forall a. FreeIn a =&gt; a -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#freeIn"><span class="hs-identifier hs-var">freeIn</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684536811"><span class="hs-identifier hs-var">kernel_body</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#namesSubtract"><span class="hs-operator hs-var">`namesSubtract`</span></a></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#namesFromList"><span class="hs-identifier hs-var">namesFromList</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684536810"><span class="hs-identifier hs-var">bound_in_kernel</span></a></span><span>
</span><span id="line-811"></span><span>  </span><span class="hs-comment">-- Compute the variables that we need to pass to the kernel.</span><span>
</span><span id="line-812"></span><span>  </span><span class="annot"><span class="annottext">[KernelUse] -&gt; [KernelUse]
forall a. Ord a =&gt; [a] -&gt; [a]
</span><a href="Futhark.Util.html#nubOrd"><span class="hs-identifier hs-var">nubOrd</span></a></span><span> </span><span class="annot"><span class="annottext">([KernelUse] -&gt; [KernelUse])
-&gt; CallKernelGen [KernelUse] -&gt; CallKernelGen [KernelUse]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Names -&gt; CallKernelGen [KernelUse]
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#readsFromSet"><span class="hs-identifier hs-var">readsFromSet</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684536809"><span class="hs-identifier hs-var">actually_free</span></a></span><span>
</span><span id="line-813"></span><span>
</span><span id="line-814"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#readsFromSet"><span class="hs-identifier hs-type">readsFromSet</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#CallKernelGen"><span class="hs-identifier hs-type">CallKernelGen</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.GPU.html#KernelUse"><span class="hs-identifier hs-type">Imp.KernelUse</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-815"></span><span id="readsFromSet"><span class="annot"><span class="annottext">readsFromSet :: Names -&gt; CallKernelGen [KernelUse]
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#readsFromSet"><span class="hs-identifier hs-var hs-var">readsFromSet</span></a></span></span><span> </span><span id="local-6989586621684536804"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684536804"><span class="hs-identifier hs-var">free</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-816"></span><span>  </span><span class="annot"><span class="annottext">([Maybe KernelUse] -&gt; [KernelUse])
-&gt; ImpM GPUMem HostEnv HostOp [Maybe KernelUse]
-&gt; CallKernelGen [KernelUse]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">[Maybe KernelUse] -&gt; [KernelUse]
forall a. [Maybe a] -&gt; [a]
</span><span class="hs-identifier hs-var">catMaybes</span></span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem HostEnv HostOp [Maybe KernelUse]
 -&gt; CallKernelGen [KernelUse])
-&gt; ImpM GPUMem HostEnv HostOp [Maybe KernelUse]
-&gt; CallKernelGen [KernelUse]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-817"></span><span>    </span><span class="annot"><span class="annottext">[VName]
-&gt; (VName -&gt; ImpM GPUMem HostEnv HostOp (Maybe KernelUse))
-&gt; ImpM GPUMem HostEnv HostOp [Maybe KernelUse]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Names -&gt; [VName]
</span><a href="Futhark.IR.Prop.Names.html#namesToList"><span class="hs-identifier hs-var">namesToList</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684536804"><span class="hs-identifier hs-var">free</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((VName -&gt; ImpM GPUMem HostEnv HostOp (Maybe KernelUse))
 -&gt; ImpM GPUMem HostEnv HostOp [Maybe KernelUse])
-&gt; (VName -&gt; ImpM GPUMem HostEnv HostOp (Maybe KernelUse))
-&gt; ImpM GPUMem HostEnv HostOp [Maybe KernelUse]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684536800"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536800"><span class="hs-identifier hs-var">var</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-818"></span><span>      </span><span id="local-6989586621684536799"><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness
</span><a href="#local-6989586621684536799"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; ImpM GPUMem HostEnv HostOp (TypeBase Shape NoUniqueness)
forall rep (m :: * -&gt; *).
HasScope rep m =&gt;
VName -&gt; m (TypeBase Shape NoUniqueness)
</span><a href="Futhark.IR.Prop.Scope.html#lookupType"><span class="hs-identifier hs-var">lookupType</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536800"><span class="hs-identifier hs-var">var</span></a></span><span>
</span><span id="line-819"></span><span>      </span><span id="local-6989586621684536797"><span class="annot"><span class="annottext">VTable GPUMem
</span><a href="#local-6989586621684536797"><span class="hs-identifier hs-var">vtable</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ImpM GPUMem HostEnv HostOp (VTable GPUMem)
forall rep r op. ImpM rep r op (VTable rep)
</span><a href="Futhark.CodeGen.ImpGen.html#getVTable"><span class="hs-identifier hs-var">getVTable</span></a></span><span>
</span><span id="line-820"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness
</span><a href="#local-6989586621684536799"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-821"></span><span>        </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe KernelUse -&gt; ImpM GPUMem HostEnv HostOp (Maybe KernelUse)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe KernelUse
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-822"></span><span>        </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Acc"><span class="hs-identifier hs-type">Acc</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe KernelUse -&gt; ImpM GPUMem HostEnv HostOp (Maybe KernelUse)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe KernelUse
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-823"></span><span>        </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Mem"><span class="hs-identifier hs-type">Mem</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;local&quot;</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe KernelUse -&gt; ImpM GPUMem HostEnv HostOp (Maybe KernelUse)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe KernelUse
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-824"></span><span>        </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Mem"><span class="hs-identifier hs-type">Mem</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe KernelUse -&gt; ImpM GPUMem HostEnv HostOp (Maybe KernelUse)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe KernelUse -&gt; ImpM GPUMem HostEnv HostOp (Maybe KernelUse))
-&gt; Maybe KernelUse -&gt; ImpM GPUMem HostEnv HostOp (Maybe KernelUse)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KernelUse -&gt; Maybe KernelUse
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(KernelUse -&gt; Maybe KernelUse) -&gt; KernelUse -&gt; Maybe KernelUse
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; KernelUse
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#MemoryUse"><span class="hs-identifier hs-var">Imp.MemoryUse</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536800"><span class="hs-identifier hs-var">var</span></a></span><span>
</span><span id="line-825"></span><span>        </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-type">Prim</span></a></span><span> </span><span id="local-6989586621684536792"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684536792"><span class="hs-identifier hs-var">bt</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-826"></span><span>          </span><span class="annot"><span class="annottext">VTable GPUMem
-&gt; PrimExp VName
-&gt; ImpM GPUMem HostEnv HostOp (Maybe KernelConstExp)
forall rep r op.
VTable GPUMem
-&gt; PrimExp VName -&gt; ImpM rep r op (Maybe KernelConstExp)
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#isConstExp"><span class="hs-identifier hs-var">isConstExp</span></a></span><span> </span><span class="annot"><span class="annottext">VTable GPUMem
</span><a href="#local-6989586621684536797"><span class="hs-identifier hs-var">vtable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; PrimExp VName
</span><a href="Futhark.CodeGen.ImpCode.html#var"><span class="hs-identifier hs-var">Imp.var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536800"><span class="hs-identifier hs-var">var</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684536792"><span class="hs-identifier hs-var">bt</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ImpM GPUMem HostEnv HostOp (Maybe KernelConstExp)
-&gt; (Maybe KernelConstExp
    -&gt; ImpM GPUMem HostEnv HostOp (Maybe KernelUse))
-&gt; ImpM GPUMem HostEnv HostOp (Maybe KernelUse)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-827"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684536790"><span class="annot"><span class="annottext">KernelConstExp
</span><a href="#local-6989586621684536790"><span class="hs-identifier hs-var">ce</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe KernelUse -&gt; ImpM GPUMem HostEnv HostOp (Maybe KernelUse)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe KernelUse -&gt; ImpM GPUMem HostEnv HostOp (Maybe KernelUse))
-&gt; Maybe KernelUse -&gt; ImpM GPUMem HostEnv HostOp (Maybe KernelUse)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KernelUse -&gt; Maybe KernelUse
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(KernelUse -&gt; Maybe KernelUse) -&gt; KernelUse -&gt; Maybe KernelUse
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; KernelConstExp -&gt; KernelUse
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#ConstUse"><span class="hs-identifier hs-var">Imp.ConstUse</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536800"><span class="hs-identifier hs-var">var</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstExp
</span><a href="#local-6989586621684536790"><span class="hs-identifier hs-var">ce</span></a></span><span>
</span><span id="line-828"></span><span>            </span><span class="annot"><span class="annottext">Maybe KernelConstExp
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe KernelUse -&gt; ImpM GPUMem HostEnv HostOp (Maybe KernelUse)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe KernelUse -&gt; ImpM GPUMem HostEnv HostOp (Maybe KernelUse))
-&gt; Maybe KernelUse -&gt; ImpM GPUMem HostEnv HostOp (Maybe KernelUse)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KernelUse -&gt; Maybe KernelUse
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(KernelUse -&gt; Maybe KernelUse) -&gt; KernelUse -&gt; Maybe KernelUse
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; KernelUse
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#ScalarUse"><span class="hs-identifier hs-var">Imp.ScalarUse</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536800"><span class="hs-identifier hs-var">var</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684536792"><span class="hs-identifier hs-var">bt</span></a></span><span>
</span><span id="line-829"></span><span>
</span><span id="line-830"></span><span id="local-6989586621684538609"><span id="local-6989586621684538610"><span id="local-6989586621684538611"><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#isConstExp"><span class="hs-identifier hs-type">isConstExp</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-831"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#VTable"><span class="hs-identifier hs-type">VTable</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-832"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#Exp"><span class="hs-identifier hs-type">Imp.Exp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-833"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684538611"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684538610"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684538609"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.GPU.html#KernelConstExp"><span class="hs-identifier hs-type">Imp.KernelConstExp</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-834"></span><span id="isConstExp"><span class="annot"><span class="annottext">isConstExp :: forall rep r op.
VTable GPUMem
-&gt; PrimExp VName -&gt; ImpM rep r op (Maybe KernelConstExp)
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#isConstExp"><span class="hs-identifier hs-var hs-var">isConstExp</span></a></span></span><span> </span><span id="local-6989586621684536777"><span class="annot"><span class="annottext">VTable GPUMem
</span><a href="#local-6989586621684536777"><span class="hs-identifier hs-var">vtable</span></a></span></span><span> </span><span id="local-6989586621684536776"><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684536776"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-835"></span><span>  </span><span id="local-6989586621684536775"><span class="annot"><span class="annottext">Maybe Name
</span><a href="#local-6989586621684536775"><span class="hs-identifier hs-var">fname</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ImpM rep r op (Maybe Name)
forall rep r op. ImpM rep r op (Maybe Name)
</span><a href="Futhark.CodeGen.ImpGen.html#askFunction"><span class="hs-identifier hs-var">askFunction</span></a></span><span>
</span><span id="line-836"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684536773"><span class="annot"><span class="annottext">onLeaf :: VName -&gt; PrimType -&gt; Maybe KernelConstExp
</span><a href="#local-6989586621684536773"><span class="hs-identifier hs-var hs-var">onLeaf</span></a></span></span><span> </span><span id="local-6989586621684536772"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536772"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Maybe KernelConstExp
</span><a href="#local-6989586621684536771"><span class="hs-identifier hs-var">lookupConstExp</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536772"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-837"></span><span>      </span><span id="local-6989586621684536771"><span class="annot"><span class="annottext">lookupConstExp :: VName -&gt; Maybe KernelConstExp
</span><a href="#local-6989586621684536771"><span class="hs-identifier hs-var hs-var">lookupConstExp</span></a></span></span><span> </span><span id="local-6989586621684536770"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536770"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-838"></span><span>        </span><span class="annot"><span class="annottext">Exp GPUMem -&gt; Maybe KernelConstExp
</span><a href="#local-6989586621684536769"><span class="hs-identifier hs-var">constExp</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp GPUMem -&gt; Maybe KernelConstExp)
-&gt; Maybe (Exp GPUMem) -&gt; Maybe KernelConstExp
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">VarEntry GPUMem -&gt; Maybe (Exp GPUMem)
forall {rep}. VarEntry rep -&gt; Maybe (Exp rep)
</span><a href="#local-6989586621684536768"><span class="hs-identifier hs-var">hasExp</span></a></span><span> </span><span class="annot"><span class="annottext">(VarEntry GPUMem -&gt; Maybe (Exp GPUMem))
-&gt; Maybe (VarEntry GPUMem) -&gt; Maybe (Exp GPUMem)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; VTable GPUMem -&gt; Maybe (VarEntry GPUMem)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536770"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">VTable GPUMem
</span><a href="#local-6989586621684536777"><span class="hs-identifier hs-var">vtable</span></a></span><span>
</span><span id="line-839"></span><span>      </span><span id="local-6989586621684536769"><span class="annot"><span class="annottext">constExp :: Exp GPUMem -&gt; Maybe KernelConstExp
</span><a href="#local-6989586621684536769"><span class="hs-identifier hs-var hs-var">constExp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SizeOp"><span class="hs-identifier hs-type">SizeOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#GetSize"><span class="hs-identifier hs-type">GetSize</span></a></span><span> </span><span id="local-6989586621684536766"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684536766"><span class="hs-identifier hs-var">key</span></a></span></span><span> </span><span class="annot"><span class="annottext">SizeClass
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-840"></span><span>        </span><span class="annot"><span class="annottext">KernelConstExp -&gt; Maybe KernelConstExp
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(KernelConstExp -&gt; Maybe KernelConstExp)
-&gt; KernelConstExp -&gt; Maybe KernelConstExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KernelConst -&gt; PrimType -&gt; KernelConstExp
forall v. v -&gt; PrimType -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#LeafExp"><span class="hs-identifier hs-var">LeafExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; KernelConst
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#SizeConst"><span class="hs-identifier hs-var">Imp.SizeConst</span></a></span><span> </span><span class="annot"><span class="annottext">(Name -&gt; KernelConst) -&gt; Name -&gt; KernelConst
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe Name -&gt; Name -&gt; Name
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#keyWithEntryPoint"><span class="hs-identifier hs-var">keyWithEntryPoint</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Name
</span><a href="#local-6989586621684536775"><span class="hs-identifier hs-var">fname</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684536766"><span class="hs-identifier hs-var">key</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int32"><span class="hs-identifier hs-var">int32</span></a></span><span>
</span><span id="line-841"></span><span>      </span><span class="annot"><a href="#local-6989586621684536769"><span class="hs-identifier hs-var">constExp</span></a></span><span> </span><span id="local-6989586621684536763"><span class="annot"><span class="annottext">Exp GPUMem
</span><a href="#local-6989586621684536763"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Maybe KernelConstExp)
-&gt; Exp GPUMem -&gt; Maybe KernelConstExp
forall (m :: * -&gt; *) rep v.
(MonadFail m, RepTypes rep) =&gt;
(VName -&gt; m (PrimExp v)) -&gt; Exp rep -&gt; m (PrimExp v)
</span><a href="Futhark.Analysis.PrimExp.Convert.html#primExpFromExp"><span class="hs-identifier hs-var">primExpFromExp</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Maybe KernelConstExp
</span><a href="#local-6989586621684536771"><span class="hs-identifier hs-var">lookupConstExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp GPUMem
</span><a href="#local-6989586621684536763"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-842"></span><span>  </span><span class="annot"><span class="annottext">Maybe KernelConstExp -&gt; ImpM rep r op (Maybe KernelConstExp)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe KernelConstExp -&gt; ImpM rep r op (Maybe KernelConstExp))
-&gt; Maybe KernelConstExp -&gt; ImpM rep r op (Maybe KernelConstExp)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; PrimType -&gt; Maybe KernelConstExp)
-&gt; PrimExp VName -&gt; Maybe KernelConstExp
forall (m :: * -&gt; *) a b.
Monad m =&gt;
(a -&gt; PrimType -&gt; m (PrimExp b)) -&gt; PrimExp a -&gt; m (PrimExp b)
</span><a href="Futhark.Analysis.PrimExp.Convert.html#replaceInPrimExpM"><span class="hs-identifier hs-var">replaceInPrimExpM</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; Maybe KernelConstExp
</span><a href="#local-6989586621684536773"><span class="hs-identifier hs-var">onLeaf</span></a></span><span> </span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684536776"><span class="hs-identifier hs-var">size</span></a></span><span>
</span><span id="line-843"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-844"></span><span>    </span><span id="local-6989586621684536768"><span class="annot"><span class="annottext">hasExp :: VarEntry rep -&gt; Maybe (Exp rep)
</span><a href="#local-6989586621684536768"><span class="hs-identifier hs-var hs-var">hasExp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ArrayVar"><span class="hs-identifier hs-type">ArrayVar</span></a></span><span> </span><span id="local-6989586621684536759"><span class="annot"><span class="annottext">Maybe (Exp rep)
</span><a href="#local-6989586621684536759"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="annot"><span class="annottext">ArrayEntry
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep)
</span><a href="#local-6989586621684536759"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-845"></span><span>    </span><span class="annot"><a href="#local-6989586621684536768"><span class="hs-identifier hs-var">hasExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#AccVar"><span class="hs-identifier hs-type">AccVar</span></a></span><span> </span><span id="local-6989586621684536757"><span class="annot"><span class="annottext">Maybe (Exp rep)
</span><a href="#local-6989586621684536757"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="annot"><span class="annottext">(VName, Shape, [TypeBase Shape NoUniqueness])
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep)
</span><a href="#local-6989586621684536757"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-846"></span><span>    </span><span class="annot"><a href="#local-6989586621684536768"><span class="hs-identifier hs-var">hasExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ScalarVar"><span class="hs-identifier hs-type">ScalarVar</span></a></span><span> </span><span id="local-6989586621684536755"><span class="annot"><span class="annottext">Maybe (Exp rep)
</span><a href="#local-6989586621684536755"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="annot"><span class="annottext">ScalarEntry
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep)
</span><a href="#local-6989586621684536755"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-847"></span><span>    </span><span class="annot"><a href="#local-6989586621684536768"><span class="hs-identifier hs-var">hasExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemVar"><span class="hs-identifier hs-type">MemVar</span></a></span><span> </span><span id="local-6989586621684536753"><span class="annot"><span class="annottext">Maybe (Exp rep)
</span><a href="#local-6989586621684536753"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="annot"><span class="annottext">MemEntry
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep)
</span><a href="#local-6989586621684536753"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-848"></span><span>
</span><span id="line-849"></span><span id="local-6989586621684538867"><span id="local-6989586621684538868"><span id="local-6989586621684538869"><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#computeThreadChunkSize"><span class="hs-identifier hs-type">computeThreadChunkSize</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-850"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#SplitOrdering"><span class="hs-identifier hs-type">SplitOrdering</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-851"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-852"></span><span>  </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-type">Imp.Count</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#Elements"><span class="hs-identifier hs-type">Imp.Elements</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-853"></span><span>  </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-type">Imp.Count</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#Elements"><span class="hs-identifier hs-type">Imp.Elements</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-854"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#TV"><span class="hs-identifier hs-type">TV</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-855"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684538869"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684538868"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684538867"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-856"></span><span id="computeThreadChunkSize"><span class="annot"><span class="annottext">computeThreadChunkSize :: forall rep r op.
SplitOrdering
-&gt; TExp Int64
-&gt; Count Elements (TExp Int64)
-&gt; Count Elements (TExp Int64)
-&gt; TV Int64
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#computeThreadChunkSize"><span class="hs-identifier hs-var hs-var">computeThreadChunkSize</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#SplitStrided"><span class="hs-identifier hs-type">SplitStrided</span></a></span><span> </span><span id="local-6989586621684536736"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684536736"><span class="hs-identifier hs-var">stride</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684536735"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536735"><span class="hs-identifier hs-var">thread_index</span></a></span></span><span> </span><span id="local-6989586621684536734"><span class="annot"><span class="annottext">Count Elements (TExp Int64)
</span><a href="#local-6989586621684536734"><span class="hs-identifier hs-var">elements_per_thread</span></a></span></span><span> </span><span id="local-6989586621684536733"><span class="annot"><span class="annottext">Count Elements (TExp Int64)
</span><a href="#local-6989586621684536733"><span class="hs-identifier hs-var">num_elements</span></a></span></span><span> </span><span id="local-6989586621684536732"><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684536732"><span class="hs-identifier hs-var">chunk_var</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-857"></span><span>  </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684536732"><span class="hs-identifier hs-var">chunk_var</span></a></span><span>
</span><span id="line-858"></span><span>    </span><span class="annot"><span class="annottext">TV Int64 -&gt; TExp Int64 -&gt; ImpM rep r op ()
forall t rep r op. TV t -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#%3C--"><span class="hs-operator hs-var">&lt;--</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall v. TPrimExp Int64 v -&gt; TPrimExp Int64 v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sMin64"><span class="hs-identifier hs-var">sMin64</span></a></span><span>
</span><span id="line-859"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Count Elements (TExp Int64) -&gt; TExp Int64
forall u e. Count u e -&gt; e
</span><a href="Futhark.IR.GPU.Sizes.html#unCount"><span class="hs-identifier hs-var hs-var">Imp.unCount</span></a></span><span> </span><span class="annot"><span class="annottext">Count Elements (TExp Int64)
</span><a href="#local-6989586621684536734"><span class="hs-identifier hs-var">elements_per_thread</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-860"></span><span>      </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Count Elements (TExp Int64) -&gt; TExp Int64
forall u e. Count u e -&gt; e
</span><a href="Futhark.IR.GPU.Sizes.html#unCount"><span class="hs-identifier hs-var hs-var">Imp.unCount</span></a></span><span> </span><span class="annot"><span class="annottext">Count Elements (TExp Int64)
</span><a href="#local-6989586621684536733"><span class="hs-identifier hs-var">num_elements</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536735"><span class="hs-identifier hs-var">thread_index</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall e. IntegralExp e =&gt; e -&gt; e -&gt; e
</span><a href="Futhark.Util.IntegralExp.html#divUp"><span class="hs-operator hs-var">`divUp`</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684536736"><span class="hs-identifier hs-var">stride</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-861"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#computeThreadChunkSize"><span class="hs-identifier hs-var">computeThreadChunkSize</span></a></span><span> </span><span class="annot"><span class="annottext">SplitOrdering
</span><a href="Futhark.IR.SegOp.html#SplitContiguous"><span class="hs-identifier hs-var">SplitContiguous</span></a></span><span> </span><span id="local-6989586621684536729"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536729"><span class="hs-identifier hs-var">thread_index</span></a></span></span><span> </span><span id="local-6989586621684536728"><span class="annot"><span class="annottext">Count Elements (TExp Int64)
</span><a href="#local-6989586621684536728"><span class="hs-identifier hs-var">elements_per_thread</span></a></span></span><span> </span><span id="local-6989586621684536727"><span class="annot"><span class="annottext">Count Elements (TExp Int64)
</span><a href="#local-6989586621684536727"><span class="hs-identifier hs-var">num_elements</span></a></span></span><span> </span><span id="local-6989586621684536726"><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684536726"><span class="hs-identifier hs-var">chunk_var</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-862"></span><span>  </span><span id="local-6989586621684536725"><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684536725"><span class="hs-identifier hs-var">starting_point</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-863"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; TExp Int64 -&gt; ImpM rep r op (TV Int64)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV"><span class="hs-identifier hs-var">dPrimV</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;starting_point&quot;</span></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; ImpM rep r op (TV Int64))
-&gt; TExp Int64 -&gt; ImpM rep r op (TV Int64)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-864"></span><span>      </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536729"><span class="hs-identifier hs-var">thread_index</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Count Elements (TExp Int64) -&gt; TExp Int64
forall u e. Count u e -&gt; e
</span><a href="Futhark.IR.GPU.Sizes.html#unCount"><span class="hs-identifier hs-var hs-var">Imp.unCount</span></a></span><span> </span><span class="annot"><span class="annottext">Count Elements (TExp Int64)
</span><a href="#local-6989586621684536728"><span class="hs-identifier hs-var">elements_per_thread</span></a></span><span>
</span><span id="line-865"></span><span>  </span><span id="local-6989586621684536724"><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684536724"><span class="hs-identifier hs-var">remaining_elements</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-866"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; TExp Int64 -&gt; ImpM rep r op (TV Int64)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV"><span class="hs-identifier hs-var">dPrimV</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;remaining_elements&quot;</span></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; ImpM rep r op (TV Int64))
-&gt; TExp Int64 -&gt; ImpM rep r op (TV Int64)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-867"></span><span>      </span><span class="annot"><span class="annottext">Count Elements (TExp Int64) -&gt; TExp Int64
forall u e. Count u e -&gt; e
</span><a href="Futhark.IR.GPU.Sizes.html#unCount"><span class="hs-identifier hs-var hs-var">Imp.unCount</span></a></span><span> </span><span class="annot"><span class="annottext">Count Elements (TExp Int64)
</span><a href="#local-6989586621684536727"><span class="hs-identifier hs-var">num_elements</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">TV Int64 -&gt; TExp Int64
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684536725"><span class="hs-identifier hs-var">starting_point</span></a></span><span>
</span><span id="line-868"></span><span>
</span><span id="line-869"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684536723"><span class="annot"><span class="annottext">no_remaining_elements :: TExp Bool
</span><a href="#local-6989586621684536723"><span class="hs-identifier hs-var hs-var">no_remaining_elements</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TV Int64 -&gt; TExp Int64
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684536724"><span class="hs-identifier hs-var">remaining_elements</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Bool
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3C%3D."><span class="hs-operator hs-var">.&lt;=.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><span class="hs-number">0</span></span><span>
</span><span id="line-870"></span><span>      </span><span id="local-6989586621684536721"><span class="annot"><span class="annottext">beyond_bounds :: TExp Bool
</span><a href="#local-6989586621684536721"><span class="hs-identifier hs-var hs-var">beyond_bounds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Count Elements (TExp Int64) -&gt; TExp Int64
forall u e. Count u e -&gt; e
</span><a href="Futhark.IR.GPU.Sizes.html#unCount"><span class="hs-identifier hs-var hs-var">Imp.unCount</span></a></span><span> </span><span class="annot"><span class="annottext">Count Elements (TExp Int64)
</span><a href="#local-6989586621684536727"><span class="hs-identifier hs-var">num_elements</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Bool
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3C%3D."><span class="hs-operator hs-var">.&lt;=.</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64 -&gt; TExp Int64
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684536725"><span class="hs-identifier hs-var">starting_point</span></a></span><span>
</span><span id="line-871"></span><span>
</span><span id="line-872"></span><span>  </span><span class="annot"><span class="annottext">TExp Bool
-&gt; ImpM rep r op () -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
forall rep r op.
TExp Bool
-&gt; ImpM rep r op () -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sIf"><span class="hs-identifier hs-var">sIf</span></a></span><span>
</span><span id="line-873"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684536723"><span class="hs-identifier hs-var">no_remaining_elements</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool -&gt; TExp Bool -&gt; TExp Bool
forall v. TPrimExp Bool v -&gt; TPrimExp Bool v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%7C%7C."><span class="hs-operator hs-var">.||.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684536721"><span class="hs-identifier hs-var">beyond_bounds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-874"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684536726"><span class="hs-identifier hs-var">chunk_var</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64 -&gt; TExp Int64 -&gt; ImpM rep r op ()
forall t rep r op. TV t -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#%3C--"><span class="hs-operator hs-var">&lt;--</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-875"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">TExp Bool
-&gt; ImpM rep r op () -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
forall rep r op.
TExp Bool
-&gt; ImpM rep r op () -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sIf"><span class="hs-identifier hs-var">sIf</span></a></span><span>
</span><span id="line-876"></span><span>        </span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684536718"><span class="hs-identifier hs-var">is_last_thread</span></a></span><span>
</span><span id="line-877"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684536726"><span class="hs-identifier hs-var">chunk_var</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64 -&gt; TExp Int64 -&gt; ImpM rep r op ()
forall t rep r op. TV t -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#%3C--"><span class="hs-operator hs-var">&lt;--</span></a></span><span> </span><span class="annot"><span class="annottext">Count Elements (TExp Int64) -&gt; TExp Int64
forall u e. Count u e -&gt; e
</span><a href="Futhark.IR.GPU.Sizes.html#unCount"><span class="hs-identifier hs-var hs-var">Imp.unCount</span></a></span><span> </span><span class="annot"><span class="annottext">Count Elements (TExp Int64)
</span><a href="#local-6989586621684536717"><span class="hs-identifier hs-var">last_thread_elements</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-878"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684536726"><span class="hs-identifier hs-var">chunk_var</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64 -&gt; TExp Int64 -&gt; ImpM rep r op ()
forall t rep r op. TV t -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#%3C--"><span class="hs-operator hs-var">&lt;--</span></a></span><span> </span><span class="annot"><span class="annottext">Count Elements (TExp Int64) -&gt; TExp Int64
forall u e. Count u e -&gt; e
</span><a href="Futhark.IR.GPU.Sizes.html#unCount"><span class="hs-identifier hs-var hs-var">Imp.unCount</span></a></span><span> </span><span class="annot"><span class="annottext">Count Elements (TExp Int64)
</span><a href="#local-6989586621684536728"><span class="hs-identifier hs-var">elements_per_thread</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-879"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-880"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-881"></span><span>    </span><span id="local-6989586621684536717"><span class="annot"><span class="annottext">last_thread_elements :: Count Elements (TExp Int64)
</span><a href="#local-6989586621684536717"><span class="hs-identifier hs-var hs-var">last_thread_elements</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-882"></span><span>      </span><span class="annot"><span class="annottext">Count Elements (TExp Int64)
</span><a href="#local-6989586621684536727"><span class="hs-identifier hs-var">num_elements</span></a></span><span> </span><span class="annot"><span class="annottext">Count Elements (TExp Int64)
-&gt; Count Elements (TExp Int64) -&gt; Count Elements (TExp Int64)
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; Count Elements (TExp Int64)
forall a. a -&gt; Count Elements a
</span><a href="Futhark.CodeGen.ImpCode.html#elements"><span class="hs-identifier hs-var">Imp.elements</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536729"><span class="hs-identifier hs-var">thread_index</span></a></span><span> </span><span class="annot"><span class="annottext">Count Elements (TExp Int64)
-&gt; Count Elements (TExp Int64) -&gt; Count Elements (TExp Int64)
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Count Elements (TExp Int64)
</span><a href="#local-6989586621684536728"><span class="hs-identifier hs-var">elements_per_thread</span></a></span><span>
</span><span id="line-883"></span><span>    </span><span id="local-6989586621684536718"><span class="annot"><span class="annottext">is_last_thread :: TExp Bool
</span><a href="#local-6989586621684536718"><span class="hs-identifier hs-var hs-var">is_last_thread</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-884"></span><span>      </span><span class="annot"><span class="annottext">Count Elements (TExp Int64) -&gt; TExp Int64
forall u e. Count u e -&gt; e
</span><a href="Futhark.IR.GPU.Sizes.html#unCount"><span class="hs-identifier hs-var hs-var">Imp.unCount</span></a></span><span> </span><span class="annot"><span class="annottext">Count Elements (TExp Int64)
</span><a href="#local-6989586621684536727"><span class="hs-identifier hs-var">num_elements</span></a></span><span>
</span><span id="line-885"></span><span>        </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Bool
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3C."><span class="hs-operator hs-var">.&lt;.</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536729"><span class="hs-identifier hs-var">thread_index</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Count Elements (TExp Int64) -&gt; TExp Int64
forall u e. Count u e -&gt; e
</span><a href="Futhark.IR.GPU.Sizes.html#unCount"><span class="hs-identifier hs-var hs-var">Imp.unCount</span></a></span><span> </span><span class="annot"><span class="annottext">Count Elements (TExp Int64)
</span><a href="#local-6989586621684536728"><span class="hs-identifier hs-var">elements_per_thread</span></a></span><span>
</span><span id="line-886"></span><span>
</span><span id="line-887"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelInitialisationSimple"><span class="hs-identifier hs-type">kernelInitialisationSimple</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-888"></span><span>  </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-type">Count</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#NumGroups"><span class="hs-identifier hs-type">NumGroups</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-889"></span><span>  </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-type">Count</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#GroupSize"><span class="hs-identifier hs-type">GroupSize</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-890"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#CallKernelGen"><span class="hs-identifier hs-type">CallKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#KernelConstants"><span class="hs-identifier hs-type">KernelConstants</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#InKernelGen"><span class="hs-identifier hs-type">InKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-891"></span><span id="kernelInitialisationSimple"><span class="annot"><span class="annottext">kernelInitialisationSimple :: Count NumGroups (TExp Int64)
-&gt; Count GroupSize (TExp Int64)
-&gt; CallKernelGen (KernelConstants, InKernelGen ())
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelInitialisationSimple"><span class="hs-identifier hs-var hs-var">kernelInitialisationSimple</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-type">Count</span></a></span><span> </span><span id="local-6989586621684536713"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536713"><span class="hs-identifier hs-var">num_groups</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-type">Count</span></a></span><span> </span><span id="local-6989586621684536712"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536712"><span class="hs-identifier hs-var">group_size</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-892"></span><span>  </span><span id="local-6989586621684536711"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536711"><span class="hs-identifier hs-var">global_tid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; ImpM GPUMem HostEnv HostOp VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; String -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;global_tid&quot;</span></span><span>
</span><span id="line-893"></span><span>  </span><span id="local-6989586621684536710"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536710"><span class="hs-identifier hs-var">local_tid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; ImpM GPUMem HostEnv HostOp VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; String -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;local_tid&quot;</span></span><span>
</span><span id="line-894"></span><span>  </span><span id="local-6989586621684536709"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536709"><span class="hs-identifier hs-var">group_id</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; ImpM GPUMem HostEnv HostOp VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; String -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;group_tid&quot;</span></span><span>
</span><span id="line-895"></span><span>  </span><span id="local-6989586621684536708"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536708"><span class="hs-identifier hs-var">wave_size</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; ImpM GPUMem HostEnv HostOp VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; String -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;wave_size&quot;</span></span><span>
</span><span id="line-896"></span><span>  </span><span id="local-6989586621684536707"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536707"><span class="hs-identifier hs-var">inner_group_size</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; ImpM GPUMem HostEnv HostOp VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; String -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;group_size&quot;</span></span><span>
</span><span id="line-897"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684536706"><span class="annot"><span class="annottext">constants :: KernelConstants
</span><a href="#local-6989586621684536706"><span class="hs-identifier hs-var hs-var">constants</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-898"></span><span>        </span><span class="annot"><span class="annottext">TExp Int32
-&gt; TExp Int32
-&gt; TExp Int32
-&gt; VName
-&gt; VName
-&gt; VName
-&gt; TExp Int64
-&gt; TExp Int64
-&gt; TExp Int32
-&gt; TExp Int32
-&gt; TExp Bool
-&gt; Map [SubExp] [TExp Int32]
-&gt; KernelConstants
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#KernelConstants"><span class="hs-identifier hs-var">KernelConstants</span></a></span><span>
</span><span id="line-899"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; TExp Int32
forall a. a -&gt; TPrimExp Int32 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le32"><span class="hs-identifier hs-var">Imp.le32</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536711"><span class="hs-identifier hs-var">global_tid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-900"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; TExp Int32
forall a. a -&gt; TPrimExp Int32 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le32"><span class="hs-identifier hs-var">Imp.le32</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536710"><span class="hs-identifier hs-var">local_tid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-901"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; TExp Int32
forall a. a -&gt; TPrimExp Int32 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le32"><span class="hs-identifier hs-var">Imp.le32</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536709"><span class="hs-identifier hs-var">group_id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-902"></span><span>          </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536711"><span class="hs-identifier hs-var">global_tid</span></a></span><span>
</span><span id="line-903"></span><span>          </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536710"><span class="hs-identifier hs-var">local_tid</span></a></span><span>
</span><span id="line-904"></span><span>          </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536709"><span class="hs-identifier hs-var">group_id</span></a></span><span>
</span><span id="line-905"></span><span>          </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536713"><span class="hs-identifier hs-var">num_groups</span></a></span><span>
</span><span id="line-906"></span><span>          </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536712"><span class="hs-identifier hs-var">group_size</span></a></span><span>
</span><span id="line-907"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int32
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int32 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt32"><span class="hs-identifier hs-var">sExt32</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536712"><span class="hs-identifier hs-var">group_size</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536713"><span class="hs-identifier hs-var">num_groups</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-908"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; TExp Int32
forall a. a -&gt; TPrimExp Int32 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le32"><span class="hs-identifier hs-var">Imp.le32</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536708"><span class="hs-identifier hs-var">wave_size</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-909"></span><span>          </span><span class="annot"><span class="annottext">TExp Bool
forall v. TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#true"><span class="hs-identifier hs-var">true</span></a></span><span>
</span><span id="line-910"></span><span>          </span><span class="annot"><span class="annottext">Map [SubExp] [TExp Int32]
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-911"></span><span>
</span><span id="line-912"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684536704"><span class="annot"><span class="annottext">set_constants :: InKernelGen ()
</span><a href="#local-6989586621684536704"><span class="hs-identifier hs-var hs-var">set_constants</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-913"></span><span>        </span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; InKernelGen ()
forall rep r op. VName -&gt; PrimType -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dPrim_"><span class="hs-identifier hs-var">dPrim_</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536711"><span class="hs-identifier hs-var">global_tid</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int32"><span class="hs-identifier hs-var">int32</span></a></span><span>
</span><span id="line-914"></span><span>        </span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; InKernelGen ()
forall rep r op. VName -&gt; PrimType -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dPrim_"><span class="hs-identifier hs-var">dPrim_</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536710"><span class="hs-identifier hs-var">local_tid</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int32"><span class="hs-identifier hs-var">int32</span></a></span><span>
</span><span id="line-915"></span><span>        </span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; InKernelGen ()
forall rep r op. VName -&gt; PrimType -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dPrim_"><span class="hs-identifier hs-var">dPrim_</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536707"><span class="hs-identifier hs-var">inner_group_size</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int64"><span class="hs-identifier hs-var">int64</span></a></span><span>
</span><span id="line-916"></span><span>        </span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; InKernelGen ()
forall rep r op. VName -&gt; PrimType -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dPrim_"><span class="hs-identifier hs-var">dPrim_</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536708"><span class="hs-identifier hs-var">wave_size</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int32"><span class="hs-identifier hs-var">int32</span></a></span><span>
</span><span id="line-917"></span><span>        </span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; InKernelGen ()
forall rep r op. VName -&gt; PrimType -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dPrim_"><span class="hs-identifier hs-var">dPrim_</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536709"><span class="hs-identifier hs-var">group_id</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int32"><span class="hs-identifier hs-var">int32</span></a></span><span>
</span><span id="line-918"></span><span>
</span><span id="line-919"></span><span>        </span><span class="annot"><span class="annottext">KernelOp -&gt; InKernelGen ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Int -&gt; KernelOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#GetGlobalId"><span class="hs-identifier hs-var">Imp.GetGlobalId</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536711"><span class="hs-identifier hs-var">global_tid</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-920"></span><span>        </span><span class="annot"><span class="annottext">KernelOp -&gt; InKernelGen ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Int -&gt; KernelOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#GetLocalId"><span class="hs-identifier hs-var">Imp.GetLocalId</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536710"><span class="hs-identifier hs-var">local_tid</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-921"></span><span>        </span><span class="annot"><span class="annottext">KernelOp -&gt; InKernelGen ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Int -&gt; KernelOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#GetLocalSize"><span class="hs-identifier hs-var">Imp.GetLocalSize</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536707"><span class="hs-identifier hs-var">inner_group_size</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-922"></span><span>        </span><span class="annot"><span class="annottext">KernelOp -&gt; InKernelGen ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; KernelOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#GetLockstepWidth"><span class="hs-identifier hs-var">Imp.GetLockstepWidth</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536708"><span class="hs-identifier hs-var">wave_size</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-923"></span><span>        </span><span class="annot"><span class="annottext">KernelOp -&gt; InKernelGen ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Int -&gt; KernelOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#GetGroupId"><span class="hs-identifier hs-var">Imp.GetGroupId</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536709"><span class="hs-identifier hs-var">group_id</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-924"></span><span>
</span><span id="line-925"></span><span>  </span><span class="annot"><span class="annottext">(KernelConstants, InKernelGen ())
-&gt; CallKernelGen (KernelConstants, InKernelGen ())
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684536706"><span class="hs-identifier hs-var">constants</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684536704"><span class="hs-identifier hs-var">set_constants</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-926"></span><span>
</span><span id="line-927"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#isActive"><span class="hs-identifier hs-type">isActive</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-928"></span><span id="isActive"><span class="annot"><span class="annottext">isActive :: [(VName, SubExp)] -&gt; TExp Bool
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#isActive"><span class="hs-identifier hs-var hs-var">isActive</span></a></span></span><span> </span><span id="local-6989586621684536698"><span class="annot"><span class="annottext">[(VName, SubExp)]
</span><a href="#local-6989586621684536698"><span class="hs-identifier hs-var">limit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[TExp Bool]
</span><a href="#local-6989586621684536697"><span class="hs-identifier hs-var">actives</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-929"></span><span>  </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TExp Bool
forall v. TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#true"><span class="hs-identifier hs-var">true</span></a></span><span>
</span><span id="line-930"></span><span>  </span><span id="local-6989586621684536696"><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684536696"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684536695"><span class="annot"><span class="annottext">[TExp Bool]
</span><a href="#local-6989586621684536695"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(TExp Bool -&gt; TExp Bool -&gt; TExp Bool)
-&gt; TExp Bool -&gt; [TExp Bool] -&gt; TExp Bool
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl</span></span><span> </span><span class="annot"><span class="annottext">TExp Bool -&gt; TExp Bool -&gt; TExp Bool
forall v. TPrimExp Bool v -&gt; TPrimExp Bool v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%26%26."><span class="hs-operator hs-var">(.&amp;&amp;.)</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684536696"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Bool]
</span><a href="#local-6989586621684536695"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-931"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-932"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684536692"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684536692"><span class="hs-identifier hs-var">is</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684536691"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684536691"><span class="hs-identifier hs-var">ws</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VName, SubExp)] -&gt; ([VName], [SubExp])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">[(VName, SubExp)]
</span><a href="#local-6989586621684536698"><span class="hs-identifier hs-var">limit</span></a></span><span>
</span><span id="line-933"></span><span>    </span><span id="local-6989586621684536697"><span class="annot"><span class="annottext">actives :: [TExp Bool]
</span><a href="#local-6989586621684536697"><span class="hs-identifier hs-var hs-var">actives</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; TExp Int64 -&gt; TExp Bool)
-&gt; [VName] -&gt; [TExp Int64] -&gt; [TExp Bool]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TExp Int64 -&gt; TExp Bool
forall {v}. v -&gt; TPrimExp Int64 v -&gt; TPrimExp Bool v
</span><a href="#local-6989586621684536689"><span class="hs-identifier hs-var">active</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684536692"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">([TExp Int64] -&gt; [TExp Bool]) -&gt; [TExp Int64] -&gt; [TExp Bool]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684536691"><span class="hs-identifier hs-var">ws</span></a></span><span>
</span><span id="line-934"></span><span>    </span><span id="local-6989586621684536689"><span class="annot"><span class="annottext">active :: v -&gt; TPrimExp Int64 v -&gt; TPrimExp Bool v
</span><a href="#local-6989586621684536689"><span class="hs-identifier hs-var hs-var">active</span></a></span></span><span> </span><span id="local-6989586621684536688"><span class="annot"><span class="annottext">v
</span><a href="#local-6989586621684536688"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">v -&gt; TPrimExp Int64 v
forall a. a -&gt; TPrimExp Int64 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le64"><span class="hs-identifier hs-var">Imp.le64</span></a></span><span> </span><span class="annot"><span class="annottext">v
</span><a href="#local-6989586621684536688"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 v -&gt; TPrimExp Int64 v -&gt; TPrimExp Bool v
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3C."><span class="hs-operator hs-var">.&lt;.</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-935"></span><span>
</span><span id="line-936"></span><span class="hs-comment">-- | Change every memory block to be in the global address space,</span><span>
</span><span id="line-937"></span><span class="hs-comment">-- except those who are in the local memory space.  This only affects</span><span>
</span><span id="line-938"></span><span class="hs-comment">-- generated code - we still need to make sure that the memory is</span><span>
</span><span id="line-939"></span><span class="hs-comment">-- actually present on the device (and dared as variables in the</span><span>
</span><span id="line-940"></span><span class="hs-comment">-- kernel).</span><span>
</span><span id="line-941"></span><span id="local-6989586621684538574"><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#makeAllMemoryGlobal"><span class="hs-identifier hs-type">makeAllMemoryGlobal</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#CallKernelGen"><span class="hs-identifier hs-type">CallKernelGen</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684538574"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#CallKernelGen"><span class="hs-identifier hs-type">CallKernelGen</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684538574"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-942"></span><span id="makeAllMemoryGlobal"><span class="annot"><span class="annottext">makeAllMemoryGlobal :: forall a. CallKernelGen a -&gt; CallKernelGen a
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#makeAllMemoryGlobal"><span class="hs-identifier hs-var hs-var">makeAllMemoryGlobal</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-943"></span><span>  </span><span class="annot"><span class="annottext">Space
-&gt; ImpM GPUMem HostEnv HostOp a -&gt; ImpM GPUMem HostEnv HostOp a
forall rep r op a. Space -&gt; ImpM rep r op a -&gt; ImpM rep r op a
</span><a href="Futhark.CodeGen.ImpGen.html#localDefaultSpace"><span class="hs-identifier hs-var">localDefaultSpace</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Space
</span><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-var">Imp.Space</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;global&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem HostEnv HostOp a -&gt; ImpM GPUMem HostEnv HostOp a)
-&gt; (ImpM GPUMem HostEnv HostOp a -&gt; ImpM GPUMem HostEnv HostOp a)
-&gt; ImpM GPUMem HostEnv HostOp a
-&gt; ImpM GPUMem HostEnv HostOp a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(VTable GPUMem -&gt; VTable GPUMem)
-&gt; ImpM GPUMem HostEnv HostOp a -&gt; ImpM GPUMem HostEnv HostOp a
forall rep r op a.
(VTable rep -&gt; VTable rep) -&gt; ImpM rep r op a -&gt; ImpM rep r op a
</span><a href="Futhark.CodeGen.ImpGen.html#localVTable"><span class="hs-identifier hs-var">localVTable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(VarEntry GPUMem -&gt; VarEntry GPUMem)
-&gt; VTable GPUMem -&gt; VTable GPUMem
forall a b k. (a -&gt; b) -&gt; Map k a -&gt; Map k b
</span><span class="hs-identifier hs-var">M.map</span></span><span> </span><span class="annot"><span class="annottext">VarEntry GPUMem -&gt; VarEntry GPUMem
forall {rep}. VarEntry rep -&gt; VarEntry rep
</span><a href="#local-6989586621684536683"><span class="hs-identifier hs-var">globalMemory</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-944"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-945"></span><span>    </span><span id="local-6989586621684536683"><span class="annot"><span class="annottext">globalMemory :: VarEntry rep -&gt; VarEntry rep
</span><a href="#local-6989586621684536683"><span class="hs-identifier hs-var hs-var">globalMemory</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemVar"><span class="hs-identifier hs-type">MemVar</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684536681"><span class="annot"><span class="annottext">MemEntry
</span><a href="#local-6989586621684536681"><span class="hs-identifier hs-var">entry</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-946"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">MemEntry -&gt; Space
</span><a href="Futhark.CodeGen.ImpGen.html#entryMemSpace"><span class="hs-identifier hs-var hs-var">entryMemSpace</span></a></span><span> </span><span class="annot"><span class="annottext">MemEntry
</span><a href="#local-6989586621684536681"><span class="hs-identifier hs-var">entry</span></a></span><span> </span><span class="annot"><span class="annottext">Space -&gt; Space -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Space
</span><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-var">Space</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;local&quot;</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-947"></span><span>        </span><span class="annot"><span class="annottext">Maybe (Exp rep) -&gt; MemEntry -&gt; VarEntry rep
forall rep. Maybe (Exp rep) -&gt; MemEntry -&gt; VarEntry rep
</span><a href="Futhark.CodeGen.ImpGen.html#MemVar"><span class="hs-identifier hs-var">MemVar</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">MemEntry
</span><a href="#local-6989586621684536681"><span class="hs-identifier hs-var">entry</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">entryMemSpace :: Space
</span><a href="Futhark.CodeGen.ImpGen.html#entryMemSpace"><span class="hs-identifier hs-var">entryMemSpace</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Space
</span><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-var">Imp.Space</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;global&quot;</span></span><span class="hs-special">}</span><span>
</span><span id="line-948"></span><span>    </span><span class="annot"><a href="#local-6989586621684536683"><span class="hs-identifier hs-var">globalMemory</span></a></span><span> </span><span id="local-6989586621684536679"><span class="annot"><span class="annottext">VarEntry rep
</span><a href="#local-6989586621684536679"><span class="hs-identifier hs-var">entry</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-949"></span><span>      </span><span class="annot"><span class="annottext">VarEntry rep
</span><a href="#local-6989586621684536679"><span class="hs-identifier hs-var">entry</span></a></span><span>
</span><span id="line-950"></span><span>
</span><span id="line-951"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#groupReduce"><span class="hs-identifier hs-type">groupReduce</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-952"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-953"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-954"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-955"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#InKernelGen"><span class="hs-identifier hs-type">InKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-956"></span><span id="groupReduce"><span class="annot"><span class="annottext">groupReduce :: TExp Int32 -&gt; Lambda GPUMem -&gt; [VName] -&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#groupReduce"><span class="hs-identifier hs-var hs-var">groupReduce</span></a></span></span><span> </span><span id="local-6989586621684536678"><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536678"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684536677"><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684536677"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span id="local-6989586621684536676"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684536676"><span class="hs-identifier hs-var">arrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-957"></span><span>  </span><span id="local-6989586621684536675"><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684536675"><span class="hs-identifier hs-var">offset</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; PrimType -&gt; ImpM GPUMem KernelEnv KernelOp (TV Int32)
forall rep r op t. String -&gt; PrimType -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrim"><span class="hs-identifier hs-var">dPrim</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;offset&quot;</span></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int32"><span class="hs-identifier hs-var">int32</span></a></span><span>
</span><span id="line-958"></span><span>  </span><span class="annot"><span class="annottext">TV Int32
-&gt; TExp Int32 -&gt; Lambda GPUMem -&gt; [VName] -&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#groupReduceWithOffset"><span class="hs-identifier hs-var">groupReduceWithOffset</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684536675"><span class="hs-identifier hs-var">offset</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536678"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684536677"><span class="hs-identifier hs-var">lam</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684536676"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-959"></span><span>
</span><span id="line-960"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#groupReduceWithOffset"><span class="hs-identifier hs-type">groupReduceWithOffset</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-961"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#TV"><span class="hs-identifier hs-type">TV</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-962"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-963"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-964"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-965"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#InKernelGen"><span class="hs-identifier hs-type">InKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-966"></span><span id="groupReduceWithOffset"><span class="annot"><span class="annottext">groupReduceWithOffset :: TV Int32
-&gt; TExp Int32 -&gt; Lambda GPUMem -&gt; [VName] -&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#groupReduceWithOffset"><span class="hs-identifier hs-var hs-var">groupReduceWithOffset</span></a></span></span><span> </span><span id="local-6989586621684536673"><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684536673"><span class="hs-identifier hs-var">offset</span></a></span></span><span> </span><span id="local-6989586621684536672"><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536672"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684536671"><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684536671"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span id="local-6989586621684536670"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684536670"><span class="hs-identifier hs-var">arrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-967"></span><span>  </span><span id="local-6989586621684536669"><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684536669"><span class="hs-identifier hs-var">constants</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">KernelEnv -&gt; KernelConstants
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelConstants"><span class="hs-identifier hs-var hs-var">kernelConstants</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelEnv -&gt; KernelConstants)
-&gt; ImpM GPUMem KernelEnv KernelOp KernelEnv
-&gt; ImpM GPUMem KernelEnv KernelOp KernelConstants
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ImpM GPUMem KernelEnv KernelOp KernelEnv
forall rep r op. ImpM rep r op r
</span><a href="Futhark.CodeGen.ImpGen.html#askEnv"><span class="hs-identifier hs-var">askEnv</span></a></span><span>
</span><span id="line-968"></span><span>
</span><span id="line-969"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684536668"><span class="annot"><span class="annottext">local_tid :: TExp Int32
</span><a href="#local-6989586621684536668"><span class="hs-identifier hs-var hs-var">local_tid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelLocalThreadId"><span class="hs-identifier hs-var hs-var">kernelLocalThreadId</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684536669"><span class="hs-identifier hs-var">constants</span></a></span><span>
</span><span id="line-970"></span><span>      </span><span id="local-6989586621684536667"><span class="annot"><span class="annottext">global_tid :: TExp Int32
</span><a href="#local-6989586621684536667"><span class="hs-identifier hs-var hs-var">global_tid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelGlobalThreadId"><span class="hs-identifier hs-var hs-var">kernelGlobalThreadId</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684536669"><span class="hs-identifier hs-var">constants</span></a></span><span>
</span><span id="line-971"></span><span>
</span><span id="line-972"></span><span>      </span><span id="local-6989586621684536666"><span class="annot"><span class="annottext">barrier :: InKernelGen ()
</span><a href="#local-6989586621684536666"><span class="hs-identifier hs-var hs-var">barrier</span></a></span></span><span>
</span><span id="line-973"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">(TypeBase Shape NoUniqueness -&gt; Bool)
-&gt; [TypeBase Shape NoUniqueness] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness -&gt; Bool
forall shape u. TypeBase shape u -&gt; Bool
</span><a href="Futhark.IR.Prop.Types.html#primType"><span class="hs-identifier hs-var">primType</span></a></span><span> </span><span class="annot"><span class="annottext">([TypeBase Shape NoUniqueness] -&gt; Bool)
-&gt; [TypeBase Shape NoUniqueness] -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem -&gt; [TypeBase Shape NoUniqueness]
forall rep. LambdaT rep -&gt; [TypeBase Shape NoUniqueness]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684536671"><span class="hs-identifier hs-var">lam</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">KernelOp -&gt; InKernelGen ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelOp -&gt; InKernelGen ()) -&gt; KernelOp -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Fence -&gt; KernelOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#Barrier"><span class="hs-identifier hs-var">Imp.Barrier</span></a></span><span> </span><span class="annot"><span class="annottext">Fence
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#FenceLocal"><span class="hs-identifier hs-var">Imp.FenceLocal</span></a></span><span>
</span><span id="line-974"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">KernelOp -&gt; InKernelGen ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelOp -&gt; InKernelGen ()) -&gt; KernelOp -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Fence -&gt; KernelOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#Barrier"><span class="hs-identifier hs-var">Imp.Barrier</span></a></span><span> </span><span class="annot"><span class="annottext">Fence
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#FenceGlobal"><span class="hs-identifier hs-var">Imp.FenceGlobal</span></a></span><span>
</span><span id="line-975"></span><span>
</span><span id="line-976"></span><span>      </span><span id="local-6989586621684536664"><span class="annot"><span class="annottext">readReduceArgument :: Param LParamMem -&gt; VName -&gt; InKernelGen ()
</span><a href="#local-6989586621684536664"><span class="hs-identifier hs-var hs-var">readReduceArgument</span></a></span></span><span> </span><span id="local-6989586621684536663"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536663"><span class="hs-identifier hs-var">param</span></a></span></span><span> </span><span id="local-6989586621684536662"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536662"><span class="hs-identifier hs-var">arr</span></a></span></span><span>
</span><span id="line-977"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-type">Prim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Param LParamMem -&gt; TypeBase Shape NoUniqueness
forall dec. Typed dec =&gt; Param dec -&gt; TypeBase Shape NoUniqueness
</span><a href="Futhark.IR.Prop.Patterns.html#paramType"><span class="hs-identifier hs-var">paramType</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536663"><span class="hs-identifier hs-var">param</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-978"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684536660"><span class="annot"><span class="annottext">i :: TExp Int32
</span><a href="#local-6989586621684536660"><span class="hs-identifier hs-var hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536668"><span class="hs-identifier hs-var">local_tid</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TV Int32 -&gt; TExp Int32
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684536673"><span class="hs-identifier hs-var">offset</span></a></span><span>
</span><span id="line-979"></span><span>          </span><span class="annot"><span class="annottext">VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; InKernelGen ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536663"><span class="hs-identifier hs-var">param</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536662"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int64
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536660"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-980"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-981"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684536659"><span class="annot"><span class="annottext">i :: TExp Int32
</span><a href="#local-6989586621684536659"><span class="hs-identifier hs-var hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536667"><span class="hs-identifier hs-var">global_tid</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TV Int32 -&gt; TExp Int32
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684536673"><span class="hs-identifier hs-var">offset</span></a></span><span>
</span><span id="line-982"></span><span>          </span><span class="annot"><span class="annottext">VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; InKernelGen ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536663"><span class="hs-identifier hs-var">param</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536662"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int64
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536659"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-983"></span><span>
</span><span id="line-984"></span><span>      </span><span id="local-6989586621684536658"><span class="annot"><span class="annottext">writeReduceOpResult :: Param LParamMem -&gt; VName -&gt; InKernelGen ()
</span><a href="#local-6989586621684536658"><span class="hs-identifier hs-var hs-var">writeReduceOpResult</span></a></span></span><span> </span><span id="local-6989586621684536657"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536657"><span class="hs-identifier hs-var">param</span></a></span></span><span> </span><span id="local-6989586621684536656"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536656"><span class="hs-identifier hs-var">arr</span></a></span></span><span>
</span><span id="line-985"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-type">Prim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Param LParamMem -&gt; TypeBase Shape NoUniqueness
forall dec. Typed dec =&gt; Param dec -&gt; TypeBase Shape NoUniqueness
</span><a href="Futhark.IR.Prop.Patterns.html#paramType"><span class="hs-identifier hs-var">paramType</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536657"><span class="hs-identifier hs-var">param</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-986"></span><span>          </span><span class="annot"><span class="annottext">VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; InKernelGen ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536656"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int64
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536668"><span class="hs-identifier hs-var">local_tid</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SubExp) -&gt; VName -&gt; SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536657"><span class="hs-identifier hs-var">param</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-987"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-988"></span><span>          </span><span class="annot"><span class="annottext">() -&gt; InKernelGen ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-989"></span><span>
</span><span id="line-990"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684536655"><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684536655"><span class="hs-identifier hs-var">reduce_acc_params</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684536654"><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684536654"><span class="hs-identifier hs-var">reduce_arr_params</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Param LParamMem] -&gt; ([Param LParamMem], [Param LParamMem])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684536670"><span class="hs-identifier hs-var">arrs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Param LParamMem] -&gt; ([Param LParamMem], [Param LParamMem]))
-&gt; [Param LParamMem] -&gt; ([Param LParamMem], [Param LParamMem])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem -&gt; [LParam GPUMem]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684536671"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-991"></span><span>
</span><span id="line-992"></span><span>  </span><span id="local-6989586621684536653"><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684536653"><span class="hs-identifier hs-var">skip_waves</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; TExp Int32 -&gt; ImpM GPUMem KernelEnv KernelOp (TV Int32)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV"><span class="hs-identifier hs-var">dPrimV</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;skip_waves&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span class="hs-special">)</span><span>
</span><span id="line-993"></span><span>  </span><span class="annot"><span class="annottext">[LParam GPUMem] -&gt; InKernelGen ()
forall rep inner r op.
Mem rep inner =&gt;
[LParam rep] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dLParams"><span class="hs-identifier hs-var">dLParams</span></a></span><span> </span><span class="annot"><span class="annottext">([LParam GPUMem] -&gt; InKernelGen ())
-&gt; [LParam GPUMem] -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem -&gt; [LParam GPUMem]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684536671"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-994"></span><span>
</span><span id="line-995"></span><span>  </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684536673"><span class="hs-identifier hs-var">offset</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32 -&gt; TExp Int32 -&gt; InKernelGen ()
forall t rep r op. TV t -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#%3C--"><span class="hs-operator hs-var">&lt;--</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span class="hs-special">)</span><span>
</span><span id="line-996"></span><span>
</span><span id="line-997"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#comment"><span class="hs-identifier hs-var">comment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;participating threads read initial accumulator&quot;</span></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-998"></span><span>    </span><span class="annot"><span class="annottext">TExp Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536668"><span class="hs-identifier hs-var">local_tid</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3C."><span class="hs-operator hs-var">.&lt;.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536672"><span class="hs-identifier hs-var">w</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-999"></span><span>      </span><span class="annot"><span class="annottext">(Param LParamMem -&gt; VName -&gt; InKernelGen ())
-&gt; [Param LParamMem] -&gt; [VName] -&gt; InKernelGen ()
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m ()
</span><span class="hs-identifier hs-var">zipWithM_</span></span><span> </span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName -&gt; InKernelGen ()
</span><a href="#local-6989586621684536664"><span class="hs-identifier hs-var">readReduceArgument</span></a></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684536655"><span class="hs-identifier hs-var">reduce_acc_params</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684536670"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-1000"></span><span>
</span><span id="line-1001"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684536651"><span class="annot"><span class="annottext">do_reduce :: InKernelGen ()
</span><a href="#local-6989586621684536651"><span class="hs-identifier hs-var hs-var">do_reduce</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1002"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#comment"><span class="hs-identifier hs-var">comment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;read array element&quot;</span></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1003"></span><span>          </span><span class="annot"><span class="annottext">(Param LParamMem -&gt; VName -&gt; InKernelGen ())
-&gt; [Param LParamMem] -&gt; [VName] -&gt; InKernelGen ()
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m ()
</span><span class="hs-identifier hs-var">zipWithM_</span></span><span> </span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName -&gt; InKernelGen ()
</span><a href="#local-6989586621684536664"><span class="hs-identifier hs-var">readReduceArgument</span></a></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684536654"><span class="hs-identifier hs-var">reduce_arr_params</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684536670"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-1004"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#comment"><span class="hs-identifier hs-var">comment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;apply reduction operation&quot;</span></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1005"></span><span>          </span><span class="annot"><span class="annottext">[Param LParamMem] -&gt; BodyT GPUMem -&gt; InKernelGen ()
forall dec rep r op. [Param dec] -&gt; Body rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileBody%27"><span class="hs-identifier hs-var">compileBody'</span></a></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684536655"><span class="hs-identifier hs-var">reduce_acc_params</span></a></span><span> </span><span class="annot"><span class="annottext">(BodyT GPUMem -&gt; InKernelGen ()) -&gt; BodyT GPUMem -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem -&gt; BodyT GPUMem
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684536671"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-1006"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#comment"><span class="hs-identifier hs-var">comment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;write result of operation&quot;</span></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1007"></span><span>          </span><span class="annot"><span class="annottext">(Param LParamMem -&gt; VName -&gt; InKernelGen ())
-&gt; [Param LParamMem] -&gt; [VName] -&gt; InKernelGen ()
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m ()
</span><span class="hs-identifier hs-var">zipWithM_</span></span><span> </span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName -&gt; InKernelGen ()
</span><a href="#local-6989586621684536658"><span class="hs-identifier hs-var">writeReduceOpResult</span></a></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684536655"><span class="hs-identifier hs-var">reduce_acc_params</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684536670"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-1008"></span><span>      </span><span id="local-6989586621684536650"><span class="annot"><span class="annottext">in_wave_reduce :: InKernelGen ()
</span><a href="#local-6989586621684536650"><span class="hs-identifier hs-var hs-var">in_wave_reduce</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InKernelGen () -&gt; InKernelGen ()
forall rep r op a. ImpM rep r op a -&gt; ImpM rep r op a
</span><a href="Futhark.CodeGen.ImpGen.html#everythingVolatile"><span class="hs-identifier hs-var">everythingVolatile</span></a></span><span> </span><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684536651"><span class="hs-identifier hs-var">do_reduce</span></a></span><span>
</span><span id="line-1009"></span><span>
</span><span id="line-1010"></span><span>      </span><span id="local-6989586621684536649"><span class="annot"><span class="annottext">wave_size :: TExp Int32
</span><a href="#local-6989586621684536649"><span class="hs-identifier hs-var hs-var">wave_size</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelWaveSize"><span class="hs-identifier hs-var hs-var">kernelWaveSize</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684536669"><span class="hs-identifier hs-var">constants</span></a></span><span>
</span><span id="line-1011"></span><span>      </span><span id="local-6989586621684536648"><span class="annot"><span class="annottext">group_size :: TExp Int64
</span><a href="#local-6989586621684536648"><span class="hs-identifier hs-var hs-var">group_size</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelGroupSize"><span class="hs-identifier hs-var hs-var">kernelGroupSize</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684536669"><span class="hs-identifier hs-var">constants</span></a></span><span>
</span><span id="line-1012"></span><span>      </span><span id="local-6989586621684536647"><span class="annot"><span class="annottext">wave_id :: TExp Int32
</span><a href="#local-6989586621684536647"><span class="hs-identifier hs-var hs-var">wave_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536668"><span class="hs-identifier hs-var">local_tid</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall e. IntegralExp e =&gt; e -&gt; e -&gt; e
</span><a href="Futhark.Util.IntegralExp.html#quot"><span class="hs-operator hs-var">`quot`</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536649"><span class="hs-identifier hs-var">wave_size</span></a></span><span>
</span><span id="line-1013"></span><span>      </span><span id="local-6989586621684536646"><span class="annot"><span class="annottext">in_wave_id :: TExp Int32
</span><a href="#local-6989586621684536646"><span class="hs-identifier hs-var hs-var">in_wave_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536668"><span class="hs-identifier hs-var">local_tid</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536647"><span class="hs-identifier hs-var">wave_id</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536649"><span class="hs-identifier hs-var">wave_size</span></a></span><span>
</span><span id="line-1014"></span><span>      </span><span id="local-6989586621684536645"><span class="annot"><span class="annottext">num_waves :: TExp Int32
</span><a href="#local-6989586621684536645"><span class="hs-identifier hs-var hs-var">num_waves</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int32
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int32 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt32"><span class="hs-identifier hs-var">sExt32</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536648"><span class="hs-identifier hs-var">group_size</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536649"><span class="hs-identifier hs-var">wave_size</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall e. IntegralExp e =&gt; e -&gt; e -&gt; e
</span><a href="Futhark.Util.IntegralExp.html#quot"><span class="hs-operator hs-var">`quot`</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536649"><span class="hs-identifier hs-var">wave_size</span></a></span><span>
</span><span id="line-1015"></span><span>      </span><span id="local-6989586621684536644"><span class="annot"><span class="annottext">arg_in_bounds :: TExp Bool
</span><a href="#local-6989586621684536644"><span class="hs-identifier hs-var hs-var">arg_in_bounds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536668"><span class="hs-identifier hs-var">local_tid</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TV Int32 -&gt; TExp Int32
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684536673"><span class="hs-identifier hs-var">offset</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3C."><span class="hs-operator hs-var">.&lt;.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536672"><span class="hs-identifier hs-var">w</span></a></span><span>
</span><span id="line-1016"></span><span>
</span><span id="line-1017"></span><span>      </span><span id="local-6989586621684536643"><span class="annot"><span class="annottext">doing_in_wave_reductions :: TExp Bool
</span><a href="#local-6989586621684536643"><span class="hs-identifier hs-var hs-var">doing_in_wave_reductions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1018"></span><span>        </span><span class="annot"><span class="annottext">TV Int32 -&gt; TExp Int32
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684536673"><span class="hs-identifier hs-var">offset</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3C."><span class="hs-operator hs-var">.&lt;.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536649"><span class="hs-identifier hs-var">wave_size</span></a></span><span>
</span><span id="line-1019"></span><span>      </span><span id="local-6989586621684536642"><span class="annot"><span class="annottext">apply_in_in_wave_iteration :: TExp Bool
</span><a href="#local-6989586621684536642"><span class="hs-identifier hs-var hs-var">apply_in_in_wave_iteration</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1020"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536646"><span class="hs-identifier hs-var">in_wave_id</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp t v
</span><a href="Futhark.Analysis.PrimExp.html#.%26."><span class="hs-operator hs-var">.&amp;.</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">2</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TV Int32 -&gt; TExp Int32
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684536673"><span class="hs-identifier hs-var">offset</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3D%3D."><span class="hs-operator hs-var">.==.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">0</span></span><span>
</span><span id="line-1021"></span><span>      </span><span id="local-6989586621684536640"><span class="annot"><span class="annottext">in_wave_reductions :: InKernelGen ()
</span><a href="#local-6989586621684536640"><span class="hs-identifier hs-var hs-var">in_wave_reductions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1022"></span><span>        </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684536673"><span class="hs-identifier hs-var">offset</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32 -&gt; TExp Int32 -&gt; InKernelGen ()
forall t rep r op. TV t -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#%3C--"><span class="hs-operator hs-var">&lt;--</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span class="hs-special">)</span><span>
</span><span id="line-1023"></span><span>        </span><span class="annot"><span class="annottext">TExp Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhile"><span class="hs-identifier hs-var">sWhile</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684536643"><span class="hs-identifier hs-var">doing_in_wave_reductions</span></a></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1024"></span><span>          </span><span class="annot"><span class="annottext">TExp Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span>
</span><span id="line-1025"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684536644"><span class="hs-identifier hs-var">arg_in_bounds</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool -&gt; TExp Bool -&gt; TExp Bool
forall v. TPrimExp Bool v -&gt; TPrimExp Bool v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%26%26."><span class="hs-operator hs-var">.&amp;&amp;.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684536642"><span class="hs-identifier hs-var">apply_in_in_wave_iteration</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1026"></span><span>            </span><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684536650"><span class="hs-identifier hs-var">in_wave_reduce</span></a></span><span>
</span><span id="line-1027"></span><span>          </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684536673"><span class="hs-identifier hs-var">offset</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32 -&gt; TExp Int32 -&gt; InKernelGen ()
forall t rep r op. TV t -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#%3C--"><span class="hs-operator hs-var">&lt;--</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32 -&gt; TExp Int32
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684536673"><span class="hs-identifier hs-var">offset</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">2</span></span><span>
</span><span id="line-1028"></span><span>
</span><span id="line-1029"></span><span>      </span><span id="local-6989586621684536639"><span class="annot"><span class="annottext">doing_cross_wave_reductions :: TExp Bool
</span><a href="#local-6989586621684536639"><span class="hs-identifier hs-var hs-var">doing_cross_wave_reductions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1030"></span><span>        </span><span class="annot"><span class="annottext">TV Int32 -&gt; TExp Int32
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684536653"><span class="hs-identifier hs-var">skip_waves</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3C."><span class="hs-operator hs-var">.&lt;.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536645"><span class="hs-identifier hs-var">num_waves</span></a></span><span>
</span><span id="line-1031"></span><span>      </span><span id="local-6989586621684536638"><span class="annot"><span class="annottext">is_first_thread_in_wave :: TExp Bool
</span><a href="#local-6989586621684536638"><span class="hs-identifier hs-var hs-var">is_first_thread_in_wave</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1032"></span><span>        </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536646"><span class="hs-identifier hs-var">in_wave_id</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3D%3D."><span class="hs-operator hs-var">.==.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">0</span></span><span>
</span><span id="line-1033"></span><span>      </span><span id="local-6989586621684536637"><span class="annot"><span class="annottext">wave_not_skipped :: TExp Bool
</span><a href="#local-6989586621684536637"><span class="hs-identifier hs-var hs-var">wave_not_skipped</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1034"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536647"><span class="hs-identifier hs-var">wave_id</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp t v
</span><a href="Futhark.Analysis.PrimExp.html#.%26."><span class="hs-operator hs-var">.&amp;.</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">2</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TV Int32 -&gt; TExp Int32
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684536653"><span class="hs-identifier hs-var">skip_waves</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3D%3D."><span class="hs-operator hs-var">.==.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">0</span></span><span>
</span><span id="line-1035"></span><span>      </span><span id="local-6989586621684536636"><span class="annot"><span class="annottext">apply_in_cross_wave_iteration :: TExp Bool
</span><a href="#local-6989586621684536636"><span class="hs-identifier hs-var hs-var">apply_in_cross_wave_iteration</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1036"></span><span>        </span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684536644"><span class="hs-identifier hs-var">arg_in_bounds</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool -&gt; TExp Bool -&gt; TExp Bool
forall v. TPrimExp Bool v -&gt; TPrimExp Bool v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%26%26."><span class="hs-operator hs-var">.&amp;&amp;.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684536638"><span class="hs-identifier hs-var">is_first_thread_in_wave</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool -&gt; TExp Bool -&gt; TExp Bool
forall v. TPrimExp Bool v -&gt; TPrimExp Bool v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%26%26."><span class="hs-operator hs-var">.&amp;&amp;.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684536637"><span class="hs-identifier hs-var">wave_not_skipped</span></a></span><span>
</span><span id="line-1037"></span><span>      </span><span id="local-6989586621684536635"><span class="annot"><span class="annottext">cross_wave_reductions :: InKernelGen ()
</span><a href="#local-6989586621684536635"><span class="hs-identifier hs-var hs-var">cross_wave_reductions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1038"></span><span>        </span><span class="annot"><span class="annottext">TExp Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhile"><span class="hs-identifier hs-var">sWhile</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684536639"><span class="hs-identifier hs-var">doing_cross_wave_reductions</span></a></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1039"></span><span>          </span><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684536666"><span class="hs-identifier hs-var">barrier</span></a></span><span>
</span><span id="line-1040"></span><span>          </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684536673"><span class="hs-identifier hs-var">offset</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32 -&gt; TExp Int32 -&gt; InKernelGen ()
forall t rep r op. TV t -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#%3C--"><span class="hs-operator hs-var">&lt;--</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32 -&gt; TExp Int32
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684536653"><span class="hs-identifier hs-var">skip_waves</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536649"><span class="hs-identifier hs-var">wave_size</span></a></span><span>
</span><span id="line-1041"></span><span>          </span><span class="annot"><span class="annottext">TExp Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span>
</span><span id="line-1042"></span><span>            </span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684536636"><span class="hs-identifier hs-var">apply_in_cross_wave_iteration</span></a></span><span>
</span><span id="line-1043"></span><span>            </span><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684536651"><span class="hs-identifier hs-var">do_reduce</span></a></span><span>
</span><span id="line-1044"></span><span>          </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684536653"><span class="hs-identifier hs-var">skip_waves</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32 -&gt; TExp Int32 -&gt; InKernelGen ()
forall t rep r op. TV t -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#%3C--"><span class="hs-operator hs-var">&lt;--</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32 -&gt; TExp Int32
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684536653"><span class="hs-identifier hs-var">skip_waves</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">2</span></span><span>
</span><span id="line-1045"></span><span>
</span><span id="line-1046"></span><span>  </span><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684536640"><span class="hs-identifier hs-var">in_wave_reductions</span></a></span><span>
</span><span id="line-1047"></span><span>  </span><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684536635"><span class="hs-identifier hs-var">cross_wave_reductions</span></a></span><span>
</span><span id="line-1048"></span><span>
</span><span id="line-1049"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#groupScan"><span class="hs-identifier hs-type">groupScan</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1050"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1051"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1052"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1053"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1054"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1055"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#InKernelGen"><span class="hs-identifier hs-type">InKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1056"></span><span id="groupScan"><span class="annot"><span class="annottext">groupScan :: Maybe (TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool)
-&gt; TExp Int64
-&gt; TExp Int64
-&gt; Lambda GPUMem
-&gt; [VName]
-&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#groupScan"><span class="hs-identifier hs-var hs-var">groupScan</span></a></span></span><span> </span><span id="local-6989586621684536634"><span class="annot"><span class="annottext">Maybe (TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool)
</span><a href="#local-6989586621684536634"><span class="hs-identifier hs-var">seg_flag</span></a></span></span><span> </span><span id="local-6989586621684536633"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536633"><span class="hs-identifier hs-var">arrs_full_size</span></a></span></span><span> </span><span id="local-6989586621684536632"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536632"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684536631"><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684536631"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span id="local-6989586621684536630"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684536630"><span class="hs-identifier hs-var">arrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1057"></span><span>  </span><span id="local-6989586621684536629"><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684536629"><span class="hs-identifier hs-var">constants</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">KernelEnv -&gt; KernelConstants
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelConstants"><span class="hs-identifier hs-var hs-var">kernelConstants</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelEnv -&gt; KernelConstants)
-&gt; ImpM GPUMem KernelEnv KernelOp KernelEnv
-&gt; ImpM GPUMem KernelEnv KernelOp KernelConstants
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ImpM GPUMem KernelEnv KernelOp KernelEnv
forall rep r op. ImpM rep r op r
</span><a href="Futhark.CodeGen.ImpGen.html#askEnv"><span class="hs-identifier hs-var">askEnv</span></a></span><span>
</span><span id="line-1058"></span><span>  </span><span id="local-6989586621684536628"><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684536628"><span class="hs-identifier hs-var">renamed_lam</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem -&gt; ImpM GPUMem KernelEnv KernelOp (Lambda GPUMem)
forall rep (m :: * -&gt; *).
(Renameable rep, MonadFreshNames m) =&gt;
Lambda rep -&gt; m (Lambda rep)
</span><a href="Futhark.Transform.Rename.html#renameLambda"><span class="hs-identifier hs-var">renameLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684536631"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-1059"></span><span>
</span><span id="line-1060"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684536626"><span class="annot"><span class="annottext">ltid32 :: TExp Int32
</span><a href="#local-6989586621684536626"><span class="hs-identifier hs-var hs-var">ltid32</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelLocalThreadId"><span class="hs-identifier hs-var hs-var">kernelLocalThreadId</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684536629"><span class="hs-identifier hs-var">constants</span></a></span><span>
</span><span id="line-1061"></span><span>      </span><span id="local-6989586621684536625"><span class="annot"><span class="annottext">ltid :: TExp Int64
</span><a href="#local-6989586621684536625"><span class="hs-identifier hs-var hs-var">ltid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int64
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536626"><span class="hs-identifier hs-var">ltid32</span></a></span><span>
</span><span id="line-1062"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684536624"><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684536624"><span class="hs-identifier hs-var">x_params</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684536623"><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684536623"><span class="hs-identifier hs-var">y_params</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Param LParamMem] -&gt; ([Param LParamMem], [Param LParamMem])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684536630"><span class="hs-identifier hs-var">arrs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Param LParamMem] -&gt; ([Param LParamMem], [Param LParamMem]))
-&gt; [Param LParamMem] -&gt; ([Param LParamMem], [Param LParamMem])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem -&gt; [LParam GPUMem]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684536631"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-1063"></span><span>
</span><span id="line-1064"></span><span>  </span><span class="annot"><span class="annottext">[LParam GPUMem] -&gt; InKernelGen ()
forall rep inner r op.
Mem rep inner =&gt;
[LParam rep] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dLParams"><span class="hs-identifier hs-var">dLParams</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda GPUMem -&gt; [LParam GPUMem]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684536631"><span class="hs-identifier hs-var">lam</span></a></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem] -&gt; [Param LParamMem] -&gt; [Param LParamMem]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem -&gt; [LParam GPUMem]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684536628"><span class="hs-identifier hs-var">renamed_lam</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1065"></span><span>
</span><span id="line-1066"></span><span>  </span><span id="local-6989586621684536622"><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684536622"><span class="hs-identifier hs-var">ltid_in_bounds</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; TExp Bool -&gt; ImpM GPUMem KernelEnv KernelOp (TExp Bool)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TExp t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimVE"><span class="hs-identifier hs-var">dPrimVE</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ltid_in_bounds&quot;</span></span><span> </span><span class="annot"><span class="annottext">(TExp Bool -&gt; ImpM GPUMem KernelEnv KernelOp (TExp Bool))
-&gt; TExp Bool -&gt; ImpM GPUMem KernelEnv KernelOp (TExp Bool)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536625"><span class="hs-identifier hs-var">ltid</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Bool
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3C."><span class="hs-operator hs-var">.&lt;.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536632"><span class="hs-identifier hs-var">w</span></a></span><span>
</span><span id="line-1067"></span><span>
</span><span id="line-1068"></span><span>  </span><span id="local-6989586621684536620"><span class="annot"><span class="annottext">Fence
</span><a href="#local-6989586621684536620"><span class="hs-identifier hs-var">fence</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; InKernelGen Fence
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#fenceForArrays"><span class="hs-identifier hs-var">fenceForArrays</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684536630"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-1069"></span><span>
</span><span id="line-1070"></span><span>  </span><span class="hs-comment">-- The scan works by splitting the group into blocks, which are</span><span>
</span><span id="line-1071"></span><span>  </span><span class="hs-comment">-- scanned separately.  Typically, these blocks are smaller than</span><span>
</span><span id="line-1072"></span><span>  </span><span class="hs-comment">-- the lockstep width, which enables barrier-free execution inside</span><span>
</span><span id="line-1073"></span><span>  </span><span class="hs-comment">-- them.</span><span>
</span><span id="line-1074"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-1075"></span><span>  </span><span class="hs-comment">-- We hardcode the block size here.  The only requirement is that</span><span>
</span><span id="line-1076"></span><span>  </span><span class="hs-comment">-- it should not be less than the square root of the group size.</span><span>
</span><span id="line-1077"></span><span>  </span><span class="hs-comment">-- With 32, we will work on groups of size 1024 or smaller, which</span><span>
</span><span id="line-1078"></span><span>  </span><span class="hs-comment">-- fits every device Troels has seen.  Still, it would be nicer if</span><span>
</span><span id="line-1079"></span><span>  </span><span class="hs-comment">-- it were a runtime parameter.  Some day.</span><span>
</span><span id="line-1080"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684536618"><span class="annot"><span class="annottext">block_size :: TExp Int32
</span><a href="#local-6989586621684536618"><span class="hs-identifier hs-var hs-var">block_size</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">32</span></span><span>
</span><span id="line-1081"></span><span>      </span><span id="local-6989586621684536617"><span class="annot"><span class="annottext">simd_width :: TExp Int32
</span><a href="#local-6989586621684536617"><span class="hs-identifier hs-var hs-var">simd_width</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelWaveSize"><span class="hs-identifier hs-var hs-var">kernelWaveSize</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684536629"><span class="hs-identifier hs-var">constants</span></a></span><span>
</span><span id="line-1082"></span><span>      </span><span id="local-6989586621684536616"><span class="annot"><span class="annottext">block_id :: TExp Int32
</span><a href="#local-6989586621684536616"><span class="hs-identifier hs-var hs-var">block_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536626"><span class="hs-identifier hs-var">ltid32</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall e. IntegralExp e =&gt; e -&gt; e -&gt; e
</span><a href="Futhark.Util.IntegralExp.html#quot"><span class="hs-operator hs-var">`quot`</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536618"><span class="hs-identifier hs-var">block_size</span></a></span><span>
</span><span id="line-1083"></span><span>      </span><span id="local-6989586621684536615"><span class="annot"><span class="annottext">in_block_id :: TExp Int32
</span><a href="#local-6989586621684536615"><span class="hs-identifier hs-var hs-var">in_block_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536626"><span class="hs-identifier hs-var">ltid32</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536616"><span class="hs-identifier hs-var">block_id</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536618"><span class="hs-identifier hs-var">block_size</span></a></span><span>
</span><span id="line-1084"></span><span>      </span><span id="local-6989586621684536614"><span class="annot"><span class="annottext">doInBlockScan :: Maybe (TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool)
-&gt; TExp Bool -&gt; Lambda GPUMem -&gt; InKernelGen ()
</span><a href="#local-6989586621684536614"><span class="hs-identifier hs-var hs-var">doInBlockScan</span></a></span></span><span> </span><span id="local-6989586621684536613"><span class="annot"><span class="annottext">Maybe (TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool)
</span><a href="#local-6989586621684536613"><span class="hs-identifier hs-var">seg_flag'</span></a></span></span><span> </span><span id="local-6989586621684536612"><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684536612"><span class="hs-identifier hs-var">active</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1085"></span><span>        </span><span class="annot"><span class="annottext">KernelConstants
-&gt; Maybe (TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool)
-&gt; TExp Int64
-&gt; TExp Int32
-&gt; TExp Int32
-&gt; TExp Bool
-&gt; [VName]
-&gt; InKernelGen ()
-&gt; Lambda GPUMem
-&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#inBlockScan"><span class="hs-identifier hs-var">inBlockScan</span></a></span><span>
</span><span id="line-1086"></span><span>          </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684536629"><span class="hs-identifier hs-var">constants</span></a></span><span>
</span><span id="line-1087"></span><span>          </span><span class="annot"><span class="annottext">Maybe (TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool)
</span><a href="#local-6989586621684536613"><span class="hs-identifier hs-var">seg_flag'</span></a></span><span>
</span><span id="line-1088"></span><span>          </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536633"><span class="hs-identifier hs-var">arrs_full_size</span></a></span><span>
</span><span id="line-1089"></span><span>          </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536617"><span class="hs-identifier hs-var">simd_width</span></a></span><span>
</span><span id="line-1090"></span><span>          </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536618"><span class="hs-identifier hs-var">block_size</span></a></span><span>
</span><span id="line-1091"></span><span>          </span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684536612"><span class="hs-identifier hs-var">active</span></a></span><span>
</span><span id="line-1092"></span><span>          </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684536630"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-1093"></span><span>          </span><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684536610"><span class="hs-identifier hs-var">barrier</span></a></span><span>
</span><span id="line-1094"></span><span>      </span><span id="local-6989586621684536609"><span class="annot"><span class="annottext">array_scan :: Bool
</span><a href="#local-6989586621684536609"><span class="hs-identifier hs-var hs-var">array_scan</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(TypeBase Shape NoUniqueness -&gt; Bool)
-&gt; [TypeBase Shape NoUniqueness] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness -&gt; Bool
forall shape u. TypeBase shape u -&gt; Bool
</span><a href="Futhark.IR.Prop.Types.html#primType"><span class="hs-identifier hs-var">primType</span></a></span><span> </span><span class="annot"><span class="annottext">([TypeBase Shape NoUniqueness] -&gt; Bool)
-&gt; [TypeBase Shape NoUniqueness] -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem -&gt; [TypeBase Shape NoUniqueness]
forall rep. LambdaT rep -&gt; [TypeBase Shape NoUniqueness]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684536631"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-1095"></span><span>      </span><span id="local-6989586621684536610"><span class="annot"><span class="annottext">barrier :: InKernelGen ()
</span><a href="#local-6989586621684536610"><span class="hs-identifier hs-var hs-var">barrier</span></a></span></span><span>
</span><span id="line-1096"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684536609"><span class="hs-identifier hs-var">array_scan</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1097"></span><span>          </span><span class="annot"><span class="annottext">KernelOp -&gt; InKernelGen ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelOp -&gt; InKernelGen ()) -&gt; KernelOp -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Fence -&gt; KernelOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#Barrier"><span class="hs-identifier hs-var">Imp.Barrier</span></a></span><span> </span><span class="annot"><span class="annottext">Fence
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#FenceGlobal"><span class="hs-identifier hs-var">Imp.FenceGlobal</span></a></span><span>
</span><span id="line-1098"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1099"></span><span>          </span><span class="annot"><span class="annottext">KernelOp -&gt; InKernelGen ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelOp -&gt; InKernelGen ()) -&gt; KernelOp -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Fence -&gt; KernelOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#Barrier"><span class="hs-identifier hs-var">Imp.Barrier</span></a></span><span> </span><span class="annot"><span class="annottext">Fence
</span><a href="#local-6989586621684536620"><span class="hs-identifier hs-var">fence</span></a></span><span>
</span><span id="line-1100"></span><span>
</span><span id="line-1101"></span><span>      </span><span id="local-6989586621684536607"><span class="annot"><span class="annottext">group_offset :: TExp Int64
</span><a href="#local-6989586621684536607"><span class="hs-identifier hs-var hs-var">group_offset</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int64
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelGroupId"><span class="hs-identifier hs-var hs-var">kernelGroupId</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684536629"><span class="hs-identifier hs-var">constants</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelGroupSize"><span class="hs-identifier hs-var hs-var">kernelGroupSize</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684536629"><span class="hs-identifier hs-var">constants</span></a></span><span>
</span><span id="line-1102"></span><span>
</span><span id="line-1103"></span><span>      </span><span id="local-6989586621684536606"><span class="annot"><span class="annottext">writeBlockResult :: Param LParamMem -&gt; VName -&gt; InKernelGen ()
</span><a href="#local-6989586621684536606"><span class="hs-identifier hs-var hs-var">writeBlockResult</span></a></span></span><span> </span><span id="local-6989586621684536605"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536605"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621684536604"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536604"><span class="hs-identifier hs-var">arr</span></a></span></span><span>
</span><span id="line-1104"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness -&gt; Bool
forall shape u. TypeBase shape u -&gt; Bool
</span><a href="Futhark.IR.Prop.Types.html#primType"><span class="hs-identifier hs-var">primType</span></a></span><span> </span><span class="annot"><span class="annottext">(TypeBase Shape NoUniqueness -&gt; Bool)
-&gt; TypeBase Shape NoUniqueness -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param LParamMem -&gt; TypeBase Shape NoUniqueness
forall dec. Typed dec =&gt; Param dec -&gt; TypeBase Shape NoUniqueness
</span><a href="Futhark.IR.Prop.Patterns.html#paramType"><span class="hs-identifier hs-var">paramType</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536605"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1105"></span><span>          </span><span class="annot"><span class="annottext">VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; InKernelGen ()
forall rep r op.
VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-var">copyDWIM</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536604"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TExp Int64 -&gt; DimIndex (TExp Int64)
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; DimIndex (TExp Int64))
-&gt; TExp Int64 -&gt; DimIndex (TExp Int64)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int64
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536616"><span class="hs-identifier hs-var">block_id</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SubExp) -&gt; VName -&gt; SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536605"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1106"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1107"></span><span>          </span><span class="annot"><span class="annottext">VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; InKernelGen ()
forall rep r op.
VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-var">copyDWIM</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536604"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TExp Int64 -&gt; DimIndex (TExp Int64)
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; DimIndex (TExp Int64))
-&gt; TExp Int64 -&gt; DimIndex (TExp Int64)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536607"><span class="hs-identifier hs-var">group_offset</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int64
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536616"><span class="hs-identifier hs-var">block_id</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SubExp) -&gt; VName -&gt; SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536605"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1108"></span><span>
</span><span id="line-1109"></span><span>      </span><span id="local-6989586621684536603"><span class="annot"><span class="annottext">readPrevBlockResult :: Param LParamMem -&gt; VName -&gt; InKernelGen ()
</span><a href="#local-6989586621684536603"><span class="hs-identifier hs-var hs-var">readPrevBlockResult</span></a></span></span><span> </span><span id="local-6989586621684536602"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536602"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621684536601"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536601"><span class="hs-identifier hs-var">arr</span></a></span></span><span>
</span><span id="line-1110"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness -&gt; Bool
forall shape u. TypeBase shape u -&gt; Bool
</span><a href="Futhark.IR.Prop.Types.html#primType"><span class="hs-identifier hs-var">primType</span></a></span><span> </span><span class="annot"><span class="annottext">(TypeBase Shape NoUniqueness -&gt; Bool)
-&gt; TypeBase Shape NoUniqueness -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param LParamMem -&gt; TypeBase Shape NoUniqueness
forall dec. Typed dec =&gt; Param dec -&gt; TypeBase Shape NoUniqueness
</span><a href="Futhark.IR.Prop.Patterns.html#paramType"><span class="hs-identifier hs-var">paramType</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536602"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1111"></span><span>          </span><span class="annot"><span class="annottext">VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; InKernelGen ()
forall rep r op.
VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-var">copyDWIM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536602"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536601"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TExp Int64 -&gt; DimIndex (TExp Int64)
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; DimIndex (TExp Int64))
-&gt; TExp Int64 -&gt; DimIndex (TExp Int64)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int64
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536616"><span class="hs-identifier hs-var">block_id</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span>
</span><span id="line-1112"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1113"></span><span>          </span><span class="annot"><span class="annottext">VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; InKernelGen ()
forall rep r op.
VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-var">copyDWIM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536602"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536601"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TExp Int64 -&gt; DimIndex (TExp Int64)
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; DimIndex (TExp Int64))
-&gt; TExp Int64 -&gt; DimIndex (TExp Int64)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536607"><span class="hs-identifier hs-var">group_offset</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int64
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536616"><span class="hs-identifier hs-var">block_id</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span>
</span><span id="line-1114"></span><span>
</span><span id="line-1115"></span><span>  </span><span class="annot"><span class="annottext">Maybe (TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool)
-&gt; TExp Bool -&gt; Lambda GPUMem -&gt; InKernelGen ()
</span><a href="#local-6989586621684536614"><span class="hs-identifier hs-var">doInBlockScan</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool)
</span><a href="#local-6989586621684536634"><span class="hs-identifier hs-var">seg_flag</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684536622"><span class="hs-identifier hs-var">ltid_in_bounds</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684536631"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-1116"></span><span>  </span><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684536610"><span class="hs-identifier hs-var">barrier</span></a></span><span>
</span><span id="line-1117"></span><span>
</span><span id="line-1118"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684536600"><span class="annot"><span class="annottext">is_first_block :: TExp Bool
</span><a href="#local-6989586621684536600"><span class="hs-identifier hs-var hs-var">is_first_block</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536616"><span class="hs-identifier hs-var">block_id</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3D%3D."><span class="hs-operator hs-var">.==.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">0</span></span><span>
</span><span id="line-1119"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684536609"><span class="hs-identifier hs-var">array_scan</span></a></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1120"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;save correct values for first block&quot;</span></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1121"></span><span>      </span><span class="annot"><span class="annottext">TExp Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684536600"><span class="hs-identifier hs-var">is_first_block</span></a></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1122"></span><span>        </span><span class="annot"><span class="annottext">[(Param LParamMem, VName)]
-&gt; ((Param LParamMem, VName) -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param LParamMem] -&gt; [VName] -&gt; [(Param LParamMem, VName)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684536624"><span class="hs-identifier hs-var">x_params</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684536630"><span class="hs-identifier hs-var">arrs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Param LParamMem, VName) -&gt; InKernelGen ()) -&gt; InKernelGen ())
-&gt; ((Param LParamMem, VName) -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684536598"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536598"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684536597"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536597"><span class="hs-identifier hs-var">arr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1123"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness -&gt; Bool
forall shape u. TypeBase shape u -&gt; Bool
</span><a href="Futhark.IR.Prop.Types.html#primType"><span class="hs-identifier hs-var">primType</span></a></span><span> </span><span class="annot"><span class="annottext">(TypeBase Shape NoUniqueness -&gt; Bool)
-&gt; TypeBase Shape NoUniqueness -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param LParamMem -&gt; TypeBase Shape NoUniqueness
forall dec. Typed dec =&gt; Param dec -&gt; TypeBase Shape NoUniqueness
</span><a href="Futhark.IR.Prop.Patterns.html#paramType"><span class="hs-identifier hs-var">paramType</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536598"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1124"></span><span>            </span><span class="annot"><span class="annottext">VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; InKernelGen ()
forall rep r op.
VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-var">copyDWIM</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536597"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TExp Int64 -&gt; DimIndex (TExp Int64)
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; DimIndex (TExp Int64))
-&gt; TExp Int64 -&gt; DimIndex (TExp Int64)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536633"><span class="hs-identifier hs-var">arrs_full_size</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536607"><span class="hs-identifier hs-var">group_offset</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int64
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536618"><span class="hs-identifier hs-var">block_size</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536625"><span class="hs-identifier hs-var">ltid</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SubExp) -&gt; VName -&gt; SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536598"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1125"></span><span>
</span><span id="line-1126"></span><span>    </span><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684536610"><span class="hs-identifier hs-var">barrier</span></a></span><span>
</span><span id="line-1127"></span><span>
</span><span id="line-1128"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684536595"><span class="annot"><span class="annottext">last_in_block :: TExp Bool
</span><a href="#local-6989586621684536595"><span class="hs-identifier hs-var hs-var">last_in_block</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536615"><span class="hs-identifier hs-var">in_block_id</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3D%3D."><span class="hs-operator hs-var">.==.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536618"><span class="hs-identifier hs-var">block_size</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">1</span></span><span>
</span><span id="line-1129"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;last thread of block 'i' writes its result to offset 'i'&quot;</span></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1130"></span><span>    </span><span class="annot"><span class="annottext">TExp Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684536595"><span class="hs-identifier hs-var">last_in_block</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool -&gt; TExp Bool -&gt; TExp Bool
forall v. TPrimExp Bool v -&gt; TPrimExp Bool v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%26%26."><span class="hs-operator hs-var">.&amp;&amp;.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684536622"><span class="hs-identifier hs-var">ltid_in_bounds</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1131"></span><span>      </span><span class="annot"><span class="annottext">InKernelGen () -&gt; InKernelGen ()
forall rep r op a. ImpM rep r op a -&gt; ImpM rep r op a
</span><a href="Futhark.CodeGen.ImpGen.html#everythingVolatile"><span class="hs-identifier hs-var">everythingVolatile</span></a></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1132"></span><span>        </span><span class="annot"><span class="annottext">(Param LParamMem -&gt; VName -&gt; InKernelGen ())
-&gt; [Param LParamMem] -&gt; [VName] -&gt; InKernelGen ()
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m ()
</span><span class="hs-identifier hs-var">zipWithM_</span></span><span> </span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName -&gt; InKernelGen ()
</span><a href="#local-6989586621684536606"><span class="hs-identifier hs-var">writeBlockResult</span></a></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684536624"><span class="hs-identifier hs-var">x_params</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684536630"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-1133"></span><span>
</span><span id="line-1134"></span><span>  </span><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684536610"><span class="hs-identifier hs-var">barrier</span></a></span><span>
</span><span id="line-1135"></span><span>
</span><span id="line-1136"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684536594"><span class="annot"><span class="annottext">first_block_seg_flag :: Maybe (TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool)
</span><a href="#local-6989586621684536594"><span class="hs-identifier hs-var hs-var">first_block_seg_flag</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1137"></span><span>        </span><span id="local-6989586621684536593"><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool
</span><a href="#local-6989586621684536593"><span class="hs-identifier hs-var">flag_true</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe (TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool)
</span><a href="#local-6989586621684536634"><span class="hs-identifier hs-var">seg_flag</span></a></span><span>
</span><span id="line-1138"></span><span>        </span><span class="annot"><span class="annottext">(TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool)
-&gt; Maybe (TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">((TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool)
 -&gt; Maybe (TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool))
-&gt; (TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool)
-&gt; Maybe (TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684536592"><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536592"><span class="hs-identifier hs-var">from</span></a></span></span><span> </span><span id="local-6989586621684536591"><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536591"><span class="hs-identifier hs-var">to</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1139"></span><span>          </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool
</span><a href="#local-6989586621684536593"><span class="hs-identifier hs-var">flag_true</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536592"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536618"><span class="hs-identifier hs-var">block_size</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536618"><span class="hs-identifier hs-var">block_size</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536591"><span class="hs-identifier hs-var">to</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536618"><span class="hs-identifier hs-var">block_size</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536618"><span class="hs-identifier hs-var">block_size</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-1140"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#comment"><span class="hs-identifier hs-var">comment</span></a></span><span>
</span><span id="line-1141"></span><span>    </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;scan the first block, after which offset 'i' contains carry-in for block 'i+1'&quot;</span></span><span>
</span><span id="line-1142"></span><span>    </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool)
-&gt; TExp Bool -&gt; Lambda GPUMem -&gt; InKernelGen ()
</span><a href="#local-6989586621684536614"><span class="hs-identifier hs-var">doInBlockScan</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool)
</span><a href="#local-6989586621684536594"><span class="hs-identifier hs-var">first_block_seg_flag</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684536600"><span class="hs-identifier hs-var">is_first_block</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool -&gt; TExp Bool -&gt; TExp Bool
forall v. TPrimExp Bool v -&gt; TPrimExp Bool v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%26%26."><span class="hs-operator hs-var">.&amp;&amp;.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684536622"><span class="hs-identifier hs-var">ltid_in_bounds</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684536628"><span class="hs-identifier hs-var">renamed_lam</span></a></span><span>
</span><span id="line-1143"></span><span>
</span><span id="line-1144"></span><span>  </span><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684536610"><span class="hs-identifier hs-var">barrier</span></a></span><span>
</span><span id="line-1145"></span><span>
</span><span id="line-1146"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684536609"><span class="hs-identifier hs-var">array_scan</span></a></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1147"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;move correct values for first block back a block&quot;</span></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1148"></span><span>      </span><span class="annot"><span class="annottext">TExp Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684536600"><span class="hs-identifier hs-var">is_first_block</span></a></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1149"></span><span>        </span><span class="annot"><span class="annottext">[(Param LParamMem, VName)]
-&gt; ((Param LParamMem, VName) -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param LParamMem] -&gt; [VName] -&gt; [(Param LParamMem, VName)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684536624"><span class="hs-identifier hs-var">x_params</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684536630"><span class="hs-identifier hs-var">arrs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Param LParamMem, VName) -&gt; InKernelGen ()) -&gt; InKernelGen ())
-&gt; ((Param LParamMem, VName) -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684536590"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536590"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684536589"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536589"><span class="hs-identifier hs-var">arr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1150"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness -&gt; Bool
forall shape u. TypeBase shape u -&gt; Bool
</span><a href="Futhark.IR.Prop.Types.html#primType"><span class="hs-identifier hs-var">primType</span></a></span><span> </span><span class="annot"><span class="annottext">(TypeBase Shape NoUniqueness -&gt; Bool)
-&gt; TypeBase Shape NoUniqueness -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param LParamMem -&gt; TypeBase Shape NoUniqueness
forall dec. Typed dec =&gt; Param dec -&gt; TypeBase Shape NoUniqueness
</span><a href="Futhark.IR.Prop.Patterns.html#paramType"><span class="hs-identifier hs-var">paramType</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536590"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1151"></span><span>            </span><span class="annot"><span class="annottext">VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; InKernelGen ()
forall rep r op.
VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-var">copyDWIM</span></a></span><span>
</span><span id="line-1152"></span><span>              </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536589"><span class="hs-identifier hs-var">arr</span></a></span><span>
</span><span id="line-1153"></span><span>              </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TExp Int64 -&gt; DimIndex (TExp Int64)
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; DimIndex (TExp Int64))
-&gt; TExp Int64 -&gt; DimIndex (TExp Int64)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536633"><span class="hs-identifier hs-var">arrs_full_size</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536607"><span class="hs-identifier hs-var">group_offset</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536625"><span class="hs-identifier hs-var">ltid</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1154"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536589"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1155"></span><span>              </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TExp Int64 -&gt; DimIndex (TExp Int64)
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; DimIndex (TExp Int64))
-&gt; TExp Int64 -&gt; DimIndex (TExp Int64)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536633"><span class="hs-identifier hs-var">arrs_full_size</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536607"><span class="hs-identifier hs-var">group_offset</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int64
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536618"><span class="hs-identifier hs-var">block_size</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536625"><span class="hs-identifier hs-var">ltid</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1156"></span><span>
</span><span id="line-1157"></span><span>    </span><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684536610"><span class="hs-identifier hs-var">barrier</span></a></span><span>
</span><span id="line-1158"></span><span>
</span><span id="line-1159"></span><span>  </span><span id="local-6989586621684536588"><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684536588"><span class="hs-identifier hs-var">no_carry_in</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; TExp Bool -&gt; ImpM GPUMem KernelEnv KernelOp (TExp Bool)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TExp t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimVE"><span class="hs-identifier hs-var">dPrimVE</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;no_carry_in&quot;</span></span><span> </span><span class="annot"><span class="annottext">(TExp Bool -&gt; ImpM GPUMem KernelEnv KernelOp (TExp Bool))
-&gt; TExp Bool -&gt; ImpM GPUMem KernelEnv KernelOp (TExp Bool)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684536600"><span class="hs-identifier hs-var">is_first_block</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool -&gt; TExp Bool -&gt; TExp Bool
forall v. TPrimExp Bool v -&gt; TPrimExp Bool v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%7C%7C."><span class="hs-operator hs-var">.||.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool -&gt; TExp Bool
forall v. TPrimExp Bool v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#bNot"><span class="hs-identifier hs-var">bNot</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684536622"><span class="hs-identifier hs-var">ltid_in_bounds</span></a></span><span>
</span><span id="line-1160"></span><span>
</span><span id="line-1161"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684536586"><span class="annot"><span class="annottext">read_carry_in :: InKernelGen ()
</span><a href="#local-6989586621684536586"><span class="hs-identifier hs-var hs-var">read_carry_in</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TExp Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sUnless"><span class="hs-identifier hs-var">sUnless</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684536588"><span class="hs-identifier hs-var">no_carry_in</span></a></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1162"></span><span>        </span><span class="annot"><span class="annottext">[(Param LParamMem, Param LParamMem)]
-&gt; ((Param LParamMem, Param LParamMem) -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param LParamMem]
-&gt; [Param LParamMem] -&gt; [(Param LParamMem, Param LParamMem)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684536624"><span class="hs-identifier hs-var">x_params</span></a></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684536623"><span class="hs-identifier hs-var">y_params</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Param LParamMem, Param LParamMem) -&gt; InKernelGen ())
 -&gt; InKernelGen ())
-&gt; ((Param LParamMem, Param LParamMem) -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684536584"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536584"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684536583"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536583"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1163"></span><span>          </span><span class="annot"><span class="annottext">VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; InKernelGen ()
forall rep r op.
VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-var">copyDWIM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536583"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536584"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1164"></span><span>        </span><span class="annot"><span class="annottext">(Param LParamMem -&gt; VName -&gt; InKernelGen ())
-&gt; [Param LParamMem] -&gt; [VName] -&gt; InKernelGen ()
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m ()
</span><span class="hs-identifier hs-var">zipWithM_</span></span><span> </span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName -&gt; InKernelGen ()
</span><a href="#local-6989586621684536603"><span class="hs-identifier hs-var">readPrevBlockResult</span></a></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684536624"><span class="hs-identifier hs-var">x_params</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684536630"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-1165"></span><span>
</span><span id="line-1166"></span><span>      </span><span id="local-6989586621684536582"><span class="annot"><span class="annottext">op_to_x :: InKernelGen ()
</span><a href="#local-6989586621684536582"><span class="hs-identifier hs-var hs-var">op_to_x</span></a></span></span><span>
</span><span id="line-1167"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Maybe (TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe (TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool)
</span><a href="#local-6989586621684536634"><span class="hs-identifier hs-var">seg_flag</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1168"></span><span>          </span><span class="annot"><span class="annottext">TExp Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sUnless"><span class="hs-identifier hs-var">sUnless</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684536588"><span class="hs-identifier hs-var">no_carry_in</span></a></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem] -&gt; BodyT GPUMem -&gt; InKernelGen ()
forall dec rep r op. [Param dec] -&gt; Body rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileBody%27"><span class="hs-identifier hs-var">compileBody'</span></a></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684536624"><span class="hs-identifier hs-var">x_params</span></a></span><span> </span><span class="annot"><span class="annottext">(BodyT GPUMem -&gt; InKernelGen ()) -&gt; BodyT GPUMem -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem -&gt; BodyT GPUMem
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684536631"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-1169"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684536581"><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool
</span><a href="#local-6989586621684536581"><span class="hs-identifier hs-var">flag_true</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe (TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool)
</span><a href="#local-6989586621684536634"><span class="hs-identifier hs-var">seg_flag</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1170"></span><span>          </span><span id="local-6989586621684536580"><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684536580"><span class="hs-identifier hs-var">inactive</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1171"></span><span>            </span><span class="annot"><span class="annottext">String -&gt; TExp Bool -&gt; ImpM GPUMem KernelEnv KernelOp (TExp Bool)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TExp t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimVE"><span class="hs-identifier hs-var">dPrimVE</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;inactive&quot;</span></span><span> </span><span class="annot"><span class="annottext">(TExp Bool -&gt; ImpM GPUMem KernelEnv KernelOp (TExp Bool))
-&gt; TExp Bool -&gt; ImpM GPUMem KernelEnv KernelOp (TExp Bool)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool
</span><a href="#local-6989586621684536581"><span class="hs-identifier hs-var">flag_true</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536616"><span class="hs-identifier hs-var">block_id</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536618"><span class="hs-identifier hs-var">block_size</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536626"><span class="hs-identifier hs-var">ltid32</span></a></span><span>
</span><span id="line-1172"></span><span>          </span><span class="annot"><span class="annottext">TExp Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sUnless"><span class="hs-identifier hs-var">sUnless</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684536588"><span class="hs-identifier hs-var">no_carry_in</span></a></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; (((Param LParamMem, Param LParamMem) -&gt; InKernelGen ())
    -&gt; InKernelGen ())
-&gt; ((Param LParamMem, Param LParamMem) -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TExp Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684536580"><span class="hs-identifier hs-var">inactive</span></a></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; (((Param LParamMem, Param LParamMem) -&gt; InKernelGen ())
    -&gt; InKernelGen ())
-&gt; ((Param LParamMem, Param LParamMem) -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[(Param LParamMem, Param LParamMem)]
-&gt; ((Param LParamMem, Param LParamMem) -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param LParamMem]
-&gt; [Param LParamMem] -&gt; [(Param LParamMem, Param LParamMem)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684536624"><span class="hs-identifier hs-var">x_params</span></a></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684536623"><span class="hs-identifier hs-var">y_params</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Param LParamMem, Param LParamMem) -&gt; InKernelGen ())
 -&gt; InKernelGen ())
-&gt; ((Param LParamMem, Param LParamMem) -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684536579"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536579"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684536578"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536578"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1173"></span><span>            </span><span class="annot"><span class="annottext">VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; InKernelGen ()
forall rep r op.
VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-var">copyDWIM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536579"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536578"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1174"></span><span>          </span><span class="hs-comment">-- The convoluted control flow is to ensure all threads</span><span>
</span><span id="line-1175"></span><span>          </span><span class="hs-comment">-- hit this barrier (if applicable).</span><span>
</span><span id="line-1176"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684536609"><span class="hs-identifier hs-var">array_scan</span></a></span><span> </span><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684536610"><span class="hs-identifier hs-var">barrier</span></a></span><span>
</span><span id="line-1177"></span><span>          </span><span class="annot"><span class="annottext">TExp Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sUnless"><span class="hs-identifier hs-var">sUnless</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684536588"><span class="hs-identifier hs-var">no_carry_in</span></a></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sUnless"><span class="hs-identifier hs-var">sUnless</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684536580"><span class="hs-identifier hs-var">inactive</span></a></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem] -&gt; BodyT GPUMem -&gt; InKernelGen ()
forall dec rep r op. [Param dec] -&gt; Body rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileBody%27"><span class="hs-identifier hs-var">compileBody'</span></a></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684536624"><span class="hs-identifier hs-var">x_params</span></a></span><span> </span><span class="annot"><span class="annottext">(BodyT GPUMem -&gt; InKernelGen ()) -&gt; BodyT GPUMem -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem -&gt; BodyT GPUMem
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684536631"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-1178"></span><span>
</span><span id="line-1179"></span><span>      </span><span id="local-6989586621684536577"><span class="annot"><span class="annottext">write_final_result :: InKernelGen ()
</span><a href="#local-6989586621684536577"><span class="hs-identifier hs-var hs-var">write_final_result</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1180"></span><span>        </span><span class="annot"><span class="annottext">[(Param LParamMem, VName)]
-&gt; ((Param LParamMem, VName) -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param LParamMem] -&gt; [VName] -&gt; [(Param LParamMem, VName)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684536624"><span class="hs-identifier hs-var">x_params</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684536630"><span class="hs-identifier hs-var">arrs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Param LParamMem, VName) -&gt; InKernelGen ()) -&gt; InKernelGen ())
-&gt; ((Param LParamMem, VName) -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684536576"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536576"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684536575"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536575"><span class="hs-identifier hs-var">arr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1181"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness -&gt; Bool
forall shape u. TypeBase shape u -&gt; Bool
</span><a href="Futhark.IR.Prop.Types.html#primType"><span class="hs-identifier hs-var">primType</span></a></span><span> </span><span class="annot"><span class="annottext">(TypeBase Shape NoUniqueness -&gt; Bool)
-&gt; TypeBase Shape NoUniqueness -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param LParamMem -&gt; TypeBase Shape NoUniqueness
forall dec. Typed dec =&gt; Param dec -&gt; TypeBase Shape NoUniqueness
</span><a href="Futhark.IR.Prop.Patterns.html#paramType"><span class="hs-identifier hs-var">paramType</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536576"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1182"></span><span>            </span><span class="annot"><span class="annottext">VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; InKernelGen ()
forall rep r op.
VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-var">copyDWIM</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536575"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TExp Int64 -&gt; DimIndex (TExp Int64)
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536625"><span class="hs-identifier hs-var">ltid</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SubExp) -&gt; VName -&gt; SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536576"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1183"></span><span>
</span><span id="line-1184"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;carry-in for every block except the first&quot;</span></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1185"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;read operands&quot;</span></span><span> </span><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684536586"><span class="hs-identifier hs-var">read_carry_in</span></a></span><span>
</span><span id="line-1186"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;perform operation&quot;</span></span><span> </span><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684536582"><span class="hs-identifier hs-var">op_to_x</span></a></span><span>
</span><span id="line-1187"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;write final result&quot;</span></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sUnless"><span class="hs-identifier hs-var">sUnless</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684536588"><span class="hs-identifier hs-var">no_carry_in</span></a></span><span> </span><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684536577"><span class="hs-identifier hs-var">write_final_result</span></a></span><span>
</span><span id="line-1188"></span><span>
</span><span id="line-1189"></span><span>  </span><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684536610"><span class="hs-identifier hs-var">barrier</span></a></span><span>
</span><span id="line-1190"></span><span>
</span><span id="line-1191"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;restore correct values for first block&quot;</span></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1192"></span><span>    </span><span class="annot"><span class="annottext">TExp Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684536600"><span class="hs-identifier hs-var">is_first_block</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool -&gt; TExp Bool -&gt; TExp Bool
forall v. TPrimExp Bool v -&gt; TPrimExp Bool v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%26%26."><span class="hs-operator hs-var">.&amp;&amp;.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684536622"><span class="hs-identifier hs-var">ltid_in_bounds</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1193"></span><span>      </span><span class="annot"><span class="annottext">[(Param LParamMem, Param LParamMem, VName)]
-&gt; ((Param LParamMem, Param LParamMem, VName) -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param LParamMem]
-&gt; [Param LParamMem]
-&gt; [VName]
-&gt; [(Param LParamMem, Param LParamMem, VName)]
forall a b c. [a] -&gt; [b] -&gt; [c] -&gt; [(a, b, c)]
</span><span class="hs-identifier hs-var">zip3</span></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684536624"><span class="hs-identifier hs-var">x_params</span></a></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684536623"><span class="hs-identifier hs-var">y_params</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684536630"><span class="hs-identifier hs-var">arrs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Param LParamMem, Param LParamMem, VName) -&gt; InKernelGen ())
 -&gt; InKernelGen ())
-&gt; ((Param LParamMem, Param LParamMem, VName) -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684536573"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536573"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684536572"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536572"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684536571"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536571"><span class="hs-identifier hs-var">arr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1194"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness -&gt; Bool
forall shape u. TypeBase shape u -&gt; Bool
</span><a href="Futhark.IR.Prop.Types.html#primType"><span class="hs-identifier hs-var">primType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param LParamMem -&gt; TypeBase Shape NoUniqueness
forall dec. Typed dec =&gt; Param dec -&gt; TypeBase Shape NoUniqueness
</span><a href="Futhark.IR.Prop.Patterns.html#paramType"><span class="hs-identifier hs-var">paramType</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536572"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1195"></span><span>          </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; InKernelGen ()
forall rep r op.
VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-var">copyDWIM</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536571"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TExp Int64 -&gt; DimIndex (TExp Int64)
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536625"><span class="hs-identifier hs-var">ltid</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SubExp) -&gt; VName -&gt; SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536572"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1196"></span><span>          </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; InKernelGen ()
forall rep r op.
VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-var">copyDWIM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536573"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536571"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TExp Int64 -&gt; DimIndex (TExp Int64)
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; DimIndex (TExp Int64))
-&gt; TExp Int64 -&gt; DimIndex (TExp Int64)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536633"><span class="hs-identifier hs-var">arrs_full_size</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536607"><span class="hs-identifier hs-var">group_offset</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536625"><span class="hs-identifier hs-var">ltid</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1197"></span><span>
</span><span id="line-1198"></span><span>  </span><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684536610"><span class="hs-identifier hs-var">barrier</span></a></span><span>
</span><span id="line-1199"></span><span>
</span><span id="line-1200"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#inBlockScan"><span class="hs-identifier hs-type">inBlockScan</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1201"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#KernelConstants"><span class="hs-identifier hs-type">KernelConstants</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1202"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1203"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1204"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1205"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1206"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1207"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1208"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#InKernelGen"><span class="hs-identifier hs-type">InKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1209"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1210"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#InKernelGen"><span class="hs-identifier hs-type">InKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1211"></span><span id="inBlockScan"><span class="annot"><span class="annottext">inBlockScan :: KernelConstants
-&gt; Maybe (TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool)
-&gt; TExp Int64
-&gt; TExp Int32
-&gt; TExp Int32
-&gt; TExp Bool
-&gt; [VName]
-&gt; InKernelGen ()
-&gt; Lambda GPUMem
-&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#inBlockScan"><span class="hs-identifier hs-var hs-var">inBlockScan</span></a></span></span><span> </span><span id="local-6989586621684536570"><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684536570"><span class="hs-identifier hs-var">constants</span></a></span></span><span> </span><span id="local-6989586621684536569"><span class="annot"><span class="annottext">Maybe (TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool)
</span><a href="#local-6989586621684536569"><span class="hs-identifier hs-var">seg_flag</span></a></span></span><span> </span><span id="local-6989586621684536568"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536568"><span class="hs-identifier hs-var">arrs_full_size</span></a></span></span><span> </span><span id="local-6989586621684536567"><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536567"><span class="hs-identifier hs-var">lockstep_width</span></a></span></span><span> </span><span id="local-6989586621684536566"><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536566"><span class="hs-identifier hs-var">block_size</span></a></span></span><span> </span><span id="local-6989586621684536565"><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684536565"><span class="hs-identifier hs-var">active</span></a></span></span><span> </span><span id="local-6989586621684536564"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684536564"><span class="hs-identifier hs-var">arrs</span></a></span></span><span> </span><span id="local-6989586621684536563"><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684536563"><span class="hs-identifier hs-var">barrier</span></a></span></span><span> </span><span id="local-6989586621684536562"><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684536562"><span class="hs-identifier hs-var">scan_lam</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InKernelGen () -&gt; InKernelGen ()
forall rep r op a. ImpM rep r op a -&gt; ImpM rep r op a
</span><a href="Futhark.CodeGen.ImpGen.html#everythingVolatile"><span class="hs-identifier hs-var">everythingVolatile</span></a></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1212"></span><span>  </span><span id="local-6989586621684536561"><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684536561"><span class="hs-identifier hs-var">skip_threads</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; PrimType -&gt; ImpM GPUMem KernelEnv KernelOp (TV Int32)
forall rep r op t. String -&gt; PrimType -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrim"><span class="hs-identifier hs-var">dPrim</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;skip_threads&quot;</span></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int32"><span class="hs-identifier hs-var">int32</span></a></span><span>
</span><span id="line-1213"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684536560"><span class="annot"><span class="annottext">actual_params :: [LParam GPUMem]
</span><a href="#local-6989586621684536560"><span class="hs-identifier hs-var hs-var">actual_params</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem -&gt; [LParam GPUMem]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684536562"><span class="hs-identifier hs-var">scan_lam</span></a></span><span>
</span><span id="line-1214"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684536559"><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684536559"><span class="hs-identifier hs-var">x_params</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684536558"><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684536558"><span class="hs-identifier hs-var">y_params</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1215"></span><span>        </span><span class="annot"><span class="annottext">Int -&gt; [Param LParamMem] -&gt; ([Param LParamMem], [Param LParamMem])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param LParamMem] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[LParam GPUMem]
[Param LParamMem]
</span><a href="#local-6989586621684536560"><span class="hs-identifier hs-var">actual_params</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Integral a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`div`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[LParam GPUMem]
[Param LParamMem]
</span><a href="#local-6989586621684536560"><span class="hs-identifier hs-var">actual_params</span></a></span><span>
</span><span id="line-1216"></span><span>      </span><span id="local-6989586621684536556"><span class="annot"><span class="annottext">y_to_x :: InKernelGen ()
</span><a href="#local-6989586621684536556"><span class="hs-identifier hs-var hs-var">y_to_x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1217"></span><span>        </span><span class="annot"><span class="annottext">[(Param LParamMem, Param LParamMem)]
-&gt; ((Param LParamMem, Param LParamMem) -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param LParamMem]
-&gt; [Param LParamMem] -&gt; [(Param LParamMem, Param LParamMem)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684536559"><span class="hs-identifier hs-var">x_params</span></a></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684536558"><span class="hs-identifier hs-var">y_params</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Param LParamMem, Param LParamMem) -&gt; InKernelGen ())
 -&gt; InKernelGen ())
-&gt; ((Param LParamMem, Param LParamMem) -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684536555"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536555"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684536554"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536554"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1218"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness -&gt; Bool
forall shape u. TypeBase shape u -&gt; Bool
</span><a href="Futhark.IR.Prop.Types.html#primType"><span class="hs-identifier hs-var">primType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param LParamMem -&gt; TypeBase Shape NoUniqueness
forall dec. Typed dec =&gt; Param dec -&gt; TypeBase Shape NoUniqueness
</span><a href="Futhark.IR.Prop.Patterns.html#paramType"><span class="hs-identifier hs-var">paramType</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536555"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1219"></span><span>            </span><span class="annot"><span class="annottext">VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; InKernelGen ()
forall rep r op.
VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-var">copyDWIM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536555"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536554"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1220"></span><span>
</span><span id="line-1221"></span><span>  </span><span class="hs-comment">-- Set initial y values</span><span>
</span><span id="line-1222"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;read input for in-block scan&quot;</span></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1223"></span><span>    </span><span class="annot"><span class="annottext">TExp Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684536565"><span class="hs-identifier hs-var">active</span></a></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1224"></span><span>      </span><span class="annot"><span class="annottext">(Param LParamMem -&gt; VName -&gt; InKernelGen ())
-&gt; [Param LParamMem] -&gt; [VName] -&gt; InKernelGen ()
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m ()
</span><span class="hs-identifier hs-var">zipWithM_</span></span><span> </span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName -&gt; InKernelGen ()
</span><a href="#local-6989586621684536553"><span class="hs-identifier hs-var">readInitial</span></a></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684536558"><span class="hs-identifier hs-var">y_params</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684536564"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-1225"></span><span>      </span><span class="hs-comment">-- Since the final result is expected to be in x_params, we may</span><span>
</span><span id="line-1226"></span><span>      </span><span class="hs-comment">-- need to copy it there for the first thread in the block.</span><span>
</span><span id="line-1227"></span><span>      </span><span class="annot"><span class="annottext">TExp Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536552"><span class="hs-identifier hs-var">in_block_id</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3D%3D."><span class="hs-operator hs-var">.==.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684536556"><span class="hs-identifier hs-var">y_to_x</span></a></span><span>
</span><span id="line-1228"></span><span>
</span><span id="line-1229"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684536551"><span class="hs-identifier hs-var">array_scan</span></a></span><span> </span><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684536563"><span class="hs-identifier hs-var">barrier</span></a></span><span>
</span><span id="line-1230"></span><span>
</span><span id="line-1231"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684536550"><span class="annot"><span class="annottext">op_to_x :: TExp Bool -&gt; InKernelGen ()
</span><a href="#local-6989586621684536550"><span class="hs-identifier hs-var hs-var">op_to_x</span></a></span></span><span> </span><span id="local-6989586621684536549"><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684536549"><span class="hs-identifier hs-var">in_block_thread_active</span></a></span></span><span>
</span><span id="line-1232"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Maybe (TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe (TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool)
</span><a href="#local-6989586621684536569"><span class="hs-identifier hs-var">seg_flag</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1233"></span><span>          </span><span class="annot"><span class="annottext">TExp Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684536549"><span class="hs-identifier hs-var">in_block_thread_active</span></a></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1234"></span><span>            </span><span class="annot"><span class="annottext">[Param LParamMem] -&gt; BodyT GPUMem -&gt; InKernelGen ()
forall dec rep r op. [Param dec] -&gt; Body rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileBody%27"><span class="hs-identifier hs-var">compileBody'</span></a></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684536559"><span class="hs-identifier hs-var">x_params</span></a></span><span> </span><span class="annot"><span class="annottext">(BodyT GPUMem -&gt; InKernelGen ()) -&gt; BodyT GPUMem -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem -&gt; BodyT GPUMem
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684536562"><span class="hs-identifier hs-var">scan_lam</span></a></span><span>
</span><span id="line-1235"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684536548"><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool
</span><a href="#local-6989586621684536548"><span class="hs-identifier hs-var">flag_true</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe (TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool)
</span><a href="#local-6989586621684536569"><span class="hs-identifier hs-var">seg_flag</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1236"></span><span>          </span><span id="local-6989586621684536547"><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684536547"><span class="hs-identifier hs-var">inactive</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1237"></span><span>            </span><span class="annot"><span class="annottext">String -&gt; TExp Bool -&gt; ImpM GPUMem KernelEnv KernelOp (TExp Bool)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TExp t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimVE"><span class="hs-identifier hs-var">dPrimVE</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;inactive&quot;</span></span><span> </span><span class="annot"><span class="annottext">(TExp Bool -&gt; ImpM GPUMem KernelEnv KernelOp (TExp Bool))
-&gt; TExp Bool -&gt; ImpM GPUMem KernelEnv KernelOp (TExp Bool)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool
</span><a href="#local-6989586621684536548"><span class="hs-identifier hs-var">flag_true</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536546"><span class="hs-identifier hs-var">ltid32</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">TV Int32 -&gt; TExp Int32
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684536561"><span class="hs-identifier hs-var">skip_threads</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536546"><span class="hs-identifier hs-var">ltid32</span></a></span><span>
</span><span id="line-1238"></span><span>          </span><span class="annot"><span class="annottext">TExp Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684536549"><span class="hs-identifier hs-var">in_block_thread_active</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool -&gt; TExp Bool -&gt; TExp Bool
forall v. TPrimExp Bool v -&gt; TPrimExp Bool v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%26%26."><span class="hs-operator hs-var">.&amp;&amp;.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684536547"><span class="hs-identifier hs-var">inactive</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1239"></span><span>            </span><span class="annot"><span class="annottext">[(Param LParamMem, Param LParamMem)]
-&gt; ((Param LParamMem, Param LParamMem) -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param LParamMem]
-&gt; [Param LParamMem] -&gt; [(Param LParamMem, Param LParamMem)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684536559"><span class="hs-identifier hs-var">x_params</span></a></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684536558"><span class="hs-identifier hs-var">y_params</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Param LParamMem, Param LParamMem) -&gt; InKernelGen ())
 -&gt; InKernelGen ())
-&gt; ((Param LParamMem, Param LParamMem) -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684536545"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536545"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684536544"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536544"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1240"></span><span>              </span><span class="annot"><span class="annottext">VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; InKernelGen ()
forall rep r op.
VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-var">copyDWIM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536545"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536544"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1241"></span><span>          </span><span class="hs-comment">-- The convoluted control flow is to ensure all threads</span><span>
</span><span id="line-1242"></span><span>          </span><span class="hs-comment">-- hit this barrier (if applicable).</span><span>
</span><span id="line-1243"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684536551"><span class="hs-identifier hs-var">array_scan</span></a></span><span> </span><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684536563"><span class="hs-identifier hs-var">barrier</span></a></span><span>
</span><span id="line-1244"></span><span>          </span><span class="annot"><span class="annottext">TExp Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684536549"><span class="hs-identifier hs-var">in_block_thread_active</span></a></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; (InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen ()
-&gt; InKernelGen ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TExp Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sUnless"><span class="hs-identifier hs-var">sUnless</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684536547"><span class="hs-identifier hs-var">inactive</span></a></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1245"></span><span>            </span><span class="annot"><span class="annottext">[Param LParamMem] -&gt; BodyT GPUMem -&gt; InKernelGen ()
forall dec rep r op. [Param dec] -&gt; Body rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileBody%27"><span class="hs-identifier hs-var">compileBody'</span></a></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684536559"><span class="hs-identifier hs-var">x_params</span></a></span><span> </span><span class="annot"><span class="annottext">(BodyT GPUMem -&gt; InKernelGen ()) -&gt; BodyT GPUMem -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem -&gt; BodyT GPUMem
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684536562"><span class="hs-identifier hs-var">scan_lam</span></a></span><span>
</span><span id="line-1246"></span><span>
</span><span id="line-1247"></span><span>      </span><span id="local-6989586621684536543"><span class="annot"><span class="annottext">maybeBarrier :: InKernelGen ()
</span><a href="#local-6989586621684536543"><span class="hs-identifier hs-var hs-var">maybeBarrier</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1248"></span><span>        </span><span class="annot"><span class="annottext">TExp Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span>
</span><span id="line-1249"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536567"><span class="hs-identifier hs-var">lockstep_width</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3C%3D."><span class="hs-operator hs-var">.&lt;=.</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32 -&gt; TExp Int32
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684536561"><span class="hs-identifier hs-var">skip_threads</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1250"></span><span>          </span><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684536563"><span class="hs-identifier hs-var">barrier</span></a></span><span>
</span><span id="line-1251"></span><span>
</span><span id="line-1252"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;in-block scan (hopefully no barriers needed)&quot;</span></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1253"></span><span>    </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684536561"><span class="hs-identifier hs-var">skip_threads</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32 -&gt; TExp Int32 -&gt; InKernelGen ()
forall t rep r op. TV t -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#%3C--"><span class="hs-operator hs-var">&lt;--</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">1</span></span><span>
</span><span id="line-1254"></span><span>    </span><span class="annot"><span class="annottext">TExp Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhile"><span class="hs-identifier hs-var">sWhile</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int32 -&gt; TExp Int32
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684536561"><span class="hs-identifier hs-var">skip_threads</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3C."><span class="hs-operator hs-var">.&lt;.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536566"><span class="hs-identifier hs-var">block_size</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1255"></span><span>      </span><span id="local-6989586621684536542"><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684536542"><span class="hs-identifier hs-var">thread_active</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1256"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; TExp Bool -&gt; ImpM GPUMem KernelEnv KernelOp (TExp Bool)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TExp t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimVE"><span class="hs-identifier hs-var">dPrimVE</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;thread_active&quot;</span></span><span> </span><span class="annot"><span class="annottext">(TExp Bool -&gt; ImpM GPUMem KernelEnv KernelOp (TExp Bool))
-&gt; TExp Bool -&gt; ImpM GPUMem KernelEnv KernelOp (TExp Bool)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TV Int32 -&gt; TExp Int32
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684536561"><span class="hs-identifier hs-var">skip_threads</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3C%3D."><span class="hs-operator hs-var">.&lt;=.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536552"><span class="hs-identifier hs-var">in_block_id</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool -&gt; TExp Bool -&gt; TExp Bool
forall v. TPrimExp Bool v -&gt; TPrimExp Bool v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%26%26."><span class="hs-operator hs-var">.&amp;&amp;.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684536565"><span class="hs-identifier hs-var">active</span></a></span><span>
</span><span id="line-1257"></span><span>
</span><span id="line-1258"></span><span>      </span><span class="annot"><span class="annottext">TExp Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684536542"><span class="hs-identifier hs-var">thread_active</span></a></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; (InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen ()
-&gt; InKernelGen ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;read operands&quot;</span></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1259"></span><span>        </span><span class="annot"><span class="annottext">(Param LParamMem -&gt; VName -&gt; InKernelGen ())
-&gt; [Param LParamMem] -&gt; [VName] -&gt; InKernelGen ()
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m ()
</span><span class="hs-identifier hs-var">zipWithM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int64 -&gt; Param LParamMem -&gt; VName -&gt; InKernelGen ()
</span><a href="#local-6989586621684536541"><span class="hs-identifier hs-var">readParam</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int64
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int32 -&gt; TExp Int64) -&gt; TExp Int32 -&gt; TExp Int64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TV Int32 -&gt; TExp Int32
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684536561"><span class="hs-identifier hs-var">skip_threads</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684536559"><span class="hs-identifier hs-var">x_params</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684536564"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-1260"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;perform operation&quot;</span></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp Bool -&gt; InKernelGen ()
</span><a href="#local-6989586621684536550"><span class="hs-identifier hs-var">op_to_x</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684536542"><span class="hs-identifier hs-var">thread_active</span></a></span><span>
</span><span id="line-1261"></span><span>
</span><span id="line-1262"></span><span>      </span><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684536543"><span class="hs-identifier hs-var">maybeBarrier</span></a></span><span>
</span><span id="line-1263"></span><span>
</span><span id="line-1264"></span><span>      </span><span class="annot"><span class="annottext">TExp Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684536542"><span class="hs-identifier hs-var">thread_active</span></a></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; (InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen ()
-&gt; InKernelGen ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;write result&quot;</span></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1265"></span><span>        </span><span class="annot"><span class="annottext">[InKernelGen ()] -&gt; InKernelGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a.
(Foldable t, Monad m) =&gt;
t (m a) -&gt; m ()
</span><span class="hs-identifier hs-var">sequence_</span></span><span> </span><span class="annot"><span class="annottext">([InKernelGen ()] -&gt; InKernelGen ())
-&gt; [InKernelGen ()] -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Param LParamMem -&gt; Param LParamMem -&gt; VName -&gt; InKernelGen ())
-&gt; [Param LParamMem]
-&gt; [Param LParamMem]
-&gt; [VName]
-&gt; [InKernelGen ()]
forall a b c d. (a -&gt; b -&gt; c -&gt; d) -&gt; [a] -&gt; [b] -&gt; [c] -&gt; [d]
</span><span class="hs-identifier hs-var">zipWith3</span></span><span> </span><span class="annot"><span class="annottext">Param LParamMem -&gt; Param LParamMem -&gt; VName -&gt; InKernelGen ()
</span><a href="#local-6989586621684536538"><span class="hs-identifier hs-var">writeResult</span></a></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684536559"><span class="hs-identifier hs-var">x_params</span></a></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684536558"><span class="hs-identifier hs-var">y_params</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684536564"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-1266"></span><span>
</span><span id="line-1267"></span><span>      </span><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684536543"><span class="hs-identifier hs-var">maybeBarrier</span></a></span><span>
</span><span id="line-1268"></span><span>
</span><span id="line-1269"></span><span>      </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684536561"><span class="hs-identifier hs-var">skip_threads</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32 -&gt; TExp Int32 -&gt; InKernelGen ()
forall t rep r op. TV t -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#%3C--"><span class="hs-operator hs-var">&lt;--</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32 -&gt; TExp Int32
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684536561"><span class="hs-identifier hs-var">skip_threads</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">2</span></span><span>
</span><span id="line-1270"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1271"></span><span>    </span><span id="local-6989586621684536537"><span class="annot"><span class="annottext">block_id :: TExp Int32
</span><a href="#local-6989586621684536537"><span class="hs-identifier hs-var hs-var">block_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536546"><span class="hs-identifier hs-var">ltid32</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall e. IntegralExp e =&gt; e -&gt; e -&gt; e
</span><a href="Futhark.Util.IntegralExp.html#quot"><span class="hs-operator hs-var">`quot`</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536566"><span class="hs-identifier hs-var">block_size</span></a></span><span>
</span><span id="line-1272"></span><span>    </span><span id="local-6989586621684536552"><span class="annot"><span class="annottext">in_block_id :: TExp Int32
</span><a href="#local-6989586621684536552"><span class="hs-identifier hs-var hs-var">in_block_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536546"><span class="hs-identifier hs-var">ltid32</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536537"><span class="hs-identifier hs-var">block_id</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536566"><span class="hs-identifier hs-var">block_size</span></a></span><span>
</span><span id="line-1273"></span><span>    </span><span id="local-6989586621684536546"><span class="annot"><span class="annottext">ltid32 :: TExp Int32
</span><a href="#local-6989586621684536546"><span class="hs-identifier hs-var hs-var">ltid32</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelLocalThreadId"><span class="hs-identifier hs-var hs-var">kernelLocalThreadId</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684536570"><span class="hs-identifier hs-var">constants</span></a></span><span>
</span><span id="line-1274"></span><span>    </span><span id="local-6989586621684536536"><span class="annot"><span class="annottext">ltid :: TExp Int64
</span><a href="#local-6989586621684536536"><span class="hs-identifier hs-var hs-var">ltid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int64
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536546"><span class="hs-identifier hs-var">ltid32</span></a></span><span>
</span><span id="line-1275"></span><span>    </span><span id="local-6989586621684536535"><span class="annot"><span class="annottext">gtid :: TExp Int64
</span><a href="#local-6989586621684536535"><span class="hs-identifier hs-var hs-var">gtid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int64
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int32 -&gt; TExp Int64) -&gt; TExp Int32 -&gt; TExp Int64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelGlobalThreadId"><span class="hs-identifier hs-var hs-var">kernelGlobalThreadId</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684536570"><span class="hs-identifier hs-var">constants</span></a></span><span>
</span><span id="line-1276"></span><span>    </span><span id="local-6989586621684536551"><span class="annot"><span class="annottext">array_scan :: Bool
</span><a href="#local-6989586621684536551"><span class="hs-identifier hs-var hs-var">array_scan</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(TypeBase Shape NoUniqueness -&gt; Bool)
-&gt; [TypeBase Shape NoUniqueness] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness -&gt; Bool
forall shape u. TypeBase shape u -&gt; Bool
</span><a href="Futhark.IR.Prop.Types.html#primType"><span class="hs-identifier hs-var">primType</span></a></span><span> </span><span class="annot"><span class="annottext">([TypeBase Shape NoUniqueness] -&gt; Bool)
-&gt; [TypeBase Shape NoUniqueness] -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem -&gt; [TypeBase Shape NoUniqueness]
forall rep. LambdaT rep -&gt; [TypeBase Shape NoUniqueness]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684536562"><span class="hs-identifier hs-var">scan_lam</span></a></span><span>
</span><span id="line-1277"></span><span>
</span><span id="line-1278"></span><span>    </span><span id="local-6989586621684536553"><span class="annot"><span class="annottext">readInitial :: Param LParamMem -&gt; VName -&gt; InKernelGen ()
</span><a href="#local-6989586621684536553"><span class="hs-identifier hs-var hs-var">readInitial</span></a></span></span><span> </span><span id="local-6989586621684536534"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536534"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621684536533"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536533"><span class="hs-identifier hs-var">arr</span></a></span></span><span>
</span><span id="line-1279"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness -&gt; Bool
forall shape u. TypeBase shape u -&gt; Bool
</span><a href="Futhark.IR.Prop.Types.html#primType"><span class="hs-identifier hs-var">primType</span></a></span><span> </span><span class="annot"><span class="annottext">(TypeBase Shape NoUniqueness -&gt; Bool)
-&gt; TypeBase Shape NoUniqueness -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param LParamMem -&gt; TypeBase Shape NoUniqueness
forall dec. Typed dec =&gt; Param dec -&gt; TypeBase Shape NoUniqueness
</span><a href="Futhark.IR.Prop.Patterns.html#paramType"><span class="hs-identifier hs-var">paramType</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536534"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1280"></span><span>        </span><span class="annot"><span class="annottext">VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; InKernelGen ()
forall rep r op.
VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-var">copyDWIM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536534"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536533"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TExp Int64 -&gt; DimIndex (TExp Int64)
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536536"><span class="hs-identifier hs-var">ltid</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1281"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1282"></span><span>        </span><span class="annot"><span class="annottext">VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; InKernelGen ()
forall rep r op.
VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-var">copyDWIM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536534"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536533"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TExp Int64 -&gt; DimIndex (TExp Int64)
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536535"><span class="hs-identifier hs-var">gtid</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1283"></span><span>
</span><span id="line-1284"></span><span>    </span><span id="local-6989586621684536541"><span class="annot"><span class="annottext">readParam :: TExp Int64 -&gt; Param LParamMem -&gt; VName -&gt; InKernelGen ()
</span><a href="#local-6989586621684536541"><span class="hs-identifier hs-var hs-var">readParam</span></a></span></span><span> </span><span id="local-6989586621684536532"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536532"><span class="hs-identifier hs-var">behind</span></a></span></span><span> </span><span id="local-6989586621684536531"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536531"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621684536530"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536530"><span class="hs-identifier hs-var">arr</span></a></span></span><span>
</span><span id="line-1285"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness -&gt; Bool
forall shape u. TypeBase shape u -&gt; Bool
</span><a href="Futhark.IR.Prop.Types.html#primType"><span class="hs-identifier hs-var">primType</span></a></span><span> </span><span class="annot"><span class="annottext">(TypeBase Shape NoUniqueness -&gt; Bool)
-&gt; TypeBase Shape NoUniqueness -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param LParamMem -&gt; TypeBase Shape NoUniqueness
forall dec. Typed dec =&gt; Param dec -&gt; TypeBase Shape NoUniqueness
</span><a href="Futhark.IR.Prop.Patterns.html#paramType"><span class="hs-identifier hs-var">paramType</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536531"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1286"></span><span>        </span><span class="annot"><span class="annottext">VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; InKernelGen ()
forall rep r op.
VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-var">copyDWIM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536531"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536530"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TExp Int64 -&gt; DimIndex (TExp Int64)
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; DimIndex (TExp Int64))
-&gt; TExp Int64 -&gt; DimIndex (TExp Int64)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536536"><span class="hs-identifier hs-var">ltid</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536532"><span class="hs-identifier hs-var">behind</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1287"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1288"></span><span>        </span><span class="annot"><span class="annottext">VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; InKernelGen ()
forall rep r op.
VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-var">copyDWIM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536531"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536530"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TExp Int64 -&gt; DimIndex (TExp Int64)
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; DimIndex (TExp Int64))
-&gt; TExp Int64 -&gt; DimIndex (TExp Int64)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536535"><span class="hs-identifier hs-var">gtid</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536532"><span class="hs-identifier hs-var">behind</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536568"><span class="hs-identifier hs-var">arrs_full_size</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1289"></span><span>
</span><span id="line-1290"></span><span>    </span><span id="local-6989586621684536538"><span class="annot"><span class="annottext">writeResult :: Param LParamMem -&gt; Param LParamMem -&gt; VName -&gt; InKernelGen ()
</span><a href="#local-6989586621684536538"><span class="hs-identifier hs-var hs-var">writeResult</span></a></span></span><span> </span><span id="local-6989586621684536529"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536529"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621684536528"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536528"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span id="local-6989586621684536527"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536527"><span class="hs-identifier hs-var">arr</span></a></span></span><span>
</span><span id="line-1291"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness -&gt; Bool
forall shape u. TypeBase shape u -&gt; Bool
</span><a href="Futhark.IR.Prop.Types.html#primType"><span class="hs-identifier hs-var">primType</span></a></span><span> </span><span class="annot"><span class="annottext">(TypeBase Shape NoUniqueness -&gt; Bool)
-&gt; TypeBase Shape NoUniqueness -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param LParamMem -&gt; TypeBase Shape NoUniqueness
forall dec. Typed dec =&gt; Param dec -&gt; TypeBase Shape NoUniqueness
</span><a href="Futhark.IR.Prop.Patterns.html#paramType"><span class="hs-identifier hs-var">paramType</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536529"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1292"></span><span>        </span><span class="annot"><span class="annottext">VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; InKernelGen ()
forall rep r op.
VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-var">copyDWIM</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536527"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TExp Int64 -&gt; DimIndex (TExp Int64)
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536536"><span class="hs-identifier hs-var">ltid</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SubExp) -&gt; VName -&gt; SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536529"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1293"></span><span>        </span><span class="annot"><span class="annottext">VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; InKernelGen ()
forall rep r op.
VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-var">copyDWIM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536528"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SubExp) -&gt; VName -&gt; SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536529"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1294"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1295"></span><span>        </span><span class="annot"><span class="annottext">VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; InKernelGen ()
forall rep r op.
VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-var">copyDWIM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536528"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SubExp) -&gt; VName -&gt; SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684536529"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1296"></span><span>
</span><span id="line-1297"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#computeMapKernelGroups"><span class="hs-identifier hs-type">computeMapKernelGroups</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#CallKernelGen"><span class="hs-identifier hs-type">CallKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">)</span><span>
</span><span id="line-1298"></span><span id="computeMapKernelGroups"><span class="annot"><span class="annottext">computeMapKernelGroups :: TExp Int64 -&gt; CallKernelGen (TExp Int64, TExp Int64)
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#computeMapKernelGroups"><span class="hs-identifier hs-var hs-var">computeMapKernelGroups</span></a></span></span><span> </span><span id="local-6989586621684536525"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536525"><span class="hs-identifier hs-var">kernel_size</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1299"></span><span>  </span><span id="local-6989586621684536524"><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684536524"><span class="hs-identifier hs-var">group_size</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; PrimType -&gt; ImpM GPUMem HostEnv HostOp (TV Int64)
forall rep r op t. String -&gt; PrimType -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrim"><span class="hs-identifier hs-var">dPrim</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;group_size&quot;</span></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int64"><span class="hs-identifier hs-var">int64</span></a></span><span>
</span><span id="line-1300"></span><span>  </span><span id="local-6989586621684536523"><span class="annot"><span class="annottext">Maybe Name
</span><a href="#local-6989586621684536523"><span class="hs-identifier hs-var">fname</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ImpM GPUMem HostEnv HostOp (Maybe Name)
forall rep r op. ImpM rep r op (Maybe Name)
</span><a href="Futhark.CodeGen.ImpGen.html#askFunction"><span class="hs-identifier hs-var">askFunction</span></a></span><span>
</span><span id="line-1301"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684536522"><span class="annot"><span class="annottext">group_size_key :: Name
</span><a href="#local-6989586621684536522"><span class="hs-identifier hs-var hs-var">group_size_key</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Name -&gt; Name -&gt; Name
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#keyWithEntryPoint"><span class="hs-identifier hs-var">keyWithEntryPoint</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Name
</span><a href="#local-6989586621684536523"><span class="hs-identifier hs-var">fname</span></a></span><span> </span><span class="annot"><span class="annottext">(Name -&gt; Name) -&gt; Name -&gt; Name
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Name
</span><a href="Language.Futhark.Core.html#nameFromString"><span class="hs-identifier hs-var">nameFromString</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Name) -&gt; String -&gt; Name
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; String) -&gt; VName -&gt; String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TV Int64 -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684536524"><span class="hs-identifier hs-var">group_size</span></a></span><span>
</span><span id="line-1302"></span><span>  </span><span class="annot"><span class="annottext">HostOp -&gt; ImpM GPUMem HostEnv HostOp ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">(HostOp -&gt; ImpM GPUMem HostEnv HostOp ())
-&gt; HostOp -&gt; ImpM GPUMem HostEnv HostOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Name -&gt; SizeClass -&gt; HostOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#GetSize"><span class="hs-identifier hs-var">Imp.GetSize</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int64 -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684536524"><span class="hs-identifier hs-var">group_size</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684536522"><span class="hs-identifier hs-var">group_size_key</span></a></span><span> </span><span class="annot"><span class="annottext">SizeClass
</span><a href="Futhark.IR.GPU.Sizes.html#SizeGroup"><span class="hs-identifier hs-var">Imp.SizeGroup</span></a></span><span>
</span><span id="line-1303"></span><span>  </span><span id="local-6989586621684536519"><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684536519"><span class="hs-identifier hs-var">num_groups</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; TExp Int64 -&gt; ImpM GPUMem HostEnv HostOp (TV Int64)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV"><span class="hs-identifier hs-var">dPrimV</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;num_groups&quot;</span></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; ImpM GPUMem HostEnv HostOp (TV Int64))
-&gt; TExp Int64 -&gt; ImpM GPUMem HostEnv HostOp (TV Int64)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536525"><span class="hs-identifier hs-var">kernel_size</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall e. IntegralExp e =&gt; e -&gt; e -&gt; e
</span><a href="Futhark.Util.IntegralExp.html#divUp"><span class="hs-operator hs-var">`divUp`</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64 -&gt; TExp Int64
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684536524"><span class="hs-identifier hs-var">group_size</span></a></span><span>
</span><span id="line-1304"></span><span>  </span><span class="annot"><span class="annottext">(TExp Int64, TExp Int64) -&gt; CallKernelGen (TExp Int64, TExp Int64)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int64 -&gt; TExp Int64
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684536519"><span class="hs-identifier hs-var">num_groups</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TV Int64 -&gt; TExp Int64
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684536524"><span class="hs-identifier hs-var">group_size</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1305"></span><span>
</span><span id="line-1306"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#simpleKernelConstants"><span class="hs-identifier hs-type">simpleKernelConstants</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1307"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1308"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1309"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#CallKernelGen"><span class="hs-identifier hs-type">CallKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#KernelConstants"><span class="hs-identifier hs-type">KernelConstants</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#InKernelGen"><span class="hs-identifier hs-type">InKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1310"></span><span id="simpleKernelConstants"><span class="annot"><span class="annottext">simpleKernelConstants :: TExp Int64
-&gt; String -&gt; CallKernelGen (KernelConstants, InKernelGen ())
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#simpleKernelConstants"><span class="hs-identifier hs-var hs-var">simpleKernelConstants</span></a></span></span><span> </span><span id="local-6989586621684536517"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536517"><span class="hs-identifier hs-var">kernel_size</span></a></span></span><span> </span><span id="local-6989586621684536516"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621684536516"><span class="hs-identifier hs-var">desc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1311"></span><span>  </span><span id="local-6989586621684536515"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536515"><span class="hs-identifier hs-var">thread_gtid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; ImpM GPUMem HostEnv HostOp VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; String -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; ImpM GPUMem HostEnv HostOp VName)
-&gt; String -&gt; ImpM GPUMem HostEnv HostOp VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621684536516"><span class="hs-identifier hs-var">desc</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_gtid&quot;</span></span><span>
</span><span id="line-1312"></span><span>  </span><span id="local-6989586621684536514"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536514"><span class="hs-identifier hs-var">thread_ltid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; ImpM GPUMem HostEnv HostOp VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; String -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; ImpM GPUMem HostEnv HostOp VName)
-&gt; String -&gt; ImpM GPUMem HostEnv HostOp VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621684536516"><span class="hs-identifier hs-var">desc</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_ltid&quot;</span></span><span>
</span><span id="line-1313"></span><span>  </span><span id="local-6989586621684536513"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536513"><span class="hs-identifier hs-var">group_id</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; ImpM GPUMem HostEnv HostOp VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; String -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; ImpM GPUMem HostEnv HostOp VName)
-&gt; String -&gt; ImpM GPUMem HostEnv HostOp VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621684536516"><span class="hs-identifier hs-var">desc</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_gid&quot;</span></span><span>
</span><span id="line-1314"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684536512"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536512"><span class="hs-identifier hs-var">num_groups</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684536511"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536511"><span class="hs-identifier hs-var">group_size</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; CallKernelGen (TExp Int64, TExp Int64)
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#computeMapKernelGroups"><span class="hs-identifier hs-var">computeMapKernelGroups</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536517"><span class="hs-identifier hs-var">kernel_size</span></a></span><span>
</span><span id="line-1315"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684536510"><span class="annot"><span class="annottext">set_constants :: InKernelGen ()
</span><a href="#local-6989586621684536510"><span class="hs-identifier hs-var hs-var">set_constants</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1316"></span><span>        </span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; InKernelGen ()
forall rep r op. VName -&gt; PrimType -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dPrim_"><span class="hs-identifier hs-var">dPrim_</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536515"><span class="hs-identifier hs-var">thread_gtid</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int32"><span class="hs-identifier hs-var">int32</span></a></span><span>
</span><span id="line-1317"></span><span>        </span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; InKernelGen ()
forall rep r op. VName -&gt; PrimType -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dPrim_"><span class="hs-identifier hs-var">dPrim_</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536514"><span class="hs-identifier hs-var">thread_ltid</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int32"><span class="hs-identifier hs-var">int32</span></a></span><span>
</span><span id="line-1318"></span><span>        </span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; InKernelGen ()
forall rep r op. VName -&gt; PrimType -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dPrim_"><span class="hs-identifier hs-var">dPrim_</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536513"><span class="hs-identifier hs-var">group_id</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int32"><span class="hs-identifier hs-var">int32</span></a></span><span>
</span><span id="line-1319"></span><span>        </span><span class="annot"><span class="annottext">KernelOp -&gt; InKernelGen ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Int -&gt; KernelOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#GetGlobalId"><span class="hs-identifier hs-var">Imp.GetGlobalId</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536515"><span class="hs-identifier hs-var">thread_gtid</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-1320"></span><span>        </span><span class="annot"><span class="annottext">KernelOp -&gt; InKernelGen ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Int -&gt; KernelOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#GetLocalId"><span class="hs-identifier hs-var">Imp.GetLocalId</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536514"><span class="hs-identifier hs-var">thread_ltid</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-1321"></span><span>        </span><span class="annot"><span class="annottext">KernelOp -&gt; InKernelGen ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Int -&gt; KernelOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#GetGroupId"><span class="hs-identifier hs-var">Imp.GetGroupId</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536513"><span class="hs-identifier hs-var">group_id</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-1322"></span><span>
</span><span id="line-1323"></span><span>  </span><span class="annot"><span class="annottext">(KernelConstants, InKernelGen ())
-&gt; CallKernelGen (KernelConstants, InKernelGen ())
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-1324"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">TExp Int32
-&gt; TExp Int32
-&gt; TExp Int32
-&gt; VName
-&gt; VName
-&gt; VName
-&gt; TExp Int64
-&gt; TExp Int64
-&gt; TExp Int32
-&gt; TExp Int32
-&gt; TExp Bool
-&gt; Map [SubExp] [TExp Int32]
-&gt; KernelConstants
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#KernelConstants"><span class="hs-identifier hs-var">KernelConstants</span></a></span><span>
</span><span id="line-1325"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; TExp Int32
forall a. a -&gt; TPrimExp Int32 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le32"><span class="hs-identifier hs-var">Imp.le32</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536515"><span class="hs-identifier hs-var">thread_gtid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1326"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; TExp Int32
forall a. a -&gt; TPrimExp Int32 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le32"><span class="hs-identifier hs-var">Imp.le32</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536514"><span class="hs-identifier hs-var">thread_ltid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1327"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; TExp Int32
forall a. a -&gt; TPrimExp Int32 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le32"><span class="hs-identifier hs-var">Imp.le32</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536513"><span class="hs-identifier hs-var">group_id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1328"></span><span>        </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536515"><span class="hs-identifier hs-var">thread_gtid</span></a></span><span>
</span><span id="line-1329"></span><span>        </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536514"><span class="hs-identifier hs-var">thread_ltid</span></a></span><span>
</span><span id="line-1330"></span><span>        </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536513"><span class="hs-identifier hs-var">group_id</span></a></span><span>
</span><span id="line-1331"></span><span>        </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536512"><span class="hs-identifier hs-var">num_groups</span></a></span><span>
</span><span id="line-1332"></span><span>        </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536511"><span class="hs-identifier hs-var">group_size</span></a></span><span>
</span><span id="line-1333"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int32
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int32 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt32"><span class="hs-identifier hs-var">sExt32</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536511"><span class="hs-identifier hs-var">group_size</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536512"><span class="hs-identifier hs-var">num_groups</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1334"></span><span>        </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">0</span></span><span>
</span><span id="line-1335"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; TExp Int64
forall a. a -&gt; TPrimExp Int64 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le64"><span class="hs-identifier hs-var">Imp.le64</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536515"><span class="hs-identifier hs-var">thread_gtid</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Bool
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3C."><span class="hs-operator hs-var">.&lt;.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536517"><span class="hs-identifier hs-var">kernel_size</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1336"></span><span>        </span><span class="annot"><span class="annottext">Map [SubExp] [TExp Int32]
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">,</span><span>
</span><span id="line-1337"></span><span>      </span><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684536510"><span class="hs-identifier hs-var">set_constants</span></a></span><span>
</span><span id="line-1338"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-1339"></span><span>
</span><span id="line-1340"></span><span class="hs-comment">-- | For many kernels, we may not have enough physical groups to cover</span><span>
</span><span id="line-1341"></span><span class="hs-comment">-- the logical iteration space.  Some groups thus have to perform</span><span>
</span><span id="line-1342"></span><span class="hs-comment">-- double duty; we put an outer loop to accomplish this.  The</span><span>
</span><span id="line-1343"></span><span class="hs-comment">-- advantage over just launching a bazillion threads is that the cost</span><span>
</span><span id="line-1344"></span><span class="hs-comment">-- of memory expansion should be proportional to the number of</span><span>
</span><span id="line-1345"></span><span class="hs-comment">-- *physical* threads (hardware parallelism), not the amount of</span><span>
</span><span id="line-1346"></span><span class="hs-comment">-- application parallelism.</span><span>
</span><span id="line-1347"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#virtualiseGroups"><span class="hs-identifier hs-type">virtualiseGroups</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1348"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegVirt"><span class="hs-identifier hs-type">SegVirt</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1349"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1350"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#InKernelGen"><span class="hs-identifier hs-type">InKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1351"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#InKernelGen"><span class="hs-identifier hs-type">InKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1352"></span><span id="virtualiseGroups"><span class="annot"><span class="annottext">virtualiseGroups :: SegVirt
-&gt; TExp Int32 -&gt; (TExp Int32 -&gt; InKernelGen ()) -&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#virtualiseGroups"><span class="hs-identifier hs-var hs-var">virtualiseGroups</span></a></span></span><span> </span><span class="annot"><span class="annottext">SegVirt
</span><a href="Futhark.IR.SegOp.html#SegVirt"><span class="hs-identifier hs-var">SegVirt</span></a></span><span> </span><span id="local-6989586621684536508"><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536508"><span class="hs-identifier hs-var">required_groups</span></a></span></span><span> </span><span id="local-6989586621684536507"><span class="annot"><span class="annottext">TExp Int32 -&gt; InKernelGen ()
</span><a href="#local-6989586621684536507"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1353"></span><span>  </span><span id="local-6989586621684536506"><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684536506"><span class="hs-identifier hs-var">constants</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">KernelEnv -&gt; KernelConstants
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelConstants"><span class="hs-identifier hs-var hs-var">kernelConstants</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelEnv -&gt; KernelConstants)
-&gt; ImpM GPUMem KernelEnv KernelOp KernelEnv
-&gt; ImpM GPUMem KernelEnv KernelOp KernelConstants
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ImpM GPUMem KernelEnv KernelOp KernelEnv
forall rep r op. ImpM rep r op r
</span><a href="Futhark.CodeGen.ImpGen.html#askEnv"><span class="hs-identifier hs-var">askEnv</span></a></span><span>
</span><span id="line-1354"></span><span>  </span><span id="local-6989586621684536505"><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684536505"><span class="hs-identifier hs-var">phys_group_id</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; PrimType -&gt; ImpM GPUMem KernelEnv KernelOp (TV Int32)
forall rep r op t. String -&gt; PrimType -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrim"><span class="hs-identifier hs-var">dPrim</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;phys_group_id&quot;</span></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int32"><span class="hs-identifier hs-var">int32</span></a></span><span>
</span><span id="line-1355"></span><span>  </span><span class="annot"><span class="annottext">KernelOp -&gt; InKernelGen ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelOp -&gt; InKernelGen ()) -&gt; KernelOp -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Int -&gt; KernelOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#GetGroupId"><span class="hs-identifier hs-var">Imp.GetGroupId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int32 -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684536505"><span class="hs-identifier hs-var">phys_group_id</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-1356"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684536504"><span class="annot"><span class="annottext">iterations :: TExp Int32
</span><a href="#local-6989586621684536504"><span class="hs-identifier hs-var hs-var">iterations</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1357"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536508"><span class="hs-identifier hs-var">required_groups</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">TV Int32 -&gt; TExp Int32
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684536505"><span class="hs-identifier hs-var">phys_group_id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1358"></span><span>          </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall e. IntegralExp e =&gt; e -&gt; e -&gt; e
</span><a href="Futhark.Util.IntegralExp.html#divUp"><span class="hs-operator hs-var">`divUp`</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int32
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int32 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt32"><span class="hs-identifier hs-var">sExt32</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelNumGroups"><span class="hs-identifier hs-var hs-var">kernelNumGroups</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684536506"><span class="hs-identifier hs-var">constants</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1359"></span><span>
</span><span id="line-1360"></span><span>  </span><span class="annot"><span class="annottext">String
-&gt; TExp Int32 -&gt; (TExp Int32 -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall t rep r op.
String
-&gt; TExp t -&gt; (TExp t -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sFor"><span class="hs-identifier hs-var">sFor</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;i&quot;</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536504"><span class="hs-identifier hs-var">iterations</span></a></span><span> </span><span class="annot"><span class="annottext">((TExp Int32 -&gt; InKernelGen ()) -&gt; InKernelGen ())
-&gt; (TExp Int32 -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684536503"><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536503"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1361"></span><span>    </span><span class="annot"><span class="annottext">TExp Int32 -&gt; InKernelGen ()
</span><a href="#local-6989586621684536507"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int32 -&gt; InKernelGen ())
-&gt; (TV Int32 -&gt; TExp Int32) -&gt; TV Int32 -&gt; InKernelGen ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TV Int32 -&gt; TExp Int32
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span>
</span><span id="line-1362"></span><span>      </span><span class="annot"><span class="annottext">(TV Int32 -&gt; InKernelGen ())
-&gt; ImpM GPUMem KernelEnv KernelOp (TV Int32) -&gt; InKernelGen ()
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; TExp Int32 -&gt; ImpM GPUMem KernelEnv KernelOp (TV Int32)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV"><span class="hs-identifier hs-var">dPrimV</span></a></span><span>
</span><span id="line-1363"></span><span>        </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;virt_group_id&quot;</span></span><span>
</span><span id="line-1364"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int32 -&gt; TExp Int32
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684536505"><span class="hs-identifier hs-var">phys_group_id</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684536503"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int32
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int32 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt32"><span class="hs-identifier hs-var">sExt32</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelNumGroups"><span class="hs-identifier hs-var hs-var">kernelNumGroups</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684536506"><span class="hs-identifier hs-var">constants</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1365"></span><span>    </span><span class="hs-comment">-- Make sure the virtual group is actually done before we let</span><span>
</span><span id="line-1366"></span><span>    </span><span class="hs-comment">-- another virtual group have its way with it.</span><span>
</span><span id="line-1367"></span><span>    </span><span class="annot"><span class="annottext">KernelOp -&gt; InKernelGen ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelOp -&gt; InKernelGen ()) -&gt; KernelOp -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Fence -&gt; KernelOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#Barrier"><span class="hs-identifier hs-var">Imp.Barrier</span></a></span><span> </span><span class="annot"><span class="annottext">Fence
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#FenceGlobal"><span class="hs-identifier hs-var">Imp.FenceGlobal</span></a></span><span>
</span><span id="line-1368"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#virtualiseGroups"><span class="hs-identifier hs-var">virtualiseGroups</span></a></span><span> </span><span class="annot"><span class="annottext">SegVirt
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684536502"><span class="annot"><span class="annottext">TExp Int32 -&gt; InKernelGen ()
</span><a href="#local-6989586621684536502"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1369"></span><span>  </span><span id="local-6989586621684536501"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536501"><span class="hs-identifier hs-var">gid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelGroupIdVar"><span class="hs-identifier hs-var hs-var">kernelGroupIdVar</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelConstants -&gt; VName)
-&gt; (KernelEnv -&gt; KernelConstants) -&gt; KernelEnv -&gt; VName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">KernelEnv -&gt; KernelConstants
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelConstants"><span class="hs-identifier hs-var hs-var">kernelConstants</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelEnv -&gt; VName)
-&gt; ImpM GPUMem KernelEnv KernelOp KernelEnv
-&gt; ImpM GPUMem KernelEnv KernelOp VName
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ImpM GPUMem KernelEnv KernelOp KernelEnv
forall rep r op. ImpM rep r op r
</span><a href="Futhark.CodeGen.ImpGen.html#askEnv"><span class="hs-identifier hs-var">askEnv</span></a></span><span>
</span><span id="line-1370"></span><span>  </span><span class="annot"><span class="annottext">TExp Int32 -&gt; InKernelGen ()
</span><a href="#local-6989586621684536502"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int32 -&gt; InKernelGen ()) -&gt; TExp Int32 -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TExp Int32
forall a. a -&gt; TPrimExp Int32 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le32"><span class="hs-identifier hs-var">Imp.le32</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536501"><span class="hs-identifier hs-var">gid</span></a></span><span>
</span><span id="line-1371"></span><span>
</span><span id="line-1372"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#sKernelThread"><span class="hs-identifier hs-type">sKernelThread</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1373"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1374"></span><span>  </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-type">Count</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#NumGroups"><span class="hs-identifier hs-type">NumGroups</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1375"></span><span>  </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-type">Count</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#GroupSize"><span class="hs-identifier hs-type">GroupSize</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1376"></span><span>  </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1377"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#InKernelGen"><span class="hs-identifier hs-type">InKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1378"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#CallKernelGen"><span class="hs-identifier hs-type">CallKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1379"></span><span id="sKernelThread"><span class="annot"><span class="annottext">sKernelThread :: String
-&gt; Count NumGroups (TExp Int64)
-&gt; Count GroupSize (TExp Int64)
-&gt; VName
-&gt; InKernelGen ()
-&gt; ImpM GPUMem HostEnv HostOp ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#sKernelThread"><span class="hs-identifier hs-var hs-var">sKernelThread</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Operations GPUMem KernelEnv KernelOp
-&gt; (KernelConstants -&gt; TExp Int32)
-&gt; String
-&gt; Count NumGroups (TExp Int64)
-&gt; Count GroupSize (TExp Int64)
-&gt; VName
-&gt; InKernelGen ()
-&gt; ImpM GPUMem HostEnv HostOp ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#sKernel"><span class="hs-identifier hs-var">sKernel</span></a></span><span> </span><span class="annot"><span class="annottext">Operations GPUMem KernelEnv KernelOp
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#threadOperations"><span class="hs-identifier hs-var">threadOperations</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelGlobalThreadId"><span class="hs-identifier hs-var hs-var">kernelGlobalThreadId</span></a></span><span>
</span><span id="line-1380"></span><span>
</span><span id="line-1381"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#sKernelGroup"><span class="hs-identifier hs-type">sKernelGroup</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1382"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1383"></span><span>  </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-type">Count</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#NumGroups"><span class="hs-identifier hs-type">NumGroups</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1384"></span><span>  </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-type">Count</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#GroupSize"><span class="hs-identifier hs-type">GroupSize</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1385"></span><span>  </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1386"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#InKernelGen"><span class="hs-identifier hs-type">InKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1387"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#CallKernelGen"><span class="hs-identifier hs-type">CallKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1388"></span><span id="sKernelGroup"><span class="annot"><span class="annottext">sKernelGroup :: String
-&gt; Count NumGroups (TExp Int64)
-&gt; Count GroupSize (TExp Int64)
-&gt; VName
-&gt; InKernelGen ()
-&gt; ImpM GPUMem HostEnv HostOp ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#sKernelGroup"><span class="hs-identifier hs-var hs-var">sKernelGroup</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Operations GPUMem KernelEnv KernelOp
-&gt; (KernelConstants -&gt; TExp Int32)
-&gt; String
-&gt; Count NumGroups (TExp Int64)
-&gt; Count GroupSize (TExp Int64)
-&gt; VName
-&gt; InKernelGen ()
-&gt; ImpM GPUMem HostEnv HostOp ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#sKernel"><span class="hs-identifier hs-var">sKernel</span></a></span><span> </span><span class="annot"><span class="annottext">Operations GPUMem KernelEnv KernelOp
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#groupOperations"><span class="hs-identifier hs-var">groupOperations</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelGroupId"><span class="hs-identifier hs-var hs-var">kernelGroupId</span></a></span><span>
</span><span id="line-1389"></span><span>
</span><span id="line-1390"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#sKernelFailureTolerant"><span class="hs-identifier hs-type">sKernelFailureTolerant</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1391"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1392"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#Operations"><span class="hs-identifier hs-type">Operations</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#KernelEnv"><span class="hs-identifier hs-type">KernelEnv</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.GPU.html#KernelOp"><span class="hs-identifier hs-type">Imp.KernelOp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1393"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#KernelConstants"><span class="hs-identifier hs-type">KernelConstants</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1394"></span><span>  </span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1395"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#InKernelGen"><span class="hs-identifier hs-type">InKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1396"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#CallKernelGen"><span class="hs-identifier hs-type">CallKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1397"></span><span id="sKernelFailureTolerant"><span class="annot"><span class="annottext">sKernelFailureTolerant :: Bool
-&gt; Operations GPUMem KernelEnv KernelOp
-&gt; KernelConstants
-&gt; Name
-&gt; InKernelGen ()
-&gt; ImpM GPUMem HostEnv HostOp ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#sKernelFailureTolerant"><span class="hs-identifier hs-var hs-var">sKernelFailureTolerant</span></a></span></span><span> </span><span id="local-6989586621684536497"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684536497"><span class="hs-identifier hs-var">tol</span></a></span></span><span> </span><span id="local-6989586621684536496"><span class="annot"><span class="annottext">Operations GPUMem KernelEnv KernelOp
</span><a href="#local-6989586621684536496"><span class="hs-identifier hs-var">ops</span></a></span></span><span> </span><span id="local-6989586621684536495"><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684536495"><span class="hs-identifier hs-var">constants</span></a></span></span><span> </span><span id="local-6989586621684536494"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684536494"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621684536493"><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684536493"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1398"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#HostEnv"><span class="hs-identifier hs-type">HostEnv</span></a></span><span> </span><span id="local-6989586621684536492"><span class="annot"><span class="annottext">AtomicBinOp
</span><a href="#local-6989586621684536492"><span class="hs-identifier hs-var">atomics</span></a></span></span><span> </span><span class="annot"><span class="annottext">Target
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684536491"><span class="annot"><span class="annottext">Map VName Locks
</span><a href="#local-6989586621684536491"><span class="hs-identifier hs-var">locks</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ImpM GPUMem HostEnv HostOp HostEnv
forall rep r op. ImpM rep r op r
</span><a href="Futhark.CodeGen.ImpGen.html#askEnv"><span class="hs-identifier hs-var">askEnv</span></a></span><span>
</span><span id="line-1399"></span><span>  </span><span id="local-6989586621684536490"><span class="annot"><span class="annottext">Code KernelOp
</span><a href="#local-6989586621684536490"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CallKernelGen (Code KernelOp) -&gt; CallKernelGen (Code KernelOp)
forall a. CallKernelGen a -&gt; CallKernelGen a
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#makeAllMemoryGlobal"><span class="hs-identifier hs-var">makeAllMemoryGlobal</span></a></span><span> </span><span class="annot"><span class="annottext">(CallKernelGen (Code KernelOp) -&gt; CallKernelGen (Code KernelOp))
-&gt; CallKernelGen (Code KernelOp) -&gt; CallKernelGen (Code KernelOp)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KernelEnv
-&gt; Operations GPUMem KernelEnv KernelOp
-&gt; InKernelGen ()
-&gt; CallKernelGen (Code KernelOp)
forall r' rep op' a r op.
r'
-&gt; Operations rep r' op'
-&gt; ImpM rep r' op' a
-&gt; ImpM rep r op (Code op')
</span><a href="Futhark.CodeGen.ImpGen.html#subImpM_"><span class="hs-identifier hs-var">subImpM_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AtomicBinOp -&gt; KernelConstants -&gt; Map VName Locks -&gt; KernelEnv
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#KernelEnv"><span class="hs-identifier hs-var">KernelEnv</span></a></span><span> </span><span class="annot"><span class="annottext">AtomicBinOp
</span><a href="#local-6989586621684536492"><span class="hs-identifier hs-var">atomics</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684536495"><span class="hs-identifier hs-var">constants</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName Locks
</span><a href="#local-6989586621684536491"><span class="hs-identifier hs-var">locks</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Operations GPUMem KernelEnv KernelOp
</span><a href="#local-6989586621684536496"><span class="hs-identifier hs-var">ops</span></a></span><span> </span><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684536493"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-1400"></span><span>  </span><span id="local-6989586621684536488"><span class="annot"><span class="annottext">[KernelUse]
</span><a href="#local-6989586621684536488"><span class="hs-identifier hs-var">uses</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Code KernelOp -&gt; [VName] -&gt; CallKernelGen [KernelUse]
forall a. FreeIn a =&gt; a -&gt; [VName] -&gt; CallKernelGen [KernelUse]
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#computeKernelUses"><span class="hs-identifier hs-var">computeKernelUses</span></a></span><span> </span><span class="annot"><span class="annottext">Code KernelOp
</span><a href="#local-6989586621684536490"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-1401"></span><span>  </span><span class="annot"><span class="annottext">Code HostOp -&gt; ImpM GPUMem HostEnv HostOp ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code HostOp -&gt; ImpM GPUMem HostEnv HostOp ())
-&gt; Code HostOp -&gt; ImpM GPUMem HostEnv HostOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1402"></span><span>    </span><span class="annot"><span class="annottext">HostOp -&gt; Code HostOp
forall a. a -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#Op"><span class="hs-identifier hs-var">Imp.Op</span></a></span><span> </span><span class="annot"><span class="annottext">(HostOp -&gt; Code HostOp) -&gt; HostOp -&gt; Code HostOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1403"></span><span>      </span><span class="annot"><span class="annottext">Kernel -&gt; HostOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#CallKernel"><span class="hs-identifier hs-var">Imp.CallKernel</span></a></span><span>
</span><span id="line-1404"></span><span>        </span><span class="annot"><span class="annottext">Kernel :: Code KernelOp
-&gt; [KernelUse]
-&gt; [PrimExp VName]
-&gt; [PrimExp VName]
-&gt; Name
-&gt; Bool
-&gt; Kernel
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#Kernel"><span class="hs-identifier hs-type">Imp.Kernel</span></a></span><span>
</span><span id="line-1405"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">kernelBody :: Code KernelOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#kernelBody"><span class="hs-identifier hs-var">Imp.kernelBody</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Code KernelOp
</span><a href="#local-6989586621684536490"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1406"></span><span>            </span><span class="annot"><span class="annottext">kernelUses :: [KernelUse]
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#kernelUses"><span class="hs-identifier hs-var">Imp.kernelUses</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[KernelUse]
</span><a href="#local-6989586621684536488"><span class="hs-identifier hs-var">uses</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1407"></span><span>            </span><span class="annot"><span class="annottext">kernelNumGroups :: [PrimExp VName]
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#kernelNumGroups"><span class="hs-identifier hs-var">Imp.kernelNumGroups</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TExp Int64 -&gt; PrimExp VName
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; PrimExp VName) -&gt; TExp Int64 -&gt; PrimExp VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelNumGroups"><span class="hs-identifier hs-var hs-var">kernelNumGroups</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684536495"><span class="hs-identifier hs-var">constants</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><span id="line-1408"></span><span>            </span><span class="annot"><span class="annottext">kernelGroupSize :: [PrimExp VName]
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#kernelGroupSize"><span class="hs-identifier hs-var">Imp.kernelGroupSize</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TExp Int64 -&gt; PrimExp VName
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; PrimExp VName) -&gt; TExp Int64 -&gt; PrimExp VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelGroupSize"><span class="hs-identifier hs-var hs-var">kernelGroupSize</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684536495"><span class="hs-identifier hs-var">constants</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><span id="line-1409"></span><span>            </span><span class="annot"><span class="annottext">kernelName :: Name
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#kernelName"><span class="hs-identifier hs-var">Imp.kernelName</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684536494"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1410"></span><span>            </span><span class="annot"><span class="annottext">kernelFailureTolerant :: Bool
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#kernelFailureTolerant"><span class="hs-identifier hs-var">Imp.kernelFailureTolerant</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684536497"><span class="hs-identifier hs-var">tol</span></a></span><span>
</span><span id="line-1411"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-1412"></span><span>
</span><span id="line-1413"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#sKernel"><span class="hs-identifier hs-type">sKernel</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1414"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#Operations"><span class="hs-identifier hs-type">Operations</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#KernelEnv"><span class="hs-identifier hs-type">KernelEnv</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.GPU.html#KernelOp"><span class="hs-identifier hs-type">Imp.KernelOp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1415"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#KernelConstants"><span class="hs-identifier hs-type">KernelConstants</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1416"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1417"></span><span>  </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-type">Count</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#NumGroups"><span class="hs-identifier hs-type">NumGroups</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1418"></span><span>  </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-type">Count</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#GroupSize"><span class="hs-identifier hs-type">GroupSize</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1419"></span><span>  </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1420"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#InKernelGen"><span class="hs-identifier hs-type">InKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1421"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#CallKernelGen"><span class="hs-identifier hs-type">CallKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1422"></span><span id="sKernel"><span class="annot"><span class="annottext">sKernel :: Operations GPUMem KernelEnv KernelOp
-&gt; (KernelConstants -&gt; TExp Int32)
-&gt; String
-&gt; Count NumGroups (TExp Int64)
-&gt; Count GroupSize (TExp Int64)
-&gt; VName
-&gt; InKernelGen ()
-&gt; ImpM GPUMem HostEnv HostOp ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#sKernel"><span class="hs-identifier hs-var hs-var">sKernel</span></a></span></span><span> </span><span id="local-6989586621684536477"><span class="annot"><span class="annottext">Operations GPUMem KernelEnv KernelOp
</span><a href="#local-6989586621684536477"><span class="hs-identifier hs-var">ops</span></a></span></span><span> </span><span id="local-6989586621684536476"><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="#local-6989586621684536476"><span class="hs-identifier hs-var">flatf</span></a></span></span><span> </span><span id="local-6989586621684536475"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621684536475"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621684536474"><span class="annot"><span class="annottext">Count NumGroups (TExp Int64)
</span><a href="#local-6989586621684536474"><span class="hs-identifier hs-var">num_groups</span></a></span></span><span> </span><span id="local-6989586621684536473"><span class="annot"><span class="annottext">Count GroupSize (TExp Int64)
</span><a href="#local-6989586621684536473"><span class="hs-identifier hs-var">group_size</span></a></span></span><span> </span><span id="local-6989586621684536472"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536472"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621684536471"><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684536471"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1423"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684536470"><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684536470"><span class="hs-identifier hs-var">constants</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684536469"><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684536469"><span class="hs-identifier hs-var">set_constants</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Count NumGroups (TExp Int64)
-&gt; Count GroupSize (TExp Int64)
-&gt; CallKernelGen (KernelConstants, InKernelGen ())
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelInitialisationSimple"><span class="hs-identifier hs-var">kernelInitialisationSimple</span></a></span><span> </span><span class="annot"><span class="annottext">Count NumGroups (TExp Int64)
</span><a href="#local-6989586621684536474"><span class="hs-identifier hs-var">num_groups</span></a></span><span> </span><span class="annot"><span class="annottext">Count GroupSize (TExp Int64)
</span><a href="#local-6989586621684536473"><span class="hs-identifier hs-var">group_size</span></a></span><span>
</span><span id="line-1424"></span><span>  </span><span id="local-6989586621684536468"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684536468"><span class="hs-identifier hs-var">name'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; ImpM GPUMem HostEnv HostOp Name
forall rep r op. String -&gt; ImpM rep r op Name
</span><a href="Futhark.CodeGen.ImpGen.html#nameForFun"><span class="hs-identifier hs-var">nameForFun</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; ImpM GPUMem HostEnv HostOp Name)
-&gt; String -&gt; ImpM GPUMem HostEnv HostOp Name
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621684536475"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Int
</span><a href="Language.Futhark.Core.html#baseTag"><span class="hs-identifier hs-var">baseTag</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536472"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1425"></span><span>  </span><span class="annot"><span class="annottext">Bool
-&gt; Operations GPUMem KernelEnv KernelOp
-&gt; KernelConstants
-&gt; Name
-&gt; InKernelGen ()
-&gt; ImpM GPUMem HostEnv HostOp ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#sKernelFailureTolerant"><span class="hs-identifier hs-var">sKernelFailureTolerant</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">Operations GPUMem KernelEnv KernelOp
</span><a href="#local-6989586621684536477"><span class="hs-identifier hs-var">ops</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684536470"><span class="hs-identifier hs-var">constants</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684536468"><span class="hs-identifier hs-var">name'</span></a></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; ImpM GPUMem HostEnv HostOp ())
-&gt; InKernelGen () -&gt; ImpM GPUMem HostEnv HostOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1426"></span><span>    </span><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684536469"><span class="hs-identifier hs-var">set_constants</span></a></span><span>
</span><span id="line-1427"></span><span>    </span><span class="annot"><span class="annottext">VName -&gt; TExp Int32 -&gt; InKernelGen ()
forall t rep r op. VName -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV_"><span class="hs-identifier hs-var">dPrimV_</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536472"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int32 -&gt; InKernelGen ()) -&gt; TExp Int32 -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="#local-6989586621684536476"><span class="hs-identifier hs-var">flatf</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684536470"><span class="hs-identifier hs-var">constants</span></a></span><span>
</span><span id="line-1428"></span><span>    </span><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684536471"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-1429"></span><span>
</span><span id="line-1430"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#copyInGroup"><span class="hs-identifier hs-type">copyInGroup</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#CopyCompiler"><span class="hs-identifier hs-type">CopyCompiler</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#KernelEnv"><span class="hs-identifier hs-type">KernelEnv</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.GPU.html#KernelOp"><span class="hs-identifier hs-type">Imp.KernelOp</span></a></span><span>
</span><span id="line-1431"></span><span id="copyInGroup"><span class="annot"><span class="annottext">copyInGroup :: CopyCompiler GPUMem KernelEnv KernelOp
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#copyInGroup"><span class="hs-identifier hs-var hs-var">copyInGroup</span></a></span></span><span> </span><span id="local-6989586621684536464"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684536464"><span class="hs-identifier hs-var">pt</span></a></span></span><span> </span><span id="local-6989586621684536463"><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684536463"><span class="hs-identifier hs-var">destloc</span></a></span></span><span> </span><span id="local-6989586621684536462"><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684536462"><span class="hs-identifier hs-var">srcloc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1432"></span><span>  </span><span id="local-6989586621684536461"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684536461"><span class="hs-identifier hs-var">dest_space</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MemEntry -&gt; Space
</span><a href="Futhark.CodeGen.ImpGen.html#entryMemSpace"><span class="hs-identifier hs-var hs-var">entryMemSpace</span></a></span><span> </span><span class="annot"><span class="annottext">(MemEntry -&gt; Space)
-&gt; ImpM GPUMem KernelEnv KernelOp MemEntry
-&gt; ImpM GPUMem KernelEnv KernelOp Space
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; ImpM GPUMem KernelEnv KernelOp MemEntry
forall rep r op. VName -&gt; ImpM rep r op MemEntry
</span><a href="Futhark.CodeGen.ImpGen.html#lookupMemory"><span class="hs-identifier hs-var">lookupMemory</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MemLoc -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#memLocName"><span class="hs-identifier hs-var hs-var">memLocName</span></a></span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684536463"><span class="hs-identifier hs-var">destloc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1433"></span><span>  </span><span id="local-6989586621684536460"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684536460"><span class="hs-identifier hs-var">src_space</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MemEntry -&gt; Space
</span><a href="Futhark.CodeGen.ImpGen.html#entryMemSpace"><span class="hs-identifier hs-var hs-var">entryMemSpace</span></a></span><span> </span><span class="annot"><span class="annottext">(MemEntry -&gt; Space)
-&gt; ImpM GPUMem KernelEnv KernelOp MemEntry
-&gt; ImpM GPUMem KernelEnv KernelOp Space
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; ImpM GPUMem KernelEnv KernelOp MemEntry
forall rep r op. VName -&gt; ImpM rep r op MemEntry
</span><a href="Futhark.CodeGen.ImpGen.html#lookupMemory"><span class="hs-identifier hs-var">lookupMemory</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MemLoc -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#memLocName"><span class="hs-identifier hs-var hs-var">memLocName</span></a></span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684536462"><span class="hs-identifier hs-var">srcloc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1434"></span><span>
</span><span id="line-1435"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684536459"><span class="annot"><span class="annottext">src_ixfun :: IxFun
</span><a href="#local-6989586621684536459"><span class="hs-identifier hs-var hs-var">src_ixfun</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MemLoc -&gt; IxFun
</span><a href="Futhark.CodeGen.ImpGen.html#memLocIxFun"><span class="hs-identifier hs-var hs-var">memLocIxFun</span></a></span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684536462"><span class="hs-identifier hs-var">srcloc</span></a></span><span>
</span><span id="line-1436"></span><span>      </span><span id="local-6989586621684536457"><span class="annot"><span class="annottext">dims :: [TExp Int64]
</span><a href="#local-6989586621684536457"><span class="hs-identifier hs-var hs-var">dims</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IxFun -&gt; [TExp Int64]
forall num. (Eq num, IntegralExp num) =&gt; IxFun num -&gt; Shape num
</span><a href="Futhark.IR.Mem.IxFun.html#shape"><span class="hs-identifier hs-var">IxFun.shape</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun
</span><a href="#local-6989586621684536459"><span class="hs-identifier hs-var">src_ixfun</span></a></span><span>
</span><span id="line-1437"></span><span>      </span><span id="local-6989586621684536455"><span class="annot"><span class="annottext">rank :: Int
</span><a href="#local-6989586621684536455"><span class="hs-identifier hs-var hs-var">rank</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536457"><span class="hs-identifier hs-var">dims</span></a></span><span>
</span><span id="line-1438"></span><span>
</span><span id="line-1439"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684536461"><span class="hs-identifier hs-var">dest_space</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684536460"><span class="hs-identifier hs-var">src_space</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1440"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#ScalarSpace"><span class="hs-identifier hs-type">ScalarSpace</span></a></span><span> </span><span id="local-6989586621684536454"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684536454"><span class="hs-identifier hs-var">destds</span></a></span></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#ScalarSpace"><span class="hs-identifier hs-type">ScalarSpace</span></a></span><span> </span><span id="local-6989586621684536453"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684536453"><span class="hs-identifier hs-var">srcds</span></a></span></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1441"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684536449"><span class="annot"><span class="annottext">fullDim :: d -&gt; DimIndex d
</span><a href="#local-6989586621684536449"><span class="hs-identifier hs-var hs-var">fullDim</span></a></span></span><span> </span><span id="local-6989586621684536448"><span class="annot"><span class="annottext">d
</span><a href="#local-6989586621684536448"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">d -&gt; d -&gt; d -&gt; DimIndex d
forall d. d -&gt; d -&gt; d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimSlice"><span class="hs-identifier hs-var">DimSlice</span></a></span><span> </span><span class="annot"><span class="annottext">d
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">d
</span><a href="#local-6989586621684536448"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">d
</span><span class="hs-number">1</span></span><span>
</span><span id="line-1442"></span><span>          </span><span id="local-6989586621684536446"><span class="annot"><span class="annottext">destslice' :: Slice (TExp Int64)
</span><a href="#local-6989586621684536446"><span class="hs-identifier hs-var hs-var">destslice'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1443"></span><span>            </span><span class="annot"><span class="annottext">[DimIndex (TExp Int64)] -&gt; Slice (TExp Int64)
forall d. [DimIndex d] -&gt; Slice d
</span><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-var">Slice</span></a></span><span> </span><span class="annot"><span class="annottext">([DimIndex (TExp Int64)] -&gt; Slice (TExp Int64))
-&gt; [DimIndex (TExp Int64)] -&gt; Slice (TExp Int64)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1444"></span><span>              </span><span class="annot"><span class="annottext">Int -&gt; DimIndex (TExp Int64) -&gt; [DimIndex (TExp Int64)]
forall a. Int -&gt; a -&gt; [a]
</span><span class="hs-identifier hs-var">replicate</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684536455"><span class="hs-identifier hs-var">rank</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684536454"><span class="hs-identifier hs-var">destds</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int64 -&gt; DimIndex (TExp Int64)
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-1445"></span><span>                </span><span class="annot"><span class="annottext">[DimIndex (TExp Int64)]
-&gt; [DimIndex (TExp Int64)] -&gt; [DimIndex (TExp Int64)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [DimIndex (TExp Int64)] -&gt; [DimIndex (TExp Int64)]
forall a. Int -&gt; [a] -&gt; [a]
</span><a href="Futhark.Util.html#takeLast"><span class="hs-identifier hs-var">takeLast</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684536454"><span class="hs-identifier hs-var">destds</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TExp Int64 -&gt; DimIndex (TExp Int64))
-&gt; [TExp Int64] -&gt; [DimIndex (TExp Int64)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; DimIndex (TExp Int64)
forall {d}. Num d =&gt; d -&gt; DimIndex d
</span><a href="#local-6989586621684536449"><span class="hs-identifier hs-var">fullDim</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536457"><span class="hs-identifier hs-var">dims</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1446"></span><span>          </span><span id="local-6989586621684536444"><span class="annot"><span class="annottext">srcslice' :: Slice (TExp Int64)
</span><a href="#local-6989586621684536444"><span class="hs-identifier hs-var hs-var">srcslice'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1447"></span><span>            </span><span class="annot"><span class="annottext">[DimIndex (TExp Int64)] -&gt; Slice (TExp Int64)
forall d. [DimIndex d] -&gt; Slice d
</span><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-var">Slice</span></a></span><span> </span><span class="annot"><span class="annottext">([DimIndex (TExp Int64)] -&gt; Slice (TExp Int64))
-&gt; [DimIndex (TExp Int64)] -&gt; Slice (TExp Int64)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1448"></span><span>              </span><span class="annot"><span class="annottext">Int -&gt; DimIndex (TExp Int64) -&gt; [DimIndex (TExp Int64)]
forall a. Int -&gt; a -&gt; [a]
</span><span class="hs-identifier hs-var">replicate</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684536455"><span class="hs-identifier hs-var">rank</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684536453"><span class="hs-identifier hs-var">srcds</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int64 -&gt; DimIndex (TExp Int64)
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-1449"></span><span>                </span><span class="annot"><span class="annottext">[DimIndex (TExp Int64)]
-&gt; [DimIndex (TExp Int64)] -&gt; [DimIndex (TExp Int64)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [DimIndex (TExp Int64)] -&gt; [DimIndex (TExp Int64)]
forall a. Int -&gt; [a] -&gt; [a]
</span><a href="Futhark.Util.html#takeLast"><span class="hs-identifier hs-var">takeLast</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684536453"><span class="hs-identifier hs-var">srcds</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TExp Int64 -&gt; DimIndex (TExp Int64))
-&gt; [TExp Int64] -&gt; [DimIndex (TExp Int64)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; DimIndex (TExp Int64)
forall {d}. Num d =&gt; d -&gt; DimIndex d
</span><a href="#local-6989586621684536449"><span class="hs-identifier hs-var">fullDim</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536457"><span class="hs-identifier hs-var">dims</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1450"></span><span>      </span><span class="annot"><span class="annottext">CopyCompiler GPUMem KernelEnv KernelOp
forall rep r op. CopyCompiler rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#copyElementWise"><span class="hs-identifier hs-var">copyElementWise</span></a></span><span>
</span><span id="line-1451"></span><span>        </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684536464"><span class="hs-identifier hs-var">pt</span></a></span><span>
</span><span id="line-1452"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MemLoc -&gt; Slice (TExp Int64) -&gt; MemLoc
</span><a href="Futhark.CodeGen.ImpGen.html#sliceMemLoc"><span class="hs-identifier hs-var">sliceMemLoc</span></a></span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684536463"><span class="hs-identifier hs-var">destloc</span></a></span><span> </span><span class="annot"><span class="annottext">Slice (TExp Int64)
</span><a href="#local-6989586621684536446"><span class="hs-identifier hs-var">destslice'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1453"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MemLoc -&gt; Slice (TExp Int64) -&gt; MemLoc
</span><a href="Futhark.CodeGen.ImpGen.html#sliceMemLoc"><span class="hs-identifier hs-var">sliceMemLoc</span></a></span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684536462"><span class="hs-identifier hs-var">srcloc</span></a></span><span> </span><span class="annot"><span class="annottext">Slice (TExp Int64)
</span><a href="#local-6989586621684536444"><span class="hs-identifier hs-var">srcslice'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1454"></span><span>    </span><span class="annot"><span class="annottext">(Space, Space)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1455"></span><span>      </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; ([TExp Int64] -&gt; InKernelGen ()) -&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#groupCoverSpace"><span class="hs-identifier hs-var">groupCoverSpace</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536457"><span class="hs-identifier hs-var">dims</span></a></span><span> </span><span class="annot"><span class="annottext">(([TExp Int64] -&gt; InKernelGen ()) -&gt; InKernelGen ())
-&gt; ([TExp Int64] -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684536441"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536441"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1456"></span><span>        </span><span class="annot"><span class="annottext">CopyCompiler GPUMem KernelEnv KernelOp
forall rep r op. CopyCompiler rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#copyElementWise"><span class="hs-identifier hs-var">copyElementWise</span></a></span><span>
</span><span id="line-1457"></span><span>          </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684536464"><span class="hs-identifier hs-var">pt</span></a></span><span>
</span><span id="line-1458"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MemLoc -&gt; Slice (TExp Int64) -&gt; MemLoc
</span><a href="Futhark.CodeGen.ImpGen.html#sliceMemLoc"><span class="hs-identifier hs-var">sliceMemLoc</span></a></span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684536463"><span class="hs-identifier hs-var">destloc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DimIndex (TExp Int64)] -&gt; Slice (TExp Int64)
forall d. [DimIndex d] -&gt; Slice d
</span><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-var">Slice</span></a></span><span> </span><span class="annot"><span class="annottext">([DimIndex (TExp Int64)] -&gt; Slice (TExp Int64))
-&gt; [DimIndex (TExp Int64)] -&gt; Slice (TExp Int64)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; DimIndex (TExp Int64))
-&gt; [TExp Int64] -&gt; [DimIndex (TExp Int64)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; DimIndex (TExp Int64)
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536441"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1459"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MemLoc -&gt; Slice (TExp Int64) -&gt; MemLoc
</span><a href="Futhark.CodeGen.ImpGen.html#sliceMemLoc"><span class="hs-identifier hs-var">sliceMemLoc</span></a></span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684536462"><span class="hs-identifier hs-var">srcloc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DimIndex (TExp Int64)] -&gt; Slice (TExp Int64)
forall d. [DimIndex d] -&gt; Slice d
</span><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-var">Slice</span></a></span><span> </span><span class="annot"><span class="annottext">([DimIndex (TExp Int64)] -&gt; Slice (TExp Int64))
-&gt; [DimIndex (TExp Int64)] -&gt; Slice (TExp Int64)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; DimIndex (TExp Int64))
-&gt; [TExp Int64] -&gt; [DimIndex (TExp Int64)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; DimIndex (TExp Int64)
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536441"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1460"></span><span>      </span><span class="annot"><span class="annottext">KernelOp -&gt; InKernelGen ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelOp -&gt; InKernelGen ()) -&gt; KernelOp -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Fence -&gt; KernelOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#Barrier"><span class="hs-identifier hs-var">Imp.Barrier</span></a></span><span> </span><span class="annot"><span class="annottext">Fence
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#FenceLocal"><span class="hs-identifier hs-var">Imp.FenceLocal</span></a></span><span>
</span><span id="line-1461"></span><span>
</span><span id="line-1462"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#threadOperations"><span class="hs-identifier hs-type">threadOperations</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#groupOperations"><span class="hs-identifier hs-type">groupOperations</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#Operations"><span class="hs-identifier hs-type">Operations</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#KernelEnv"><span class="hs-identifier hs-type">KernelEnv</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.GPU.html#KernelOp"><span class="hs-identifier hs-type">Imp.KernelOp</span></a></span><span>
</span><span id="line-1463"></span><span id="threadOperations"><span class="annot"><span class="annottext">threadOperations :: Operations GPUMem KernelEnv KernelOp
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#threadOperations"><span class="hs-identifier hs-var hs-var">threadOperations</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1464"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OpCompiler GPUMem KernelEnv KernelOp
-&gt; Operations GPUMem KernelEnv KernelOp
forall rep inner op r.
(Mem rep inner, FreeIn op) =&gt;
OpCompiler rep r op -&gt; Operations rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#defaultOperations"><span class="hs-identifier hs-var">defaultOperations</span></a></span><span> </span><span class="annot"><span class="annottext">OpCompiler GPUMem KernelEnv KernelOp
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileThreadOp"><span class="hs-identifier hs-var">compileThreadOp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1465"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">opsCopyCompiler :: CopyCompiler GPUMem KernelEnv KernelOp
</span><a href="Futhark.CodeGen.ImpGen.html#opsCopyCompiler"><span class="hs-identifier hs-var">opsCopyCompiler</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CopyCompiler GPUMem KernelEnv KernelOp
forall rep r op. CopyCompiler rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#copyElementWise"><span class="hs-identifier hs-var">copyElementWise</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1466"></span><span>      </span><span class="annot"><span class="annottext">opsExpCompiler :: ExpCompiler GPUMem KernelEnv KernelOp
</span><a href="Futhark.CodeGen.ImpGen.html#opsExpCompiler"><span class="hs-identifier hs-var">opsExpCompiler</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExpCompiler GPUMem KernelEnv KernelOp
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileThreadExp"><span class="hs-identifier hs-var">compileThreadExp</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1467"></span><span>      </span><span class="annot"><span class="annottext">opsStmsCompiler :: Names -&gt; Stms GPUMem -&gt; InKernelGen () -&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.html#opsStmsCompiler"><span class="hs-identifier hs-var">opsStmsCompiler</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">Names
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Names -&gt; Stms GPUMem -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep inner op r.
(Mem rep inner, FreeIn op) =&gt;
Names -&gt; Stms rep -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#defCompileStms"><span class="hs-identifier hs-var">defCompileStms</span></a></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">,</span><span>
</span><span id="line-1468"></span><span>      </span><span class="annot"><span class="annottext">opsAllocCompilers :: Map Space (AllocCompiler GPUMem KernelEnv KernelOp)
</span><a href="Futhark.CodeGen.ImpGen.html#opsAllocCompilers"><span class="hs-identifier hs-var">opsAllocCompilers</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1469"></span><span>        </span><span class="annot"><span class="annottext">[(Space, AllocCompiler GPUMem KernelEnv KernelOp)]
-&gt; Map Space (AllocCompiler GPUMem KernelEnv KernelOp)
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Space
</span><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-var">Space</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;local&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AllocCompiler GPUMem KernelEnv KernelOp
forall r. AllocCompiler GPUMem r KernelOp
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#allocLocal"><span class="hs-identifier hs-var">allocLocal</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-1470"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-1471"></span><span id="groupOperations"><span class="annot"><span class="annottext">groupOperations :: Operations GPUMem KernelEnv KernelOp
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#groupOperations"><span class="hs-identifier hs-var hs-var">groupOperations</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1472"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OpCompiler GPUMem KernelEnv KernelOp
-&gt; Operations GPUMem KernelEnv KernelOp
forall rep inner op r.
(Mem rep inner, FreeIn op) =&gt;
OpCompiler rep r op -&gt; Operations rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#defaultOperations"><span class="hs-identifier hs-var">defaultOperations</span></a></span><span> </span><span class="annot"><span class="annottext">OpCompiler GPUMem KernelEnv KernelOp
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileGroupOp"><span class="hs-identifier hs-var">compileGroupOp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1473"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">opsCopyCompiler :: CopyCompiler GPUMem KernelEnv KernelOp
</span><a href="Futhark.CodeGen.ImpGen.html#opsCopyCompiler"><span class="hs-identifier hs-var">opsCopyCompiler</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CopyCompiler GPUMem KernelEnv KernelOp
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#copyInGroup"><span class="hs-identifier hs-var">copyInGroup</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1474"></span><span>      </span><span class="annot"><span class="annottext">opsExpCompiler :: ExpCompiler GPUMem KernelEnv KernelOp
</span><a href="Futhark.CodeGen.ImpGen.html#opsExpCompiler"><span class="hs-identifier hs-var">opsExpCompiler</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExpCompiler GPUMem KernelEnv KernelOp
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileGroupExp"><span class="hs-identifier hs-var">compileGroupExp</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1475"></span><span>      </span><span class="annot"><span class="annottext">opsStmsCompiler :: Names -&gt; Stms GPUMem -&gt; InKernelGen () -&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.html#opsStmsCompiler"><span class="hs-identifier hs-var">opsStmsCompiler</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">Names
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Names -&gt; Stms GPUMem -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep inner op r.
(Mem rep inner, FreeIn op) =&gt;
Names -&gt; Stms rep -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#defCompileStms"><span class="hs-identifier hs-var">defCompileStms</span></a></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">,</span><span>
</span><span id="line-1476"></span><span>      </span><span class="annot"><span class="annottext">opsAllocCompilers :: Map Space (AllocCompiler GPUMem KernelEnv KernelOp)
</span><a href="Futhark.CodeGen.ImpGen.html#opsAllocCompilers"><span class="hs-identifier hs-var">opsAllocCompilers</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1477"></span><span>        </span><span class="annot"><span class="annottext">[(Space, AllocCompiler GPUMem KernelEnv KernelOp)]
-&gt; Map Space (AllocCompiler GPUMem KernelEnv KernelOp)
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Space
</span><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-var">Space</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;local&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AllocCompiler GPUMem KernelEnv KernelOp
forall r. AllocCompiler GPUMem r KernelOp
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#allocLocal"><span class="hs-identifier hs-var">allocLocal</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-1478"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-1479"></span><span>
</span><span id="line-1480"></span><span class="hs-comment">-- | Perform a Replicate with a kernel.</span><span>
</span><span id="line-1481"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#sReplicateKernel"><span class="hs-identifier hs-type">sReplicateKernel</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#CallKernelGen"><span class="hs-identifier hs-type">CallKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1482"></span><span id="sReplicateKernel"><span class="annot"><span class="annottext">sReplicateKernel :: VName -&gt; SubExp -&gt; ImpM GPUMem HostEnv HostOp ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#sReplicateKernel"><span class="hs-identifier hs-var hs-var">sReplicateKernel</span></a></span></span><span> </span><span id="local-6989586621684536433"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536433"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span id="local-6989586621684536432"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684536432"><span class="hs-identifier hs-var">se</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1483"></span><span>  </span><span id="local-6989586621684536431"><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness
</span><a href="#local-6989586621684536431"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; ImpM GPUMem HostEnv HostOp (TypeBase Shape NoUniqueness)
forall t (m :: * -&gt; *).
HasScope t m =&gt;
SubExp -&gt; m (TypeBase Shape NoUniqueness)
</span><a href="Futhark.IR.Prop.TypeOf.html#subExpType"><span class="hs-identifier hs-var">subExpType</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684536432"><span class="hs-identifier hs-var">se</span></a></span><span>
</span><span id="line-1484"></span><span>  </span><span id="local-6989586621684536429"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684536429"><span class="hs-identifier hs-var">ds</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [SubExp] -&gt; [SubExp]
forall a. Int -&gt; [a] -&gt; [a]
</span><a href="Futhark.Util.html#dropLast"><span class="hs-identifier hs-var">dropLast</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness -&gt; Int
forall shape u. ArrayShape shape =&gt; TypeBase shape u -&gt; Int
</span><a href="Futhark.IR.Prop.Types.html#arrayRank"><span class="hs-identifier hs-var">arrayRank</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness
</span><a href="#local-6989586621684536431"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [SubExp])
-&gt; (TypeBase Shape NoUniqueness -&gt; [SubExp])
-&gt; TypeBase Shape NoUniqueness
-&gt; [SubExp]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness -&gt; [SubExp]
forall u. TypeBase Shape u -&gt; [SubExp]
</span><a href="Futhark.IR.Prop.Types.html#arrayDims"><span class="hs-identifier hs-var">arrayDims</span></a></span><span> </span><span class="annot"><span class="annottext">(TypeBase Shape NoUniqueness -&gt; [SubExp])
-&gt; ImpM GPUMem HostEnv HostOp (TypeBase Shape NoUniqueness)
-&gt; ImpM GPUMem HostEnv HostOp [SubExp]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; ImpM GPUMem HostEnv HostOp (TypeBase Shape NoUniqueness)
forall rep (m :: * -&gt; *).
HasScope rep m =&gt;
VName -&gt; m (TypeBase Shape NoUniqueness)
</span><a href="Futhark.IR.Prop.Scope.html#lookupType"><span class="hs-identifier hs-var">lookupType</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536433"><span class="hs-identifier hs-var">arr</span></a></span><span>
</span><span id="line-1485"></span><span>
</span><span id="line-1486"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684536427"><span class="annot"><span class="annottext">dims :: [TExp Int64]
</span><a href="#local-6989586621684536427"><span class="hs-identifier hs-var hs-var">dims</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [TExp Int64]) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684536429"><span class="hs-identifier hs-var">ds</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; [SubExp] -&gt; [SubExp]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness -&gt; [SubExp]
forall u. TypeBase Shape u -&gt; [SubExp]
</span><a href="Futhark.IR.Prop.Types.html#arrayDims"><span class="hs-identifier hs-var">arrayDims</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness
</span><a href="#local-6989586621684536431"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-1487"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684536426"><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684536426"><span class="hs-identifier hs-var">constants</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684536425"><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684536425"><span class="hs-identifier hs-var">set_constants</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1488"></span><span>    </span><span class="annot"><span class="annottext">TExp Int64
-&gt; String -&gt; CallKernelGen (KernelConstants, InKernelGen ())
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#simpleKernelConstants"><span class="hs-identifier hs-var">simpleKernelConstants</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TExp Int64] -&gt; TExp Int64
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">product</span></span><span> </span><span class="annot"><span class="annottext">([TExp Int64] -&gt; TExp Int64) -&gt; [TExp Int64] -&gt; TExp Int64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; TExp Int64) -&gt; [TExp Int64] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536427"><span class="hs-identifier hs-var">dims</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;replicate&quot;</span></span><span>
</span><span id="line-1489"></span><span>
</span><span id="line-1490"></span><span>  </span><span id="local-6989586621684536424"><span class="annot"><span class="annottext">Maybe Name
</span><a href="#local-6989586621684536424"><span class="hs-identifier hs-var">fname</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ImpM GPUMem HostEnv HostOp (Maybe Name)
forall rep r op. ImpM rep r op (Maybe Name)
</span><a href="Futhark.CodeGen.ImpGen.html#askFunction"><span class="hs-identifier hs-var">askFunction</span></a></span><span>
</span><span id="line-1491"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684536423"><span class="annot"><span class="annottext">name :: Name
</span><a href="#local-6989586621684536423"><span class="hs-identifier hs-var hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1492"></span><span>        </span><span class="annot"><span class="annottext">Maybe Name -&gt; Name -&gt; Name
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#keyWithEntryPoint"><span class="hs-identifier hs-var">keyWithEntryPoint</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Name
</span><a href="#local-6989586621684536424"><span class="hs-identifier hs-var">fname</span></a></span><span> </span><span class="annot"><span class="annottext">(Name -&gt; Name) -&gt; Name -&gt; Name
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1493"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; Name
</span><a href="Language.Futhark.Core.html#nameFromString"><span class="hs-identifier hs-var">nameFromString</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Name) -&gt; String -&gt; Name
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1494"></span><span>            </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;replicate_&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Int
</span><a href="Language.Futhark.Core.html#baseTag"><span class="hs-identifier hs-var">baseTag</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Int) -&gt; VName -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelGlobalThreadIdVar"><span class="hs-identifier hs-var hs-var">kernelGlobalThreadIdVar</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684536426"><span class="hs-identifier hs-var">constants</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1495"></span><span>
</span><span id="line-1496"></span><span>  </span><span class="annot"><span class="annottext">Bool
-&gt; Operations GPUMem KernelEnv KernelOp
-&gt; KernelConstants
-&gt; Name
-&gt; InKernelGen ()
-&gt; ImpM GPUMem HostEnv HostOp ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#sKernelFailureTolerant"><span class="hs-identifier hs-var">sKernelFailureTolerant</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">Operations GPUMem KernelEnv KernelOp
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#threadOperations"><span class="hs-identifier hs-var">threadOperations</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684536426"><span class="hs-identifier hs-var">constants</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684536423"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; ImpM GPUMem HostEnv HostOp ())
-&gt; InKernelGen () -&gt; ImpM GPUMem HostEnv HostOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1497"></span><span>    </span><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684536425"><span class="hs-identifier hs-var">set_constants</span></a></span><span>
</span><span id="line-1498"></span><span>    </span><span id="local-6989586621684536422"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536422"><span class="hs-identifier hs-var">is'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; [TExp Int64] -&gt; TExp Int64 -&gt; InKernelGen [TExp Int64]
forall rep r op.
String -&gt; [TExp Int64] -&gt; TExp Int64 -&gt; ImpM rep r op [TExp Int64]
</span><a href="Futhark.CodeGen.ImpGen.html#dIndexSpace%27"><span class="hs-identifier hs-var">dIndexSpace'</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;rep_i&quot;</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536427"><span class="hs-identifier hs-var">dims</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; InKernelGen [TExp Int64])
-&gt; TExp Int64 -&gt; InKernelGen [TExp Int64]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int64
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int32 -&gt; TExp Int64) -&gt; TExp Int32 -&gt; TExp Int64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelGlobalThreadId"><span class="hs-identifier hs-var hs-var">kernelGlobalThreadId</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684536426"><span class="hs-identifier hs-var">constants</span></a></span><span>
</span><span id="line-1499"></span><span>    </span><span class="annot"><span class="annottext">TExp Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Bool
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelThreadActive"><span class="hs-identifier hs-var hs-var">kernelThreadActive</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684536426"><span class="hs-identifier hs-var">constants</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1500"></span><span>      </span><span class="annot"><span class="annottext">VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; InKernelGen ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536433"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536422"><span class="hs-identifier hs-var">is'</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684536432"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="annot"><span class="annottext">([TExp Int64] -&gt; InKernelGen ()) -&gt; [TExp Int64] -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [TExp Int64] -&gt; [TExp Int64]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684536429"><span class="hs-identifier hs-var">ds</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536422"><span class="hs-identifier hs-var">is'</span></a></span><span>
</span><span id="line-1501"></span><span>
</span><span id="line-1502"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#replicateName"><span class="hs-identifier hs-type">replicateName</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Primitive.html#PrimType"><span class="hs-identifier hs-type">PrimType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-1503"></span><span id="replicateName"><span class="annot"><span class="annottext">replicateName :: PrimType -&gt; String
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#replicateName"><span class="hs-identifier hs-var hs-var">replicateName</span></a></span></span><span> </span><span id="local-6989586621684536420"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684536420"><span class="hs-identifier hs-var">bt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;replicate_&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684536420"><span class="hs-identifier hs-var">bt</span></a></span><span>
</span><span id="line-1504"></span><span>
</span><span id="line-1505"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#replicateForType"><span class="hs-identifier hs-type">replicateForType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Primitive.html#PrimType"><span class="hs-identifier hs-type">PrimType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#CallKernelGen"><span class="hs-identifier hs-type">CallKernelGen</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span>
</span><span id="line-1506"></span><span id="replicateForType"><span class="annot"><span class="annottext">replicateForType :: PrimType -&gt; ImpM GPUMem HostEnv HostOp Name
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#replicateForType"><span class="hs-identifier hs-var hs-var">replicateForType</span></a></span></span><span> </span><span id="local-6989586621684536418"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684536418"><span class="hs-identifier hs-var">bt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1507"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684536417"><span class="annot"><span class="annottext">fname :: Name
</span><a href="#local-6989586621684536417"><span class="hs-identifier hs-var hs-var">fname</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Name
</span><a href="Language.Futhark.Core.html#nameFromString"><span class="hs-identifier hs-var">nameFromString</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Name) -&gt; String -&gt; Name
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;builtin#&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; String
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#replicateName"><span class="hs-identifier hs-var">replicateName</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684536418"><span class="hs-identifier hs-var">bt</span></a></span><span>
</span><span id="line-1508"></span><span>
</span><span id="line-1509"></span><span>  </span><span id="local-6989586621684536416"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684536416"><span class="hs-identifier hs-var">exists</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; ImpM GPUMem HostEnv HostOp Bool
forall rep r op. Name -&gt; ImpM rep r op Bool
</span><a href="Futhark.CodeGen.ImpGen.html#hasFunction"><span class="hs-identifier hs-var">hasFunction</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684536417"><span class="hs-identifier hs-var">fname</span></a></span><span>
</span><span id="line-1510"></span><span>  </span><span class="annot"><span class="annottext">Bool
-&gt; ImpM GPUMem HostEnv HostOp () -&gt; ImpM GPUMem HostEnv HostOp ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684536416"><span class="hs-identifier hs-var">exists</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem HostEnv HostOp () -&gt; ImpM GPUMem HostEnv HostOp ())
-&gt; ImpM GPUMem HostEnv HostOp () -&gt; ImpM GPUMem HostEnv HostOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1511"></span><span>    </span><span id="local-6989586621684536414"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536414"><span class="hs-identifier hs-var">mem</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; ImpM GPUMem HostEnv HostOp VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; String -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;mem&quot;</span></span><span>
</span><span id="line-1512"></span><span>    </span><span id="local-6989586621684536413"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536413"><span class="hs-identifier hs-var">num_elems</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; ImpM GPUMem HostEnv HostOp VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; String -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;num_elems&quot;</span></span><span>
</span><span id="line-1513"></span><span>    </span><span id="local-6989586621684536412"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536412"><span class="hs-identifier hs-var">val</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; ImpM GPUMem HostEnv HostOp VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; String -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;val&quot;</span></span><span>
</span><span id="line-1514"></span><span>
</span><span id="line-1515"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684536411"><span class="annot"><span class="annottext">params :: [Param]
</span><a href="#local-6989586621684536411"><span class="hs-identifier hs-var hs-var">params</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1516"></span><span>          </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Space -&gt; Param
</span><a href="Futhark.CodeGen.ImpCode.html#MemParam"><span class="hs-identifier hs-var">Imp.MemParam</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536414"><span class="hs-identifier hs-var">mem</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Space
</span><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-var">Space</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;device&quot;</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-1517"></span><span>            </span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; Param
</span><a href="Futhark.CodeGen.ImpCode.html#ScalarParam"><span class="hs-identifier hs-var">Imp.ScalarParam</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536413"><span class="hs-identifier hs-var">num_elems</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int32"><span class="hs-identifier hs-var">int32</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1518"></span><span>            </span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; Param
</span><a href="Futhark.CodeGen.ImpCode.html#ScalarParam"><span class="hs-identifier hs-var">Imp.ScalarParam</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536412"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684536418"><span class="hs-identifier hs-var">bt</span></a></span><span>
</span><span id="line-1519"></span><span>          </span><span class="hs-special">]</span><span>
</span><span id="line-1520"></span><span>        </span><span id="local-6989586621684536408"><span class="annot"><span class="annottext">shape :: Shape
</span><a href="#local-6989586621684536408"><span class="hs-identifier hs-var hs-var">shape</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; Shape
forall d. [d] -&gt; ShapeBase d
</span><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-var">Shape</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536413"><span class="hs-identifier hs-var">num_elems</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1521"></span><span>    </span><span class="annot"><span class="annottext">Name
-&gt; [Param]
-&gt; [Param]
-&gt; ImpM GPUMem HostEnv HostOp ()
-&gt; ImpM GPUMem HostEnv HostOp ()
forall rep r op.
Name -&gt; [Param] -&gt; [Param] -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#function"><span class="hs-identifier hs-var">function</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684536417"><span class="hs-identifier hs-var">fname</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[Param]
</span><a href="#local-6989586621684536411"><span class="hs-identifier hs-var">params</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem HostEnv HostOp () -&gt; ImpM GPUMem HostEnv HostOp ())
-&gt; ImpM GPUMem HostEnv HostOp () -&gt; ImpM GPUMem HostEnv HostOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1522"></span><span>      </span><span id="local-6989586621684536406"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536406"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1523"></span><span>        </span><span class="annot"><span class="annottext">String
-&gt; PrimType
-&gt; Shape
-&gt; VName
-&gt; IxFun
-&gt; ImpM GPUMem HostEnv HostOp VName
forall rep r op.
String
-&gt; PrimType -&gt; Shape -&gt; VName -&gt; IxFun -&gt; ImpM rep r op VName
</span><a href="Futhark.CodeGen.ImpGen.html#sArray"><span class="hs-identifier hs-var">sArray</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;arr&quot;</span></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684536418"><span class="hs-identifier hs-var">bt</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684536408"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536414"><span class="hs-identifier hs-var">mem</span></a></span><span> </span><span class="annot"><span class="annottext">(IxFun -&gt; ImpM GPUMem HostEnv HostOp VName)
-&gt; IxFun -&gt; ImpM GPUMem HostEnv HostOp VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1524"></span><span>          </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; IxFun
forall num. IntegralExp num =&gt; Shape num -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#iota"><span class="hs-identifier hs-var">IxFun.iota</span></a></span><span> </span><span class="annot"><span class="annottext">([TExp Int64] -&gt; IxFun) -&gt; [TExp Int64] -&gt; IxFun
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
</span><a href="Futhark.Analysis.PrimExp.Convert.html#pe64"><span class="hs-identifier hs-var">pe64</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [TExp Int64]) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Shape -&gt; [SubExp]
forall d. ShapeBase d -&gt; [d]
</span><a href="Futhark.IR.Syntax.Core.html#shapeDims"><span class="hs-identifier hs-var hs-var">shapeDims</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684536408"><span class="hs-identifier hs-var">shape</span></a></span><span>
</span><span id="line-1525"></span><span>      </span><span class="annot"><span class="annottext">VName -&gt; SubExp -&gt; ImpM GPUMem HostEnv HostOp ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#sReplicateKernel"><span class="hs-identifier hs-var">sReplicateKernel</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536406"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; ImpM GPUMem HostEnv HostOp ())
-&gt; SubExp -&gt; ImpM GPUMem HostEnv HostOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536412"><span class="hs-identifier hs-var">val</span></a></span><span>
</span><span id="line-1526"></span><span>
</span><span id="line-1527"></span><span>  </span><span class="annot"><span class="annottext">Name -&gt; ImpM GPUMem HostEnv HostOp Name
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684536417"><span class="hs-identifier hs-var">fname</span></a></span><span>
</span><span id="line-1528"></span><span>
</span><span id="line-1529"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#replicateIsFill"><span class="hs-identifier hs-type">replicateIsFill</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#CallKernelGen"><span class="hs-identifier hs-type">CallKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#CallKernelGen"><span class="hs-identifier hs-type">CallKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1530"></span><span id="replicateIsFill"><span class="annot"><span class="annottext">replicateIsFill :: VName
-&gt; SubExp -&gt; CallKernelGen (Maybe (ImpM GPUMem HostEnv HostOp ()))
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#replicateIsFill"><span class="hs-identifier hs-var hs-var">replicateIsFill</span></a></span></span><span> </span><span id="local-6989586621684536404"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536404"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span id="local-6989586621684536403"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684536403"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1531"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ArrayEntry"><span class="hs-identifier hs-type">ArrayEntry</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemLoc"><span class="hs-identifier hs-type">MemLoc</span></a></span><span> </span><span id="local-6989586621684536402"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536402"><span class="hs-identifier hs-var">arr_mem</span></a></span></span><span> </span><span id="local-6989586621684536401"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684536401"><span class="hs-identifier hs-var">arr_shape</span></a></span></span><span> </span><span id="local-6989586621684536400"><span class="annot"><span class="annottext">IxFun
</span><a href="#local-6989586621684536400"><span class="hs-identifier hs-var">arr_ixfun</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PrimType
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; ImpM GPUMem HostEnv HostOp ArrayEntry
forall rep r op. VName -&gt; ImpM rep r op ArrayEntry
</span><a href="Futhark.CodeGen.ImpGen.html#lookupArray"><span class="hs-identifier hs-var">lookupArray</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536404"><span class="hs-identifier hs-var">arr</span></a></span><span>
</span><span id="line-1532"></span><span>  </span><span id="local-6989586621684536399"><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness
</span><a href="#local-6989586621684536399"><span class="hs-identifier hs-var">v_t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; ImpM GPUMem HostEnv HostOp (TypeBase Shape NoUniqueness)
forall t (m :: * -&gt; *).
HasScope t m =&gt;
SubExp -&gt; m (TypeBase Shape NoUniqueness)
</span><a href="Futhark.IR.Prop.TypeOf.html#subExpType"><span class="hs-identifier hs-var">subExpType</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684536403"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-1533"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness
</span><a href="#local-6989586621684536399"><span class="hs-identifier hs-var">v_t</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1534"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-type">Prim</span></a></span><span> </span><span id="local-6989586621684536398"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684536398"><span class="hs-identifier hs-var">v_t'</span></a></span></span><span>
</span><span id="line-1535"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">IxFun -&gt; Bool
forall num. (Eq num, IntegralExp num) =&gt; IxFun num -&gt; Bool
</span><a href="Futhark.IR.Mem.IxFun.html#isLinear"><span class="hs-identifier hs-var">IxFun.isLinear</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun
</span><a href="#local-6989586621684536400"><span class="hs-identifier hs-var">arr_ixfun</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (ImpM GPUMem HostEnv HostOp ())
-&gt; CallKernelGen (Maybe (ImpM GPUMem HostEnv HostOp ()))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (ImpM GPUMem HostEnv HostOp ())
 -&gt; CallKernelGen (Maybe (ImpM GPUMem HostEnv HostOp ())))
-&gt; Maybe (ImpM GPUMem HostEnv HostOp ())
-&gt; CallKernelGen (Maybe (ImpM GPUMem HostEnv HostOp ()))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1536"></span><span>        </span><span class="annot"><span class="annottext">ImpM GPUMem HostEnv HostOp ()
-&gt; Maybe (ImpM GPUMem HostEnv HostOp ())
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem HostEnv HostOp ()
 -&gt; Maybe (ImpM GPUMem HostEnv HostOp ()))
-&gt; ImpM GPUMem HostEnv HostOp ()
-&gt; Maybe (ImpM GPUMem HostEnv HostOp ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1537"></span><span>          </span><span id="local-6989586621684536396"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684536396"><span class="hs-identifier hs-var">fname</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; ImpM GPUMem HostEnv HostOp Name
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#replicateForType"><span class="hs-identifier hs-var">replicateForType</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684536398"><span class="hs-identifier hs-var">v_t'</span></a></span><span>
</span><span id="line-1538"></span><span>          </span><span class="annot"><span class="annottext">Code HostOp -&gt; ImpM GPUMem HostEnv HostOp ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code HostOp -&gt; ImpM GPUMem HostEnv HostOp ())
-&gt; Code HostOp -&gt; ImpM GPUMem HostEnv HostOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1539"></span><span>            </span><span class="annot"><span class="annottext">[VName] -&gt; Name -&gt; [Arg] -&gt; Code HostOp
forall a. [VName] -&gt; Name -&gt; [Arg] -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#Call"><span class="hs-identifier hs-var">Imp.Call</span></a></span><span>
</span><span id="line-1540"></span><span>              </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1541"></span><span>              </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684536396"><span class="hs-identifier hs-var">fname</span></a></span><span>
</span><span id="line-1542"></span><span>              </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Arg
</span><a href="Futhark.CodeGen.ImpCode.html#MemArg"><span class="hs-identifier hs-var">Imp.MemArg</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536402"><span class="hs-identifier hs-var">arr_mem</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1543"></span><span>                </span><span class="annot"><span class="annottext">PrimExp VName -&gt; Arg
</span><a href="Futhark.CodeGen.ImpCode.html#ExpArg"><span class="hs-identifier hs-var">Imp.ExpArg</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimExp VName -&gt; Arg) -&gt; PrimExp VName -&gt; Arg
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; PrimExp VName
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; PrimExp VName) -&gt; TExp Int64 -&gt; PrimExp VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; TExp Int64
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">product</span></span><span> </span><span class="annot"><span class="annottext">([TExp Int64] -&gt; TExp Int64) -&gt; [TExp Int64] -&gt; TExp Int64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684536401"><span class="hs-identifier hs-var">arr_shape</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1544"></span><span>                </span><span class="annot"><span class="annottext">PrimExp VName -&gt; Arg
</span><a href="Futhark.CodeGen.ImpCode.html#ExpArg"><span class="hs-identifier hs-var">Imp.ExpArg</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimExp VName -&gt; Arg) -&gt; PrimExp VName -&gt; Arg
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; SubExp -&gt; PrimExp VName
forall a. ToExp a =&gt; PrimType -&gt; a -&gt; PrimExp VName
</span><a href="Futhark.CodeGen.ImpGen.html#toExp%27"><span class="hs-identifier hs-var">toExp'</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684536398"><span class="hs-identifier hs-var">v_t'</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684536403"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-1545"></span><span>              </span><span class="hs-special">]</span><span>
</span><span id="line-1546"></span><span>    </span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (ImpM GPUMem HostEnv HostOp ())
-&gt; CallKernelGen (Maybe (ImpM GPUMem HostEnv HostOp ()))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe (ImpM GPUMem HostEnv HostOp ())
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1547"></span><span>
</span><span id="line-1548"></span><span class="hs-comment">-- | Perform a Replicate with a kernel.</span><span>
</span><span id="line-1549"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#sReplicate"><span class="hs-identifier hs-type">sReplicate</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#CallKernelGen"><span class="hs-identifier hs-type">CallKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1550"></span><span id="sReplicate"><span class="annot"><span class="annottext">sReplicate :: VName -&gt; SubExp -&gt; ImpM GPUMem HostEnv HostOp ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#sReplicate"><span class="hs-identifier hs-var hs-var">sReplicate</span></a></span></span><span> </span><span id="local-6989586621684536391"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536391"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span id="local-6989586621684536390"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684536390"><span class="hs-identifier hs-var">se</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1551"></span><span>  </span><span class="hs-comment">-- If the replicate is of a particularly common and simple form</span><span>
</span><span id="line-1552"></span><span>  </span><span class="hs-comment">-- (morally a memset()/fill), then we use a common function.</span><span>
</span><span id="line-1553"></span><span>  </span><span id="local-6989586621684536389"><span class="annot"><span class="annottext">Maybe (ImpM GPUMem HostEnv HostOp ())
</span><a href="#local-6989586621684536389"><span class="hs-identifier hs-var">is_fill</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName
-&gt; SubExp -&gt; CallKernelGen (Maybe (ImpM GPUMem HostEnv HostOp ()))
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#replicateIsFill"><span class="hs-identifier hs-var">replicateIsFill</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536391"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684536390"><span class="hs-identifier hs-var">se</span></a></span><span>
</span><span id="line-1554"></span><span>
</span><span id="line-1555"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (ImpM GPUMem HostEnv HostOp ())
</span><a href="#local-6989586621684536389"><span class="hs-identifier hs-var">is_fill</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1556"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684536388"><span class="annot"><span class="annottext">ImpM GPUMem HostEnv HostOp ()
</span><a href="#local-6989586621684536388"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ImpM GPUMem HostEnv HostOp ()
</span><a href="#local-6989586621684536388"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-1557"></span><span>    </span><span class="annot"><span class="annottext">Maybe (ImpM GPUMem HostEnv HostOp ())
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp -&gt; ImpM GPUMem HostEnv HostOp ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#sReplicateKernel"><span class="hs-identifier hs-var">sReplicateKernel</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536391"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684536390"><span class="hs-identifier hs-var">se</span></a></span><span>
</span><span id="line-1558"></span><span>
</span><span id="line-1559"></span><span class="hs-comment">-- | Perform an Iota with a kernel.</span><span>
</span><span id="line-1560"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#sIotaKernel"><span class="hs-identifier hs-type">sIotaKernel</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1561"></span><span>  </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1562"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1563"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#Exp"><span class="hs-identifier hs-type">Imp.Exp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1564"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#Exp"><span class="hs-identifier hs-type">Imp.Exp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1565"></span><span>  </span><span class="annot"><a href="Futhark.IR.Primitive.html#IntType"><span class="hs-identifier hs-type">IntType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1566"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#CallKernelGen"><span class="hs-identifier hs-type">CallKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1567"></span><span id="sIotaKernel"><span class="annot"><span class="annottext">sIotaKernel :: VName
-&gt; TExp Int64
-&gt; PrimExp VName
-&gt; PrimExp VName
-&gt; IntType
-&gt; ImpM GPUMem HostEnv HostOp ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#sIotaKernel"><span class="hs-identifier hs-var hs-var">sIotaKernel</span></a></span></span><span> </span><span id="local-6989586621684536386"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536386"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span id="local-6989586621684536385"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536385"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621684536384"><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684536384"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621684536383"><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684536383"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621684536382"><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684536382"><span class="hs-identifier hs-var">et</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1568"></span><span>  </span><span id="local-6989586621684536381"><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684536381"><span class="hs-identifier hs-var">destloc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ArrayEntry -&gt; MemLoc
</span><a href="Futhark.CodeGen.ImpGen.html#entryArrayLoc"><span class="hs-identifier hs-var hs-var">entryArrayLoc</span></a></span><span> </span><span class="annot"><span class="annottext">(ArrayEntry -&gt; MemLoc)
-&gt; ImpM GPUMem HostEnv HostOp ArrayEntry
-&gt; ImpM GPUMem HostEnv HostOp MemLoc
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; ImpM GPUMem HostEnv HostOp ArrayEntry
forall rep r op. VName -&gt; ImpM rep r op ArrayEntry
</span><a href="Futhark.CodeGen.ImpGen.html#lookupArray"><span class="hs-identifier hs-var">lookupArray</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536386"><span class="hs-identifier hs-var">arr</span></a></span><span>
</span><span id="line-1569"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684536380"><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684536380"><span class="hs-identifier hs-var">constants</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684536379"><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684536379"><span class="hs-identifier hs-var">set_constants</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TExp Int64
-&gt; String -&gt; CallKernelGen (KernelConstants, InKernelGen ())
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#simpleKernelConstants"><span class="hs-identifier hs-var">simpleKernelConstants</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536385"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;iota&quot;</span></span><span>
</span><span id="line-1570"></span><span>
</span><span id="line-1571"></span><span>  </span><span id="local-6989586621684536378"><span class="annot"><span class="annottext">Maybe Name
</span><a href="#local-6989586621684536378"><span class="hs-identifier hs-var">fname</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ImpM GPUMem HostEnv HostOp (Maybe Name)
forall rep r op. ImpM rep r op (Maybe Name)
</span><a href="Futhark.CodeGen.ImpGen.html#askFunction"><span class="hs-identifier hs-var">askFunction</span></a></span><span>
</span><span id="line-1572"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684536377"><span class="annot"><span class="annottext">name :: Name
</span><a href="#local-6989586621684536377"><span class="hs-identifier hs-var hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1573"></span><span>        </span><span class="annot"><span class="annottext">Maybe Name -&gt; Name -&gt; Name
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#keyWithEntryPoint"><span class="hs-identifier hs-var">keyWithEntryPoint</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Name
</span><a href="#local-6989586621684536378"><span class="hs-identifier hs-var">fname</span></a></span><span> </span><span class="annot"><span class="annottext">(Name -&gt; Name) -&gt; Name -&gt; Name
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1574"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; Name
</span><a href="Language.Futhark.Core.html#nameFromString"><span class="hs-identifier hs-var">nameFromString</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Name) -&gt; String -&gt; Name
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1575"></span><span>            </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;iota_&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">IntType -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684536382"><span class="hs-identifier hs-var">et</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_&quot;</span></span><span>
</span><span id="line-1576"></span><span>              </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Int
</span><a href="Language.Futhark.Core.html#baseTag"><span class="hs-identifier hs-var">baseTag</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Int) -&gt; VName -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelGlobalThreadIdVar"><span class="hs-identifier hs-var hs-var">kernelGlobalThreadIdVar</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684536380"><span class="hs-identifier hs-var">constants</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1577"></span><span>
</span><span id="line-1578"></span><span>  </span><span class="annot"><span class="annottext">Bool
-&gt; Operations GPUMem KernelEnv KernelOp
-&gt; KernelConstants
-&gt; Name
-&gt; InKernelGen ()
-&gt; ImpM GPUMem HostEnv HostOp ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#sKernelFailureTolerant"><span class="hs-identifier hs-var">sKernelFailureTolerant</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">Operations GPUMem KernelEnv KernelOp
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#threadOperations"><span class="hs-identifier hs-var">threadOperations</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684536380"><span class="hs-identifier hs-var">constants</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684536377"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; ImpM GPUMem HostEnv HostOp ())
-&gt; InKernelGen () -&gt; ImpM GPUMem HostEnv HostOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1579"></span><span>    </span><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684536379"><span class="hs-identifier hs-var">set_constants</span></a></span><span>
</span><span id="line-1580"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684536376"><span class="annot"><span class="annottext">gtid :: TExp Int64
</span><a href="#local-6989586621684536376"><span class="hs-identifier hs-var hs-var">gtid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int64
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int32 -&gt; TExp Int64) -&gt; TExp Int32 -&gt; TExp Int64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelGlobalThreadId"><span class="hs-identifier hs-var hs-var">kernelGlobalThreadId</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684536380"><span class="hs-identifier hs-var">constants</span></a></span><span>
</span><span id="line-1581"></span><span>    </span><span class="annot"><span class="annottext">TExp Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Bool
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelThreadActive"><span class="hs-identifier hs-var hs-var">kernelThreadActive</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684536380"><span class="hs-identifier hs-var">constants</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1582"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684536375"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536375"><span class="hs-identifier hs-var">destmem</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684536374"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684536374"><span class="hs-identifier hs-var">destspace</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684536373"><span class="annot"><span class="annottext">Count Elements (TExp Int64)
</span><a href="#local-6989586621684536373"><span class="hs-identifier hs-var">destidx</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MemLoc
-&gt; [TExp Int64]
-&gt; ImpM
     GPUMem
     KernelEnv
     KernelOp
     (VName, Space, Count Elements (TExp Int64))
forall rep r op.
MemLoc
-&gt; [TExp Int64]
-&gt; ImpM rep r op (VName, Space, Count Elements (TExp Int64))
</span><a href="Futhark.CodeGen.ImpGen.html#fullyIndexArray%27"><span class="hs-identifier hs-var">fullyIndexArray'</span></a></span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684536381"><span class="hs-identifier hs-var">destloc</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536376"><span class="hs-identifier hs-var">gtid</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1583"></span><span>
</span><span id="line-1584"></span><span>      </span><span class="annot"><span class="annottext">Code KernelOp -&gt; InKernelGen ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code KernelOp -&gt; InKernelGen ())
-&gt; Code KernelOp -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1585"></span><span>        </span><span class="annot"><span class="annottext">VName
-&gt; Count Elements (TExp Int64)
-&gt; PrimType
-&gt; Space
-&gt; Volatility
-&gt; PrimExp VName
-&gt; Code KernelOp
forall a.
VName
-&gt; Count Elements (TExp Int64)
-&gt; PrimType
-&gt; Space
-&gt; Volatility
-&gt; PrimExp VName
-&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#Write"><span class="hs-identifier hs-var">Imp.Write</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536375"><span class="hs-identifier hs-var">destmem</span></a></span><span> </span><span class="annot"><span class="annottext">Count Elements (TExp Int64)
</span><a href="#local-6989586621684536373"><span class="hs-identifier hs-var">destidx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; PrimType
</span><a href="Futhark.IR.Primitive.html#IntType"><span class="hs-identifier hs-var">IntType</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684536382"><span class="hs-identifier hs-var">et</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684536374"><span class="hs-identifier hs-var">destspace</span></a></span><span> </span><span class="annot"><span class="annottext">Volatility
</span><a href="Futhark.CodeGen.ImpCode.html#Nonvolatile"><span class="hs-identifier hs-var">Imp.Nonvolatile</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimExp VName -&gt; Code KernelOp) -&gt; PrimExp VName -&gt; Code KernelOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1586"></span><span>          </span><span class="annot"><span class="annottext">BinOp -&gt; PrimExp VName -&gt; PrimExp VName -&gt; PrimExp VName
forall v. BinOp -&gt; PrimExp v -&gt; PrimExp v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#BinOpExp"><span class="hs-identifier hs-var">BinOpExp</span></a></span><span>
</span><span id="line-1587"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Overflow -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#Add"><span class="hs-identifier hs-var">Add</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684536382"><span class="hs-identifier hs-var">et</span></a></span><span> </span><span class="annot"><span class="annottext">Overflow
</span><a href="Futhark.IR.Primitive.html#OverflowWrap"><span class="hs-identifier hs-var">OverflowWrap</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1588"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BinOp -&gt; PrimExp VName -&gt; PrimExp VName -&gt; PrimExp VName
forall v. BinOp -&gt; PrimExp v -&gt; PrimExp v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#BinOpExp"><span class="hs-identifier hs-var">BinOpExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Overflow -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#Mul"><span class="hs-identifier hs-var">Mul</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684536382"><span class="hs-identifier hs-var">et</span></a></span><span> </span><span class="annot"><span class="annottext">Overflow
</span><a href="Futhark.IR.Primitive.html#OverflowWrap"><span class="hs-identifier hs-var">OverflowWrap</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; PrimExp VName -&gt; PrimExp VName
forall v. IntType -&gt; PrimExp v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#sExt"><span class="hs-identifier hs-var">Imp.sExt</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684536382"><span class="hs-identifier hs-var">et</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimExp VName -&gt; PrimExp VName) -&gt; PrimExp VName -&gt; PrimExp VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; PrimExp VName
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536376"><span class="hs-identifier hs-var">gtid</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684536383"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1589"></span><span>            </span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684536384"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-1590"></span><span>
</span><span id="line-1591"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#iotaName"><span class="hs-identifier hs-type">iotaName</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Primitive.html#IntType"><span class="hs-identifier hs-type">IntType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-1592"></span><span id="iotaName"><span class="annot"><span class="annottext">iotaName :: IntType -&gt; String
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#iotaName"><span class="hs-identifier hs-var hs-var">iotaName</span></a></span></span><span> </span><span id="local-6989586621684536365"><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684536365"><span class="hs-identifier hs-var">bt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;iota_&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">IntType -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684536365"><span class="hs-identifier hs-var">bt</span></a></span><span>
</span><span id="line-1593"></span><span>
</span><span id="line-1594"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#iotaForType"><span class="hs-identifier hs-type">iotaForType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Primitive.html#IntType"><span class="hs-identifier hs-type">IntType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#CallKernelGen"><span class="hs-identifier hs-type">CallKernelGen</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span>
</span><span id="line-1595"></span><span id="iotaForType"><span class="annot"><span class="annottext">iotaForType :: IntType -&gt; ImpM GPUMem HostEnv HostOp Name
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#iotaForType"><span class="hs-identifier hs-var hs-var">iotaForType</span></a></span></span><span> </span><span id="local-6989586621684536363"><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684536363"><span class="hs-identifier hs-var">bt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1596"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684536362"><span class="annot"><span class="annottext">fname :: Name
</span><a href="#local-6989586621684536362"><span class="hs-identifier hs-var hs-var">fname</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Name
</span><a href="Language.Futhark.Core.html#nameFromString"><span class="hs-identifier hs-var">nameFromString</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Name) -&gt; String -&gt; Name
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;builtin#&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">IntType -&gt; String
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#iotaName"><span class="hs-identifier hs-var">iotaName</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684536363"><span class="hs-identifier hs-var">bt</span></a></span><span>
</span><span id="line-1597"></span><span>
</span><span id="line-1598"></span><span>  </span><span id="local-6989586621684536361"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684536361"><span class="hs-identifier hs-var">exists</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; ImpM GPUMem HostEnv HostOp Bool
forall rep r op. Name -&gt; ImpM rep r op Bool
</span><a href="Futhark.CodeGen.ImpGen.html#hasFunction"><span class="hs-identifier hs-var">hasFunction</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684536362"><span class="hs-identifier hs-var">fname</span></a></span><span>
</span><span id="line-1599"></span><span>  </span><span class="annot"><span class="annottext">Bool
-&gt; ImpM GPUMem HostEnv HostOp () -&gt; ImpM GPUMem HostEnv HostOp ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684536361"><span class="hs-identifier hs-var">exists</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem HostEnv HostOp () -&gt; ImpM GPUMem HostEnv HostOp ())
-&gt; ImpM GPUMem HostEnv HostOp () -&gt; ImpM GPUMem HostEnv HostOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1600"></span><span>    </span><span id="local-6989586621684536360"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536360"><span class="hs-identifier hs-var">mem</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; ImpM GPUMem HostEnv HostOp VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; String -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;mem&quot;</span></span><span>
</span><span id="line-1601"></span><span>    </span><span id="local-6989586621684536359"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536359"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; ImpM GPUMem HostEnv HostOp VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; String -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;n&quot;</span></span><span>
</span><span id="line-1602"></span><span>    </span><span id="local-6989586621684536358"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536358"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; ImpM GPUMem HostEnv HostOp VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; String -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;x&quot;</span></span><span>
</span><span id="line-1603"></span><span>    </span><span id="local-6989586621684536357"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536357"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; ImpM GPUMem HostEnv HostOp VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; String -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;s&quot;</span></span><span>
</span><span id="line-1604"></span><span>
</span><span id="line-1605"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684536356"><span class="annot"><span class="annottext">params :: [Param]
</span><a href="#local-6989586621684536356"><span class="hs-identifier hs-var hs-var">params</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1606"></span><span>          </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Space -&gt; Param
</span><a href="Futhark.CodeGen.ImpCode.html#MemParam"><span class="hs-identifier hs-var">Imp.MemParam</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536360"><span class="hs-identifier hs-var">mem</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Space
</span><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-var">Space</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;device&quot;</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-1607"></span><span>            </span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; Param
</span><a href="Futhark.CodeGen.ImpCode.html#ScalarParam"><span class="hs-identifier hs-var">Imp.ScalarParam</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536359"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int32"><span class="hs-identifier hs-var">int32</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1608"></span><span>            </span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; Param
</span><a href="Futhark.CodeGen.ImpCode.html#ScalarParam"><span class="hs-identifier hs-var">Imp.ScalarParam</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536358"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimType -&gt; Param) -&gt; PrimType -&gt; Param
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IntType -&gt; PrimType
</span><a href="Futhark.IR.Primitive.html#IntType"><span class="hs-identifier hs-var">IntType</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684536363"><span class="hs-identifier hs-var">bt</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1609"></span><span>            </span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; Param
</span><a href="Futhark.CodeGen.ImpCode.html#ScalarParam"><span class="hs-identifier hs-var">Imp.ScalarParam</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536357"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimType -&gt; Param) -&gt; PrimType -&gt; Param
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IntType -&gt; PrimType
</span><a href="Futhark.IR.Primitive.html#IntType"><span class="hs-identifier hs-var">IntType</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684536363"><span class="hs-identifier hs-var">bt</span></a></span><span>
</span><span id="line-1610"></span><span>          </span><span class="hs-special">]</span><span>
</span><span id="line-1611"></span><span>        </span><span id="local-6989586621684536355"><span class="annot"><span class="annottext">shape :: Shape
</span><a href="#local-6989586621684536355"><span class="hs-identifier hs-var hs-var">shape</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; Shape
forall d. [d] -&gt; ShapeBase d
</span><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-var">Shape</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536359"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1612"></span><span>        </span><span id="local-6989586621684536354"><span class="annot"><span class="annottext">n' :: TExp Int64
</span><a href="#local-6989586621684536354"><span class="hs-identifier hs-var hs-var">n'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; TExp Int64
forall a. a -&gt; TPrimExp Int64 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le64"><span class="hs-identifier hs-var">Imp.le64</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536359"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-1613"></span><span>        </span><span id="local-6989586621684536353"><span class="annot"><span class="annottext">x' :: PrimExp VName
</span><a href="#local-6989586621684536353"><span class="hs-identifier hs-var hs-var">x'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; PrimExp VName
</span><a href="Futhark.CodeGen.ImpCode.html#var"><span class="hs-identifier hs-var">Imp.var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536358"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimType -&gt; PrimExp VName) -&gt; PrimType -&gt; PrimExp VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IntType -&gt; PrimType
</span><a href="Futhark.IR.Primitive.html#IntType"><span class="hs-identifier hs-var">IntType</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684536363"><span class="hs-identifier hs-var">bt</span></a></span><span>
</span><span id="line-1614"></span><span>        </span><span id="local-6989586621684536352"><span class="annot"><span class="annottext">s' :: PrimExp VName
</span><a href="#local-6989586621684536352"><span class="hs-identifier hs-var hs-var">s'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; PrimExp VName
</span><a href="Futhark.CodeGen.ImpCode.html#var"><span class="hs-identifier hs-var">Imp.var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536357"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimType -&gt; PrimExp VName) -&gt; PrimType -&gt; PrimExp VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IntType -&gt; PrimType
</span><a href="Futhark.IR.Primitive.html#IntType"><span class="hs-identifier hs-var">IntType</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684536363"><span class="hs-identifier hs-var">bt</span></a></span><span>
</span><span id="line-1615"></span><span>
</span><span id="line-1616"></span><span>    </span><span class="annot"><span class="annottext">Name
-&gt; [Param]
-&gt; [Param]
-&gt; ImpM GPUMem HostEnv HostOp ()
-&gt; ImpM GPUMem HostEnv HostOp ()
forall rep r op.
Name -&gt; [Param] -&gt; [Param] -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#function"><span class="hs-identifier hs-var">function</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684536362"><span class="hs-identifier hs-var">fname</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[Param]
</span><a href="#local-6989586621684536356"><span class="hs-identifier hs-var">params</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem HostEnv HostOp () -&gt; ImpM GPUMem HostEnv HostOp ())
-&gt; ImpM GPUMem HostEnv HostOp () -&gt; ImpM GPUMem HostEnv HostOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1617"></span><span>      </span><span id="local-6989586621684536351"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536351"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1618"></span><span>        </span><span class="annot"><span class="annottext">String
-&gt; PrimType
-&gt; Shape
-&gt; VName
-&gt; IxFun
-&gt; ImpM GPUMem HostEnv HostOp VName
forall rep r op.
String
-&gt; PrimType -&gt; Shape -&gt; VName -&gt; IxFun -&gt; ImpM rep r op VName
</span><a href="Futhark.CodeGen.ImpGen.html#sArray"><span class="hs-identifier hs-var">sArray</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;arr&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; PrimType
</span><a href="Futhark.IR.Primitive.html#IntType"><span class="hs-identifier hs-var">IntType</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684536363"><span class="hs-identifier hs-var">bt</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684536355"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536360"><span class="hs-identifier hs-var">mem</span></a></span><span> </span><span class="annot"><span class="annottext">(IxFun -&gt; ImpM GPUMem HostEnv HostOp VName)
-&gt; IxFun -&gt; ImpM GPUMem HostEnv HostOp VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1619"></span><span>          </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; IxFun
forall num. IntegralExp num =&gt; Shape num -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#iota"><span class="hs-identifier hs-var">IxFun.iota</span></a></span><span> </span><span class="annot"><span class="annottext">([TExp Int64] -&gt; IxFun) -&gt; [TExp Int64] -&gt; IxFun
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
</span><a href="Futhark.Analysis.PrimExp.Convert.html#pe64"><span class="hs-identifier hs-var">pe64</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [TExp Int64]) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Shape -&gt; [SubExp]
forall d. ShapeBase d -&gt; [d]
</span><a href="Futhark.IR.Syntax.Core.html#shapeDims"><span class="hs-identifier hs-var hs-var">shapeDims</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684536355"><span class="hs-identifier hs-var">shape</span></a></span><span>
</span><span id="line-1620"></span><span>      </span><span class="annot"><span class="annottext">VName
-&gt; TExp Int64
-&gt; PrimExp VName
-&gt; PrimExp VName
-&gt; IntType
-&gt; ImpM GPUMem HostEnv HostOp ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#sIotaKernel"><span class="hs-identifier hs-var">sIotaKernel</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536351"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536354"><span class="hs-identifier hs-var">n'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684536353"><span class="hs-identifier hs-var">x'</span></a></span><span> </span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684536352"><span class="hs-identifier hs-var">s'</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684536363"><span class="hs-identifier hs-var">bt</span></a></span><span>
</span><span id="line-1621"></span><span>
</span><span id="line-1622"></span><span>  </span><span class="annot"><span class="annottext">Name -&gt; ImpM GPUMem HostEnv HostOp Name
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684536362"><span class="hs-identifier hs-var">fname</span></a></span><span>
</span><span id="line-1623"></span><span>
</span><span id="line-1624"></span><span class="hs-comment">-- | Perform an Iota with a kernel.</span><span>
</span><span id="line-1625"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#sIota"><span class="hs-identifier hs-type">sIota</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1626"></span><span>  </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1627"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1628"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#Exp"><span class="hs-identifier hs-type">Imp.Exp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1629"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#Exp"><span class="hs-identifier hs-type">Imp.Exp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1630"></span><span>  </span><span class="annot"><a href="Futhark.IR.Primitive.html#IntType"><span class="hs-identifier hs-type">IntType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1631"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#CallKernelGen"><span class="hs-identifier hs-type">CallKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1632"></span><span id="sIota"><span class="annot"><span class="annottext">sIota :: VName
-&gt; TExp Int64
-&gt; PrimExp VName
-&gt; PrimExp VName
-&gt; IntType
-&gt; ImpM GPUMem HostEnv HostOp ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#sIota"><span class="hs-identifier hs-var hs-var">sIota</span></a></span></span><span> </span><span id="local-6989586621684536350"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536350"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span id="local-6989586621684536349"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536349"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621684536348"><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684536348"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621684536347"><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684536347"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621684536346"><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684536346"><span class="hs-identifier hs-var">et</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1633"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ArrayEntry"><span class="hs-identifier hs-type">ArrayEntry</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemLoc"><span class="hs-identifier hs-type">MemLoc</span></a></span><span> </span><span id="local-6989586621684536345"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536345"><span class="hs-identifier hs-var">arr_mem</span></a></span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684536344"><span class="annot"><span class="annottext">IxFun
</span><a href="#local-6989586621684536344"><span class="hs-identifier hs-var">arr_ixfun</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PrimType
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; ImpM GPUMem HostEnv HostOp ArrayEntry
forall rep r op. VName -&gt; ImpM rep r op ArrayEntry
</span><a href="Futhark.CodeGen.ImpGen.html#lookupArray"><span class="hs-identifier hs-var">lookupArray</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536350"><span class="hs-identifier hs-var">arr</span></a></span><span>
</span><span id="line-1634"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">IxFun -&gt; Bool
forall num. (Eq num, IntegralExp num) =&gt; IxFun num -&gt; Bool
</span><a href="Futhark.IR.Mem.IxFun.html#isLinear"><span class="hs-identifier hs-var">IxFun.isLinear</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun
</span><a href="#local-6989586621684536344"><span class="hs-identifier hs-var">arr_ixfun</span></a></span><span>
</span><span id="line-1635"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1636"></span><span>      </span><span id="local-6989586621684536343"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684536343"><span class="hs-identifier hs-var">fname</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IntType -&gt; ImpM GPUMem HostEnv HostOp Name
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#iotaForType"><span class="hs-identifier hs-var">iotaForType</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684536346"><span class="hs-identifier hs-var">et</span></a></span><span>
</span><span id="line-1637"></span><span>      </span><span class="annot"><span class="annottext">Code HostOp -&gt; ImpM GPUMem HostEnv HostOp ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code HostOp -&gt; ImpM GPUMem HostEnv HostOp ())
-&gt; Code HostOp -&gt; ImpM GPUMem HostEnv HostOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1638"></span><span>        </span><span class="annot"><span class="annottext">[VName] -&gt; Name -&gt; [Arg] -&gt; Code HostOp
forall a. [VName] -&gt; Name -&gt; [Arg] -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#Call"><span class="hs-identifier hs-var">Imp.Call</span></a></span><span>
</span><span id="line-1639"></span><span>          </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1640"></span><span>          </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684536343"><span class="hs-identifier hs-var">fname</span></a></span><span>
</span><span id="line-1641"></span><span>          </span><span class="hs-special">[</span><span class="annot"><span class="annottext">VName -&gt; Arg
</span><a href="Futhark.CodeGen.ImpCode.html#MemArg"><span class="hs-identifier hs-var">Imp.MemArg</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536345"><span class="hs-identifier hs-var">arr_mem</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PrimExp VName -&gt; Arg
</span><a href="Futhark.CodeGen.ImpCode.html#ExpArg"><span class="hs-identifier hs-var">Imp.ExpArg</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimExp VName -&gt; Arg) -&gt; PrimExp VName -&gt; Arg
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; PrimExp VName
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536349"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PrimExp VName -&gt; Arg
</span><a href="Futhark.CodeGen.ImpCode.html#ExpArg"><span class="hs-identifier hs-var">Imp.ExpArg</span></a></span><span> </span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684536348"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PrimExp VName -&gt; Arg
</span><a href="Futhark.CodeGen.ImpCode.html#ExpArg"><span class="hs-identifier hs-var">Imp.ExpArg</span></a></span><span> </span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684536347"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1642"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">VName
-&gt; TExp Int64
-&gt; PrimExp VName
-&gt; PrimExp VName
-&gt; IntType
-&gt; ImpM GPUMem HostEnv HostOp ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#sIotaKernel"><span class="hs-identifier hs-var">sIotaKernel</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536350"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536349"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684536348"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684536347"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684536346"><span class="hs-identifier hs-var">et</span></a></span><span>
</span><span id="line-1643"></span><span>
</span><span id="line-1644"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#sCopy"><span class="hs-identifier hs-type">sCopy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#CopyCompiler"><span class="hs-identifier hs-type">CopyCompiler</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#HostEnv"><span class="hs-identifier hs-type">HostEnv</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.GPU.html#HostOp"><span class="hs-identifier hs-type">Imp.HostOp</span></a></span><span>
</span><span id="line-1645"></span><span id="sCopy"><span class="annot"><span class="annottext">sCopy :: CopyCompiler GPUMem HostEnv HostOp
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#sCopy"><span class="hs-identifier hs-var hs-var">sCopy</span></a></span></span><span> </span><span id="local-6989586621684536342"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684536342"><span class="hs-identifier hs-var">pt</span></a></span></span><span> </span><span id="local-6989586621684536341"><span class="annot"><span class="annottext">destloc :: MemLoc
</span><a href="#local-6989586621684536341"><span class="hs-identifier hs-var">destloc</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemLoc"><span class="hs-identifier hs-type">MemLoc</span></a></span><span> </span><span id="local-6989586621684536340"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536340"><span class="hs-identifier hs-var">destmem</span></a></span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">IxFun
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684536339"><span class="annot"><span class="annottext">srcloc :: MemLoc
</span><a href="#local-6989586621684536339"><span class="hs-identifier hs-var">srcloc</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemLoc"><span class="hs-identifier hs-type">MemLoc</span></a></span><span> </span><span id="local-6989586621684536338"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536338"><span class="hs-identifier hs-var">srcmem</span></a></span></span><span> </span><span id="local-6989586621684536337"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684536337"><span class="hs-identifier hs-var">srcdims</span></a></span></span><span> </span><span class="annot"><span class="annottext">IxFun
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1646"></span><span>  </span><span class="hs-comment">-- Note that the shape of the destination and the source are</span><span>
</span><span id="line-1647"></span><span>  </span><span class="hs-comment">-- necessarily the same.</span><span>
</span><span id="line-1648"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684536336"><span class="annot"><span class="annottext">shape :: [TExp Int64]
</span><a href="#local-6989586621684536336"><span class="hs-identifier hs-var hs-var">shape</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684536337"><span class="hs-identifier hs-var">srcdims</span></a></span><span>
</span><span id="line-1649"></span><span>      </span><span id="local-6989586621684536335"><span class="annot"><span class="annottext">kernel_size :: TExp Int64
</span><a href="#local-6989586621684536335"><span class="hs-identifier hs-var hs-var">kernel_size</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; TExp Int64
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">product</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536336"><span class="hs-identifier hs-var">shape</span></a></span><span>
</span><span id="line-1650"></span><span>
</span><span id="line-1651"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684536334"><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684536334"><span class="hs-identifier hs-var">constants</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684536333"><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684536333"><span class="hs-identifier hs-var">set_constants</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TExp Int64
-&gt; String -&gt; CallKernelGen (KernelConstants, InKernelGen ())
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#simpleKernelConstants"><span class="hs-identifier hs-var">simpleKernelConstants</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536335"><span class="hs-identifier hs-var">kernel_size</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;copy&quot;</span></span><span>
</span><span id="line-1652"></span><span>
</span><span id="line-1653"></span><span>  </span><span id="local-6989586621684536332"><span class="annot"><span class="annottext">Maybe Name
</span><a href="#local-6989586621684536332"><span class="hs-identifier hs-var">fname</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ImpM GPUMem HostEnv HostOp (Maybe Name)
forall rep r op. ImpM rep r op (Maybe Name)
</span><a href="Futhark.CodeGen.ImpGen.html#askFunction"><span class="hs-identifier hs-var">askFunction</span></a></span><span>
</span><span id="line-1654"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684536331"><span class="annot"><span class="annottext">name :: Name
</span><a href="#local-6989586621684536331"><span class="hs-identifier hs-var hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1655"></span><span>        </span><span class="annot"><span class="annottext">Maybe Name -&gt; Name -&gt; Name
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#keyWithEntryPoint"><span class="hs-identifier hs-var">keyWithEntryPoint</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Name
</span><a href="#local-6989586621684536332"><span class="hs-identifier hs-var">fname</span></a></span><span> </span><span class="annot"><span class="annottext">(Name -&gt; Name) -&gt; Name -&gt; Name
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1656"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; Name
</span><a href="Language.Futhark.Core.html#nameFromString"><span class="hs-identifier hs-var">nameFromString</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Name) -&gt; String -&gt; Name
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1657"></span><span>            </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;copy_&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Int
</span><a href="Language.Futhark.Core.html#baseTag"><span class="hs-identifier hs-var">baseTag</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Int) -&gt; VName -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelGlobalThreadIdVar"><span class="hs-identifier hs-var hs-var">kernelGlobalThreadIdVar</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684536334"><span class="hs-identifier hs-var">constants</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1658"></span><span>
</span><span id="line-1659"></span><span>  </span><span class="annot"><span class="annottext">Bool
-&gt; Operations GPUMem KernelEnv KernelOp
-&gt; KernelConstants
-&gt; Name
-&gt; InKernelGen ()
-&gt; ImpM GPUMem HostEnv HostOp ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#sKernelFailureTolerant"><span class="hs-identifier hs-var">sKernelFailureTolerant</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">Operations GPUMem KernelEnv KernelOp
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#threadOperations"><span class="hs-identifier hs-var">threadOperations</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684536334"><span class="hs-identifier hs-var">constants</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684536331"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; ImpM GPUMem HostEnv HostOp ())
-&gt; InKernelGen () -&gt; ImpM GPUMem HostEnv HostOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1660"></span><span>    </span><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684536333"><span class="hs-identifier hs-var">set_constants</span></a></span><span>
</span><span id="line-1661"></span><span>
</span><span id="line-1662"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684536330"><span class="annot"><span class="annottext">gtid :: TExp Int64
</span><a href="#local-6989586621684536330"><span class="hs-identifier hs-var hs-var">gtid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int64
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int32 -&gt; TExp Int64) -&gt; TExp Int32 -&gt; TExp Int64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelGlobalThreadId"><span class="hs-identifier hs-var hs-var">kernelGlobalThreadId</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684536334"><span class="hs-identifier hs-var">constants</span></a></span><span>
</span><span id="line-1663"></span><span>    </span><span id="local-6989586621684536329"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536329"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; [TExp Int64] -&gt; TExp Int64 -&gt; InKernelGen [TExp Int64]
forall rep r op.
String -&gt; [TExp Int64] -&gt; TExp Int64 -&gt; ImpM rep r op [TExp Int64]
</span><a href="Futhark.CodeGen.ImpGen.html#dIndexSpace%27"><span class="hs-identifier hs-var">dIndexSpace'</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;copy_i&quot;</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536336"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536330"><span class="hs-identifier hs-var">gtid</span></a></span><span>
</span><span id="line-1664"></span><span>
</span><span id="line-1665"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684536328"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684536328"><span class="hs-identifier hs-var">destspace</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684536327"><span class="annot"><span class="annottext">Count Elements (TExp Int64)
</span><a href="#local-6989586621684536327"><span class="hs-identifier hs-var">destidx</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MemLoc
-&gt; [TExp Int64]
-&gt; ImpM
     GPUMem
     KernelEnv
     KernelOp
     (VName, Space, Count Elements (TExp Int64))
forall rep r op.
MemLoc
-&gt; [TExp Int64]
-&gt; ImpM rep r op (VName, Space, Count Elements (TExp Int64))
</span><a href="Futhark.CodeGen.ImpGen.html#fullyIndexArray%27"><span class="hs-identifier hs-var">fullyIndexArray'</span></a></span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684536341"><span class="hs-identifier hs-var">destloc</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536329"><span class="hs-identifier hs-var">is</span></a></span><span>
</span><span id="line-1666"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684536326"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684536326"><span class="hs-identifier hs-var">srcspace</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684536325"><span class="annot"><span class="annottext">Count Elements (TExp Int64)
</span><a href="#local-6989586621684536325"><span class="hs-identifier hs-var">srcidx</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MemLoc
-&gt; [TExp Int64]
-&gt; ImpM
     GPUMem
     KernelEnv
     KernelOp
     (VName, Space, Count Elements (TExp Int64))
forall rep r op.
MemLoc
-&gt; [TExp Int64]
-&gt; ImpM rep r op (VName, Space, Count Elements (TExp Int64))
</span><a href="Futhark.CodeGen.ImpGen.html#fullyIndexArray%27"><span class="hs-identifier hs-var">fullyIndexArray'</span></a></span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684536339"><span class="hs-identifier hs-var">srcloc</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536329"><span class="hs-identifier hs-var">is</span></a></span><span>
</span><span id="line-1667"></span><span>
</span><span id="line-1668"></span><span>    </span><span class="annot"><span class="annottext">TExp Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536330"><span class="hs-identifier hs-var">gtid</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Bool
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3C."><span class="hs-operator hs-var">.&lt;.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536335"><span class="hs-identifier hs-var">kernel_size</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1669"></span><span>      </span><span id="local-6989586621684536324"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536324"><span class="hs-identifier hs-var">tmp</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TV Any -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">(TV Any -&gt; VName)
-&gt; ImpM GPUMem KernelEnv KernelOp (TV Any)
-&gt; ImpM GPUMem KernelEnv KernelOp VName
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; PrimType -&gt; ImpM GPUMem KernelEnv KernelOp (TV Any)
forall rep r op t. String -&gt; PrimType -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrim"><span class="hs-identifier hs-var">dPrim</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;tmp&quot;</span></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684536342"><span class="hs-identifier hs-var">pt</span></a></span><span>
</span><span id="line-1670"></span><span>      </span><span class="annot"><span class="annottext">Code KernelOp -&gt; InKernelGen ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code KernelOp -&gt; InKernelGen ())
-&gt; Code KernelOp -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName
-&gt; VName
-&gt; Count Elements (TExp Int64)
-&gt; PrimType
-&gt; Space
-&gt; Volatility
-&gt; Code KernelOp
forall a.
VName
-&gt; VName
-&gt; Count Elements (TExp Int64)
-&gt; PrimType
-&gt; Space
-&gt; Volatility
-&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#Read"><span class="hs-identifier hs-var">Imp.Read</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536324"><span class="hs-identifier hs-var">tmp</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536338"><span class="hs-identifier hs-var">srcmem</span></a></span><span> </span><span class="annot"><span class="annottext">Count Elements (TExp Int64)
</span><a href="#local-6989586621684536325"><span class="hs-identifier hs-var">srcidx</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684536342"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684536326"><span class="hs-identifier hs-var">srcspace</span></a></span><span> </span><span class="annot"><span class="annottext">Volatility
</span><a href="Futhark.CodeGen.ImpCode.html#Nonvolatile"><span class="hs-identifier hs-var">Imp.Nonvolatile</span></a></span><span>
</span><span id="line-1671"></span><span>      </span><span class="annot"><span class="annottext">Code KernelOp -&gt; InKernelGen ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code KernelOp -&gt; InKernelGen ())
-&gt; Code KernelOp -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName
-&gt; Count Elements (TExp Int64)
-&gt; PrimType
-&gt; Space
-&gt; Volatility
-&gt; PrimExp VName
-&gt; Code KernelOp
forall a.
VName
-&gt; Count Elements (TExp Int64)
-&gt; PrimType
-&gt; Space
-&gt; Volatility
-&gt; PrimExp VName
-&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#Write"><span class="hs-identifier hs-var">Imp.Write</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536340"><span class="hs-identifier hs-var">destmem</span></a></span><span> </span><span class="annot"><span class="annottext">Count Elements (TExp Int64)
</span><a href="#local-6989586621684536327"><span class="hs-identifier hs-var">destidx</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684536342"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684536328"><span class="hs-identifier hs-var">destspace</span></a></span><span> </span><span class="annot"><span class="annottext">Volatility
</span><a href="Futhark.CodeGen.ImpCode.html#Nonvolatile"><span class="hs-identifier hs-var">Imp.Nonvolatile</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimExp VName -&gt; Code KernelOp) -&gt; PrimExp VName -&gt; Code KernelOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; PrimExp VName
</span><a href="Futhark.CodeGen.ImpCode.html#var"><span class="hs-identifier hs-var">Imp.var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536324"><span class="hs-identifier hs-var">tmp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684536342"><span class="hs-identifier hs-var">pt</span></a></span><span>
</span><span id="line-1672"></span><span>
</span><span id="line-1673"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileGroupResult"><span class="hs-identifier hs-type">compileGroupResult</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1674"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegSpace"><span class="hs-identifier hs-type">SegSpace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1675"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#PatElem"><span class="hs-identifier hs-type">PatElem</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1676"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#KernelResult"><span class="hs-identifier hs-type">KernelResult</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1677"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#InKernelGen"><span class="hs-identifier hs-type">InKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1678"></span><span id="compileGroupResult"><span class="annot"><span class="annottext">compileGroupResult :: SegSpace
-&gt; PatElemT (LetDec GPUMem) -&gt; KernelResult -&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileGroupResult"><span class="hs-identifier hs-var hs-var">compileGroupResult</span></a></span></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684536321"><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
</span><a href="#local-6989586621684536321"><span class="hs-identifier hs-var">pe</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#TileReturns"><span class="hs-identifier hs-type">TileReturns</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span id="local-6989586621684536319"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684536319"><span class="hs-identifier hs-var">w</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684536318"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684536318"><span class="hs-identifier hs-var">per_group_elems</span></a></span></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span id="local-6989586621684536317"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536317"><span class="hs-identifier hs-var">what</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1679"></span><span>  </span><span id="local-6989586621684536316"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536316"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64)
-&gt; (TypeBase Shape NoUniqueness -&gt; SubExp)
-&gt; TypeBase Shape NoUniqueness
-&gt; TExp Int64
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; TypeBase Shape NoUniqueness -&gt; SubExp
forall u. Int -&gt; TypeBase Shape u -&gt; SubExp
</span><a href="Futhark.IR.Prop.Types.html#arraySize"><span class="hs-identifier hs-var">arraySize</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">(TypeBase Shape NoUniqueness -&gt; TExp Int64)
-&gt; ImpM GPUMem KernelEnv KernelOp (TypeBase Shape NoUniqueness)
-&gt; ImpM GPUMem KernelEnv KernelOp (TExp Int64)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">VName
-&gt; ImpM GPUMem KernelEnv KernelOp (TypeBase Shape NoUniqueness)
forall rep (m :: * -&gt; *).
HasScope rep m =&gt;
VName -&gt; m (TypeBase Shape NoUniqueness)
</span><a href="Futhark.IR.Prop.Scope.html#lookupType"><span class="hs-identifier hs-var">lookupType</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536317"><span class="hs-identifier hs-var">what</span></a></span><span>
</span><span id="line-1680"></span><span>
</span><span id="line-1681"></span><span>  </span><span id="local-6989586621684536314"><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684536314"><span class="hs-identifier hs-var">constants</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">KernelEnv -&gt; KernelConstants
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelConstants"><span class="hs-identifier hs-var hs-var">kernelConstants</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelEnv -&gt; KernelConstants)
-&gt; ImpM GPUMem KernelEnv KernelOp KernelEnv
-&gt; ImpM GPUMem KernelEnv KernelOp KernelConstants
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ImpM GPUMem KernelEnv KernelOp KernelEnv
forall rep r op. ImpM rep r op r
</span><a href="Futhark.CodeGen.ImpGen.html#askEnv"><span class="hs-identifier hs-var">askEnv</span></a></span><span>
</span><span id="line-1682"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684536313"><span class="annot"><span class="annottext">ltid :: TExp Int64
</span><a href="#local-6989586621684536313"><span class="hs-identifier hs-var hs-var">ltid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int64
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int32 -&gt; TExp Int64) -&gt; TExp Int32 -&gt; TExp Int64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelLocalThreadId"><span class="hs-identifier hs-var hs-var">kernelLocalThreadId</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684536314"><span class="hs-identifier hs-var">constants</span></a></span><span>
</span><span id="line-1683"></span><span>      </span><span id="local-6989586621684536312"><span class="annot"><span class="annottext">offset :: TExp Int64
</span><a href="#local-6989586621684536312"><span class="hs-identifier hs-var hs-var">offset</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1684"></span><span>        </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684536318"><span class="hs-identifier hs-var">per_group_elems</span></a></span><span>
</span><span id="line-1685"></span><span>          </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int64
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelGroupId"><span class="hs-identifier hs-var hs-var">kernelGroupId</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684536314"><span class="hs-identifier hs-var">constants</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1686"></span><span>
</span><span id="line-1687"></span><span>  </span><span class="hs-comment">-- Avoid loop for the common case where each thread is statically</span><span>
</span><span id="line-1688"></span><span>  </span><span class="hs-comment">-- known to write at most one element.</span><span>
</span><span id="line-1689"></span><span>  </span><span class="annot"><span class="annottext">Operations GPUMem KernelEnv KernelOp
-&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op a.
Operations rep r op -&gt; ImpM rep r op a -&gt; ImpM rep r op a
</span><a href="Futhark.CodeGen.ImpGen.html#localOps"><span class="hs-identifier hs-var">localOps</span></a></span><span> </span><span class="annot"><span class="annottext">Operations GPUMem KernelEnv KernelOp
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#threadOperations"><span class="hs-identifier hs-var">threadOperations</span></a></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1690"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684536318"><span class="hs-identifier hs-var">per_group_elems</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelGroupSize"><span class="hs-identifier hs-var hs-var">kernelGroupSize</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684536314"><span class="hs-identifier hs-var">constants</span></a></span><span>
</span><span id="line-1691"></span><span>      </span><span class="hs-keyword">then</span><span>
</span><span id="line-1692"></span><span>        </span><span class="annot"><span class="annottext">TExp Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536313"><span class="hs-identifier hs-var">ltid</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536312"><span class="hs-identifier hs-var">offset</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Bool
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3C."><span class="hs-operator hs-var">.&lt;.</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684536319"><span class="hs-identifier hs-var">w</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1693"></span><span>          </span><span class="annot"><span class="annottext">VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; InKernelGen ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
PatElemT LParamMem
</span><a href="#local-6989586621684536321"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536313"><span class="hs-identifier hs-var">ltid</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536312"><span class="hs-identifier hs-var">offset</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536317"><span class="hs-identifier hs-var">what</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536313"><span class="hs-identifier hs-var">ltid</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1694"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">String
-&gt; TExp Int64 -&gt; (TExp Int64 -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall t rep r op.
String
-&gt; TExp t -&gt; (TExp t -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sFor"><span class="hs-identifier hs-var">sFor</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;i&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536316"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall e. IntegralExp e =&gt; e -&gt; e -&gt; e
</span><a href="Futhark.Util.IntegralExp.html#divUp"><span class="hs-operator hs-var">`divUp`</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelGroupSize"><span class="hs-identifier hs-var hs-var">kernelGroupSize</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684536314"><span class="hs-identifier hs-var">constants</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((TExp Int64 -&gt; InKernelGen ()) -&gt; InKernelGen ())
-&gt; (TExp Int64 -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684536311"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536311"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1695"></span><span>        </span><span id="local-6989586621684536310"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536310"><span class="hs-identifier hs-var">j</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; TExp Int64 -&gt; ImpM GPUMem KernelEnv KernelOp (TExp Int64)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TExp t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimVE"><span class="hs-identifier hs-var">dPrimVE</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;j&quot;</span></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; ImpM GPUMem KernelEnv KernelOp (TExp Int64))
-&gt; TExp Int64 -&gt; ImpM GPUMem KernelEnv KernelOp (TExp Int64)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelGroupSize"><span class="hs-identifier hs-var hs-var">kernelGroupSize</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684536314"><span class="hs-identifier hs-var">constants</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536311"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536313"><span class="hs-identifier hs-var">ltid</span></a></span><span>
</span><span id="line-1696"></span><span>        </span><span class="annot"><span class="annottext">TExp Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536310"><span class="hs-identifier hs-var">j</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536312"><span class="hs-identifier hs-var">offset</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Bool
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3C."><span class="hs-operator hs-var">.&lt;.</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684536319"><span class="hs-identifier hs-var">w</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1697"></span><span>          </span><span class="annot"><span class="annottext">VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; InKernelGen ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
PatElemT LParamMem
</span><a href="#local-6989586621684536321"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536310"><span class="hs-identifier hs-var">j</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536312"><span class="hs-identifier hs-var">offset</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536317"><span class="hs-identifier hs-var">what</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536310"><span class="hs-identifier hs-var">j</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1698"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileGroupResult"><span class="hs-identifier hs-var">compileGroupResult</span></a></span><span> </span><span id="local-6989586621684536309"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684536309"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684536308"><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
</span><a href="#local-6989586621684536308"><span class="hs-identifier hs-var">pe</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#TileReturns"><span class="hs-identifier hs-type">TileReturns</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684536307"><span class="annot"><span class="annottext">[(SubExp, SubExp)]
</span><a href="#local-6989586621684536307"><span class="hs-identifier hs-var">dims</span></a></span></span><span> </span><span id="local-6989586621684536306"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536306"><span class="hs-identifier hs-var">what</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1699"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684536305"><span class="annot"><span class="annottext">gids :: [VName]
</span><a href="#local-6989586621684536305"><span class="hs-identifier hs-var hs-var">gids</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((VName, SubExp) -&gt; VName) -&gt; [(VName, SubExp)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(VName, SubExp) -&gt; VName
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">([(VName, SubExp)] -&gt; [VName]) -&gt; [(VName, SubExp)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; [(VName, SubExp)]
</span><a href="Futhark.IR.SegOp.html#unSegSpace"><span class="hs-identifier hs-var hs-var">unSegSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684536309"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-1700"></span><span>      </span><span id="local-6989586621684536304"><span class="annot"><span class="annottext">out_tile_sizes :: [TExp Int64]
</span><a href="#local-6989586621684536304"><span class="hs-identifier hs-var hs-var">out_tile_sizes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((SubExp, SubExp) -&gt; TExp Int64)
-&gt; [(SubExp, SubExp)] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64)
-&gt; ((SubExp, SubExp) -&gt; SubExp) -&gt; (SubExp, SubExp) -&gt; TExp Int64
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(SubExp, SubExp) -&gt; SubExp
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(SubExp, SubExp)]
</span><a href="#local-6989586621684536307"><span class="hs-identifier hs-var">dims</span></a></span><span>
</span><span id="line-1701"></span><span>      </span><span id="local-6989586621684536303"><span class="annot"><span class="annottext">group_is :: [TExp Int64]
</span><a href="#local-6989586621684536303"><span class="hs-identifier hs-var hs-var">group_is</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64)
-&gt; [TExp Int64] -&gt; [TExp Int64] -&gt; [TExp Int64]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">(*)</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(VName -&gt; TExp Int64) -&gt; [VName] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TExp Int64
forall a. a -&gt; TPrimExp Int64 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le64"><span class="hs-identifier hs-var">Imp.le64</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684536305"><span class="hs-identifier hs-var">gids</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536304"><span class="hs-identifier hs-var">out_tile_sizes</span></a></span><span>
</span><span id="line-1702"></span><span>  </span><span id="local-6989586621684536302"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536302"><span class="hs-identifier hs-var">local_is</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; InKernelGen [TExp Int64]
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#localThreadIDs"><span class="hs-identifier hs-var">localThreadIDs</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; InKernelGen [TExp Int64])
-&gt; [SubExp] -&gt; InKernelGen [TExp Int64]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((SubExp, SubExp) -&gt; SubExp) -&gt; [(SubExp, SubExp)] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(SubExp, SubExp) -&gt; SubExp
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">[(SubExp, SubExp)]
</span><a href="#local-6989586621684536307"><span class="hs-identifier hs-var">dims</span></a></span><span>
</span><span id="line-1703"></span><span>  </span><span id="local-6989586621684536301"><span class="annot"><span class="annottext">[TV Int64]
</span><a href="#local-6989586621684536301"><span class="hs-identifier hs-var">is_for_thread</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1704"></span><span>    </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; ImpM GPUMem KernelEnv KernelOp (TV Int64))
-&gt; [TExp Int64] -&gt; ImpM GPUMem KernelEnv KernelOp [TV Int64]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; TExp Int64 -&gt; ImpM GPUMem KernelEnv KernelOp (TV Int64)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV"><span class="hs-identifier hs-var">dPrimV</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;thread_out_index&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([TExp Int64] -&gt; ImpM GPUMem KernelEnv KernelOp [TV Int64])
-&gt; [TExp Int64] -&gt; ImpM GPUMem KernelEnv KernelOp [TV Int64]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1705"></span><span>      </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64)
-&gt; [TExp Int64] -&gt; [TExp Int64] -&gt; [TExp Int64]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">(+)</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536303"><span class="hs-identifier hs-var">group_is</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536302"><span class="hs-identifier hs-var">local_is</span></a></span><span>
</span><span id="line-1706"></span><span>
</span><span id="line-1707"></span><span>  </span><span class="annot"><span class="annottext">Operations GPUMem KernelEnv KernelOp
-&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op a.
Operations rep r op -&gt; ImpM rep r op a -&gt; ImpM rep r op a
</span><a href="Futhark.CodeGen.ImpGen.html#localOps"><span class="hs-identifier hs-var">localOps</span></a></span><span> </span><span class="annot"><span class="annottext">Operations GPUMem KernelEnv KernelOp
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#threadOperations"><span class="hs-identifier hs-var">threadOperations</span></a></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1708"></span><span>    </span><span class="annot"><span class="annottext">TExp Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(VName, SubExp)] -&gt; TExp Bool
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#isActive"><span class="hs-identifier hs-var">isActive</span></a></span><span> </span><span class="annot"><span class="annottext">([(VName, SubExp)] -&gt; TExp Bool) -&gt; [(VName, SubExp)] -&gt; TExp Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [SubExp] -&gt; [(VName, SubExp)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TV Int64 -&gt; VName) -&gt; [TV Int64] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TV Int64 -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">[TV Int64]
</span><a href="#local-6989586621684536301"><span class="hs-identifier hs-var">is_for_thread</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [(VName, SubExp)]) -&gt; [SubExp] -&gt; [(VName, SubExp)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((SubExp, SubExp) -&gt; SubExp) -&gt; [(SubExp, SubExp)] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(SubExp, SubExp) -&gt; SubExp
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(SubExp, SubExp)]
</span><a href="#local-6989586621684536307"><span class="hs-identifier hs-var">dims</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1709"></span><span>      </span><span class="annot"><span class="annottext">VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; InKernelGen ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
PatElemT LParamMem
</span><a href="#local-6989586621684536308"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TV Int64 -&gt; TExp Int64) -&gt; [TV Int64] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TV Int64 -&gt; TExp Int64
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">[TV Int64]
</span><a href="#local-6989586621684536301"><span class="hs-identifier hs-var">is_for_thread</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536306"><span class="hs-identifier hs-var">what</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536302"><span class="hs-identifier hs-var">local_is</span></a></span><span>
</span><span id="line-1710"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileGroupResult"><span class="hs-identifier hs-var">compileGroupResult</span></a></span><span> </span><span id="local-6989586621684536300"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684536300"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684536299"><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
</span><a href="#local-6989586621684536299"><span class="hs-identifier hs-var">pe</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#RegTileReturns"><span class="hs-identifier hs-type">RegTileReturns</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684536297"><span class="annot"><span class="annottext">[(SubExp, SubExp, SubExp)]
</span><a href="#local-6989586621684536297"><span class="hs-identifier hs-var">dims_n_tiles</span></a></span></span><span> </span><span id="local-6989586621684536296"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536296"><span class="hs-identifier hs-var">what</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1711"></span><span>  </span><span id="local-6989586621684536295"><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684536295"><span class="hs-identifier hs-var">constants</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">KernelEnv -&gt; KernelConstants
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelConstants"><span class="hs-identifier hs-var hs-var">kernelConstants</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelEnv -&gt; KernelConstants)
-&gt; ImpM GPUMem KernelEnv KernelOp KernelEnv
-&gt; ImpM GPUMem KernelEnv KernelOp KernelConstants
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ImpM GPUMem KernelEnv KernelOp KernelEnv
forall rep r op. ImpM rep r op r
</span><a href="Futhark.CodeGen.ImpGen.html#askEnv"><span class="hs-identifier hs-var">askEnv</span></a></span><span>
</span><span id="line-1712"></span><span>
</span><span id="line-1713"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684536294"><span class="annot"><span class="annottext">gids :: [VName]
</span><a href="#local-6989586621684536294"><span class="hs-identifier hs-var hs-var">gids</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((VName, SubExp) -&gt; VName) -&gt; [(VName, SubExp)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(VName, SubExp) -&gt; VName
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">([(VName, SubExp)] -&gt; [VName]) -&gt; [(VName, SubExp)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; [(VName, SubExp)]
</span><a href="Futhark.IR.SegOp.html#unSegSpace"><span class="hs-identifier hs-var hs-var">unSegSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684536300"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-1714"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684536293"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684536293"><span class="hs-identifier hs-var">dims</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684536292"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684536292"><span class="hs-identifier hs-var">group_tiles</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684536291"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684536291"><span class="hs-identifier hs-var">reg_tiles</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(SubExp, SubExp, SubExp)] -&gt; ([SubExp], [SubExp], [SubExp])
forall a b c. [(a, b, c)] -&gt; ([a], [b], [c])
</span><span class="hs-identifier hs-var">unzip3</span></span><span> </span><span class="annot"><span class="annottext">[(SubExp, SubExp, SubExp)]
</span><a href="#local-6989586621684536297"><span class="hs-identifier hs-var">dims_n_tiles</span></a></span><span>
</span><span id="line-1715"></span><span>      </span><span id="local-6989586621684536289"><span class="annot"><span class="annottext">group_tiles' :: [TExp Int64]
</span><a href="#local-6989586621684536289"><span class="hs-identifier hs-var hs-var">group_tiles'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684536292"><span class="hs-identifier hs-var">group_tiles</span></a></span><span>
</span><span id="line-1716"></span><span>      </span><span id="local-6989586621684536288"><span class="annot"><span class="annottext">reg_tiles' :: [TExp Int64]
</span><a href="#local-6989586621684536288"><span class="hs-identifier hs-var hs-var">reg_tiles'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684536291"><span class="hs-identifier hs-var">reg_tiles</span></a></span><span>
</span><span id="line-1717"></span><span>
</span><span id="line-1718"></span><span>  </span><span class="hs-comment">-- Which group tile is this group responsible for?</span><span>
</span><span id="line-1719"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684536287"><span class="annot"><span class="annottext">group_tile_is :: [TExp Int64]
</span><a href="#local-6989586621684536287"><span class="hs-identifier hs-var hs-var">group_tile_is</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; TExp Int64) -&gt; [VName] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TExp Int64
forall a. a -&gt; TPrimExp Int64 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le64"><span class="hs-identifier hs-var">Imp.le64</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684536294"><span class="hs-identifier hs-var">gids</span></a></span><span>
</span><span id="line-1720"></span><span>
</span><span id="line-1721"></span><span>  </span><span class="hs-comment">-- Within the group tile, which register tile is this thread</span><span>
</span><span id="line-1722"></span><span>  </span><span class="hs-comment">-- responsible for?</span><span>
</span><span id="line-1723"></span><span>  </span><span id="local-6989586621684536286"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536286"><span class="hs-identifier hs-var">reg_tile_is</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1724"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; [TExp Int64] -&gt; TExp Int64 -&gt; InKernelGen [TExp Int64]
forall rep r op.
String -&gt; [TExp Int64] -&gt; TExp Int64 -&gt; ImpM rep r op [TExp Int64]
</span><a href="Futhark.CodeGen.ImpGen.html#dIndexSpace%27"><span class="hs-identifier hs-var">dIndexSpace'</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;reg_tile_i&quot;</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536289"><span class="hs-identifier hs-var">group_tiles'</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; InKernelGen [TExp Int64])
-&gt; TExp Int64 -&gt; InKernelGen [TExp Int64]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int64
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int32 -&gt; TExp Int64) -&gt; TExp Int32 -&gt; TExp Int64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelLocalThreadId"><span class="hs-identifier hs-var hs-var">kernelLocalThreadId</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684536295"><span class="hs-identifier hs-var">constants</span></a></span><span>
</span><span id="line-1725"></span><span>
</span><span id="line-1726"></span><span>  </span><span class="hs-comment">-- Compute output array slice for the register tile belonging to</span><span>
</span><span id="line-1727"></span><span>  </span><span class="hs-comment">-- this thread.</span><span>
</span><span id="line-1728"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684536276"><span class="annot"><span class="annottext">regTileSliceDim :: (TExp t, TExp t)
-&gt; (TExp t, TExp t) -&gt; ImpM rep r op (DimIndex (TExp t))
</span><a href="#local-6989586621684536276"><span class="hs-identifier hs-var hs-var">regTileSliceDim</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684536275"><span class="annot"><span class="annottext">TExp t
</span><a href="#local-6989586621684536275"><span class="hs-identifier hs-var">group_tile</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684536274"><span class="annot"><span class="annottext">TExp t
</span><a href="#local-6989586621684536274"><span class="hs-identifier hs-var">group_tile_i</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684536273"><span class="annot"><span class="annottext">TExp t
</span><a href="#local-6989586621684536273"><span class="hs-identifier hs-var">reg_tile</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684536272"><span class="annot"><span class="annottext">TExp t
</span><a href="#local-6989586621684536272"><span class="hs-identifier hs-var">reg_tile_i</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1729"></span><span>        </span><span id="local-6989586621684536271"><span class="annot"><span class="annottext">TExp t
</span><a href="#local-6989586621684536271"><span class="hs-identifier hs-var">tile_dim_start</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1730"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; TExp t -&gt; ImpM rep r op (TExp t)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TExp t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimVE"><span class="hs-identifier hs-var">dPrimVE</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;tile_dim_start&quot;</span></span><span> </span><span class="annot"><span class="annottext">(TExp t -&gt; ImpM rep r op (TExp t))
-&gt; TExp t -&gt; ImpM rep r op (TExp t)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1731"></span><span>            </span><span class="annot"><span class="annottext">TExp t
</span><a href="#local-6989586621684536273"><span class="hs-identifier hs-var">reg_tile</span></a></span><span> </span><span class="annot"><span class="annottext">TExp t -&gt; TExp t -&gt; TExp t
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp t
</span><a href="#local-6989586621684536275"><span class="hs-identifier hs-var">group_tile</span></a></span><span> </span><span class="annot"><span class="annottext">TExp t -&gt; TExp t -&gt; TExp t
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TExp t
</span><a href="#local-6989586621684536274"><span class="hs-identifier hs-var">group_tile_i</span></a></span><span> </span><span class="annot"><span class="annottext">TExp t -&gt; TExp t -&gt; TExp t
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TExp t
</span><a href="#local-6989586621684536272"><span class="hs-identifier hs-var">reg_tile_i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1732"></span><span>        </span><span class="annot"><span class="annottext">DimIndex (TExp t) -&gt; ImpM rep r op (DimIndex (TExp t))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(DimIndex (TExp t) -&gt; ImpM rep r op (DimIndex (TExp t)))
-&gt; DimIndex (TExp t) -&gt; ImpM rep r op (DimIndex (TExp t))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp t -&gt; TExp t -&gt; TExp t -&gt; DimIndex (TExp t)
forall d. d -&gt; d -&gt; d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimSlice"><span class="hs-identifier hs-var">DimSlice</span></a></span><span> </span><span class="annot"><span class="annottext">TExp t
</span><a href="#local-6989586621684536271"><span class="hs-identifier hs-var">tile_dim_start</span></a></span><span> </span><span class="annot"><span class="annottext">TExp t
</span><a href="#local-6989586621684536273"><span class="hs-identifier hs-var">reg_tile</span></a></span><span> </span><span class="annot"><span class="annottext">TExp t
</span><span class="hs-number">1</span></span><span>
</span><span id="line-1733"></span><span>  </span><span id="local-6989586621684536270"><span class="annot"><span class="annottext">Slice (TExp Int64)
</span><a href="#local-6989586621684536270"><span class="hs-identifier hs-var">reg_tile_slices</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1734"></span><span>    </span><span class="annot"><span class="annottext">[DimIndex (TExp Int64)] -&gt; Slice (TExp Int64)
forall d. [DimIndex d] -&gt; Slice d
</span><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-var">Slice</span></a></span><span>
</span><span id="line-1735"></span><span>      </span><span class="annot"><span class="annottext">([DimIndex (TExp Int64)] -&gt; Slice (TExp Int64))
-&gt; ImpM GPUMem KernelEnv KernelOp [DimIndex (TExp Int64)]
-&gt; ImpM GPUMem KernelEnv KernelOp (Slice (TExp Int64))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">((TExp Int64, TExp Int64)
 -&gt; (TExp Int64, TExp Int64)
 -&gt; ImpM GPUMem KernelEnv KernelOp (DimIndex (TExp Int64)))
-&gt; [(TExp Int64, TExp Int64)]
-&gt; [(TExp Int64, TExp Int64)]
-&gt; ImpM GPUMem KernelEnv KernelOp [DimIndex (TExp Int64)]
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m [c]
</span><span class="hs-identifier hs-var">zipWithM</span></span><span>
</span><span id="line-1736"></span><span>        </span><span class="annot"><span class="annottext">(TExp Int64, TExp Int64)
-&gt; (TExp Int64, TExp Int64)
-&gt; ImpM GPUMem KernelEnv KernelOp (DimIndex (TExp Int64))
forall {t} {rep} {r} {op}.
NumExp t =&gt;
(TExp t, TExp t)
-&gt; (TExp t, TExp t) -&gt; ImpM rep r op (DimIndex (TExp t))
</span><a href="#local-6989586621684536276"><span class="hs-identifier hs-var">regTileSliceDim</span></a></span><span>
</span><span id="line-1737"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TExp Int64] -&gt; [TExp Int64] -&gt; [(TExp Int64, TExp Int64)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536289"><span class="hs-identifier hs-var">group_tiles'</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536287"><span class="hs-identifier hs-var">group_tile_is</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1738"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TExp Int64] -&gt; [TExp Int64] -&gt; [(TExp Int64, TExp Int64)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536288"><span class="hs-identifier hs-var">reg_tiles'</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536286"><span class="hs-identifier hs-var">reg_tile_is</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1739"></span><span>
</span><span id="line-1740"></span><span>  </span><span class="annot"><span class="annottext">Operations GPUMem KernelEnv KernelOp
-&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op a.
Operations rep r op -&gt; ImpM rep r op a -&gt; ImpM rep r op a
</span><a href="Futhark.CodeGen.ImpGen.html#localOps"><span class="hs-identifier hs-var">localOps</span></a></span><span> </span><span class="annot"><span class="annottext">Operations GPUMem KernelEnv KernelOp
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#threadOperations"><span class="hs-identifier hs-var">threadOperations</span></a></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1741"></span><span>    </span><span class="annot"><span class="annottext">Shape -&gt; ([TExp Int64] -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall rep r op.
Shape -&gt; ([TExp Int64] -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sLoopNest"><span class="hs-identifier hs-var">sLoopNest</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Shape
forall d. [d] -&gt; ShapeBase d
</span><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-var">Shape</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684536291"><span class="hs-identifier hs-var">reg_tiles</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(([TExp Int64] -&gt; InKernelGen ()) -&gt; InKernelGen ())
-&gt; ([TExp Int64] -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684536268"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536268"><span class="hs-identifier hs-var">is_in_reg_tile</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1742"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684536267"><span class="annot"><span class="annottext">dest_is :: [TExp Int64]
</span><a href="#local-6989586621684536267"><span class="hs-identifier hs-var hs-var">dest_is</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Slice (TExp Int64) -&gt; [TExp Int64] -&gt; [TExp Int64]
forall d. Num d =&gt; Slice d -&gt; [d] -&gt; [d]
</span><a href="Futhark.IR.Syntax.Core.html#fixSlice"><span class="hs-identifier hs-var">fixSlice</span></a></span><span> </span><span class="annot"><span class="annottext">Slice (TExp Int64)
</span><a href="#local-6989586621684536270"><span class="hs-identifier hs-var">reg_tile_slices</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536268"><span class="hs-identifier hs-var">is_in_reg_tile</span></a></span><span>
</span><span id="line-1743"></span><span>          </span><span id="local-6989586621684536265"><span class="annot"><span class="annottext">src_is :: [TExp Int64]
</span><a href="#local-6989586621684536265"><span class="hs-identifier hs-var hs-var">src_is</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536286"><span class="hs-identifier hs-var">reg_tile_is</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; [TExp Int64] -&gt; [TExp Int64]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536268"><span class="hs-identifier hs-var">is_in_reg_tile</span></a></span><span>
</span><span id="line-1744"></span><span>      </span><span class="annot"><span class="annottext">TExp Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TExp Bool -&gt; TExp Bool -&gt; TExp Bool) -&gt; [TExp Bool] -&gt; TExp Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; a -&gt; a) -&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">foldl1</span></span><span> </span><span class="annot"><span class="annottext">TExp Bool -&gt; TExp Bool -&gt; TExp Bool
forall v. TPrimExp Bool v -&gt; TPrimExp Bool v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%26%26."><span class="hs-operator hs-var">(.&amp;&amp;.)</span></a></span><span> </span><span class="annot"><span class="annottext">([TExp Bool] -&gt; TExp Bool) -&gt; [TExp Bool] -&gt; TExp Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; TExp Int64 -&gt; TExp Bool)
-&gt; [TExp Int64] -&gt; [TExp Int64] -&gt; [TExp Bool]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Bool
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3C."><span class="hs-operator hs-var">(.&lt;.)</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536267"><span class="hs-identifier hs-var">dest_is</span></a></span><span> </span><span class="annot"><span class="annottext">([TExp Int64] -&gt; [TExp Bool]) -&gt; [TExp Int64] -&gt; [TExp Bool]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684536293"><span class="hs-identifier hs-var">dims</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1745"></span><span>        </span><span class="annot"><span class="annottext">VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; InKernelGen ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
PatElemT LParamMem
</span><a href="#local-6989586621684536299"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536267"><span class="hs-identifier hs-var">dest_is</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536296"><span class="hs-identifier hs-var">what</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536265"><span class="hs-identifier hs-var">src_is</span></a></span><span>
</span><span id="line-1746"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileGroupResult"><span class="hs-identifier hs-var">compileGroupResult</span></a></span><span> </span><span id="local-6989586621684536263"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684536263"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684536262"><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
</span><a href="#local-6989586621684536262"><span class="hs-identifier hs-var">pe</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#Returns"><span class="hs-identifier hs-type">Returns</span></a></span><span> </span><span class="annot"><span class="annottext">ResultManifest
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Certs
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684536260"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684536260"><span class="hs-identifier hs-var">what</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1747"></span><span>  </span><span id="local-6989586621684536259"><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684536259"><span class="hs-identifier hs-var">constants</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">KernelEnv -&gt; KernelConstants
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelConstants"><span class="hs-identifier hs-var hs-var">kernelConstants</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelEnv -&gt; KernelConstants)
-&gt; ImpM GPUMem KernelEnv KernelOp KernelEnv
-&gt; ImpM GPUMem KernelEnv KernelOp KernelConstants
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ImpM GPUMem KernelEnv KernelOp KernelEnv
forall rep r op. ImpM rep r op r
</span><a href="Futhark.CodeGen.ImpGen.html#askEnv"><span class="hs-identifier hs-var">askEnv</span></a></span><span>
</span><span id="line-1748"></span><span>  </span><span id="local-6989586621684536258"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684536258"><span class="hs-identifier hs-var">in_local_memory</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; InKernelGen Bool
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#arrayInLocalMemory"><span class="hs-identifier hs-var">arrayInLocalMemory</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684536260"><span class="hs-identifier hs-var">what</span></a></span><span>
</span><span id="line-1749"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684536256"><span class="annot"><span class="annottext">gids :: [TExp Int64]
</span><a href="#local-6989586621684536256"><span class="hs-identifier hs-var hs-var">gids</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((VName, SubExp) -&gt; TExp Int64)
-&gt; [(VName, SubExp)] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; TExp Int64
forall a. a -&gt; TPrimExp Int64 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le64"><span class="hs-identifier hs-var">Imp.le64</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; TExp Int64)
-&gt; ((VName, SubExp) -&gt; VName) -&gt; (VName, SubExp) -&gt; TExp Int64
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(VName, SubExp) -&gt; VName
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(VName, SubExp)] -&gt; [TExp Int64])
-&gt; [(VName, SubExp)] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; [(VName, SubExp)]
</span><a href="Futhark.IR.SegOp.html#unSegSpace"><span class="hs-identifier hs-var hs-var">unSegSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684536263"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-1750"></span><span>
</span><span id="line-1751"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684536258"><span class="hs-identifier hs-var">in_local_memory</span></a></span><span>
</span><span id="line-1752"></span><span>    </span><span class="hs-keyword">then</span><span>
</span><span id="line-1753"></span><span>      </span><span class="annot"><span class="annottext">Operations GPUMem KernelEnv KernelOp
-&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op a.
Operations rep r op -&gt; ImpM rep r op a -&gt; ImpM rep r op a
</span><a href="Futhark.CodeGen.ImpGen.html#localOps"><span class="hs-identifier hs-var">localOps</span></a></span><span> </span><span class="annot"><span class="annottext">Operations GPUMem KernelEnv KernelOp
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#threadOperations"><span class="hs-identifier hs-var">threadOperations</span></a></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1754"></span><span>        </span><span class="annot"><span class="annottext">TExp Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelLocalThreadId"><span class="hs-identifier hs-var hs-var">kernelLocalThreadId</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684536259"><span class="hs-identifier hs-var">constants</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3D%3D."><span class="hs-operator hs-var">.==.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1755"></span><span>          </span><span class="annot"><span class="annottext">VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; InKernelGen ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
PatElemT LParamMem
</span><a href="#local-6989586621684536262"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536256"><span class="hs-identifier hs-var">gids</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684536260"><span class="hs-identifier hs-var">what</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1756"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-comment">-- If the result of the group is an array in local memory, we</span><span>
</span><span id="line-1757"></span><span>    </span><span class="hs-comment">-- store it by collective copying among all the threads of the</span><span>
</span><span id="line-1758"></span><span>    </span><span class="hs-comment">-- group.  TODO: also do this if the array is in global memory</span><span>
</span><span id="line-1759"></span><span>    </span><span class="hs-comment">-- (but this is a bit more tricky, synchronisation-wise).</span><span>
</span><span id="line-1760"></span><span>      </span><span class="annot"><span class="annottext">VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; InKernelGen ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
PatElemT LParamMem
</span><a href="#local-6989586621684536262"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536256"><span class="hs-identifier hs-var">gids</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684536260"><span class="hs-identifier hs-var">what</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1761"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileGroupResult"><span class="hs-identifier hs-var">compileGroupResult</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><a href="Futhark.IR.SegOp.html#WriteReturns"><span class="hs-identifier hs-type">WriteReturns</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1762"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; InKernelGen ()
forall a. String -&gt; a
</span><a href="Futhark.Error.html#compilerLimitationS"><span class="hs-identifier hs-var">compilerLimitationS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;compileGroupResult: WriteReturns not handled yet.&quot;</span></span><span>
</span><span id="line-1763"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileGroupResult"><span class="hs-identifier hs-var">compileGroupResult</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><a href="Futhark.IR.SegOp.html#ConcatReturns"><span class="hs-identifier hs-type">ConcatReturns</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1764"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; InKernelGen ()
forall a. String -&gt; a
</span><a href="Futhark.Error.html#compilerLimitationS"><span class="hs-identifier hs-var">compilerLimitationS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;compileGroupResult: ConcatReturns not handled yet.&quot;</span></span><span>
</span><span id="line-1765"></span><span>
</span><span id="line-1766"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileThreadResult"><span class="hs-identifier hs-type">compileThreadResult</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1767"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegSpace"><span class="hs-identifier hs-type">SegSpace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1768"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#PatElem"><span class="hs-identifier hs-type">PatElem</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1769"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#KernelResult"><span class="hs-identifier hs-type">KernelResult</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1770"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#InKernelGen"><span class="hs-identifier hs-type">InKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1771"></span><span id="compileThreadResult"><span class="annot"><span class="annottext">compileThreadResult :: SegSpace
-&gt; PatElemT (LetDec GPUMem) -&gt; KernelResult -&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileThreadResult"><span class="hs-identifier hs-var hs-var">compileThreadResult</span></a></span></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><a href="Futhark.IR.SegOp.html#RegTileReturns"><span class="hs-identifier hs-type">RegTileReturns</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1772"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; InKernelGen ()
forall a. String -&gt; a
</span><a href="Futhark.Error.html#compilerLimitationS"><span class="hs-identifier hs-var">compilerLimitationS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;compileThreadResult: RegTileReturns not yet handled.&quot;</span></span><span>
</span><span id="line-1773"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileThreadResult"><span class="hs-identifier hs-var">compileThreadResult</span></a></span><span> </span><span id="local-6989586621684536253"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684536253"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684536252"><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
</span><a href="#local-6989586621684536252"><span class="hs-identifier hs-var">pe</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#Returns"><span class="hs-identifier hs-type">Returns</span></a></span><span> </span><span class="annot"><span class="annottext">ResultManifest
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Certs
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684536251"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684536251"><span class="hs-identifier hs-var">what</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1774"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684536250"><span class="annot"><span class="annottext">is :: [TExp Int64]
</span><a href="#local-6989586621684536250"><span class="hs-identifier hs-var hs-var">is</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((VName, SubExp) -&gt; TExp Int64)
-&gt; [(VName, SubExp)] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; TExp Int64
forall a. a -&gt; TPrimExp Int64 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le64"><span class="hs-identifier hs-var">Imp.le64</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; TExp Int64)
-&gt; ((VName, SubExp) -&gt; VName) -&gt; (VName, SubExp) -&gt; TExp Int64
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(VName, SubExp) -&gt; VName
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(VName, SubExp)] -&gt; [TExp Int64])
-&gt; [(VName, SubExp)] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; [(VName, SubExp)]
</span><a href="Futhark.IR.SegOp.html#unSegSpace"><span class="hs-identifier hs-var hs-var">unSegSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684536253"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-1775"></span><span>  </span><span class="annot"><span class="annottext">VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; InKernelGen ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
PatElemT LParamMem
</span><a href="#local-6989586621684536252"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536250"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684536251"><span class="hs-identifier hs-var">what</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1776"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileThreadResult"><span class="hs-identifier hs-var">compileThreadResult</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684536249"><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
</span><a href="#local-6989586621684536249"><span class="hs-identifier hs-var">pe</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#ConcatReturns"><span class="hs-identifier hs-type">ConcatReturns</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SplitOrdering
</span><a href="Futhark.IR.SegOp.html#SplitContiguous"><span class="hs-identifier hs-var">SplitContiguous</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684536248"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684536248"><span class="hs-identifier hs-var">per_thread_elems</span></a></span></span><span> </span><span id="local-6989586621684536247"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536247"><span class="hs-identifier hs-var">what</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1777"></span><span>  </span><span id="local-6989586621684536246"><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684536246"><span class="hs-identifier hs-var">constants</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">KernelEnv -&gt; KernelConstants
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelConstants"><span class="hs-identifier hs-var hs-var">kernelConstants</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelEnv -&gt; KernelConstants)
-&gt; ImpM GPUMem KernelEnv KernelOp KernelEnv
-&gt; ImpM GPUMem KernelEnv KernelOp KernelConstants
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ImpM GPUMem KernelEnv KernelOp KernelEnv
forall rep r op. ImpM rep r op r
</span><a href="Futhark.CodeGen.ImpGen.html#askEnv"><span class="hs-identifier hs-var">askEnv</span></a></span><span>
</span><span id="line-1778"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684536245"><span class="annot"><span class="annottext">offset :: TExp Int64
</span><a href="#local-6989586621684536245"><span class="hs-identifier hs-var hs-var">offset</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1779"></span><span>        </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684536248"><span class="hs-identifier hs-var">per_thread_elems</span></a></span><span>
</span><span id="line-1780"></span><span>          </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int64
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelGlobalThreadId"><span class="hs-identifier hs-var hs-var">kernelGlobalThreadId</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684536246"><span class="hs-identifier hs-var">constants</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1781"></span><span>  </span><span id="local-6989586621684536244"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536244"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64)
-&gt; (TypeBase Shape NoUniqueness -&gt; SubExp)
-&gt; TypeBase Shape NoUniqueness
-&gt; TExp Int64
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; TypeBase Shape NoUniqueness -&gt; SubExp
forall u. Int -&gt; TypeBase Shape u -&gt; SubExp
</span><a href="Futhark.IR.Prop.Types.html#arraySize"><span class="hs-identifier hs-var">arraySize</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">(TypeBase Shape NoUniqueness -&gt; TExp Int64)
-&gt; ImpM GPUMem KernelEnv KernelOp (TypeBase Shape NoUniqueness)
-&gt; ImpM GPUMem KernelEnv KernelOp (TExp Int64)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">VName
-&gt; ImpM GPUMem KernelEnv KernelOp (TypeBase Shape NoUniqueness)
forall rep (m :: * -&gt; *).
HasScope rep m =&gt;
VName -&gt; m (TypeBase Shape NoUniqueness)
</span><a href="Futhark.IR.Prop.Scope.html#lookupType"><span class="hs-identifier hs-var">lookupType</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536247"><span class="hs-identifier hs-var">what</span></a></span><span>
</span><span id="line-1782"></span><span>  </span><span class="annot"><span class="annottext">VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; InKernelGen ()
forall rep r op.
VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-var">copyDWIM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
PatElemT LParamMem
</span><a href="#local-6989586621684536249"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64 -&gt; DimIndex (TExp Int64)
forall d. d -&gt; d -&gt; d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimSlice"><span class="hs-identifier hs-var">DimSlice</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536245"><span class="hs-identifier hs-var">offset</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536244"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536247"><span class="hs-identifier hs-var">what</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1783"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileThreadResult"><span class="hs-identifier hs-var">compileThreadResult</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684536243"><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
</span><a href="#local-6989586621684536243"><span class="hs-identifier hs-var">pe</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#ConcatReturns"><span class="hs-identifier hs-type">ConcatReturns</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#SplitStrided"><span class="hs-identifier hs-type">SplitStrided</span></a></span><span> </span><span id="local-6989586621684536242"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684536242"><span class="hs-identifier hs-var">stride</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684536241"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536241"><span class="hs-identifier hs-var">what</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1784"></span><span>  </span><span id="local-6989586621684536240"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536240"><span class="hs-identifier hs-var">offset</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int64
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int32 -&gt; TExp Int64)
-&gt; (KernelEnv -&gt; TExp Int32) -&gt; KernelEnv -&gt; TExp Int64
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelGlobalThreadId"><span class="hs-identifier hs-var hs-var">kernelGlobalThreadId</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelConstants -&gt; TExp Int32)
-&gt; (KernelEnv -&gt; KernelConstants) -&gt; KernelEnv -&gt; TExp Int32
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">KernelEnv -&gt; KernelConstants
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelConstants"><span class="hs-identifier hs-var hs-var">kernelConstants</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelEnv -&gt; TExp Int64)
-&gt; ImpM GPUMem KernelEnv KernelOp KernelEnv
-&gt; ImpM GPUMem KernelEnv KernelOp (TExp Int64)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ImpM GPUMem KernelEnv KernelOp KernelEnv
forall rep r op. ImpM rep r op r
</span><a href="Futhark.CodeGen.ImpGen.html#askEnv"><span class="hs-identifier hs-var">askEnv</span></a></span><span>
</span><span id="line-1785"></span><span>  </span><span id="local-6989586621684536239"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536239"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64)
-&gt; (TypeBase Shape NoUniqueness -&gt; SubExp)
-&gt; TypeBase Shape NoUniqueness
-&gt; TExp Int64
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; TypeBase Shape NoUniqueness -&gt; SubExp
forall u. Int -&gt; TypeBase Shape u -&gt; SubExp
</span><a href="Futhark.IR.Prop.Types.html#arraySize"><span class="hs-identifier hs-var">arraySize</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">(TypeBase Shape NoUniqueness -&gt; TExp Int64)
-&gt; ImpM GPUMem KernelEnv KernelOp (TypeBase Shape NoUniqueness)
-&gt; ImpM GPUMem KernelEnv KernelOp (TExp Int64)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">VName
-&gt; ImpM GPUMem KernelEnv KernelOp (TypeBase Shape NoUniqueness)
forall rep (m :: * -&gt; *).
HasScope rep m =&gt;
VName -&gt; m (TypeBase Shape NoUniqueness)
</span><a href="Futhark.IR.Prop.Scope.html#lookupType"><span class="hs-identifier hs-var">lookupType</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536241"><span class="hs-identifier hs-var">what</span></a></span><span>
</span><span id="line-1786"></span><span>  </span><span class="annot"><span class="annottext">VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; InKernelGen ()
forall rep r op.
VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-var">copyDWIM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
PatElemT LParamMem
</span><a href="#local-6989586621684536243"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64 -&gt; DimIndex (TExp Int64)
forall d. d -&gt; d -&gt; d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimSlice"><span class="hs-identifier hs-var">DimSlice</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536240"><span class="hs-identifier hs-var">offset</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684536239"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; DimIndex (TExp Int64))
-&gt; TExp Int64 -&gt; DimIndex (TExp Int64)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684536242"><span class="hs-identifier hs-var">stride</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536241"><span class="hs-identifier hs-var">what</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1787"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileThreadResult"><span class="hs-identifier hs-var">compileThreadResult</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684536238"><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
</span><a href="#local-6989586621684536238"><span class="hs-identifier hs-var">pe</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#WriteReturns"><span class="hs-identifier hs-type">WriteReturns</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-type">Shape</span></a></span><span> </span><span id="local-6989586621684536237"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684536237"><span class="hs-identifier hs-var">rws</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684536236"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536236"><span class="hs-identifier hs-var">_arr</span></a></span></span><span> </span><span id="local-6989586621684536235"><span class="annot"><span class="annottext">[(Slice SubExp, SubExp)]
</span><a href="#local-6989586621684536235"><span class="hs-identifier hs-var">dests</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1788"></span><span>  </span><span id="local-6989586621684536234"><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684536234"><span class="hs-identifier hs-var">constants</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">KernelEnv -&gt; KernelConstants
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelConstants"><span class="hs-identifier hs-var hs-var">kernelConstants</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelEnv -&gt; KernelConstants)
-&gt; ImpM GPUMem KernelEnv KernelOp KernelEnv
-&gt; ImpM GPUMem KernelEnv KernelOp KernelConstants
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ImpM GPUMem KernelEnv KernelOp KernelEnv
forall rep r op. ImpM rep r op r
</span><a href="Futhark.CodeGen.ImpGen.html#askEnv"><span class="hs-identifier hs-var">askEnv</span></a></span><span>
</span><span id="line-1789"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684536233"><span class="annot"><span class="annottext">rws' :: [TExp Int64]
</span><a href="#local-6989586621684536233"><span class="hs-identifier hs-var hs-var">rws'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684536237"><span class="hs-identifier hs-var">rws</span></a></span><span>
</span><span id="line-1790"></span><span>  </span><span class="annot"><span class="annottext">[(Slice SubExp, SubExp)]
-&gt; ((Slice SubExp, SubExp) -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="annot"><span class="annottext">[(Slice SubExp, SubExp)]
</span><a href="#local-6989586621684536235"><span class="hs-identifier hs-var">dests</span></a></span><span> </span><span class="annot"><span class="annottext">(((Slice SubExp, SubExp) -&gt; InKernelGen ()) -&gt; InKernelGen ())
-&gt; ((Slice SubExp, SubExp) -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684536232"><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684536232"><span class="hs-identifier hs-var">slice</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684536231"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684536231"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1791"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684536230"><span class="annot"><span class="annottext">slice' :: Slice (TExp Int64)
</span><a href="#local-6989586621684536230"><span class="hs-identifier hs-var hs-var">slice'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64) -&gt; Slice SubExp -&gt; Slice (TExp Int64)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684536232"><span class="hs-identifier hs-var">slice</span></a></span><span>
</span><span id="line-1792"></span><span>        </span><span id="local-6989586621684536229"><span class="annot"><span class="annottext">write :: TExp Bool
</span><a href="#local-6989586621684536229"><span class="hs-identifier hs-var hs-var">write</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Bool
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelThreadActive"><span class="hs-identifier hs-var hs-var">kernelThreadActive</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684536234"><span class="hs-identifier hs-var">constants</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool -&gt; TExp Bool -&gt; TExp Bool
forall v. TPrimExp Bool v -&gt; TPrimExp Bool v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%26%26."><span class="hs-operator hs-var">.&amp;&amp;.</span></a></span><span> </span><span class="annot"><span class="annottext">Slice (TExp Int64) -&gt; [TExp Int64] -&gt; TExp Bool
</span><a href="Futhark.CodeGen.ImpGen.html#inBounds"><span class="hs-identifier hs-var">inBounds</span></a></span><span> </span><span class="annot"><span class="annottext">Slice (TExp Int64)
</span><a href="#local-6989586621684536230"><span class="hs-identifier hs-var">slice'</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684536233"><span class="hs-identifier hs-var">rws'</span></a></span><span>
</span><span id="line-1793"></span><span>    </span><span class="annot"><span class="annottext">TExp Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684536229"><span class="hs-identifier hs-var">write</span></a></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; InKernelGen ()
forall rep r op.
VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-var">copyDWIM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
PatElemT LParamMem
</span><a href="#local-6989586621684536238"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Slice (TExp Int64) -&gt; [DimIndex (TExp Int64)]
forall d. Slice d -&gt; [DimIndex d]
</span><a href="Futhark.IR.Syntax.Core.html#unSlice"><span class="hs-identifier hs-var hs-var">unSlice</span></a></span><span> </span><span class="annot"><span class="annottext">Slice (TExp Int64)
</span><a href="#local-6989586621684536230"><span class="hs-identifier hs-var">slice'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684536231"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1794"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileThreadResult"><span class="hs-identifier hs-var">compileThreadResult</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><a href="Futhark.IR.SegOp.html#TileReturns"><span class="hs-identifier hs-type">TileReturns</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1795"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; InKernelGen ()
forall a. String -&gt; a
</span><a href="Futhark.Error.html#compilerBugS"><span class="hs-identifier hs-var">compilerBugS</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;compileThreadResult: TileReturns unhandled.&quot;</span></span><span>
</span><span id="line-1796"></span><span>
</span><span id="line-1797"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#arrayInLocalMemory"><span class="hs-identifier hs-type">arrayInLocalMemory</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#InKernelGen"><span class="hs-identifier hs-type">InKernelGen</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1798"></span><span id="arrayInLocalMemory"><span class="annot"><span class="annottext">arrayInLocalMemory :: SubExp -&gt; InKernelGen Bool
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#arrayInLocalMemory"><span class="hs-identifier hs-var hs-var">arrayInLocalMemory</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684536228"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536228"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1799"></span><span>  </span><span id="local-6989586621684536227"><span class="annot"><span class="annottext">VarEntry GPUMem
</span><a href="#local-6989586621684536227"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; ImpM GPUMem KernelEnv KernelOp (VarEntry GPUMem)
forall rep r op. VName -&gt; ImpM rep r op (VarEntry rep)
</span><a href="Futhark.CodeGen.ImpGen.html#lookupVar"><span class="hs-identifier hs-var">lookupVar</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684536228"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-1800"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">VarEntry GPUMem
</span><a href="#local-6989586621684536227"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1801"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ArrayVar"><span class="hs-identifier hs-type">ArrayVar</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp GPUMem)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684536225"><span class="annot"><span class="annottext">ArrayEntry
</span><a href="#local-6989586621684536225"><span class="hs-identifier hs-var">entry</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1802"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Space
</span><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-var">Space</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;local&quot;</span></span><span> </span><span class="annot"><span class="annottext">Space -&gt; Space -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Space -&gt; Bool) -&gt; (MemEntry -&gt; Space) -&gt; MemEntry -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">MemEntry -&gt; Space
</span><a href="Futhark.CodeGen.ImpGen.html#entryMemSpace"><span class="hs-identifier hs-var hs-var">entryMemSpace</span></a></span><span>
</span><span id="line-1803"></span><span>        </span><span class="annot"><span class="annottext">(MemEntry -&gt; Bool)
-&gt; ImpM GPUMem KernelEnv KernelOp MemEntry -&gt; InKernelGen Bool
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; ImpM GPUMem KernelEnv KernelOp MemEntry
forall rep r op. VName -&gt; ImpM rep r op MemEntry
</span><a href="Futhark.CodeGen.ImpGen.html#lookupMemory"><span class="hs-identifier hs-var">lookupMemory</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MemLoc -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#memLocName"><span class="hs-identifier hs-var hs-var">memLocName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ArrayEntry -&gt; MemLoc
</span><a href="Futhark.CodeGen.ImpGen.html#entryArrayLoc"><span class="hs-identifier hs-var hs-var">entryArrayLoc</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayEntry
</span><a href="#local-6989586621684536225"><span class="hs-identifier hs-var">entry</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1804"></span><span>    </span><span class="annot"><span class="annottext">VarEntry GPUMem
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; InKernelGen Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1805"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#arrayInLocalMemory"><span class="hs-identifier hs-var">arrayInLocalMemory</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; InKernelGen Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1806"></span></pre></body></html>