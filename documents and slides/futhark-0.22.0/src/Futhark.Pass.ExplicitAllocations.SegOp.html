<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE FlexibleInstances #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# OPTIONS_GHC -fno-warn-orphans #-}</span><span>
</span><span id="line-5"></span><span>
</span><span id="line-6"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Futhark.Pass.ExplicitAllocations.SegOp</span><span>
</span><span id="line-7"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.SegOp.html#allocInKernelBody"><span class="hs-identifier">allocInKernelBody</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-8"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.SegOp.html#allocInBinOpLambda"><span class="hs-identifier">allocInBinOpLambda</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-9"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-10"></span><span class="hs-keyword">where</span><span>
</span><span id="line-11"></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html"><span class="hs-identifier">Futhark.IR.GPUMem</span></a></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html"><span class="hs-identifier">Futhark.IR.Mem.IxFun</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">IxFun</span></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html"><span class="hs-identifier">Futhark.Pass.ExplicitAllocations</span></a></span><span>
</span><span id="line-15"></span><span>
</span><span id="line-16"></span><span id="local-6989586621684440440"><span id="local-6989586621684440441"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621684440245"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#SizeSubst"><span class="hs-identifier hs-type">SizeSubst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#SegOp"><span class="hs-identifier hs-type">SegOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684440441"><span class="hs-identifier hs-type">lvl</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684440440"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-17"></span><span>  </span><span id="local-6989586621684440239"><span class="annot"><span class="annottext">opSizeSubst :: forall dec. PatT dec -&gt; SegOp lvl rep -&gt; ChunkMap
</span><a href="Futhark.Pass.ExplicitAllocations.html#opSizeSubst"><span class="hs-identifier hs-var hs-var hs-var hs-var">opSizeSubst</span></a></span></span><span> </span><span class="annot"><span class="annottext">PatT dec
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SegOp lvl rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChunkMap
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span></span></span><span>
</span><span id="line-18"></span><span>
</span><span id="line-19"></span><span id="local-6989586621684440431"><span id="local-6989586621684440432"><span id="local-6989586621684440433"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.SegOp.html#allocInKernelBody"><span class="hs-identifier hs-type">allocInKernelBody</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-20"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#Allocable"><span class="hs-identifier hs-type">Allocable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684440433"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684440432"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684440431"><span class="hs-identifier hs-type">inner</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-21"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-type">KernelBody</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684440433"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-22"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocM"><span class="hs-identifier hs-type">AllocM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684440433"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684440432"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-type">KernelBody</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684440432"><span class="hs-identifier hs-type">torep</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-23"></span><span id="allocInKernelBody"><span class="annot"><span class="annottext">allocInKernelBody :: forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
KernelBody fromrep -&gt; AllocM fromrep torep (KernelBody torep)
</span><a href="Futhark.Pass.ExplicitAllocations.SegOp.html#allocInKernelBody"><span class="hs-identifier hs-var hs-var">allocInKernelBody</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-type">KernelBody</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span id="local-6989586621684440126"><span class="annot"><span class="annottext">Stms fromrep
</span><a href="#local-6989586621684440126"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span id="local-6989586621684440125"><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684440125"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-24"></span><span>  </span><span class="annot"><span class="annottext">([KernelResult] -&gt; Stms torep -&gt; KernelBody torep)
-&gt; ([KernelResult], Stms torep) -&gt; KernelBody torep
forall a b c. (a -&gt; b -&gt; c) -&gt; (a, b) -&gt; c
</span><span class="hs-identifier hs-var">uncurry</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Stms torep -&gt; [KernelResult] -&gt; KernelBody torep)
-&gt; [KernelResult] -&gt; Stms torep -&gt; KernelBody torep
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BodyDec torep -&gt; Stms torep -&gt; [KernelResult] -&gt; KernelBody torep
forall rep.
BodyDec rep -&gt; Stms rep -&gt; [KernelResult] -&gt; KernelBody rep
</span><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-var">KernelBody</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span>    </span><span class="annot"><span class="annottext">(([KernelResult], Stms torep) -&gt; KernelBody torep)
-&gt; AllocM fromrep torep ([KernelResult], Stms torep)
-&gt; AllocM fromrep torep (KernelBody torep)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">AllocM fromrep torep [KernelResult]
-&gt; AllocM
     fromrep torep ([KernelResult], Stms (Rep (AllocM fromrep torep)))
forall (m :: * -&gt; *) a.
MonadBuilder m =&gt;
m a -&gt; m (a, Stms (Rep m))
</span><a href="Futhark.Builder.Class.html#collectStms"><span class="hs-identifier hs-var">collectStms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms fromrep
-&gt; AllocM fromrep torep [KernelResult]
-&gt; AllocM fromrep torep [KernelResult]
forall fromrep torep inner a.
Allocable fromrep torep inner =&gt;
Stms fromrep -&gt; AllocM fromrep torep a -&gt; AllocM fromrep torep a
</span><a href="Futhark.Pass.ExplicitAllocations.html#allocInStms"><span class="hs-identifier hs-var">allocInStms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms fromrep
</span><a href="#local-6989586621684440126"><span class="hs-identifier hs-var">stms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[KernelResult] -&gt; AllocM fromrep torep [KernelResult]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684440125"><span class="hs-identifier hs-var">res</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span>
</span><span id="line-27"></span><span id="local-6989586621684440351"><span id="local-6989586621684440352"><span id="local-6989586621684440353"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.SegOp.html#allocInLambda"><span class="hs-identifier hs-type">allocInLambda</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-28"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#Allocable"><span class="hs-identifier hs-type">Allocable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684440353"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684440352"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684440351"><span class="hs-identifier hs-type">inner</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-29"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#LParam"><span class="hs-identifier hs-type">LParam</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684440352"><span class="hs-identifier hs-type">torep</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-30"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684440353"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-31"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocM"><span class="hs-identifier hs-type">AllocM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684440353"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684440352"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684440352"><span class="hs-identifier hs-type">torep</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-32"></span><span id="allocInLambda"><span class="annot"><span class="annottext">allocInLambda :: forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
[LParam torep]
-&gt; Body fromrep -&gt; AllocM fromrep torep (Lambda torep)
</span><a href="Futhark.Pass.ExplicitAllocations.SegOp.html#allocInLambda"><span class="hs-identifier hs-var hs-var">allocInLambda</span></a></span></span><span> </span><span id="local-6989586621684440033"><span class="annot"><span class="annottext">[LParam torep]
</span><a href="#local-6989586621684440033"><span class="hs-identifier hs-var">params</span></a></span></span><span> </span><span id="local-6989586621684440032"><span class="annot"><span class="annottext">Body fromrep
</span><a href="#local-6989586621684440032"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-33"></span><span>  </span><span class="annot"><span class="annottext">[LParam (Rep (AllocM fromrep torep))]
-&gt; AllocM fromrep torep Result
-&gt; AllocM fromrep torep (Lambda (Rep (AllocM fromrep torep)))
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[LParam (Rep m)] -&gt; m Result -&gt; m (Lambda (Rep m))
</span><a href="Futhark.Construct.html#mkLambda"><span class="hs-identifier hs-var">mkLambda</span></a></span><span> </span><span class="annot"><span class="annottext">[LParam torep]
[LParam (Rep (AllocM fromrep torep))]
</span><a href="#local-6989586621684440033"><span class="hs-identifier hs-var">params</span></a></span><span> </span><span class="annot"><span class="annottext">(AllocM fromrep torep Result
 -&gt; AllocM fromrep torep (LambdaT torep))
-&gt; (AllocM fromrep torep Result -&gt; AllocM fromrep torep Result)
-&gt; AllocM fromrep torep Result
-&gt; AllocM fromrep torep (LambdaT torep)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Stms fromrep
-&gt; AllocM fromrep torep Result -&gt; AllocM fromrep torep Result
forall fromrep torep inner a.
Allocable fromrep torep inner =&gt;
Stms fromrep -&gt; AllocM fromrep torep a -&gt; AllocM fromrep torep a
</span><a href="Futhark.Pass.ExplicitAllocations.html#allocInStms"><span class="hs-identifier hs-var">allocInStms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Body fromrep -&gt; Stms fromrep
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">Body fromrep
</span><a href="#local-6989586621684440032"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(AllocM fromrep torep Result
 -&gt; AllocM fromrep torep (LambdaT torep))
-&gt; AllocM fromrep torep Result
-&gt; AllocM fromrep torep (LambdaT torep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-34"></span><span>    </span><span class="annot"><span class="annottext">Result -&gt; AllocM fromrep torep Result
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Result -&gt; AllocM fromrep torep Result)
-&gt; Result -&gt; AllocM fromrep torep Result
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Body fromrep -&gt; Result
forall rep. BodyT rep -&gt; Result
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var hs-var">bodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">Body fromrep
</span><a href="#local-6989586621684440032"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-35"></span><span>
</span><span id="line-36"></span><span id="local-6989586621684440331"><span id="local-6989586621684440332"><span id="local-6989586621684440333"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.SegOp.html#allocInBinOpParams"><span class="hs-identifier hs-type">allocInBinOpParams</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-37"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#Allocable"><span class="hs-identifier hs-type">Allocable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684440333"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684440332"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684440331"><span class="hs-identifier hs-type">inner</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-38"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-39"></span><span>  </span><span class="annot"><a href="Futhark.Analysis.PrimExp.html#TPrimExp"><span class="hs-identifier hs-type">TPrimExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-40"></span><span>  </span><span class="annot"><a href="Futhark.Analysis.PrimExp.html#TPrimExp"><span class="hs-identifier hs-type">TPrimExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-41"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#LParam"><span class="hs-identifier hs-type">LParam</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684440333"><span class="hs-identifier hs-type">fromrep</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-42"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#LParam"><span class="hs-identifier hs-type">LParam</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684440333"><span class="hs-identifier hs-type">fromrep</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-43"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocM"><span class="hs-identifier hs-type">AllocM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684440333"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684440332"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#LParam"><span class="hs-identifier hs-type">LParam</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684440332"><span class="hs-identifier hs-type">torep</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#LParam"><span class="hs-identifier hs-type">LParam</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684440332"><span class="hs-identifier hs-type">torep</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-44"></span><span id="allocInBinOpParams"><span class="annot"><span class="annottext">allocInBinOpParams :: forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
SubExp
-&gt; TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName
-&gt; [LParam fromrep]
-&gt; [LParam fromrep]
-&gt; AllocM fromrep torep ([LParam torep], [LParam torep])
</span><a href="Futhark.Pass.ExplicitAllocations.SegOp.html#allocInBinOpParams"><span class="hs-identifier hs-var hs-var">allocInBinOpParams</span></a></span></span><span> </span><span id="local-6989586621684439906"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684439906"><span class="hs-identifier hs-var">num_threads</span></a></span></span><span> </span><span id="local-6989586621684439905"><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684439905"><span class="hs-identifier hs-var">my_id</span></a></span></span><span> </span><span id="local-6989586621684439904"><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684439904"><span class="hs-identifier hs-var">other_id</span></a></span></span><span> </span><span id="local-6989586621684439903"><span class="annot"><span class="annottext">[LParam fromrep]
</span><a href="#local-6989586621684439903"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span id="local-6989586621684439902"><span class="annot"><span class="annottext">[LParam fromrep]
</span><a href="#local-6989586621684439902"><span class="hs-identifier hs-var">ys</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Param LParamMem, Param LParamMem)]
-&gt; ([Param LParamMem], [Param LParamMem])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(Param LParamMem, Param LParamMem)]
 -&gt; ([Param LParamMem], [Param LParamMem]))
-&gt; AllocM fromrep torep [(Param LParamMem, Param LParamMem)]
-&gt; AllocM fromrep torep ([Param LParamMem], [Param LParamMem])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Param Type
 -&gt; Param Type
 -&gt; AllocM fromrep torep (Param LParamMem, Param LParamMem))
-&gt; [Param Type]
-&gt; [Param Type]
-&gt; AllocM fromrep torep [(Param LParamMem, Param LParamMem)]
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m [c]
</span><span class="hs-identifier hs-var">zipWithM</span></span><span> </span><span class="annot"><span class="annottext">Param Type
-&gt; Param Type
-&gt; AllocM fromrep torep (Param LParamMem, Param LParamMem)
</span><a href="#local-6989586621684439899"><span class="hs-identifier hs-var">alloc</span></a></span><span> </span><span class="annot"><span class="annottext">[Param Type]
[LParam fromrep]
</span><a href="#local-6989586621684439903"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="annot"><span class="annottext">[Param Type]
[LParam fromrep]
</span><a href="#local-6989586621684439902"><span class="hs-identifier hs-var">ys</span></a></span><span>
</span><span id="line-45"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-46"></span><span>    </span><span id="local-6989586621684439899"><span class="annot"><span class="annottext">alloc :: Param Type
-&gt; Param Type
-&gt; AllocM fromrep torep (Param LParamMem, Param LParamMem)
</span><a href="#local-6989586621684439899"><span class="hs-identifier hs-var hs-var">alloc</span></a></span></span><span> </span><span id="local-6989586621684439898"><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684439898"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621684439897"><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684439897"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-47"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Param Type -&gt; Type
forall dec. Typed dec =&gt; Param dec -&gt; Type
</span><a href="Futhark.IR.Prop.Patterns.html#paramType"><span class="hs-identifier hs-var">paramType</span></a></span><span> </span><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684439898"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-48"></span><span>        </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span id="local-6989586621684439894"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684439894"><span class="hs-identifier hs-var">pt</span></a></span></span><span> </span><span id="local-6989586621684439893"><span class="annot"><span class="annottext">ShapeBase SubExp
</span><a href="#local-6989586621684439893"><span class="hs-identifier hs-var">shape</span></a></span></span><span> </span><span id="local-6989586621684439892"><span class="annot"><span class="annottext">NoUniqueness
</span><a href="#local-6989586621684439892"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-49"></span><span>          </span><span id="local-6989586621684439891"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684439891"><span class="hs-identifier hs-var">twice_num_threads</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-50"></span><span>            </span><span class="annot"><span class="annottext">String
-&gt; Exp (Rep (AllocM fromrep torep)) -&gt; AllocM fromrep torep SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;twice_num_threads&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (AllocM fromrep torep)) -&gt; AllocM fromrep torep SubExp)
-&gt; Exp (Rep (AllocM fromrep torep)) -&gt; AllocM fromrep torep SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-51"></span><span>              </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT torep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT torep) -&gt; BasicOp -&gt; ExpT torep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BinOp -&gt; SubExp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#BinOp"><span class="hs-identifier hs-var">BinOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Overflow -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#Mul"><span class="hs-identifier hs-var">Mul</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Overflow
</span><a href="Futhark.IR.Primitive.html#OverflowUndef"><span class="hs-identifier hs-var">OverflowUndef</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684439906"><span class="hs-identifier hs-var">num_threads</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; BasicOp) -&gt; SubExp -&gt; BasicOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IntType -&gt; Integer -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#intConst"><span class="hs-identifier hs-var">intConst</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">2</span></span><span>
</span><span id="line-52"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684439883"><span class="annot"><span class="annottext">t :: Type
</span><a href="#local-6989586621684439883"><span class="hs-identifier hs-var hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Param Type -&gt; Type
forall dec. Typed dec =&gt; Param dec -&gt; Type
</span><a href="Futhark.IR.Prop.Patterns.html#paramType"><span class="hs-identifier hs-var">paramType</span></a></span><span> </span><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684439898"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; SubExp -&gt; Type
forall d.
ArrayShape (ShapeBase d) =&gt;
TypeBase (ShapeBase d) NoUniqueness
-&gt; d -&gt; TypeBase (ShapeBase d) NoUniqueness
</span><a href="Futhark.IR.Prop.Types.html#arrayOfRow"><span class="hs-operator hs-var">`arrayOfRow`</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684439891"><span class="hs-identifier hs-var">twice_num_threads</span></a></span><span>
</span><span id="line-53"></span><span>          </span><span id="local-6989586621684439881"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684439881"><span class="hs-identifier hs-var">mem</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Space -&gt; AllocM fromrep torep VName
forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
Type -&gt; Space -&gt; AllocM fromrep torep VName
</span><a href="Futhark.Pass.ExplicitAllocations.html#allocForArray"><span class="hs-identifier hs-var">allocForArray</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684439883"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="Futhark.IR.Syntax.Core.html#DefaultSpace"><span class="hs-identifier hs-var">DefaultSpace</span></a></span><span>
</span><span id="line-54"></span><span>          </span><span class="hs-comment">-- XXX: this iota ixfun is a bit inefficient; leading to</span><span>
</span><span id="line-55"></span><span>          </span><span class="hs-comment">-- uncoalesced access.</span><span>
</span><span id="line-56"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684439878"><span class="annot"><span class="annottext">base_dims :: [TPrimExp Int64 VName]
</span><a href="#local-6989586621684439878"><span class="hs-identifier hs-var hs-var">base_dims</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TPrimExp Int64 VName)
-&gt; [SubExp] -&gt; [TPrimExp Int64 VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TPrimExp Int64 VName
</span><a href="Futhark.Analysis.PrimExp.Convert.html#pe64"><span class="hs-identifier hs-var">pe64</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [TPrimExp Int64 VName])
-&gt; [SubExp] -&gt; [TPrimExp Int64 VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; [SubExp]
forall u. TypeBase (ShapeBase SubExp) u -&gt; [SubExp]
</span><a href="Futhark.IR.Prop.Types.html#arrayDims"><span class="hs-identifier hs-var">arrayDims</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684439883"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-57"></span><span>              </span><span id="local-6989586621684439875"><span class="annot"><span class="annottext">ixfun_base :: IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684439875"><span class="hs-identifier hs-var hs-var">ixfun_base</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName] -&gt; IxFun (TPrimExp Int64 VName)
forall num. IntegralExp num =&gt; Shape num -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#iota"><span class="hs-identifier hs-var">IxFun.iota</span></a></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684439878"><span class="hs-identifier hs-var">base_dims</span></a></span><span>
</span><span id="line-58"></span><span>              </span><span id="local-6989586621684439873"><span class="annot"><span class="annottext">ixfun_x :: IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684439873"><span class="hs-identifier hs-var hs-var">ixfun_x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-59"></span><span>                </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
-&gt; Slice (TPrimExp Int64 VName) -&gt; IxFun (TPrimExp Int64 VName)
forall num.
(Eq num, IntegralExp num) =&gt;
IxFun num -&gt; Slice num -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#slice"><span class="hs-identifier hs-var">IxFun.slice</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684439875"><span class="hs-identifier hs-var">ixfun_base</span></a></span><span> </span><span class="annot"><span class="annottext">(Slice (TPrimExp Int64 VName) -&gt; IxFun (TPrimExp Int64 VName))
-&gt; Slice (TPrimExp Int64 VName) -&gt; IxFun (TPrimExp Int64 VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-60"></span><span>                  </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
-&gt; [DimIndex (TPrimExp Int64 VName)]
-&gt; Slice (TPrimExp Int64 VName)
forall d. Num d =&gt; [d] -&gt; [DimIndex d] -&gt; Slice d
</span><a href="Futhark.Construct.html#fullSliceNum"><span class="hs-identifier hs-var">fullSliceNum</span></a></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684439878"><span class="hs-identifier hs-var">base_dims</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; DimIndex (TPrimExp Int64 VName)
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684439905"><span class="hs-identifier hs-var">my_id</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-61"></span><span>              </span><span id="local-6989586621684439869"><span class="annot"><span class="annottext">ixfun_y :: IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684439869"><span class="hs-identifier hs-var hs-var">ixfun_y</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-62"></span><span>                </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
-&gt; Slice (TPrimExp Int64 VName) -&gt; IxFun (TPrimExp Int64 VName)
forall num.
(Eq num, IntegralExp num) =&gt;
IxFun num -&gt; Slice num -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#slice"><span class="hs-identifier hs-var">IxFun.slice</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684439875"><span class="hs-identifier hs-var">ixfun_base</span></a></span><span> </span><span class="annot"><span class="annottext">(Slice (TPrimExp Int64 VName) -&gt; IxFun (TPrimExp Int64 VName))
-&gt; Slice (TPrimExp Int64 VName) -&gt; IxFun (TPrimExp Int64 VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-63"></span><span>                  </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
-&gt; [DimIndex (TPrimExp Int64 VName)]
-&gt; Slice (TPrimExp Int64 VName)
forall d. Num d =&gt; [d] -&gt; [DimIndex d] -&gt; Slice d
</span><a href="Futhark.Construct.html#fullSliceNum"><span class="hs-identifier hs-var">fullSliceNum</span></a></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684439878"><span class="hs-identifier hs-var">base_dims</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; DimIndex (TPrimExp Int64 VName)
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684439904"><span class="hs-identifier hs-var">other_id</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-64"></span><span>          </span><span class="annot"><span class="annottext">(Param LParamMem, Param LParamMem)
-&gt; AllocM fromrep torep (Param LParamMem, Param LParamMem)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-65"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684439898"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">paramDec :: LParamMem
</span><a href="Futhark.IR.Syntax.Core.html#paramDec"><span class="hs-identifier hs-var">paramDec</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimType
-&gt; ShapeBase SubExp -&gt; NoUniqueness -&gt; MemBind -&gt; LParamMem
forall d u ret.
PrimType -&gt; ShapeBase d -&gt; u -&gt; ret -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-var">MemArray</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684439894"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">ShapeBase SubExp
</span><a href="#local-6989586621684439893"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">NoUniqueness
</span><a href="#local-6989586621684439892"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">(MemBind -&gt; LParamMem) -&gt; MemBind -&gt; LParamMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; IxFun (TPrimExp Int64 VName) -&gt; MemBind
</span><a href="Futhark.IR.Mem.html#ArrayIn"><span class="hs-identifier hs-var">ArrayIn</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684439881"><span class="hs-identifier hs-var">mem</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684439873"><span class="hs-identifier hs-var">ixfun_x</span></a></span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><span id="line-66"></span><span>              </span><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684439897"><span class="hs-identifier hs-var">y</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">paramDec :: LParamMem
</span><a href="Futhark.IR.Syntax.Core.html#paramDec"><span class="hs-identifier hs-var">paramDec</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimType
-&gt; ShapeBase SubExp -&gt; NoUniqueness -&gt; MemBind -&gt; LParamMem
forall d u ret.
PrimType -&gt; ShapeBase d -&gt; u -&gt; ret -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-var">MemArray</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684439894"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">ShapeBase SubExp
</span><a href="#local-6989586621684439893"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">NoUniqueness
</span><a href="#local-6989586621684439892"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">(MemBind -&gt; LParamMem) -&gt; MemBind -&gt; LParamMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; IxFun (TPrimExp Int64 VName) -&gt; MemBind
</span><a href="Futhark.IR.Mem.html#ArrayIn"><span class="hs-identifier hs-var">ArrayIn</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684439881"><span class="hs-identifier hs-var">mem</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684439869"><span class="hs-identifier hs-var">ixfun_y</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-67"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-68"></span><span>        </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-type">Prim</span></a></span><span> </span><span id="local-6989586621684439864"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684439864"><span class="hs-identifier hs-var">bt</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-69"></span><span>          </span><span class="annot"><span class="annottext">(Param LParamMem, Param LParamMem)
-&gt; AllocM fromrep torep (Param LParamMem, Param LParamMem)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-70"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684439898"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">paramDec :: LParamMem
</span><a href="Futhark.IR.Syntax.Core.html#paramDec"><span class="hs-identifier hs-var">paramDec</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; LParamMem
forall d u ret. PrimType -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemPrim"><span class="hs-identifier hs-var">MemPrim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684439864"><span class="hs-identifier hs-var">bt</span></a></span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><span id="line-71"></span><span>              </span><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684439897"><span class="hs-identifier hs-var">y</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">paramDec :: LParamMem
</span><a href="Futhark.IR.Syntax.Core.html#paramDec"><span class="hs-identifier hs-var">paramDec</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; LParamMem
forall d u ret. PrimType -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemPrim"><span class="hs-identifier hs-var">MemPrim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684439864"><span class="hs-identifier hs-var">bt</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-72"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-73"></span><span>        </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Mem"><span class="hs-identifier hs-type">Mem</span></a></span><span> </span><span id="local-6989586621684439861"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684439861"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-74"></span><span>          </span><span class="annot"><span class="annottext">(Param LParamMem, Param LParamMem)
-&gt; AllocM fromrep torep (Param LParamMem, Param LParamMem)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-75"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684439898"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">paramDec :: LParamMem
</span><a href="Futhark.IR.Syntax.Core.html#paramDec"><span class="hs-identifier hs-var">paramDec</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Space -&gt; LParamMem
forall d u ret. Space -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemMem"><span class="hs-identifier hs-var">MemMem</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684439861"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><span id="line-76"></span><span>              </span><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684439897"><span class="hs-identifier hs-var">y</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">paramDec :: LParamMem
</span><a href="Futhark.IR.Syntax.Core.html#paramDec"><span class="hs-identifier hs-var">paramDec</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Space -&gt; LParamMem
forall d u ret. Space -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemMem"><span class="hs-identifier hs-var">MemMem</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684439861"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-77"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-78"></span><span>        </span><span class="hs-comment">-- This next case will never happen.</span><span>
</span><span id="line-79"></span><span>        </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Acc"><span class="hs-identifier hs-type">Acc</span></a></span><span> </span><span id="local-6989586621684439858"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684439858"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621684439857"><span class="annot"><span class="annottext">ShapeBase SubExp
</span><a href="#local-6989586621684439857"><span class="hs-identifier hs-var">ispace</span></a></span></span><span> </span><span id="local-6989586621684439856"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684439856"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span id="local-6989586621684439855"><span class="annot"><span class="annottext">NoUniqueness
</span><a href="#local-6989586621684439855"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-80"></span><span>          </span><span class="annot"><span class="annottext">(Param LParamMem, Param LParamMem)
-&gt; AllocM fromrep torep (Param LParamMem, Param LParamMem)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-81"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684439898"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">paramDec :: LParamMem
</span><a href="Futhark.IR.Syntax.Core.html#paramDec"><span class="hs-identifier hs-var">paramDec</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; ShapeBase SubExp -&gt; [Type] -&gt; NoUniqueness -&gt; LParamMem
forall d u ret.
VName -&gt; ShapeBase SubExp -&gt; [Type] -&gt; u -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemAcc"><span class="hs-identifier hs-var">MemAcc</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684439858"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">ShapeBase SubExp
</span><a href="#local-6989586621684439857"><span class="hs-identifier hs-var">ispace</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684439856"><span class="hs-identifier hs-var">ts</span></a></span><span> </span><span class="annot"><span class="annottext">NoUniqueness
</span><a href="#local-6989586621684439855"><span class="hs-identifier hs-var">u</span></a></span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><span id="line-82"></span><span>              </span><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684439897"><span class="hs-identifier hs-var">y</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">paramDec :: LParamMem
</span><a href="Futhark.IR.Syntax.Core.html#paramDec"><span class="hs-identifier hs-var">paramDec</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; ShapeBase SubExp -&gt; [Type] -&gt; NoUniqueness -&gt; LParamMem
forall d u ret.
VName -&gt; ShapeBase SubExp -&gt; [Type] -&gt; u -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemAcc"><span class="hs-identifier hs-var">MemAcc</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684439858"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">ShapeBase SubExp
</span><a href="#local-6989586621684439857"><span class="hs-identifier hs-var">ispace</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684439856"><span class="hs-identifier hs-var">ts</span></a></span><span> </span><span class="annot"><span class="annottext">NoUniqueness
</span><a href="#local-6989586621684439855"><span class="hs-identifier hs-var">u</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-83"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-84"></span><span>
</span><span id="line-85"></span><span id="local-6989586621684440265"><span id="local-6989586621684440266"><span id="local-6989586621684440267"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.SegOp.html#allocInBinOpLambda"><span class="hs-identifier hs-type">allocInBinOpLambda</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-86"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#Allocable"><span class="hs-identifier hs-type">Allocable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684440267"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684440266"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684440265"><span class="hs-identifier hs-type">inner</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-87"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-88"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegSpace"><span class="hs-identifier hs-type">SegSpace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-89"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684440267"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-90"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocM"><span class="hs-identifier hs-type">AllocM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684440267"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684440266"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684440266"><span class="hs-identifier hs-type">torep</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-91"></span><span id="allocInBinOpLambda"><span class="annot"><span class="annottext">allocInBinOpLambda :: forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
SubExp
-&gt; SegSpace
-&gt; Lambda fromrep
-&gt; AllocM fromrep torep (Lambda torep)
</span><a href="Futhark.Pass.ExplicitAllocations.SegOp.html#allocInBinOpLambda"><span class="hs-identifier hs-var hs-var">allocInBinOpLambda</span></a></span></span><span> </span><span id="local-6989586621684439760"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684439760"><span class="hs-identifier hs-var">num_threads</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#SegSpace"><span class="hs-identifier hs-type">SegSpace</span></a></span><span> </span><span id="local-6989586621684439758"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684439758"><span class="hs-identifier hs-var">flat</span></a></span></span><span> </span><span class="annot"><span class="annottext">[(VName, SubExp)]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684439757"><span class="annot"><span class="annottext">Lambda fromrep
</span><a href="#local-6989586621684439757"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-92"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684439756"><span class="annot"><span class="annottext">[Param Type]
</span><a href="#local-6989586621684439756"><span class="hs-identifier hs-var">acc_params</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684439755"><span class="annot"><span class="annottext">[Param Type]
</span><a href="#local-6989586621684439755"><span class="hs-identifier hs-var">arr_params</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-93"></span><span>        </span><span class="annot"><span class="annottext">Int -&gt; [Param Type] -&gt; ([Param Type], [Param Type])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param Type] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda fromrep -&gt; [LParam fromrep]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda fromrep
</span><a href="#local-6989586621684439757"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Integral a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`div`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Param Type] -&gt; ([Param Type], [Param Type]))
-&gt; [Param Type] -&gt; ([Param Type], [Param Type])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda fromrep -&gt; [LParam fromrep]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda fromrep
</span><a href="#local-6989586621684439757"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-94"></span><span>      </span><span id="local-6989586621684439750"><span class="annot"><span class="annottext">index_x :: TPrimExp Int64 VName
</span><a href="#local-6989586621684439750"><span class="hs-identifier hs-var hs-var">index_x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimExp VName -&gt; TPrimExp Int64 VName
forall t v. PrimExp v -&gt; TPrimExp t v
</span><a href="Futhark.Analysis.PrimExp.html#TPrimExp"><span class="hs-identifier hs-var">TPrimExp</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimExp VName -&gt; TPrimExp Int64 VName)
-&gt; PrimExp VName -&gt; TPrimExp Int64 VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; PrimExp VName
forall v. v -&gt; PrimType -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#LeafExp"><span class="hs-identifier hs-var">LeafExp</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684439758"><span class="hs-identifier hs-var">flat</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int64"><span class="hs-identifier hs-var">int64</span></a></span><span>
</span><span id="line-95"></span><span>      </span><span id="local-6989586621684439746"><span class="annot"><span class="annottext">index_y :: TPrimExp Int64 VName
</span><a href="#local-6989586621684439746"><span class="hs-identifier hs-var hs-var">index_y</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684439750"><span class="hs-identifier hs-var">index_x</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TPrimExp Int64 VName
</span><a href="Futhark.Analysis.PrimExp.Convert.html#pe64"><span class="hs-identifier hs-var">pe64</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684439760"><span class="hs-identifier hs-var">num_threads</span></a></span><span>
</span><span id="line-96"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684439744"><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684439744"><span class="hs-identifier hs-var">acc_params'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684439743"><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684439743"><span class="hs-identifier hs-var">arr_params'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-97"></span><span>    </span><span class="annot"><span class="annottext">SubExp
-&gt; TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName
-&gt; [LParam fromrep]
-&gt; [LParam fromrep]
-&gt; AllocM fromrep torep ([LParam torep], [LParam torep])
forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
SubExp
-&gt; TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName
-&gt; [LParam fromrep]
-&gt; [LParam fromrep]
-&gt; AllocM fromrep torep ([LParam torep], [LParam torep])
</span><a href="Futhark.Pass.ExplicitAllocations.SegOp.html#allocInBinOpParams"><span class="hs-identifier hs-var">allocInBinOpParams</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684439760"><span class="hs-identifier hs-var">num_threads</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684439750"><span class="hs-identifier hs-var">index_x</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684439746"><span class="hs-identifier hs-var">index_y</span></a></span><span> </span><span class="annot"><span class="annottext">[Param Type]
[LParam fromrep]
</span><a href="#local-6989586621684439756"><span class="hs-identifier hs-var">acc_params</span></a></span><span> </span><span class="annot"><span class="annottext">[Param Type]
[LParam fromrep]
</span><a href="#local-6989586621684439755"><span class="hs-identifier hs-var">arr_params</span></a></span><span>
</span><span id="line-98"></span><span>
</span><span id="line-99"></span><span>  </span><span class="annot"><span class="annottext">[LParam torep]
-&gt; Body fromrep -&gt; AllocM fromrep torep (Lambda torep)
forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
[LParam torep]
-&gt; Body fromrep -&gt; AllocM fromrep torep (Lambda torep)
</span><a href="Futhark.Pass.ExplicitAllocations.SegOp.html#allocInLambda"><span class="hs-identifier hs-var">allocInLambda</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684439744"><span class="hs-identifier hs-var">acc_params'</span></a></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem] -&gt; [Param LParamMem] -&gt; [Param LParamMem]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684439743"><span class="hs-identifier hs-var">arr_params'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda fromrep -&gt; Body fromrep
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda fromrep
</span><a href="#local-6989586621684439757"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-100"></span></pre></body></html>