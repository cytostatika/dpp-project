<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE FlexibleInstances #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE MultiParamTypeClasses #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-6"></span><span>
</span><span id="line-7"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Futhark.AD.Rev.Reduce</span><span>
</span><span id="line-8"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.AD.Rev.Reduce.html#diffReduce"><span class="hs-identifier">diffReduce</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-9"></span><span>    </span><span class="annot"><a href="Futhark.AD.Rev.Reduce.html#diffMinMaxReduce"><span class="hs-identifier">diffMinMaxReduce</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-10"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-11"></span><span class="hs-keyword">where</span><span>
</span><span id="line-12"></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.AD.Rev.Monad.html"><span class="hs-identifier">Futhark.AD.Rev.Monad</span></a></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Analysis.PrimExp.Convert.html"><span class="hs-identifier">Futhark.Analysis.PrimExp.Convert</span></a></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Builder.html"><span class="hs-identifier">Futhark.Builder</span></a></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html"><span class="hs-identifier">Futhark.IR.SOACS</span></a></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Tools.html"><span class="hs-identifier">Futhark.Tools</span></a></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Transform.Rename.html"><span class="hs-identifier">Futhark.Transform.Rename</span></a></span><span>
</span><span id="line-20"></span><span>
</span><span id="line-21"></span><span id="local-6989586621684462473"><span class="annot"><a href="Futhark.AD.Rev.Reduce.html#eReverse"><span class="hs-identifier hs-type">eReverse</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Builder.Class.html#MonadBuilder"><span class="hs-identifier hs-type">MonadBuilder</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684462473"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684462473"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span></span><span>
</span><span id="line-22"></span><span id="eReverse"><span class="annot"><span class="annottext">eReverse :: forall (m :: * -&gt; *). MonadBuilder m =&gt; VName -&gt; m VName
</span><a href="Futhark.AD.Rev.Reduce.html#eReverse"><span class="hs-identifier hs-var hs-var">eReverse</span></a></span></span><span> </span><span id="local-6989586621684461975"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684461975"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-23"></span><span>  </span><span id="local-6989586621684461974"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684461974"><span class="hs-identifier hs-var">arr_t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; m Type
forall rep (m :: * -&gt; *). HasScope rep m =&gt; VName -&gt; m Type
</span><a href="Futhark.IR.Prop.Scope.html#lookupType"><span class="hs-identifier hs-var">lookupType</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684461975"><span class="hs-identifier hs-var">arr</span></a></span><span>
</span><span id="line-24"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684461972"><span class="annot"><span class="annottext">w :: SubExp
</span><a href="#local-6989586621684461972"><span class="hs-identifier hs-var hs-var">w</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Type -&gt; SubExp
forall u. Int -&gt; TypeBase (ShapeBase SubExp) u -&gt; SubExp
</span><a href="Futhark.IR.Prop.Types.html#arraySize"><span class="hs-identifier hs-var">arraySize</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684461974"><span class="hs-identifier hs-var">arr_t</span></a></span><span>
</span><span id="line-25"></span><span>  </span><span id="local-6989586621684461970"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684461970"><span class="hs-identifier hs-var">start</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-26"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; Exp (Rep m) -&gt; m SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;rev_start&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep m) -&gt; m SubExp) -&gt; Exp (Rep m) -&gt; m SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-27"></span><span>      </span><span class="annot"><span class="annottext">BasicOp -&gt; Exp (Rep m)
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; Exp (Rep m)) -&gt; BasicOp -&gt; Exp (Rep m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BinOp -&gt; SubExp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#BinOp"><span class="hs-identifier hs-var">BinOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Overflow -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#Sub"><span class="hs-identifier hs-var">Sub</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Overflow
</span><a href="Futhark.IR.Primitive.html#OverflowUndef"><span class="hs-identifier hs-var">OverflowUndef</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684461972"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Integer -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#intConst"><span class="hs-identifier hs-var">intConst</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684461960"><span class="annot"><span class="annottext">stride :: SubExp
</span><a href="#local-6989586621684461960"><span class="hs-identifier hs-var hs-var">stride</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IntType -&gt; Integer -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#intConst"><span class="hs-identifier hs-var">intConst</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span>      </span><span id="local-6989586621684461959"><span class="annot"><span class="annottext">slice :: Slice SubExp
</span><a href="#local-6989586621684461959"><span class="hs-identifier hs-var hs-var">slice</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; [DimIndex SubExp] -&gt; Slice SubExp
</span><a href="Futhark.Construct.html#fullSlice"><span class="hs-identifier hs-var">fullSlice</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684461974"><span class="hs-identifier hs-var">arr_t</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SubExp -&gt; SubExp -&gt; SubExp -&gt; DimIndex SubExp
forall d. d -&gt; d -&gt; d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimSlice"><span class="hs-identifier hs-var">DimSlice</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684461970"><span class="hs-identifier hs-var">start</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684461972"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684461960"><span class="hs-identifier hs-var">stride</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-30"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; Exp (Rep m) -&gt; m VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m VName
</span><a href="Futhark.Construct.html#letExp"><span class="hs-identifier hs-var">letExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; String
</span><a href="Language.Futhark.Core.html#baseString"><span class="hs-identifier hs-var">baseString</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684461975"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_rev&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Exp (Rep m) -&gt; m VName) -&gt; Exp (Rep m) -&gt; m VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; Exp (Rep m)
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; Exp (Rep m)) -&gt; BasicOp -&gt; Exp (Rep m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Slice SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Index"><span class="hs-identifier hs-var">Index</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684461975"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684461959"><span class="hs-identifier hs-var">slice</span></a></span><span>
</span><span id="line-31"></span><span>
</span><span id="line-32"></span><span id="local-6989586621684462448"><span class="annot"><a href="Futhark.AD.Rev.Reduce.html#eRotate"><span class="hs-identifier hs-type">eRotate</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Builder.Class.html#MonadBuilder"><span class="hs-identifier hs-type">MonadBuilder</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684462448"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684462448"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span></span><span>
</span><span id="line-33"></span><span id="eRotate"><span class="annot"><span class="annottext">eRotate :: forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[SubExp] -&gt; VName -&gt; m VName
</span><a href="Futhark.AD.Rev.Reduce.html#eRotate"><span class="hs-identifier hs-var hs-var">eRotate</span></a></span></span><span> </span><span id="local-6989586621684461947"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684461947"><span class="hs-identifier hs-var">rots</span></a></span></span><span> </span><span id="local-6989586621684461946"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684461946"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Exp (Rep m) -&gt; m VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m VName
</span><a href="Futhark.Construct.html#letExp"><span class="hs-identifier hs-var">letExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; String
</span><a href="Language.Futhark.Core.html#baseString"><span class="hs-identifier hs-var">baseString</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684461946"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_rot&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Exp (Rep m) -&gt; m VName) -&gt; Exp (Rep m) -&gt; m VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; Exp (Rep m)
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; Exp (Rep m)) -&gt; BasicOp -&gt; Exp (Rep m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; VName -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Rotate"><span class="hs-identifier hs-var">Rotate</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684461947"><span class="hs-identifier hs-var">rots</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684461946"><span class="hs-identifier hs-var">arr</span></a></span><span>
</span><span id="line-34"></span><span>
</span><span id="line-35"></span><span id="local-6989586621684462446"><span class="annot"><a href="Futhark.AD.Rev.Reduce.html#scanExc"><span class="hs-identifier hs-type">scanExc</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-36"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Builder.Class.html#MonadBuilder"><span class="hs-identifier hs-type">MonadBuilder</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684462446"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Builder.Class.html#Rep"><span class="hs-identifier hs-type">Rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684462446"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">~</span></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-37"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-38"></span><span>  </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Scan"><span class="hs-identifier hs-type">Scan</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-39"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-40"></span><span>  </span><span class="annot"><a href="#local-6989586621684462446"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span></span><span>
</span><span id="line-41"></span><span id="scanExc"><span class="annot"><span class="annottext">scanExc :: forall (m :: * -&gt; *).
(MonadBuilder m, Rep m ~ SOACS) =&gt;
String -&gt; Scan SOACS -&gt; [VName] -&gt; m [VName]
</span><a href="Futhark.AD.Rev.Reduce.html#scanExc"><span class="hs-identifier hs-var hs-var">scanExc</span></a></span></span><span> </span><span id="local-6989586621684461885"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621684461885"><span class="hs-identifier hs-var">desc</span></a></span></span><span> </span><span id="local-6989586621684461884"><span class="annot"><span class="annottext">Scan SOACS
</span><a href="#local-6989586621684461884"><span class="hs-identifier hs-var">scan</span></a></span></span><span> </span><span id="local-6989586621684461883"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684461883"><span class="hs-identifier hs-var">arrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-42"></span><span>  </span><span id="local-6989586621684461882"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684461882"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Type] -&gt; SubExp
forall u. Int -&gt; [TypeBase (ShapeBase SubExp) u] -&gt; SubExp
</span><a href="Futhark.IR.Prop.Types.html#arraysSize"><span class="hs-identifier hs-var">arraysSize</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">([Type] -&gt; SubExp) -&gt; m [Type] -&gt; m SubExp
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; m Type) -&gt; [VName] -&gt; m [Type]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; m Type
forall rep (m :: * -&gt; *). HasScope rep m =&gt; VName -&gt; m Type
</span><a href="Futhark.IR.Prop.Scope.html#lookupType"><span class="hs-identifier hs-var">lookupType</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684461883"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-43"></span><span>  </span><span id="local-6989586621684461878"><span class="annot"><span class="annottext">ScremaForm SOACS
</span><a href="#local-6989586621684461878"><span class="hs-identifier hs-var">form</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Scan SOACS] -&gt; m (ScremaForm SOACS)
forall rep (m :: * -&gt; *).
(Buildable rep, MonadFreshNames m) =&gt;
[Scan rep] -&gt; m (ScremaForm rep)
</span><a href="Futhark.IR.SOACS.SOAC.html#scanSOAC"><span class="hs-identifier hs-var">scanSOAC</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Scan SOACS
</span><a href="#local-6989586621684461884"><span class="hs-identifier hs-var">scan</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-44"></span><span>  </span><span id="local-6989586621684461876"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684461876"><span class="hs-identifier hs-var">res_incl</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; Exp (Rep m) -&gt; m [VName]
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m [VName]
</span><a href="Futhark.Construct.html#letTupExp"><span class="hs-identifier hs-var">letTupExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621684461885"><span class="hs-identifier hs-var">desc</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_incl&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Exp (Rep m) -&gt; m [VName]) -&gt; Exp (Rep m) -&gt; m [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Op SOACS -&gt; ExpT SOACS
forall rep. Op rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-var">Op</span></a></span><span> </span><span class="annot"><span class="annottext">(Op SOACS -&gt; ExpT SOACS) -&gt; Op SOACS -&gt; ExpT SOACS
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; [VName] -&gt; ScremaForm SOACS -&gt; SOAC SOACS
forall rep. SubExp -&gt; [VName] -&gt; ScremaForm rep -&gt; SOAC rep
</span><a href="Futhark.IR.SOACS.SOAC.html#Screma"><span class="hs-identifier hs-var">Screma</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684461882"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684461883"><span class="hs-identifier hs-var">arrs</span></a></span><span> </span><span class="annot"><span class="annottext">ScremaForm SOACS
</span><a href="#local-6989586621684461878"><span class="hs-identifier hs-var">form</span></a></span><span>
</span><span id="line-45"></span><span>  </span><span id="local-6989586621684461872"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684461872"><span class="hs-identifier hs-var">res_incl_rot</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; m VName) -&gt; [VName] -&gt; m [VName]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; VName -&gt; m VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[SubExp] -&gt; VName -&gt; m VName
</span><a href="Futhark.AD.Rev.Reduce.html#eRotate"><span class="hs-identifier hs-var">eRotate</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">IntType -&gt; Integer -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#intConst"><span class="hs-identifier hs-var">intConst</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684461876"><span class="hs-identifier hs-var">res_incl</span></a></span><span>
</span><span id="line-46"></span><span>
</span><span id="line-47"></span><span>  </span><span id="local-6989586621684461871"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684461871"><span class="hs-identifier hs-var">iota</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-48"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; Exp (Rep m) -&gt; m VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m VName
</span><a href="Futhark.Construct.html#letExp"><span class="hs-identifier hs-var">letExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;iota&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ExpT SOACS -&gt; m VName)
-&gt; (BasicOp -&gt; ExpT SOACS) -&gt; BasicOp -&gt; m VName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT SOACS
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; m VName) -&gt; BasicOp -&gt; m VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-49"></span><span>      </span><span class="annot"><span class="annottext">SubExp -&gt; SubExp -&gt; SubExp -&gt; IntType -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Iota"><span class="hs-identifier hs-var">Iota</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684461882"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Integer -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#intConst"><span class="hs-identifier hs-var">intConst</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Integer -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#intConst"><span class="hs-identifier hs-var">intConst</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span>
</span><span id="line-50"></span><span>
</span><span id="line-51"></span><span>  </span><span id="local-6989586621684461868"><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684461868"><span class="hs-identifier hs-var">iparam</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; Type -&gt; m (Param Type)
forall (m :: * -&gt; *) dec.
MonadFreshNames m =&gt;
String -&gt; dec -&gt; m (Param dec)
</span><a href="Futhark.MonadFreshNames.html#newParam"><span class="hs-identifier hs-var">newParam</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;iota_param&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; m (Param Type)) -&gt; Type -&gt; m (Param Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; Type
forall shape u. PrimType -&gt; TypeBase shape u
</span><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int64"><span class="hs-identifier hs-var">int64</span></a></span><span>
</span><span id="line-52"></span><span>  </span><span id="local-6989586621684461864"><span class="annot"><span class="annottext">[Param Type]
</span><a href="#local-6989586621684461864"><span class="hs-identifier hs-var">vparams</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Type -&gt; m (Param Type)) -&gt; [Type] -&gt; m [Param Type]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Type -&gt; m (Param Type)
forall (m :: * -&gt; *) dec.
MonadFreshNames m =&gt;
String -&gt; dec -&gt; m (Param dec)
</span><a href="Futhark.MonadFreshNames.html#newParam"><span class="hs-identifier hs-var">newParam</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;vp&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684461863"><span class="hs-identifier hs-var">ts</span></a></span><span>
</span><span id="line-53"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684461862"><span class="annot"><span class="annottext">params :: [Param Type]
</span><a href="#local-6989586621684461862"><span class="hs-identifier hs-var hs-var">params</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684461868"><span class="hs-identifier hs-var">iparam</span></a></span><span> </span><span class="annot"><span class="annottext">Param Type -&gt; [Param Type] -&gt; [Param Type]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Param Type]
</span><a href="#local-6989586621684461864"><span class="hs-identifier hs-var">vparams</span></a></span><span>
</span><span id="line-54"></span><span>
</span><span id="line-55"></span><span>  </span><span id="local-6989586621684461861"><span class="annot"><span class="annottext">Body SOACS
</span><a href="#local-6989586621684461861"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Builder SOACS (Body SOACS) -&gt; m (Body SOACS)
forall rep (m :: * -&gt; *) somerep.
(Buildable rep, MonadFreshNames m, HasScope somerep m,
 SameScope somerep rep) =&gt;
Builder rep (Body rep) -&gt; m (Body rep)
</span><a href="Futhark.Builder.html#runBodyBuilder"><span class="hs-identifier hs-var">runBodyBuilder</span></a></span><span> </span><span class="annot"><span class="annottext">(Builder SOACS (Body SOACS) -&gt; m (Body SOACS))
-&gt; (Builder SOACS (Body SOACS) -&gt; Builder SOACS (Body SOACS))
-&gt; Builder SOACS (Body SOACS)
-&gt; m (Body SOACS)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Scope SOACS
-&gt; Builder SOACS (Body SOACS) -&gt; Builder SOACS (Body SOACS)
forall rep (m :: * -&gt; *) a.
LocalScope rep m =&gt;
Scope rep -&gt; m a -&gt; m a
</span><a href="Futhark.IR.Prop.Scope.html#localScope"><span class="hs-identifier hs-var">localScope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param Type] -&gt; Scope SOACS
forall rep dec. (LParamInfo rep ~ dec) =&gt; [Param dec] -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOfLParams"><span class="hs-identifier hs-var">scopeOfLParams</span></a></span><span> </span><span class="annot"><span class="annottext">[Param Type]
</span><a href="#local-6989586621684461862"><span class="hs-identifier hs-var">params</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Builder SOACS (Body SOACS) -&gt; m (Body SOACS))
-&gt; Builder SOACS (Body SOACS) -&gt; m (Body SOACS)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-56"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684461857"><span class="annot"><span class="annottext">first_elem :: BuilderT
  SOACS
  (State VNameSource)
  (Exp (Rep (BuilderT SOACS (State VNameSource))))
</span><a href="#local-6989586621684461857"><span class="hs-identifier hs-var hs-var">first_elem</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-57"></span><span>          </span><span class="annot"><span class="annottext">CmpOp
-&gt; BuilderT
     SOACS
     (State VNameSource)
     (Exp (Rep (BuilderT SOACS (State VNameSource))))
-&gt; BuilderT
     SOACS
     (State VNameSource)
     (Exp (Rep (BuilderT SOACS (State VNameSource))))
-&gt; BuilderT
     SOACS
     (State VNameSource)
     (Exp (Rep (BuilderT SOACS (State VNameSource))))
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
CmpOp -&gt; m (Exp (Rep m)) -&gt; m (Exp (Rep m)) -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#eCmpOp"><span class="hs-identifier hs-var">eCmpOp</span></a></span><span>
</span><span id="line-58"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimType -&gt; CmpOp
</span><a href="Futhark.IR.Primitive.html#CmpEq"><span class="hs-identifier hs-var">CmpEq</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int64"><span class="hs-identifier hs-var">int64</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-59"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp
-&gt; BuilderT
     SOACS
     (State VNameSource)
     (Exp (Rep (BuilderT SOACS (State VNameSource))))
forall (m :: * -&gt; *). MonadBuilder m =&gt; SubExp -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#eSubExp"><span class="hs-identifier hs-var">eSubExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param Type -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684461868"><span class="hs-identifier hs-var">iparam</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-60"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp
-&gt; BuilderT
     SOACS
     (State VNameSource)
     (Exp (Rep (BuilderT SOACS (State VNameSource))))
forall (m :: * -&gt; *). MonadBuilder m =&gt; SubExp -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#eSubExp"><span class="hs-identifier hs-var">eSubExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Integer -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#intConst"><span class="hs-identifier hs-var">intConst</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-61"></span><span>    </span><span class="annot"><span class="annottext">[BuilderT
   SOACS
   (State VNameSource)
   (Exp (Rep (BuilderT SOACS (State VNameSource))))]
-&gt; BuilderT
     SOACS
     (State VNameSource)
     (Body (Rep (BuilderT SOACS (State VNameSource))))
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[m (Exp (Rep m))] -&gt; m (Body (Rep m))
</span><a href="Futhark.Construct.html#eBody"><span class="hs-identifier hs-var">eBody</span></a></span><span>
</span><span id="line-62"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">BuilderT
  SOACS
  (State VNameSource)
  (Exp (Rep (BuilderT SOACS (State VNameSource))))
-&gt; BuilderT
     SOACS
     (State VNameSource)
     (Body (Rep (BuilderT SOACS (State VNameSource))))
-&gt; BuilderT
     SOACS
     (State VNameSource)
     (Body (Rep (BuilderT SOACS (State VNameSource))))
-&gt; BuilderT
     SOACS
     (State VNameSource)
     (Exp (Rep (BuilderT SOACS (State VNameSource))))
forall (m :: * -&gt; *).
(MonadBuilder m, BranchType (Rep m) ~ ExtType) =&gt;
m (Exp (Rep m))
-&gt; m (Body (Rep m)) -&gt; m (Body (Rep m)) -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#eIf"><span class="hs-identifier hs-var">eIf</span></a></span><span>
</span><span id="line-63"></span><span>          </span><span class="annot"><span class="annottext">BuilderT
  SOACS
  (State VNameSource)
  (Exp (Rep (BuilderT SOACS (State VNameSource))))
</span><a href="#local-6989586621684461857"><span class="hs-identifier hs-var">first_elem</span></a></span><span>
</span><span id="line-64"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp]
-&gt; BuilderT
     SOACS
     (State VNameSource)
     (Body (Rep (BuilderT SOACS (State VNameSource))))
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[SubExp] -&gt; m (Body (Rep m))
</span><a href="Futhark.Construct.html#resultBodyM"><span class="hs-identifier hs-var">resultBodyM</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684461848"><span class="hs-identifier hs-var">nes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp]
-&gt; BuilderT
     SOACS
     (State VNameSource)
     (Body (Rep (BuilderT SOACS (State VNameSource))))
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[SubExp] -&gt; m (Body (Rep m))
</span><a href="Futhark.Construct.html#resultBodyM"><span class="hs-identifier hs-var">resultBodyM</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp]
 -&gt; BuilderT
      SOACS
      (State VNameSource)
      (Body (Rep (BuilderT SOACS (State VNameSource)))))
-&gt; [SubExp]
-&gt; BuilderT
     SOACS
     (State VNameSource)
     (Body (Rep (BuilderT SOACS (State VNameSource))))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Param Type -&gt; SubExp) -&gt; [Param Type] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SubExp) -&gt; (Param Type -&gt; VName) -&gt; Param Type -&gt; SubExp
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Param Type -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Param Type]
</span><a href="#local-6989586621684461864"><span class="hs-identifier hs-var">vparams</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-66"></span><span>      </span><span class="hs-special">]</span><span>
</span><span id="line-67"></span><span>
</span><span id="line-68"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684461847"><span class="annot"><span class="annottext">lam :: LambdaT SOACS
</span><a href="#local-6989586621684461847"><span class="hs-identifier hs-var hs-var">lam</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[LParam SOACS] -&gt; Body SOACS -&gt; [Type] -&gt; LambdaT SOACS
forall rep. [LParam rep] -&gt; BodyT rep -&gt; [Type] -&gt; LambdaT rep
</span><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-var">Lambda</span></a></span><span> </span><span class="annot"><span class="annottext">[Param Type]
[LParam SOACS]
</span><a href="#local-6989586621684461862"><span class="hs-identifier hs-var">params</span></a></span><span> </span><span class="annot"><span class="annottext">Body SOACS
</span><a href="#local-6989586621684461861"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684461863"><span class="hs-identifier hs-var">ts</span></a></span><span>
</span><span id="line-69"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; Exp (Rep m) -&gt; m [VName]
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m [VName]
</span><a href="Futhark.Construct.html#letTupExp"><span class="hs-identifier hs-var">letTupExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621684461885"><span class="hs-identifier hs-var">desc</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep m) -&gt; m [VName]) -&gt; Exp (Rep m) -&gt; m [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Op SOACS -&gt; ExpT SOACS
forall rep. Op rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-var">Op</span></a></span><span> </span><span class="annot"><span class="annottext">(Op SOACS -&gt; ExpT SOACS) -&gt; Op SOACS -&gt; ExpT SOACS
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; [VName] -&gt; ScremaForm SOACS -&gt; SOAC SOACS
forall rep. SubExp -&gt; [VName] -&gt; ScremaForm rep -&gt; SOAC rep
</span><a href="Futhark.IR.SOACS.SOAC.html#Screma"><span class="hs-identifier hs-var">Screma</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684461882"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684461871"><span class="hs-identifier hs-var">iota</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [VName] -&gt; [VName]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684461872"><span class="hs-identifier hs-var">res_incl_rot</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LambdaT SOACS -&gt; ScremaForm SOACS
forall rep. Lambda rep -&gt; ScremaForm rep
</span><a href="Futhark.IR.SOACS.SOAC.html#mapSOAC"><span class="hs-identifier hs-var">mapSOAC</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT SOACS
</span><a href="#local-6989586621684461847"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-71"></span><span>    </span><span id="local-6989586621684461848"><span class="annot"><span class="annottext">nes :: [SubExp]
</span><a href="#local-6989586621684461848"><span class="hs-identifier hs-var hs-var">nes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Scan SOACS -&gt; [SubExp]
forall rep. Scan rep -&gt; [SubExp]
</span><a href="Futhark.IR.SOACS.SOAC.html#scanNeutral"><span class="hs-identifier hs-var hs-var">scanNeutral</span></a></span><span> </span><span class="annot"><span class="annottext">Scan SOACS
</span><a href="#local-6989586621684461884"><span class="hs-identifier hs-var">scan</span></a></span><span>
</span><span id="line-72"></span><span>    </span><span id="local-6989586621684461863"><span class="annot"><span class="annottext">ts :: [Type]
</span><a href="#local-6989586621684461863"><span class="hs-identifier hs-var hs-var">ts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LambdaT SOACS -&gt; [Type]
forall rep. LambdaT rep -&gt; [Type]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">(LambdaT SOACS -&gt; [Type]) -&gt; LambdaT SOACS -&gt; [Type]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Scan SOACS -&gt; LambdaT SOACS
forall rep. Scan rep -&gt; Lambda rep
</span><a href="Futhark.IR.SOACS.SOAC.html#scanLambda"><span class="hs-identifier hs-var hs-var">scanLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Scan SOACS
</span><a href="#local-6989586621684461884"><span class="hs-identifier hs-var">scan</span></a></span><span>
</span><span id="line-73"></span><span>
</span><span id="line-74"></span><span class="annot"><a href="Futhark.AD.Rev.Reduce.html#mkF"><span class="hs-identifier hs-type">mkF</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.AD.Rev.Monad.html#ADM"><span class="hs-identifier hs-type">ADM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-75"></span><span id="mkF"><span class="annot"><span class="annottext">mkF :: LambdaT SOACS -&gt; ADM ([VName], LambdaT SOACS)
</span><a href="Futhark.AD.Rev.Reduce.html#mkF"><span class="hs-identifier hs-var hs-var">mkF</span></a></span></span><span> </span><span id="local-6989586621684461839"><span class="annot"><span class="annottext">LambdaT SOACS
</span><a href="#local-6989586621684461839"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-76"></span><span>  </span><span id="local-6989586621684461838"><span class="annot"><span class="annottext">LambdaT SOACS
</span><a href="#local-6989586621684461838"><span class="hs-identifier hs-var">lam_l</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LambdaT SOACS -&gt; ADM (LambdaT SOACS)
forall rep (m :: * -&gt; *).
(Renameable rep, MonadFreshNames m) =&gt;
Lambda rep -&gt; m (Lambda rep)
</span><a href="Futhark.Transform.Rename.html#renameLambda"><span class="hs-identifier hs-var">renameLambda</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT SOACS
</span><a href="#local-6989586621684461839"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-77"></span><span>  </span><span id="local-6989586621684461836"><span class="annot"><span class="annottext">LambdaT SOACS
</span><a href="#local-6989586621684461836"><span class="hs-identifier hs-var">lam_r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LambdaT SOACS -&gt; ADM (LambdaT SOACS)
forall rep (m :: * -&gt; *).
(Renameable rep, MonadFreshNames m) =&gt;
Lambda rep -&gt; m (Lambda rep)
</span><a href="Futhark.Transform.Rename.html#renameLambda"><span class="hs-identifier hs-var">renameLambda</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT SOACS
</span><a href="#local-6989586621684461839"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-78"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684461835"><span class="annot"><span class="annottext">q :: Int
</span><a href="#local-6989586621684461835"><span class="hs-identifier hs-var hs-var">q</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">([Type] -&gt; Int) -&gt; [Type] -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LambdaT SOACS -&gt; [Type]
forall rep. LambdaT rep -&gt; [Type]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT SOACS
</span><a href="#local-6989586621684461839"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-79"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684461833"><span class="annot"><span class="annottext">[Param Type]
</span><a href="#local-6989586621684461833"><span class="hs-identifier hs-var">lps</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684461832"><span class="annot"><span class="annottext">[Param Type]
</span><a href="#local-6989586621684461832"><span class="hs-identifier hs-var">aps</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Param Type] -&gt; ([Param Type], [Param Type])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684461835"><span class="hs-identifier hs-var">q</span></a></span><span> </span><span class="annot"><span class="annottext">([Param Type] -&gt; ([Param Type], [Param Type]))
-&gt; [Param Type] -&gt; ([Param Type], [Param Type])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LambdaT SOACS -&gt; [LParam SOACS]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT SOACS
</span><a href="#local-6989586621684461838"><span class="hs-identifier hs-var">lam_l</span></a></span><span>
</span><span id="line-80"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684461829"><span class="annot"><span class="annottext">[Param Type]
</span><a href="#local-6989586621684461829"><span class="hs-identifier hs-var">ips</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684461828"><span class="annot"><span class="annottext">[Param Type]
</span><a href="#local-6989586621684461828"><span class="hs-identifier hs-var">rps</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Param Type] -&gt; ([Param Type], [Param Type])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684461835"><span class="hs-identifier hs-var">q</span></a></span><span> </span><span class="annot"><span class="annottext">([Param Type] -&gt; ([Param Type], [Param Type]))
-&gt; [Param Type] -&gt; ([Param Type], [Param Type])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LambdaT SOACS -&gt; [LParam SOACS]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT SOACS
</span><a href="#local-6989586621684461836"><span class="hs-identifier hs-var">lam_r</span></a></span><span>
</span><span id="line-81"></span><span>  </span><span id="local-6989586621684461827"><span class="annot"><span class="annottext">LambdaT SOACS
</span><a href="#local-6989586621684461827"><span class="hs-identifier hs-var">lam'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[LParam (Rep ADM)] -&gt; ADM Result -&gt; ADM (Lambda (Rep ADM))
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[LParam (Rep m)] -&gt; m Result -&gt; m (Lambda (Rep m))
</span><a href="Futhark.Construct.html#mkLambda"><span class="hs-identifier hs-var">mkLambda</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param Type]
</span><a href="#local-6989586621684461833"><span class="hs-identifier hs-var">lps</span></a></span><span> </span><span class="annot"><span class="annottext">[Param Type] -&gt; [Param Type] -&gt; [Param Type]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Param Type]
</span><a href="#local-6989586621684461832"><span class="hs-identifier hs-var">aps</span></a></span><span> </span><span class="annot"><span class="annottext">[Param Type] -&gt; [Param Type] -&gt; [Param Type]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Param Type]
</span><a href="#local-6989586621684461828"><span class="hs-identifier hs-var">rps</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ADM Result -&gt; ADM (Lambda (Rep ADM)))
-&gt; ADM Result -&gt; ADM (Lambda (Rep ADM))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-82"></span><span>    </span><span id="local-6989586621684461825"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684461825"><span class="hs-identifier hs-var">lam_l_res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Body (Rep ADM) -&gt; ADM Result
forall (m :: * -&gt; *). MonadBuilder m =&gt; Body (Rep m) -&gt; m Result
</span><a href="Futhark.Builder.Class.html#bodyBind"><span class="hs-identifier hs-var">bodyBind</span></a></span><span> </span><span class="annot"><span class="annottext">(Body (Rep ADM) -&gt; ADM Result) -&gt; Body (Rep ADM) -&gt; ADM Result
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LambdaT SOACS -&gt; Body SOACS
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT SOACS
</span><a href="#local-6989586621684461838"><span class="hs-identifier hs-var">lam_l</span></a></span><span>
</span><span id="line-83"></span><span>    </span><span class="annot"><span class="annottext">[(Param Type, SubExpRes)]
-&gt; ((Param Type, SubExpRes) -&gt; ADM ()) -&gt; ADM ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param Type] -&gt; Result -&gt; [(Param Type, SubExpRes)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Param Type]
</span><a href="#local-6989586621684461829"><span class="hs-identifier hs-var">ips</span></a></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684461825"><span class="hs-identifier hs-var">lam_l_res</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Param Type, SubExpRes) -&gt; ADM ()) -&gt; ADM ())
-&gt; ((Param Type, SubExpRes) -&gt; ADM ()) -&gt; ADM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684461821"><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684461821"><span class="hs-identifier hs-var">ip</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-type">SubExpRes</span></a></span><span> </span><span id="local-6989586621684461819"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684461819"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span id="local-6989586621684461818"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684461818"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-84"></span><span>      </span><span class="annot"><span class="annottext">Certs -&gt; ADM () -&gt; ADM ()
forall (m :: * -&gt; *) a. MonadBuilder m =&gt; Certs -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#certifying"><span class="hs-identifier hs-var">certifying</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684461819"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">(ADM () -&gt; ADM ()) -&gt; ADM () -&gt; ADM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Exp (Rep ADM) -&gt; ADM ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[VName] -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBindNames"><span class="hs-identifier hs-var">letBindNames</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Param Type -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684461821"><span class="hs-identifier hs-var">ip</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(Exp (Rep ADM) -&gt; ADM ()) -&gt; Exp (Rep ADM) -&gt; ADM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT SOACS
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT SOACS) -&gt; BasicOp -&gt; ExpT SOACS
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#SubExp"><span class="hs-identifier hs-var">SubExp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684461818"><span class="hs-identifier hs-var">se</span></a></span><span>
</span><span id="line-85"></span><span>    </span><span class="annot"><span class="annottext">Body (Rep ADM) -&gt; ADM Result
forall (m :: * -&gt; *). MonadBuilder m =&gt; Body (Rep m) -&gt; m Result
</span><a href="Futhark.Builder.Class.html#bodyBind"><span class="hs-identifier hs-var">bodyBind</span></a></span><span> </span><span class="annot"><span class="annottext">(Body (Rep ADM) -&gt; ADM Result) -&gt; Body (Rep ADM) -&gt; ADM Result
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LambdaT SOACS -&gt; Body SOACS
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT SOACS
</span><a href="#local-6989586621684461836"><span class="hs-identifier hs-var">lam_r</span></a></span><span>
</span><span id="line-86"></span><span>  </span><span class="annot"><span class="annottext">([VName], LambdaT SOACS) -&gt; ADM ([VName], LambdaT SOACS)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Param Type -&gt; VName) -&gt; [Param Type] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Param Type -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">[Param Type]
</span><a href="#local-6989586621684461832"><span class="hs-identifier hs-var">aps</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">LambdaT SOACS
</span><a href="#local-6989586621684461827"><span class="hs-identifier hs-var">lam'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-87"></span><span>
</span><span id="line-88"></span><span class="annot"><a href="Futhark.AD.Rev.Reduce.html#diffReduce"><span class="hs-identifier hs-type">diffReduce</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.AD.Rev.Monad.html#VjpOps"><span class="hs-identifier hs-type">VjpOps</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Reduce"><span class="hs-identifier hs-type">Reduce</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.AD.Rev.Monad.html#ADM"><span class="hs-identifier hs-type">ADM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-89"></span><span id="diffReduce"><span class="annot"><span class="annottext">diffReduce :: VjpOps -&gt; [VName] -&gt; SubExp -&gt; [VName] -&gt; Reduce SOACS -&gt; ADM ()
</span><a href="Futhark.AD.Rev.Reduce.html#diffReduce"><span class="hs-identifier hs-var hs-var">diffReduce</span></a></span></span><span> </span><span id="local-6989586621684461814"><span class="annot"><span class="annottext">VjpOps
</span><a href="#local-6989586621684461814"><span class="hs-identifier hs-var">_ops</span></a></span></span><span> </span><span class="hs-special">[</span><span id="local-6989586621684461813"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684461813"><span class="hs-identifier hs-var">adj</span></a></span></span><span class="hs-special">]</span><span> </span><span id="local-6989586621684461812"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684461812"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span class="hs-special">[</span><span id="local-6989586621684461811"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684461811"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">]</span><span> </span><span id="local-6989586621684461810"><span class="annot"><span class="annottext">Reduce SOACS
</span><a href="#local-6989586621684461810"><span class="hs-identifier hs-var">red</span></a></span></span><span>
</span><span id="line-90"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span id="local-6989586621684461809"><span class="annot"><span class="annottext">BinOp
</span><a href="#local-6989586621684461809"><span class="hs-identifier hs-var">op</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PrimType
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LambdaT SOACS -&gt; Maybe [(BinOp, PrimType, VName, VName)]
forall rep.
ASTRep rep =&gt;
Lambda rep -&gt; Maybe [(BinOp, PrimType, VName, VName)]
</span><a href="Futhark.IR.Prop.html#lamIsBinOp"><span class="hs-identifier hs-var">lamIsBinOp</span></a></span><span> </span><span class="annot"><span class="annottext">(LambdaT SOACS -&gt; Maybe [(BinOp, PrimType, VName, VName)])
-&gt; LambdaT SOACS -&gt; Maybe [(BinOp, PrimType, VName, VName)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Reduce SOACS -&gt; LambdaT SOACS
forall rep. Reduce rep -&gt; Lambda rep
</span><a href="Futhark.IR.SOACS.SOAC.html#redLambda"><span class="hs-identifier hs-var hs-var">redLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Reduce SOACS
</span><a href="#local-6989586621684461810"><span class="hs-identifier hs-var">red</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-91"></span><span>    </span><span class="annot"><span class="annottext">BinOp -&gt; Bool
</span><a href="#local-6989586621684461806"><span class="hs-identifier hs-var">isAdd</span></a></span><span> </span><span class="annot"><span class="annottext">BinOp
</span><a href="#local-6989586621684461809"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-92"></span><span>    </span><span id="local-6989586621684461805"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684461805"><span class="hs-identifier hs-var">adj_rep</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-93"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; Exp (Rep ADM) -&gt; ADM VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m VName
</span><a href="Futhark.Construct.html#letExp"><span class="hs-identifier hs-var">letExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; String
</span><a href="Language.Futhark.Core.html#baseString"><span class="hs-identifier hs-var">baseString</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684461813"><span class="hs-identifier hs-var">adj</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_rep&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Exp (Rep ADM) -&gt; ADM VName) -&gt; Exp (Rep ADM) -&gt; ADM VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-94"></span><span>        </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT SOACS
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT SOACS) -&gt; BasicOp -&gt; ExpT SOACS
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ShapeBase SubExp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Replicate"><span class="hs-identifier hs-var">Replicate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; ShapeBase SubExp
forall d. [d] -&gt; ShapeBase d
</span><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-var">Shape</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684461812"><span class="hs-identifier hs-var">w</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; BasicOp) -&gt; SubExp -&gt; BasicOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684461813"><span class="hs-identifier hs-var">adj</span></a></span><span>
</span><span id="line-95"></span><span>    </span><span class="annot"><span class="annottext">ADM () -&gt; ADM ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(ADM () -&gt; ADM ()) -&gt; ADM () -&gt; ADM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; VName -&gt; ADM ()
</span><a href="Futhark.AD.Rev.Monad.html#updateAdj"><span class="hs-identifier hs-var">updateAdj</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684461811"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684461805"><span class="hs-identifier hs-var">adj_rep</span></a></span><span>
</span><span id="line-96"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-97"></span><span>    </span><span id="local-6989586621684461806"><span class="annot"><span class="annottext">isAdd :: BinOp -&gt; Bool
</span><a href="#local-6989586621684461806"><span class="hs-identifier hs-var hs-var">isAdd</span></a></span></span><span> </span><span class="annot"><a href="Futhark.IR.Primitive.html#FAdd"><span class="hs-identifier hs-type">FAdd</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-98"></span><span>    </span><span class="annot"><a href="#local-6989586621684461806"><span class="hs-identifier hs-var">isAdd</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Primitive.html#Add"><span class="hs-identifier hs-type">Add</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-99"></span><span>    </span><span class="annot"><a href="#local-6989586621684461806"><span class="hs-identifier hs-var">isAdd</span></a></span><span> </span><span class="annot"><span class="annottext">BinOp
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-100"></span><span class="hs-comment">--</span><span>
</span><span id="line-101"></span><span class="hs-comment">-- Differentiating a general single reduce:</span><span>
</span><span id="line-102"></span><span class="hs-comment">--    let y = reduce \odot ne as</span><span>
</span><span id="line-103"></span><span class="hs-comment">-- Forward sweep:</span><span>
</span><span id="line-104"></span><span class="hs-comment">--    let ls = scan_exc \odot  ne as</span><span>
</span><span id="line-105"></span><span class="hs-comment">--    let rs = scan_exc \odot' ne (reverse as)</span><span>
</span><span id="line-106"></span><span class="hs-comment">-- Reverse sweep:</span><span>
</span><span id="line-107"></span><span class="hs-comment">--    let as_c = map3 (f_bar y_bar) ls as (reverse rs)</span><span>
</span><span id="line-108"></span><span class="hs-comment">-- where</span><span>
</span><span id="line-109"></span><span class="hs-comment">--   x \odot' y = y \odot x</span><span>
</span><span id="line-110"></span><span class="hs-comment">--   y_bar is the adjoint of the result y</span><span>
</span><span id="line-111"></span><span class="hs-comment">--   f l_i a_i r_i = l_i \odot a_i \odot r_i</span><span>
</span><span id="line-112"></span><span class="hs-comment">--   f_bar = the reverse diff of f with respect to a_i under the adjoint y_bar</span><span>
</span><span id="line-113"></span><span class="hs-comment">-- The plan is to create</span><span>
</span><span id="line-114"></span><span class="hs-comment">--   one scanomap SOAC which computes ls and rs</span><span>
</span><span id="line-115"></span><span class="hs-comment">--   another map which computes as_c</span><span>
</span><span id="line-116"></span><span class="hs-comment">--</span><span>
</span><span id="line-117"></span><span class="annot"><a href="Futhark.AD.Rev.Reduce.html#diffReduce"><span class="hs-identifier hs-var">diffReduce</span></a></span><span> </span><span id="local-6989586621684461798"><span class="annot"><span class="annottext">VjpOps
</span><a href="#local-6989586621684461798"><span class="hs-identifier hs-var">ops</span></a></span></span><span> </span><span id="local-6989586621684461797"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684461797"><span class="hs-identifier hs-var">pat_adj</span></a></span></span><span> </span><span id="local-6989586621684461796"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684461796"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621684461795"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684461795"><span class="hs-keyword hs-var">as</span></a></span></span><span> </span><span id="local-6989586621684461794"><span class="annot"><span class="annottext">Reduce SOACS
</span><a href="#local-6989586621684461794"><span class="hs-identifier hs-var">red</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-118"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684461793"><span class="annot"><span class="annottext">LambdaT SOACS
</span><a href="#local-6989586621684461793"><span class="hs-identifier hs-var">lam0</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684461792"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684461792"><span class="hs-identifier hs-var">ne</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Reduce SOACS -&gt; LambdaT SOACS
forall rep. Reduce rep -&gt; Lambda rep
</span><a href="Futhark.IR.SOACS.SOAC.html#redLambda"><span class="hs-identifier hs-var hs-var">redLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Reduce SOACS
</span><a href="#local-6989586621684461794"><span class="hs-identifier hs-var">red</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Reduce SOACS -&gt; [SubExp]
forall rep. Reduce rep -&gt; [SubExp]
</span><a href="Futhark.IR.SOACS.SOAC.html#redNeutral"><span class="hs-identifier hs-var hs-var">redNeutral</span></a></span><span> </span><span class="annot"><span class="annottext">Reduce SOACS
</span><a href="#local-6989586621684461794"><span class="hs-identifier hs-var">red</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-119"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684461790"><span class="annot"><span class="annottext">alphas :: [Type]
</span><a href="#local-6989586621684461790"><span class="hs-identifier hs-var hs-var">alphas</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LambdaT SOACS -&gt; [Type]
forall rep. LambdaT rep -&gt; [Type]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT SOACS
</span><a href="#local-6989586621684461793"><span class="hs-identifier hs-var">lam0</span></a></span><span>
</span><span id="line-120"></span><span>  </span><span id="local-6989586621684461789"><span class="annot"><span class="annottext">LambdaT SOACS
</span><a href="#local-6989586621684461789"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LambdaT SOACS -&gt; ADM (LambdaT SOACS)
forall rep (m :: * -&gt; *).
(Renameable rep, MonadFreshNames m) =&gt;
Lambda rep -&gt; m (Lambda rep)
</span><a href="Futhark.Transform.Rename.html#renameLambda"><span class="hs-identifier hs-var">renameLambda</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT SOACS
</span><a href="#local-6989586621684461793"><span class="hs-identifier hs-var">lam0</span></a></span><span>
</span><span id="line-121"></span><span>  </span><span id="local-6989586621684461788"><span class="annot"><span class="annottext">LambdaT SOACS
</span><a href="#local-6989586621684461788"><span class="hs-identifier hs-var">lam'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LambdaT SOACS -&gt; ADM (LambdaT SOACS)
forall rep (m :: * -&gt; *).
(Renameable rep, MonadFreshNames m) =&gt;
Lambda rep -&gt; m (Lambda rep)
</span><a href="Futhark.Transform.Rename.html#renameLambda"><span class="hs-identifier hs-var">renameLambda</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT SOACS
</span><a href="#local-6989586621684461793"><span class="hs-identifier hs-var">lam0</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">lambdaParams :: [LParam SOACS]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var">lambdaParams</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Param Type] -&gt; [Param Type]
forall {a}. [a] -&gt; [a]
</span><a href="#local-6989586621684461787"><span class="hs-identifier hs-var">flipParams</span></a></span><span> </span><span class="annot"><span class="annottext">([Param Type] -&gt; [Param Type]) -&gt; [Param Type] -&gt; [Param Type]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LambdaT SOACS -&gt; [LParam SOACS]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT SOACS
</span><a href="#local-6989586621684461793"><span class="hs-identifier hs-var">lam0</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-122"></span><span>  </span><span id="local-6989586621684461786"><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684461786"><span class="hs-identifier hs-var">par_i</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; Type -&gt; ADM (Param Type)
forall (m :: * -&gt; *) dec.
MonadFreshNames m =&gt;
String -&gt; dec -&gt; m (Param dec)
</span><a href="Futhark.MonadFreshNames.html#newParam"><span class="hs-identifier hs-var">newParam</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;i&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; ADM (Param Type)) -&gt; Type -&gt; ADM (Param Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; Type
forall shape u. PrimType -&gt; TypeBase shape u
</span><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int64"><span class="hs-identifier hs-var">int64</span></a></span><span>
</span><span id="line-123"></span><span>  </span><span class="hs-comment">-- phase1: build the scanomap soac</span><span>
</span><span id="line-124"></span><span>  </span><span id="local-6989586621684461785"><span class="annot"><span class="annottext">Body SOACS
</span><a href="#local-6989586621684461785"><span class="hs-identifier hs-var">g_bdy</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Param Type -&gt; [SubExp] -&gt; [Type] -&gt; ADM (Body SOACS)
</span><a href="#local-6989586621684461784"><span class="hs-identifier hs-var">mkFusedMapBody</span></a></span><span> </span><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684461786"><span class="hs-identifier hs-var">par_i</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684461792"><span class="hs-identifier hs-var">ne</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684461790"><span class="hs-identifier hs-var">alphas</span></a></span><span>
</span><span id="line-125"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684461783"><span class="annot"><span class="annottext">g_lam :: LambdaT SOACS
</span><a href="#local-6989586621684461783"><span class="hs-identifier hs-var hs-var">g_lam</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[LParam SOACS] -&gt; Body SOACS -&gt; [Type] -&gt; LambdaT SOACS
forall rep. [LParam rep] -&gt; BodyT rep -&gt; [Type] -&gt; LambdaT rep
</span><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-var">Lambda</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Param Type
LParam SOACS
</span><a href="#local-6989586621684461786"><span class="hs-identifier hs-var">par_i</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Body SOACS
</span><a href="#local-6989586621684461785"><span class="hs-identifier hs-var">g_bdy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684461790"><span class="hs-identifier hs-var">alphas</span></a></span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; [Type] -&gt; [Type]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684461790"><span class="hs-identifier hs-var">alphas</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-126"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684461782"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684461782"><span class="hs-identifier hs-var">r_scan</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684461781"><span class="annot"><span class="annottext">Stms SOACS
</span><a href="#local-6989586621684461781"><span class="hs-identifier hs-var">scan_stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">BuilderT SOACS ADM [VName] -&gt; ADM ([VName], Stms SOACS)
forall (m :: * -&gt; *) somerep rep a.
(MonadFreshNames m, HasScope somerep m, SameScope somerep rep) =&gt;
BuilderT rep m a -&gt; m (a, Stms rep)
</span><a href="Futhark.Builder.html#runBuilderT%27"><span class="hs-identifier hs-var">runBuilderT'</span></a></span><span> </span><span class="annot"><span class="annottext">(BuilderT SOACS ADM [VName] -&gt; ADM ([VName], Stms SOACS))
-&gt; BuilderT SOACS ADM [VName] -&gt; ADM ([VName], Stms SOACS)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-127"></span><span>    </span><span id="local-6989586621684461779"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684461779"><span class="hs-identifier hs-var">iota</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String
-&gt; Exp (Rep (BuilderT SOACS ADM)) -&gt; BuilderT SOACS ADM VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m VName
</span><a href="Futhark.Construct.html#letExp"><span class="hs-identifier hs-var">letExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;iota&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (BuilderT SOACS ADM)) -&gt; BuilderT SOACS ADM VName)
-&gt; Exp (Rep (BuilderT SOACS ADM)) -&gt; BuilderT SOACS ADM VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT SOACS
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT SOACS) -&gt; BasicOp -&gt; ExpT SOACS
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; SubExp -&gt; SubExp -&gt; IntType -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Iota"><span class="hs-identifier hs-var">Iota</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684461796"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684461778"><span class="hs-identifier hs-var">se0</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684461777"><span class="hs-identifier hs-var">se1</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span>
</span><span id="line-128"></span><span>    </span><span class="annot"><span class="annottext">String
-&gt; Exp (Rep (BuilderT SOACS ADM)) -&gt; BuilderT SOACS ADM [VName]
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m [VName]
</span><a href="Futhark.Construct.html#letTupExp"><span class="hs-identifier hs-var">letTupExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;adj_ctrb_scan&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (BuilderT SOACS ADM)) -&gt; BuilderT SOACS ADM [VName])
-&gt; Exp (Rep (BuilderT SOACS ADM)) -&gt; BuilderT SOACS ADM [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-129"></span><span>      </span><span class="annot"><span class="annottext">Op SOACS -&gt; ExpT SOACS
forall rep. Op rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-var">Op</span></a></span><span> </span><span class="annot"><span class="annottext">(Op SOACS -&gt; ExpT SOACS) -&gt; Op SOACS -&gt; ExpT SOACS
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-130"></span><span>        </span><span class="annot"><span class="annottext">SubExp -&gt; [VName] -&gt; ScremaForm SOACS -&gt; SOAC SOACS
forall rep. SubExp -&gt; [VName] -&gt; ScremaForm rep -&gt; SOAC rep
</span><a href="Futhark.IR.SOACS.SOAC.html#Screma"><span class="hs-identifier hs-var">Screma</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684461796"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684461779"><span class="hs-identifier hs-var">iota</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(ScremaForm SOACS -&gt; SOAC SOACS) -&gt; ScremaForm SOACS -&gt; SOAC SOACS
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Scan SOACS] -&gt; [Reduce SOACS] -&gt; LambdaT SOACS -&gt; ScremaForm SOACS
forall rep.
[Scan rep] -&gt; [Reduce rep] -&gt; Lambda rep -&gt; ScremaForm rep
</span><a href="Futhark.IR.SOACS.SOAC.html#ScremaForm"><span class="hs-identifier hs-var">ScremaForm</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">LambdaT SOACS -&gt; [SubExp] -&gt; Scan SOACS
forall rep. Lambda rep -&gt; [SubExp] -&gt; Scan rep
</span><a href="Futhark.IR.SOACS.SOAC.html#Scan"><span class="hs-identifier hs-var">Scan</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT SOACS
</span><a href="#local-6989586621684461789"><span class="hs-identifier hs-var">lam</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684461792"><span class="hs-identifier hs-var">ne</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">LambdaT SOACS -&gt; [SubExp] -&gt; Scan SOACS
forall rep. Lambda rep -&gt; [SubExp] -&gt; Scan rep
</span><a href="Futhark.IR.SOACS.SOAC.html#Scan"><span class="hs-identifier hs-var">Scan</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT SOACS
</span><a href="#local-6989586621684461788"><span class="hs-identifier hs-var">lam'</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684461792"><span class="hs-identifier hs-var">ne</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">LambdaT SOACS
</span><a href="#local-6989586621684461783"><span class="hs-identifier hs-var">g_lam</span></a></span><span>
</span><span id="line-131"></span><span>  </span><span class="annot"><span class="annottext">Stms (Rep ADM) -&gt; ADM ()
forall (m :: * -&gt; *). MonadBuilder m =&gt; Stms (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#addStms"><span class="hs-identifier hs-var">addStms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms (Rep ADM)
Stms SOACS
</span><a href="#local-6989586621684461781"><span class="hs-identifier hs-var">scan_stms</span></a></span><span>
</span><span id="line-132"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684461773"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684461773"><span class="hs-identifier hs-var">ls_arr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684461772"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684461772"><span class="hs-identifier hs-var">rs_arr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [VName] -&gt; ([VName], [VName])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684461792"><span class="hs-identifier hs-var">ne</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684461782"><span class="hs-identifier hs-var">r_scan</span></a></span><span>
</span><span id="line-133"></span><span>  </span><span class="hs-comment">-- phase2: build the following map:</span><span>
</span><span id="line-134"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684461771"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684461771"><span class="hs-identifier hs-var">as_params</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684461770"><span class="annot"><span class="annottext">LambdaT SOACS
</span><a href="#local-6989586621684461770"><span class="hs-identifier hs-var">f</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LambdaT SOACS -&gt; ADM ([VName], LambdaT SOACS)
</span><a href="Futhark.AD.Rev.Reduce.html#mkF"><span class="hs-identifier hs-var">mkF</span></a></span><span> </span><span class="annot"><span class="annottext">(LambdaT SOACS -&gt; ADM ([VName], LambdaT SOACS))
-&gt; LambdaT SOACS -&gt; ADM ([VName], LambdaT SOACS)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Reduce SOACS -&gt; LambdaT SOACS
forall rep. Reduce rep -&gt; Lambda rep
</span><a href="Futhark.IR.SOACS.SOAC.html#redLambda"><span class="hs-identifier hs-var hs-var">redLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Reduce SOACS
</span><a href="#local-6989586621684461794"><span class="hs-identifier hs-var">red</span></a></span><span>
</span><span id="line-135"></span><span>  </span><span id="local-6989586621684461769"><span class="annot"><span class="annottext">LambdaT SOACS
</span><a href="#local-6989586621684461769"><span class="hs-identifier hs-var">f_adj</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VjpOps -&gt; [Adj] -&gt; [VName] -&gt; LambdaT SOACS -&gt; ADM (LambdaT SOACS)
</span><a href="Futhark.AD.Rev.Monad.html#vjpLambda"><span class="hs-identifier hs-var hs-var">vjpLambda</span></a></span><span> </span><span class="annot"><span class="annottext">VjpOps
</span><a href="#local-6989586621684461798"><span class="hs-identifier hs-var">ops</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(VName -&gt; Adj) -&gt; [VName] -&gt; [Adj]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Adj
</span><a href="Futhark.AD.Rev.Monad.html#adjFromVar"><span class="hs-identifier hs-var">adjFromVar</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684461797"><span class="hs-identifier hs-var">pat_adj</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684461771"><span class="hs-identifier hs-var">as_params</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT SOACS
</span><a href="#local-6989586621684461770"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-136"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-137"></span><span>  </span><span id="local-6989586621684461766"><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684461766"><span class="hs-identifier hs-var">par_i'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; Type -&gt; ADM (Param Type)
forall (m :: * -&gt; *) dec.
MonadFreshNames m =&gt;
String -&gt; dec -&gt; m (Param dec)
</span><a href="Futhark.MonadFreshNames.html#newParam"><span class="hs-identifier hs-var">newParam</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;i&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; ADM (Param Type)) -&gt; Type -&gt; ADM (Param Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; Type
forall shape u. PrimType -&gt; TypeBase shape u
</span><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int64"><span class="hs-identifier hs-var">int64</span></a></span><span>
</span><span id="line-138"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684461765"><span class="annot"><span class="annottext">i' :: VName
</span><a href="#local-6989586621684461765"><span class="hs-identifier hs-var hs-var">i'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Param Type -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684461766"><span class="hs-identifier hs-var">par_i'</span></a></span><span>
</span><span id="line-139"></span><span>      </span><span id="local-6989586621684461764"><span class="annot"><span class="annottext">f_adj_params :: [LParam SOACS]
</span><a href="#local-6989586621684461764"><span class="hs-identifier hs-var hs-var">f_adj_params</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LambdaT SOACS -&gt; [LParam SOACS]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT SOACS
</span><a href="#local-6989586621684461769"><span class="hs-identifier hs-var">f_adj</span></a></span><span>
</span><span id="line-140"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684461763"><span class="annot"><span class="annottext">[Param Type]
</span><a href="#local-6989586621684461763"><span class="hs-identifier hs-var">ls_as_ps</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684461762"><span class="annot"><span class="annottext">[Param Type]
</span><a href="#local-6989586621684461762"><span class="hs-identifier hs-var">rs_ps</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Param Type] -&gt; ([Param Type], [Param Type])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684461792"><span class="hs-identifier hs-var">ne</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Param Type]
[LParam SOACS]
</span><a href="#local-6989586621684461764"><span class="hs-identifier hs-var">f_adj_params</span></a></span><span>
</span><span id="line-141"></span><span>      </span><span id="local-6989586621684461760"><span class="annot"><span class="annottext">scp_params :: [Param Type]
</span><a href="#local-6989586621684461760"><span class="hs-identifier hs-var hs-var">scp_params</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684461766"><span class="hs-identifier hs-var">par_i'</span></a></span><span> </span><span class="annot"><span class="annottext">Param Type -&gt; [Param Type] -&gt; [Param Type]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Param Type]
</span><a href="#local-6989586621684461763"><span class="hs-identifier hs-var">ls_as_ps</span></a></span><span> </span><span class="annot"><span class="annottext">[Param Type] -&gt; [Param Type] -&gt; [Param Type]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Type -&gt; Param Type) -&gt; [VName] -&gt; [Type] -&gt; [Param Type]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Attrs -&gt; VName -&gt; Type -&gt; Param Type
forall dec. Attrs -&gt; VName -&gt; dec -&gt; Param dec
</span><a href="Futhark.IR.Syntax.Core.html#Param"><span class="hs-identifier hs-var">Param</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684461797"><span class="hs-identifier hs-var">pat_adj</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684461790"><span class="hs-identifier hs-var">alphas</span></a></span><span>
</span><span id="line-142"></span><span>  </span><span id="local-6989586621684461757"><span class="annot"><span class="annottext">Body SOACS
</span><a href="#local-6989586621684461757"><span class="hs-identifier hs-var">f_adj_body</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Builder SOACS (Body SOACS) -&gt; ADM (Body SOACS)
forall rep (m :: * -&gt; *) somerep.
(Buildable rep, MonadFreshNames m, HasScope somerep m,
 SameScope somerep rep) =&gt;
Builder rep (Body rep) -&gt; m (Body rep)
</span><a href="Futhark.Builder.html#runBodyBuilder"><span class="hs-identifier hs-var">runBodyBuilder</span></a></span><span> </span><span class="annot"><span class="annottext">(Builder SOACS (Body SOACS) -&gt; ADM (Body SOACS))
-&gt; (Builder SOACS (Body SOACS) -&gt; Builder SOACS (Body SOACS))
-&gt; Builder SOACS (Body SOACS)
-&gt; ADM (Body SOACS)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Scope SOACS
-&gt; Builder SOACS (Body SOACS) -&gt; Builder SOACS (Body SOACS)
forall rep (m :: * -&gt; *) a.
LocalScope rep m =&gt;
Scope rep -&gt; m a -&gt; m a
</span><a href="Futhark.IR.Prop.Scope.html#localScope"><span class="hs-identifier hs-var">localScope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param Type] -&gt; Scope SOACS
forall rep dec. (LParamInfo rep ~ dec) =&gt; [Param dec] -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOfLParams"><span class="hs-identifier hs-var">scopeOfLParams</span></a></span><span> </span><span class="annot"><span class="annottext">[Param Type]
</span><a href="#local-6989586621684461760"><span class="hs-identifier hs-var">scp_params</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Builder SOACS (Body SOACS) -&gt; ADM (Body SOACS))
-&gt; Builder SOACS (Body SOACS) -&gt; ADM (Body SOACS)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-143"></span><span>    </span><span id="local-6989586621684461756"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684461756"><span class="hs-identifier hs-var">nmim1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String
-&gt; Exp (Rep (BuilderT SOACS (State VNameSource)))
-&gt; BuilderT SOACS (State VNameSource) SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;n_i_1&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ExpT SOACS -&gt; BuilderT SOACS (State VNameSource) SubExp)
-&gt; BuilderT SOACS (State VNameSource) (ExpT SOACS)
-&gt; BuilderT SOACS (State VNameSource) SubExp
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; BuilderT
     SOACS
     (State VNameSource)
     (Exp (Rep (BuilderT SOACS (State VNameSource))))
forall a (m :: * -&gt; *).
(ToExp a, MonadBuilder m) =&gt;
a -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#toExp"><span class="hs-identifier hs-var">toExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp -&gt; TPrimExp Int64 VName
</span><a href="Futhark.Analysis.PrimExp.Convert.html#pe64"><span class="hs-identifier hs-var">pe64</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684461796"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; TPrimExp Int64 VName
forall a. a -&gt; TPrimExp Int64 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le64"><span class="hs-identifier hs-var">le64</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684461765"><span class="hs-identifier hs-var">i'</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TPrimExp Int64 VName
</span><a href="Futhark.Analysis.PrimExp.Convert.html#pe64"><span class="hs-identifier hs-var">pe64</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684461777"><span class="hs-identifier hs-var">se1</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-144"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684461750"><span class="annot"><span class="annottext">idx_stms :: [Stm SOACS]
</span><a href="#local-6989586621684461750"><span class="hs-identifier hs-var hs-var">idx_stms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Type, VName, VName) -&gt; Stm SOACS)
-&gt; [(Type, VName, VName)] -&gt; [Stm SOACS]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp -&gt; (Type, VName, VName) -&gt; Stm SOACS
forall {rep}.
Buildable rep =&gt;
SubExp -&gt; (Type, VName, VName) -&gt; Stm rep
</span><a href="#local-6989586621684461749"><span class="hs-identifier hs-var">mkIdxStm</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684461756"><span class="hs-identifier hs-var">nmim1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(Type, VName, VName)] -&gt; [Stm SOACS])
-&gt; [(Type, VName, VName)] -&gt; [Stm SOACS]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; [VName] -&gt; [VName] -&gt; [(Type, VName, VName)]
forall a b c. [a] -&gt; [b] -&gt; [c] -&gt; [(a, b, c)]
</span><span class="hs-identifier hs-var">zip3</span></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684461790"><span class="hs-identifier hs-var">alphas</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684461772"><span class="hs-identifier hs-var">rs_arr</span></a></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; [(Type, VName, VName)])
-&gt; [VName] -&gt; [(Type, VName, VName)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Param Type -&gt; VName) -&gt; [Param Type] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Param Type -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">[Param Type]
</span><a href="#local-6989586621684461762"><span class="hs-identifier hs-var">rs_ps</span></a></span><span>
</span><span id="line-145"></span><span>    </span><span class="annot"><span class="annottext">Stms (Rep (BuilderT SOACS (State VNameSource)))
-&gt; BuilderT SOACS (State VNameSource) ()
forall (m :: * -&gt; *). MonadBuilder m =&gt; Stms (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#addStms"><span class="hs-identifier hs-var">addStms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Stm SOACS] -&gt; Stms SOACS
forall rep. [Stm rep] -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#stmsFromList"><span class="hs-identifier hs-var">stmsFromList</span></a></span><span> </span><span class="annot"><span class="annottext">[Stm SOACS]
</span><a href="#local-6989586621684461750"><span class="hs-identifier hs-var">idx_stms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-146"></span><span>    </span><span class="annot"><span class="annottext">Body SOACS -&gt; Builder SOACS (Body SOACS)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Body SOACS -&gt; Builder SOACS (Body SOACS))
-&gt; Body SOACS -&gt; Builder SOACS (Body SOACS)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LambdaT SOACS -&gt; Body SOACS
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT SOACS
</span><a href="#local-6989586621684461769"><span class="hs-identifier hs-var">f_adj</span></a></span><span>
</span><span id="line-147"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684461746"><span class="annot"><span class="annottext">map_lam :: LambdaT SOACS
</span><a href="#local-6989586621684461746"><span class="hs-identifier hs-var hs-var">map_lam</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[LParam SOACS] -&gt; Body SOACS -&gt; [Type] -&gt; LambdaT SOACS
forall rep. [LParam rep] -&gt; BodyT rep -&gt; [Type] -&gt; LambdaT rep
</span><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-var">Lambda</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684461766"><span class="hs-identifier hs-var">par_i'</span></a></span><span> </span><span class="annot"><span class="annottext">Param Type -&gt; [Param Type] -&gt; [Param Type]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Param Type]
</span><a href="#local-6989586621684461763"><span class="hs-identifier hs-var">ls_as_ps</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Body SOACS
</span><a href="#local-6989586621684461757"><span class="hs-identifier hs-var">f_adj_body</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684461790"><span class="hs-identifier hs-var">alphas</span></a></span><span>
</span><span id="line-148"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684461745"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684461745"><span class="hs-identifier hs-var">as_adj</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684461744"><span class="annot"><span class="annottext">Stms SOACS
</span><a href="#local-6989586621684461744"><span class="hs-identifier hs-var">map_stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">BuilderT SOACS ADM [VName] -&gt; ADM ([VName], Stms SOACS)
forall (m :: * -&gt; *) somerep rep a.
(MonadFreshNames m, HasScope somerep m, SameScope somerep rep) =&gt;
BuilderT rep m a -&gt; m (a, Stms rep)
</span><a href="Futhark.Builder.html#runBuilderT%27"><span class="hs-identifier hs-var">runBuilderT'</span></a></span><span> </span><span class="annot"><span class="annottext">(BuilderT SOACS ADM [VName] -&gt; ADM ([VName], Stms SOACS))
-&gt; BuilderT SOACS ADM [VName] -&gt; ADM ([VName], Stms SOACS)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-149"></span><span>    </span><span id="local-6989586621684461743"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684461743"><span class="hs-identifier hs-var">iota</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String
-&gt; Exp (Rep (BuilderT SOACS ADM)) -&gt; BuilderT SOACS ADM VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m VName
</span><a href="Futhark.Construct.html#letExp"><span class="hs-identifier hs-var">letExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;iota&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (BuilderT SOACS ADM)) -&gt; BuilderT SOACS ADM VName)
-&gt; Exp (Rep (BuilderT SOACS ADM)) -&gt; BuilderT SOACS ADM VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT SOACS
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT SOACS) -&gt; BasicOp -&gt; ExpT SOACS
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; SubExp -&gt; SubExp -&gt; IntType -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Iota"><span class="hs-identifier hs-var">Iota</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684461796"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684461778"><span class="hs-identifier hs-var">se0</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684461777"><span class="hs-identifier hs-var">se1</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span>
</span><span id="line-150"></span><span>    </span><span class="annot"><span class="annottext">String
-&gt; Exp (Rep (BuilderT SOACS ADM)) -&gt; BuilderT SOACS ADM [VName]
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m [VName]
</span><a href="Futhark.Construct.html#letTupExp"><span class="hs-identifier hs-var">letTupExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;adj_ctrb_scan&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (BuilderT SOACS ADM)) -&gt; BuilderT SOACS ADM [VName])
-&gt; Exp (Rep (BuilderT SOACS ADM)) -&gt; BuilderT SOACS ADM [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-151"></span><span>      </span><span class="annot"><span class="annottext">Op SOACS -&gt; ExpT SOACS
forall rep. Op rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-var">Op</span></a></span><span> </span><span class="annot"><span class="annottext">(Op SOACS -&gt; ExpT SOACS) -&gt; Op SOACS -&gt; ExpT SOACS
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-152"></span><span>        </span><span class="annot"><span class="annottext">SubExp -&gt; [VName] -&gt; ScremaForm SOACS -&gt; SOAC SOACS
forall rep. SubExp -&gt; [VName] -&gt; ScremaForm rep -&gt; SOAC rep
</span><a href="Futhark.IR.SOACS.SOAC.html#Screma"><span class="hs-identifier hs-var">Screma</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684461796"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684461743"><span class="hs-identifier hs-var">iota</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [VName] -&gt; [VName]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684461773"><span class="hs-identifier hs-var">ls_arr</span></a></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684461795"><span class="hs-keyword hs-var">as</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ScremaForm SOACS -&gt; SOAC SOACS) -&gt; ScremaForm SOACS -&gt; SOAC SOACS
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-153"></span><span>          </span><span class="annot"><span class="annottext">[Scan SOACS] -&gt; [Reduce SOACS] -&gt; LambdaT SOACS -&gt; ScremaForm SOACS
forall rep.
[Scan rep] -&gt; [Reduce rep] -&gt; Lambda rep -&gt; ScremaForm rep
</span><a href="Futhark.IR.SOACS.SOAC.html#ScremaForm"><span class="hs-identifier hs-var">ScremaForm</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">LambdaT SOACS
</span><a href="#local-6989586621684461746"><span class="hs-identifier hs-var">map_lam</span></a></span><span>
</span><span id="line-154"></span><span>  </span><span class="annot"><span class="annottext">Stms (Rep ADM) -&gt; ADM ()
forall (m :: * -&gt; *). MonadBuilder m =&gt; Stms (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#addStms"><span class="hs-identifier hs-var">addStms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms (Rep ADM)
Stms SOACS
</span><a href="#local-6989586621684461744"><span class="hs-identifier hs-var">map_stms</span></a></span><span>
</span><span id="line-155"></span><span>  </span><span class="hs-comment">-- finally add contributions to the adjoint of as</span><span>
</span><span id="line-156"></span><span>  </span><span class="annot"><span class="annottext">(VName -&gt; VName -&gt; ADM ()) -&gt; [VName] -&gt; [VName] -&gt; ADM ()
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m ()
</span><span class="hs-identifier hs-var">zipWithM_</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; VName -&gt; ADM ()
</span><a href="Futhark.AD.Rev.Monad.html#updateAdj"><span class="hs-identifier hs-var">updateAdj</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684461795"><span class="hs-keyword hs-var">as</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684461745"><span class="hs-identifier hs-var">as_adj</span></a></span><span>
</span><span id="line-157"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-158"></span><span>    </span><span id="local-6989586621684461778"><span class="annot"><span class="annottext">se0 :: SubExp
</span><a href="#local-6989586621684461778"><span class="hs-identifier hs-var hs-var">se0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IntType -&gt; Integer -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#intConst"><span class="hs-identifier hs-var">intConst</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span>
</span><span id="line-159"></span><span>    </span><span id="local-6989586621684461777"><span class="annot"><span class="annottext">se1 :: SubExp
</span><a href="#local-6989586621684461777"><span class="hs-identifier hs-var hs-var">se1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IntType -&gt; Integer -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#intConst"><span class="hs-identifier hs-var">intConst</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">1</span></span><span>
</span><span id="line-160"></span><span>    </span><span id="local-6989586621684461741"><span class="annot"><span class="annottext">addFixIdx2FullSlice :: SubExp -&gt; Type -&gt; Slice SubExp
</span><a href="#local-6989586621684461741"><span class="hs-identifier hs-var hs-var">addFixIdx2FullSlice</span></a></span></span><span> </span><span id="local-6989586621684461740"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684461740"><span class="hs-identifier hs-var">idx</span></a></span></span><span> </span><span id="local-6989586621684461739"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684461739"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-161"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684461738"><span class="annot"><span class="annottext">full_dims :: [DimIndex SubExp]
</span><a href="#local-6989586621684461738"><span class="hs-identifier hs-var hs-var">full_dims</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Slice SubExp -&gt; [DimIndex SubExp]
forall d. Slice d -&gt; [DimIndex d]
</span><a href="Futhark.IR.Syntax.Core.html#unSlice"><span class="hs-identifier hs-var hs-var">unSlice</span></a></span><span> </span><span class="annot"><span class="annottext">(Slice SubExp -&gt; [DimIndex SubExp])
-&gt; Slice SubExp -&gt; [DimIndex SubExp]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; [DimIndex SubExp] -&gt; Slice SubExp
</span><a href="Futhark.Construct.html#fullSlice"><span class="hs-identifier hs-var">fullSlice</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684461739"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-162"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">[DimIndex SubExp] -&gt; Slice SubExp
forall d. [DimIndex d] -&gt; Slice d
</span><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-var">Slice</span></a></span><span> </span><span class="annot"><span class="annottext">([DimIndex SubExp] -&gt; Slice SubExp)
-&gt; [DimIndex SubExp] -&gt; Slice SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; DimIndex SubExp
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684461740"><span class="hs-identifier hs-var">idx</span></a></span><span> </span><span class="annot"><span class="annottext">DimIndex SubExp -&gt; [DimIndex SubExp] -&gt; [DimIndex SubExp]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[DimIndex SubExp]
</span><a href="#local-6989586621684461738"><span class="hs-identifier hs-var">full_dims</span></a></span><span>
</span><span id="line-163"></span><span>    </span><span id="local-6989586621684461787"><span class="annot"><span class="annottext">flipParams :: [a] -&gt; [a]
</span><a href="#local-6989586621684461787"><span class="hs-identifier hs-var hs-var">flipParams</span></a></span></span><span> </span><span id="local-6989586621684461730"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684461730"><span class="hs-identifier hs-var">ps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([a] -&gt; [a] -&gt; [a]) -&gt; ([a], [a]) -&gt; [a]
forall a b c. (a -&gt; b -&gt; c) -&gt; (a, b) -&gt; c
</span><span class="hs-identifier hs-var">uncurry</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">([a] -&gt; [a] -&gt; [a]) -&gt; [a] -&gt; [a] -&gt; [a]
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [a] -&gt; [a]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">(++)</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(([a], [a]) -&gt; [a]) -&gt; ([a], [a]) -&gt; [a]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [a] -&gt; ([a], [a])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684461730"><span class="hs-identifier hs-var">ps</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Integral a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`div`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684461730"><span class="hs-identifier hs-var">ps</span></a></span><span>
</span><span id="line-164"></span><span>    </span><span id="local-6989586621684461784"><span class="annot"><span class="annottext">mkFusedMapBody :: Param Type -&gt; [SubExp] -&gt; [Type] -&gt; ADM (Body SOACS)
</span><a href="#local-6989586621684461784"><span class="hs-identifier hs-var hs-var">mkFusedMapBody</span></a></span></span><span> </span><span id="local-6989586621684461726"><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684461726"><span class="hs-identifier hs-var">par_i</span></a></span></span><span> </span><span id="local-6989586621684461725"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684461725"><span class="hs-identifier hs-var">ne</span></a></span></span><span> </span><span id="local-6989586621684461724"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684461724"><span class="hs-identifier hs-var">alphas</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-165"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684461723"><span class="annot"><span class="annottext">i :: VName
</span><a href="#local-6989586621684461723"><span class="hs-identifier hs-var hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Param Type -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684461726"><span class="hs-identifier hs-var">par_i</span></a></span><span>
</span><span id="line-166"></span><span>      </span><span class="annot"><span class="annottext">Builder SOACS (Body SOACS) -&gt; ADM (Body SOACS)
forall rep (m :: * -&gt; *) somerep.
(Buildable rep, MonadFreshNames m, HasScope somerep m,
 SameScope somerep rep) =&gt;
Builder rep (Body rep) -&gt; m (Body rep)
</span><a href="Futhark.Builder.html#runBodyBuilder"><span class="hs-identifier hs-var">runBodyBuilder</span></a></span><span> </span><span class="annot"><span class="annottext">(Builder SOACS (Body SOACS) -&gt; ADM (Body SOACS))
-&gt; (Builder SOACS (Body SOACS) -&gt; Builder SOACS (Body SOACS))
-&gt; Builder SOACS (Body SOACS)
-&gt; ADM (Body SOACS)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Scope SOACS
-&gt; Builder SOACS (Body SOACS) -&gt; Builder SOACS (Body SOACS)
forall rep (m :: * -&gt; *) a.
LocalScope rep m =&gt;
Scope rep -&gt; m a -&gt; m a
</span><a href="Futhark.IR.Prop.Scope.html#localScope"><span class="hs-identifier hs-var">localScope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param Type] -&gt; Scope SOACS
forall rep dec. (LParamInfo rep ~ dec) =&gt; [Param dec] -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOfLParams"><span class="hs-identifier hs-var">scopeOfLParams</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684461726"><span class="hs-identifier hs-var">par_i</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Builder SOACS (Body SOACS) -&gt; ADM (Body SOACS))
-&gt; Builder SOACS (Body SOACS) -&gt; ADM (Body SOACS)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-167"></span><span>        </span><span class="annot"><span class="annottext">[BuilderT
   SOACS
   (State VNameSource)
   (Exp (Rep (BuilderT SOACS (State VNameSource))))]
-&gt; BuilderT
     SOACS
     (State VNameSource)
     (Body (Rep (BuilderT SOACS (State VNameSource))))
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[m (Exp (Rep m))] -&gt; m (Body (Rep m))
</span><a href="Futhark.Construct.html#eBody"><span class="hs-identifier hs-var">eBody</span></a></span><span>
</span><span id="line-168"></span><span>          </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">BuilderT
  SOACS
  (State VNameSource)
  (Exp (Rep (BuilderT SOACS (State VNameSource))))
-&gt; BuilderT
     SOACS
     (State VNameSource)
     (Body (Rep (BuilderT SOACS (State VNameSource))))
-&gt; BuilderT
     SOACS
     (State VNameSource)
     (Body (Rep (BuilderT SOACS (State VNameSource))))
-&gt; BuilderT
     SOACS
     (State VNameSource)
     (Exp (Rep (BuilderT SOACS (State VNameSource))))
forall (m :: * -&gt; *).
(MonadBuilder m, BranchType (Rep m) ~ ExtType) =&gt;
m (Exp (Rep m))
-&gt; m (Body (Rep m)) -&gt; m (Body (Rep m)) -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#eIf"><span class="hs-identifier hs-var">eIf</span></a></span><span>
</span><span id="line-169"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TPrimExp Bool VName
-&gt; BuilderT
     SOACS
     (State VNameSource)
     (Exp (Rep (BuilderT SOACS (State VNameSource))))
forall a (m :: * -&gt; *).
(ToExp a, MonadBuilder m) =&gt;
a -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#toExp"><span class="hs-identifier hs-var">toExp</span></a></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Bool VName
 -&gt; BuilderT
      SOACS
      (State VNameSource)
      (Exp (Rep (BuilderT SOACS (State VNameSource)))))
-&gt; TPrimExp Bool VName
-&gt; BuilderT
     SOACS
     (State VNameSource)
     (Exp (Rep (BuilderT SOACS (State VNameSource))))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TPrimExp Int64 VName
forall a. a -&gt; TPrimExp Int64 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le64"><span class="hs-identifier hs-var">le64</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684461723"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; TPrimExp Int64 VName -&gt; TPrimExp Bool VName
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3E."><span class="hs-operator hs-var">.&gt;.</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TPrimExp Int64 VName
</span><a href="Futhark.Analysis.PrimExp.Convert.html#pe64"><span class="hs-identifier hs-var">pe64</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684461778"><span class="hs-identifier hs-var">se0</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-170"></span><span>              </span><span class="hs-special">(</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-171"></span><span>                  </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621684461721"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684461721"><span class="hs-identifier hs-var">rs1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684461720"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684461720"><span class="hs-identifier hs-var">rs2</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621684461719"><span class="annot"><span class="annottext">Stms SOACS
</span><a href="#local-6989586621684461719"><span class="hs-identifier hs-var">stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">BuilderT
  SOACS (BuilderT SOACS (State VNameSource)) ([SubExp], [SubExp])
-&gt; BuilderT
     SOACS (State VNameSource) (([SubExp], [SubExp]), Stms SOACS)
forall (m :: * -&gt; *) somerep rep a.
(MonadFreshNames m, HasScope somerep m, SameScope somerep rep) =&gt;
BuilderT rep m a -&gt; m (a, Stms rep)
</span><a href="Futhark.Builder.html#runBuilderT%27"><span class="hs-identifier hs-var">runBuilderT'</span></a></span><span> </span><span class="annot"><span class="annottext">(BuilderT
   SOACS (BuilderT SOACS (State VNameSource)) ([SubExp], [SubExp])
 -&gt; BuilderT
      SOACS (State VNameSource) (([SubExp], [SubExp]), Stms SOACS))
-&gt; (BuilderT
      SOACS (BuilderT SOACS (State VNameSource)) ([SubExp], [SubExp])
    -&gt; BuilderT
         SOACS (BuilderT SOACS (State VNameSource)) ([SubExp], [SubExp]))
-&gt; BuilderT
     SOACS (BuilderT SOACS (State VNameSource)) ([SubExp], [SubExp])
-&gt; BuilderT
     SOACS (State VNameSource) (([SubExp], [SubExp]), Stms SOACS)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Scope SOACS
-&gt; BuilderT
     SOACS (BuilderT SOACS (State VNameSource)) ([SubExp], [SubExp])
-&gt; BuilderT
     SOACS (BuilderT SOACS (State VNameSource)) ([SubExp], [SubExp])
forall rep (m :: * -&gt; *) a.
LocalScope rep m =&gt;
Scope rep -&gt; m a -&gt; m a
</span><a href="Futhark.IR.Prop.Scope.html#localScope"><span class="hs-identifier hs-var">localScope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param Type] -&gt; Scope SOACS
forall rep dec. (LParamInfo rep ~ dec) =&gt; [Param dec] -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOfLParams"><span class="hs-identifier hs-var">scopeOfLParams</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684461726"><span class="hs-identifier hs-var">par_i</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(BuilderT
   SOACS (BuilderT SOACS (State VNameSource)) ([SubExp], [SubExp])
 -&gt; BuilderT
      SOACS (State VNameSource) (([SubExp], [SubExp]), Stms SOACS))
-&gt; BuilderT
     SOACS (BuilderT SOACS (State VNameSource)) ([SubExp], [SubExp])
-&gt; BuilderT
     SOACS (State VNameSource) (([SubExp], [SubExp]), Stms SOACS)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-172"></span><span>                    </span><span id="local-6989586621684461718"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684461718"><span class="hs-identifier hs-var">im1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String
-&gt; Exp (Rep (BuilderT SOACS (BuilderT SOACS (State VNameSource))))
-&gt; BuilderT SOACS (BuilderT SOACS (State VNameSource)) SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;i_1&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ExpT SOACS
 -&gt; BuilderT SOACS (BuilderT SOACS (State VNameSource)) SubExp)
-&gt; BuilderT SOACS (BuilderT SOACS (State VNameSource)) (ExpT SOACS)
-&gt; BuilderT SOACS (BuilderT SOACS (State VNameSource)) SubExp
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; BuilderT
     SOACS
     (BuilderT SOACS (State VNameSource))
     (Exp (Rep (BuilderT SOACS (BuilderT SOACS (State VNameSource)))))
forall a (m :: * -&gt; *).
(ToExp a, MonadBuilder m) =&gt;
a -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#toExp"><span class="hs-identifier hs-var">toExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; TPrimExp Int64 VName
forall a. a -&gt; TPrimExp Int64 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le64"><span class="hs-identifier hs-var">le64</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684461723"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TPrimExp Int64 VName
</span><a href="Futhark.Analysis.PrimExp.Convert.html#pe64"><span class="hs-identifier hs-var">pe64</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684461777"><span class="hs-identifier hs-var">se1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-173"></span><span>                    </span><span id="local-6989586621684461717"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684461717"><span class="hs-identifier hs-var">nmi</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String
-&gt; Exp (Rep (BuilderT SOACS (BuilderT SOACS (State VNameSource))))
-&gt; BuilderT SOACS (BuilderT SOACS (State VNameSource)) SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;n_i&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ExpT SOACS
 -&gt; BuilderT SOACS (BuilderT SOACS (State VNameSource)) SubExp)
-&gt; BuilderT SOACS (BuilderT SOACS (State VNameSource)) (ExpT SOACS)
-&gt; BuilderT SOACS (BuilderT SOACS (State VNameSource)) SubExp
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; BuilderT
     SOACS
     (BuilderT SOACS (State VNameSource))
     (Exp (Rep (BuilderT SOACS (BuilderT SOACS (State VNameSource)))))
forall a (m :: * -&gt; *).
(ToExp a, MonadBuilder m) =&gt;
a -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#toExp"><span class="hs-identifier hs-var">toExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp -&gt; TPrimExp Int64 VName
</span><a href="Futhark.Analysis.PrimExp.Convert.html#pe64"><span class="hs-identifier hs-var">pe64</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684461796"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TPrimExp Int64 VName
forall a. a -&gt; TPrimExp Int64 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le64"><span class="hs-identifier hs-var">le64</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684461723"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-174"></span><span>                    </span><span id="local-6989586621684461716"><span class="annot"><span class="annottext">[(SubExp, SubExp)]
</span><a href="#local-6989586621684461716"><span class="hs-identifier hs-var">tmp</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(VName, Type)]
-&gt; ((VName, Type)
    -&gt; BuilderT
         SOACS (BuilderT SOACS (State VNameSource)) (SubExp, SubExp))
-&gt; BuilderT
     SOACS (BuilderT SOACS (State VNameSource)) [(SubExp, SubExp)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; [Type] -&gt; [(VName, Type)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684461795"><span class="hs-keyword hs-var">as</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684461724"><span class="hs-identifier hs-var">alphas</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((VName, Type)
  -&gt; BuilderT
       SOACS (BuilderT SOACS (State VNameSource)) (SubExp, SubExp))
 -&gt; BuilderT
      SOACS (BuilderT SOACS (State VNameSource)) [(SubExp, SubExp)])
-&gt; ((VName, Type)
    -&gt; BuilderT
         SOACS (BuilderT SOACS (State VNameSource)) (SubExp, SubExp))
-&gt; BuilderT
     SOACS (BuilderT SOACS (State VNameSource)) [(SubExp, SubExp)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684461714"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684461714"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684461713"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684461713"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-175"></span><span>                      </span><span id="local-6989586621684461712"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684461712"><span class="hs-identifier hs-var">x1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-176"></span><span>                        </span><span class="annot"><span class="annottext">String
-&gt; Exp (Rep (BuilderT SOACS (BuilderT SOACS (State VNameSource))))
-&gt; BuilderT SOACS (BuilderT SOACS (State VNameSource)) SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; String
</span><a href="Language.Futhark.Core.html#baseString"><span class="hs-identifier hs-var">baseString</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684461714"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_elem_1&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (BuilderT SOACS (BuilderT SOACS (State VNameSource))))
 -&gt; BuilderT SOACS (BuilderT SOACS (State VNameSource)) SubExp)
-&gt; Exp (Rep (BuilderT SOACS (BuilderT SOACS (State VNameSource))))
-&gt; BuilderT SOACS (BuilderT SOACS (State VNameSource)) SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-177"></span><span>                          </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT SOACS
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT SOACS) -&gt; BasicOp -&gt; ExpT SOACS
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Slice SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Index"><span class="hs-identifier hs-var">Index</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684461714"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">(Slice SubExp -&gt; BasicOp) -&gt; Slice SubExp -&gt; BasicOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Type -&gt; Slice SubExp
</span><a href="#local-6989586621684461741"><span class="hs-identifier hs-var">addFixIdx2FullSlice</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684461718"><span class="hs-identifier hs-var">im1</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684461713"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-178"></span><span>                      </span><span id="local-6989586621684461711"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684461711"><span class="hs-identifier hs-var">x2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-179"></span><span>                        </span><span class="annot"><span class="annottext">String
-&gt; Exp (Rep (BuilderT SOACS (BuilderT SOACS (State VNameSource))))
-&gt; BuilderT SOACS (BuilderT SOACS (State VNameSource)) SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; String
</span><a href="Language.Futhark.Core.html#baseString"><span class="hs-identifier hs-var">baseString</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684461714"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_elem_2&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (BuilderT SOACS (BuilderT SOACS (State VNameSource))))
 -&gt; BuilderT SOACS (BuilderT SOACS (State VNameSource)) SubExp)
-&gt; Exp (Rep (BuilderT SOACS (BuilderT SOACS (State VNameSource))))
-&gt; BuilderT SOACS (BuilderT SOACS (State VNameSource)) SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-180"></span><span>                          </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT SOACS
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT SOACS) -&gt; BasicOp -&gt; ExpT SOACS
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Slice SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Index"><span class="hs-identifier hs-var">Index</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684461714"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">(Slice SubExp -&gt; BasicOp) -&gt; Slice SubExp -&gt; BasicOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Type -&gt; Slice SubExp
</span><a href="#local-6989586621684461741"><span class="hs-identifier hs-var">addFixIdx2FullSlice</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684461717"><span class="hs-identifier hs-var">nmi</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684461713"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-181"></span><span>                      </span><span class="annot"><span class="annottext">(SubExp, SubExp)
-&gt; BuilderT
     SOACS (BuilderT SOACS (State VNameSource)) (SubExp, SubExp)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684461712"><span class="hs-identifier hs-var">x1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684461711"><span class="hs-identifier hs-var">x2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-182"></span><span>                    </span><span class="annot"><span class="annottext">([SubExp], [SubExp])
-&gt; BuilderT
     SOACS (BuilderT SOACS (State VNameSource)) ([SubExp], [SubExp])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(SubExp, SubExp)] -&gt; ([SubExp], [SubExp])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">[(SubExp, SubExp)]
</span><a href="#local-6989586621684461716"><span class="hs-identifier hs-var">tmp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-183"></span><span>                  </span><span class="annot"><span class="annottext">Stms (Rep (BuilderT SOACS (State VNameSource)))
-&gt; BuilderT SOACS (State VNameSource) ()
forall (m :: * -&gt; *). MonadBuilder m =&gt; Stms (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#addStms"><span class="hs-identifier hs-var">addStms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms (Rep (BuilderT SOACS (State VNameSource)))
Stms SOACS
</span><a href="#local-6989586621684461719"><span class="hs-identifier hs-var">stms</span></a></span><span>
</span><span id="line-184"></span><span>                  </span><span class="annot"><span class="annottext">[SubExp]
-&gt; BuilderT
     SOACS
     (State VNameSource)
     (Body (Rep (BuilderT SOACS (State VNameSource))))
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[SubExp] -&gt; m (Body (Rep m))
</span><a href="Futhark.Construct.html#resultBodyM"><span class="hs-identifier hs-var">resultBodyM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684461721"><span class="hs-identifier hs-var">rs1</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; [SubExp] -&gt; [SubExp]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684461720"><span class="hs-identifier hs-var">rs2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-185"></span><span>              </span><span class="hs-special">)</span><span>
</span><span id="line-186"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp]
-&gt; BuilderT
     SOACS
     (State VNameSource)
     (Body (Rep (BuilderT SOACS (State VNameSource))))
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[SubExp] -&gt; m (Body (Rep m))
</span><a href="Futhark.Construct.html#resultBodyM"><span class="hs-identifier hs-var">resultBodyM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684461725"><span class="hs-identifier hs-var">ne</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; [SubExp] -&gt; [SubExp]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684461725"><span class="hs-identifier hs-var">ne</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-187"></span><span>          </span><span class="hs-special">]</span><span>
</span><span id="line-188"></span><span>    </span><span id="local-6989586621684461749"><span class="annot"><span class="annottext">mkIdxStm :: SubExp -&gt; (Type, VName, VName) -&gt; Stm rep
</span><a href="#local-6989586621684461749"><span class="hs-identifier hs-var hs-var">mkIdxStm</span></a></span></span><span> </span><span id="local-6989586621684461707"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684461707"><span class="hs-identifier hs-var">idx</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684461706"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684461706"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684461705"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684461705"><span class="hs-identifier hs-var">r_arr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684461704"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684461704"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-189"></span><span>      </span><span class="annot"><span class="annottext">[Ident] -&gt; Exp rep -&gt; Stm rep
forall rep. Buildable rep =&gt; [Ident] -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.Builder.Class.html#mkLet"><span class="hs-identifier hs-var">mkLet</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">VName -&gt; Type -&gt; Ident
</span><a href="Futhark.IR.Syntax.Core.html#Ident"><span class="hs-identifier hs-var">Ident</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684461704"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684461706"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(Exp rep -&gt; Stm rep) -&gt; Exp rep -&gt; Stm rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; Exp rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; Exp rep) -&gt; BasicOp -&gt; Exp rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Slice SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Index"><span class="hs-identifier hs-var">Index</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684461705"><span class="hs-identifier hs-var">r_arr</span></a></span><span> </span><span class="annot"><span class="annottext">(Slice SubExp -&gt; BasicOp) -&gt; Slice SubExp -&gt; BasicOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Type -&gt; Slice SubExp
</span><a href="#local-6989586621684461741"><span class="hs-identifier hs-var">addFixIdx2FullSlice</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684461707"><span class="hs-identifier hs-var">idx</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684461706"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-190"></span><span class="hs-comment">--</span><span>
</span><span id="line-191"></span><span class="hs-comment">-- previous buggy version is unreachable now</span><span>
</span><span id="line-192"></span><span class="annot"><a href="Futhark.AD.Rev.Reduce.html#diffReduce"><span class="hs-identifier hs-var">diffReduce</span></a></span><span> </span><span id="local-6989586621684461701"><span class="annot"><span class="annottext">VjpOps
</span><a href="#local-6989586621684461701"><span class="hs-identifier hs-var">ops</span></a></span></span><span> </span><span id="local-6989586621684461700"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684461700"><span class="hs-identifier hs-var">pat_adj</span></a></span></span><span> </span><span id="local-6989586621684461699"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684461699"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684461698"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684461698"><span class="hs-keyword hs-var">as</span></a></span></span><span> </span><span id="local-6989586621684461697"><span class="annot"><span class="annottext">Reduce SOACS
</span><a href="#local-6989586621684461697"><span class="hs-identifier hs-var">red</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-193"></span><span>  </span><span id="local-6989586621684461696"><span class="annot"><span class="annottext">Reduce SOACS
</span><a href="#local-6989586621684461696"><span class="hs-identifier hs-var">red'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Reduce SOACS -&gt; ADM (Reduce SOACS)
forall {f :: * -&gt; *} {rep}.
(Rename (LetDec rep), Rename (ExpDec rep), Rename (BodyDec rep),
 Rename (FParamInfo rep), Rename (LParamInfo rep),
 Rename (RetType rep), Rename (BranchType rep), Rename (Op rep),
 MonadFreshNames f) =&gt;
Reduce rep -&gt; f (Reduce rep)
</span><a href="#local-6989586621684461695"><span class="hs-identifier hs-var">renameRed</span></a></span><span> </span><span class="annot"><span class="annottext">Reduce SOACS
</span><a href="#local-6989586621684461697"><span class="hs-identifier hs-var">red</span></a></span><span>
</span><span id="line-194"></span><span>  </span><span id="local-6989586621684461694"><span class="annot"><span class="annottext">Reduce SOACS
</span><a href="#local-6989586621684461694"><span class="hs-identifier hs-var">flip_red</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Reduce SOACS -&gt; ADM (Reduce SOACS)
forall {f :: * -&gt; *} {rep}.
(Rename (LetDec rep), Rename (ExpDec rep), Rename (BodyDec rep),
 Rename (FParamInfo rep), Rename (LParamInfo rep),
 Rename (RetType rep), Rename (BranchType rep), Rename (Op rep),
 MonadFreshNames f) =&gt;
Reduce rep -&gt; f (Reduce rep)
</span><a href="#local-6989586621684461695"><span class="hs-identifier hs-var">renameRed</span></a></span><span> </span><span class="annot"><span class="annottext">(Reduce SOACS -&gt; ADM (Reduce SOACS))
-&gt; ADM (Reduce SOACS) -&gt; ADM (Reduce SOACS)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">Reduce SOACS -&gt; ADM (Reduce SOACS)
forall {f :: * -&gt; *} {rep}.
(Rename (LetDec rep), Rename (ExpDec rep), Rename (BodyDec rep),
 Rename (FParamInfo rep), Rename (LParamInfo rep),
 Rename (RetType rep), Rename (BranchType rep), Rename (Op rep),
 MonadFreshNames f) =&gt;
Reduce rep -&gt; f (Reduce rep)
</span><a href="#local-6989586621684461693"><span class="hs-identifier hs-var">flipReduce</span></a></span><span> </span><span class="annot"><span class="annottext">Reduce SOACS
</span><a href="#local-6989586621684461697"><span class="hs-identifier hs-var">red</span></a></span><span>
</span><span id="line-195"></span><span>  </span><span id="local-6989586621684461692"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684461692"><span class="hs-identifier hs-var">ls</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; Scan SOACS -&gt; [VName] -&gt; ADM [VName]
forall (m :: * -&gt; *).
(MonadBuilder m, Rep m ~ SOACS) =&gt;
String -&gt; Scan SOACS -&gt; [VName] -&gt; m [VName]
</span><a href="Futhark.AD.Rev.Reduce.html#scanExc"><span class="hs-identifier hs-var">scanExc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ls&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Reduce SOACS -&gt; Scan SOACS
</span><a href="#local-6989586621684461691"><span class="hs-identifier hs-var">redToScan</span></a></span><span> </span><span class="annot"><span class="annottext">Reduce SOACS
</span><a href="#local-6989586621684461696"><span class="hs-identifier hs-var">red'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684461698"><span class="hs-keyword hs-var">as</span></a></span><span>
</span><span id="line-196"></span><span>  </span><span id="local-6989586621684461690"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684461690"><span class="hs-identifier hs-var">rs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-197"></span><span>    </span><span class="annot"><span class="annottext">(VName -&gt; ADM VName) -&gt; [VName] -&gt; ADM [VName]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; ADM VName
forall (m :: * -&gt; *). MonadBuilder m =&gt; VName -&gt; m VName
</span><a href="Futhark.AD.Rev.Reduce.html#eReverse"><span class="hs-identifier hs-var">eReverse</span></a></span><span>
</span><span id="line-198"></span><span>      </span><span class="annot"><span class="annottext">([VName] -&gt; ADM [VName]) -&gt; ADM [VName] -&gt; ADM [VName]
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Scan SOACS -&gt; [VName] -&gt; ADM [VName]
forall (m :: * -&gt; *).
(MonadBuilder m, Rep m ~ SOACS) =&gt;
String -&gt; Scan SOACS -&gt; [VName] -&gt; m [VName]
</span><a href="Futhark.AD.Rev.Reduce.html#scanExc"><span class="hs-identifier hs-var">scanExc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ls&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Reduce SOACS -&gt; Scan SOACS
</span><a href="#local-6989586621684461691"><span class="hs-identifier hs-var">redToScan</span></a></span><span> </span><span class="annot"><span class="annottext">Reduce SOACS
</span><a href="#local-6989586621684461694"><span class="hs-identifier hs-var">flip_red</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-199"></span><span>      </span><span class="annot"><span class="annottext">([VName] -&gt; ADM [VName]) -&gt; ADM [VName] -&gt; ADM [VName]
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; ADM VName) -&gt; [VName] -&gt; ADM [VName]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; ADM VName
forall (m :: * -&gt; *). MonadBuilder m =&gt; VName -&gt; m VName
</span><a href="Futhark.AD.Rev.Reduce.html#eReverse"><span class="hs-identifier hs-var">eReverse</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684461698"><span class="hs-keyword hs-var">as</span></a></span><span>
</span><span id="line-200"></span><span>
</span><span id="line-201"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684461689"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684461689"><span class="hs-identifier hs-var">as_params</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684461688"><span class="annot"><span class="annottext">LambdaT SOACS
</span><a href="#local-6989586621684461688"><span class="hs-identifier hs-var">f</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LambdaT SOACS -&gt; ADM ([VName], LambdaT SOACS)
</span><a href="Futhark.AD.Rev.Reduce.html#mkF"><span class="hs-identifier hs-var">mkF</span></a></span><span> </span><span class="annot"><span class="annottext">(LambdaT SOACS -&gt; ADM ([VName], LambdaT SOACS))
-&gt; LambdaT SOACS -&gt; ADM ([VName], LambdaT SOACS)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Reduce SOACS -&gt; LambdaT SOACS
forall rep. Reduce rep -&gt; Lambda rep
</span><a href="Futhark.IR.SOACS.SOAC.html#redLambda"><span class="hs-identifier hs-var hs-var">redLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Reduce SOACS
</span><a href="#local-6989586621684461697"><span class="hs-identifier hs-var">red</span></a></span><span>
</span><span id="line-202"></span><span>
</span><span id="line-203"></span><span>  </span><span id="local-6989586621684461687"><span class="annot"><span class="annottext">LambdaT SOACS
</span><a href="#local-6989586621684461687"><span class="hs-identifier hs-var">f_adj</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VjpOps -&gt; [Adj] -&gt; [VName] -&gt; LambdaT SOACS -&gt; ADM (LambdaT SOACS)
</span><a href="Futhark.AD.Rev.Monad.html#vjpLambda"><span class="hs-identifier hs-var hs-var">vjpLambda</span></a></span><span> </span><span class="annot"><span class="annottext">VjpOps
</span><a href="#local-6989586621684461701"><span class="hs-identifier hs-var">ops</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(VName -&gt; Adj) -&gt; [VName] -&gt; [Adj]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Adj
</span><a href="Futhark.AD.Rev.Monad.html#adjFromVar"><span class="hs-identifier hs-var">adjFromVar</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684461700"><span class="hs-identifier hs-var">pat_adj</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684461689"><span class="hs-identifier hs-var">as_params</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT SOACS
</span><a href="#local-6989586621684461688"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-204"></span><span>
</span><span id="line-205"></span><span>  </span><span id="local-6989586621684461686"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684461686"><span class="hs-identifier hs-var">as_adj</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; Exp (Rep ADM) -&gt; ADM [VName]
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m [VName]
</span><a href="Futhark.Construct.html#letTupExp"><span class="hs-identifier hs-var">letTupExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;adjs&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep ADM) -&gt; ADM [VName]) -&gt; Exp (Rep ADM) -&gt; ADM [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Op SOACS -&gt; ExpT SOACS
forall rep. Op rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-var">Op</span></a></span><span> </span><span class="annot"><span class="annottext">(Op SOACS -&gt; ExpT SOACS) -&gt; Op SOACS -&gt; ExpT SOACS
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; [VName] -&gt; ScremaForm SOACS -&gt; SOAC SOACS
forall rep. SubExp -&gt; [VName] -&gt; ScremaForm rep -&gt; SOAC rep
</span><a href="Futhark.IR.SOACS.SOAC.html#Screma"><span class="hs-identifier hs-var">Screma</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684461699"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684461692"><span class="hs-identifier hs-var">ls</span></a></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684461698"><span class="hs-keyword hs-var">as</span></a></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684461690"><span class="hs-identifier hs-var">rs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LambdaT SOACS -&gt; ScremaForm SOACS
forall rep. Lambda rep -&gt; ScremaForm rep
</span><a href="Futhark.IR.SOACS.SOAC.html#mapSOAC"><span class="hs-identifier hs-var">mapSOAC</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT SOACS
</span><a href="#local-6989586621684461687"><span class="hs-identifier hs-var">f_adj</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-206"></span><span>
</span><span id="line-207"></span><span>  </span><span class="annot"><span class="annottext">(VName -&gt; VName -&gt; ADM ()) -&gt; [VName] -&gt; [VName] -&gt; ADM ()
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m ()
</span><span class="hs-identifier hs-var">zipWithM_</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; VName -&gt; ADM ()
</span><a href="Futhark.AD.Rev.Monad.html#updateAdj"><span class="hs-identifier hs-var">updateAdj</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684461698"><span class="hs-keyword hs-var">as</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684461686"><span class="hs-identifier hs-var">as_adj</span></a></span><span>
</span><span id="line-208"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-209"></span><span>    </span><span id="local-6989586621684461695"><span class="annot"><span class="annottext">renameRed :: Reduce rep -&gt; f (Reduce rep)
</span><a href="#local-6989586621684461695"><span class="hs-identifier hs-var hs-var">renameRed</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Reduce"><span class="hs-identifier hs-type">Reduce</span></a></span><span> </span><span id="local-6989586621684461643"><span class="annot"><span class="annottext">Commutativity
</span><a href="#local-6989586621684461643"><span class="hs-identifier hs-var">comm</span></a></span></span><span> </span><span id="local-6989586621684461642"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684461642"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span id="local-6989586621684461641"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684461641"><span class="hs-identifier hs-var">nes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-210"></span><span>      </span><span class="annot"><span class="annottext">Commutativity -&gt; Lambda rep -&gt; [SubExp] -&gt; Reduce rep
forall rep. Commutativity -&gt; Lambda rep -&gt; [SubExp] -&gt; Reduce rep
</span><a href="Futhark.IR.SOACS.SOAC.html#Reduce"><span class="hs-identifier hs-var">Reduce</span></a></span><span> </span><span class="annot"><span class="annottext">Commutativity
</span><a href="#local-6989586621684461643"><span class="hs-identifier hs-var">comm</span></a></span><span> </span><span class="annot"><span class="annottext">(Lambda rep -&gt; [SubExp] -&gt; Reduce rep)
-&gt; f (Lambda rep) -&gt; f ([SubExp] -&gt; Reduce rep)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; f (Lambda rep)
forall rep (m :: * -&gt; *).
(Renameable rep, MonadFreshNames m) =&gt;
Lambda rep -&gt; m (Lambda rep)
</span><a href="Futhark.Transform.Rename.html#renameLambda"><span class="hs-identifier hs-var">renameLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684461642"><span class="hs-identifier hs-var">lam</span></a></span><span> </span><span class="annot"><span class="annottext">f ([SubExp] -&gt; Reduce rep) -&gt; f [SubExp] -&gt; f (Reduce rep)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; f [SubExp]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684461641"><span class="hs-identifier hs-var">nes</span></a></span><span>
</span><span id="line-211"></span><span>
</span><span id="line-212"></span><span>    </span><span class="annot"><a href="#local-6989586621684461691"><span class="hs-identifier hs-type">redToScan</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Reduce"><span class="hs-identifier hs-type">Reduce</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Scan"><span class="hs-identifier hs-type">Scan</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span><span>
</span><span id="line-213"></span><span>    </span><span id="local-6989586621684461691"><span class="annot"><span class="annottext">redToScan :: Reduce SOACS -&gt; Scan SOACS
</span><a href="#local-6989586621684461691"><span class="hs-identifier hs-var hs-var">redToScan</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Reduce"><span class="hs-identifier hs-type">Reduce</span></a></span><span> </span><span class="annot"><span class="annottext">Commutativity
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684461640"><span class="annot"><span class="annottext">LambdaT SOACS
</span><a href="#local-6989586621684461640"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span id="local-6989586621684461639"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684461639"><span class="hs-identifier hs-var">nes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LambdaT SOACS -&gt; [SubExp] -&gt; Scan SOACS
forall rep. Lambda rep -&gt; [SubExp] -&gt; Scan rep
</span><a href="Futhark.IR.SOACS.SOAC.html#Scan"><span class="hs-identifier hs-var">Scan</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT SOACS
</span><a href="#local-6989586621684461640"><span class="hs-identifier hs-var">lam</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684461639"><span class="hs-identifier hs-var">nes</span></a></span><span>
</span><span id="line-214"></span><span>    </span><span id="local-6989586621684461693"><span class="annot"><span class="annottext">flipReduce :: Reduce rep -&gt; m (Reduce rep)
</span><a href="#local-6989586621684461693"><span class="hs-identifier hs-var hs-var">flipReduce</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Reduce"><span class="hs-identifier hs-type">Reduce</span></a></span><span> </span><span id="local-6989586621684461598"><span class="annot"><span class="annottext">Commutativity
</span><a href="#local-6989586621684461598"><span class="hs-identifier hs-var">comm</span></a></span></span><span> </span><span id="local-6989586621684461597"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684461597"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span id="local-6989586621684461596"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684461596"><span class="hs-identifier hs-var">nes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-215"></span><span>      </span><span id="local-6989586621684461595"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684461595"><span class="hs-identifier hs-var">lam'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; m (Lambda rep)
forall rep (m :: * -&gt; *).
(Renameable rep, MonadFreshNames m) =&gt;
Lambda rep -&gt; m (Lambda rep)
</span><a href="Futhark.Transform.Rename.html#renameLambda"><span class="hs-identifier hs-var">renameLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684461597"><span class="hs-identifier hs-var">lam</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">lambdaParams :: [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var">lambdaParams</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[LParam rep] -&gt; [LParam rep]
forall {a}. [a] -&gt; [a]
</span><a href="#local-6989586621684461594"><span class="hs-identifier hs-var">flipParams</span></a></span><span> </span><span class="annot"><span class="annottext">([LParam rep] -&gt; [LParam rep]) -&gt; [LParam rep] -&gt; [LParam rep]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; [LParam rep]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684461597"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-216"></span><span>      </span><span class="annot"><span class="annottext">Reduce rep -&gt; m (Reduce rep)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Reduce rep -&gt; m (Reduce rep)) -&gt; Reduce rep -&gt; m (Reduce rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Commutativity -&gt; Lambda rep -&gt; [SubExp] -&gt; Reduce rep
forall rep. Commutativity -&gt; Lambda rep -&gt; [SubExp] -&gt; Reduce rep
</span><a href="Futhark.IR.SOACS.SOAC.html#Reduce"><span class="hs-identifier hs-var">Reduce</span></a></span><span> </span><span class="annot"><span class="annottext">Commutativity
</span><a href="#local-6989586621684461598"><span class="hs-identifier hs-var">comm</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684461595"><span class="hs-identifier hs-var">lam'</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684461596"><span class="hs-identifier hs-var">nes</span></a></span><span>
</span><span id="line-217"></span><span>    </span><span id="local-6989586621684461594"><span class="annot"><span class="annottext">flipParams :: [a] -&gt; [a]
</span><a href="#local-6989586621684461594"><span class="hs-identifier hs-var hs-var">flipParams</span></a></span></span><span> </span><span id="local-6989586621684461590"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684461590"><span class="hs-identifier hs-var">ps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([a] -&gt; [a] -&gt; [a]) -&gt; ([a], [a]) -&gt; [a]
forall a b c. (a -&gt; b -&gt; c) -&gt; (a, b) -&gt; c
</span><span class="hs-identifier hs-var">uncurry</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">([a] -&gt; [a] -&gt; [a]) -&gt; [a] -&gt; [a] -&gt; [a]
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [a] -&gt; [a]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">(++)</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(([a], [a]) -&gt; [a]) -&gt; ([a], [a]) -&gt; [a]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [a] -&gt; ([a], [a])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684461590"><span class="hs-identifier hs-var">ps</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Integral a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`div`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684461590"><span class="hs-identifier hs-var">ps</span></a></span><span>
</span><span id="line-218"></span><span>
</span><span id="line-219"></span><span class="hs-comment">--</span><span>
</span><span id="line-220"></span><span class="hs-comment">-- Special case of reduce with min/max:</span><span>
</span><span id="line-221"></span><span class="hs-comment">--    let x = reduce minmax ne as</span><span>
</span><span id="line-222"></span><span class="hs-comment">-- Forward trace (assuming w = length as):</span><span>
</span><span id="line-223"></span><span class="hs-comment">--    let (x, x_ind) =</span><span>
</span><span id="line-224"></span><span class="hs-comment">--      reduce (\ acc_v acc_i v i -&gt;</span><span>
</span><span id="line-225"></span><span class="hs-comment">--                 if (acc_v == v) then (acc_v, min acc_i i)</span><span>
</span><span id="line-226"></span><span class="hs-comment">--                 else if (acc_v == minmax acc_v v)</span><span>
</span><span id="line-227"></span><span class="hs-comment">--                      then (acc_v, acc_i)</span><span>
</span><span id="line-228"></span><span class="hs-comment">--                      else (v, i))</span><span>
</span><span id="line-229"></span><span class="hs-comment">--             (ne_min, -1)</span><span>
</span><span id="line-230"></span><span class="hs-comment">--             (zip as (iota w))</span><span>
</span><span id="line-231"></span><span class="hs-comment">-- Reverse trace:</span><span>
</span><span id="line-232"></span><span class="hs-comment">--    num_elems = i64.bool (0 &lt;= x_ind)</span><span>
</span><span id="line-233"></span><span class="hs-comment">--    m_bar_repl = replicate num_elems m_bar</span><span>
</span><span id="line-234"></span><span class="hs-comment">--    as_bar[x_ind:num_elems:1] += m_bar_repl</span><span>
</span><span id="line-235"></span><span class="annot"><a href="Futhark.AD.Rev.Reduce.html#diffMinMaxReduce"><span class="hs-identifier hs-type">diffMinMaxReduce</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-236"></span><span>  </span><span class="annot"><a href="Futhark.AD.Rev.Monad.html#VjpOps"><span class="hs-identifier hs-type">VjpOps</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#StmAux"><span class="hs-identifier hs-type">StmAux</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Primitive.html#BinOp"><span class="hs-identifier hs-type">BinOp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.AD.Rev.Monad.html#ADM"><span class="hs-identifier hs-type">ADM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.AD.Rev.Monad.html#ADM"><span class="hs-identifier hs-type">ADM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-237"></span><span id="diffMinMaxReduce"><span class="annot"><span class="annottext">diffMinMaxReduce :: VjpOps
-&gt; VName
-&gt; StmAux ()
-&gt; SubExp
-&gt; BinOp
-&gt; SubExp
-&gt; VName
-&gt; ADM ()
-&gt; ADM ()
</span><a href="Futhark.AD.Rev.Reduce.html#diffMinMaxReduce"><span class="hs-identifier hs-var hs-var">diffMinMaxReduce</span></a></span></span><span> </span><span id="local-6989586621684461589"><span class="annot"><span class="annottext">VjpOps
</span><a href="#local-6989586621684461589"><span class="hs-identifier hs-var">_ops</span></a></span></span><span> </span><span id="local-6989586621684461588"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684461588"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621684461587"><span class="annot"><span class="annottext">StmAux ()
</span><a href="#local-6989586621684461587"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span id="local-6989586621684461586"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684461586"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684461585"><span class="annot"><span class="annottext">BinOp
</span><a href="#local-6989586621684461585"><span class="hs-identifier hs-var">minmax</span></a></span></span><span> </span><span id="local-6989586621684461584"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684461584"><span class="hs-identifier hs-var">ne</span></a></span></span><span> </span><span id="local-6989586621684461583"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684461583"><span class="hs-keyword hs-var">as</span></a></span></span><span> </span><span id="local-6989586621684461582"><span class="annot"><span class="annottext">ADM ()
</span><a href="#local-6989586621684461582"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-238"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684461581"><span class="annot"><span class="annottext">t :: PrimType
</span><a href="#local-6989586621684461581"><span class="hs-identifier hs-var hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BinOp -&gt; PrimType
</span><a href="Futhark.IR.Primitive.html#binOpType"><span class="hs-identifier hs-var">binOpType</span></a></span><span> </span><span class="annot"><span class="annottext">BinOp
</span><a href="#local-6989586621684461585"><span class="hs-identifier hs-var">minmax</span></a></span><span>
</span><span id="line-239"></span><span>
</span><span id="line-240"></span><span>  </span><span id="local-6989586621684461579"><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684461579"><span class="hs-identifier hs-var">acc_v_p</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; Type -&gt; ADM (Param Type)
forall (m :: * -&gt; *) dec.
MonadFreshNames m =&gt;
String -&gt; dec -&gt; m (Param dec)
</span><a href="Futhark.MonadFreshNames.html#newParam"><span class="hs-identifier hs-var">newParam</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;acc_v&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; ADM (Param Type)) -&gt; Type -&gt; ADM (Param Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; Type
forall shape u. PrimType -&gt; TypeBase shape u
</span><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684461581"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-241"></span><span>  </span><span id="local-6989586621684461578"><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684461578"><span class="hs-identifier hs-var">acc_i_p</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; Type -&gt; ADM (Param Type)
forall (m :: * -&gt; *) dec.
MonadFreshNames m =&gt;
String -&gt; dec -&gt; m (Param dec)
</span><a href="Futhark.MonadFreshNames.html#newParam"><span class="hs-identifier hs-var">newParam</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;acc_i&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; ADM (Param Type)) -&gt; Type -&gt; ADM (Param Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; Type
forall shape u. PrimType -&gt; TypeBase shape u
</span><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int64"><span class="hs-identifier hs-var">int64</span></a></span><span>
</span><span id="line-242"></span><span>  </span><span id="local-6989586621684461577"><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684461577"><span class="hs-identifier hs-var">v_p</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; Type -&gt; ADM (Param Type)
forall (m :: * -&gt; *) dec.
MonadFreshNames m =&gt;
String -&gt; dec -&gt; m (Param dec)
</span><a href="Futhark.MonadFreshNames.html#newParam"><span class="hs-identifier hs-var">newParam</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;v&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; ADM (Param Type)) -&gt; Type -&gt; ADM (Param Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; Type
forall shape u. PrimType -&gt; TypeBase shape u
</span><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684461581"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-243"></span><span>  </span><span id="local-6989586621684461576"><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684461576"><span class="hs-identifier hs-var">i_p</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; Type -&gt; ADM (Param Type)
forall (m :: * -&gt; *) dec.
MonadFreshNames m =&gt;
String -&gt; dec -&gt; m (Param dec)
</span><a href="Futhark.MonadFreshNames.html#newParam"><span class="hs-identifier hs-var">newParam</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;i&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; ADM (Param Type)) -&gt; Type -&gt; ADM (Param Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; Type
forall shape u. PrimType -&gt; TypeBase shape u
</span><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int64"><span class="hs-identifier hs-var">int64</span></a></span><span>
</span><span id="line-244"></span><span>  </span><span id="local-6989586621684461575"><span class="annot"><span class="annottext">LambdaT SOACS
</span><a href="#local-6989586621684461575"><span class="hs-identifier hs-var">red_lam</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-245"></span><span>    </span><span class="annot"><span class="annottext">[LParam (Rep ADM)] -&gt; ADM Result -&gt; ADM (Lambda (Rep ADM))
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[LParam (Rep m)] -&gt; m Result -&gt; m (Lambda (Rep m))
</span><a href="Futhark.Construct.html#mkLambda"><span class="hs-identifier hs-var">mkLambda</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Param Type
LParam (Rep ADM)
</span><a href="#local-6989586621684461579"><span class="hs-identifier hs-var">acc_v_p</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Param Type
LParam (Rep ADM)
</span><a href="#local-6989586621684461578"><span class="hs-identifier hs-var">acc_i_p</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Param Type
LParam (Rep ADM)
</span><a href="#local-6989586621684461577"><span class="hs-identifier hs-var">v_p</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Param Type
LParam (Rep ADM)
</span><a href="#local-6989586621684461576"><span class="hs-identifier hs-var">i_p</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(ADM Result -&gt; ADM (Lambda (Rep ADM)))
-&gt; ADM Result -&gt; ADM (Lambda (Rep ADM))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-246"></span><span>      </span><span class="annot"><span class="annottext">([VName] -&gt; Result) -&gt; ADM [VName] -&gt; ADM Result
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Result
</span><a href="Futhark.IR.Syntax.html#varsRes"><span class="hs-identifier hs-var">varsRes</span></a></span><span> </span><span class="annot"><span class="annottext">(ADM [VName] -&gt; ADM Result)
-&gt; (ExpT SOACS -&gt; ADM [VName]) -&gt; ExpT SOACS -&gt; ADM Result
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Exp (Rep ADM) -&gt; ADM [VName]
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m [VName]
</span><a href="Futhark.Construct.html#letTupExp"><span class="hs-identifier hs-var">letTupExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;idx_res&quot;</span></span><span>
</span><span id="line-247"></span><span>        </span><span class="annot"><span class="annottext">(ExpT SOACS -&gt; ADM Result) -&gt; ADM (ExpT SOACS) -&gt; ADM Result
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">ADM (Exp (Rep ADM))
-&gt; ADM (Body (Rep ADM))
-&gt; ADM (Body (Rep ADM))
-&gt; ADM (Exp (Rep ADM))
forall (m :: * -&gt; *).
(MonadBuilder m, BranchType (Rep m) ~ ExtType) =&gt;
m (Exp (Rep m))
-&gt; m (Body (Rep m)) -&gt; m (Body (Rep m)) -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#eIf"><span class="hs-identifier hs-var">eIf</span></a></span><span>
</span><span id="line-248"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CmpOp
-&gt; ADM (Exp (Rep ADM))
-&gt; ADM (Exp (Rep ADM))
-&gt; ADM (Exp (Rep ADM))
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
CmpOp -&gt; m (Exp (Rep m)) -&gt; m (Exp (Rep m)) -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#eCmpOp"><span class="hs-identifier hs-var">eCmpOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimType -&gt; CmpOp
</span><a href="Futhark.IR.Primitive.html#CmpEq"><span class="hs-identifier hs-var">CmpEq</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684461581"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param Type -&gt; ADM (Exp (Rep ADM))
forall (m :: * -&gt; *) t.
MonadBuilder m =&gt;
Param t -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#eParam"><span class="hs-identifier hs-var">eParam</span></a></span><span> </span><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684461579"><span class="hs-identifier hs-var">acc_v_p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param Type -&gt; ADM (Exp (Rep ADM))
forall (m :: * -&gt; *) t.
MonadBuilder m =&gt;
Param t -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#eParam"><span class="hs-identifier hs-var">eParam</span></a></span><span> </span><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684461577"><span class="hs-identifier hs-var">v_p</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-249"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">[ADM (Exp (Rep ADM))] -&gt; ADM (Body (Rep ADM))
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[m (Exp (Rep m))] -&gt; m (Body (Rep m))
</span><a href="Futhark.Construct.html#eBody"><span class="hs-identifier hs-var">eBody</span></a></span><span>
</span><span id="line-250"></span><span>              </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Param Type -&gt; ADM (Exp (Rep ADM))
forall (m :: * -&gt; *) t.
MonadBuilder m =&gt;
Param t -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#eParam"><span class="hs-identifier hs-var">eParam</span></a></span><span> </span><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684461579"><span class="hs-identifier hs-var">acc_v_p</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-251"></span><span>                </span><span class="annot"><span class="annottext">BinOp
-&gt; ADM (Exp (Rep ADM))
-&gt; ADM (Exp (Rep ADM))
-&gt; ADM (Exp (Rep ADM))
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
BinOp -&gt; m (Exp (Rep m)) -&gt; m (Exp (Rep m)) -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#eBinOp"><span class="hs-identifier hs-var">eBinOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#SMin"><span class="hs-identifier hs-var">SMin</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param Type -&gt; ADM (Exp (Rep ADM))
forall (m :: * -&gt; *) t.
MonadBuilder m =&gt;
Param t -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#eParam"><span class="hs-identifier hs-var">eParam</span></a></span><span> </span><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684461578"><span class="hs-identifier hs-var">acc_i_p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param Type -&gt; ADM (Exp (Rep ADM))
forall (m :: * -&gt; *) t.
MonadBuilder m =&gt;
Param t -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#eParam"><span class="hs-identifier hs-var">eParam</span></a></span><span> </span><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684461576"><span class="hs-identifier hs-var">i_p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-252"></span><span>              </span><span class="hs-special">]</span><span>
</span><span id="line-253"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-254"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">[ADM (Exp (Rep ADM))] -&gt; ADM (Body (Rep ADM))
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[m (Exp (Rep m))] -&gt; m (Body (Rep m))
</span><a href="Futhark.Construct.html#eBody"><span class="hs-identifier hs-var">eBody</span></a></span><span>
</span><span id="line-255"></span><span>              </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">ADM (Exp (Rep ADM))
-&gt; ADM (Body (Rep ADM))
-&gt; ADM (Body (Rep ADM))
-&gt; ADM (Exp (Rep ADM))
forall (m :: * -&gt; *).
(MonadBuilder m, BranchType (Rep m) ~ ExtType) =&gt;
m (Exp (Rep m))
-&gt; m (Body (Rep m)) -&gt; m (Body (Rep m)) -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#eIf"><span class="hs-identifier hs-var">eIf</span></a></span><span>
</span><span id="line-256"></span><span>                  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">CmpOp
-&gt; ADM (Exp (Rep ADM))
-&gt; ADM (Exp (Rep ADM))
-&gt; ADM (Exp (Rep ADM))
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
CmpOp -&gt; m (Exp (Rep m)) -&gt; m (Exp (Rep m)) -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#eCmpOp"><span class="hs-identifier hs-var">eCmpOp</span></a></span><span>
</span><span id="line-257"></span><span>                      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimType -&gt; CmpOp
</span><a href="Futhark.IR.Primitive.html#CmpEq"><span class="hs-identifier hs-var">CmpEq</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684461581"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-258"></span><span>                      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param Type -&gt; ADM (Exp (Rep ADM))
forall (m :: * -&gt; *) t.
MonadBuilder m =&gt;
Param t -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#eParam"><span class="hs-identifier hs-var">eParam</span></a></span><span> </span><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684461579"><span class="hs-identifier hs-var">acc_v_p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-259"></span><span>                      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BinOp
-&gt; ADM (Exp (Rep ADM))
-&gt; ADM (Exp (Rep ADM))
-&gt; ADM (Exp (Rep ADM))
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
BinOp -&gt; m (Exp (Rep m)) -&gt; m (Exp (Rep m)) -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#eBinOp"><span class="hs-identifier hs-var">eBinOp</span></a></span><span> </span><span class="annot"><span class="annottext">BinOp
</span><a href="#local-6989586621684461585"><span class="hs-identifier hs-var">minmax</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param Type -&gt; ADM (Exp (Rep ADM))
forall (m :: * -&gt; *) t.
MonadBuilder m =&gt;
Param t -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#eParam"><span class="hs-identifier hs-var">eParam</span></a></span><span> </span><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684461579"><span class="hs-identifier hs-var">acc_v_p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param Type -&gt; ADM (Exp (Rep ADM))
forall (m :: * -&gt; *) t.
MonadBuilder m =&gt;
Param t -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#eParam"><span class="hs-identifier hs-var">eParam</span></a></span><span> </span><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684461577"><span class="hs-identifier hs-var">v_p</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-260"></span><span>                  </span><span class="hs-special">)</span><span>
</span><span id="line-261"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[ADM (Exp (Rep ADM))] -&gt; ADM (Body (Rep ADM))
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[m (Exp (Rep m))] -&gt; m (Body (Rep m))
</span><a href="Futhark.Construct.html#eBody"><span class="hs-identifier hs-var">eBody</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Param Type -&gt; ADM (Exp (Rep ADM))
forall (m :: * -&gt; *) t.
MonadBuilder m =&gt;
Param t -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#eParam"><span class="hs-identifier hs-var">eParam</span></a></span><span> </span><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684461579"><span class="hs-identifier hs-var">acc_v_p</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Param Type -&gt; ADM (Exp (Rep ADM))
forall (m :: * -&gt; *) t.
MonadBuilder m =&gt;
Param t -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#eParam"><span class="hs-identifier hs-var">eParam</span></a></span><span> </span><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684461578"><span class="hs-identifier hs-var">acc_i_p</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-262"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[ADM (Exp (Rep ADM))] -&gt; ADM (Body (Rep ADM))
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[m (Exp (Rep m))] -&gt; m (Body (Rep m))
</span><a href="Futhark.Construct.html#eBody"><span class="hs-identifier hs-var">eBody</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Param Type -&gt; ADM (Exp (Rep ADM))
forall (m :: * -&gt; *) t.
MonadBuilder m =&gt;
Param t -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#eParam"><span class="hs-identifier hs-var">eParam</span></a></span><span> </span><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684461577"><span class="hs-identifier hs-var">v_p</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Param Type -&gt; ADM (Exp (Rep ADM))
forall (m :: * -&gt; *) t.
MonadBuilder m =&gt;
Param t -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#eParam"><span class="hs-identifier hs-var">eParam</span></a></span><span> </span><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684461576"><span class="hs-identifier hs-var">i_p</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-263"></span><span>              </span><span class="hs-special">]</span><span>
</span><span id="line-264"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-265"></span><span>
</span><span id="line-266"></span><span>  </span><span id="local-6989586621684461570"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684461570"><span class="hs-identifier hs-var">red_iota</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-267"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; Exp (Rep ADM) -&gt; ADM VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m VName
</span><a href="Futhark.Construct.html#letExp"><span class="hs-identifier hs-var">letExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;red_iota&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep ADM) -&gt; ADM VName) -&gt; Exp (Rep ADM) -&gt; ADM VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-268"></span><span>      </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT SOACS
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT SOACS) -&gt; BasicOp -&gt; ExpT SOACS
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; SubExp -&gt; SubExp -&gt; IntType -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Iota"><span class="hs-identifier hs-var">Iota</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684461586"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Integer -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#intConst"><span class="hs-identifier hs-var">intConst</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Integer -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#intConst"><span class="hs-identifier hs-var">intConst</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span>
</span><span id="line-269"></span><span>  </span><span id="local-6989586621684461569"><span class="annot"><span class="annottext">ScremaForm SOACS
</span><a href="#local-6989586621684461569"><span class="hs-identifier hs-var">form</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Reduce SOACS] -&gt; ADM (ScremaForm SOACS)
forall rep (m :: * -&gt; *).
(Buildable rep, MonadFreshNames m) =&gt;
[Reduce rep] -&gt; m (ScremaForm rep)
</span><a href="Futhark.IR.SOACS.SOAC.html#reduceSOAC"><span class="hs-identifier hs-var">reduceSOAC</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Commutativity -&gt; LambdaT SOACS -&gt; [SubExp] -&gt; Reduce SOACS
forall rep. Commutativity -&gt; Lambda rep -&gt; [SubExp] -&gt; Reduce rep
</span><a href="Futhark.IR.SOACS.SOAC.html#Reduce"><span class="hs-identifier hs-var">Reduce</span></a></span><span> </span><span class="annot"><span class="annottext">Commutativity
</span><a href="Futhark.IR.Syntax.Core.html#Commutative"><span class="hs-identifier hs-var">Commutative</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT SOACS
</span><a href="#local-6989586621684461575"><span class="hs-identifier hs-var">red_lam</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684461584"><span class="hs-identifier hs-var">ne</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IntType -&gt; Integer -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#intConst"><span class="hs-identifier hs-var">intConst</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><span id="line-270"></span><span>  </span><span id="local-6989586621684461566"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684461566"><span class="hs-identifier hs-var">x_ind</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; ADM VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; String -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; String
</span><a href="Language.Futhark.Core.html#baseString"><span class="hs-identifier hs-var">baseString</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684461588"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_ind&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-271"></span><span>  </span><span class="annot"><span class="annottext">StmAux () -&gt; ADM () -&gt; ADM ()
forall (m :: * -&gt; *) anyrep a.
MonadBuilder m =&gt;
StmAux anyrep -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#auxing"><span class="hs-identifier hs-var">auxing</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux ()
</span><a href="#local-6989586621684461587"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">(ADM () -&gt; ADM ()) -&gt; ADM () -&gt; ADM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Exp (Rep ADM) -&gt; ADM ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[VName] -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBindNames"><span class="hs-identifier hs-var">letBindNames</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684461588"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684461566"><span class="hs-identifier hs-var">x_ind</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(Exp (Rep ADM) -&gt; ADM ()) -&gt; Exp (Rep ADM) -&gt; ADM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Op SOACS -&gt; ExpT SOACS
forall rep. Op rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-var">Op</span></a></span><span> </span><span class="annot"><span class="annottext">(Op SOACS -&gt; ExpT SOACS) -&gt; Op SOACS -&gt; ExpT SOACS
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; [VName] -&gt; ScremaForm SOACS -&gt; SOAC SOACS
forall rep. SubExp -&gt; [VName] -&gt; ScremaForm rep -&gt; SOAC rep
</span><a href="Futhark.IR.SOACS.SOAC.html#Screma"><span class="hs-identifier hs-var">Screma</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684461586"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684461583"><span class="hs-keyword hs-var">as</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684461570"><span class="hs-identifier hs-var">red_iota</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">ScremaForm SOACS
</span><a href="#local-6989586621684461569"><span class="hs-identifier hs-var">form</span></a></span><span>
</span><span id="line-272"></span><span>
</span><span id="line-273"></span><span>  </span><span class="annot"><span class="annottext">ADM ()
</span><a href="#local-6989586621684461582"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-274"></span><span>
</span><span id="line-275"></span><span>  </span><span id="local-6989586621684461563"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684461563"><span class="hs-identifier hs-var">x_adj</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; ADM VName
</span><a href="Futhark.AD.Rev.Monad.html#lookupAdjVal"><span class="hs-identifier hs-var">lookupAdjVal</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684461588"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-276"></span><span>  </span><span id="local-6989586621684461561"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684461561"><span class="hs-identifier hs-var">in_bounds</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-277"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; Exp (Rep ADM) -&gt; ADM SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;minmax_in_bounds&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ExpT SOACS -&gt; ADM SubExp)
-&gt; (BasicOp -&gt; ExpT SOACS) -&gt; BasicOp -&gt; ADM SubExp
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT SOACS
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ADM SubExp) -&gt; BasicOp -&gt; ADM SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-278"></span><span>      </span><span class="annot"><span class="annottext">CmpOp -&gt; SubExp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#CmpOp"><span class="hs-identifier hs-var">CmpOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; CmpOp
</span><a href="Futhark.IR.Primitive.html#CmpSlt"><span class="hs-identifier hs-var">CmpSlt</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Integer -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#intConst"><span class="hs-identifier hs-var">intConst</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684461586"><span class="hs-identifier hs-var">w</span></a></span><span>
</span><span id="line-279"></span><span>  </span><span class="annot"><span class="annottext">VName -&gt; (InBounds, SubExp) -&gt; SubExp -&gt; ADM ()
</span><a href="Futhark.AD.Rev.Monad.html#updateAdjIndex"><span class="hs-identifier hs-var">updateAdjIndex</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684461583"><span class="hs-keyword hs-var">as</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe SubExp -&gt; InBounds
</span><a href="Futhark.AD.Rev.Monad.html#CheckBounds"><span class="hs-identifier hs-var">CheckBounds</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp -&gt; Maybe SubExp
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684461561"><span class="hs-identifier hs-var">in_bounds</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684461566"><span class="hs-identifier hs-var">x_ind</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684461563"><span class="hs-identifier hs-var">x_adj</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-280"></span></pre></body></html>