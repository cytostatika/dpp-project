<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# OPTIONS_GHC -Wno-overlapping-patterns -Wno-incomplete-patterns -Wno-incomplete-uni-patterns -Wno-incomplete-record-updates #-}</span><span>
</span><span id="line-6"></span><span>
</span><span id="line-7"></span><span class="hs-comment">-- | Some simplification rules for t'BasicOp'.</span><span>
</span><span id="line-8"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Futhark.Optimise.Simplify.Rules.BasicOp</span><span>
</span><span id="line-9"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#basicOpRules"><span class="hs-identifier">basicOpRules</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-10"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-11"></span><span class="hs-keyword">where</span><span>
</span><span id="line-12"></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">find</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">foldl'</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">isSuffixOf</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">sort</span></span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Analysis.PrimExp.Convert.html"><span class="hs-identifier">Futhark.Analysis.PrimExp.Convert</span></a></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.Analysis.SymbolTable.html"><span class="hs-identifier">Futhark.Analysis.SymbolTable</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">ST</span></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Construct.html"><span class="hs-identifier">Futhark.Construct</span></a></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.html"><span class="hs-identifier">Futhark.IR</span></a></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Aliases.html"><span class="hs-identifier">Futhark.IR.Prop.Aliases</span></a></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Rule.html"><span class="hs-identifier">Futhark.Optimise.Simplify.Rule</span></a></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.Loop.html"><span class="hs-identifier">Futhark.Optimise.Simplify.Rules.Loop</span></a></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.Simple.html"><span class="hs-identifier">Futhark.Optimise.Simplify.Rules.Simple</span></a></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Util.html"><span class="hs-identifier">Futhark.Util</span></a></span><span>
</span><span id="line-24"></span><span>
</span><span id="line-25"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#isCt1"><span class="hs-identifier hs-type">isCt1</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-26"></span><span id="isCt1"><span class="annot"><span class="annottext">isCt1 :: SubExp -&gt; Bool
</span><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#isCt1"><span class="hs-identifier hs-var hs-var">isCt1</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span> </span><span id="local-6989586621684366935"><span class="annot"><span class="annottext">PrimValue
</span><a href="#local-6989586621684366935"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimValue -&gt; Bool
</span><a href="Futhark.IR.Primitive.html#oneIsh"><span class="hs-identifier hs-var">oneIsh</span></a></span><span> </span><span class="annot"><span class="annottext">PrimValue
</span><a href="#local-6989586621684366935"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-27"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#isCt1"><span class="hs-identifier hs-var">isCt1</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-28"></span><span>
</span><span id="line-29"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#isCt0"><span class="hs-identifier hs-type">isCt0</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-30"></span><span id="isCt0"><span class="annot"><span class="annottext">isCt0 :: SubExp -&gt; Bool
</span><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#isCt0"><span class="hs-identifier hs-var hs-var">isCt0</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span> </span><span id="local-6989586621684366932"><span class="annot"><span class="annottext">PrimValue
</span><a href="#local-6989586621684366932"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimValue -&gt; Bool
</span><a href="Futhark.IR.Primitive.html#zeroIsh"><span class="hs-identifier hs-var">zeroIsh</span></a></span><span> </span><span class="annot"><span class="annottext">PrimValue
</span><a href="#local-6989586621684366932"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-31"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#isCt0"><span class="hs-identifier hs-var">isCt0</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-32"></span><span>
</span><span id="line-33"></span><span class="hs-keyword">data</span><span> </span><span id="ConcatArg"><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ConcatArg"><span class="hs-identifier hs-var">ConcatArg</span></a></span></span><span>
</span><span id="line-34"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="ArgArrayLit"><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ArgArrayLit"><span class="hs-identifier hs-var">ArgArrayLit</span></a></span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-35"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="ArgReplicate"><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ArgReplicate"><span class="hs-identifier hs-var">ArgReplicate</span></a></span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span>
</span><span id="line-36"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="ArgVar"><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ArgVar"><span class="hs-identifier hs-var">ArgVar</span></a></span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span>
</span><span id="line-37"></span><span>
</span><span id="line-38"></span><span id="local-6989586621684367191"><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#toConcatArg"><span class="hs-identifier hs-type">toConcatArg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Analysis.SymbolTable.html#SymbolTable"><span class="hs-identifier hs-type">ST.SymbolTable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684367191"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ConcatArg"><span class="hs-identifier hs-type">ConcatArg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Certs"><span class="hs-identifier hs-type">Certs</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-39"></span><span id="toConcatArg"><span class="annot"><span class="annottext">toConcatArg :: forall rep. SymbolTable rep -&gt; VName -&gt; (ConcatArg, Certs)
</span><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#toConcatArg"><span class="hs-identifier hs-var hs-var">toConcatArg</span></a></span></span><span> </span><span id="local-6989586621684366924"><span class="annot"><span class="annottext">SymbolTable rep
</span><a href="#local-6989586621684366924"><span class="hs-identifier hs-var">vtable</span></a></span></span><span> </span><span id="local-6989586621684366923"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366923"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-40"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">VName -&gt; SymbolTable rep -&gt; Maybe (BasicOp, Certs)
forall rep. VName -&gt; SymbolTable rep -&gt; Maybe (BasicOp, Certs)
</span><a href="Futhark.Analysis.SymbolTable.html#lookupBasicOp"><span class="hs-identifier hs-var">ST.lookupBasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366923"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">SymbolTable rep
</span><a href="#local-6989586621684366924"><span class="hs-identifier hs-var">vtable</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-41"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#ArrayLit"><span class="hs-identifier hs-type">ArrayLit</span></a></span><span> </span><span id="local-6989586621684366920"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684366920"><span class="hs-identifier hs-var">ses</span></a></span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684366919"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366919"><span class="hs-identifier hs-var">cs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-42"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; ConcatArg
</span><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ArgArrayLit"><span class="hs-identifier hs-var">ArgArrayLit</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684366920"><span class="hs-identifier hs-var">ses</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366919"><span class="hs-identifier hs-var">cs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Replicate"><span class="hs-identifier hs-type">Replicate</span></a></span><span> </span><span id="local-6989586621684366917"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684366917"><span class="hs-identifier hs-var">shape</span></a></span></span><span> </span><span id="local-6989586621684366916"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366916"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684366915"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366915"><span class="hs-identifier hs-var">cs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-44"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; SubExp -&gt; ConcatArg
</span><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ArgReplicate"><span class="hs-identifier hs-var">ArgReplicate</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int -&gt; Shape -&gt; SubExp
</span><a href="Futhark.IR.Prop.Types.html#shapeSize"><span class="hs-identifier hs-var">shapeSize</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684366917"><span class="hs-identifier hs-var">shape</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366916"><span class="hs-identifier hs-var">se</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366915"><span class="hs-identifier hs-var">cs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span>    </span><span class="annot"><span class="annottext">Maybe (BasicOp, Certs)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-46"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; ConcatArg
</span><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ArgVar"><span class="hs-identifier hs-var">ArgVar</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366923"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Certs
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span>
</span><span id="line-47"></span><span>
</span><span id="line-48"></span><span id="local-6989586621684367181"><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#fromConcatArg"><span class="hs-identifier hs-type">fromConcatArg</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-49"></span><span>  </span><span class="annot"><a href="Futhark.Builder.Class.html#MonadBuilder"><span class="hs-identifier hs-type">MonadBuilder</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684367181"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-50"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-51"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ConcatArg"><span class="hs-identifier hs-type">ConcatArg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Certs"><span class="hs-identifier hs-type">Certs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-52"></span><span>  </span><span class="annot"><a href="#local-6989586621684367181"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span></span><span>
</span><span id="line-53"></span><span id="fromConcatArg"><span class="annot"><span class="annottext">fromConcatArg :: forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Type -&gt; (ConcatArg, Certs) -&gt; m VName
</span><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#fromConcatArg"><span class="hs-identifier hs-var hs-var">fromConcatArg</span></a></span></span><span> </span><span id="local-6989586621684366881"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684366881"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ArgArrayLit"><span class="hs-identifier hs-type">ArgArrayLit</span></a></span><span> </span><span id="local-6989586621684366880"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684366880"><span class="hs-identifier hs-var">ses</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684366879"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366879"><span class="hs-identifier hs-var">cs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-54"></span><span>  </span><span class="annot"><span class="annottext">Certs -&gt; m VName -&gt; m VName
forall (m :: * -&gt; *) a. MonadBuilder m =&gt; Certs -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#certifying"><span class="hs-identifier hs-var">certifying</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366879"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">(m VName -&gt; m VName) -&gt; m VName -&gt; m VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Exp (Rep m) -&gt; m VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m VName
</span><a href="Futhark.Construct.html#letExp"><span class="hs-identifier hs-var">letExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;concat_lit&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep m) -&gt; m VName) -&gt; Exp (Rep m) -&gt; m VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; Exp (Rep m)
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; Exp (Rep m)) -&gt; BasicOp -&gt; Exp (Rep m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; Type -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#ArrayLit"><span class="hs-identifier hs-var">ArrayLit</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684366880"><span class="hs-identifier hs-var">ses</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; BasicOp) -&gt; Type -&gt; BasicOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
forall u. TypeBase Shape u -&gt; TypeBase Shape u
</span><a href="Futhark.IR.Prop.Types.html#rowType"><span class="hs-identifier hs-var">rowType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684366881"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-55"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#fromConcatArg"><span class="hs-identifier hs-var">fromConcatArg</span></a></span><span> </span><span id="local-6989586621684366874"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684366874"><span class="hs-identifier hs-var">elem_type</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ArgReplicate"><span class="hs-identifier hs-type">ArgReplicate</span></a></span><span> </span><span id="local-6989586621684366873"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684366873"><span class="hs-identifier hs-var">ws</span></a></span></span><span> </span><span id="local-6989586621684366872"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366872"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684366871"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366871"><span class="hs-identifier hs-var">cs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-56"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684366870"><span class="annot"><span class="annottext">elem_shape :: Shape
</span><a href="#local-6989586621684366870"><span class="hs-identifier hs-var hs-var">elem_shape</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Shape
forall shape u. ArrayShape shape =&gt; TypeBase shape u -&gt; shape
</span><a href="Futhark.IR.Prop.Types.html#arrayShape"><span class="hs-identifier hs-var">arrayShape</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684366874"><span class="hs-identifier hs-var">elem_type</span></a></span><span>
</span><span id="line-57"></span><span>  </span><span class="annot"><span class="annottext">Certs -&gt; m VName -&gt; m VName
forall (m :: * -&gt; *) a. MonadBuilder m =&gt; Certs -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#certifying"><span class="hs-identifier hs-var">certifying</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366871"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">(m VName -&gt; m VName) -&gt; m VName -&gt; m VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-58"></span><span>    </span><span id="local-6989586621684366868"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366868"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; Exp (Rep m) -&gt; m SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;concat_rep_w&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep m) -&gt; m SubExp) -&gt; m (Exp (Rep m)) -&gt; m SubExp
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; m (Exp (Rep m))
forall a (m :: * -&gt; *).
(ToExp a, MonadBuilder m) =&gt;
a -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#toExp"><span class="hs-identifier hs-var">toExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TPrimExp Int64 VName] -&gt; TPrimExp Int64 VName
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">sum</span></span><span> </span><span class="annot"><span class="annottext">([TPrimExp Int64 VName] -&gt; TPrimExp Int64 VName)
-&gt; [TPrimExp Int64 VName] -&gt; TPrimExp Int64 VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TPrimExp Int64 VName)
-&gt; [SubExp] -&gt; [TPrimExp Int64 VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TPrimExp Int64 VName
</span><a href="Futhark.Analysis.PrimExp.Convert.html#pe64"><span class="hs-identifier hs-var">pe64</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684366873"><span class="hs-identifier hs-var">ws</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-59"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; Exp (Rep m) -&gt; m VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m VName
</span><a href="Futhark.Construct.html#letExp"><span class="hs-identifier hs-var">letExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;concat_rep&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep m) -&gt; m VName) -&gt; Exp (Rep m) -&gt; m VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; Exp (Rep m)
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; Exp (Rep m)) -&gt; BasicOp -&gt; Exp (Rep m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Shape -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Replicate"><span class="hs-identifier hs-var">Replicate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Shape -&gt; SubExp -&gt; Shape
forall d. Int -&gt; ShapeBase d -&gt; d -&gt; ShapeBase d
</span><a href="Futhark.IR.Prop.Types.html#setDim"><span class="hs-identifier hs-var">setDim</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684366870"><span class="hs-identifier hs-var">elem_shape</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366868"><span class="hs-identifier hs-var">w</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366872"><span class="hs-identifier hs-var">se</span></a></span><span>
</span><span id="line-60"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#fromConcatArg"><span class="hs-identifier hs-var">fromConcatArg</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ArgVar"><span class="hs-identifier hs-type">ArgVar</span></a></span><span> </span><span id="local-6989586621684366861"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366861"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Certs
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-61"></span><span>  </span><span class="annot"><span class="annottext">VName -&gt; m VName
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366861"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-62"></span><span>
</span><span id="line-63"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#fuseConcatArg"><span class="hs-identifier hs-type">fuseConcatArg</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-64"></span><span>  </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ConcatArg"><span class="hs-identifier hs-type">ConcatArg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Certs"><span class="hs-identifier hs-type">Certs</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-65"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ConcatArg"><span class="hs-identifier hs-type">ConcatArg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Certs"><span class="hs-identifier hs-type">Certs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-66"></span><span>  </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ConcatArg"><span class="hs-identifier hs-type">ConcatArg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Certs"><span class="hs-identifier hs-type">Certs</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-67"></span><span id="fuseConcatArg"><span class="annot"><span class="annottext">fuseConcatArg :: [(ConcatArg, Certs)] -&gt; (ConcatArg, Certs) -&gt; [(ConcatArg, Certs)]
</span><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#fuseConcatArg"><span class="hs-identifier hs-var hs-var">fuseConcatArg</span></a></span></span><span> </span><span id="local-6989586621684366859"><span class="annot"><span class="annottext">[(ConcatArg, Certs)]
</span><a href="#local-6989586621684366859"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ArgArrayLit"><span class="hs-identifier hs-type">ArgArrayLit</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Certs
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-68"></span><span>  </span><span class="annot"><span class="annottext">[(ConcatArg, Certs)]
</span><a href="#local-6989586621684366859"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-69"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#fuseConcatArg"><span class="hs-identifier hs-var">fuseConcatArg</span></a></span><span> </span><span id="local-6989586621684366858"><span class="annot"><span class="annottext">[(ConcatArg, Certs)]
</span><a href="#local-6989586621684366858"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ArgReplicate"><span class="hs-identifier hs-type">ArgReplicate</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621684366857"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366857"><span class="hs-identifier hs-var">w</span></a></span></span><span class="hs-special">]</span><span> </span><span id="local-6989586621684366856"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366856"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684366855"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366855"><span class="hs-identifier hs-var">cs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Bool
</span><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#isCt0"><span class="hs-identifier hs-var">isCt0</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366857"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-71"></span><span>    </span><span class="annot"><span class="annottext">[(ConcatArg, Certs)]
</span><a href="#local-6989586621684366858"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-72"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Bool
</span><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#isCt1"><span class="hs-identifier hs-var">isCt1</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366857"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-73"></span><span>    </span><span class="annot"><span class="annottext">[(ConcatArg, Certs)] -&gt; (ConcatArg, Certs) -&gt; [(ConcatArg, Certs)]
</span><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#fuseConcatArg"><span class="hs-identifier hs-var">fuseConcatArg</span></a></span><span> </span><span class="annot"><span class="annottext">[(ConcatArg, Certs)]
</span><a href="#local-6989586621684366858"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; ConcatArg
</span><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ArgArrayLit"><span class="hs-identifier hs-var">ArgArrayLit</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366856"><span class="hs-identifier hs-var">se</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366855"><span class="hs-identifier hs-var">cs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-74"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#fuseConcatArg"><span class="hs-identifier hs-var">fuseConcatArg</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ArgArrayLit"><span class="hs-identifier hs-type">ArgArrayLit</span></a></span><span> </span><span id="local-6989586621684366854"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684366854"><span class="hs-identifier hs-var">x_ses</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684366853"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366853"><span class="hs-identifier hs-var">x_cs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684366852"><span class="annot"><span class="annottext">[(ConcatArg, Certs)]
</span><a href="#local-6989586621684366852"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ArgArrayLit"><span class="hs-identifier hs-type">ArgArrayLit</span></a></span><span> </span><span id="local-6989586621684366851"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684366851"><span class="hs-identifier hs-var">y_ses</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684366850"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366850"><span class="hs-identifier hs-var">y_cs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-75"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; ConcatArg
</span><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ArgArrayLit"><span class="hs-identifier hs-var">ArgArrayLit</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684366854"><span class="hs-identifier hs-var">x_ses</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; [SubExp] -&gt; [SubExp]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684366851"><span class="hs-identifier hs-var">y_ses</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366853"><span class="hs-identifier hs-var">x_cs</span></a></span><span> </span><span class="annot"><span class="annottext">Certs -&gt; Certs -&gt; Certs
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366850"><span class="hs-identifier hs-var">y_cs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ConcatArg, Certs) -&gt; [(ConcatArg, Certs)] -&gt; [(ConcatArg, Certs)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[(ConcatArg, Certs)]
</span><a href="#local-6989586621684366852"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-76"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#fuseConcatArg"><span class="hs-identifier hs-var">fuseConcatArg</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ArgReplicate"><span class="hs-identifier hs-type">ArgReplicate</span></a></span><span> </span><span id="local-6989586621684366849"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684366849"><span class="hs-identifier hs-var">x_ws</span></a></span></span><span> </span><span id="local-6989586621684366848"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366848"><span class="hs-identifier hs-var">x_se</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684366847"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366847"><span class="hs-identifier hs-var">x_cs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684366846"><span class="annot"><span class="annottext">[(ConcatArg, Certs)]
</span><a href="#local-6989586621684366846"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ArgReplicate"><span class="hs-identifier hs-type">ArgReplicate</span></a></span><span> </span><span id="local-6989586621684366845"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684366845"><span class="hs-identifier hs-var">y_ws</span></a></span></span><span> </span><span id="local-6989586621684366844"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366844"><span class="hs-identifier hs-var">y_se</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684366843"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366843"><span class="hs-identifier hs-var">y_cs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-77"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366848"><span class="hs-identifier hs-var">x_se</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; SubExp -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366844"><span class="hs-identifier hs-var">y_se</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-78"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; SubExp -&gt; ConcatArg
</span><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ArgReplicate"><span class="hs-identifier hs-var">ArgReplicate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684366849"><span class="hs-identifier hs-var">x_ws</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; [SubExp] -&gt; [SubExp]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684366845"><span class="hs-identifier hs-var">y_ws</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366848"><span class="hs-identifier hs-var">x_se</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366847"><span class="hs-identifier hs-var">x_cs</span></a></span><span> </span><span class="annot"><span class="annottext">Certs -&gt; Certs -&gt; Certs
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366843"><span class="hs-identifier hs-var">y_cs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ConcatArg, Certs) -&gt; [(ConcatArg, Certs)] -&gt; [(ConcatArg, Certs)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[(ConcatArg, Certs)]
</span><a href="#local-6989586621684366846"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-79"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#fuseConcatArg"><span class="hs-identifier hs-var">fuseConcatArg</span></a></span><span> </span><span id="local-6989586621684366842"><span class="annot"><span class="annottext">[(ConcatArg, Certs)]
</span><a href="#local-6989586621684366842"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span id="local-6989586621684366841"><span class="annot"><span class="annottext">(ConcatArg, Certs)
</span><a href="#local-6989586621684366841"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-80"></span><span>  </span><span class="annot"><span class="annottext">(ConcatArg, Certs)
</span><a href="#local-6989586621684366841"><span class="hs-identifier hs-var">y</span></a></span><span> </span><span class="annot"><span class="annottext">(ConcatArg, Certs) -&gt; [(ConcatArg, Certs)] -&gt; [(ConcatArg, Certs)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[(ConcatArg, Certs)]
</span><a href="#local-6989586621684366842"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-81"></span><span>
</span><span id="line-82"></span><span id="local-6989586621684367135"><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#simplifyConcat"><span class="hs-identifier hs-type">simplifyConcat</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Builder.html#BuilderOps"><span class="hs-identifier hs-type">BuilderOps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684367135"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Rule.html#BottomUpRuleBasicOp"><span class="hs-identifier hs-type">BottomUpRuleBasicOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684367135"><span class="hs-identifier hs-type">rep</span></a></span></span><span>
</span><span id="line-83"></span><span class="hs-comment">-- concat@1(transpose(x),transpose(y)) == transpose(concat@0(x,y))</span><span>
</span><span id="line-84"></span><span id="simplifyConcat"><span class="annot"><span class="annottext">simplifyConcat :: forall rep. BuilderOps rep =&gt; BottomUpRuleBasicOp rep
</span><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#simplifyConcat"><span class="hs-identifier hs-var hs-var">simplifyConcat</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684366768"><span class="annot"><span class="annottext">SymbolTable rep
</span><a href="#local-6989586621684366768"><span class="hs-identifier hs-var">vtable</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684366767"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684366767"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Concat"><span class="hs-identifier hs-type">Concat</span></a></span><span> </span><span id="local-6989586621684366765"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684366765"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621684366764"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366764"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621684366763"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684366763"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span id="local-6989586621684366762"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366762"><span class="hs-identifier hs-var">new_d</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-85"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684366761"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684366761"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Int
forall shape u. ArrayShape shape =&gt; TypeBase shape u -&gt; Int
</span><a href="Futhark.IR.Prop.Types.html#arrayRank"><span class="hs-identifier hs-var">arrayRank</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Int) -&gt; Maybe Type -&gt; Maybe Int
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SymbolTable rep -&gt; Maybe Type
forall rep. ASTRep rep =&gt; VName -&gt; SymbolTable rep -&gt; Maybe Type
</span><a href="Futhark.Analysis.SymbolTable.html#lookupType"><span class="hs-identifier hs-var">ST.lookupType</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366764"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">SymbolTable rep
</span><a href="#local-6989586621684366768"><span class="hs-identifier hs-var">vtable</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-86"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684366757"><span class="annot"><span class="annottext">perm :: [Int]
</span><a href="#local-6989586621684366757"><span class="hs-identifier hs-var hs-var">perm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684366765"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; [Int] -&gt; [Int]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684366765"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; [Int] -&gt; [Int]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684366765"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684366761"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><span id="line-87"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684366755"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366755"><span class="hs-identifier hs-var">x'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684366754"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366754"><span class="hs-identifier hs-var">x_cs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; VName -&gt; Maybe (VName, Certs)
</span><a href="#local-6989586621684366753"><span class="hs-identifier hs-var">transposedBy</span></a></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684366757"><span class="hs-identifier hs-var">perm</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366764"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-88"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684366752"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684366752"><span class="hs-identifier hs-var">xs'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684366751"><span class="annot"><span class="annottext">[Certs]
</span><a href="#local-6989586621684366751"><span class="hs-identifier hs-var">xs_cs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(VName, Certs)] -&gt; ([VName], [Certs])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(VName, Certs)] -&gt; ([VName], [Certs]))
-&gt; Maybe [(VName, Certs)] -&gt; Maybe ([VName], [Certs])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Maybe (VName, Certs))
-&gt; [VName] -&gt; Maybe [(VName, Certs)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Int] -&gt; VName -&gt; Maybe (VName, Certs)
</span><a href="#local-6989586621684366753"><span class="hs-identifier hs-var">transposedBy</span></a></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684366757"><span class="hs-identifier hs-var">perm</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684366763"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleM rep () -&gt; Rule rep
forall rep. RuleM rep () -&gt; Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Simplify"><span class="hs-identifier hs-var">Simplify</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; Rule rep) -&gt; RuleM rep () -&gt; Rule rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-89"></span><span>    </span><span id="local-6989586621684366747"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366747"><span class="hs-identifier hs-var">concat_rearrange</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-90"></span><span>      </span><span class="annot"><span class="annottext">Certs -&gt; RuleM rep VName -&gt; RuleM rep VName
forall (m :: * -&gt; *) a. MonadBuilder m =&gt; Certs -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#certifying"><span class="hs-identifier hs-var">certifying</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366754"><span class="hs-identifier hs-var">x_cs</span></a></span><span> </span><span class="annot"><span class="annottext">Certs -&gt; Certs -&gt; Certs
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Certs] -&gt; Certs
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">[Certs]
</span><a href="#local-6989586621684366751"><span class="hs-identifier hs-var">xs_cs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(RuleM rep VName -&gt; RuleM rep VName)
-&gt; RuleM rep VName -&gt; RuleM rep VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-91"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m VName
</span><a href="Futhark.Construct.html#letExp"><span class="hs-identifier hs-var">letExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;concat_rearrange&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep VName)
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; VName -&gt; [VName] -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Concat"><span class="hs-identifier hs-var">Concat</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366755"><span class="hs-identifier hs-var">x'</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684366752"><span class="hs-identifier hs-var">xs'</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366762"><span class="hs-identifier hs-var">new_d</span></a></span><span>
</span><span id="line-92"></span><span>    </span><span class="annot"><span class="annottext">Pat (Rep (RuleM rep)) -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
Pat (Rep (RuleM rep))
</span><a href="#local-6989586621684366767"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep ())
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; VName -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Rearrange"><span class="hs-identifier hs-var">Rearrange</span></a></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684366757"><span class="hs-identifier hs-var">perm</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366747"><span class="hs-identifier hs-var">concat_rearrange</span></a></span><span>
</span><span id="line-93"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-94"></span><span>    </span><span id="local-6989586621684366753"><span class="annot"><span class="annottext">transposedBy :: [Int] -&gt; VName -&gt; Maybe (VName, Certs)
</span><a href="#local-6989586621684366753"><span class="hs-identifier hs-var hs-var">transposedBy</span></a></span></span><span> </span><span id="local-6989586621684366744"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684366744"><span class="hs-identifier hs-var">perm1</span></a></span></span><span> </span><span id="local-6989586621684366743"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366743"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-95"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">VName -&gt; SymbolTable rep -&gt; Maybe (ExpT rep, Certs)
forall rep. VName -&gt; SymbolTable rep -&gt; Maybe (Exp rep, Certs)
</span><a href="Futhark.Analysis.SymbolTable.html#lookupExp"><span class="hs-identifier hs-var">ST.lookupExp</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366743"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">SymbolTable rep
</span><a href="#local-6989586621684366768"><span class="hs-identifier hs-var">vtable</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-96"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Rearrange"><span class="hs-identifier hs-type">Rearrange</span></a></span><span> </span><span id="local-6989586621684366741"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684366741"><span class="hs-identifier hs-var">perm2</span></a></span></span><span> </span><span id="local-6989586621684366740"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366740"><span class="hs-identifier hs-var">v'</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621684366739"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366739"><span class="hs-identifier hs-var">vcs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-97"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684366744"><span class="hs-identifier hs-var">perm1</span></a></span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; [Int] -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684366741"><span class="hs-identifier hs-var">perm2</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(VName, Certs) -&gt; Maybe (VName, Certs)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366740"><span class="hs-identifier hs-var">v'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366739"><span class="hs-identifier hs-var">vcs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-98"></span><span>        </span><span class="annot"><span class="annottext">Maybe (ExpT rep, Certs)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (VName, Certs)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-99"></span><span>
</span><span id="line-100"></span><span class="hs-comment">-- Removing a concatenation that involves only a single array.  This</span><span>
</span><span id="line-101"></span><span class="hs-comment">-- may be produced as a result of other simplification rules.</span><span>
</span><span id="line-102"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#simplifyConcat"><span class="hs-identifier hs-var">simplifyConcat</span></a></span><span> </span><span class="annot"><span class="annottext">(SymbolTable rep, UsageTable)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684366738"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684366738"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684366737"><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><a href="#local-6989586621684366737"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Concat"><span class="hs-identifier hs-type">Concat</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684366736"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366736"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-103"></span><span>  </span><span class="annot"><span class="annottext">RuleM rep () -&gt; Rule rep
forall rep. RuleM rep () -&gt; Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Simplify"><span class="hs-identifier hs-var">Simplify</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; Rule rep) -&gt; RuleM rep () -&gt; Rule rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-104"></span><span>    </span><span class="hs-comment">-- Still need a copy because Concat produces a fresh array.</span><span>
</span><span id="line-105"></span><span>    </span><span class="annot"><span class="annottext">StmAux (ExpDec rep) -&gt; RuleM rep () -&gt; RuleM rep ()
forall (m :: * -&gt; *) anyrep a.
MonadBuilder m =&gt;
StmAux anyrep -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#auxing"><span class="hs-identifier hs-var">auxing</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><a href="#local-6989586621684366737"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; RuleM rep ()) -&gt; RuleM rep () -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat (Rep (RuleM rep)) -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
Pat (Rep (RuleM rep))
</span><a href="#local-6989586621684366738"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep ())
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Copy"><span class="hs-identifier hs-var">Copy</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366736"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-106"></span><span class="hs-comment">-- concat xs (concat ys zs) == concat xs ys zs</span><span>
</span><span id="line-107"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#simplifyConcat"><span class="hs-identifier hs-var">simplifyConcat</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684366733"><span class="annot"><span class="annottext">SymbolTable rep
</span><a href="#local-6989586621684366733"><span class="hs-identifier hs-var">vtable</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684366732"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684366732"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#StmAux"><span class="hs-identifier hs-type">StmAux</span></a></span><span> </span><span id="local-6989586621684366730"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366730"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span id="local-6989586621684366729"><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684366729"><span class="hs-identifier hs-var">attrs</span></a></span></span><span> </span><span class="annot"><span class="annottext">ExpDec rep
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Concat"><span class="hs-identifier hs-type">Concat</span></a></span><span> </span><span id="local-6989586621684366728"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684366728"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621684366727"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366727"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621684366726"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684366726"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span id="local-6989586621684366725"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366725"><span class="hs-identifier hs-var">new_d</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-108"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366724"><span class="hs-identifier hs-var">x'</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; VName -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366727"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">[[VName]] -&gt; [VName]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span> </span><span class="annot"><span class="annottext">[[VName]]
</span><a href="#local-6989586621684366720"><span class="hs-identifier hs-var">xs'</span></a></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684366726"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-109"></span><span>    </span><span class="annot"><span class="annottext">RuleM rep () -&gt; Rule rep
forall rep. RuleM rep () -&gt; Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Simplify"><span class="hs-identifier hs-var">Simplify</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; Rule rep) -&gt; RuleM rep () -&gt; Rule rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-110"></span><span>      </span><span class="annot"><span class="annottext">Certs -&gt; RuleM rep () -&gt; RuleM rep ()
forall (m :: * -&gt; *) a. MonadBuilder m =&gt; Certs -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#certifying"><span class="hs-identifier hs-var">certifying</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366730"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">Certs -&gt; Certs -&gt; Certs
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366719"><span class="hs-identifier hs-var">x_cs</span></a></span><span> </span><span class="annot"><span class="annottext">Certs -&gt; Certs -&gt; Certs
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Certs] -&gt; Certs
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">[Certs]
</span><a href="#local-6989586621684366718"><span class="hs-identifier hs-var">xs_cs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; RuleM rep ()) -&gt; RuleM rep () -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-111"></span><span>        </span><span class="annot"><span class="annottext">Attrs -&gt; RuleM rep () -&gt; RuleM rep ()
forall (m :: * -&gt; *) a. MonadBuilder m =&gt; Attrs -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#attributing"><span class="hs-identifier hs-var">attributing</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684366729"><span class="hs-identifier hs-var">attrs</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; RuleM rep ()) -&gt; RuleM rep () -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-112"></span><span>          </span><span class="annot"><span class="annottext">Pat (Rep (RuleM rep)) -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
Pat (Rep (RuleM rep))
</span><a href="#local-6989586621684366732"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep ())
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-113"></span><span>            </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; VName -&gt; [VName] -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Concat"><span class="hs-identifier hs-var">Concat</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684366728"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366724"><span class="hs-identifier hs-var">x'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684366716"><span class="hs-identifier hs-var">zs</span></a></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[[VName]] -&gt; [VName]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span> </span><span class="annot"><span class="annottext">[[VName]]
</span><a href="#local-6989586621684366720"><span class="hs-identifier hs-var">xs'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366725"><span class="hs-identifier hs-var">new_d</span></a></span><span>
</span><span id="line-114"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-115"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684366724"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366724"><span class="hs-identifier hs-var">x'</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684366716"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684366716"><span class="hs-identifier hs-var">zs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684366719"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366719"><span class="hs-identifier hs-var">x_cs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; ([VName], Certs)
</span><a href="#local-6989586621684366715"><span class="hs-identifier hs-var">isConcat</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366727"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-116"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684366720"><span class="annot"><span class="annottext">[[VName]]
</span><a href="#local-6989586621684366720"><span class="hs-identifier hs-var">xs'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684366718"><span class="annot"><span class="annottext">[Certs]
</span><a href="#local-6989586621684366718"><span class="hs-identifier hs-var">xs_cs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[([VName], Certs)] -&gt; ([[VName]], [Certs])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([([VName], Certs)] -&gt; ([[VName]], [Certs]))
-&gt; [([VName], Certs)] -&gt; ([[VName]], [Certs])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; ([VName], Certs)) -&gt; [VName] -&gt; [([VName], Certs)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; ([VName], Certs)
</span><a href="#local-6989586621684366715"><span class="hs-identifier hs-var">isConcat</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684366726"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-117"></span><span>    </span><span id="local-6989586621684366715"><span class="annot"><span class="annottext">isConcat :: VName -&gt; ([VName], Certs)
</span><a href="#local-6989586621684366715"><span class="hs-identifier hs-var hs-var">isConcat</span></a></span></span><span> </span><span id="local-6989586621684366714"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366714"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">VName -&gt; SymbolTable rep -&gt; Maybe (BasicOp, Certs)
forall rep. VName -&gt; SymbolTable rep -&gt; Maybe (BasicOp, Certs)
</span><a href="Futhark.Analysis.SymbolTable.html#lookupBasicOp"><span class="hs-identifier hs-var">ST.lookupBasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366714"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">SymbolTable rep
</span><a href="#local-6989586621684366733"><span class="hs-identifier hs-var">vtable</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-118"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Concat"><span class="hs-identifier hs-type">Concat</span></a></span><span> </span><span id="local-6989586621684366713"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684366713"><span class="hs-identifier hs-var">j</span></a></span></span><span> </span><span id="local-6989586621684366712"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366712"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span id="local-6989586621684366711"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684366711"><span class="hs-identifier hs-var">ys</span></a></span></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684366710"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366710"><span class="hs-identifier hs-var">v_cs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684366713"><span class="hs-identifier hs-var">j</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684366728"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366712"><span class="hs-identifier hs-var">y</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [VName] -&gt; [VName]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684366711"><span class="hs-identifier hs-var">ys</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366710"><span class="hs-identifier hs-var">v_cs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-119"></span><span>      </span><span class="annot"><span class="annottext">Maybe (BasicOp, Certs)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366714"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Certs
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span>
</span><span id="line-120"></span><span>
</span><span id="line-121"></span><span class="hs-comment">-- Fusing arguments to the concat when possible.  Only done when</span><span>
</span><span id="line-122"></span><span class="hs-comment">-- concatenating along the outer dimension for now.</span><span>
</span><span id="line-123"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#simplifyConcat"><span class="hs-identifier hs-var">simplifyConcat</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684366709"><span class="annot"><span class="annottext">SymbolTable rep
</span><a href="#local-6989586621684366709"><span class="hs-identifier hs-var">vtable</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684366708"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684366708"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684366707"><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><a href="#local-6989586621684366707"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Concat"><span class="hs-identifier hs-type">Concat</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span id="local-6989586621684366706"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366706"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621684366705"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684366705"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span id="local-6989586621684366704"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366704"><span class="hs-identifier hs-var">outer_w</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-124"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-comment">-- We produce the to-be-concatenated arrays in reverse order, so</span><span>
</span><span id="line-125"></span><span>    </span><span class="hs-comment">-- reverse them back.</span><span>
</span><span id="line-126"></span><span>    </span><span id="local-6989586621684366703"><span class="annot"><span class="annottext">(ConcatArg, Certs)
</span><a href="#local-6989586621684366703"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684366702"><span class="annot"><span class="annottext">[(ConcatArg, Certs)]
</span><a href="#local-6989586621684366702"><span class="hs-identifier hs-var">ys</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-127"></span><span>      </span><span class="annot"><span class="annottext">[(ConcatArg, Certs)] -&gt; [(ConcatArg, Certs)]
</span><a href="#local-6989586621684366701"><span class="hs-identifier hs-var">forSingleArray</span></a></span><span> </span><span class="annot"><span class="annottext">([(ConcatArg, Certs)] -&gt; [(ConcatArg, Certs)])
-&gt; [(ConcatArg, Certs)] -&gt; [(ConcatArg, Certs)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-128"></span><span>        </span><span class="annot"><span class="annottext">[(ConcatArg, Certs)] -&gt; [(ConcatArg, Certs)]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">([(ConcatArg, Certs)] -&gt; [(ConcatArg, Certs)])
-&gt; [(ConcatArg, Certs)] -&gt; [(ConcatArg, Certs)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-129"></span><span>          </span><span class="annot"><span class="annottext">([(ConcatArg, Certs)]
 -&gt; (ConcatArg, Certs) -&gt; [(ConcatArg, Certs)])
-&gt; [(ConcatArg, Certs)]
-&gt; [(ConcatArg, Certs)]
-&gt; [(ConcatArg, Certs)]
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span> </span><span class="annot"><span class="annottext">[(ConcatArg, Certs)] -&gt; (ConcatArg, Certs) -&gt; [(ConcatArg, Certs)]
</span><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#fuseConcatArg"><span class="hs-identifier hs-var">fuseConcatArg</span></a></span><span> </span><span class="annot"><span class="annottext">[(ConcatArg, Certs)]
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">([(ConcatArg, Certs)] -&gt; [(ConcatArg, Certs)])
-&gt; [(ConcatArg, Certs)] -&gt; [(ConcatArg, Certs)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-130"></span><span>            </span><span class="annot"><span class="annottext">(VName -&gt; (ConcatArg, Certs)) -&gt; [VName] -&gt; [(ConcatArg, Certs)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SymbolTable rep -&gt; VName -&gt; (ConcatArg, Certs)
forall rep. SymbolTable rep -&gt; VName -&gt; (ConcatArg, Certs)
</span><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#toConcatArg"><span class="hs-identifier hs-var">toConcatArg</span></a></span><span> </span><span class="annot"><span class="annottext">SymbolTable rep
</span><a href="#local-6989586621684366709"><span class="hs-identifier hs-var">vtable</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; [(ConcatArg, Certs)])
-&gt; [VName] -&gt; [(ConcatArg, Certs)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366706"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [VName] -&gt; [VName]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684366705"><span class="hs-identifier hs-var">xs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-131"></span><span>    </span><span class="annot"><span class="annottext">[VName] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684366705"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">[(ConcatArg, Certs)] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[(ConcatArg, Certs)]
</span><a href="#local-6989586621684366702"><span class="hs-identifier hs-var">ys</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-132"></span><span>    </span><span class="annot"><span class="annottext">RuleM rep () -&gt; Rule rep
forall rep. RuleM rep () -&gt; Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Simplify"><span class="hs-identifier hs-var">Simplify</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; Rule rep) -&gt; RuleM rep () -&gt; Rule rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-133"></span><span>      </span><span id="local-6989586621684366698"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684366698"><span class="hs-identifier hs-var">elem_type</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; RuleM rep Type
forall rep (m :: * -&gt; *). HasScope rep m =&gt; VName -&gt; m Type
</span><a href="Futhark.IR.Prop.Scope.html#lookupType"><span class="hs-identifier hs-var">lookupType</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366706"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-134"></span><span>      </span><span id="local-6989586621684366696"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366696"><span class="hs-identifier hs-var">y'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; (ConcatArg, Certs) -&gt; RuleM rep VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Type -&gt; (ConcatArg, Certs) -&gt; m VName
</span><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#fromConcatArg"><span class="hs-identifier hs-var">fromConcatArg</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684366698"><span class="hs-identifier hs-var">elem_type</span></a></span><span> </span><span class="annot"><span class="annottext">(ConcatArg, Certs)
</span><a href="#local-6989586621684366703"><span class="hs-identifier hs-var">y</span></a></span><span>
</span><span id="line-135"></span><span>      </span><span id="local-6989586621684366695"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684366695"><span class="hs-identifier hs-var">ys'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((ConcatArg, Certs) -&gt; RuleM rep VName)
-&gt; [(ConcatArg, Certs)] -&gt; RuleM rep [VName]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; (ConcatArg, Certs) -&gt; RuleM rep VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Type -&gt; (ConcatArg, Certs) -&gt; m VName
</span><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#fromConcatArg"><span class="hs-identifier hs-var">fromConcatArg</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684366698"><span class="hs-identifier hs-var">elem_type</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(ConcatArg, Certs)]
</span><a href="#local-6989586621684366702"><span class="hs-identifier hs-var">ys</span></a></span><span>
</span><span id="line-136"></span><span>      </span><span class="annot"><span class="annottext">StmAux (ExpDec rep) -&gt; RuleM rep () -&gt; RuleM rep ()
forall (m :: * -&gt; *) anyrep a.
MonadBuilder m =&gt;
StmAux anyrep -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#auxing"><span class="hs-identifier hs-var">auxing</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><a href="#local-6989586621684366707"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; RuleM rep ()) -&gt; RuleM rep () -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat (Rep (RuleM rep)) -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
Pat (Rep (RuleM rep))
</span><a href="#local-6989586621684366708"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep ())
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; VName -&gt; [VName] -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Concat"><span class="hs-identifier hs-var">Concat</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366696"><span class="hs-identifier hs-var">y'</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684366695"><span class="hs-identifier hs-var">ys'</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366704"><span class="hs-identifier hs-var">outer_w</span></a></span><span>
</span><span id="line-137"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-138"></span><span>    </span><span class="hs-comment">-- If we fuse so much that there is only a single input left, then</span><span>
</span><span id="line-139"></span><span>    </span><span class="hs-comment">-- it must have the right size.</span><span>
</span><span id="line-140"></span><span>    </span><span id="local-6989586621684366701"><span class="annot"><span class="annottext">forSingleArray :: [(ConcatArg, Certs)] -&gt; [(ConcatArg, Certs)]
</span><a href="#local-6989586621684366701"><span class="hs-identifier hs-var hs-var">forSingleArray</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ArgReplicate"><span class="hs-identifier hs-type">ArgReplicate</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684366694"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366694"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684366693"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366693"><span class="hs-identifier hs-var">cs</span></a></span></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-141"></span><span>      </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; SubExp -&gt; ConcatArg
</span><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ArgReplicate"><span class="hs-identifier hs-var">ArgReplicate</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366704"><span class="hs-identifier hs-var">outer_w</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366694"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366693"><span class="hs-identifier hs-var">cs</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-142"></span><span>    </span><span class="annot"><a href="#local-6989586621684366701"><span class="hs-identifier hs-var">forSingleArray</span></a></span><span> </span><span id="local-6989586621684366692"><span class="annot"><span class="annottext">[(ConcatArg, Certs)]
</span><a href="#local-6989586621684366692"><span class="hs-identifier hs-var">ys</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(ConcatArg, Certs)]
</span><a href="#local-6989586621684366692"><span class="hs-identifier hs-var">ys</span></a></span><span>
</span><span id="line-143"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#simplifyConcat"><span class="hs-identifier hs-var">simplifyConcat</span></a></span><span> </span><span class="annot"><span class="annottext">(SymbolTable rep, UsageTable)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">BasicOp
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Rule rep
forall rep. Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span>
</span><span id="line-144"></span><span>
</span><span id="line-145"></span><span id="local-6989586621684367087"><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ruleBasicOp"><span class="hs-identifier hs-type">ruleBasicOp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Builder.html#BuilderOps"><span class="hs-identifier hs-type">BuilderOps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684367087"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Rule.html#TopDownRuleBasicOp"><span class="hs-identifier hs-type">TopDownRuleBasicOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684367087"><span class="hs-identifier hs-type">rep</span></a></span></span><span>
</span><span id="line-146"></span><span id="ruleBasicOp"><span class="annot"><span class="annottext">ruleBasicOp :: forall rep. BuilderOps rep =&gt; TopDownRuleBasicOp rep
</span><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ruleBasicOp"><span class="hs-identifier hs-var hs-var">ruleBasicOp</span></a></span></span><span> </span><span id="local-6989586621684366489"><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684366489"><span class="hs-identifier hs-var">vtable</span></a></span></span><span> </span><span id="local-6989586621684366488"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684366488"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684366487"><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><a href="#local-6989586621684366487"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span id="local-6989586621684366486"><span class="annot"><span class="annottext">BasicOp
</span><a href="#local-6989586621684366486"><span class="hs-identifier hs-var">op</span></a></span></span><span>
</span><span id="line-147"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684366485"><span class="annot"><span class="annottext">BasicOp
</span><a href="#local-6989586621684366485"><span class="hs-identifier hs-var">op'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684366484"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366484"><span class="hs-identifier hs-var">cs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VarLookup rep -&gt; TypeLookup -&gt; BasicOp -&gt; Maybe (BasicOp, Certs)
forall rep.
VarLookup rep -&gt; TypeLookup -&gt; BasicOp -&gt; Maybe (BasicOp, Certs)
</span><a href="Futhark.Optimise.Simplify.Rules.Simple.html#applySimpleRules"><span class="hs-identifier hs-var">applySimpleRules</span></a></span><span> </span><span class="annot"><span class="annottext">VarLookup rep
</span><a href="#local-6989586621684366482"><span class="hs-identifier hs-var">defOf</span></a></span><span> </span><span class="annot"><span class="annottext">TypeLookup
</span><a href="#local-6989586621684366481"><span class="hs-identifier hs-var">seType</span></a></span><span> </span><span class="annot"><span class="annottext">BasicOp
</span><a href="#local-6989586621684366486"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-148"></span><span>    </span><span class="annot"><span class="annottext">RuleM rep () -&gt; Rule rep
forall rep. RuleM rep () -&gt; Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Simplify"><span class="hs-identifier hs-var">Simplify</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; Rule rep) -&gt; RuleM rep () -&gt; Rule rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Certs -&gt; RuleM rep () -&gt; RuleM rep ()
forall (m :: * -&gt; *) a. MonadBuilder m =&gt; Certs -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#certifying"><span class="hs-identifier hs-var">certifying</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366484"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">Certs -&gt; Certs -&gt; Certs
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep) -&gt; Certs
forall dec. StmAux dec -&gt; Certs
</span><a href="Futhark.IR.Syntax.html#stmAuxCerts"><span class="hs-identifier hs-var hs-var">stmAuxCerts</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><a href="#local-6989586621684366487"><span class="hs-identifier hs-var">aux</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; RuleM rep ()) -&gt; RuleM rep () -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat (Rep (RuleM rep)) -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
Pat (Rep (RuleM rep))
</span><a href="#local-6989586621684366488"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep ())
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">BasicOp
</span><a href="#local-6989586621684366485"><span class="hs-identifier hs-var">op'</span></a></span><span>
</span><span id="line-149"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-150"></span><span>    </span><span id="local-6989586621684366482"><span class="annot"><span class="annottext">defOf :: VarLookup rep
</span><a href="#local-6989586621684366482"><span class="hs-identifier hs-var hs-var">defOf</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; TopDown rep -&gt; Maybe (ExpT rep, Certs)
forall rep. VName -&gt; SymbolTable rep -&gt; Maybe (Exp rep, Certs)
</span><a href="Futhark.Analysis.SymbolTable.html#lookupExp"><span class="hs-operator hs-var">`ST.lookupExp`</span></a></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684366489"><span class="hs-identifier hs-var">vtable</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-151"></span><span>    </span><span id="local-6989586621684366481"><span class="annot"><span class="annottext">seType :: TypeLookup
</span><a href="#local-6989586621684366481"><span class="hs-identifier hs-var hs-var">seType</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684366478"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366478"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; TopDown rep -&gt; Maybe Type
forall rep. ASTRep rep =&gt; VName -&gt; SymbolTable rep -&gt; Maybe Type
</span><a href="Futhark.Analysis.SymbolTable.html#lookupType"><span class="hs-identifier hs-var">ST.lookupType</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366478"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684366489"><span class="hs-identifier hs-var">vtable</span></a></span><span>
</span><span id="line-152"></span><span>    </span><span class="annot"><a href="#local-6989586621684366481"><span class="hs-identifier hs-var">seType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span> </span><span id="local-6989586621684366477"><span class="annot"><span class="annottext">PrimValue
</span><a href="#local-6989586621684366477"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe Type
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Maybe Type) -&gt; Type -&gt; Maybe Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; Type
forall shape u. PrimType -&gt; TypeBase shape u
</span><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimType -&gt; Type) -&gt; PrimType -&gt; Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimValue -&gt; PrimType
</span><a href="Futhark.IR.Primitive.html#primValueType"><span class="hs-identifier hs-var">primValueType</span></a></span><span> </span><span class="annot"><span class="annottext">PrimValue
</span><a href="#local-6989586621684366477"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-153"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ruleBasicOp"><span class="hs-identifier hs-var">ruleBasicOp</span></a></span><span> </span><span id="local-6989586621684366474"><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684366474"><span class="hs-identifier hs-var">vtable</span></a></span></span><span> </span><span id="local-6989586621684366473"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684366473"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Update"><span class="hs-identifier hs-type">Update</span></a></span><span> </span><span class="annot"><span class="annottext">Safety
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684366471"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366471"><span class="hs-identifier hs-var">src</span></a></span></span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684366470"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366470"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-154"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Scratch"><span class="hs-identifier hs-type">Scratch</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Certs
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; TopDown rep -&gt; Maybe (ExpT rep, Certs)
forall rep. VName -&gt; SymbolTable rep -&gt; Maybe (Exp rep, Certs)
</span><a href="Futhark.Analysis.SymbolTable.html#lookupExp"><span class="hs-identifier hs-var">ST.lookupExp</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366470"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684366474"><span class="hs-identifier hs-var">vtable</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-155"></span><span>    </span><span class="annot"><span class="annottext">RuleM rep () -&gt; Rule rep
forall rep. RuleM rep () -&gt; Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Simplify"><span class="hs-identifier hs-var">Simplify</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; Rule rep) -&gt; RuleM rep () -&gt; Rule rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat (Rep (RuleM rep)) -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
Pat (Rep (RuleM rep))
</span><a href="#local-6989586621684366473"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep ())
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#SubExp"><span class="hs-identifier hs-var">SubExp</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; BasicOp) -&gt; SubExp -&gt; BasicOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366471"><span class="hs-identifier hs-var">src</span></a></span><span>
</span><span id="line-156"></span><span class="hs-comment">-- If we are writing a single-element slice from some array, and the</span><span>
</span><span id="line-157"></span><span class="hs-comment">-- element of that array can be computed as a PrimExp based on the</span><span>
</span><span id="line-158"></span><span class="hs-comment">-- index, let's just write that instead.</span><span>
</span><span id="line-159"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ruleBasicOp"><span class="hs-identifier hs-var">ruleBasicOp</span></a></span><span> </span><span id="local-6989586621684366467"><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684366467"><span class="hs-identifier hs-var">vtable</span></a></span></span><span> </span><span id="local-6989586621684366466"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684366466"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684366465"><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><a href="#local-6989586621684366465"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Update"><span class="hs-identifier hs-type">Update</span></a></span><span> </span><span id="local-6989586621684366464"><span class="annot"><span class="annottext">Safety
</span><a href="#local-6989586621684366464"><span class="hs-identifier hs-var">safety</span></a></span></span><span> </span><span id="local-6989586621684366463"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366463"><span class="hs-identifier hs-var">src</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-type">Slice</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#DimSlice"><span class="hs-identifier hs-type">DimSlice</span></a></span><span> </span><span id="local-6989586621684366460"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366460"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621684366459"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366459"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621684366458"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366458"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684366457"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366457"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-160"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Bool
</span><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#isCt1"><span class="hs-identifier hs-var">isCt1</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366459"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-161"></span><span>    </span><span class="annot"><span class="annottext">SubExp -&gt; Bool
</span><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#isCt1"><span class="hs-identifier hs-var">isCt1</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366458"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-162"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.SymbolTable.html#Indexed"><span class="hs-identifier hs-type">ST.Indexed</span></a></span><span> </span><span id="local-6989586621684366455"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366455"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span id="local-6989586621684366454"><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684366454"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; [SubExp] -&gt; TopDown rep -&gt; Maybe Indexed
forall rep.
ASTRep rep =&gt;
VName -&gt; [SubExp] -&gt; SymbolTable rep -&gt; Maybe Indexed
</span><a href="Futhark.Analysis.SymbolTable.html#index"><span class="hs-identifier hs-var">ST.index</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366457"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">IntType -&gt; Integer -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#intConst"><span class="hs-identifier hs-var">intConst</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684366467"><span class="hs-identifier hs-var">vtable</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-163"></span><span>    </span><span class="annot"><span class="annottext">RuleM rep () -&gt; Rule rep
forall rep. RuleM rep () -&gt; Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Simplify"><span class="hs-identifier hs-var">Simplify</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; Rule rep) -&gt; RuleM rep () -&gt; Rule rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-164"></span><span>      </span><span id="local-6989586621684366450"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366450"><span class="hs-identifier hs-var">e'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; PrimExp VName -&gt; RuleM rep SubExp
forall (m :: * -&gt; *) a.
(MonadBuilder m, ToExp a) =&gt;
String -&gt; a -&gt; m SubExp
</span><a href="Futhark.Construct.html#toSubExp"><span class="hs-identifier hs-var">toSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;update_elem&quot;</span></span><span> </span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684366454"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-165"></span><span>      </span><span class="annot"><span class="annottext">StmAux (ExpDec rep) -&gt; RuleM rep () -&gt; RuleM rep ()
forall (m :: * -&gt; *) anyrep a.
MonadBuilder m =&gt;
StmAux anyrep -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#auxing"><span class="hs-identifier hs-var">auxing</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><a href="#local-6989586621684366465"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; RuleM rep ())
-&gt; (RuleM rep () -&gt; RuleM rep ()) -&gt; RuleM rep () -&gt; RuleM rep ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Certs -&gt; RuleM rep () -&gt; RuleM rep ()
forall (m :: * -&gt; *) a. MonadBuilder m =&gt; Certs -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#certifying"><span class="hs-identifier hs-var">certifying</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366455"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; RuleM rep ()) -&gt; RuleM rep () -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-166"></span><span>        </span><span class="annot"><span class="annottext">Pat (Rep (RuleM rep)) -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
Pat (Rep (RuleM rep))
</span><a href="#local-6989586621684366466"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep ())
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Safety -&gt; VName -&gt; Slice SubExp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Update"><span class="hs-identifier hs-var">Update</span></a></span><span> </span><span class="annot"><span class="annottext">Safety
</span><a href="#local-6989586621684366464"><span class="hs-identifier hs-var">safety</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366463"><span class="hs-identifier hs-var">src</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DimIndex SubExp] -&gt; Slice SubExp
forall d. [DimIndex d] -&gt; Slice d
</span><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-var">Slice</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SubExp -&gt; DimIndex SubExp
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366460"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366450"><span class="hs-identifier hs-var">e'</span></a></span><span>
</span><span id="line-167"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ruleBasicOp"><span class="hs-identifier hs-var">ruleBasicOp</span></a></span><span> </span><span id="local-6989586621684366446"><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684366446"><span class="hs-identifier hs-var">vtable</span></a></span></span><span> </span><span id="local-6989586621684366445"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684366445"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Update"><span class="hs-identifier hs-type">Update</span></a></span><span> </span><span class="annot"><span class="annottext">Safety
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684366444"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366444"><span class="hs-identifier hs-var">dest</span></a></span></span><span> </span><span id="local-6989586621684366443"><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684366443"><span class="hs-identifier hs-var">destis</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684366442"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366442"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-168"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684366441"><span class="annot"><span class="annottext">ExpT rep
</span><a href="#local-6989586621684366441"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Certs
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; TopDown rep -&gt; Maybe (ExpT rep, Certs)
forall rep. VName -&gt; SymbolTable rep -&gt; Maybe (Exp rep, Certs)
</span><a href="Futhark.Analysis.SymbolTable.html#lookupExp"><span class="hs-identifier hs-var">ST.lookupExp</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366442"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684366446"><span class="hs-identifier hs-var">vtable</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-169"></span><span>    </span><span class="annot"><span class="annottext">ExpT rep -&gt; Bool
</span><a href="#local-6989586621684366440"><span class="hs-identifier hs-var">arrayFrom</span></a></span><span> </span><span class="annot"><span class="annottext">ExpT rep
</span><a href="#local-6989586621684366441"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-170"></span><span>    </span><span class="annot"><span class="annottext">RuleM rep () -&gt; Rule rep
forall rep. RuleM rep () -&gt; Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Simplify"><span class="hs-identifier hs-var">Simplify</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; Rule rep) -&gt; RuleM rep () -&gt; Rule rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat (Rep (RuleM rep)) -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
Pat (Rep (RuleM rep))
</span><a href="#local-6989586621684366445"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep ())
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#SubExp"><span class="hs-identifier hs-var">SubExp</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; BasicOp) -&gt; SubExp -&gt; BasicOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366444"><span class="hs-identifier hs-var">dest</span></a></span><span>
</span><span id="line-171"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-172"></span><span>    </span><span id="local-6989586621684366440"><span class="annot"><span class="annottext">arrayFrom :: ExpT rep -&gt; Bool
</span><a href="#local-6989586621684366440"><span class="hs-identifier hs-var hs-var">arrayFrom</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Copy"><span class="hs-identifier hs-type">Copy</span></a></span><span> </span><span id="local-6989586621684366439"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366439"><span class="hs-identifier hs-var">copy_v</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-173"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684366438"><span class="annot"><span class="annottext">ExpT rep
</span><a href="#local-6989586621684366438"><span class="hs-identifier hs-var">e'</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Certs
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; TopDown rep -&gt; Maybe (ExpT rep, Certs)
forall rep. VName -&gt; SymbolTable rep -&gt; Maybe (Exp rep, Certs)
</span><a href="Futhark.Analysis.SymbolTable.html#lookupExp"><span class="hs-identifier hs-var">ST.lookupExp</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366439"><span class="hs-identifier hs-var">copy_v</span></a></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684366446"><span class="hs-identifier hs-var">vtable</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-174"></span><span>        </span><span class="annot"><span class="annottext">ExpT rep -&gt; Bool
</span><a href="#local-6989586621684366440"><span class="hs-identifier hs-var">arrayFrom</span></a></span><span> </span><span class="annot"><span class="annottext">ExpT rep
</span><a href="#local-6989586621684366438"><span class="hs-identifier hs-var">e'</span></a></span><span>
</span><span id="line-175"></span><span>    </span><span class="annot"><a href="#local-6989586621684366440"><span class="hs-identifier hs-var">arrayFrom</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Index"><span class="hs-identifier hs-type">Index</span></a></span><span> </span><span id="local-6989586621684366436"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366436"><span class="hs-identifier hs-var">src</span></a></span></span><span> </span><span id="local-6989586621684366435"><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684366435"><span class="hs-identifier hs-var">srcis</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-176"></span><span>      </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366436"><span class="hs-identifier hs-var">src</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; VName -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366444"><span class="hs-identifier hs-var">dest</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684366443"><span class="hs-identifier hs-var">destis</span></a></span><span> </span><span class="annot"><span class="annottext">Slice SubExp -&gt; Slice SubExp -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684366435"><span class="hs-identifier hs-var">srcis</span></a></span><span>
</span><span id="line-177"></span><span>    </span><span class="annot"><a href="#local-6989586621684366440"><span class="hs-identifier hs-var">arrayFrom</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Replicate"><span class="hs-identifier hs-type">Replicate</span></a></span><span> </span><span id="local-6989586621684366433"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684366433"><span class="hs-identifier hs-var">v_shape</span></a></span></span><span> </span><span id="local-6989586621684366432"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366432"><span class="hs-identifier hs-var">v_se</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-178"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Replicate"><span class="hs-identifier hs-type">Replicate</span></a></span><span> </span><span id="local-6989586621684366431"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684366431"><span class="hs-identifier hs-var">dest_shape</span></a></span></span><span> </span><span id="local-6989586621684366430"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366430"><span class="hs-identifier hs-var">dest_se</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Certs
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; TopDown rep -&gt; Maybe (BasicOp, Certs)
forall rep. VName -&gt; SymbolTable rep -&gt; Maybe (BasicOp, Certs)
</span><a href="Futhark.Analysis.SymbolTable.html#lookupBasicOp"><span class="hs-identifier hs-var">ST.lookupBasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366444"><span class="hs-identifier hs-var">dest</span></a></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684366446"><span class="hs-identifier hs-var">vtable</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-179"></span><span>        </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366432"><span class="hs-identifier hs-var">v_se</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; SubExp -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366430"><span class="hs-identifier hs-var">dest_se</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-180"></span><span>        </span><span class="annot"><span class="annottext">Shape -&gt; [SubExp]
forall d. ShapeBase d -&gt; [d]
</span><a href="Futhark.IR.Syntax.Core.html#shapeDims"><span class="hs-identifier hs-var hs-var">shapeDims</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684366433"><span class="hs-identifier hs-var">v_shape</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; [SubExp] -&gt; Bool
forall a. Eq a =&gt; [a] -&gt; [a] -&gt; Bool
</span><span class="hs-operator hs-var">`isSuffixOf`</span></span><span> </span><span class="annot"><span class="annottext">Shape -&gt; [SubExp]
forall d. ShapeBase d -&gt; [d]
</span><a href="Futhark.IR.Syntax.Core.html#shapeDims"><span class="hs-identifier hs-var hs-var">shapeDims</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684366431"><span class="hs-identifier hs-var">dest_shape</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-181"></span><span>        </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-182"></span><span>    </span><span class="annot"><a href="#local-6989586621684366440"><span class="hs-identifier hs-var">arrayFrom</span></a></span><span> </span><span class="annot"><span class="annottext">ExpT rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-183"></span><span>      </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-184"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ruleBasicOp"><span class="hs-identifier hs-var">ruleBasicOp</span></a></span><span> </span><span id="local-6989586621684366428"><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684366428"><span class="hs-identifier hs-var">vtable</span></a></span></span><span> </span><span id="local-6989586621684366427"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684366427"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Update"><span class="hs-identifier hs-type">Update</span></a></span><span> </span><span class="annot"><span class="annottext">Safety
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684366426"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366426"><span class="hs-identifier hs-var">dest</span></a></span></span><span> </span><span id="local-6989586621684366425"><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684366425"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span id="local-6989586621684366424"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366424"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-185"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684366423"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684366423"><span class="hs-identifier hs-var">dest_t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; TopDown rep -&gt; Maybe Type
forall rep. ASTRep rep =&gt; VName -&gt; SymbolTable rep -&gt; Maybe Type
</span><a href="Futhark.Analysis.SymbolTable.html#lookupType"><span class="hs-identifier hs-var">ST.lookupType</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366426"><span class="hs-identifier hs-var">dest</span></a></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684366428"><span class="hs-identifier hs-var">vtable</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-186"></span><span>    </span><span class="annot"><span class="annottext">Shape -&gt; Slice SubExp -&gt; Bool
</span><a href="Futhark.Construct.html#isFullSlice"><span class="hs-identifier hs-var">isFullSlice</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Shape
forall shape u. ArrayShape shape =&gt; TypeBase shape u -&gt; shape
</span><a href="Futhark.IR.Prop.Types.html#arrayShape"><span class="hs-identifier hs-var">arrayShape</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684366423"><span class="hs-identifier hs-var">dest_t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684366425"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleM rep () -&gt; Rule rep
forall rep. RuleM rep () -&gt; Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Simplify"><span class="hs-identifier hs-var">Simplify</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; Rule rep) -&gt; RuleM rep () -&gt; Rule rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-187"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366424"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-188"></span><span>      </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684366421"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366421"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; Bool) -&gt; [SubExp] -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Slice SubExp -&gt; [SubExp]
forall d. Slice d -&gt; [d]
</span><a href="Futhark.IR.Syntax.Core.html#sliceDims"><span class="hs-identifier hs-var">sliceDims</span></a></span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684366425"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-189"></span><span>        </span><span id="local-6989586621684366417"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366417"><span class="hs-identifier hs-var">v_reshaped</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-190"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m VName
</span><a href="Futhark.Construct.html#letExp"><span class="hs-identifier hs-var">letExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; String
</span><a href="Language.Futhark.Core.html#baseString"><span class="hs-identifier hs-var">baseString</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366421"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_reshaped&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep VName)
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-191"></span><span>            </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ShapeChange SubExp -&gt; VName -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Reshape"><span class="hs-identifier hs-var">Reshape</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SubExp -&gt; DimChange SubExp) -&gt; [SubExp] -&gt; ShapeChange SubExp
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; DimChange SubExp
forall d. d -&gt; DimChange d
</span><a href="Futhark.IR.Syntax.html#DimNew"><span class="hs-identifier hs-var">DimNew</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; ShapeChange SubExp) -&gt; [SubExp] -&gt; ShapeChange SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; [SubExp]
forall u. TypeBase Shape u -&gt; [SubExp]
</span><a href="Futhark.IR.Prop.Types.html#arrayDims"><span class="hs-identifier hs-var">arrayDims</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684366423"><span class="hs-identifier hs-var">dest_t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366421"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-192"></span><span>        </span><span class="annot"><span class="annottext">Pat (Rep (RuleM rep)) -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
Pat (Rep (RuleM rep))
</span><a href="#local-6989586621684366427"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep ())
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Copy"><span class="hs-identifier hs-var">Copy</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366417"><span class="hs-identifier hs-var">v_reshaped</span></a></span><span>
</span><span id="line-193"></span><span>      </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Pat (Rep (RuleM rep)) -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
Pat (Rep (RuleM rep))
</span><a href="#local-6989586621684366427"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep ())
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; Type -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#ArrayLit"><span class="hs-identifier hs-var">ArrayLit</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366424"><span class="hs-identifier hs-var">se</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(Type -&gt; BasicOp) -&gt; Type -&gt; BasicOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
forall u. TypeBase Shape u -&gt; TypeBase Shape u
</span><a href="Futhark.IR.Prop.Types.html#rowType"><span class="hs-identifier hs-var">rowType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684366423"><span class="hs-identifier hs-var">dest_t</span></a></span><span>
</span><span id="line-194"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ruleBasicOp"><span class="hs-identifier hs-var">ruleBasicOp</span></a></span><span> </span><span id="local-6989586621684366412"><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684366412"><span class="hs-identifier hs-var">vtable</span></a></span></span><span> </span><span id="local-6989586621684366411"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684366411"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#StmAux"><span class="hs-identifier hs-type">StmAux</span></a></span><span> </span><span id="local-6989586621684366410"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366410"><span class="hs-identifier hs-var">cs1</span></a></span></span><span> </span><span id="local-6989586621684366409"><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684366409"><span class="hs-identifier hs-var">attrs</span></a></span></span><span> </span><span class="annot"><span class="annottext">ExpDec rep
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Update"><span class="hs-identifier hs-type">Update</span></a></span><span> </span><span id="local-6989586621684366408"><span class="annot"><span class="annottext">Safety
</span><a href="#local-6989586621684366408"><span class="hs-identifier hs-var">safety1</span></a></span></span><span> </span><span id="local-6989586621684366407"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366407"><span class="hs-identifier hs-var">dest1</span></a></span></span><span> </span><span id="local-6989586621684366406"><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684366406"><span class="hs-identifier hs-var">is1</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684366405"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366405"><span class="hs-identifier hs-var">v1</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-195"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Update"><span class="hs-identifier hs-type">Update</span></a></span><span> </span><span id="local-6989586621684366404"><span class="annot"><span class="annottext">Safety
</span><a href="#local-6989586621684366404"><span class="hs-identifier hs-var">safety2</span></a></span></span><span> </span><span id="local-6989586621684366403"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366403"><span class="hs-identifier hs-var">dest2</span></a></span></span><span> </span><span id="local-6989586621684366402"><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684366402"><span class="hs-identifier hs-var">is2</span></a></span></span><span> </span><span id="local-6989586621684366401"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366401"><span class="hs-identifier hs-var">se2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684366400"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366400"><span class="hs-identifier hs-var">cs2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; TopDown rep -&gt; Maybe (BasicOp, Certs)
forall rep. VName -&gt; SymbolTable rep -&gt; Maybe (BasicOp, Certs)
</span><a href="Futhark.Analysis.SymbolTable.html#lookupBasicOp"><span class="hs-identifier hs-var">ST.lookupBasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366405"><span class="hs-identifier hs-var">v1</span></a></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684366412"><span class="hs-identifier hs-var">vtable</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-196"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Copy"><span class="hs-identifier hs-type">Copy</span></a></span><span> </span><span id="local-6989586621684366399"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366399"><span class="hs-identifier hs-var">v3</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684366398"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366398"><span class="hs-identifier hs-var">cs3</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; TopDown rep -&gt; Maybe (BasicOp, Certs)
forall rep. VName -&gt; SymbolTable rep -&gt; Maybe (BasicOp, Certs)
</span><a href="Futhark.Analysis.SymbolTable.html#lookupBasicOp"><span class="hs-identifier hs-var">ST.lookupBasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366403"><span class="hs-identifier hs-var">dest2</span></a></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684366412"><span class="hs-identifier hs-var">vtable</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-197"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Index"><span class="hs-identifier hs-type">Index</span></a></span><span> </span><span id="local-6989586621684366397"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366397"><span class="hs-identifier hs-var">v4</span></a></span></span><span> </span><span id="local-6989586621684366396"><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684366396"><span class="hs-identifier hs-var">is4</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684366395"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366395"><span class="hs-identifier hs-var">cs4</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; TopDown rep -&gt; Maybe (BasicOp, Certs)
forall rep. VName -&gt; SymbolTable rep -&gt; Maybe (BasicOp, Certs)
</span><a href="Futhark.Analysis.SymbolTable.html#lookupBasicOp"><span class="hs-identifier hs-var">ST.lookupBasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366399"><span class="hs-identifier hs-var">v3</span></a></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684366412"><span class="hs-identifier hs-var">vtable</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-198"></span><span>    </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684366396"><span class="hs-identifier hs-var">is4</span></a></span><span> </span><span class="annot"><span class="annottext">Slice SubExp -&gt; Slice SubExp -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684366406"><span class="hs-identifier hs-var">is1</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-199"></span><span>    </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366397"><span class="hs-identifier hs-var">v4</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; VName -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366407"><span class="hs-identifier hs-var">dest1</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-200"></span><span>    </span><span class="annot"><span class="annottext">RuleM rep () -&gt; Rule rep
forall rep. RuleM rep () -&gt; Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Simplify"><span class="hs-identifier hs-var">Simplify</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; Rule rep) -&gt; RuleM rep () -&gt; Rule rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-201"></span><span>      </span><span class="annot"><span class="annottext">Certs -&gt; RuleM rep () -&gt; RuleM rep ()
forall (m :: * -&gt; *) a. MonadBuilder m =&gt; Certs -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#certifying"><span class="hs-identifier hs-var">certifying</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366410"><span class="hs-identifier hs-var">cs1</span></a></span><span> </span><span class="annot"><span class="annottext">Certs -&gt; Certs -&gt; Certs
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366400"><span class="hs-identifier hs-var">cs2</span></a></span><span> </span><span class="annot"><span class="annottext">Certs -&gt; Certs -&gt; Certs
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366398"><span class="hs-identifier hs-var">cs3</span></a></span><span> </span><span class="annot"><span class="annottext">Certs -&gt; Certs -&gt; Certs
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366395"><span class="hs-identifier hs-var">cs4</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; RuleM rep ()) -&gt; RuleM rep () -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-202"></span><span>        </span><span id="local-6989586621684366394"><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684366394"><span class="hs-identifier hs-var">is5</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Slice (TPrimExp Int64 VName) -&gt; RuleM rep (Slice SubExp)
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Slice (TPrimExp Int64 VName) -&gt; m (Slice SubExp)
</span><a href="Futhark.Analysis.PrimExp.Convert.html#subExpSlice"><span class="hs-identifier hs-var">subExpSlice</span></a></span><span> </span><span class="annot"><span class="annottext">(Slice (TPrimExp Int64 VName) -&gt; RuleM rep (Slice SubExp))
-&gt; Slice (TPrimExp Int64 VName) -&gt; RuleM rep (Slice SubExp)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Slice (TPrimExp Int64 VName)
-&gt; Slice (TPrimExp Int64 VName) -&gt; Slice (TPrimExp Int64 VName)
forall d. Num d =&gt; Slice d -&gt; Slice d -&gt; Slice d
</span><a href="Futhark.IR.Syntax.Core.html#sliceSlice"><span class="hs-identifier hs-var">sliceSlice</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Slice SubExp -&gt; Slice (TPrimExp Int64 VName)
</span><a href="Futhark.Analysis.PrimExp.Convert.html#primExpSlice"><span class="hs-identifier hs-var">primExpSlice</span></a></span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684366406"><span class="hs-identifier hs-var">is1</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Slice SubExp -&gt; Slice (TPrimExp Int64 VName)
</span><a href="Futhark.Analysis.PrimExp.Convert.html#primExpSlice"><span class="hs-identifier hs-var">primExpSlice</span></a></span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684366402"><span class="hs-identifier hs-var">is2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-203"></span><span>        </span><span class="annot"><span class="annottext">Attrs -&gt; RuleM rep () -&gt; RuleM rep ()
forall (m :: * -&gt; *) a. MonadBuilder m =&gt; Attrs -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#attributing"><span class="hs-identifier hs-var">attributing</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684366409"><span class="hs-identifier hs-var">attrs</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; RuleM rep ()) -&gt; RuleM rep () -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat (Rep (RuleM rep)) -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
Pat (Rep (RuleM rep))
</span><a href="#local-6989586621684366411"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep ())
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Safety -&gt; VName -&gt; Slice SubExp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Update"><span class="hs-identifier hs-var">Update</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Safety -&gt; Safety -&gt; Safety
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">max</span></span><span> </span><span class="annot"><span class="annottext">Safety
</span><a href="#local-6989586621684366408"><span class="hs-identifier hs-var">safety1</span></a></span><span> </span><span class="annot"><span class="annottext">Safety
</span><a href="#local-6989586621684366404"><span class="hs-identifier hs-var">safety2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366407"><span class="hs-identifier hs-var">dest1</span></a></span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684366394"><span class="hs-identifier hs-var">is5</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366401"><span class="hs-identifier hs-var">se2</span></a></span><span>
</span><span id="line-204"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ruleBasicOp"><span class="hs-identifier hs-var">ruleBasicOp</span></a></span><span> </span><span id="local-6989586621684366389"><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684366389"><span class="hs-identifier hs-var">vtable</span></a></span></span><span> </span><span id="local-6989586621684366388"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684366388"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#CmpOp"><span class="hs-identifier hs-type">CmpOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Primitive.html#CmpEq"><span class="hs-identifier hs-type">CmpEq</span></a></span><span> </span><span id="local-6989586621684366385"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684366385"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684366384"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366384"><span class="hs-identifier hs-var">se1</span></a></span></span><span> </span><span id="local-6989586621684366383"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366383"><span class="hs-identifier hs-var">se2</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-205"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684366382"><span class="annot"><span class="annottext">RuleM rep ()
</span><a href="#local-6989586621684366382"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; SubExp -&gt; Maybe (RuleM rep ())
</span><a href="#local-6989586621684366381"><span class="hs-identifier hs-var">simplifyWith</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366384"><span class="hs-identifier hs-var">se1</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366383"><span class="hs-identifier hs-var">se2</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleM rep () -&gt; Rule rep
forall rep. RuleM rep () -&gt; Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Simplify"><span class="hs-identifier hs-var">Simplify</span></a></span><span> </span><span class="annot"><span class="annottext">RuleM rep ()
</span><a href="#local-6989586621684366382"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-206"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684366380"><span class="annot"><span class="annottext">RuleM rep ()
</span><a href="#local-6989586621684366380"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; SubExp -&gt; Maybe (RuleM rep ())
</span><a href="#local-6989586621684366381"><span class="hs-identifier hs-var">simplifyWith</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366383"><span class="hs-identifier hs-var">se2</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366384"><span class="hs-identifier hs-var">se1</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleM rep () -&gt; Rule rep
forall rep. RuleM rep () -&gt; Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Simplify"><span class="hs-identifier hs-var">Simplify</span></a></span><span> </span><span class="annot"><span class="annottext">RuleM rep ()
</span><a href="#local-6989586621684366380"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-207"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-208"></span><span>    </span><span id="local-6989586621684366381"><span class="annot"><span class="annottext">simplifyWith :: SubExp -&gt; SubExp -&gt; Maybe (RuleM rep ())
</span><a href="#local-6989586621684366381"><span class="hs-identifier hs-var hs-var">simplifyWith</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684366379"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366379"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684366378"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366378"><span class="hs-identifier hs-var">x</span></a></span></span><span>
</span><span id="line-209"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684366377"><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684366377"><span class="hs-identifier hs-var">stm</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; TopDown rep -&gt; Maybe (Stm rep)
forall rep. VName -&gt; SymbolTable rep -&gt; Maybe (Stm rep)
</span><a href="Futhark.Analysis.SymbolTable.html#lookupStm"><span class="hs-identifier hs-var">ST.lookupStm</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366379"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684366389"><span class="hs-identifier hs-var">vtable</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-210"></span><span>        </span><span class="annot"><a href="Futhark.IR.Syntax.html#If"><span class="hs-identifier hs-type">If</span></a></span><span> </span><span id="local-6989586621684366374"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366374"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621684366373"><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684366373"><span class="hs-identifier hs-var">tbranch</span></a></span></span><span> </span><span id="local-6989586621684366372"><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684366372"><span class="hs-identifier hs-var">fbranch</span></a></span></span><span> </span><span class="annot"><span class="annottext">IfDec (BranchType rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; ExpT rep
forall rep. Stm rep -&gt; Exp rep
</span><a href="Futhark.IR.Syntax.html#stmExp"><span class="hs-identifier hs-var hs-var">stmExp</span></a></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684366377"><span class="hs-identifier hs-var">stm</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-211"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684366370"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366370"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684366369"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366369"><span class="hs-identifier hs-var">z</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-212"></span><span>          </span><span class="annot"><span class="annottext">VName
-&gt; Pat rep -&gt; BodyT rep -&gt; BodyT rep -&gt; Maybe (SubExp, SubExp)
forall {dec} {rep} {rep}.
VName
-&gt; PatT dec -&gt; BodyT rep -&gt; BodyT rep -&gt; Maybe (SubExp, SubExp)
</span><a href="#local-6989586621684366368"><span class="hs-identifier hs-var">returns</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366379"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stm rep -&gt; Pat rep
forall rep. Stm rep -&gt; Pat rep
</span><a href="Futhark.IR.Syntax.html#stmPat"><span class="hs-identifier hs-var hs-var">stmPat</span></a></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684366377"><span class="hs-identifier hs-var">stm</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684366373"><span class="hs-identifier hs-var">tbranch</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684366372"><span class="hs-identifier hs-var">fbranch</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-213"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BodyT rep -&gt; Names
forall rep. Body rep -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#boundInBody"><span class="hs-identifier hs-var">boundInBody</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684366373"><span class="hs-identifier hs-var">tbranch</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#namesIntersect"><span class="hs-operator hs-var">`namesIntersect`</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Names
forall a. FreeIn a =&gt; a -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#freeIn"><span class="hs-identifier hs-var">freeIn</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366370"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-214"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BodyT rep -&gt; Names
forall rep. Body rep -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#boundInBody"><span class="hs-identifier hs-var">boundInBody</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684366372"><span class="hs-identifier hs-var">fbranch</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#namesIntersect"><span class="hs-operator hs-var">`namesIntersect`</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Names
forall a. FreeIn a =&gt; a -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#freeIn"><span class="hs-identifier hs-var">freeIn</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366369"><span class="hs-identifier hs-var">z</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleM rep () -&gt; Maybe (RuleM rep ())
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; Maybe (RuleM rep ()))
-&gt; RuleM rep () -&gt; Maybe (RuleM rep ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-215"></span><span>        </span><span id="local-6989586621684366363"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366363"><span class="hs-identifier hs-var">eq_x_y</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-216"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;eq_x_y&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep SubExp)
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CmpOp -&gt; SubExp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#CmpOp"><span class="hs-identifier hs-var">CmpOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimType -&gt; CmpOp
</span><a href="Futhark.IR.Primitive.html#CmpEq"><span class="hs-identifier hs-var">CmpEq</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684366385"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366378"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366370"><span class="hs-identifier hs-var">y</span></a></span><span>
</span><span id="line-217"></span><span>        </span><span id="local-6989586621684366362"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366362"><span class="hs-identifier hs-var">eq_x_z</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-218"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;eq_x_z&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep SubExp)
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CmpOp -&gt; SubExp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#CmpOp"><span class="hs-identifier hs-var">CmpOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimType -&gt; CmpOp
</span><a href="Futhark.IR.Primitive.html#CmpEq"><span class="hs-identifier hs-var">CmpEq</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684366385"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366378"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366369"><span class="hs-identifier hs-var">z</span></a></span><span>
</span><span id="line-219"></span><span>        </span><span id="local-6989586621684366361"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366361"><span class="hs-identifier hs-var">p_and_eq_x_y</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-220"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;p_and_eq_x_y&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep SubExp)
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BinOp -&gt; SubExp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#BinOp"><span class="hs-identifier hs-var">BinOp</span></a></span><span> </span><span class="annot"><span class="annottext">BinOp
</span><a href="Futhark.IR.Primitive.html#LogAnd"><span class="hs-identifier hs-var">LogAnd</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366374"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366363"><span class="hs-identifier hs-var">eq_x_y</span></a></span><span>
</span><span id="line-221"></span><span>        </span><span id="local-6989586621684366358"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366358"><span class="hs-identifier hs-var">not_p</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-222"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;not_p&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep SubExp)
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">UnOp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#UnOp"><span class="hs-identifier hs-var">UnOp</span></a></span><span> </span><span class="annot"><span class="annottext">UnOp
</span><a href="Futhark.IR.Primitive.html#Not"><span class="hs-identifier hs-var">Not</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366374"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-223"></span><span>        </span><span id="local-6989586621684366355"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366355"><span class="hs-identifier hs-var">not_p_and_eq_x_z</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-224"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;p_and_eq_x_y&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep SubExp)
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BinOp -&gt; SubExp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#BinOp"><span class="hs-identifier hs-var">BinOp</span></a></span><span> </span><span class="annot"><span class="annottext">BinOp
</span><a href="Futhark.IR.Primitive.html#LogAnd"><span class="hs-identifier hs-var">LogAnd</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366358"><span class="hs-identifier hs-var">not_p</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366362"><span class="hs-identifier hs-var">eq_x_z</span></a></span><span>
</span><span id="line-225"></span><span>        </span><span class="annot"><span class="annottext">Pat (Rep (RuleM rep)) -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
Pat (Rep (RuleM rep))
</span><a href="#local-6989586621684366388"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep ())
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-226"></span><span>          </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BinOp -&gt; SubExp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#BinOp"><span class="hs-identifier hs-var">BinOp</span></a></span><span> </span><span class="annot"><span class="annottext">BinOp
</span><a href="Futhark.IR.Primitive.html#LogOr"><span class="hs-identifier hs-var">LogOr</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366361"><span class="hs-identifier hs-var">p_and_eq_x_y</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366355"><span class="hs-identifier hs-var">not_p_and_eq_x_z</span></a></span><span>
</span><span id="line-227"></span><span>    </span><span class="annot"><a href="#local-6989586621684366381"><span class="hs-identifier hs-var">simplifyWith</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-228"></span><span>      </span><span class="annot"><span class="annottext">Maybe (RuleM rep ())
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-229"></span><span>
</span><span id="line-230"></span><span>    </span><span id="local-6989586621684366368"><span class="annot"><span class="annottext">returns :: VName
-&gt; PatT dec -&gt; BodyT rep -&gt; BodyT rep -&gt; Maybe (SubExp, SubExp)
</span><a href="#local-6989586621684366368"><span class="hs-identifier hs-var hs-var">returns</span></a></span></span><span> </span><span id="local-6989586621684366350"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366350"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621684366349"><span class="annot"><span class="annottext">PatT dec
</span><a href="#local-6989586621684366349"><span class="hs-identifier hs-var">ifpat</span></a></span></span><span> </span><span id="local-6989586621684366348"><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684366348"><span class="hs-identifier hs-var">tbranch</span></a></span></span><span> </span><span id="local-6989586621684366347"><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684366347"><span class="hs-identifier hs-var">fbranch</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-231"></span><span>      </span><span class="annot"><span class="annottext">((PatElemT dec, (SubExp, SubExp)) -&gt; (SubExp, SubExp))
-&gt; Maybe (PatElemT dec, (SubExp, SubExp)) -&gt; Maybe (SubExp, SubExp)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">(PatElemT dec, (SubExp, SubExp)) -&gt; (SubExp, SubExp)
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (PatElemT dec, (SubExp, SubExp)) -&gt; Maybe (SubExp, SubExp))
-&gt; ([(PatElemT dec, (SubExp, SubExp))]
    -&gt; Maybe (PatElemT dec, (SubExp, SubExp)))
-&gt; [(PatElemT dec, (SubExp, SubExp))]
-&gt; Maybe (SubExp, SubExp)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">((PatElemT dec, (SubExp, SubExp)) -&gt; Bool)
-&gt; [(PatElemT dec, (SubExp, SubExp))]
-&gt; Maybe (PatElemT dec, (SubExp, SubExp))
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Maybe a
</span><span class="hs-identifier hs-var">find</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; VName -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366350"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Bool)
-&gt; ((PatElemT dec, (SubExp, SubExp)) -&gt; VName)
-&gt; (PatElemT dec, (SubExp, SubExp))
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PatElemT dec -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">(PatElemT dec -&gt; VName)
-&gt; ((PatElemT dec, (SubExp, SubExp)) -&gt; PatElemT dec)
-&gt; (PatElemT dec, (SubExp, SubExp))
-&gt; VName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(PatElemT dec, (SubExp, SubExp)) -&gt; PatElemT dec
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(PatElemT dec, (SubExp, SubExp))] -&gt; Maybe (SubExp, SubExp))
-&gt; [(PatElemT dec, (SubExp, SubExp))] -&gt; Maybe (SubExp, SubExp)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-232"></span><span>        </span><span class="annot"><span class="annottext">[PatElemT dec]
-&gt; [(SubExp, SubExp)] -&gt; [(PatElemT dec, (SubExp, SubExp))]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatT dec -&gt; [PatElemT dec]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span> </span><span class="annot"><span class="annottext">PatT dec
</span><a href="#local-6989586621684366349"><span class="hs-identifier hs-var">ifpat</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(SubExp, SubExp)] -&gt; [(PatElemT dec, (SubExp, SubExp))])
-&gt; [(SubExp, SubExp)] -&gt; [(PatElemT dec, (SubExp, SubExp))]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-233"></span><span>          </span><span class="annot"><span class="annottext">[SubExp] -&gt; [SubExp] -&gt; [(SubExp, SubExp)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SubExpRes -&gt; SubExp) -&gt; [SubExpRes] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExpRes -&gt; SubExp
</span><a href="Futhark.IR.Syntax.html#resSubExp"><span class="hs-identifier hs-var hs-var">resSubExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BodyT rep -&gt; [SubExpRes]
forall rep. BodyT rep -&gt; [SubExpRes]
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var hs-var">bodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684366348"><span class="hs-identifier hs-var">tbranch</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SubExpRes -&gt; SubExp) -&gt; [SubExpRes] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExpRes -&gt; SubExp
</span><a href="Futhark.IR.Syntax.html#resSubExp"><span class="hs-identifier hs-var hs-var">resSubExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BodyT rep -&gt; [SubExpRes]
forall rep. BodyT rep -&gt; [SubExpRes]
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var hs-var">bodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684366347"><span class="hs-identifier hs-var">fbranch</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-234"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ruleBasicOp"><span class="hs-identifier hs-var">ruleBasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684366342"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684366342"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Replicate"><span class="hs-identifier hs-type">Replicate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-type">Shape</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span id="local-6989586621684366340"><span class="annot"><span class="annottext">se :: SubExp
</span><a href="#local-6989586621684366340"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-235"></span><span>  </span><span class="annot"><span class="annottext">RuleM rep () -&gt; Rule rep
forall rep. RuleM rep () -&gt; Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Simplify"><span class="hs-identifier hs-var">Simplify</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; Rule rep) -&gt; RuleM rep () -&gt; Rule rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat (Rep (RuleM rep)) -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
Pat (Rep (RuleM rep))
</span><a href="#local-6989586621684366342"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep ())
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#SubExp"><span class="hs-identifier hs-var">SubExp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366340"><span class="hs-identifier hs-var">se</span></a></span><span>
</span><span id="line-236"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ruleBasicOp"><span class="hs-identifier hs-var">ruleBasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684366339"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684366339"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Replicate"><span class="hs-identifier hs-type">Replicate</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684366338"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366338"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-237"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Acc"><span class="hs-identifier hs-type">Acc</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Pat rep -&gt; [Type]
forall dec. Typed dec =&gt; PatT dec -&gt; [Type]
</span><a href="Futhark.IR.Prop.Patterns.html#patTypes"><span class="hs-identifier hs-var">patTypes</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684366339"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-238"></span><span>    </span><span class="annot"><span class="annottext">RuleM rep () -&gt; Rule rep
forall rep. RuleM rep () -&gt; Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Simplify"><span class="hs-identifier hs-var">Simplify</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; Rule rep) -&gt; RuleM rep () -&gt; Rule rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat (Rep (RuleM rep)) -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
Pat (Rep (RuleM rep))
</span><a href="#local-6989586621684366339"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep ())
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#SubExp"><span class="hs-identifier hs-var">SubExp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366338"><span class="hs-identifier hs-var">se</span></a></span><span>
</span><span id="line-239"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ruleBasicOp"><span class="hs-identifier hs-var">ruleBasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684366335"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684366335"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Replicate"><span class="hs-identifier hs-type">Replicate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-type">Shape</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684366334"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366334"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleM rep () -&gt; Rule rep
forall rep. RuleM rep () -&gt; Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Simplify"><span class="hs-identifier hs-var">Simplify</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; Rule rep) -&gt; RuleM rep () -&gt; Rule rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-240"></span><span>  </span><span id="local-6989586621684366333"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684366333"><span class="hs-identifier hs-var">v_t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; RuleM rep Type
forall rep (m :: * -&gt; *). HasScope rep m =&gt; VName -&gt; m Type
</span><a href="Futhark.IR.Prop.Scope.html#lookupType"><span class="hs-identifier hs-var">lookupType</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366334"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-241"></span><span>  </span><span class="annot"><span class="annottext">Pat (Rep (RuleM rep)) -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
Pat (Rep (RuleM rep))
</span><a href="#local-6989586621684366335"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep ())
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-242"></span><span>    </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-243"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Bool
forall shape u. TypeBase shape u -&gt; Bool
</span><a href="Futhark.IR.Prop.Types.html#primType"><span class="hs-identifier hs-var">primType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684366333"><span class="hs-identifier hs-var">v_t</span></a></span><span>
</span><span id="line-244"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#SubExp"><span class="hs-identifier hs-var">SubExp</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; BasicOp) -&gt; SubExp -&gt; BasicOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366334"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-245"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">VName -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Copy"><span class="hs-identifier hs-var">Copy</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366334"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-246"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ruleBasicOp"><span class="hs-identifier hs-var">ruleBasicOp</span></a></span><span> </span><span id="local-6989586621684366331"><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684366331"><span class="hs-identifier hs-var">vtable</span></a></span></span><span> </span><span id="local-6989586621684366330"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684366330"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Replicate"><span class="hs-identifier hs-type">Replicate</span></a></span><span> </span><span id="local-6989586621684366329"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684366329"><span class="hs-identifier hs-var">shape</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684366328"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366328"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-247"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Replicate"><span class="hs-identifier hs-type">Replicate</span></a></span><span> </span><span id="local-6989586621684366327"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684366327"><span class="hs-identifier hs-var">shape2</span></a></span></span><span> </span><span id="local-6989586621684366326"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366326"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621684366325"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366325"><span class="hs-identifier hs-var">cs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; TopDown rep -&gt; Maybe (ExpT rep, Certs)
forall rep. VName -&gt; SymbolTable rep -&gt; Maybe (Exp rep, Certs)
</span><a href="Futhark.Analysis.SymbolTable.html#lookupExp"><span class="hs-identifier hs-var">ST.lookupExp</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366328"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684366331"><span class="hs-identifier hs-var">vtable</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-248"></span><span>    </span><span class="annot"><span class="annottext">RuleM rep () -&gt; Rule rep
forall rep. RuleM rep () -&gt; Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Simplify"><span class="hs-identifier hs-var">Simplify</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; Rule rep) -&gt; RuleM rep () -&gt; Rule rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Certs -&gt; RuleM rep () -&gt; RuleM rep ()
forall (m :: * -&gt; *) a. MonadBuilder m =&gt; Certs -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#certifying"><span class="hs-identifier hs-var">certifying</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366325"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; RuleM rep ()) -&gt; RuleM rep () -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat (Rep (RuleM rep)) -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
Pat (Rep (RuleM rep))
</span><a href="#local-6989586621684366330"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep ())
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Shape -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Replicate"><span class="hs-identifier hs-var">Replicate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684366329"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">Shape -&gt; Shape -&gt; Shape
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684366327"><span class="hs-identifier hs-var">shape2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366326"><span class="hs-identifier hs-var">se</span></a></span><span>
</span><span id="line-249"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ruleBasicOp"><span class="hs-identifier hs-var">ruleBasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684366324"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684366324"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#ArrayLit"><span class="hs-identifier hs-type">ArrayLit</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684366323"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366323"><span class="hs-identifier hs-var">se</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684366322"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684366322"><span class="hs-identifier hs-var">ses</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-250"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; Bool) -&gt; [SubExp] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp -&gt; SubExp -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366323"><span class="hs-identifier hs-var">se</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684366322"><span class="hs-identifier hs-var">ses</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-251"></span><span>    </span><span class="annot"><span class="annottext">RuleM rep () -&gt; Rule rep
forall rep. RuleM rep () -&gt; Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Simplify"><span class="hs-identifier hs-var">Simplify</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; Rule rep) -&gt; RuleM rep () -&gt; Rule rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-252"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684366320"><span class="annot"><span class="annottext">n :: SubExp
</span><a href="#local-6989586621684366320"><span class="hs-identifier hs-var hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int64 -&gt; SubExp
forall v. IsValue v =&gt; v -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#constant"><span class="hs-identifier hs-var">constant</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684366322"><span class="hs-identifier hs-var">ses</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int64 -&gt; Int64 -&gt; Int64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int64
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">)</span><span>
</span><span id="line-253"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Pat (Rep (RuleM rep)) -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
Pat (Rep (RuleM rep))
</span><a href="#local-6989586621684366324"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep ())
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Shape -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Replicate"><span class="hs-identifier hs-var">Replicate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Shape
forall d. [d] -&gt; ShapeBase d
</span><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-var">Shape</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366320"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366323"><span class="hs-identifier hs-var">se</span></a></span><span>
</span><span id="line-254"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ruleBasicOp"><span class="hs-identifier hs-var">ruleBasicOp</span></a></span><span> </span><span id="local-6989586621684366318"><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684366318"><span class="hs-identifier hs-var">vtable</span></a></span></span><span> </span><span id="local-6989586621684366317"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684366317"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684366316"><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><a href="#local-6989586621684366316"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Index"><span class="hs-identifier hs-type">Index</span></a></span><span> </span><span id="local-6989586621684366315"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366315"><span class="hs-identifier hs-var">idd</span></a></span></span><span> </span><span id="local-6989586621684366314"><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684366314"><span class="hs-identifier hs-var">slice</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-255"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684366313"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684366313"><span class="hs-identifier hs-var">inds</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Slice SubExp -&gt; Maybe [SubExp]
forall d. Slice d -&gt; Maybe [d]
</span><a href="Futhark.IR.Syntax.Core.html#sliceIndices"><span class="hs-identifier hs-var">sliceIndices</span></a></span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684366314"><span class="hs-identifier hs-var">slice</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-256"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Reshape"><span class="hs-identifier hs-type">Reshape</span></a></span><span> </span><span id="local-6989586621684366311"><span class="annot"><span class="annottext">ShapeChange SubExp
</span><a href="#local-6989586621684366311"><span class="hs-identifier hs-var">newshape</span></a></span></span><span> </span><span id="local-6989586621684366310"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366310"><span class="hs-identifier hs-var">idd2</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621684366309"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366309"><span class="hs-identifier hs-var">idd_cs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; TopDown rep -&gt; Maybe (ExpT rep, Certs)
forall rep. VName -&gt; SymbolTable rep -&gt; Maybe (Exp rep, Certs)
</span><a href="Futhark.Analysis.SymbolTable.html#lookupExp"><span class="hs-identifier hs-var">ST.lookupExp</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366315"><span class="hs-identifier hs-var">idd</span></a></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684366318"><span class="hs-identifier hs-var">vtable</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-257"></span><span>    </span><span class="annot"><span class="annottext">ShapeChange SubExp -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">ShapeChange SubExp
</span><a href="#local-6989586621684366311"><span class="hs-identifier hs-var">newshape</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684366313"><span class="hs-identifier hs-var">inds</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-258"></span><span>    </span><span class="annot"><span class="annottext">RuleM rep () -&gt; Rule rep
forall rep. RuleM rep () -&gt; Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Simplify"><span class="hs-identifier hs-var">Simplify</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; Rule rep) -&gt; RuleM rep () -&gt; Rule rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-259"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ShapeChange SubExp -&gt; Maybe [SubExp]
forall d. ShapeChange d -&gt; Maybe [d]
</span><a href="Futhark.IR.Prop.Reshape.html#shapeCoercion"><span class="hs-identifier hs-var">shapeCoercion</span></a></span><span> </span><span class="annot"><span class="annottext">ShapeChange SubExp
</span><a href="#local-6989586621684366311"><span class="hs-identifier hs-var">newshape</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-260"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-261"></span><span>          </span><span class="annot"><span class="annottext">Certs -&gt; RuleM rep () -&gt; RuleM rep ()
forall (m :: * -&gt; *) a. MonadBuilder m =&gt; Certs -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#certifying"><span class="hs-identifier hs-var">certifying</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366309"><span class="hs-identifier hs-var">idd_cs</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; RuleM rep ()) -&gt; RuleM rep () -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-262"></span><span>            </span><span class="annot"><span class="annottext">StmAux (ExpDec rep) -&gt; RuleM rep () -&gt; RuleM rep ()
forall (m :: * -&gt; *) anyrep a.
MonadBuilder m =&gt;
StmAux anyrep -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#auxing"><span class="hs-identifier hs-var">auxing</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><a href="#local-6989586621684366316"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; RuleM rep ()) -&gt; RuleM rep () -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-263"></span><span>              </span><span class="annot"><span class="annottext">Pat (Rep (RuleM rep)) -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
Pat (Rep (RuleM rep))
</span><a href="#local-6989586621684366317"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep ())
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Slice SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Index"><span class="hs-identifier hs-var">Index</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366310"><span class="hs-identifier hs-var">idd2</span></a></span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684366314"><span class="hs-identifier hs-var">slice</span></a></span><span>
</span><span id="line-264"></span><span>        </span><span class="annot"><span class="annottext">Maybe [SubExp]
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-265"></span><span>          </span><span class="hs-comment">-- Linearise indices and map to old index space.</span><span>
</span><span id="line-266"></span><span>          </span><span id="local-6989586621684366307"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684366307"><span class="hs-identifier hs-var">oldshape</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; [SubExp]
forall u. TypeBase Shape u -&gt; [SubExp]
</span><a href="Futhark.IR.Prop.Types.html#arrayDims"><span class="hs-identifier hs-var">arrayDims</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; [SubExp]) -&gt; RuleM rep Type -&gt; RuleM rep [SubExp]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; RuleM rep Type
forall rep (m :: * -&gt; *). HasScope rep m =&gt; VName -&gt; m Type
</span><a href="Futhark.IR.Prop.Scope.html#lookupType"><span class="hs-identifier hs-var">lookupType</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366310"><span class="hs-identifier hs-var">idd2</span></a></span><span>
</span><span id="line-267"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684366306"><span class="annot"><span class="annottext">new_inds :: [TPrimExp Int64 VName]
</span><a href="#local-6989586621684366306"><span class="hs-identifier hs-var hs-var">new_inds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-268"></span><span>                </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
-&gt; [TPrimExp Int64 VName]
-&gt; [TPrimExp Int64 VName]
-&gt; [TPrimExp Int64 VName]
forall num. IntegralExp num =&gt; [num] -&gt; [num] -&gt; [num] -&gt; [num]
</span><a href="Futhark.IR.Prop.Reshape.html#reshapeIndex"><span class="hs-identifier hs-var">reshapeIndex</span></a></span><span>
</span><span id="line-269"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SubExp -&gt; TPrimExp Int64 VName)
-&gt; [SubExp] -&gt; [TPrimExp Int64 VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TPrimExp Int64 VName
</span><a href="Futhark.Analysis.PrimExp.Convert.html#pe64"><span class="hs-identifier hs-var">pe64</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684366307"><span class="hs-identifier hs-var">oldshape</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-270"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SubExp -&gt; TPrimExp Int64 VName)
-&gt; [SubExp] -&gt; [TPrimExp Int64 VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TPrimExp Int64 VName
</span><a href="Futhark.Analysis.PrimExp.Convert.html#pe64"><span class="hs-identifier hs-var">pe64</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [TPrimExp Int64 VName])
-&gt; [SubExp] -&gt; [TPrimExp Int64 VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ShapeChange SubExp -&gt; [SubExp]
forall d. ShapeChange d -&gt; [d]
</span><a href="Futhark.IR.Prop.Reshape.html#newDims"><span class="hs-identifier hs-var">newDims</span></a></span><span> </span><span class="annot"><span class="annottext">ShapeChange SubExp
</span><a href="#local-6989586621684366311"><span class="hs-identifier hs-var">newshape</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-271"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SubExp -&gt; TPrimExp Int64 VName)
-&gt; [SubExp] -&gt; [TPrimExp Int64 VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TPrimExp Int64 VName
</span><a href="Futhark.Analysis.PrimExp.Convert.html#pe64"><span class="hs-identifier hs-var">pe64</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684366313"><span class="hs-identifier hs-var">inds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-272"></span><span>          </span><span id="local-6989586621684366303"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684366303"><span class="hs-identifier hs-var">new_inds'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-273"></span><span>            </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName -&gt; RuleM rep SubExp)
-&gt; [TPrimExp Int64 VName] -&gt; RuleM rep [SubExp]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; TPrimExp Int64 VName -&gt; RuleM rep SubExp
forall (m :: * -&gt; *) a.
(MonadBuilder m, ToExp a) =&gt;
String -&gt; a -&gt; m SubExp
</span><a href="Futhark.Construct.html#toSubExp"><span class="hs-identifier hs-var">toSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;new_index&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684366306"><span class="hs-identifier hs-var">new_inds</span></a></span><span>
</span><span id="line-274"></span><span>          </span><span class="annot"><span class="annottext">Certs -&gt; RuleM rep () -&gt; RuleM rep ()
forall (m :: * -&gt; *) a. MonadBuilder m =&gt; Certs -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#certifying"><span class="hs-identifier hs-var">certifying</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366309"><span class="hs-identifier hs-var">idd_cs</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; RuleM rep ())
-&gt; (RuleM rep () -&gt; RuleM rep ()) -&gt; RuleM rep () -&gt; RuleM rep ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep) -&gt; RuleM rep () -&gt; RuleM rep ()
forall (m :: * -&gt; *) anyrep a.
MonadBuilder m =&gt;
StmAux anyrep -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#auxing"><span class="hs-identifier hs-var">auxing</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><a href="#local-6989586621684366316"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; RuleM rep ()) -&gt; RuleM rep () -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-275"></span><span>            </span><span class="annot"><span class="annottext">Pat (Rep (RuleM rep)) -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
Pat (Rep (RuleM rep))
</span><a href="#local-6989586621684366317"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep ())
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Slice SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Index"><span class="hs-identifier hs-var">Index</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366310"><span class="hs-identifier hs-var">idd2</span></a></span><span> </span><span class="annot"><span class="annottext">(Slice SubExp -&gt; BasicOp) -&gt; Slice SubExp -&gt; BasicOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[DimIndex SubExp] -&gt; Slice SubExp
forall d. [DimIndex d] -&gt; Slice d
</span><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-var">Slice</span></a></span><span> </span><span class="annot"><span class="annottext">([DimIndex SubExp] -&gt; Slice SubExp)
-&gt; [DimIndex SubExp] -&gt; Slice SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; DimIndex SubExp) -&gt; [SubExp] -&gt; [DimIndex SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; DimIndex SubExp
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684366303"><span class="hs-identifier hs-var">new_inds'</span></a></span><span>
</span><span id="line-276"></span><span>
</span><span id="line-277"></span><span class="hs-comment">-- Copying an iota is pointless; just make it an iota instead.</span><span>
</span><span id="line-278"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ruleBasicOp"><span class="hs-identifier hs-var">ruleBasicOp</span></a></span><span> </span><span id="local-6989586621684366302"><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684366302"><span class="hs-identifier hs-var">vtable</span></a></span></span><span> </span><span id="local-6989586621684366301"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684366301"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684366300"><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><a href="#local-6989586621684366300"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Copy"><span class="hs-identifier hs-type">Copy</span></a></span><span> </span><span id="local-6989586621684366299"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366299"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-279"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Iota"><span class="hs-identifier hs-type">Iota</span></a></span><span> </span><span id="local-6989586621684366297"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366297"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621684366296"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366296"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621684366295"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366295"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621684366294"><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684366294"><span class="hs-identifier hs-var">it</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684366293"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366293"><span class="hs-identifier hs-var">v_cs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; TopDown rep -&gt; Maybe (BasicOp, Certs)
forall rep. VName -&gt; SymbolTable rep -&gt; Maybe (BasicOp, Certs)
</span><a href="Futhark.Analysis.SymbolTable.html#lookupBasicOp"><span class="hs-identifier hs-var">ST.lookupBasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366299"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684366302"><span class="hs-identifier hs-var">vtable</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-280"></span><span>    </span><span class="annot"><span class="annottext">RuleM rep () -&gt; Rule rep
forall rep. RuleM rep () -&gt; Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Simplify"><span class="hs-identifier hs-var">Simplify</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; Rule rep)
-&gt; (RuleM rep () -&gt; RuleM rep ()) -&gt; RuleM rep () -&gt; Rule rep
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Certs -&gt; RuleM rep () -&gt; RuleM rep ()
forall (m :: * -&gt; *) a. MonadBuilder m =&gt; Certs -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#certifying"><span class="hs-identifier hs-var">certifying</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366293"><span class="hs-identifier hs-var">v_cs</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; RuleM rep ())
-&gt; (RuleM rep () -&gt; RuleM rep ()) -&gt; RuleM rep () -&gt; RuleM rep ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep) -&gt; RuleM rep () -&gt; RuleM rep ()
forall (m :: * -&gt; *) anyrep a.
MonadBuilder m =&gt;
StmAux anyrep -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#auxing"><span class="hs-identifier hs-var">auxing</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><a href="#local-6989586621684366300"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; Rule rep) -&gt; RuleM rep () -&gt; Rule rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-281"></span><span>      </span><span class="annot"><span class="annottext">Pat (Rep (RuleM rep)) -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
Pat (Rep (RuleM rep))
</span><a href="#local-6989586621684366301"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep ())
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; SubExp -&gt; SubExp -&gt; IntType -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Iota"><span class="hs-identifier hs-var">Iota</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366297"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366296"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366295"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684366294"><span class="hs-identifier hs-var">it</span></a></span><span>
</span><span id="line-282"></span><span class="hs-comment">-- Handle identity permutation.</span><span>
</span><span id="line-283"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ruleBasicOp"><span class="hs-identifier hs-var">ruleBasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684366292"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684366292"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Rearrange"><span class="hs-identifier hs-type">Rearrange</span></a></span><span> </span><span id="local-6989586621684366291"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684366291"><span class="hs-identifier hs-var">perm</span></a></span></span><span> </span><span id="local-6989586621684366290"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366290"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-284"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; [Int]
forall a. Ord a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">sort</span></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684366291"><span class="hs-identifier hs-var">perm</span></a></span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; [Int] -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684366291"><span class="hs-identifier hs-var">perm</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-285"></span><span>    </span><span class="annot"><span class="annottext">RuleM rep () -&gt; Rule rep
forall rep. RuleM rep () -&gt; Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Simplify"><span class="hs-identifier hs-var">Simplify</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; Rule rep) -&gt; RuleM rep () -&gt; Rule rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat (Rep (RuleM rep)) -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
Pat (Rep (RuleM rep))
</span><a href="#local-6989586621684366292"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep ())
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#SubExp"><span class="hs-identifier hs-var">SubExp</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; BasicOp) -&gt; SubExp -&gt; BasicOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366290"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-286"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ruleBasicOp"><span class="hs-identifier hs-var">ruleBasicOp</span></a></span><span> </span><span id="local-6989586621684366289"><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684366289"><span class="hs-identifier hs-var">vtable</span></a></span></span><span> </span><span id="local-6989586621684366288"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684366288"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684366287"><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><a href="#local-6989586621684366287"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Rearrange"><span class="hs-identifier hs-type">Rearrange</span></a></span><span> </span><span id="local-6989586621684366286"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684366286"><span class="hs-identifier hs-var">perm</span></a></span></span><span> </span><span id="local-6989586621684366285"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366285"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-287"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Rearrange"><span class="hs-identifier hs-type">Rearrange</span></a></span><span> </span><span id="local-6989586621684366284"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684366284"><span class="hs-identifier hs-var">perm2</span></a></span></span><span> </span><span id="local-6989586621684366283"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366283"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621684366282"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366282"><span class="hs-identifier hs-var">v_cs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; TopDown rep -&gt; Maybe (ExpT rep, Certs)
forall rep. VName -&gt; SymbolTable rep -&gt; Maybe (Exp rep, Certs)
</span><a href="Futhark.Analysis.SymbolTable.html#lookupExp"><span class="hs-identifier hs-var">ST.lookupExp</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366285"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684366289"><span class="hs-identifier hs-var">vtable</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-288"></span><span>    </span><span class="hs-comment">-- Rearranging a rearranging: compose the permutations.</span><span>
</span><span id="line-289"></span><span>    </span><span class="annot"><span class="annottext">RuleM rep () -&gt; Rule rep
forall rep. RuleM rep () -&gt; Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Simplify"><span class="hs-identifier hs-var">Simplify</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; Rule rep)
-&gt; (RuleM rep () -&gt; RuleM rep ()) -&gt; RuleM rep () -&gt; Rule rep
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Certs -&gt; RuleM rep () -&gt; RuleM rep ()
forall (m :: * -&gt; *) a. MonadBuilder m =&gt; Certs -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#certifying"><span class="hs-identifier hs-var">certifying</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366282"><span class="hs-identifier hs-var">v_cs</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; RuleM rep ())
-&gt; (RuleM rep () -&gt; RuleM rep ()) -&gt; RuleM rep () -&gt; RuleM rep ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep) -&gt; RuleM rep () -&gt; RuleM rep ()
forall (m :: * -&gt; *) anyrep a.
MonadBuilder m =&gt;
StmAux anyrep -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#auxing"><span class="hs-identifier hs-var">auxing</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><a href="#local-6989586621684366287"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; Rule rep) -&gt; RuleM rep () -&gt; Rule rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-290"></span><span>      </span><span class="annot"><span class="annottext">Pat (Rep (RuleM rep)) -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
Pat (Rep (RuleM rep))
</span><a href="#local-6989586621684366288"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep ())
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; VName -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Rearrange"><span class="hs-identifier hs-var">Rearrange</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684366286"><span class="hs-identifier hs-var">perm</span></a></span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; [Int] -&gt; [Int]
</span><a href="Futhark.IR.Prop.Rearrange.html#rearrangeCompose"><span class="hs-operator hs-var">`rearrangeCompose`</span></a></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684366284"><span class="hs-identifier hs-var">perm2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366283"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-291"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ruleBasicOp"><span class="hs-identifier hs-var">ruleBasicOp</span></a></span><span> </span><span id="local-6989586621684366280"><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684366280"><span class="hs-identifier hs-var">vtable</span></a></span></span><span> </span><span id="local-6989586621684366279"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684366279"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684366278"><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><a href="#local-6989586621684366278"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Rearrange"><span class="hs-identifier hs-type">Rearrange</span></a></span><span> </span><span id="local-6989586621684366277"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684366277"><span class="hs-identifier hs-var">perm</span></a></span></span><span> </span><span id="local-6989586621684366276"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366276"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-292"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Rotate"><span class="hs-identifier hs-type">Rotate</span></a></span><span> </span><span id="local-6989586621684366274"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684366274"><span class="hs-identifier hs-var">offsets</span></a></span></span><span> </span><span id="local-6989586621684366273"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366273"><span class="hs-identifier hs-var">v2</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621684366272"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366272"><span class="hs-identifier hs-var">v_cs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; TopDown rep -&gt; Maybe (ExpT rep, Certs)
forall rep. VName -&gt; SymbolTable rep -&gt; Maybe (Exp rep, Certs)
</span><a href="Futhark.Analysis.SymbolTable.html#lookupExp"><span class="hs-identifier hs-var">ST.lookupExp</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366276"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684366280"><span class="hs-identifier hs-var">vtable</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-293"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Rearrange"><span class="hs-identifier hs-type">Rearrange</span></a></span><span> </span><span id="local-6989586621684366271"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684366271"><span class="hs-identifier hs-var">perm3</span></a></span></span><span> </span><span id="local-6989586621684366270"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366270"><span class="hs-identifier hs-var">v3</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621684366269"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366269"><span class="hs-identifier hs-var">v2_cs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; TopDown rep -&gt; Maybe (ExpT rep, Certs)
forall rep. VName -&gt; SymbolTable rep -&gt; Maybe (Exp rep, Certs)
</span><a href="Futhark.Analysis.SymbolTable.html#lookupExp"><span class="hs-identifier hs-var">ST.lookupExp</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366273"><span class="hs-identifier hs-var">v2</span></a></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684366280"><span class="hs-identifier hs-var">vtable</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleM rep () -&gt; Rule rep
forall rep. RuleM rep () -&gt; Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Simplify"><span class="hs-identifier hs-var">Simplify</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; Rule rep) -&gt; RuleM rep () -&gt; Rule rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-294"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684366268"><span class="annot"><span class="annottext">offsets' :: [SubExp]
</span><a href="#local-6989586621684366268"><span class="hs-identifier hs-var hs-var">offsets'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; [SubExp] -&gt; [SubExp]
forall a. [Int] -&gt; [a] -&gt; [a]
</span><a href="Futhark.IR.Prop.Rearrange.html#rearrangeShape"><span class="hs-identifier hs-var">rearrangeShape</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Int] -&gt; [Int]
</span><a href="Futhark.IR.Prop.Rearrange.html#rearrangeInverse"><span class="hs-identifier hs-var">rearrangeInverse</span></a></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684366271"><span class="hs-identifier hs-var">perm3</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684366274"><span class="hs-identifier hs-var">offsets</span></a></span><span>
</span><span id="line-295"></span><span>    </span><span id="local-6989586621684366265"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366265"><span class="hs-identifier hs-var">rearrange_rotate</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m VName
</span><a href="Futhark.Construct.html#letExp"><span class="hs-identifier hs-var">letExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;rearrange_rotate&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep VName)
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; VName -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Rotate"><span class="hs-identifier hs-var">Rotate</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684366268"><span class="hs-identifier hs-var">offsets'</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366270"><span class="hs-identifier hs-var">v3</span></a></span><span>
</span><span id="line-296"></span><span>    </span><span class="annot"><span class="annottext">Certs -&gt; RuleM rep () -&gt; RuleM rep ()
forall (m :: * -&gt; *) a. MonadBuilder m =&gt; Certs -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#certifying"><span class="hs-identifier hs-var">certifying</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366272"><span class="hs-identifier hs-var">v_cs</span></a></span><span> </span><span class="annot"><span class="annottext">Certs -&gt; Certs -&gt; Certs
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366269"><span class="hs-identifier hs-var">v2_cs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; RuleM rep ()) -&gt; RuleM rep () -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-297"></span><span>      </span><span class="annot"><span class="annottext">StmAux (ExpDec rep) -&gt; RuleM rep () -&gt; RuleM rep ()
forall (m :: * -&gt; *) anyrep a.
MonadBuilder m =&gt;
StmAux anyrep -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#auxing"><span class="hs-identifier hs-var">auxing</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><a href="#local-6989586621684366278"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; RuleM rep ()) -&gt; RuleM rep () -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-298"></span><span>        </span><span class="annot"><span class="annottext">Pat (Rep (RuleM rep)) -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
Pat (Rep (RuleM rep))
</span><a href="#local-6989586621684366279"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep ())
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; VName -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Rearrange"><span class="hs-identifier hs-var">Rearrange</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684366277"><span class="hs-identifier hs-var">perm</span></a></span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; [Int] -&gt; [Int]
</span><a href="Futhark.IR.Prop.Rearrange.html#rearrangeCompose"><span class="hs-operator hs-var">`rearrangeCompose`</span></a></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684366271"><span class="hs-identifier hs-var">perm3</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366265"><span class="hs-identifier hs-var">rearrange_rotate</span></a></span><span>
</span><span id="line-299"></span><span>
</span><span id="line-300"></span><span class="hs-comment">-- Rearranging a replicate where the outer dimension is left untouched.</span><span>
</span><span id="line-301"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ruleBasicOp"><span class="hs-identifier hs-var">ruleBasicOp</span></a></span><span> </span><span id="local-6989586621684366264"><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684366264"><span class="hs-identifier hs-var">vtable</span></a></span></span><span> </span><span id="local-6989586621684366263"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684366263"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684366262"><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><a href="#local-6989586621684366262"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Rearrange"><span class="hs-identifier hs-type">Rearrange</span></a></span><span> </span><span id="local-6989586621684366261"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684366261"><span class="hs-identifier hs-var">perm</span></a></span></span><span> </span><span id="local-6989586621684366260"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366260"><span class="hs-identifier hs-var">v1</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-302"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Replicate"><span class="hs-identifier hs-type">Replicate</span></a></span><span> </span><span id="local-6989586621684366259"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684366259"><span class="hs-identifier hs-var">dims</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684366258"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366258"><span class="hs-identifier hs-var">v2</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621684366257"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366257"><span class="hs-identifier hs-var">v1_cs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; TopDown rep -&gt; Maybe (ExpT rep, Certs)
forall rep. VName -&gt; SymbolTable rep -&gt; Maybe (Exp rep, Certs)
</span><a href="Futhark.Analysis.SymbolTable.html#lookupExp"><span class="hs-identifier hs-var">ST.lookupExp</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366260"><span class="hs-identifier hs-var">v1</span></a></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684366264"><span class="hs-identifier hs-var">vtable</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-303"></span><span>    </span><span id="local-6989586621684366256"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684366256"><span class="hs-identifier hs-var">num_dims</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Shape -&gt; Int
forall a. ArrayShape a =&gt; a -&gt; Int
</span><a href="Futhark.IR.Syntax.Core.html#shapeRank"><span class="hs-identifier hs-var">shapeRank</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684366259"><span class="hs-identifier hs-var">dims</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-304"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684366254"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684366254"><span class="hs-identifier hs-var">rep_perm</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684366253"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684366253"><span class="hs-identifier hs-var">rest_perm</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Int] -&gt; ([Int], [Int])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684366256"><span class="hs-identifier hs-var">num_dims</span></a></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684366261"><span class="hs-identifier hs-var">perm</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-305"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684366253"><span class="hs-identifier hs-var">rest_perm</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-306"></span><span>    </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684366254"><span class="hs-identifier hs-var">rep_perm</span></a></span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; [Int] -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684366254"><span class="hs-identifier hs-var">rep_perm</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-307"></span><span>    </span><span class="annot"><span class="annottext">RuleM rep () -&gt; Rule rep
forall rep. RuleM rep () -&gt; Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Simplify"><span class="hs-identifier hs-var">Simplify</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; Rule rep) -&gt; RuleM rep () -&gt; Rule rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-308"></span><span>      </span><span class="annot"><span class="annottext">Certs -&gt; RuleM rep () -&gt; RuleM rep ()
forall (m :: * -&gt; *) a. MonadBuilder m =&gt; Certs -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#certifying"><span class="hs-identifier hs-var">certifying</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366257"><span class="hs-identifier hs-var">v1_cs</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; RuleM rep ()) -&gt; RuleM rep () -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-309"></span><span>        </span><span class="annot"><span class="annottext">StmAux (ExpDec rep) -&gt; RuleM rep () -&gt; RuleM rep ()
forall (m :: * -&gt; *) anyrep a.
MonadBuilder m =&gt;
StmAux anyrep -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#auxing"><span class="hs-identifier hs-var">auxing</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><a href="#local-6989586621684366262"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; RuleM rep ()) -&gt; RuleM rep () -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-310"></span><span>          </span><span id="local-6989586621684366251"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366251"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-311"></span><span>            </span><span class="annot"><span class="annottext">String -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;rearrange_replicate&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep SubExp)
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-312"></span><span>              </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; VName -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Rearrange"><span class="hs-identifier hs-var">Rearrange</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Int -&gt; Int) -&gt; [Int] -&gt; [Int]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">subtract</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684366256"><span class="hs-identifier hs-var">num_dims</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684366253"><span class="hs-identifier hs-var">rest_perm</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366258"><span class="hs-identifier hs-var">v2</span></a></span><span>
</span><span id="line-313"></span><span>          </span><span class="annot"><span class="annottext">Pat (Rep (RuleM rep)) -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
Pat (Rep (RuleM rep))
</span><a href="#local-6989586621684366263"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep ())
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Shape -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Replicate"><span class="hs-identifier hs-var">Replicate</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684366259"><span class="hs-identifier hs-var">dims</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366251"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-314"></span><span>
</span><span id="line-315"></span><span class="hs-comment">-- A zero-rotation is identity.</span><span>
</span><span id="line-316"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ruleBasicOp"><span class="hs-identifier hs-var">ruleBasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684366249"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684366249"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Rotate"><span class="hs-identifier hs-type">Rotate</span></a></span><span> </span><span id="local-6989586621684366248"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684366248"><span class="hs-identifier hs-var">offsets</span></a></span></span><span> </span><span id="local-6989586621684366247"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366247"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-317"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; Bool) -&gt; [SubExp] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Bool
</span><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#isCt0"><span class="hs-identifier hs-var">isCt0</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684366248"><span class="hs-identifier hs-var">offsets</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleM rep () -&gt; Rule rep
forall rep. RuleM rep () -&gt; Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Simplify"><span class="hs-identifier hs-var">Simplify</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; Rule rep) -&gt; RuleM rep () -&gt; Rule rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat (Rep (RuleM rep)) -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
Pat (Rep (RuleM rep))
</span><a href="#local-6989586621684366249"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep ())
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#SubExp"><span class="hs-identifier hs-var">SubExp</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; BasicOp) -&gt; SubExp -&gt; BasicOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366247"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-318"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ruleBasicOp"><span class="hs-identifier hs-var">ruleBasicOp</span></a></span><span> </span><span id="local-6989586621684366246"><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684366246"><span class="hs-identifier hs-var">vtable</span></a></span></span><span> </span><span id="local-6989586621684366245"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684366245"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684366244"><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><a href="#local-6989586621684366244"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Rotate"><span class="hs-identifier hs-type">Rotate</span></a></span><span> </span><span id="local-6989586621684366243"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684366243"><span class="hs-identifier hs-var">offsets</span></a></span></span><span> </span><span id="local-6989586621684366242"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366242"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-319"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Rearrange"><span class="hs-identifier hs-type">Rearrange</span></a></span><span> </span><span id="local-6989586621684366241"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684366241"><span class="hs-identifier hs-var">perm</span></a></span></span><span> </span><span id="local-6989586621684366240"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366240"><span class="hs-identifier hs-var">v2</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621684366239"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366239"><span class="hs-identifier hs-var">v_cs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; TopDown rep -&gt; Maybe (ExpT rep, Certs)
forall rep. VName -&gt; SymbolTable rep -&gt; Maybe (Exp rep, Certs)
</span><a href="Futhark.Analysis.SymbolTable.html#lookupExp"><span class="hs-identifier hs-var">ST.lookupExp</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366242"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684366246"><span class="hs-identifier hs-var">vtable</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-320"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Rotate"><span class="hs-identifier hs-type">Rotate</span></a></span><span> </span><span id="local-6989586621684366238"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684366238"><span class="hs-identifier hs-var">offsets2</span></a></span></span><span> </span><span id="local-6989586621684366237"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366237"><span class="hs-identifier hs-var">v3</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621684366236"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366236"><span class="hs-identifier hs-var">v2_cs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; TopDown rep -&gt; Maybe (ExpT rep, Certs)
forall rep. VName -&gt; SymbolTable rep -&gt; Maybe (Exp rep, Certs)
</span><a href="Futhark.Analysis.SymbolTable.html#lookupExp"><span class="hs-identifier hs-var">ST.lookupExp</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366240"><span class="hs-identifier hs-var">v2</span></a></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684366246"><span class="hs-identifier hs-var">vtable</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleM rep () -&gt; Rule rep
forall rep. RuleM rep () -&gt; Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Simplify"><span class="hs-identifier hs-var">Simplify</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; Rule rep) -&gt; RuleM rep () -&gt; Rule rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-321"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684366235"><span class="annot"><span class="annottext">offsets2' :: [SubExp]
</span><a href="#local-6989586621684366235"><span class="hs-identifier hs-var hs-var">offsets2'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; [SubExp] -&gt; [SubExp]
forall a. [Int] -&gt; [a] -&gt; [a]
</span><a href="Futhark.IR.Prop.Rearrange.html#rearrangeShape"><span class="hs-identifier hs-var">rearrangeShape</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Int] -&gt; [Int]
</span><a href="Futhark.IR.Prop.Rearrange.html#rearrangeInverse"><span class="hs-identifier hs-var">rearrangeInverse</span></a></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684366241"><span class="hs-identifier hs-var">perm</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684366238"><span class="hs-identifier hs-var">offsets2</span></a></span><span>
</span><span id="line-322"></span><span>        </span><span id="local-6989586621684366232"><span class="annot"><span class="annottext">addOffsets :: SubExp -&gt; SubExp -&gt; m SubExp
</span><a href="#local-6989586621684366232"><span class="hs-identifier hs-var hs-var">addOffsets</span></a></span></span><span> </span><span id="local-6989586621684366231"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366231"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621684366230"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366230"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Exp (Rep m) -&gt; m SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;summed_offset&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep m) -&gt; m SubExp) -&gt; Exp (Rep m) -&gt; m SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; Exp (Rep m)
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; Exp (Rep m)) -&gt; BasicOp -&gt; Exp (Rep m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BinOp -&gt; SubExp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#BinOp"><span class="hs-identifier hs-var">BinOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Overflow -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#Add"><span class="hs-identifier hs-var">Add</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Overflow
</span><a href="Futhark.IR.Primitive.html#OverflowWrap"><span class="hs-identifier hs-var">OverflowWrap</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366231"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366230"><span class="hs-identifier hs-var">y</span></a></span><span>
</span><span id="line-323"></span><span>    </span><span id="local-6989586621684366227"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684366227"><span class="hs-identifier hs-var">offsets'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; SubExp -&gt; RuleM rep SubExp)
-&gt; [SubExp] -&gt; [SubExp] -&gt; RuleM rep [SubExp]
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m [c]
</span><span class="hs-identifier hs-var">zipWithM</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; SubExp -&gt; RuleM rep SubExp
forall {m :: * -&gt; *}.
MonadBuilder m =&gt;
SubExp -&gt; SubExp -&gt; m SubExp
</span><a href="#local-6989586621684366232"><span class="hs-identifier hs-var">addOffsets</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684366243"><span class="hs-identifier hs-var">offsets</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684366235"><span class="hs-identifier hs-var">offsets2'</span></a></span><span>
</span><span id="line-324"></span><span>    </span><span id="local-6989586621684366225"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366225"><span class="hs-identifier hs-var">rotate_rearrange</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-325"></span><span>      </span><span class="annot"><span class="annottext">StmAux (ExpDec rep) -&gt; RuleM rep VName -&gt; RuleM rep VName
forall (m :: * -&gt; *) anyrep a.
MonadBuilder m =&gt;
StmAux anyrep -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#auxing"><span class="hs-identifier hs-var">auxing</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><a href="#local-6989586621684366244"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep VName -&gt; RuleM rep VName)
-&gt; RuleM rep VName -&gt; RuleM rep VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m VName
</span><a href="Futhark.Construct.html#letExp"><span class="hs-identifier hs-var">letExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;rotate_rearrange&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep VName)
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; VName -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Rearrange"><span class="hs-identifier hs-var">Rearrange</span></a></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684366241"><span class="hs-identifier hs-var">perm</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366237"><span class="hs-identifier hs-var">v3</span></a></span><span>
</span><span id="line-326"></span><span>    </span><span class="annot"><span class="annottext">Certs -&gt; RuleM rep () -&gt; RuleM rep ()
forall (m :: * -&gt; *) a. MonadBuilder m =&gt; Certs -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#certifying"><span class="hs-identifier hs-var">certifying</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366239"><span class="hs-identifier hs-var">v_cs</span></a></span><span> </span><span class="annot"><span class="annottext">Certs -&gt; Certs -&gt; Certs
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366236"><span class="hs-identifier hs-var">v2_cs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; RuleM rep ()) -&gt; RuleM rep () -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-327"></span><span>      </span><span class="annot"><span class="annottext">Pat (Rep (RuleM rep)) -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
Pat (Rep (RuleM rep))
</span><a href="#local-6989586621684366245"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep ())
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; VName -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Rotate"><span class="hs-identifier hs-var">Rotate</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684366227"><span class="hs-identifier hs-var">offsets'</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366225"><span class="hs-identifier hs-var">rotate_rearrange</span></a></span><span>
</span><span id="line-328"></span><span>
</span><span id="line-329"></span><span class="hs-comment">-- Combining Rotates.</span><span>
</span><span id="line-330"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ruleBasicOp"><span class="hs-identifier hs-var">ruleBasicOp</span></a></span><span> </span><span id="local-6989586621684366224"><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684366224"><span class="hs-identifier hs-var">vtable</span></a></span></span><span> </span><span id="local-6989586621684366223"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684366223"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684366222"><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><a href="#local-6989586621684366222"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Rotate"><span class="hs-identifier hs-type">Rotate</span></a></span><span> </span><span id="local-6989586621684366221"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684366221"><span class="hs-identifier hs-var">offsets1</span></a></span></span><span> </span><span id="local-6989586621684366220"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366220"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-331"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Rotate"><span class="hs-identifier hs-type">Rotate</span></a></span><span> </span><span id="local-6989586621684366219"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684366219"><span class="hs-identifier hs-var">offsets2</span></a></span></span><span> </span><span id="local-6989586621684366218"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366218"><span class="hs-identifier hs-var">v2</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621684366217"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366217"><span class="hs-identifier hs-var">v_cs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; TopDown rep -&gt; Maybe (ExpT rep, Certs)
forall rep. VName -&gt; SymbolTable rep -&gt; Maybe (Exp rep, Certs)
</span><a href="Futhark.Analysis.SymbolTable.html#lookupExp"><span class="hs-identifier hs-var">ST.lookupExp</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366220"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684366224"><span class="hs-identifier hs-var">vtable</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleM rep () -&gt; Rule rep
forall rep. RuleM rep () -&gt; Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Simplify"><span class="hs-identifier hs-var">Simplify</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; Rule rep) -&gt; RuleM rep () -&gt; Rule rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-332"></span><span>    </span><span id="local-6989586621684366216"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684366216"><span class="hs-identifier hs-var">offsets</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; SubExp -&gt; RuleM rep SubExp)
-&gt; [SubExp] -&gt; [SubExp] -&gt; RuleM rep [SubExp]
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m [c]
</span><span class="hs-identifier hs-var">zipWithM</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; SubExp -&gt; RuleM rep SubExp
forall {m :: * -&gt; *}.
MonadBuilder m =&gt;
SubExp -&gt; SubExp -&gt; m SubExp
</span><a href="#local-6989586621684366215"><span class="hs-identifier hs-var">add</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684366221"><span class="hs-identifier hs-var">offsets1</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684366219"><span class="hs-identifier hs-var">offsets2</span></a></span><span>
</span><span id="line-333"></span><span>    </span><span class="annot"><span class="annottext">Certs -&gt; RuleM rep () -&gt; RuleM rep ()
forall (m :: * -&gt; *) a. MonadBuilder m =&gt; Certs -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#certifying"><span class="hs-identifier hs-var">certifying</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366217"><span class="hs-identifier hs-var">v_cs</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; RuleM rep ()) -&gt; RuleM rep () -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-334"></span><span>      </span><span class="annot"><span class="annottext">StmAux (ExpDec rep) -&gt; RuleM rep () -&gt; RuleM rep ()
forall (m :: * -&gt; *) anyrep a.
MonadBuilder m =&gt;
StmAux anyrep -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#auxing"><span class="hs-identifier hs-var">auxing</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><a href="#local-6989586621684366222"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; RuleM rep ()) -&gt; RuleM rep () -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-335"></span><span>        </span><span class="annot"><span class="annottext">Pat (Rep (RuleM rep)) -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
Pat (Rep (RuleM rep))
</span><a href="#local-6989586621684366223"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep ())
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; VName -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Rotate"><span class="hs-identifier hs-var">Rotate</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684366216"><span class="hs-identifier hs-var">offsets</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366218"><span class="hs-identifier hs-var">v2</span></a></span><span>
</span><span id="line-336"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-337"></span><span>    </span><span id="local-6989586621684366215"><span class="annot"><span class="annottext">add :: SubExp -&gt; SubExp -&gt; m SubExp
</span><a href="#local-6989586621684366215"><span class="hs-identifier hs-var hs-var">add</span></a></span></span><span> </span><span id="local-6989586621684366212"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366212"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621684366211"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366211"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Exp (Rep m) -&gt; m SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;offset&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep m) -&gt; m SubExp) -&gt; Exp (Rep m) -&gt; m SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; Exp (Rep m)
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; Exp (Rep m)) -&gt; BasicOp -&gt; Exp (Rep m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BinOp -&gt; SubExp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#BinOp"><span class="hs-identifier hs-var">BinOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Overflow -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#Add"><span class="hs-identifier hs-var">Add</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Overflow
</span><a href="Futhark.IR.Primitive.html#OverflowWrap"><span class="hs-identifier hs-var">OverflowWrap</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366212"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366211"><span class="hs-identifier hs-var">y</span></a></span><span>
</span><span id="line-338"></span><span>
</span><span id="line-339"></span><span class="hs-comment">-- If we see an Update with a scalar where the value to be written is</span><span>
</span><span id="line-340"></span><span class="hs-comment">-- the result of indexing some other array, then we convert it into an</span><span>
</span><span id="line-341"></span><span class="hs-comment">-- Update with a slice of that array.  This matters when the arrays</span><span>
</span><span id="line-342"></span><span class="hs-comment">-- are far away (on the GPU, say), because it avoids a copy of the</span><span>
</span><span id="line-343"></span><span class="hs-comment">-- scalar to and from the host.</span><span>
</span><span id="line-344"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ruleBasicOp"><span class="hs-identifier hs-var">ruleBasicOp</span></a></span><span> </span><span id="local-6989586621684366210"><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684366210"><span class="hs-identifier hs-var">vtable</span></a></span></span><span> </span><span id="local-6989586621684366209"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684366209"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684366208"><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><a href="#local-6989586621684366208"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Update"><span class="hs-identifier hs-type">Update</span></a></span><span> </span><span id="local-6989586621684366207"><span class="annot"><span class="annottext">Safety
</span><a href="#local-6989586621684366207"><span class="hs-identifier hs-var">safety</span></a></span></span><span> </span><span id="local-6989586621684366206"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366206"><span class="hs-identifier hs-var">arr_x</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-type">Slice</span></a></span><span> </span><span id="local-6989586621684366205"><span class="annot"><span class="annottext">[DimIndex SubExp]
</span><a href="#local-6989586621684366205"><span class="hs-identifier hs-var">slice_x</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684366204"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366204"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-345"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Slice SubExp -&gt; Maybe [SubExp]
forall d. Slice d -&gt; Maybe [d]
</span><a href="Futhark.IR.Syntax.Core.html#sliceIndices"><span class="hs-identifier hs-var">sliceIndices</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DimIndex SubExp] -&gt; Slice SubExp
forall d. [DimIndex d] -&gt; Slice d
</span><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-var">Slice</span></a></span><span> </span><span class="annot"><span class="annottext">[DimIndex SubExp]
</span><a href="#local-6989586621684366205"><span class="hs-identifier hs-var">slice_x</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-346"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Index"><span class="hs-identifier hs-type">Index</span></a></span><span> </span><span id="local-6989586621684366203"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366203"><span class="hs-identifier hs-var">arr_y</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-type">Slice</span></a></span><span> </span><span id="local-6989586621684366202"><span class="annot"><span class="annottext">[DimIndex SubExp]
</span><a href="#local-6989586621684366202"><span class="hs-identifier hs-var">slice_y</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621684366201"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366201"><span class="hs-identifier hs-var">cs_y</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; TopDown rep -&gt; Maybe (BasicOp, Certs)
forall rep. VName -&gt; SymbolTable rep -&gt; Maybe (BasicOp, Certs)
</span><a href="Futhark.Analysis.SymbolTable.html#lookupBasicOp"><span class="hs-identifier hs-var">ST.lookupBasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366204"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684366210"><span class="hs-identifier hs-var">vtable</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-347"></span><span>    </span><span class="annot"><span class="annottext">VName -&gt; TopDown rep -&gt; Bool
forall rep. VName -&gt; SymbolTable rep -&gt; Bool
</span><a href="Futhark.Analysis.SymbolTable.html#available"><span class="hs-identifier hs-var">ST.available</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366203"><span class="hs-identifier hs-var">arr_y</span></a></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684366210"><span class="hs-identifier hs-var">vtable</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-348"></span><span>    </span><span class="hs-comment">-- XXX: we should check for proper aliasing here instead.</span><span>
</span><span id="line-349"></span><span>    </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366203"><span class="hs-identifier hs-var">arr_y</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; VName -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366206"><span class="hs-identifier hs-var">arr_x</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-350"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684366199"><span class="annot"><span class="annottext">[DimIndex SubExp]
</span><a href="#local-6989586621684366199"><span class="hs-identifier hs-var">slice_x_bef</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-type">DimFix</span></a></span><span> </span><span id="local-6989586621684366198"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366198"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int
-&gt; [DimIndex SubExp]
-&gt; Maybe ([DimIndex SubExp], DimIndex SubExp, [DimIndex SubExp])
forall int a. Integral int =&gt; int -&gt; [a] -&gt; Maybe ([a], a, [a])
</span><a href="Futhark.Util.html#focusNth"><span class="hs-identifier hs-var">focusNth</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DimIndex SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[DimIndex SubExp]
</span><a href="#local-6989586621684366205"><span class="hs-identifier hs-var">slice_x</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DimIndex SubExp]
</span><a href="#local-6989586621684366205"><span class="hs-identifier hs-var">slice_x</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-351"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684366196"><span class="annot"><span class="annottext">[DimIndex SubExp]
</span><a href="#local-6989586621684366196"><span class="hs-identifier hs-var">slice_y_bef</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-type">DimFix</span></a></span><span> </span><span id="local-6989586621684366195"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366195"><span class="hs-identifier hs-var">j</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int
-&gt; [DimIndex SubExp]
-&gt; Maybe ([DimIndex SubExp], DimIndex SubExp, [DimIndex SubExp])
forall int a. Integral int =&gt; int -&gt; [a] -&gt; Maybe ([a], a, [a])
</span><a href="Futhark.Util.html#focusNth"><span class="hs-identifier hs-var">focusNth</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DimIndex SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[DimIndex SubExp]
</span><a href="#local-6989586621684366202"><span class="hs-identifier hs-var">slice_y</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DimIndex SubExp]
</span><a href="#local-6989586621684366202"><span class="hs-identifier hs-var">slice_y</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleM rep () -&gt; Rule rep
forall rep. RuleM rep () -&gt; Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Simplify"><span class="hs-identifier hs-var">Simplify</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; Rule rep) -&gt; RuleM rep () -&gt; Rule rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-352"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684366194"><span class="annot"><span class="annottext">slice_x' :: Slice SubExp
</span><a href="#local-6989586621684366194"><span class="hs-identifier hs-var hs-var">slice_x'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[DimIndex SubExp] -&gt; Slice SubExp
forall d. [DimIndex d] -&gt; Slice d
</span><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-var">Slice</span></a></span><span> </span><span class="annot"><span class="annottext">([DimIndex SubExp] -&gt; Slice SubExp)
-&gt; [DimIndex SubExp] -&gt; Slice SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[DimIndex SubExp]
</span><a href="#local-6989586621684366199"><span class="hs-identifier hs-var">slice_x_bef</span></a></span><span> </span><span class="annot"><span class="annottext">[DimIndex SubExp] -&gt; [DimIndex SubExp] -&gt; [DimIndex SubExp]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SubExp -&gt; SubExp -&gt; SubExp -&gt; DimIndex SubExp
forall d. d -&gt; d -&gt; d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimSlice"><span class="hs-identifier hs-var">DimSlice</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366198"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Integer -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#intConst"><span class="hs-identifier hs-var">intConst</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Integer -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#intConst"><span class="hs-identifier hs-var">intConst</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-353"></span><span>        </span><span id="local-6989586621684366193"><span class="annot"><span class="annottext">slice_y' :: Slice SubExp
</span><a href="#local-6989586621684366193"><span class="hs-identifier hs-var hs-var">slice_y'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[DimIndex SubExp] -&gt; Slice SubExp
forall d. [DimIndex d] -&gt; Slice d
</span><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-var">Slice</span></a></span><span> </span><span class="annot"><span class="annottext">([DimIndex SubExp] -&gt; Slice SubExp)
-&gt; [DimIndex SubExp] -&gt; Slice SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[DimIndex SubExp]
</span><a href="#local-6989586621684366196"><span class="hs-identifier hs-var">slice_y_bef</span></a></span><span> </span><span class="annot"><span class="annottext">[DimIndex SubExp] -&gt; [DimIndex SubExp] -&gt; [DimIndex SubExp]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SubExp -&gt; SubExp -&gt; SubExp -&gt; DimIndex SubExp
forall d. d -&gt; d -&gt; d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimSlice"><span class="hs-identifier hs-var">DimSlice</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366195"><span class="hs-identifier hs-var">j</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Integer -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#intConst"><span class="hs-identifier hs-var">intConst</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Integer -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#intConst"><span class="hs-identifier hs-var">intConst</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-354"></span><span>    </span><span id="local-6989586621684366192"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366192"><span class="hs-identifier hs-var">v'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m VName
</span><a href="Futhark.Construct.html#letExp"><span class="hs-identifier hs-var">letExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; String
</span><a href="Language.Futhark.Core.html#baseString"><span class="hs-identifier hs-var">baseString</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366204"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_slice&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep VName)
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Slice SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Index"><span class="hs-identifier hs-var">Index</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366203"><span class="hs-identifier hs-var">arr_y</span></a></span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684366193"><span class="hs-identifier hs-var">slice_y'</span></a></span><span>
</span><span id="line-355"></span><span>    </span><span class="annot"><span class="annottext">Certs -&gt; RuleM rep () -&gt; RuleM rep ()
forall (m :: * -&gt; *) a. MonadBuilder m =&gt; Certs -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#certifying"><span class="hs-identifier hs-var">certifying</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684366201"><span class="hs-identifier hs-var">cs_y</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; RuleM rep ())
-&gt; (RuleM rep () -&gt; RuleM rep ()) -&gt; RuleM rep () -&gt; RuleM rep ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep) -&gt; RuleM rep () -&gt; RuleM rep ()
forall (m :: * -&gt; *) anyrep a.
MonadBuilder m =&gt;
StmAux anyrep -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#auxing"><span class="hs-identifier hs-var">auxing</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><a href="#local-6989586621684366208"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; RuleM rep ()) -&gt; RuleM rep () -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-356"></span><span>      </span><span class="annot"><span class="annottext">Pat (Rep (RuleM rep)) -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
Pat (Rep (RuleM rep))
</span><a href="#local-6989586621684366209"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep ())
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Safety -&gt; VName -&gt; Slice SubExp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Update"><span class="hs-identifier hs-var">Update</span></a></span><span> </span><span class="annot"><span class="annottext">Safety
</span><a href="#local-6989586621684366207"><span class="hs-identifier hs-var">safety</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366206"><span class="hs-identifier hs-var">arr_x</span></a></span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684366194"><span class="hs-identifier hs-var">slice_x'</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; BasicOp) -&gt; SubExp -&gt; BasicOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366192"><span class="hs-identifier hs-var">v'</span></a></span><span>
</span><span id="line-357"></span><span>
</span><span id="line-358"></span><span class="hs-comment">-- Simplify away 0&lt;=i when 'i' is from a loop of form 'for i &lt; n'.</span><span>
</span><span id="line-359"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ruleBasicOp"><span class="hs-identifier hs-var">ruleBasicOp</span></a></span><span> </span><span id="local-6989586621684366191"><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684366191"><span class="hs-identifier hs-var">vtable</span></a></span></span><span> </span><span id="local-6989586621684366190"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684366190"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684366189"><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><a href="#local-6989586621684366189"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#CmpOp"><span class="hs-identifier hs-type">CmpOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Primitive.html#CmpSle"><span class="hs-identifier hs-type">CmpSle</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span id="local-6989586621684366187"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366187"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621684366186"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366186"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-360"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Primitive.html#IntValue"><span class="hs-identifier hs-type">IntValue</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Primitive.html#Int64Value"><span class="hs-identifier hs-type">Int64Value</span></a></span><span> </span><span class="annot"><span class="annottext">Int64
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366187"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-361"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684366183"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366183"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366186"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-362"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; TopDown rep -&gt; Maybe SubExp
forall rep. VName -&gt; SymbolTable rep -&gt; Maybe SubExp
</span><a href="Futhark.Analysis.SymbolTable.html#lookupLoopVar"><span class="hs-identifier hs-var">ST.lookupLoopVar</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366183"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684366191"><span class="hs-identifier hs-var">vtable</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-363"></span><span>    </span><span class="annot"><span class="annottext">RuleM rep () -&gt; Rule rep
forall rep. RuleM rep () -&gt; Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Simplify"><span class="hs-identifier hs-var">Simplify</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; Rule rep) -&gt; RuleM rep () -&gt; Rule rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep) -&gt; RuleM rep () -&gt; RuleM rep ()
forall (m :: * -&gt; *) anyrep a.
MonadBuilder m =&gt;
StmAux anyrep -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#auxing"><span class="hs-identifier hs-var">auxing</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><a href="#local-6989586621684366189"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; RuleM rep ()) -&gt; RuleM rep () -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat (Rep (RuleM rep)) -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
Pat (Rep (RuleM rep))
</span><a href="#local-6989586621684366190"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep ())
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#SubExp"><span class="hs-identifier hs-var">SubExp</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; BasicOp) -&gt; SubExp -&gt; BasicOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SubExp
forall v. IsValue v =&gt; v -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#constant"><span class="hs-identifier hs-var">constant</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-364"></span><span class="hs-comment">-- Simplify away i&lt;n when 'i' is from a loop of form 'for i &lt; n'.</span><span>
</span><span id="line-365"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ruleBasicOp"><span class="hs-identifier hs-var">ruleBasicOp</span></a></span><span> </span><span id="local-6989586621684366181"><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684366181"><span class="hs-identifier hs-var">vtable</span></a></span></span><span> </span><span id="local-6989586621684366180"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684366180"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684366179"><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><a href="#local-6989586621684366179"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#CmpOp"><span class="hs-identifier hs-type">CmpOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Primitive.html#CmpSlt"><span class="hs-identifier hs-type">CmpSlt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span id="local-6989586621684366177"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366177"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621684366176"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366176"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-366"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684366175"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366175"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366177"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-367"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684366174"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366174"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; TopDown rep -&gt; Maybe SubExp
forall rep. VName -&gt; SymbolTable rep -&gt; Maybe SubExp
</span><a href="Futhark.Analysis.SymbolTable.html#lookupLoopVar"><span class="hs-identifier hs-var">ST.lookupLoopVar</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366175"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684366181"><span class="hs-identifier hs-var">vtable</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-368"></span><span>    </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366174"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; SubExp -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366176"><span class="hs-identifier hs-var">y</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-369"></span><span>    </span><span class="annot"><span class="annottext">RuleM rep () -&gt; Rule rep
forall rep. RuleM rep () -&gt; Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Simplify"><span class="hs-identifier hs-var">Simplify</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; Rule rep) -&gt; RuleM rep () -&gt; Rule rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep) -&gt; RuleM rep () -&gt; RuleM rep ()
forall (m :: * -&gt; *) anyrep a.
MonadBuilder m =&gt;
StmAux anyrep -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#auxing"><span class="hs-identifier hs-var">auxing</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><a href="#local-6989586621684366179"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; RuleM rep ()) -&gt; RuleM rep () -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat (Rep (RuleM rep)) -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
Pat (Rep (RuleM rep))
</span><a href="#local-6989586621684366180"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep ())
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#SubExp"><span class="hs-identifier hs-var">SubExp</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; BasicOp) -&gt; SubExp -&gt; BasicOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SubExp
forall v. IsValue v =&gt; v -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#constant"><span class="hs-identifier hs-var">constant</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-370"></span><span class="hs-comment">-- Simplify away x&lt;0 when 'x' has been used as array size.</span><span>
</span><span id="line-371"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ruleBasicOp"><span class="hs-identifier hs-var">ruleBasicOp</span></a></span><span> </span><span id="local-6989586621684366173"><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684366173"><span class="hs-identifier hs-var">vtable</span></a></span></span><span> </span><span id="local-6989586621684366172"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684366172"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684366171"><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><a href="#local-6989586621684366171"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#CmpOp"><span class="hs-identifier hs-type">CmpOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Primitive.html#CmpSlt"><span class="hs-identifier hs-type">CmpSlt</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684366170"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366170"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684366169"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366169"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-372"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Bool
</span><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#isCt0"><span class="hs-identifier hs-var">isCt0</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684366169"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-373"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; (Entry rep -&gt; Bool) -&gt; Maybe (Entry rep) -&gt; Bool
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">Entry rep -&gt; Bool
forall rep. Entry rep -&gt; Bool
</span><a href="Futhark.Analysis.SymbolTable.html#entryIsSize"><span class="hs-identifier hs-var hs-var">ST.entryIsSize</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (Entry rep) -&gt; Bool) -&gt; Maybe (Entry rep) -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TopDown rep -&gt; Maybe (Entry rep)
forall rep. VName -&gt; SymbolTable rep -&gt; Maybe (Entry rep)
</span><a href="Futhark.Analysis.SymbolTable.html#lookup"><span class="hs-identifier hs-var">ST.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366170"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684366173"><span class="hs-identifier hs-var">vtable</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-374"></span><span>    </span><span class="annot"><span class="annottext">RuleM rep () -&gt; Rule rep
forall rep. RuleM rep () -&gt; Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Simplify"><span class="hs-identifier hs-var">Simplify</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; Rule rep) -&gt; RuleM rep () -&gt; Rule rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep) -&gt; RuleM rep () -&gt; RuleM rep ()
forall (m :: * -&gt; *) anyrep a.
MonadBuilder m =&gt;
StmAux anyrep -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#auxing"><span class="hs-identifier hs-var">auxing</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><a href="#local-6989586621684366171"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; RuleM rep ()) -&gt; RuleM rep () -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat (Rep (RuleM rep)) -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
Pat (Rep (RuleM rep))
</span><a href="#local-6989586621684366172"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep ())
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#SubExp"><span class="hs-identifier hs-var">SubExp</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; BasicOp) -&gt; SubExp -&gt; BasicOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SubExp
forall v. IsValue v =&gt; v -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#constant"><span class="hs-identifier hs-var">constant</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-375"></span><span class="hs-comment">-- Remove certificates for variables whose definition already contain</span><span>
</span><span id="line-376"></span><span class="hs-comment">-- that certificate.</span><span>
</span><span id="line-377"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ruleBasicOp"><span class="hs-identifier hs-var">ruleBasicOp</span></a></span><span> </span><span id="local-6989586621684366165"><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684366165"><span class="hs-identifier hs-var">vtable</span></a></span></span><span> </span><span id="local-6989586621684366164"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684366164"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684366163"><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><a href="#local-6989586621684366163"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684366162"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366162"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-378"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621684366161"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684366161"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Certs -&gt; [VName]
</span><a href="Futhark.IR.Syntax.Core.html#unCerts"><span class="hs-identifier hs-var hs-var">unCerts</span></a></span><span> </span><span class="annot"><span class="annottext">(Certs -&gt; [VName]) -&gt; Certs -&gt; [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep) -&gt; Certs
forall dec. StmAux dec -&gt; Certs
</span><a href="Futhark.IR.Syntax.html#stmAuxCerts"><span class="hs-identifier hs-var hs-var">stmAuxCerts</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><a href="#local-6989586621684366163"><span class="hs-identifier hs-var">aux</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-379"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684366161"><span class="hs-identifier hs-var">cs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-380"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684366159"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684366159"><span class="hs-identifier hs-var">v_cs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Certs -&gt; [VName]
</span><a href="Futhark.IR.Syntax.Core.html#unCerts"><span class="hs-identifier hs-var hs-var">unCerts</span></a></span><span> </span><span class="annot"><span class="annottext">(Certs -&gt; [VName]) -&gt; (Stm rep -&gt; Certs) -&gt; Stm rep -&gt; [VName]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; Certs
forall rep. Stm rep -&gt; Certs
</span><a href="Futhark.IR.Prop.html#stmCerts"><span class="hs-identifier hs-var">stmCerts</span></a></span><span> </span><span class="annot"><span class="annottext">(Stm rep -&gt; [VName]) -&gt; Maybe (Stm rep) -&gt; Maybe [VName]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TopDown rep -&gt; Maybe (Stm rep)
forall rep. VName -&gt; SymbolTable rep -&gt; Maybe (Stm rep)
</span><a href="Futhark.Analysis.SymbolTable.html#lookupStm"><span class="hs-identifier hs-var">ST.lookupStm</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366162"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684366165"><span class="hs-identifier hs-var">vtable</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-381"></span><span>    </span><span id="local-6989586621684366157"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684366157"><span class="hs-identifier hs-var">cs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Bool) -&gt; [VName] -&gt; [VName]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; [VName] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`notElem`</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684366159"><span class="hs-identifier hs-var">v_cs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684366161"><span class="hs-identifier hs-var">cs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-382"></span><span>    </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684366157"><span class="hs-identifier hs-var">cs'</span></a></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684366161"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-383"></span><span>    </span><span class="annot"><span class="annottext">RuleM rep () -&gt; Rule rep
forall rep. RuleM rep () -&gt; Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Simplify"><span class="hs-identifier hs-var">Simplify</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; Rule rep)
-&gt; (RuleM rep () -&gt; RuleM rep ()) -&gt; RuleM rep () -&gt; Rule rep
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Certs -&gt; RuleM rep () -&gt; RuleM rep ()
forall (m :: * -&gt; *) a. MonadBuilder m =&gt; Certs -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#certifying"><span class="hs-identifier hs-var">certifying</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; Certs
</span><a href="Futhark.IR.Syntax.Core.html#Certs"><span class="hs-identifier hs-var">Certs</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684366157"><span class="hs-identifier hs-var">cs'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; Rule rep) -&gt; RuleM rep () -&gt; Rule rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-384"></span><span>      </span><span class="annot"><span class="annottext">Pat (Rep (RuleM rep)) -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
Pat (Rep (RuleM rep))
</span><a href="#local-6989586621684366164"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep ())
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#SubExp"><span class="hs-identifier hs-var">SubExp</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; BasicOp) -&gt; SubExp -&gt; BasicOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366162"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-385"></span><span class="hs-comment">-- Remove UpdateAccs that contribute the neutral value, which is</span><span>
</span><span id="line-386"></span><span class="hs-comment">-- always a no-op.</span><span>
</span><span id="line-387"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ruleBasicOp"><span class="hs-identifier hs-var">ruleBasicOp</span></a></span><span> </span><span id="local-6989586621684366154"><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684366154"><span class="hs-identifier hs-var">vtable</span></a></span></span><span> </span><span id="local-6989586621684366153"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684366153"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684366152"><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><a href="#local-6989586621684366152"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#UpdateAcc"><span class="hs-identifier hs-type">UpdateAcc</span></a></span><span> </span><span id="local-6989586621684366150"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366150"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684366149"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684366149"><span class="hs-identifier hs-var">vs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-388"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621684366147"><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684366147"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684366153"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-389"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Acc"><span class="hs-identifier hs-type">Acc</span></a></span><span> </span><span id="local-6989586621684366146"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366146"><span class="hs-identifier hs-var">token</span></a></span></span><span> </span><span class="annot"><span class="annottext">Shape
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">NoUniqueness
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep) -&gt; Type
forall dec. Typed dec =&gt; PatElemT dec -&gt; Type
</span><a href="Futhark.IR.Prop.Patterns.html#patElemType"><span class="hs-identifier hs-var">patElemType</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684366147"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-390"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Shape
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda rep
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684366144"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684366144"><span class="hs-identifier hs-var">ne</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Entry rep -&gt; Maybe (WithAccInput rep)
forall rep. Entry rep -&gt; Maybe (WithAccInput rep)
</span><a href="Futhark.Analysis.SymbolTable.html#entryAccInput"><span class="hs-identifier hs-var hs-var">ST.entryAccInput</span></a></span><span> </span><span class="annot"><span class="annottext">(Entry rep -&gt; Maybe (WithAccInput rep))
-&gt; Maybe (Entry rep) -&gt; Maybe (WithAccInput rep)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TopDown rep -&gt; Maybe (Entry rep)
forall rep. VName -&gt; SymbolTable rep -&gt; Maybe (Entry rep)
</span><a href="Futhark.Analysis.SymbolTable.html#lookup"><span class="hs-identifier hs-var">ST.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366146"><span class="hs-identifier hs-var">token</span></a></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684366154"><span class="hs-identifier hs-var">vtable</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-391"></span><span>    </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684366149"><span class="hs-identifier hs-var">vs</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; [SubExp] -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684366144"><span class="hs-identifier hs-var">ne</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-392"></span><span>    </span><span class="annot"><span class="annottext">RuleM rep () -&gt; Rule rep
forall rep. RuleM rep () -&gt; Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Simplify"><span class="hs-identifier hs-var">Simplify</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; Rule rep)
-&gt; (RuleM rep () -&gt; RuleM rep ()) -&gt; RuleM rep () -&gt; Rule rep
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep) -&gt; RuleM rep () -&gt; RuleM rep ()
forall (m :: * -&gt; *) anyrep a.
MonadBuilder m =&gt;
StmAux anyrep -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#auxing"><span class="hs-identifier hs-var">auxing</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><a href="#local-6989586621684366152"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; Rule rep) -&gt; RuleM rep () -&gt; Rule rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat (Rep (RuleM rep)) -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
Pat (Rep (RuleM rep))
</span><a href="#local-6989586621684366153"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep ())
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#SubExp"><span class="hs-identifier hs-var">SubExp</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; BasicOp) -&gt; SubExp -&gt; BasicOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684366150"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-393"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ruleBasicOp"><span class="hs-identifier hs-var">ruleBasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">BasicOp
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-394"></span><span>  </span><span class="annot"><span class="annottext">Rule rep
forall rep. Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span>
</span><span id="line-395"></span><span>
</span><span id="line-396"></span><span id="local-6989586621684366964"><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#topDownRules"><span class="hs-identifier hs-type">topDownRules</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Builder.html#BuilderOps"><span class="hs-identifier hs-type">BuilderOps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684366964"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rule.html#TopDownRule"><span class="hs-identifier hs-type">TopDownRule</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684366964"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">]</span></span><span>
</span><span id="line-397"></span><span id="topDownRules"><span class="annot"><span class="annottext">topDownRules :: forall rep. BuilderOps rep =&gt; [TopDownRule rep]
</span><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#topDownRules"><span class="hs-identifier hs-var hs-var">topDownRules</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-398"></span><span>  </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">RuleBasicOp rep (TopDown rep) -&gt; TopDownRule rep
forall rep a. RuleBasicOp rep a -&gt; SimplificationRule rep a
</span><a href="Futhark.Optimise.Simplify.Rule.html#RuleBasicOp"><span class="hs-identifier hs-var">RuleBasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">RuleBasicOp rep (TopDown rep)
forall rep. BuilderOps rep =&gt; TopDownRuleBasicOp rep
</span><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#ruleBasicOp"><span class="hs-identifier hs-var">ruleBasicOp</span></a></span><span>
</span><span id="line-399"></span><span>  </span><span class="hs-special">]</span><span>
</span><span id="line-400"></span><span>
</span><span id="line-401"></span><span id="local-6989586621684366957"><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#bottomUpRules"><span class="hs-identifier hs-type">bottomUpRules</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Builder.html#BuilderOps"><span class="hs-identifier hs-type">BuilderOps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684366957"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rule.html#BottomUpRule"><span class="hs-identifier hs-type">BottomUpRule</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684366957"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">]</span></span><span>
</span><span id="line-402"></span><span id="bottomUpRules"><span class="annot"><span class="annottext">bottomUpRules :: forall rep. BuilderOps rep =&gt; [BottomUpRule rep]
</span><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#bottomUpRules"><span class="hs-identifier hs-var hs-var">bottomUpRules</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-403"></span><span>  </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">RuleBasicOp rep (BottomUp rep) -&gt; BottomUpRule rep
forall rep a. RuleBasicOp rep a -&gt; SimplificationRule rep a
</span><a href="Futhark.Optimise.Simplify.Rule.html#RuleBasicOp"><span class="hs-identifier hs-var">RuleBasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">RuleBasicOp rep (BottomUp rep)
forall rep. BuilderOps rep =&gt; BottomUpRuleBasicOp rep
</span><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#simplifyConcat"><span class="hs-identifier hs-var">simplifyConcat</span></a></span><span>
</span><span id="line-404"></span><span>  </span><span class="hs-special">]</span><span>
</span><span id="line-405"></span><span>
</span><span id="line-406"></span><span class="hs-comment">-- | A set of simplification rules for t'BasicOp's.  Includes rules</span><span>
</span><span id="line-407"></span><span class="hs-comment">-- from &quot;Futhark.Optimise.Simplify.Rules.Simple&quot;.</span><span>
</span><span id="line-408"></span><span id="local-6989586621684366953"><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#basicOpRules"><span class="hs-identifier hs-type">basicOpRules</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Builder.html#BuilderOps"><span class="hs-identifier hs-type">BuilderOps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684366953"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Aliases.html#Aliased"><span class="hs-identifier hs-type">Aliased</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684366953"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Rule.html#RuleBook"><span class="hs-identifier hs-type">RuleBook</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684366953"><span class="hs-identifier hs-type">rep</span></a></span></span><span>
</span><span id="line-409"></span><span id="basicOpRules"><span class="annot"><span class="annottext">basicOpRules :: forall rep. (BuilderOps rep, Aliased rep) =&gt; RuleBook rep
</span><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#basicOpRules"><span class="hs-identifier hs-var hs-var">basicOpRules</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TopDownRule rep] -&gt; [BottomUpRule rep] -&gt; RuleBook rep
forall m. [TopDownRule m] -&gt; [BottomUpRule m] -&gt; RuleBook m
</span><a href="Futhark.Optimise.Simplify.Rule.html#ruleBook"><span class="hs-identifier hs-var">ruleBook</span></a></span><span> </span><span class="annot"><span class="annottext">[TopDownRule rep]
forall rep. BuilderOps rep =&gt; [TopDownRule rep]
</span><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#topDownRules"><span class="hs-identifier hs-var">topDownRules</span></a></span><span> </span><span class="annot"><span class="annottext">[BottomUpRule rep]
forall rep. BuilderOps rep =&gt; [BottomUpRule rep]
</span><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#bottomUpRules"><span class="hs-identifier hs-var">bottomUpRules</span></a></span><span> </span><span class="annot"><span class="annottext">RuleBook rep -&gt; RuleBook rep -&gt; RuleBook rep
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">RuleBook rep
forall rep. (BuilderOps rep, Aliased rep) =&gt; RuleBook rep
</span><a href="Futhark.Optimise.Simplify.Rules.Loop.html#loopRules"><span class="hs-identifier hs-var">loopRules</span></a></span><span>
</span><span id="line-410"></span></pre></body></html>