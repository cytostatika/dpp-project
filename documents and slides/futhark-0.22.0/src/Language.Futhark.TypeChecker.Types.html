<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE FlexibleInstances #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE TupleSections #-}</span><span>
</span><span id="line-6"></span><span>
</span><span id="line-7"></span><span class="hs-comment">-- | Type checker building blocks that do not involve unification.</span><span>
</span><span id="line-8"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Language.Futhark.TypeChecker.Types</span><span>
</span><span id="line-9"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#checkTypeExp"><span class="hs-identifier">checkTypeExp</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-10"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#renameRetType"><span class="hs-identifier">renameRetType</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-11"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#unifyTypesU"><span class="hs-identifier">unifyTypesU</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-12"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#subtypeOf"><span class="hs-identifier">subtypeOf</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-13"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#subuniqueOf"><span class="hs-identifier">subuniqueOf</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-14"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#checkForDuplicateNames"><span class="hs-identifier">checkForDuplicateNames</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-15"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#checkTypeParams"><span class="hs-identifier">checkTypeParams</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-16"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#typeParamToArg"><span class="hs-identifier">typeParamToArg</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-17"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#Subst"><span class="hs-identifier">Subst</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-18"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#substFromAbbr"><span class="hs-identifier">substFromAbbr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-19"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#TypeSubs"><span class="hs-identifier">TypeSubs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-20"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#Substitutable"><span class="hs-identifier">Substitutable</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-21"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#substTypesAny"><span class="hs-identifier">substTypesAny</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-22"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span class="hs-keyword">where</span><span>
</span><span id="line-24"></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Identity</span></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Reader</span></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.State</span></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Bifunctor</span></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">foldl'</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">sort</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">unzip4</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-operator">(\\)</span></span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map.Strict</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Util.html"><span class="hs-identifier">Futhark.Util</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Util.html#nubOrd"><span class="hs-identifier">nubOrd</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Util.Pretty.html"><span class="hs-identifier">Futhark.Util.Pretty</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-operator">(&lt;|&gt;)</span></span><span class="hs-special">)</span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Language.Futhark.html"><span class="hs-identifier">Language.Futhark</span></a></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Language.Futhark.Traversals.html"><span class="hs-identifier">Language.Futhark.Traversals</span></a></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Monad.html"><span class="hs-identifier">Language.Futhark.TypeChecker.Monad</span></a></span><span>
</span><span id="line-37"></span><span>
</span><span id="line-38"></span><span class="hs-comment">-- | @unifyTypes uf t1 t2@ attempts to unify @t1@ and @t2@.  If</span><span>
</span><span id="line-39"></span><span class="hs-comment">-- unification cannot happen, 'Nothing' is returned, otherwise a type</span><span>
</span><span id="line-40"></span><span class="hs-comment">-- that combines the aliasing of @t1@ and @t2@ is returned.</span><span>
</span><span id="line-41"></span><span class="hs-comment">-- Uniqueness is unified with @uf@.  Assumes sizes already match, and</span><span>
</span><span id="line-42"></span><span class="hs-comment">-- always picks the size of the leftmost type.</span><span>
</span><span id="line-43"></span><span id="local-6989586621684550591"><span id="local-6989586621684550592"><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#unifyTypesU"><span class="hs-identifier hs-type">unifyTypesU</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-44"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monoid</span></span><span> </span><span class="annot"><a href="#local-6989586621684550592"><span class="hs-identifier hs-type">als</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#ArrayDim"><span class="hs-identifier hs-type">ArrayDim</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684550591"><span class="hs-identifier hs-type">dim</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-45"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Core.html#Uniqueness"><span class="hs-identifier hs-type">Uniqueness</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#Uniqueness"><span class="hs-identifier hs-type">Uniqueness</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#Uniqueness"><span class="hs-identifier hs-type">Uniqueness</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-46"></span><span>  </span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeBase"><span class="hs-identifier hs-type">TypeBase</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684550591"><span class="hs-identifier hs-type">dim</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684550592"><span class="hs-identifier hs-type">als</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-47"></span><span>  </span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeBase"><span class="hs-identifier hs-type">TypeBase</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684550591"><span class="hs-identifier hs-type">dim</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684550592"><span class="hs-identifier hs-type">als</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-48"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeBase"><span class="hs-identifier hs-type">TypeBase</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684550591"><span class="hs-identifier hs-type">dim</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684550592"><span class="hs-identifier hs-type">als</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-49"></span><span id="unifyTypesU"><span class="annot"><span class="annottext">unifyTypesU :: forall als dim.
(Monoid als, ArrayDim dim) =&gt;
(Uniqueness -&gt; Uniqueness -&gt; Maybe Uniqueness)
-&gt; TypeBase dim als -&gt; TypeBase dim als -&gt; Maybe (TypeBase dim als)
</span><a href="Language.Futhark.TypeChecker.Types.html#unifyTypesU"><span class="hs-identifier hs-var hs-var">unifyTypesU</span></a></span></span><span> </span><span id="local-6989586621684550205"><span class="annot"><span class="annottext">Uniqueness -&gt; Uniqueness -&gt; Maybe Uniqueness
</span><a href="#local-6989586621684550205"><span class="hs-identifier hs-var">uf</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span id="local-6989586621684550203"><span class="annot"><span class="annottext">als
</span><a href="#local-6989586621684550203"><span class="hs-identifier hs-var">als1</span></a></span></span><span> </span><span id="local-6989586621684550202"><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684550202"><span class="hs-identifier hs-var">u1</span></a></span></span><span> </span><span id="local-6989586621684550201"><span class="annot"><span class="annottext">ScalarTypeBase dim ()
</span><a href="#local-6989586621684550201"><span class="hs-identifier hs-var">et1</span></a></span></span><span> </span><span id="local-6989586621684550200"><span class="annot"><span class="annottext">ShapeDecl dim
</span><a href="#local-6989586621684550200"><span class="hs-identifier hs-var">shape1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span id="local-6989586621684550199"><span class="annot"><span class="annottext">als
</span><a href="#local-6989586621684550199"><span class="hs-identifier hs-var">als2</span></a></span></span><span> </span><span id="local-6989586621684550198"><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684550198"><span class="hs-identifier hs-var">u2</span></a></span></span><span> </span><span id="local-6989586621684550197"><span class="annot"><span class="annottext">ScalarTypeBase dim ()
</span><a href="#local-6989586621684550197"><span class="hs-identifier hs-var">et2</span></a></span></span><span> </span><span id="local-6989586621684550196"><span class="annot"><span class="annottext">ShapeDecl dim
</span><a href="#local-6989586621684550196"><span class="hs-identifier hs-var">_shape2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-50"></span><span>  </span><span class="annot"><span class="annottext">als
-&gt; Uniqueness
-&gt; ScalarTypeBase dim ()
-&gt; ShapeDecl dim
-&gt; TypeBase dim als
forall dim as.
as
-&gt; Uniqueness
-&gt; ScalarTypeBase dim ()
-&gt; ShapeDecl dim
-&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Array"><span class="hs-identifier hs-var">Array</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">als
</span><a href="#local-6989586621684550203"><span class="hs-identifier hs-var">als1</span></a></span><span> </span><span class="annot"><span class="annottext">als -&gt; als -&gt; als
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">als
</span><a href="#local-6989586621684550199"><span class="hs-identifier hs-var">als2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Uniqueness
 -&gt; ScalarTypeBase dim () -&gt; ShapeDecl dim -&gt; TypeBase dim als)
-&gt; Maybe Uniqueness
-&gt; Maybe
     (ScalarTypeBase dim () -&gt; ShapeDecl dim -&gt; TypeBase dim als)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Uniqueness -&gt; Uniqueness -&gt; Maybe Uniqueness
</span><a href="#local-6989586621684550205"><span class="hs-identifier hs-var">uf</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684550202"><span class="hs-identifier hs-var">u1</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684550198"><span class="hs-identifier hs-var">u2</span></a></span><span>
</span><span id="line-51"></span><span>    </span><span class="annot"><span class="annottext">Maybe (ScalarTypeBase dim () -&gt; ShapeDecl dim -&gt; TypeBase dim als)
-&gt; Maybe (ScalarTypeBase dim ())
-&gt; Maybe (ShapeDecl dim -&gt; TypeBase dim als)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Uniqueness -&gt; Uniqueness -&gt; Maybe Uniqueness)
-&gt; ScalarTypeBase dim ()
-&gt; ScalarTypeBase dim ()
-&gt; Maybe (ScalarTypeBase dim ())
forall als dim.
(Monoid als, ArrayDim dim) =&gt;
(Uniqueness -&gt; Uniqueness -&gt; Maybe Uniqueness)
-&gt; ScalarTypeBase dim als
-&gt; ScalarTypeBase dim als
-&gt; Maybe (ScalarTypeBase dim als)
</span><a href="Language.Futhark.TypeChecker.Types.html#unifyScalarTypes"><span class="hs-identifier hs-var">unifyScalarTypes</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness -&gt; Uniqueness -&gt; Maybe Uniqueness
</span><a href="#local-6989586621684550205"><span class="hs-identifier hs-var">uf</span></a></span><span> </span><span class="annot"><span class="annottext">ScalarTypeBase dim ()
</span><a href="#local-6989586621684550201"><span class="hs-identifier hs-var">et1</span></a></span><span> </span><span class="annot"><span class="annottext">ScalarTypeBase dim ()
</span><a href="#local-6989586621684550197"><span class="hs-identifier hs-var">et2</span></a></span><span>
</span><span id="line-52"></span><span>    </span><span class="annot"><span class="annottext">Maybe (ShapeDecl dim -&gt; TypeBase dim als)
-&gt; Maybe (ShapeDecl dim) -&gt; Maybe (TypeBase dim als)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">ShapeDecl dim -&gt; Maybe (ShapeDecl dim)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">ShapeDecl dim
</span><a href="#local-6989586621684550200"><span class="hs-identifier hs-var">shape1</span></a></span><span>
</span><span id="line-53"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#unifyTypesU"><span class="hs-identifier hs-var">unifyTypesU</span></a></span><span> </span><span id="local-6989586621684550193"><span class="annot"><span class="annottext">Uniqueness -&gt; Uniqueness -&gt; Maybe Uniqueness
</span><a href="#local-6989586621684550193"><span class="hs-identifier hs-var">uf</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a></span><span> </span><span id="local-6989586621684550191"><span class="annot"><span class="annottext">ScalarTypeBase dim als
</span><a href="#local-6989586621684550191"><span class="hs-identifier hs-var">t1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a></span><span> </span><span id="local-6989586621684550190"><span class="annot"><span class="annottext">ScalarTypeBase dim als
</span><a href="#local-6989586621684550190"><span class="hs-identifier hs-var">t2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScalarTypeBase dim als -&gt; TypeBase dim als
forall dim as. ScalarTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-var">Scalar</span></a></span><span> </span><span class="annot"><span class="annottext">(ScalarTypeBase dim als -&gt; TypeBase dim als)
-&gt; Maybe (ScalarTypeBase dim als) -&gt; Maybe (TypeBase dim als)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Uniqueness -&gt; Uniqueness -&gt; Maybe Uniqueness)
-&gt; ScalarTypeBase dim als
-&gt; ScalarTypeBase dim als
-&gt; Maybe (ScalarTypeBase dim als)
forall als dim.
(Monoid als, ArrayDim dim) =&gt;
(Uniqueness -&gt; Uniqueness -&gt; Maybe Uniqueness)
-&gt; ScalarTypeBase dim als
-&gt; ScalarTypeBase dim als
-&gt; Maybe (ScalarTypeBase dim als)
</span><a href="Language.Futhark.TypeChecker.Types.html#unifyScalarTypes"><span class="hs-identifier hs-var">unifyScalarTypes</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness -&gt; Uniqueness -&gt; Maybe Uniqueness
</span><a href="#local-6989586621684550193"><span class="hs-identifier hs-var">uf</span></a></span><span> </span><span class="annot"><span class="annottext">ScalarTypeBase dim als
</span><a href="#local-6989586621684550191"><span class="hs-identifier hs-var">t1</span></a></span><span> </span><span class="annot"><span class="annottext">ScalarTypeBase dim als
</span><a href="#local-6989586621684550190"><span class="hs-identifier hs-var">t2</span></a></span><span>
</span><span id="line-54"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#unifyTypesU"><span class="hs-identifier hs-var">unifyTypesU</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness -&gt; Uniqueness -&gt; Maybe Uniqueness
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">TypeBase dim als
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">TypeBase dim als
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (TypeBase dim als)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-55"></span><span>
</span><span id="line-56"></span><span id="local-6989586621684550573"><span id="local-6989586621684550574"><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#unifyScalarTypes"><span class="hs-identifier hs-type">unifyScalarTypes</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-57"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monoid</span></span><span> </span><span class="annot"><a href="#local-6989586621684550574"><span class="hs-identifier hs-type">als</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#ArrayDim"><span class="hs-identifier hs-type">ArrayDim</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684550573"><span class="hs-identifier hs-type">dim</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-58"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Core.html#Uniqueness"><span class="hs-identifier hs-type">Uniqueness</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#Uniqueness"><span class="hs-identifier hs-type">Uniqueness</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#Uniqueness"><span class="hs-identifier hs-type">Uniqueness</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-59"></span><span>  </span><span class="annot"><a href="Language.Futhark.Syntax.html#ScalarTypeBase"><span class="hs-identifier hs-type">ScalarTypeBase</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684550573"><span class="hs-identifier hs-type">dim</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684550574"><span class="hs-identifier hs-type">als</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-60"></span><span>  </span><span class="annot"><a href="Language.Futhark.Syntax.html#ScalarTypeBase"><span class="hs-identifier hs-type">ScalarTypeBase</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684550573"><span class="hs-identifier hs-type">dim</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684550574"><span class="hs-identifier hs-type">als</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-61"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#ScalarTypeBase"><span class="hs-identifier hs-type">ScalarTypeBase</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684550573"><span class="hs-identifier hs-type">dim</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684550574"><span class="hs-identifier hs-type">als</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-62"></span><span id="unifyScalarTypes"><span class="annot"><span class="annottext">unifyScalarTypes :: forall als dim.
(Monoid als, ArrayDim dim) =&gt;
(Uniqueness -&gt; Uniqueness -&gt; Maybe Uniqueness)
-&gt; ScalarTypeBase dim als
-&gt; ScalarTypeBase dim als
-&gt; Maybe (ScalarTypeBase dim als)
</span><a href="Language.Futhark.TypeChecker.Types.html#unifyScalarTypes"><span class="hs-identifier hs-var hs-var">unifyScalarTypes</span></a></span></span><span> </span><span class="annot"><span class="annottext">Uniqueness -&gt; Uniqueness -&gt; Maybe Uniqueness
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Prim"><span class="hs-identifier hs-type">Prim</span></a></span><span> </span><span id="local-6989586621684550135"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684550135"><span class="hs-identifier hs-var">t1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Prim"><span class="hs-identifier hs-type">Prim</span></a></span><span> </span><span id="local-6989586621684550134"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684550134"><span class="hs-identifier hs-var">t2</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-63"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684550135"><span class="hs-identifier hs-var">t1</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; PrimType -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684550134"><span class="hs-identifier hs-var">t2</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScalarTypeBase dim als -&gt; Maybe (ScalarTypeBase dim als)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(ScalarTypeBase dim als -&gt; Maybe (ScalarTypeBase dim als))
-&gt; ScalarTypeBase dim als -&gt; Maybe (ScalarTypeBase dim als)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; ScalarTypeBase dim als
forall dim as. PrimType -&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684550135"><span class="hs-identifier hs-var">t1</span></a></span><span>
</span><span id="line-64"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (ScalarTypeBase dim als)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-65"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#unifyScalarTypes"><span class="hs-identifier hs-var">unifyScalarTypes</span></a></span><span> </span><span id="local-6989586621684550133"><span class="annot"><span class="annottext">Uniqueness -&gt; Uniqueness -&gt; Maybe Uniqueness
</span><a href="#local-6989586621684550133"><span class="hs-identifier hs-var">uf</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeVar"><span class="hs-identifier hs-type">TypeVar</span></a></span><span> </span><span id="local-6989586621684550131"><span class="annot"><span class="annottext">als
</span><a href="#local-6989586621684550131"><span class="hs-identifier hs-var">als1</span></a></span></span><span> </span><span id="local-6989586621684550130"><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684550130"><span class="hs-identifier hs-var">u1</span></a></span></span><span> </span><span id="local-6989586621684550129"><span class="annot"><span class="annottext">TypeName
</span><a href="#local-6989586621684550129"><span class="hs-identifier hs-var">tv1</span></a></span></span><span> </span><span id="local-6989586621684550128"><span class="annot"><span class="annottext">[TypeArg dim]
</span><a href="#local-6989586621684550128"><span class="hs-identifier hs-var">targs1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeVar"><span class="hs-identifier hs-type">TypeVar</span></a></span><span> </span><span id="local-6989586621684550127"><span class="annot"><span class="annottext">als
</span><a href="#local-6989586621684550127"><span class="hs-identifier hs-var">als2</span></a></span></span><span> </span><span id="local-6989586621684550126"><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684550126"><span class="hs-identifier hs-var">u2</span></a></span></span><span> </span><span id="local-6989586621684550125"><span class="annot"><span class="annottext">TypeName
</span><a href="#local-6989586621684550125"><span class="hs-identifier hs-var">tv2</span></a></span></span><span> </span><span id="local-6989586621684550124"><span class="annot"><span class="annottext">[TypeArg dim]
</span><a href="#local-6989586621684550124"><span class="hs-identifier hs-var">targs2</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-66"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TypeName
</span><a href="#local-6989586621684550129"><span class="hs-identifier hs-var">tv1</span></a></span><span> </span><span class="annot"><span class="annottext">TypeName -&gt; TypeName -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">TypeName
</span><a href="#local-6989586621684550125"><span class="hs-identifier hs-var">tv2</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-67"></span><span>    </span><span id="local-6989586621684550123"><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684550123"><span class="hs-identifier hs-var">u3</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Uniqueness -&gt; Uniqueness -&gt; Maybe Uniqueness
</span><a href="#local-6989586621684550133"><span class="hs-identifier hs-var">uf</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684550130"><span class="hs-identifier hs-var">u1</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684550126"><span class="hs-identifier hs-var">u2</span></a></span><span>
</span><span id="line-68"></span><span>    </span><span id="local-6989586621684550122"><span class="annot"><span class="annottext">[TypeArg dim]
</span><a href="#local-6989586621684550122"><span class="hs-identifier hs-var">targs3</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TypeArg dim -&gt; TypeArg dim -&gt; Maybe (TypeArg dim))
-&gt; [TypeArg dim] -&gt; [TypeArg dim] -&gt; Maybe [TypeArg dim]
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m [c]
</span><span class="hs-identifier hs-var">zipWithM</span></span><span> </span><span class="annot"><span class="annottext">TypeArg dim -&gt; TypeArg dim -&gt; Maybe (TypeArg dim)
forall {dim}.
ArrayDim dim =&gt;
TypeArg dim -&gt; TypeArg dim -&gt; Maybe (TypeArg dim)
</span><a href="#local-6989586621684550120"><span class="hs-identifier hs-var">unifyTypeArgs</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeArg dim]
</span><a href="#local-6989586621684550128"><span class="hs-identifier hs-var">targs1</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeArg dim]
</span><a href="#local-6989586621684550124"><span class="hs-identifier hs-var">targs2</span></a></span><span>
</span><span id="line-69"></span><span>    </span><span class="annot"><span class="annottext">ScalarTypeBase dim als -&gt; Maybe (ScalarTypeBase dim als)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(ScalarTypeBase dim als -&gt; Maybe (ScalarTypeBase dim als))
-&gt; ScalarTypeBase dim als -&gt; Maybe (ScalarTypeBase dim als)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">als
-&gt; Uniqueness
-&gt; TypeName
-&gt; [TypeArg dim]
-&gt; ScalarTypeBase dim als
forall dim as.
as
-&gt; Uniqueness -&gt; TypeName -&gt; [TypeArg dim] -&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#TypeVar"><span class="hs-identifier hs-var">TypeVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">als
</span><a href="#local-6989586621684550131"><span class="hs-identifier hs-var">als1</span></a></span><span> </span><span class="annot"><span class="annottext">als -&gt; als -&gt; als
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">als
</span><a href="#local-6989586621684550127"><span class="hs-identifier hs-var">als2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684550123"><span class="hs-identifier hs-var">u3</span></a></span><span> </span><span class="annot"><span class="annottext">TypeName
</span><a href="#local-6989586621684550129"><span class="hs-identifier hs-var">tv1</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeArg dim]
</span><a href="#local-6989586621684550122"><span class="hs-identifier hs-var">targs3</span></a></span><span>
</span><span id="line-70"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (ScalarTypeBase dim als)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-71"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-72"></span><span>    </span><span id="local-6989586621684550120"><span class="annot"><span class="annottext">unifyTypeArgs :: TypeArg dim -&gt; TypeArg dim -&gt; Maybe (TypeArg dim)
</span><a href="#local-6989586621684550120"><span class="hs-identifier hs-var hs-var">unifyTypeArgs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeArgDim"><span class="hs-identifier hs-type">TypeArgDim</span></a></span><span> </span><span id="local-6989586621684550111"><span class="annot"><span class="annottext">dim
</span><a href="#local-6989586621684550111"><span class="hs-identifier hs-var">d1</span></a></span></span><span> </span><span id="local-6989586621684550110"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684550110"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeArgDim"><span class="hs-identifier hs-type">TypeArgDim</span></a></span><span> </span><span id="local-6989586621684550109"><span class="annot"><span class="annottext">dim
</span><a href="#local-6989586621684550109"><span class="hs-identifier hs-var">_d2</span></a></span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-73"></span><span>      </span><span class="annot"><span class="annottext">TypeArg dim -&gt; Maybe (TypeArg dim)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(TypeArg dim -&gt; Maybe (TypeArg dim))
-&gt; TypeArg dim -&gt; Maybe (TypeArg dim)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">dim -&gt; SrcLoc -&gt; TypeArg dim
forall dim. dim -&gt; SrcLoc -&gt; TypeArg dim
</span><a href="Language.Futhark.Syntax.html#TypeArgDim"><span class="hs-identifier hs-var">TypeArgDim</span></a></span><span> </span><span class="annot"><span class="annottext">dim
</span><a href="#local-6989586621684550111"><span class="hs-identifier hs-var">d1</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684550110"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-74"></span><span>    </span><span class="annot"><a href="#local-6989586621684550120"><span class="hs-identifier hs-var">unifyTypeArgs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeArgType"><span class="hs-identifier hs-type">TypeArgType</span></a></span><span> </span><span id="local-6989586621684550107"><span class="annot"><span class="annottext">TypeBase dim ()
</span><a href="#local-6989586621684550107"><span class="hs-identifier hs-var">t1</span></a></span></span><span> </span><span id="local-6989586621684550106"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684550106"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeArgType"><span class="hs-identifier hs-type">TypeArgType</span></a></span><span> </span><span id="local-6989586621684550105"><span class="annot"><span class="annottext">TypeBase dim ()
</span><a href="#local-6989586621684550105"><span class="hs-identifier hs-var">t2</span></a></span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-75"></span><span>      </span><span class="annot"><span class="annottext">TypeBase dim () -&gt; SrcLoc -&gt; TypeArg dim
forall dim. TypeBase dim () -&gt; SrcLoc -&gt; TypeArg dim
</span><a href="Language.Futhark.Syntax.html#TypeArgType"><span class="hs-identifier hs-var">TypeArgType</span></a></span><span> </span><span class="annot"><span class="annottext">(TypeBase dim () -&gt; SrcLoc -&gt; TypeArg dim)
-&gt; Maybe (TypeBase dim ()) -&gt; Maybe (SrcLoc -&gt; TypeArg dim)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Uniqueness -&gt; Uniqueness -&gt; Maybe Uniqueness)
-&gt; TypeBase dim () -&gt; TypeBase dim () -&gt; Maybe (TypeBase dim ())
forall als dim.
(Monoid als, ArrayDim dim) =&gt;
(Uniqueness -&gt; Uniqueness -&gt; Maybe Uniqueness)
-&gt; TypeBase dim als -&gt; TypeBase dim als -&gt; Maybe (TypeBase dim als)
</span><a href="Language.Futhark.TypeChecker.Types.html#unifyTypesU"><span class="hs-identifier hs-var">unifyTypesU</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness -&gt; Uniqueness -&gt; Maybe Uniqueness
</span><a href="#local-6989586621684550133"><span class="hs-identifier hs-var">uf</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase dim ()
</span><a href="#local-6989586621684550107"><span class="hs-identifier hs-var">t1</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase dim ()
</span><a href="#local-6989586621684550105"><span class="hs-identifier hs-var">t2</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (SrcLoc -&gt; TypeArg dim)
-&gt; Maybe SrcLoc -&gt; Maybe (TypeArg dim)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc -&gt; Maybe SrcLoc
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684550106"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-76"></span><span>    </span><span class="annot"><a href="#local-6989586621684550120"><span class="hs-identifier hs-var">unifyTypeArgs</span></a></span><span> </span><span class="annot"><span class="annottext">TypeArg dim
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">TypeArg dim
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-77"></span><span>      </span><span class="annot"><span class="annottext">Maybe (TypeArg dim)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-78"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#unifyScalarTypes"><span class="hs-identifier hs-var">unifyScalarTypes</span></a></span><span> </span><span id="local-6989586621684550104"><span class="annot"><span class="annottext">Uniqueness -&gt; Uniqueness -&gt; Maybe Uniqueness
</span><a href="#local-6989586621684550104"><span class="hs-identifier hs-var">uf</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Record"><span class="hs-identifier hs-type">Record</span></a></span><span> </span><span id="local-6989586621684550102"><span class="annot"><span class="annottext">Map Name (TypeBase dim als)
</span><a href="#local-6989586621684550102"><span class="hs-identifier hs-var">ts1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Record"><span class="hs-identifier hs-type">Record</span></a></span><span> </span><span id="local-6989586621684550101"><span class="annot"><span class="annottext">Map Name (TypeBase dim als)
</span><a href="#local-6989586621684550101"><span class="hs-identifier hs-var">ts2</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-79"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Map Name (TypeBase dim als) -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">Map Name (TypeBase dim als)
</span><a href="#local-6989586621684550102"><span class="hs-identifier hs-var">ts1</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Map Name (TypeBase dim als) -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">Map Name (TypeBase dim als)
</span><a href="#local-6989586621684550101"><span class="hs-identifier hs-var">ts2</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-80"></span><span>    </span><span class="annot"><span class="annottext">[Name] -&gt; [Name]
forall a. Ord a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">sort</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map Name (TypeBase dim als) -&gt; [Name]
forall k a. Map k a -&gt; [k]
</span><span class="hs-identifier hs-var">M.keys</span></span><span> </span><span class="annot"><span class="annottext">Map Name (TypeBase dim als)
</span><a href="#local-6989586621684550102"><span class="hs-identifier hs-var">ts1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Name] -&gt; [Name] -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">[Name] -&gt; [Name]
forall a. Ord a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">sort</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map Name (TypeBase dim als) -&gt; [Name]
forall k a. Map k a -&gt; [k]
</span><span class="hs-identifier hs-var">M.keys</span></span><span> </span><span class="annot"><span class="annottext">Map Name (TypeBase dim als)
</span><a href="#local-6989586621684550101"><span class="hs-identifier hs-var">ts2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-81"></span><span>    </span><span class="annot"><span class="annottext">Map Name (TypeBase dim als) -&gt; ScalarTypeBase dim als
forall dim as. Map Name (TypeBase dim as) -&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Record"><span class="hs-identifier hs-var">Record</span></a></span><span>
</span><span id="line-82"></span><span>      </span><span class="annot"><span class="annottext">(Map Name (TypeBase dim als) -&gt; ScalarTypeBase dim als)
-&gt; Maybe (Map Name (TypeBase dim als))
-&gt; Maybe (ScalarTypeBase dim als)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">((TypeBase dim als, TypeBase dim als) -&gt; Maybe (TypeBase dim als))
-&gt; Map Name (TypeBase dim als, TypeBase dim als)
-&gt; Maybe (Map Name (TypeBase dim als))
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span>
</span><span id="line-83"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TypeBase dim als -&gt; TypeBase dim als -&gt; Maybe (TypeBase dim als))
-&gt; (TypeBase dim als, TypeBase dim als) -&gt; Maybe (TypeBase dim als)
forall a b c. (a -&gt; b -&gt; c) -&gt; (a, b) -&gt; c
</span><span class="hs-identifier hs-var">uncurry</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Uniqueness -&gt; Uniqueness -&gt; Maybe Uniqueness)
-&gt; TypeBase dim als -&gt; TypeBase dim als -&gt; Maybe (TypeBase dim als)
forall als dim.
(Monoid als, ArrayDim dim) =&gt;
(Uniqueness -&gt; Uniqueness -&gt; Maybe Uniqueness)
-&gt; TypeBase dim als -&gt; TypeBase dim als -&gt; Maybe (TypeBase dim als)
</span><a href="Language.Futhark.TypeChecker.Types.html#unifyTypesU"><span class="hs-identifier hs-var">unifyTypesU</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness -&gt; Uniqueness -&gt; Maybe Uniqueness
</span><a href="#local-6989586621684550104"><span class="hs-identifier hs-var">uf</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-84"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TypeBase dim als
 -&gt; TypeBase dim als -&gt; (TypeBase dim als, TypeBase dim als))
-&gt; Map Name (TypeBase dim als)
-&gt; Map Name (TypeBase dim als)
-&gt; Map Name (TypeBase dim als, TypeBase dim als)
forall k a b c.
Ord k =&gt;
(a -&gt; b -&gt; c) -&gt; Map k a -&gt; Map k b -&gt; Map k c
</span><span class="hs-identifier hs-var">M.intersectionWith</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map Name (TypeBase dim als)
</span><a href="#local-6989586621684550102"><span class="hs-identifier hs-var">ts1</span></a></span><span> </span><span class="annot"><span class="annottext">Map Name (TypeBase dim als)
</span><a href="#local-6989586621684550101"><span class="hs-identifier hs-var">ts2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-85"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#unifyScalarTypes"><span class="hs-identifier hs-var">unifyScalarTypes</span></a></span><span>
</span><span id="line-86"></span><span>  </span><span id="local-6989586621684550095"><span class="annot"><span class="annottext">Uniqueness -&gt; Uniqueness -&gt; Maybe Uniqueness
</span><a href="#local-6989586621684550095"><span class="hs-identifier hs-var">uf</span></a></span></span><span>
</span><span id="line-87"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Arrow"><span class="hs-identifier hs-type">Arrow</span></a></span><span> </span><span id="local-6989586621684550093"><span class="annot"><span class="annottext">als
</span><a href="#local-6989586621684550093"><span class="hs-identifier hs-var">as1</span></a></span></span><span> </span><span id="local-6989586621684550092"><span class="annot"><span class="annottext">PName
</span><a href="#local-6989586621684550092"><span class="hs-identifier hs-var">mn1</span></a></span></span><span> </span><span id="local-6989586621684550091"><span class="annot"><span class="annottext">TypeBase dim als
</span><a href="#local-6989586621684550091"><span class="hs-identifier hs-var">t1</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-type">RetType</span></a></span><span> </span><span id="local-6989586621684550089"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684550089"><span class="hs-identifier hs-var">dims1</span></a></span></span><span> </span><span id="local-6989586621684550088"><span class="annot"><span class="annottext">TypeBase dim als
</span><a href="#local-6989586621684550088"><span class="hs-identifier hs-var">t1'</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-88"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Arrow"><span class="hs-identifier hs-type">Arrow</span></a></span><span> </span><span id="local-6989586621684550087"><span class="annot"><span class="annottext">als
</span><a href="#local-6989586621684550087"><span class="hs-identifier hs-var">as2</span></a></span></span><span> </span><span class="annot"><span class="annottext">PName
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684550086"><span class="annot"><span class="annottext">TypeBase dim als
</span><a href="#local-6989586621684550086"><span class="hs-identifier hs-var">t2</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-type">RetType</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684550085"><span class="annot"><span class="annottext">TypeBase dim als
</span><a href="#local-6989586621684550085"><span class="hs-identifier hs-var">t2'</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-89"></span><span>    </span><span class="annot"><span class="annottext">als
-&gt; PName
-&gt; TypeBase dim als
-&gt; RetTypeBase dim als
-&gt; ScalarTypeBase dim als
forall dim as.
as
-&gt; PName
-&gt; TypeBase dim as
-&gt; RetTypeBase dim as
-&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Arrow"><span class="hs-identifier hs-var">Arrow</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">als
</span><a href="#local-6989586621684550093"><span class="hs-identifier hs-var">as1</span></a></span><span> </span><span class="annot"><span class="annottext">als -&gt; als -&gt; als
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">als
</span><a href="#local-6989586621684550087"><span class="hs-identifier hs-var">as2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PName
</span><a href="#local-6989586621684550092"><span class="hs-identifier hs-var">mn1</span></a></span><span> </span><span class="annot"><span class="annottext">(TypeBase dim als -&gt; RetTypeBase dim als -&gt; ScalarTypeBase dim als)
-&gt; Maybe (TypeBase dim als)
-&gt; Maybe (RetTypeBase dim als -&gt; ScalarTypeBase dim als)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Uniqueness -&gt; Uniqueness -&gt; Maybe Uniqueness)
-&gt; TypeBase dim als -&gt; TypeBase dim als -&gt; Maybe (TypeBase dim als)
forall als dim.
(Monoid als, ArrayDim dim) =&gt;
(Uniqueness -&gt; Uniqueness -&gt; Maybe Uniqueness)
-&gt; TypeBase dim als -&gt; TypeBase dim als -&gt; Maybe (TypeBase dim als)
</span><a href="Language.Futhark.TypeChecker.Types.html#unifyTypesU"><span class="hs-identifier hs-var">unifyTypesU</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Uniqueness -&gt; Uniqueness -&gt; Maybe Uniqueness)
-&gt; Uniqueness -&gt; Uniqueness -&gt; Maybe Uniqueness
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">Uniqueness -&gt; Uniqueness -&gt; Maybe Uniqueness
</span><a href="#local-6989586621684550095"><span class="hs-identifier hs-var">uf</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TypeBase dim als
</span><a href="#local-6989586621684550091"><span class="hs-identifier hs-var">t1</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase dim als
</span><a href="#local-6989586621684550086"><span class="hs-identifier hs-var">t2</span></a></span><span>
</span><span id="line-90"></span><span>      </span><span class="annot"><span class="annottext">Maybe (RetTypeBase dim als -&gt; ScalarTypeBase dim als)
-&gt; Maybe (RetTypeBase dim als) -&gt; Maybe (ScalarTypeBase dim als)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; TypeBase dim als -&gt; RetTypeBase dim als
forall dim as. [VName] -&gt; TypeBase dim as -&gt; RetTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-var">RetType</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684550089"><span class="hs-identifier hs-var">dims1</span></a></span><span> </span><span class="annot"><span class="annottext">(TypeBase dim als -&gt; RetTypeBase dim als)
-&gt; Maybe (TypeBase dim als) -&gt; Maybe (RetTypeBase dim als)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Uniqueness -&gt; Uniqueness -&gt; Maybe Uniqueness)
-&gt; TypeBase dim als -&gt; TypeBase dim als -&gt; Maybe (TypeBase dim als)
forall als dim.
(Monoid als, ArrayDim dim) =&gt;
(Uniqueness -&gt; Uniqueness -&gt; Maybe Uniqueness)
-&gt; TypeBase dim als -&gt; TypeBase dim als -&gt; Maybe (TypeBase dim als)
</span><a href="Language.Futhark.TypeChecker.Types.html#unifyTypesU"><span class="hs-identifier hs-var">unifyTypesU</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness -&gt; Uniqueness -&gt; Maybe Uniqueness
</span><a href="#local-6989586621684550095"><span class="hs-identifier hs-var">uf</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase dim als
</span><a href="#local-6989586621684550088"><span class="hs-identifier hs-var">t1'</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase dim als
</span><a href="#local-6989586621684550085"><span class="hs-identifier hs-var">t2'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-91"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#unifyScalarTypes"><span class="hs-identifier hs-var">unifyScalarTypes</span></a></span><span> </span><span id="local-6989586621684550083"><span class="annot"><span class="annottext">Uniqueness -&gt; Uniqueness -&gt; Maybe Uniqueness
</span><a href="#local-6989586621684550083"><span class="hs-identifier hs-var">uf</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Sum"><span class="hs-identifier hs-type">Sum</span></a></span><span> </span><span id="local-6989586621684550081"><span class="annot"><span class="annottext">Map Name [TypeBase dim als]
</span><a href="#local-6989586621684550081"><span class="hs-identifier hs-var">cs1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Sum"><span class="hs-identifier hs-type">Sum</span></a></span><span> </span><span id="local-6989586621684550080"><span class="annot"><span class="annottext">Map Name [TypeBase dim als]
</span><a href="#local-6989586621684550080"><span class="hs-identifier hs-var">cs2</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-92"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Map Name [TypeBase dim als] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">Map Name [TypeBase dim als]
</span><a href="#local-6989586621684550081"><span class="hs-identifier hs-var">cs1</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Map Name [TypeBase dim als] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">Map Name [TypeBase dim als]
</span><a href="#local-6989586621684550080"><span class="hs-identifier hs-var">cs2</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-93"></span><span>    </span><span class="annot"><span class="annottext">[Name] -&gt; [Name]
forall a. Ord a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">sort</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map Name [TypeBase dim als] -&gt; [Name]
forall k a. Map k a -&gt; [k]
</span><span class="hs-identifier hs-var">M.keys</span></span><span> </span><span class="annot"><span class="annottext">Map Name [TypeBase dim als]
</span><a href="#local-6989586621684550081"><span class="hs-identifier hs-var">cs1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Name] -&gt; [Name] -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">[Name] -&gt; [Name]
forall a. Ord a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">sort</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map Name [TypeBase dim als] -&gt; [Name]
forall k a. Map k a -&gt; [k]
</span><span class="hs-identifier hs-var">M.keys</span></span><span> </span><span class="annot"><span class="annottext">Map Name [TypeBase dim als]
</span><a href="#local-6989586621684550080"><span class="hs-identifier hs-var">cs2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-94"></span><span>    </span><span class="annot"><span class="annottext">Map Name [TypeBase dim als] -&gt; ScalarTypeBase dim als
forall dim as. Map Name [TypeBase dim as] -&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Sum"><span class="hs-identifier hs-var">Sum</span></a></span><span>
</span><span id="line-95"></span><span>      </span><span class="annot"><span class="annottext">(Map Name [TypeBase dim als] -&gt; ScalarTypeBase dim als)
-&gt; Maybe (Map Name [TypeBase dim als])
-&gt; Maybe (ScalarTypeBase dim als)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(([TypeBase dim als], [TypeBase dim als])
 -&gt; Maybe [TypeBase dim als])
-&gt; Map Name ([TypeBase dim als], [TypeBase dim als])
-&gt; Maybe (Map Name [TypeBase dim als])
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span>
</span><span id="line-96"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">([TypeBase dim als]
 -&gt; [TypeBase dim als] -&gt; Maybe [TypeBase dim als])
-&gt; ([TypeBase dim als], [TypeBase dim als])
-&gt; Maybe [TypeBase dim als]
forall a b c. (a -&gt; b -&gt; c) -&gt; (a, b) -&gt; c
</span><span class="hs-identifier hs-var">uncurry</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TypeBase dim als -&gt; TypeBase dim als -&gt; Maybe (TypeBase dim als))
-&gt; [TypeBase dim als]
-&gt; [TypeBase dim als]
-&gt; Maybe [TypeBase dim als]
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m [c]
</span><span class="hs-identifier hs-var">zipWithM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Uniqueness -&gt; Uniqueness -&gt; Maybe Uniqueness)
-&gt; TypeBase dim als -&gt; TypeBase dim als -&gt; Maybe (TypeBase dim als)
forall als dim.
(Monoid als, ArrayDim dim) =&gt;
(Uniqueness -&gt; Uniqueness -&gt; Maybe Uniqueness)
-&gt; TypeBase dim als -&gt; TypeBase dim als -&gt; Maybe (TypeBase dim als)
</span><a href="Language.Futhark.TypeChecker.Types.html#unifyTypesU"><span class="hs-identifier hs-var">unifyTypesU</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness -&gt; Uniqueness -&gt; Maybe Uniqueness
</span><a href="#local-6989586621684550083"><span class="hs-identifier hs-var">uf</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-97"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">([TypeBase dim als]
 -&gt; [TypeBase dim als] -&gt; ([TypeBase dim als], [TypeBase dim als]))
-&gt; Map Name [TypeBase dim als]
-&gt; Map Name [TypeBase dim als]
-&gt; Map Name ([TypeBase dim als], [TypeBase dim als])
forall k a b c.
Ord k =&gt;
(a -&gt; b -&gt; c) -&gt; Map k a -&gt; Map k b -&gt; Map k c
</span><span class="hs-identifier hs-var">M.intersectionWith</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map Name [TypeBase dim als]
</span><a href="#local-6989586621684550081"><span class="hs-identifier hs-var">cs1</span></a></span><span> </span><span class="annot"><span class="annottext">Map Name [TypeBase dim als]
</span><a href="#local-6989586621684550080"><span class="hs-identifier hs-var">cs2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-98"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#unifyScalarTypes"><span class="hs-identifier hs-var">unifyScalarTypes</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness -&gt; Uniqueness -&gt; Maybe Uniqueness
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ScalarTypeBase dim als
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ScalarTypeBase dim als
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (ScalarTypeBase dim als)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-99"></span><span>
</span><span id="line-100"></span><span class="hs-comment">-- | @x \`subtypeOf\` y@ is true if @x@ is a subtype of @y@ (or equal</span><span>
</span><span id="line-101"></span><span class="hs-comment">-- to @y@), meaning @x@ is valid whenever @y@ is.  Ignores sizes.</span><span>
</span><span id="line-102"></span><span class="hs-comment">-- Mostly used for checking uniqueness.</span><span>
</span><span id="line-103"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#subtypeOf"><span class="hs-identifier hs-type">subtypeOf</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeBase"><span class="hs-identifier hs-type">TypeBase</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeBase"><span class="hs-identifier hs-type">TypeBase</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-104"></span><span id="subtypeOf"><span class="annot"><span class="annottext">subtypeOf :: TypeBase () () -&gt; TypeBase () () -&gt; Bool
</span><a href="Language.Futhark.TypeChecker.Types.html#subtypeOf"><span class="hs-identifier hs-var hs-var">subtypeOf</span></a></span></span><span> </span><span id="local-6989586621684550079"><span class="annot"><span class="annottext">TypeBase () ()
</span><a href="#local-6989586621684550079"><span class="hs-identifier hs-var">t1</span></a></span></span><span> </span><span id="local-6989586621684550078"><span class="annot"><span class="annottext">TypeBase () ()
</span><a href="#local-6989586621684550078"><span class="hs-identifier hs-var">t2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (TypeBase () ()) -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (TypeBase () ()) -&gt; Bool) -&gt; Maybe (TypeBase () ()) -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Uniqueness -&gt; Uniqueness -&gt; Maybe Uniqueness)
-&gt; TypeBase () () -&gt; TypeBase () () -&gt; Maybe (TypeBase () ())
forall als dim.
(Monoid als, ArrayDim dim) =&gt;
(Uniqueness -&gt; Uniqueness -&gt; Maybe Uniqueness)
-&gt; TypeBase dim als -&gt; TypeBase dim als -&gt; Maybe (TypeBase dim als)
</span><a href="Language.Futhark.TypeChecker.Types.html#unifyTypesU"><span class="hs-identifier hs-var">unifyTypesU</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness -&gt; Uniqueness -&gt; Maybe Uniqueness
</span><a href="#local-6989586621684550076"><span class="hs-identifier hs-var">unifyUniqueness</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeBase () () -&gt; TypeBase () ()
forall dim as. TypeBase dim as -&gt; TypeBase dim ()
</span><a href="Language.Futhark.Prop.html#toStruct"><span class="hs-identifier hs-var">toStruct</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase () ()
</span><a href="#local-6989586621684550079"><span class="hs-identifier hs-var">t1</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeBase () () -&gt; TypeBase () ()
forall dim as. TypeBase dim as -&gt; TypeBase dim ()
</span><a href="Language.Futhark.Prop.html#toStruct"><span class="hs-identifier hs-var">toStruct</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase () ()
</span><a href="#local-6989586621684550078"><span class="hs-identifier hs-var">t2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-105"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-106"></span><span>    </span><span id="local-6989586621684550076"><span class="annot"><span class="annottext">unifyUniqueness :: Uniqueness -&gt; Uniqueness -&gt; Maybe Uniqueness
</span><a href="#local-6989586621684550076"><span class="hs-identifier hs-var hs-var">unifyUniqueness</span></a></span></span><span> </span><span id="local-6989586621684550074"><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684550074"><span class="hs-identifier hs-var">u2</span></a></span></span><span> </span><span id="local-6989586621684550073"><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684550073"><span class="hs-identifier hs-var">u1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684550074"><span class="hs-identifier hs-var">u2</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness -&gt; Uniqueness -&gt; Bool
</span><a href="Language.Futhark.TypeChecker.Types.html#subuniqueOf"><span class="hs-operator hs-var">`subuniqueOf`</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684550073"><span class="hs-identifier hs-var">u1</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Uniqueness -&gt; Maybe Uniqueness
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684550073"><span class="hs-identifier hs-var">u1</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Maybe Uniqueness
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-107"></span><span>
</span><span id="line-108"></span><span class="hs-comment">-- | @x `subuniqueOf` y@ is true if @x@ is not less unique than @y@.</span><span>
</span><span id="line-109"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#subuniqueOf"><span class="hs-identifier hs-type">subuniqueOf</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#Uniqueness"><span class="hs-identifier hs-type">Uniqueness</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#Uniqueness"><span class="hs-identifier hs-type">Uniqueness</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-110"></span><span id="subuniqueOf"><span class="annot"><span class="annottext">subuniqueOf :: Uniqueness -&gt; Uniqueness -&gt; Bool
</span><a href="Language.Futhark.TypeChecker.Types.html#subuniqueOf"><span class="hs-identifier hs-var hs-var">subuniqueOf</span></a></span></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="Language.Futhark.Core.html#Nonunique"><span class="hs-identifier hs-var">Nonunique</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="Language.Futhark.Core.html#Unique"><span class="hs-identifier hs-var">Unique</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-111"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#subuniqueOf"><span class="hs-identifier hs-var">subuniqueOf</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-112"></span><span>
</span><span id="line-113"></span><span class="hs-comment">-- | Ensure that the dimensions of the RetType are unique by</span><span>
</span><span id="line-114"></span><span class="hs-comment">-- generating new names for them.  This is to avoid name capture.</span><span>
</span><span id="line-115"></span><span id="local-6989586621684550519"><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#renameRetType"><span class="hs-identifier hs-type">renameRetType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Monad.html#MonadTypeChecker"><span class="hs-identifier hs-type">MonadTypeChecker</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684550519"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#StructRetType"><span class="hs-identifier hs-type">StructRetType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684550519"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#StructRetType"><span class="hs-identifier hs-type">StructRetType</span></a></span></span><span>
</span><span id="line-116"></span><span id="renameRetType"><span class="annot"><span class="annottext">renameRetType :: forall (m :: * -&gt; *).
MonadTypeChecker m =&gt;
StructRetType -&gt; m StructRetType
</span><a href="Language.Futhark.TypeChecker.Types.html#renameRetType"><span class="hs-identifier hs-var hs-var">renameRetType</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-type">RetType</span></a></span><span> </span><span id="local-6989586621684550053"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684550053"><span class="hs-identifier hs-var">dims</span></a></span></span><span> </span><span id="local-6989586621684550052"><span class="annot"><span class="annottext">TypeBase (DimDecl VName) ()
</span><a href="#local-6989586621684550052"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-117"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684550053"><span class="hs-identifier hs-var">dims</span></a></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">[VName]
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-118"></span><span>    </span><span id="local-6989586621684550050"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684550050"><span class="hs-identifier hs-var">dims'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; m VName) -&gt; [VName] -&gt; m [VName]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; m VName
forall (m :: * -&gt; *). MonadTypeChecker m =&gt; VName -&gt; m VName
</span><a href="Language.Futhark.TypeChecker.Monad.html#newName"><span class="hs-identifier hs-var">newName</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684550053"><span class="hs-identifier hs-var">dims</span></a></span><span>
</span><span id="line-119"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684550045"><span class="annot"><span class="annottext">m :: Map VName (Subst t)
</span><a href="#local-6989586621684550045"><span class="hs-identifier hs-var hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VName, Subst t)] -&gt; Map VName (Subst t)
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="annot"><span class="annottext">([(VName, Subst t)] -&gt; Map VName (Subst t))
-&gt; [(VName, Subst t)] -&gt; Map VName (Subst t)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [Subst t] -&gt; [(VName, Subst t)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684550053"><span class="hs-identifier hs-var">dims</span></a></span><span> </span><span class="annot"><span class="annottext">([Subst t] -&gt; [(VName, Subst t)])
-&gt; [Subst t] -&gt; [(VName, Subst t)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Subst t) -&gt; [VName] -&gt; [Subst t]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DimDecl VName -&gt; Subst t
forall t. DimDecl VName -&gt; Subst t
</span><a href="Language.Futhark.TypeChecker.Types.html#SizeSubst"><span class="hs-identifier hs-var">SizeSubst</span></a></span><span> </span><span class="annot"><span class="annottext">(DimDecl VName -&gt; Subst t)
-&gt; (VName -&gt; DimDecl VName) -&gt; VName -&gt; Subst t
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">QualName VName -&gt; DimDecl VName
forall vn. QualName vn -&gt; DimDecl vn
</span><a href="Language.Futhark.Syntax.html#NamedDim"><span class="hs-identifier hs-var">NamedDim</span></a></span><span> </span><span class="annot"><span class="annottext">(QualName VName -&gt; DimDecl VName)
-&gt; (VName -&gt; QualName VName) -&gt; VName -&gt; DimDecl VName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; QualName VName
forall v. v -&gt; QualName v
</span><a href="Language.Futhark.Prop.html#qualName"><span class="hs-identifier hs-var">qualName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684550050"><span class="hs-identifier hs-var">dims'</span></a></span><span>
</span><span id="line-120"></span><span>        </span><span id="local-6989586621684550036"><span class="annot"><span class="annottext">st' :: TypeBase (DimDecl VName) ()
</span><a href="#local-6989586621684550036"><span class="hs-identifier hs-var hs-var">st'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeSubs
-&gt; TypeBase (DimDecl VName) () -&gt; TypeBase (DimDecl VName) ()
forall a. Substitutable a =&gt; TypeSubs -&gt; a -&gt; a
</span><a href="Language.Futhark.TypeChecker.Types.html#applySubst"><span class="hs-identifier hs-var">applySubst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
-&gt; Map VName (Subst StructRetType) -&gt; Maybe (Subst StructRetType)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-operator hs-var">`M.lookup`</span></span><span> </span><span class="annot"><span class="annottext">Map VName (Subst StructRetType)
forall {t}. Map VName (Subst t)
</span><a href="#local-6989586621684550045"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) ()
</span><a href="#local-6989586621684550052"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-121"></span><span>    </span><span class="annot"><span class="annottext">StructRetType -&gt; m StructRetType
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(StructRetType -&gt; m StructRetType)
-&gt; StructRetType -&gt; m StructRetType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; TypeBase (DimDecl VName) () -&gt; StructRetType
forall dim as. [VName] -&gt; TypeBase dim as -&gt; RetTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-var">RetType</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684550050"><span class="hs-identifier hs-var">dims'</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) ()
</span><a href="#local-6989586621684550036"><span class="hs-identifier hs-var">st'</span></a></span><span>
</span><span id="line-122"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-123"></span><span>    </span><span class="annot"><span class="annottext">StructRetType -&gt; m StructRetType
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(StructRetType -&gt; m StructRetType)
-&gt; StructRetType -&gt; m StructRetType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; TypeBase (DimDecl VName) () -&gt; StructRetType
forall dim as. [VName] -&gt; TypeBase dim as -&gt; RetTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-var">RetType</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684550053"><span class="hs-identifier hs-var">dims</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) ()
</span><a href="#local-6989586621684550052"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-124"></span><span>
</span><span id="line-125"></span><span id="local-6989586621684550489"><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#evalTypeExp"><span class="hs-identifier hs-type">evalTypeExp</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-126"></span><span>  </span><span class="annot"><a href="Language.Futhark.TypeChecker.Monad.html#MonadTypeChecker"><span class="hs-identifier hs-type">MonadTypeChecker</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684550489"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-127"></span><span>  </span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeExp"><span class="hs-identifier hs-type">TypeExp</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-128"></span><span>  </span><span class="annot"><a href="#local-6989586621684550489"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeExp"><span class="hs-identifier hs-type">TypeExp</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#StructRetType"><span class="hs-identifier hs-type">StructRetType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#Liftedness"><span class="hs-identifier hs-type">Liftedness</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-129"></span><span id="evalTypeExp"><span class="annot"><span class="annottext">evalTypeExp :: forall (m :: * -&gt; *).
MonadTypeChecker m =&gt;
TypeExp Name
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
</span><a href="Language.Futhark.TypeChecker.Types.html#evalTypeExp"><span class="hs-identifier hs-var hs-var">evalTypeExp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TEVar"><span class="hs-identifier hs-type">TEVar</span></a></span><span> </span><span id="local-6989586621684549836"><span class="annot"><span class="annottext">QualName Name
</span><a href="#local-6989586621684549836"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621684549835"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549835"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-130"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684549834"><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684549834"><span class="hs-identifier hs-var">name'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684549833"><span class="annot"><span class="annottext">[TypeParam]
</span><a href="#local-6989586621684549833"><span class="hs-identifier hs-var">ps</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684549832"><span class="annot"><span class="annottext">StructRetType
</span><a href="#local-6989586621684549832"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684549831"><span class="annot"><span class="annottext">Liftedness
</span><a href="#local-6989586621684549831"><span class="hs-identifier hs-var">l</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SrcLoc
-&gt; QualName Name
-&gt; m (QualName VName, [TypeParam], StructRetType, Liftedness)
forall (m :: * -&gt; *).
MonadTypeChecker m =&gt;
SrcLoc
-&gt; QualName Name
-&gt; m (QualName VName, [TypeParam], StructRetType, Liftedness)
</span><a href="Language.Futhark.TypeChecker.Monad.html#lookupType"><span class="hs-identifier hs-var">lookupType</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549835"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">QualName Name
</span><a href="#local-6989586621684549836"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-131"></span><span>  </span><span id="local-6989586621684549829"><span class="annot"><span class="annottext">StructRetType
</span><a href="#local-6989586621684549829"><span class="hs-identifier hs-var">t'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StructRetType -&gt; m StructRetType
forall (m :: * -&gt; *).
MonadTypeChecker m =&gt;
StructRetType -&gt; m StructRetType
</span><a href="Language.Futhark.TypeChecker.Types.html#renameRetType"><span class="hs-identifier hs-var">renameRetType</span></a></span><span> </span><span class="annot"><span class="annottext">StructRetType
</span><a href="#local-6989586621684549832"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-132"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[TypeParam]
</span><a href="#local-6989586621684549833"><span class="hs-identifier hs-var">ps</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-133"></span><span>    </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(TypeExp VName, [VName], StructRetType, Liftedness)
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QualName VName -&gt; SrcLoc -&gt; TypeExp VName
forall vn. QualName vn -&gt; SrcLoc -&gt; TypeExp vn
</span><a href="Language.Futhark.Syntax.html#TEVar"><span class="hs-identifier hs-var">TEVar</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684549834"><span class="hs-identifier hs-var">name'</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549835"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StructRetType
</span><a href="#local-6989586621684549829"><span class="hs-identifier hs-var">t'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Liftedness
</span><a href="#local-6989586621684549831"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-134"></span><span>    </span><span class="annot"><span class="annottext">[TypeParam]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-135"></span><span>      </span><span class="annot"><span class="annottext">SrcLoc
-&gt; Notes
-&gt; Doc
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
forall (m :: * -&gt; *) loc a.
(MonadTypeChecker m, Located loc) =&gt;
loc -&gt; Notes -&gt; Doc -&gt; m a
</span><a href="Language.Futhark.TypeChecker.Monad.html#typeError"><span class="hs-identifier hs-var">typeError</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549835"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">Notes
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; m (TypeExp VName, [VName], StructRetType, Liftedness))
-&gt; Doc -&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-136"></span><span>        </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Type constructor&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><a href="Language.Futhark.Core.html#pquote"><span class="hs-identifier hs-var">pquote</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Doc] -&gt; Doc
</span><span class="hs-identifier hs-var">spread</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QualName Name -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">QualName Name
</span><a href="#local-6989586621684549836"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; [Doc] -&gt; [Doc]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">(TypeParam -&gt; Doc) -&gt; [TypeParam] -&gt; [Doc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TypeParam -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">[TypeParam]
</span><a href="#local-6989586621684549833"><span class="hs-identifier hs-var">ps</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-137"></span><span>          </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;used without any arguments.&quot;</span></span><span>
</span><span id="line-138"></span><span class="hs-comment">--</span><span>
</span><span id="line-139"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#evalTypeExp"><span class="hs-identifier hs-var">evalTypeExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TETuple"><span class="hs-identifier hs-type">TETuple</span></a></span><span> </span><span id="local-6989586621684549822"><span class="annot"><span class="annottext">[TypeExp Name]
</span><a href="#local-6989586621684549822"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span id="local-6989586621684549821"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549821"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-140"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684549820"><span class="annot"><span class="annottext">[TypeExp VName]
</span><a href="#local-6989586621684549820"><span class="hs-identifier hs-var">ts'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684549819"><span class="annot"><span class="annottext">[[VName]]
</span><a href="#local-6989586621684549819"><span class="hs-identifier hs-var">svars</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684549818"><span class="annot"><span class="annottext">[StructRetType]
</span><a href="#local-6989586621684549818"><span class="hs-identifier hs-var">ts_s</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684549817"><span class="annot"><span class="annottext">[Liftedness]
</span><a href="#local-6989586621684549817"><span class="hs-identifier hs-var">ls</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(TypeExp VName, [VName], StructRetType, Liftedness)]
-&gt; ([TypeExp VName], [[VName]], [StructRetType], [Liftedness])
forall a b c d. [(a, b, c, d)] -&gt; ([a], [b], [c], [d])
</span><span class="hs-identifier hs-var">unzip4</span></span><span> </span><span class="annot"><span class="annottext">([(TypeExp VName, [VName], StructRetType, Liftedness)]
 -&gt; ([TypeExp VName], [[VName]], [StructRetType], [Liftedness]))
-&gt; m [(TypeExp VName, [VName], StructRetType, Liftedness)]
-&gt; m ([TypeExp VName], [[VName]], [StructRetType], [Liftedness])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(TypeExp Name
 -&gt; m (TypeExp VName, [VName], StructRetType, Liftedness))
-&gt; [TypeExp Name]
-&gt; m [(TypeExp VName, [VName], StructRetType, Liftedness)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">TypeExp Name
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
forall (m :: * -&gt; *).
MonadTypeChecker m =&gt;
TypeExp Name
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
</span><a href="Language.Futhark.TypeChecker.Types.html#evalTypeExp"><span class="hs-identifier hs-var">evalTypeExp</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeExp Name]
</span><a href="#local-6989586621684549822"><span class="hs-identifier hs-var">ts</span></a></span><span>
</span><span id="line-141"></span><span>  </span><span class="annot"><span class="annottext">(TypeExp VName, [VName], StructRetType, Liftedness)
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span>
</span><span id="line-142"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">[TypeExp VName] -&gt; SrcLoc -&gt; TypeExp VName
forall vn. [TypeExp vn] -&gt; SrcLoc -&gt; TypeExp vn
</span><a href="Language.Futhark.Syntax.html#TETuple"><span class="hs-identifier hs-var">TETuple</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeExp VName]
</span><a href="#local-6989586621684549820"><span class="hs-identifier hs-var">ts'</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549821"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-143"></span><span>      </span><span class="annot"><span class="annottext">[[VName]] -&gt; [VName]
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">[[VName]]
</span><a href="#local-6989586621684549819"><span class="hs-identifier hs-var">svars</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-144"></span><span>      </span><span class="annot"><span class="annottext">[VName] -&gt; TypeBase (DimDecl VName) () -&gt; StructRetType
forall dim as. [VName] -&gt; TypeBase dim as -&gt; RetTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-var">RetType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(StructRetType -&gt; [VName]) -&gt; [StructRetType] -&gt; [VName]
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">StructRetType -&gt; [VName]
forall dim as. RetTypeBase dim as -&gt; [VName]
</span><a href="Language.Futhark.Syntax.html#retDims"><span class="hs-identifier hs-var hs-var">retDims</span></a></span><span> </span><span class="annot"><span class="annottext">[StructRetType]
</span><a href="#local-6989586621684549818"><span class="hs-identifier hs-var">ts_s</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TypeBase (DimDecl VName) () -&gt; StructRetType)
-&gt; TypeBase (DimDecl VName) () -&gt; StructRetType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ScalarTypeBase (DimDecl VName) () -&gt; TypeBase (DimDecl VName) ()
forall dim as. ScalarTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-var">Scalar</span></a></span><span> </span><span class="annot"><span class="annottext">(ScalarTypeBase (DimDecl VName) () -&gt; TypeBase (DimDecl VName) ())
-&gt; ScalarTypeBase (DimDecl VName) () -&gt; TypeBase (DimDecl VName) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TypeBase (DimDecl VName) ()] -&gt; ScalarTypeBase (DimDecl VName) ()
forall dim as. [TypeBase dim as] -&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Prop.html#tupleRecord"><span class="hs-identifier hs-var">tupleRecord</span></a></span><span> </span><span class="annot"><span class="annottext">([TypeBase (DimDecl VName) ()]
 -&gt; ScalarTypeBase (DimDecl VName) ())
-&gt; [TypeBase (DimDecl VName) ()]
-&gt; ScalarTypeBase (DimDecl VName) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(StructRetType -&gt; TypeBase (DimDecl VName) ())
-&gt; [StructRetType] -&gt; [TypeBase (DimDecl VName) ()]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">StructRetType -&gt; TypeBase (DimDecl VName) ()
forall dim as. RetTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#retType"><span class="hs-identifier hs-var hs-var">retType</span></a></span><span> </span><span class="annot"><span class="annottext">[StructRetType]
</span><a href="#local-6989586621684549818"><span class="hs-identifier hs-var">ts_s</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-145"></span><span>      </span><span class="annot"><span class="annottext">(Liftedness -&gt; Liftedness -&gt; Liftedness)
-&gt; Liftedness -&gt; [Liftedness] -&gt; Liftedness
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span> </span><span class="annot"><span class="annottext">Liftedness -&gt; Liftedness -&gt; Liftedness
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">max</span></span><span> </span><span class="annot"><span class="annottext">Liftedness
</span><a href="Language.Futhark.Syntax.html#Unlifted"><span class="hs-identifier hs-var">Unlifted</span></a></span><span> </span><span class="annot"><span class="annottext">[Liftedness]
</span><a href="#local-6989586621684549817"><span class="hs-identifier hs-var">ls</span></a></span><span>
</span><span id="line-146"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-147"></span><span class="hs-comment">--</span><span>
</span><span id="line-148"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#evalTypeExp"><span class="hs-identifier hs-var">evalTypeExp</span></a></span><span> </span><span id="local-6989586621684549810"><span class="annot"><span class="annottext">t :: TypeExp Name
</span><a href="#local-6989586621684549810"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TERecord"><span class="hs-identifier hs-type">TERecord</span></a></span><span> </span><span id="local-6989586621684549808"><span class="annot"><span class="annottext">[(Name, TypeExp Name)]
</span><a href="#local-6989586621684549808"><span class="hs-identifier hs-var">fs</span></a></span></span><span> </span><span id="local-6989586621684549807"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549807"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-149"></span><span>  </span><span class="hs-comment">-- Check for duplicate field names.</span><span>
</span><span id="line-150"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684549806"><span class="annot"><span class="annottext">field_names :: [Name]
</span><a href="#local-6989586621684549806"><span class="hs-identifier hs-var hs-var">field_names</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Name, TypeExp Name) -&gt; Name) -&gt; [(Name, TypeExp Name)] -&gt; [Name]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Name, TypeExp Name) -&gt; Name
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(Name, TypeExp Name)]
</span><a href="#local-6989586621684549808"><span class="hs-identifier hs-var">fs</span></a></span><span>
</span><span id="line-151"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Name] -&gt; [Name]
forall a. Ord a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">sort</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621684549806"><span class="hs-identifier hs-var">field_names</span></a></span><span> </span><span class="annot"><span class="annottext">[Name] -&gt; [Name] -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">[Name] -&gt; [Name]
forall a. Ord a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">sort</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Name] -&gt; [Name]
forall a. Ord a =&gt; [a] -&gt; [a]
</span><a href="Futhark.Util.html#nubOrd"><span class="hs-identifier hs-var">nubOrd</span></a></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621684549806"><span class="hs-identifier hs-var">field_names</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-152"></span><span>    </span><span class="annot"><span class="annottext">SrcLoc -&gt; Notes -&gt; Doc -&gt; m ()
forall (m :: * -&gt; *) loc a.
(MonadTypeChecker m, Located loc) =&gt;
loc -&gt; Notes -&gt; Doc -&gt; m a
</span><a href="Language.Futhark.TypeChecker.Monad.html#typeError"><span class="hs-identifier hs-var">typeError</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549807"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">Notes
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; m ()) -&gt; Doc -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Duplicate record fields in&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">TypeExp Name -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">TypeExp Name
</span><a href="#local-6989586621684549810"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;.&quot;</span></span><span>
</span><span id="line-153"></span><span>
</span><span id="line-154"></span><span>  </span><span id="local-6989586621684549804"><span class="annot"><span class="annottext">Map Name (TypeExp VName, [VName], StructRetType, Liftedness)
</span><a href="#local-6989586621684549804"><span class="hs-identifier hs-var">checked</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TypeExp Name
 -&gt; m (TypeExp VName, [VName], StructRetType, Liftedness))
-&gt; Map Name (TypeExp Name)
-&gt; m (Map Name (TypeExp VName, [VName], StructRetType, Liftedness))
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="annot"><span class="annottext">TypeExp Name
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
forall (m :: * -&gt; *).
MonadTypeChecker m =&gt;
TypeExp Name
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
</span><a href="Language.Futhark.TypeChecker.Types.html#evalTypeExp"><span class="hs-identifier hs-var">evalTypeExp</span></a></span><span> </span><span class="annot"><span class="annottext">(Map Name (TypeExp Name)
 -&gt; m (Map
         Name (TypeExp VName, [VName], StructRetType, Liftedness)))
-&gt; Map Name (TypeExp Name)
-&gt; m (Map Name (TypeExp VName, [VName], StructRetType, Liftedness))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(Name, TypeExp Name)] -&gt; Map Name (TypeExp Name)
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="annot"><span class="annottext">[(Name, TypeExp Name)]
</span><a href="#local-6989586621684549808"><span class="hs-identifier hs-var">fs</span></a></span><span>
</span><span id="line-155"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684549801"><span class="annot"><span class="annottext">fs' :: Map Name (TypeExp VName)
</span><a href="#local-6989586621684549801"><span class="hs-identifier hs-var hs-var">fs'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((TypeExp VName, [VName], StructRetType, Liftedness)
 -&gt; TypeExp VName)
-&gt; Map Name (TypeExp VName, [VName], StructRetType, Liftedness)
-&gt; Map Name (TypeExp VName)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684549800"><span class="annot"><span class="annottext">TypeExp VName
</span><a href="#local-6989586621684549800"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StructRetType
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Liftedness
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TypeExp VName
</span><a href="#local-6989586621684549800"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map Name (TypeExp VName, [VName], StructRetType, Liftedness)
</span><a href="#local-6989586621684549804"><span class="hs-identifier hs-var">checked</span></a></span><span>
</span><span id="line-156"></span><span>      </span><span id="local-6989586621684549797"><span class="annot"><span class="annottext">fs_svars :: [VName]
</span><a href="#local-6989586621684549797"><span class="hs-identifier hs-var hs-var">fs_svars</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((TypeExp VName, [VName], StructRetType, Liftedness) -&gt; [VName])
-&gt; Map Name (TypeExp VName, [VName], StructRetType, Liftedness)
-&gt; [VName]
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeExp VName
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684549796"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549796"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StructRetType
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Liftedness
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549796"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map Name (TypeExp VName, [VName], StructRetType, Liftedness)
</span><a href="#local-6989586621684549804"><span class="hs-identifier hs-var">checked</span></a></span><span>
</span><span id="line-157"></span><span>      </span><span id="local-6989586621684549794"><span class="annot"><span class="annottext">ts_s :: Map Name StructRetType
</span><a href="#local-6989586621684549794"><span class="hs-identifier hs-var hs-var">ts_s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((TypeExp VName, [VName], StructRetType, Liftedness)
 -&gt; StructRetType)
-&gt; Map Name (TypeExp VName, [VName], StructRetType, Liftedness)
-&gt; Map Name StructRetType
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeExp VName
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684549793"><span class="annot"><span class="annottext">StructRetType
</span><a href="#local-6989586621684549793"><span class="hs-identifier hs-var">z</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Liftedness
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">StructRetType
</span><a href="#local-6989586621684549793"><span class="hs-identifier hs-var">z</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map Name (TypeExp VName, [VName], StructRetType, Liftedness)
</span><a href="#local-6989586621684549804"><span class="hs-identifier hs-var">checked</span></a></span><span>
</span><span id="line-158"></span><span>      </span><span id="local-6989586621684549791"><span class="annot"><span class="annottext">ls :: Map Name Liftedness
</span><a href="#local-6989586621684549791"><span class="hs-identifier hs-var hs-var">ls</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((TypeExp VName, [VName], StructRetType, Liftedness) -&gt; Liftedness)
-&gt; Map Name (TypeExp VName, [VName], StructRetType, Liftedness)
-&gt; Map Name Liftedness
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeExp VName
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StructRetType
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684549790"><span class="annot"><span class="annottext">Liftedness
</span><a href="#local-6989586621684549790"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Liftedness
</span><a href="#local-6989586621684549790"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map Name (TypeExp VName, [VName], StructRetType, Liftedness)
</span><a href="#local-6989586621684549804"><span class="hs-identifier hs-var">checked</span></a></span><span>
</span><span id="line-159"></span><span>  </span><span class="annot"><span class="annottext">(TypeExp VName, [VName], StructRetType, Liftedness)
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span>
</span><span id="line-160"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">[(Name, TypeExp VName)] -&gt; SrcLoc -&gt; TypeExp VName
forall vn. [(Name, TypeExp vn)] -&gt; SrcLoc -&gt; TypeExp vn
</span><a href="Language.Futhark.Syntax.html#TERecord"><span class="hs-identifier hs-var">TERecord</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map Name (TypeExp VName) -&gt; [(Name, TypeExp VName)]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">M.toList</span></span><span> </span><span class="annot"><span class="annottext">Map Name (TypeExp VName)
</span><a href="#local-6989586621684549801"><span class="hs-identifier hs-var">fs'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549807"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-161"></span><span>      </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549797"><span class="hs-identifier hs-var">fs_svars</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-162"></span><span>      </span><span class="annot"><span class="annottext">[VName] -&gt; TypeBase (DimDecl VName) () -&gt; StructRetType
forall dim as. [VName] -&gt; TypeBase dim as -&gt; RetTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-var">RetType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(StructRetType -&gt; [VName]) -&gt; Map Name StructRetType -&gt; [VName]
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">StructRetType -&gt; [VName]
forall dim as. RetTypeBase dim as -&gt; [VName]
</span><a href="Language.Futhark.Syntax.html#retDims"><span class="hs-identifier hs-var hs-var">retDims</span></a></span><span> </span><span class="annot"><span class="annottext">Map Name StructRetType
</span><a href="#local-6989586621684549794"><span class="hs-identifier hs-var">ts_s</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TypeBase (DimDecl VName) () -&gt; StructRetType)
-&gt; TypeBase (DimDecl VName) () -&gt; StructRetType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ScalarTypeBase (DimDecl VName) () -&gt; TypeBase (DimDecl VName) ()
forall dim as. ScalarTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-var">Scalar</span></a></span><span> </span><span class="annot"><span class="annottext">(ScalarTypeBase (DimDecl VName) () -&gt; TypeBase (DimDecl VName) ())
-&gt; ScalarTypeBase (DimDecl VName) () -&gt; TypeBase (DimDecl VName) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Map Name (TypeBase (DimDecl VName) ())
-&gt; ScalarTypeBase (DimDecl VName) ()
forall dim as. Map Name (TypeBase dim as) -&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Record"><span class="hs-identifier hs-var">Record</span></a></span><span> </span><span class="annot"><span class="annottext">(Map Name (TypeBase (DimDecl VName) ())
 -&gt; ScalarTypeBase (DimDecl VName) ())
-&gt; Map Name (TypeBase (DimDecl VName) ())
-&gt; ScalarTypeBase (DimDecl VName) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(StructRetType -&gt; TypeBase (DimDecl VName) ())
-&gt; Map Name StructRetType -&gt; Map Name (TypeBase (DimDecl VName) ())
forall a b k. (a -&gt; b) -&gt; Map k a -&gt; Map k b
</span><span class="hs-identifier hs-var">M.map</span></span><span> </span><span class="annot"><span class="annottext">StructRetType -&gt; TypeBase (DimDecl VName) ()
forall dim as. RetTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#retType"><span class="hs-identifier hs-var hs-var">retType</span></a></span><span> </span><span class="annot"><span class="annottext">Map Name StructRetType
</span><a href="#local-6989586621684549794"><span class="hs-identifier hs-var">ts_s</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-163"></span><span>      </span><span class="annot"><span class="annottext">(Liftedness -&gt; Liftedness -&gt; Liftedness)
-&gt; Liftedness -&gt; Map Name Liftedness -&gt; Liftedness
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span> </span><span class="annot"><span class="annottext">Liftedness -&gt; Liftedness -&gt; Liftedness
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">max</span></span><span> </span><span class="annot"><span class="annottext">Liftedness
</span><a href="Language.Futhark.Syntax.html#Unlifted"><span class="hs-identifier hs-var">Unlifted</span></a></span><span> </span><span class="annot"><span class="annottext">Map Name Liftedness
</span><a href="#local-6989586621684549791"><span class="hs-identifier hs-var">ls</span></a></span><span>
</span><span id="line-164"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-165"></span><span class="hs-comment">--</span><span>
</span><span id="line-166"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#evalTypeExp"><span class="hs-identifier hs-var">evalTypeExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TEArray"><span class="hs-identifier hs-type">TEArray</span></a></span><span> </span><span id="local-6989586621684549786"><span class="annot"><span class="annottext">TypeExp Name
</span><a href="#local-6989586621684549786"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621684549785"><span class="annot"><span class="annottext">DimExp Name
</span><a href="#local-6989586621684549785"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span id="local-6989586621684549784"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549784"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-167"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684549783"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549783"><span class="hs-identifier hs-var">d_svars</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684549782"><span class="annot"><span class="annottext">DimExp VName
</span><a href="#local-6989586621684549782"><span class="hs-identifier hs-var">d'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684549781"><span class="annot"><span class="annottext">DimDecl VName
</span><a href="#local-6989586621684549781"><span class="hs-identifier hs-var">d''</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DimExp Name -&gt; m ([VName], DimExp VName, DimDecl VName)
forall {m :: * -&gt; *}.
MonadTypeChecker m =&gt;
DimExp Name -&gt; m ([VName], DimExp VName, DimDecl VName)
</span><a href="#local-6989586621684549780"><span class="hs-identifier hs-var">checkDimExp</span></a></span><span> </span><span class="annot"><span class="annottext">DimExp Name
</span><a href="#local-6989586621684549785"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-168"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684549779"><span class="annot"><span class="annottext">TypeExp VName
</span><a href="#local-6989586621684549779"><span class="hs-identifier hs-var">t'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684549778"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549778"><span class="hs-identifier hs-var">svars</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-type">RetType</span></a></span><span> </span><span id="local-6989586621684549777"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549777"><span class="hs-identifier hs-var">dims</span></a></span></span><span> </span><span id="local-6989586621684549776"><span class="annot"><span class="annottext">TypeBase (DimDecl VName) ()
</span><a href="#local-6989586621684549776"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684549775"><span class="annot"><span class="annottext">Liftedness
</span><a href="#local-6989586621684549775"><span class="hs-identifier hs-var">l</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TypeExp Name
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
forall (m :: * -&gt; *).
MonadTypeChecker m =&gt;
TypeExp Name
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
</span><a href="Language.Futhark.TypeChecker.Types.html#evalTypeExp"><span class="hs-identifier hs-var">evalTypeExp</span></a></span><span> </span><span class="annot"><span class="annottext">TypeExp Name
</span><a href="#local-6989586621684549786"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-169"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Liftedness
</span><a href="#local-6989586621684549775"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) ()
-&gt; ShapeDecl (DimDecl VName)
-&gt; Uniqueness
-&gt; TypeBase (DimDecl VName) ()
forall as dim.
Monoid as =&gt;
TypeBase dim as -&gt; ShapeDecl dim -&gt; Uniqueness -&gt; TypeBase dim as
</span><a href="Language.Futhark.Prop.html#arrayOf"><span class="hs-identifier hs-var">arrayOf</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) ()
</span><a href="#local-6989586621684549776"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DimDecl VName] -&gt; ShapeDecl (DimDecl VName)
forall dim. [dim] -&gt; ShapeDecl dim
</span><a href="Language.Futhark.Syntax.html#ShapeDecl"><span class="hs-identifier hs-var">ShapeDecl</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">DimDecl VName
</span><a href="#local-6989586621684549781"><span class="hs-identifier hs-var">d''</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="Language.Futhark.Core.html#Nonunique"><span class="hs-identifier hs-var">Nonunique</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-170"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Liftedness
</span><a href="Language.Futhark.Syntax.html#Unlifted"><span class="hs-identifier hs-var">Unlifted</span></a></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684549772"><span class="annot"><span class="annottext">TypeBase (DimDecl VName) ()
</span><a href="#local-6989586621684549772"><span class="hs-identifier hs-var">st'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-171"></span><span>      </span><span class="annot"><span class="annottext">(TypeExp VName, [VName], StructRetType, Liftedness)
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span>
</span><span id="line-172"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">TypeExp VName -&gt; DimExp VName -&gt; SrcLoc -&gt; TypeExp VName
forall vn. TypeExp vn -&gt; DimExp vn -&gt; SrcLoc -&gt; TypeExp vn
</span><a href="Language.Futhark.Syntax.html#TEArray"><span class="hs-identifier hs-var">TEArray</span></a></span><span> </span><span class="annot"><span class="annottext">TypeExp VName
</span><a href="#local-6989586621684549779"><span class="hs-identifier hs-var">t'</span></a></span><span> </span><span class="annot"><span class="annottext">DimExp VName
</span><a href="#local-6989586621684549782"><span class="hs-identifier hs-var">d'</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549784"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-173"></span><span>          </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549778"><span class="hs-identifier hs-var">svars</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-174"></span><span>          </span><span class="annot"><span class="annottext">[VName] -&gt; TypeBase (DimDecl VName) () -&gt; StructRetType
forall dim as. [VName] -&gt; TypeBase dim as -&gt; RetTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-var">RetType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549783"><span class="hs-identifier hs-var">d_svars</span></a></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549777"><span class="hs-identifier hs-var">dims</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) ()
</span><a href="#local-6989586621684549772"><span class="hs-identifier hs-var">st'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-175"></span><span>          </span><span class="annot"><span class="annottext">Liftedness
</span><a href="Language.Futhark.Syntax.html#Unlifted"><span class="hs-identifier hs-var">Unlifted</span></a></span><span>
</span><span id="line-176"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-177"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Liftedness
</span><a href="Language.Futhark.Syntax.html#SizeLifted"><span class="hs-identifier hs-var">SizeLifted</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) ()
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-178"></span><span>      </span><span class="annot"><span class="annottext">SrcLoc
-&gt; Notes
-&gt; Doc
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
forall (m :: * -&gt; *) loc a.
(MonadTypeChecker m, Located loc) =&gt;
loc -&gt; Notes -&gt; Doc -&gt; m a
</span><a href="Language.Futhark.TypeChecker.Monad.html#typeError"><span class="hs-identifier hs-var">typeError</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549784"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">Notes
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; m (TypeExp VName, [VName], StructRetType, Liftedness))
-&gt; Doc -&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-179"></span><span>        </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Cannot create array with elements of size-lifted type&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><a href="Language.Futhark.Core.html#pquote"><span class="hs-identifier hs-var">pquote</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeExp Name -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">TypeExp Name
</span><a href="#local-6989586621684549786"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-180"></span><span>          </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;(might cause irregular array).&quot;</span></span><span>
</span><span id="line-181"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Liftedness
</span><a href="Language.Futhark.Syntax.html#Lifted"><span class="hs-identifier hs-var">Lifted</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) ()
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-182"></span><span>      </span><span class="annot"><span class="annottext">SrcLoc
-&gt; Notes
-&gt; Doc
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
forall (m :: * -&gt; *) loc a.
(MonadTypeChecker m, Located loc) =&gt;
loc -&gt; Notes -&gt; Doc -&gt; m a
</span><a href="Language.Futhark.TypeChecker.Monad.html#typeError"><span class="hs-identifier hs-var">typeError</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549784"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">Notes
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; m (TypeExp VName, [VName], StructRetType, Liftedness))
-&gt; Doc -&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-183"></span><span>        </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Cannot create array with elements of lifted type&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><a href="Language.Futhark.Core.html#pquote"><span class="hs-identifier hs-var">pquote</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeExp Name -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">TypeExp Name
</span><a href="#local-6989586621684549786"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-184"></span><span>          </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+/&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;(might contain function).&quot;</span></span><span>
</span><span id="line-185"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-186"></span><span>    </span><span id="local-6989586621684549780"><span class="annot"><span class="annottext">checkDimExp :: DimExp Name -&gt; m ([VName], DimExp VName, DimDecl VName)
</span><a href="#local-6989586621684549780"><span class="hs-identifier hs-var hs-var">checkDimExp</span></a></span></span><span> </span><span class="annot"><span class="annottext">DimExp Name
</span><a href="Language.Futhark.Syntax.html#DimExpAny"><span class="hs-identifier hs-var">DimExpAny</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-187"></span><span>      </span><span id="local-6989586621684549755"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684549755"><span class="hs-identifier hs-var">dv</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; m VName
forall (m :: * -&gt; *). MonadTypeChecker m =&gt; Name -&gt; m VName
</span><a href="Language.Futhark.TypeChecker.Monad.html#newTypeName"><span class="hs-identifier hs-var">newTypeName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-string">&quot;d&quot;</span></span><span>
</span><span id="line-188"></span><span>      </span><span class="annot"><span class="annottext">([VName], DimExp VName, DimDecl VName)
-&gt; m ([VName], DimExp VName, DimDecl VName)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684549755"><span class="hs-identifier hs-var">dv</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DimExp VName
forall vn. DimExp vn
</span><a href="Language.Futhark.Syntax.html#DimExpAny"><span class="hs-identifier hs-var">DimExpAny</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">QualName VName -&gt; DimDecl VName
forall vn. QualName vn -&gt; DimDecl vn
</span><a href="Language.Futhark.Syntax.html#NamedDim"><span class="hs-identifier hs-var">NamedDim</span></a></span><span> </span><span class="annot"><span class="annottext">(QualName VName -&gt; DimDecl VName)
-&gt; QualName VName -&gt; DimDecl VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; QualName VName
forall v. v -&gt; QualName v
</span><a href="Language.Futhark.Prop.html#qualName"><span class="hs-identifier hs-var">qualName</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684549755"><span class="hs-identifier hs-var">dv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-189"></span><span>    </span><span class="annot"><a href="#local-6989586621684549780"><span class="hs-identifier hs-var">checkDimExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#DimExpConst"><span class="hs-identifier hs-type">DimExpConst</span></a></span><span> </span><span id="local-6989586621684549752"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684549752"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span id="local-6989586621684549751"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549751"><span class="hs-identifier hs-var">dloc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-190"></span><span>      </span><span class="annot"><span class="annottext">([VName], DimExp VName, DimDecl VName)
-&gt; m ([VName], DimExp VName, DimDecl VName)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; SrcLoc -&gt; DimExp VName
forall vn. Int -&gt; SrcLoc -&gt; DimExp vn
</span><a href="Language.Futhark.Syntax.html#DimExpConst"><span class="hs-identifier hs-var">DimExpConst</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684549752"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549751"><span class="hs-identifier hs-var">dloc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; DimDecl VName
forall vn. Int -&gt; DimDecl vn
</span><a href="Language.Futhark.Syntax.html#ConstDim"><span class="hs-identifier hs-var">ConstDim</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684549752"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-191"></span><span>    </span><span class="annot"><a href="#local-6989586621684549780"><span class="hs-identifier hs-var">checkDimExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#DimExpNamed"><span class="hs-identifier hs-type">DimExpNamed</span></a></span><span> </span><span id="local-6989586621684549748"><span class="annot"><span class="annottext">QualName Name
</span><a href="#local-6989586621684549748"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621684549747"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549747"><span class="hs-identifier hs-var">dloc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-192"></span><span>      </span><span id="local-6989586621684549746"><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684549746"><span class="hs-identifier hs-var">v'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SrcLoc -&gt; QualName Name -&gt; m (QualName VName)
forall (m :: * -&gt; *).
MonadTypeChecker m =&gt;
SrcLoc -&gt; QualName Name -&gt; m (QualName VName)
</span><a href="Language.Futhark.TypeChecker.Monad.html#checkNamedDim"><span class="hs-identifier hs-var">checkNamedDim</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549784"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">QualName Name
</span><a href="#local-6989586621684549748"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-193"></span><span>      </span><span class="annot"><span class="annottext">([VName], DimExp VName, DimDecl VName)
-&gt; m ([VName], DimExp VName, DimDecl VName)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">QualName VName -&gt; SrcLoc -&gt; DimExp VName
forall vn. QualName vn -&gt; SrcLoc -&gt; DimExp vn
</span><a href="Language.Futhark.Syntax.html#DimExpNamed"><span class="hs-identifier hs-var">DimExpNamed</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684549746"><span class="hs-identifier hs-var">v'</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549747"><span class="hs-identifier hs-var">dloc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">QualName VName -&gt; DimDecl VName
forall vn. QualName vn -&gt; DimDecl vn
</span><a href="Language.Futhark.Syntax.html#NamedDim"><span class="hs-identifier hs-var">NamedDim</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684549746"><span class="hs-identifier hs-var">v'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-194"></span><span class="hs-comment">--</span><span>
</span><span id="line-195"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#evalTypeExp"><span class="hs-identifier hs-var">evalTypeExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TEUnique"><span class="hs-identifier hs-type">TEUnique</span></a></span><span> </span><span id="local-6989586621684549743"><span class="annot"><span class="annottext">TypeExp Name
</span><a href="#local-6989586621684549743"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621684549742"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549742"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-196"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684549741"><span class="annot"><span class="annottext">TypeExp VName
</span><a href="#local-6989586621684549741"><span class="hs-identifier hs-var">t'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684549740"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549740"><span class="hs-identifier hs-var">svars</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-type">RetType</span></a></span><span> </span><span id="local-6989586621684549739"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549739"><span class="hs-identifier hs-var">dims</span></a></span></span><span> </span><span id="local-6989586621684549738"><span class="annot"><span class="annottext">TypeBase (DimDecl VName) ()
</span><a href="#local-6989586621684549738"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684549737"><span class="annot"><span class="annottext">Liftedness
</span><a href="#local-6989586621684549737"><span class="hs-identifier hs-var">l</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TypeExp Name
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
forall (m :: * -&gt; *).
MonadTypeChecker m =&gt;
TypeExp Name
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
</span><a href="Language.Futhark.TypeChecker.Types.html#evalTypeExp"><span class="hs-identifier hs-var">evalTypeExp</span></a></span><span> </span><span class="annot"><span class="annottext">TypeExp Name
</span><a href="#local-6989586621684549743"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-197"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) () -&gt; Bool
forall {dim} {as}. TypeBase dim as -&gt; Bool
</span><a href="#local-6989586621684549736"><span class="hs-identifier hs-var">mayContainArray</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) ()
</span><a href="#local-6989586621684549738"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-198"></span><span>    </span><span class="annot"><span class="annottext">SrcLoc -&gt; Doc -&gt; m ()
forall (m :: * -&gt; *) loc.
(MonadTypeChecker m, Located loc) =&gt;
loc -&gt; Doc -&gt; m ()
</span><a href="Language.Futhark.TypeChecker.Monad.html#warn"><span class="hs-identifier hs-var">warn</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549742"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; m ()) -&gt; Doc -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Declaring&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><a href="Language.Futhark.Core.html#pquote"><span class="hs-identifier hs-var">pquote</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) () -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) ()
</span><a href="#local-6989586621684549738"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;as unique has no effect.&quot;</span></span><span>
</span><span id="line-199"></span><span>  </span><span class="annot"><span class="annottext">(TypeExp VName, [VName], StructRetType, Liftedness)
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeExp VName -&gt; SrcLoc -&gt; TypeExp VName
forall vn. TypeExp vn -&gt; SrcLoc -&gt; TypeExp vn
</span><a href="Language.Futhark.Syntax.html#TEUnique"><span class="hs-identifier hs-var">TEUnique</span></a></span><span> </span><span class="annot"><span class="annottext">TypeExp VName
</span><a href="#local-6989586621684549741"><span class="hs-identifier hs-var">t'</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549742"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549740"><span class="hs-identifier hs-var">svars</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; TypeBase (DimDecl VName) () -&gt; StructRetType
forall dim as. [VName] -&gt; TypeBase dim as -&gt; RetTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-var">RetType</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549739"><span class="hs-identifier hs-var">dims</span></a></span><span> </span><span class="annot"><span class="annottext">(TypeBase (DimDecl VName) () -&gt; StructRetType)
-&gt; TypeBase (DimDecl VName) () -&gt; StructRetType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) ()
</span><a href="#local-6989586621684549738"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) ()
-&gt; Uniqueness -&gt; TypeBase (DimDecl VName) ()
forall dim as. TypeBase dim as -&gt; Uniqueness -&gt; TypeBase dim as
</span><a href="Language.Futhark.Prop.html#setUniqueness"><span class="hs-operator hs-var">`setUniqueness`</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="Language.Futhark.Core.html#Unique"><span class="hs-identifier hs-var">Unique</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Liftedness
</span><a href="#local-6989586621684549737"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-200"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-201"></span><span>    </span><span id="local-6989586621684549736"><span class="annot"><span class="annottext">mayContainArray :: TypeBase dim as -&gt; Bool
</span><a href="#local-6989586621684549736"><span class="hs-identifier hs-var hs-var">mayContainArray</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#Prim"><span class="hs-identifier hs-type">Prim</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-202"></span><span>    </span><span class="annot"><a href="#local-6989586621684549736"><span class="hs-identifier hs-var">mayContainArray</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-203"></span><span>    </span><span class="annot"><a href="#local-6989586621684549736"><span class="hs-identifier hs-var">mayContainArray</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Record"><span class="hs-identifier hs-type">Record</span></a></span><span> </span><span id="local-6989586621684549730"><span class="annot"><span class="annottext">Map Name (TypeBase dim as)
</span><a href="#local-6989586621684549730"><span class="hs-identifier hs-var">fs</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TypeBase dim as -&gt; Bool) -&gt; Map Name (TypeBase dim as) -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="annot"><span class="annottext">TypeBase dim as -&gt; Bool
</span><a href="#local-6989586621684549736"><span class="hs-identifier hs-var">mayContainArray</span></a></span><span> </span><span class="annot"><span class="annottext">Map Name (TypeBase dim as)
</span><a href="#local-6989586621684549730"><span class="hs-identifier hs-var">fs</span></a></span><span>
</span><span id="line-204"></span><span>    </span><span class="annot"><a href="#local-6989586621684549736"><span class="hs-identifier hs-var">mayContainArray</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeVar"><span class="hs-identifier hs-type">TypeVar</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-205"></span><span>    </span><span class="annot"><a href="#local-6989586621684549736"><span class="hs-identifier hs-var">mayContainArray</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#Arrow"><span class="hs-identifier hs-type">Arrow</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-206"></span><span>    </span><span class="annot"><a href="#local-6989586621684549736"><span class="hs-identifier hs-var">mayContainArray</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Sum"><span class="hs-identifier hs-type">Sum</span></a></span><span> </span><span id="local-6989586621684549728"><span class="annot"><span class="annottext">Map Name [TypeBase dim as]
</span><a href="#local-6989586621684549728"><span class="hs-identifier hs-var">cs</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">([TypeBase dim as] -&gt; Bool) -&gt; Map Name [TypeBase dim as] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="annot"><span class="annottext">(([TypeBase dim as] -&gt; Bool) -&gt; Map Name [TypeBase dim as] -&gt; Bool)
-&gt; ((TypeBase dim as -&gt; Bool) -&gt; [TypeBase dim as] -&gt; Bool)
-&gt; (TypeBase dim as -&gt; Bool)
-&gt; Map Name [TypeBase dim as]
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(TypeBase dim as -&gt; Bool) -&gt; [TypeBase dim as] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TypeBase dim as -&gt; Bool
</span><a href="#local-6989586621684549736"><span class="hs-identifier hs-var">mayContainArray</span></a></span><span> </span><span class="annot"><span class="annottext">Map Name [TypeBase dim as]
</span><a href="#local-6989586621684549728"><span class="hs-identifier hs-var">cs</span></a></span><span>
</span><span id="line-207"></span><span class="hs-comment">--</span><span>
</span><span id="line-208"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#evalTypeExp"><span class="hs-identifier hs-var">evalTypeExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TEArrow"><span class="hs-identifier hs-type">TEArrow</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684549726"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684549726"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684549725"><span class="annot"><span class="annottext">TypeExp Name
</span><a href="#local-6989586621684549725"><span class="hs-identifier hs-var">t1</span></a></span></span><span> </span><span id="local-6989586621684549724"><span class="annot"><span class="annottext">TypeExp Name
</span><a href="#local-6989586621684549724"><span class="hs-identifier hs-var">t2</span></a></span></span><span> </span><span id="local-6989586621684549723"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549723"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-209"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684549722"><span class="annot"><span class="annottext">TypeExp VName
</span><a href="#local-6989586621684549722"><span class="hs-identifier hs-var">t1'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684549721"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549721"><span class="hs-identifier hs-var">svars1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-type">RetType</span></a></span><span> </span><span id="local-6989586621684549720"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549720"><span class="hs-identifier hs-var">dims1</span></a></span></span><span> </span><span id="local-6989586621684549719"><span class="annot"><span class="annottext">TypeBase (DimDecl VName) ()
</span><a href="#local-6989586621684549719"><span class="hs-identifier hs-var">st1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Liftedness
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TypeExp Name
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
forall (m :: * -&gt; *).
MonadTypeChecker m =&gt;
TypeExp Name
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
</span><a href="Language.Futhark.TypeChecker.Types.html#evalTypeExp"><span class="hs-identifier hs-var">evalTypeExp</span></a></span><span> </span><span class="annot"><span class="annottext">TypeExp Name
</span><a href="#local-6989586621684549725"><span class="hs-identifier hs-var">t1</span></a></span><span>
</span><span id="line-210"></span><span>  </span><span class="annot"><span class="annottext">[(Namespace, Name)]
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
forall (m :: * -&gt; *) a.
MonadTypeChecker m =&gt;
[(Namespace, Name)] -&gt; m a -&gt; m a
</span><a href="Language.Futhark.TypeChecker.Monad.html#bindSpaced"><span class="hs-identifier hs-var">bindSpaced</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Namespace
</span><a href="Language.Futhark.Semantic.html#Term"><span class="hs-identifier hs-var">Term</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684549726"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(m (TypeExp VName, [VName], StructRetType, Liftedness)
 -&gt; m (TypeExp VName, [VName], StructRetType, Liftedness))
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-211"></span><span>    </span><span id="local-6989586621684549716"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684549716"><span class="hs-identifier hs-var">v'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Namespace -&gt; Name -&gt; SrcLoc -&gt; m VName
forall (m :: * -&gt; *).
MonadTypeChecker m =&gt;
Namespace -&gt; Name -&gt; SrcLoc -&gt; m VName
</span><a href="Language.Futhark.TypeChecker.Monad.html#checkName"><span class="hs-identifier hs-var">checkName</span></a></span><span> </span><span class="annot"><span class="annottext">Namespace
</span><a href="Language.Futhark.Semantic.html#Term"><span class="hs-identifier hs-var">Term</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684549726"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549723"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-212"></span><span>    </span><span class="annot"><span class="annottext">VName
-&gt; BoundV
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
forall (m :: * -&gt; *) a.
MonadTypeChecker m =&gt;
VName -&gt; BoundV -&gt; m a -&gt; m a
</span><a href="Language.Futhark.TypeChecker.Monad.html#bindVal"><span class="hs-identifier hs-var">bindVal</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684549716"><span class="hs-identifier hs-var">v'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TypeParam] -&gt; TypeBase (DimDecl VName) () -&gt; BoundV
</span><a href="Language.Futhark.Semantic.html#BoundV"><span class="hs-identifier hs-var">BoundV</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) ()
</span><a href="#local-6989586621684549719"><span class="hs-identifier hs-var">st1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m (TypeExp VName, [VName], StructRetType, Liftedness)
 -&gt; m (TypeExp VName, [VName], StructRetType, Liftedness))
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-213"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684549712"><span class="annot"><span class="annottext">TypeExp VName
</span><a href="#local-6989586621684549712"><span class="hs-identifier hs-var">t2'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684549711"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549711"><span class="hs-identifier hs-var">svars2</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-type">RetType</span></a></span><span> </span><span id="local-6989586621684549710"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549710"><span class="hs-identifier hs-var">dims2</span></a></span></span><span> </span><span id="local-6989586621684549709"><span class="annot"><span class="annottext">TypeBase (DimDecl VName) ()
</span><a href="#local-6989586621684549709"><span class="hs-identifier hs-var">st2</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Liftedness
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TypeExp Name
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
forall (m :: * -&gt; *).
MonadTypeChecker m =&gt;
TypeExp Name
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
</span><a href="Language.Futhark.TypeChecker.Types.html#evalTypeExp"><span class="hs-identifier hs-var">evalTypeExp</span></a></span><span> </span><span class="annot"><span class="annottext">TypeExp Name
</span><a href="#local-6989586621684549724"><span class="hs-identifier hs-var">t2</span></a></span><span>
</span><span id="line-214"></span><span>      </span><span class="annot"><span class="annottext">(TypeExp VName, [VName], StructRetType, Liftedness)
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span>
</span><span id="line-215"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Maybe VName
-&gt; TypeExp VName -&gt; TypeExp VName -&gt; SrcLoc -&gt; TypeExp VName
forall vn.
Maybe vn -&gt; TypeExp vn -&gt; TypeExp vn -&gt; SrcLoc -&gt; TypeExp vn
</span><a href="Language.Futhark.Syntax.html#TEArrow"><span class="hs-identifier hs-var">TEArrow</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Maybe VName
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684549716"><span class="hs-identifier hs-var">v'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TypeExp VName
</span><a href="#local-6989586621684549722"><span class="hs-identifier hs-var">t1'</span></a></span><span> </span><span class="annot"><span class="annottext">TypeExp VName
</span><a href="#local-6989586621684549712"><span class="hs-identifier hs-var">t2'</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549723"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-216"></span><span>          </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549721"><span class="hs-identifier hs-var">svars1</span></a></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549720"><span class="hs-identifier hs-var">dims1</span></a></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549711"><span class="hs-identifier hs-var">svars2</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-217"></span><span>          </span><span class="annot"><span class="annottext">[VName] -&gt; TypeBase (DimDecl VName) () -&gt; StructRetType
forall dim as. [VName] -&gt; TypeBase dim as -&gt; RetTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-var">RetType</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(TypeBase (DimDecl VName) () -&gt; StructRetType)
-&gt; TypeBase (DimDecl VName) () -&gt; StructRetType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ScalarTypeBase (DimDecl VName) () -&gt; TypeBase (DimDecl VName) ()
forall dim as. ScalarTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-var">Scalar</span></a></span><span> </span><span class="annot"><span class="annottext">(ScalarTypeBase (DimDecl VName) () -&gt; TypeBase (DimDecl VName) ())
-&gt; ScalarTypeBase (DimDecl VName) () -&gt; TypeBase (DimDecl VName) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">()
-&gt; PName
-&gt; TypeBase (DimDecl VName) ()
-&gt; StructRetType
-&gt; ScalarTypeBase (DimDecl VName) ()
forall dim as.
as
-&gt; PName
-&gt; TypeBase dim as
-&gt; RetTypeBase dim as
-&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Arrow"><span class="hs-identifier hs-var">Arrow</span></a></span><span> </span><span class="annot"><span class="annottext">()
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; PName
</span><a href="Language.Futhark.Syntax.html#Named"><span class="hs-identifier hs-var">Named</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684549716"><span class="hs-identifier hs-var">v'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) ()
</span><a href="#local-6989586621684549719"><span class="hs-identifier hs-var">st1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; TypeBase (DimDecl VName) () -&gt; StructRetType
forall dim as. [VName] -&gt; TypeBase dim as -&gt; RetTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-var">RetType</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549710"><span class="hs-identifier hs-var">dims2</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) ()
</span><a href="#local-6989586621684549709"><span class="hs-identifier hs-var">st2</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-218"></span><span>          </span><span class="annot"><span class="annottext">Liftedness
</span><a href="Language.Futhark.Syntax.html#Lifted"><span class="hs-identifier hs-var">Lifted</span></a></span><span>
</span><span id="line-219"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-220"></span><span class="hs-comment">--</span><span>
</span><span id="line-221"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#evalTypeExp"><span class="hs-identifier hs-var">evalTypeExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TEArrow"><span class="hs-identifier hs-type">TEArrow</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Name
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span id="local-6989586621684549707"><span class="annot"><span class="annottext">TypeExp Name
</span><a href="#local-6989586621684549707"><span class="hs-identifier hs-var">t1</span></a></span></span><span> </span><span id="local-6989586621684549706"><span class="annot"><span class="annottext">TypeExp Name
</span><a href="#local-6989586621684549706"><span class="hs-identifier hs-var">t2</span></a></span></span><span> </span><span id="local-6989586621684549705"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549705"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-222"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684549704"><span class="annot"><span class="annottext">TypeExp VName
</span><a href="#local-6989586621684549704"><span class="hs-identifier hs-var">t1'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684549703"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549703"><span class="hs-identifier hs-var">svars1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-type">RetType</span></a></span><span> </span><span id="local-6989586621684549702"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549702"><span class="hs-identifier hs-var">dims1</span></a></span></span><span> </span><span id="local-6989586621684549701"><span class="annot"><span class="annottext">TypeBase (DimDecl VName) ()
</span><a href="#local-6989586621684549701"><span class="hs-identifier hs-var">st1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Liftedness
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TypeExp Name
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
forall (m :: * -&gt; *).
MonadTypeChecker m =&gt;
TypeExp Name
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
</span><a href="Language.Futhark.TypeChecker.Types.html#evalTypeExp"><span class="hs-identifier hs-var">evalTypeExp</span></a></span><span> </span><span class="annot"><span class="annottext">TypeExp Name
</span><a href="#local-6989586621684549707"><span class="hs-identifier hs-var">t1</span></a></span><span>
</span><span id="line-223"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684549700"><span class="annot"><span class="annottext">TypeExp VName
</span><a href="#local-6989586621684549700"><span class="hs-identifier hs-var">t2'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684549699"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549699"><span class="hs-identifier hs-var">svars2</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-type">RetType</span></a></span><span> </span><span id="local-6989586621684549698"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549698"><span class="hs-identifier hs-var">dims2</span></a></span></span><span> </span><span id="local-6989586621684549697"><span class="annot"><span class="annottext">TypeBase (DimDecl VName) ()
</span><a href="#local-6989586621684549697"><span class="hs-identifier hs-var">st2</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Liftedness
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TypeExp Name
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
forall (m :: * -&gt; *).
MonadTypeChecker m =&gt;
TypeExp Name
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
</span><a href="Language.Futhark.TypeChecker.Types.html#evalTypeExp"><span class="hs-identifier hs-var">evalTypeExp</span></a></span><span> </span><span class="annot"><span class="annottext">TypeExp Name
</span><a href="#local-6989586621684549706"><span class="hs-identifier hs-var">t2</span></a></span><span>
</span><span id="line-224"></span><span>  </span><span class="annot"><span class="annottext">(TypeExp VName, [VName], StructRetType, Liftedness)
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span>
</span><span id="line-225"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Maybe VName
-&gt; TypeExp VName -&gt; TypeExp VName -&gt; SrcLoc -&gt; TypeExp VName
forall vn.
Maybe vn -&gt; TypeExp vn -&gt; TypeExp vn -&gt; SrcLoc -&gt; TypeExp vn
</span><a href="Language.Futhark.Syntax.html#TEArrow"><span class="hs-identifier hs-var">TEArrow</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe VName
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">TypeExp VName
</span><a href="#local-6989586621684549704"><span class="hs-identifier hs-var">t1'</span></a></span><span> </span><span class="annot"><span class="annottext">TypeExp VName
</span><a href="#local-6989586621684549700"><span class="hs-identifier hs-var">t2'</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549705"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-226"></span><span>      </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549703"><span class="hs-identifier hs-var">svars1</span></a></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549702"><span class="hs-identifier hs-var">dims1</span></a></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549699"><span class="hs-identifier hs-var">svars2</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-227"></span><span>      </span><span class="annot"><span class="annottext">[VName] -&gt; TypeBase (DimDecl VName) () -&gt; StructRetType
forall dim as. [VName] -&gt; TypeBase dim as -&gt; RetTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-var">RetType</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(TypeBase (DimDecl VName) () -&gt; StructRetType)
-&gt; TypeBase (DimDecl VName) () -&gt; StructRetType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ScalarTypeBase (DimDecl VName) () -&gt; TypeBase (DimDecl VName) ()
forall dim as. ScalarTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-var">Scalar</span></a></span><span> </span><span class="annot"><span class="annottext">(ScalarTypeBase (DimDecl VName) () -&gt; TypeBase (DimDecl VName) ())
-&gt; ScalarTypeBase (DimDecl VName) () -&gt; TypeBase (DimDecl VName) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">()
-&gt; PName
-&gt; TypeBase (DimDecl VName) ()
-&gt; StructRetType
-&gt; ScalarTypeBase (DimDecl VName) ()
forall dim as.
as
-&gt; PName
-&gt; TypeBase dim as
-&gt; RetTypeBase dim as
-&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Arrow"><span class="hs-identifier hs-var">Arrow</span></a></span><span> </span><span class="annot"><span class="annottext">()
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">PName
</span><a href="Language.Futhark.Syntax.html#Unnamed"><span class="hs-identifier hs-var">Unnamed</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) ()
</span><a href="#local-6989586621684549701"><span class="hs-identifier hs-var">st1</span></a></span><span> </span><span class="annot"><span class="annottext">(StructRetType -&gt; ScalarTypeBase (DimDecl VName) ())
-&gt; StructRetType -&gt; ScalarTypeBase (DimDecl VName) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; TypeBase (DimDecl VName) () -&gt; StructRetType
forall dim as. [VName] -&gt; TypeBase dim as -&gt; RetTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-var">RetType</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549698"><span class="hs-identifier hs-var">dims2</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) ()
</span><a href="#local-6989586621684549697"><span class="hs-identifier hs-var">st2</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-228"></span><span>      </span><span class="annot"><span class="annottext">Liftedness
</span><a href="Language.Futhark.Syntax.html#Lifted"><span class="hs-identifier hs-var">Lifted</span></a></span><span>
</span><span id="line-229"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-230"></span><span class="hs-comment">--</span><span>
</span><span id="line-231"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#evalTypeExp"><span class="hs-identifier hs-var">evalTypeExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TEDim"><span class="hs-identifier hs-type">TEDim</span></a></span><span> </span><span id="local-6989586621684549694"><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621684549694"><span class="hs-identifier hs-var">dims</span></a></span></span><span> </span><span id="local-6989586621684549693"><span class="annot"><span class="annottext">TypeExp Name
</span><a href="#local-6989586621684549693"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621684549692"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549692"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-232"></span><span>  </span><span class="annot"><span class="annottext">[(Namespace, Name)]
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
forall (m :: * -&gt; *) a.
MonadTypeChecker m =&gt;
[(Namespace, Name)] -&gt; m a -&gt; m a
</span><a href="Language.Futhark.TypeChecker.Monad.html#bindSpaced"><span class="hs-identifier hs-var">bindSpaced</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Name -&gt; (Namespace, Name)) -&gt; [Name] -&gt; [(Namespace, Name)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Namespace
</span><a href="Language.Futhark.Semantic.html#Term"><span class="hs-identifier hs-var">Term</span></a></span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621684549694"><span class="hs-identifier hs-var">dims</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m (TypeExp VName, [VName], StructRetType, Liftedness)
 -&gt; m (TypeExp VName, [VName], StructRetType, Liftedness))
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-233"></span><span>    </span><span id="local-6989586621684549691"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549691"><span class="hs-identifier hs-var">dims'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; m VName) -&gt; [Name] -&gt; m [VName]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Name -&gt; SrcLoc -&gt; m VName) -&gt; SrcLoc -&gt; Name -&gt; m VName
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Namespace -&gt; Name -&gt; SrcLoc -&gt; m VName
forall (m :: * -&gt; *).
MonadTypeChecker m =&gt;
Namespace -&gt; Name -&gt; SrcLoc -&gt; m VName
</span><a href="Language.Futhark.TypeChecker.Monad.html#checkName"><span class="hs-identifier hs-var">checkName</span></a></span><span> </span><span class="annot"><span class="annottext">Namespace
</span><a href="Language.Futhark.Semantic.html#Term"><span class="hs-identifier hs-var">Term</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549692"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621684549694"><span class="hs-identifier hs-var">dims</span></a></span><span>
</span><span id="line-234"></span><span>    </span><span class="annot"><span class="annottext">[VName]
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
forall {m :: * -&gt; *} {a}.
MonadTypeChecker m =&gt;
[VName] -&gt; m a -&gt; m a
</span><a href="#local-6989586621684549690"><span class="hs-identifier hs-var">bindDims</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549691"><span class="hs-identifier hs-var">dims'</span></a></span><span> </span><span class="annot"><span class="annottext">(m (TypeExp VName, [VName], StructRetType, Liftedness)
 -&gt; m (TypeExp VName, [VName], StructRetType, Liftedness))
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-235"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684549689"><span class="annot"><span class="annottext">TypeExp VName
</span><a href="#local-6989586621684549689"><span class="hs-identifier hs-var">t'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684549688"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549688"><span class="hs-identifier hs-var">svars</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-type">RetType</span></a></span><span> </span><span id="local-6989586621684549687"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549687"><span class="hs-identifier hs-var">t_dims</span></a></span></span><span> </span><span id="local-6989586621684549686"><span class="annot"><span class="annottext">TypeBase (DimDecl VName) ()
</span><a href="#local-6989586621684549686"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684549685"><span class="annot"><span class="annottext">Liftedness
</span><a href="#local-6989586621684549685"><span class="hs-identifier hs-var">l</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TypeExp Name
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
forall (m :: * -&gt; *).
MonadTypeChecker m =&gt;
TypeExp Name
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
</span><a href="Language.Futhark.TypeChecker.Types.html#evalTypeExp"><span class="hs-identifier hs-var">evalTypeExp</span></a></span><span> </span><span class="annot"><span class="annottext">TypeExp Name
</span><a href="#local-6989586621684549693"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-236"></span><span>      </span><span class="annot"><span class="annottext">(TypeExp VName, [VName], StructRetType, Liftedness)
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-237"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; TypeExp VName -&gt; SrcLoc -&gt; TypeExp VName
forall vn. [vn] -&gt; TypeExp vn -&gt; SrcLoc -&gt; TypeExp vn
</span><a href="Language.Futhark.Syntax.html#TEDim"><span class="hs-identifier hs-var">TEDim</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549691"><span class="hs-identifier hs-var">dims'</span></a></span><span> </span><span class="annot"><span class="annottext">TypeExp VName
</span><a href="#local-6989586621684549689"><span class="hs-identifier hs-var">t'</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549692"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-238"></span><span>          </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549688"><span class="hs-identifier hs-var">svars</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-239"></span><span>          </span><span class="annot"><span class="annottext">[VName] -&gt; TypeBase (DimDecl VName) () -&gt; StructRetType
forall dim as. [VName] -&gt; TypeBase dim as -&gt; RetTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-var">RetType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549691"><span class="hs-identifier hs-var">dims'</span></a></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549687"><span class="hs-identifier hs-var">t_dims</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) ()
</span><a href="#local-6989586621684549686"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-240"></span><span>          </span><span class="annot"><span class="annottext">Liftedness -&gt; Liftedness -&gt; Liftedness
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">max</span></span><span> </span><span class="annot"><span class="annottext">Liftedness
</span><a href="#local-6989586621684549685"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">Liftedness
</span><a href="Language.Futhark.Syntax.html#SizeLifted"><span class="hs-identifier hs-var">SizeLifted</span></a></span><span>
</span><span id="line-241"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-242"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-243"></span><span>    </span><span id="local-6989586621684549690"><span class="annot"><span class="annottext">bindDims :: [VName] -&gt; m a -&gt; m a
</span><a href="#local-6989586621684549690"><span class="hs-identifier hs-var hs-var">bindDims</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span id="local-6989586621684549682"><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621684549682"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621684549682"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-244"></span><span>    </span><span class="annot"><a href="#local-6989586621684549690"><span class="hs-identifier hs-var">bindDims</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684549681"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684549681"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684549680"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549680"><span class="hs-identifier hs-var">ds</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684549679"><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621684549679"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-245"></span><span>      </span><span class="annot"><span class="annottext">VName -&gt; BoundV -&gt; m a -&gt; m a
forall (m :: * -&gt; *) a.
MonadTypeChecker m =&gt;
VName -&gt; BoundV -&gt; m a -&gt; m a
</span><a href="Language.Futhark.TypeChecker.Monad.html#bindVal"><span class="hs-identifier hs-var">bindVal</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684549681"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TypeParam] -&gt; TypeBase (DimDecl VName) () -&gt; BoundV
</span><a href="Language.Futhark.Semantic.html#BoundV"><span class="hs-identifier hs-var">BoundV</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(TypeBase (DimDecl VName) () -&gt; BoundV)
-&gt; TypeBase (DimDecl VName) () -&gt; BoundV
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ScalarTypeBase (DimDecl VName) () -&gt; TypeBase (DimDecl VName) ()
forall dim as. ScalarTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-var">Scalar</span></a></span><span> </span><span class="annot"><span class="annottext">(ScalarTypeBase (DimDecl VName) () -&gt; TypeBase (DimDecl VName) ())
-&gt; ScalarTypeBase (DimDecl VName) () -&gt; TypeBase (DimDecl VName) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; ScalarTypeBase (DimDecl VName) ()
forall dim as. PrimType -&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimType -&gt; ScalarTypeBase (DimDecl VName) ())
-&gt; PrimType -&gt; ScalarTypeBase (DimDecl VName) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IntType -&gt; PrimType
</span><a href="Language.Futhark.Syntax.html#Signed"><span class="hs-identifier hs-var">Signed</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m a -&gt; m a) -&gt; m a -&gt; m a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; m a -&gt; m a
</span><a href="#local-6989586621684549690"><span class="hs-identifier hs-var">bindDims</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549680"><span class="hs-identifier hs-var">ds</span></a></span><span> </span><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621684549679"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-246"></span><span class="hs-comment">--</span><span>
</span><span id="line-247"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#evalTypeExp"><span class="hs-identifier hs-var">evalTypeExp</span></a></span><span> </span><span id="local-6989586621684549676"><span class="annot"><span class="annottext">t :: TypeExp Name
</span><a href="#local-6989586621684549676"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TESum"><span class="hs-identifier hs-type">TESum</span></a></span><span> </span><span id="local-6989586621684549674"><span class="annot"><span class="annottext">[(Name, [TypeExp Name])]
</span><a href="#local-6989586621684549674"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span id="local-6989586621684549673"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549673"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-248"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684549672"><span class="annot"><span class="annottext">constructors :: [Name]
</span><a href="#local-6989586621684549672"><span class="hs-identifier hs-var hs-var">constructors</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Name, [TypeExp Name]) -&gt; Name)
-&gt; [(Name, [TypeExp Name])] -&gt; [Name]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Name, [TypeExp Name]) -&gt; Name
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(Name, [TypeExp Name])]
</span><a href="#local-6989586621684549674"><span class="hs-identifier hs-var">cs</span></a></span><span>
</span><span id="line-249"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Name] -&gt; [Name]
forall a. Ord a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">sort</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621684549672"><span class="hs-identifier hs-var">constructors</span></a></span><span> </span><span class="annot"><span class="annottext">[Name] -&gt; [Name] -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">[Name] -&gt; [Name]
forall a. Ord a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">sort</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Name] -&gt; [Name]
forall a. Ord a =&gt; [a] -&gt; [a]
</span><a href="Futhark.Util.html#nubOrd"><span class="hs-identifier hs-var">nubOrd</span></a></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621684549672"><span class="hs-identifier hs-var">constructors</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-250"></span><span>    </span><span class="annot"><span class="annottext">SrcLoc -&gt; Notes -&gt; Doc -&gt; m ()
forall (m :: * -&gt; *) loc a.
(MonadTypeChecker m, Located loc) =&gt;
loc -&gt; Notes -&gt; Doc -&gt; m a
</span><a href="Language.Futhark.TypeChecker.Monad.html#typeError"><span class="hs-identifier hs-var">typeError</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549673"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">Notes
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; m ()) -&gt; Doc -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Duplicate constructors in&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">TypeExp Name -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">TypeExp Name
</span><a href="#local-6989586621684549676"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-251"></span><span>
</span><span id="line-252"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Name] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621684549672"><span class="hs-identifier hs-var">constructors</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">256</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-253"></span><span>    </span><span class="annot"><span class="annottext">SrcLoc -&gt; Notes -&gt; Doc -&gt; m ()
forall (m :: * -&gt; *) loc a.
(MonadTypeChecker m, Located loc) =&gt;
loc -&gt; Notes -&gt; Doc -&gt; m a
</span><a href="Language.Futhark.TypeChecker.Monad.html#typeError"><span class="hs-identifier hs-var">typeError</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549673"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">Notes
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Sum types must have less than 256 constructors.&quot;</span></span><span>
</span><span id="line-254"></span><span>
</span><span id="line-255"></span><span>  </span><span id="local-6989586621684549670"><span class="annot"><span class="annottext">Map Name [(TypeExp VName, [VName], StructRetType, Liftedness)]
</span><a href="#local-6989586621684549670"><span class="hs-identifier hs-var">checked</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">([TypeExp Name]
 -&gt; m [(TypeExp VName, [VName], StructRetType, Liftedness)])
-&gt; Map Name [TypeExp Name]
-&gt; m (Map
        Name [(TypeExp VName, [VName], StructRetType, Liftedness)])
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="annot"><span class="annottext">(([TypeExp Name]
  -&gt; m [(TypeExp VName, [VName], StructRetType, Liftedness)])
 -&gt; Map Name [TypeExp Name]
 -&gt; m (Map
         Name [(TypeExp VName, [VName], StructRetType, Liftedness)]))
-&gt; ((TypeExp Name
     -&gt; m (TypeExp VName, [VName], StructRetType, Liftedness))
    -&gt; [TypeExp Name]
    -&gt; m [(TypeExp VName, [VName], StructRetType, Liftedness)])
-&gt; (TypeExp Name
    -&gt; m (TypeExp VName, [VName], StructRetType, Liftedness))
-&gt; Map Name [TypeExp Name]
-&gt; m (Map
        Name [(TypeExp VName, [VName], StructRetType, Liftedness)])
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(TypeExp Name
 -&gt; m (TypeExp VName, [VName], StructRetType, Liftedness))
-&gt; [TypeExp Name]
-&gt; m [(TypeExp VName, [VName], StructRetType, Liftedness)]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TypeExp Name
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
forall (m :: * -&gt; *).
MonadTypeChecker m =&gt;
TypeExp Name
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
</span><a href="Language.Futhark.TypeChecker.Types.html#evalTypeExp"><span class="hs-identifier hs-var">evalTypeExp</span></a></span><span> </span><span class="annot"><span class="annottext">(Map Name [TypeExp Name]
 -&gt; m (Map
         Name [(TypeExp VName, [VName], StructRetType, Liftedness)]))
-&gt; Map Name [TypeExp Name]
-&gt; m (Map
        Name [(TypeExp VName, [VName], StructRetType, Liftedness)])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(Name, [TypeExp Name])] -&gt; Map Name [TypeExp Name]
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="annot"><span class="annottext">[(Name, [TypeExp Name])]
</span><a href="#local-6989586621684549674"><span class="hs-identifier hs-var">cs</span></a></span><span>
</span><span id="line-256"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684549666"><span class="annot"><span class="annottext">cs' :: Map Name [TypeExp VName]
</span><a href="#local-6989586621684549666"><span class="hs-identifier hs-var hs-var">cs'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">([(TypeExp VName, [VName], StructRetType, Liftedness)]
 -&gt; [TypeExp VName])
-&gt; Map Name [(TypeExp VName, [VName], StructRetType, Liftedness)]
-&gt; Map Name [TypeExp VName]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">(([(TypeExp VName, [VName], StructRetType, Liftedness)]
  -&gt; [TypeExp VName])
 -&gt; Map Name [(TypeExp VName, [VName], StructRetType, Liftedness)]
 -&gt; Map Name [TypeExp VName])
-&gt; (((TypeExp VName, [VName], StructRetType, Liftedness)
     -&gt; TypeExp VName)
    -&gt; [(TypeExp VName, [VName], StructRetType, Liftedness)]
    -&gt; [TypeExp VName])
-&gt; ((TypeExp VName, [VName], StructRetType, Liftedness)
    -&gt; TypeExp VName)
-&gt; Map Name [(TypeExp VName, [VName], StructRetType, Liftedness)]
-&gt; Map Name [TypeExp VName]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">((TypeExp VName, [VName], StructRetType, Liftedness)
 -&gt; TypeExp VName)
-&gt; [(TypeExp VName, [VName], StructRetType, Liftedness)]
-&gt; [TypeExp VName]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684549665"><span class="annot"><span class="annottext">TypeExp VName
</span><a href="#local-6989586621684549665"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StructRetType
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Liftedness
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TypeExp VName
</span><a href="#local-6989586621684549665"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map Name [(TypeExp VName, [VName], StructRetType, Liftedness)]
</span><a href="#local-6989586621684549670"><span class="hs-identifier hs-var">checked</span></a></span><span>
</span><span id="line-257"></span><span>      </span><span id="local-6989586621684549660"><span class="annot"><span class="annottext">cs_svars :: [VName]
</span><a href="#local-6989586621684549660"><span class="hs-identifier hs-var hs-var">cs_svars</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">([(TypeExp VName, [VName], StructRetType, Liftedness)] -&gt; [VName])
-&gt; Map Name [(TypeExp VName, [VName], StructRetType, Liftedness)]
-&gt; [VName]
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">(([(TypeExp VName, [VName], StructRetType, Liftedness)] -&gt; [VName])
 -&gt; Map Name [(TypeExp VName, [VName], StructRetType, Liftedness)]
 -&gt; [VName])
-&gt; (((TypeExp VName, [VName], StructRetType, Liftedness)
     -&gt; [VName])
    -&gt; [(TypeExp VName, [VName], StructRetType, Liftedness)]
    -&gt; [VName])
-&gt; ((TypeExp VName, [VName], StructRetType, Liftedness) -&gt; [VName])
-&gt; Map Name [(TypeExp VName, [VName], StructRetType, Liftedness)]
-&gt; [VName]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">((TypeExp VName, [VName], StructRetType, Liftedness) -&gt; [VName])
-&gt; [(TypeExp VName, [VName], StructRetType, Liftedness)] -&gt; [VName]
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeExp VName
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684549659"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549659"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StructRetType
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Liftedness
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549659"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map Name [(TypeExp VName, [VName], StructRetType, Liftedness)]
</span><a href="#local-6989586621684549670"><span class="hs-identifier hs-var">checked</span></a></span><span>
</span><span id="line-258"></span><span>      </span><span id="local-6989586621684549656"><span class="annot"><span class="annottext">ts_s :: Map Name [StructRetType]
</span><a href="#local-6989586621684549656"><span class="hs-identifier hs-var hs-var">ts_s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">([(TypeExp VName, [VName], StructRetType, Liftedness)]
 -&gt; [StructRetType])
-&gt; Map Name [(TypeExp VName, [VName], StructRetType, Liftedness)]
-&gt; Map Name [StructRetType]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">(([(TypeExp VName, [VName], StructRetType, Liftedness)]
  -&gt; [StructRetType])
 -&gt; Map Name [(TypeExp VName, [VName], StructRetType, Liftedness)]
 -&gt; Map Name [StructRetType])
-&gt; (((TypeExp VName, [VName], StructRetType, Liftedness)
     -&gt; StructRetType)
    -&gt; [(TypeExp VName, [VName], StructRetType, Liftedness)]
    -&gt; [StructRetType])
-&gt; ((TypeExp VName, [VName], StructRetType, Liftedness)
    -&gt; StructRetType)
-&gt; Map Name [(TypeExp VName, [VName], StructRetType, Liftedness)]
-&gt; Map Name [StructRetType]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">((TypeExp VName, [VName], StructRetType, Liftedness)
 -&gt; StructRetType)
-&gt; [(TypeExp VName, [VName], StructRetType, Liftedness)]
-&gt; [StructRetType]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeExp VName
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684549655"><span class="annot"><span class="annottext">StructRetType
</span><a href="#local-6989586621684549655"><span class="hs-identifier hs-var">z</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Liftedness
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">StructRetType
</span><a href="#local-6989586621684549655"><span class="hs-identifier hs-var">z</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map Name [(TypeExp VName, [VName], StructRetType, Liftedness)]
</span><a href="#local-6989586621684549670"><span class="hs-identifier hs-var">checked</span></a></span><span>
</span><span id="line-259"></span><span>      </span><span id="local-6989586621684549652"><span class="annot"><span class="annottext">ls :: [Liftedness]
</span><a href="#local-6989586621684549652"><span class="hs-identifier hs-var hs-var">ls</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">([(TypeExp VName, [VName], StructRetType, Liftedness)]
 -&gt; [Liftedness])
-&gt; Map Name [(TypeExp VName, [VName], StructRetType, Liftedness)]
-&gt; [Liftedness]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="annot"><span class="annottext">(([(TypeExp VName, [VName], StructRetType, Liftedness)]
  -&gt; [Liftedness])
 -&gt; Map Name [(TypeExp VName, [VName], StructRetType, Liftedness)]
 -&gt; [Liftedness])
-&gt; (((TypeExp VName, [VName], StructRetType, Liftedness)
     -&gt; Liftedness)
    -&gt; [(TypeExp VName, [VName], StructRetType, Liftedness)]
    -&gt; [Liftedness])
-&gt; ((TypeExp VName, [VName], StructRetType, Liftedness)
    -&gt; Liftedness)
-&gt; Map Name [(TypeExp VName, [VName], StructRetType, Liftedness)]
-&gt; [Liftedness]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">((TypeExp VName, [VName], StructRetType, Liftedness) -&gt; Liftedness)
-&gt; [(TypeExp VName, [VName], StructRetType, Liftedness)]
-&gt; [Liftedness]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeExp VName
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StructRetType
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684549650"><span class="annot"><span class="annottext">Liftedness
</span><a href="#local-6989586621684549650"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Liftedness
</span><a href="#local-6989586621684549650"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map Name [(TypeExp VName, [VName], StructRetType, Liftedness)]
</span><a href="#local-6989586621684549670"><span class="hs-identifier hs-var">checked</span></a></span><span>
</span><span id="line-260"></span><span>  </span><span class="annot"><span class="annottext">(TypeExp VName, [VName], StructRetType, Liftedness)
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-261"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">[(Name, [TypeExp VName])] -&gt; SrcLoc -&gt; TypeExp VName
forall vn. [(Name, [TypeExp vn])] -&gt; SrcLoc -&gt; TypeExp vn
</span><a href="Language.Futhark.Syntax.html#TESum"><span class="hs-identifier hs-var">TESum</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map Name [TypeExp VName] -&gt; [(Name, [TypeExp VName])]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">M.toList</span></span><span> </span><span class="annot"><span class="annottext">Map Name [TypeExp VName]
</span><a href="#local-6989586621684549666"><span class="hs-identifier hs-var">cs'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549673"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-262"></span><span>      </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549660"><span class="hs-identifier hs-var">cs_svars</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-263"></span><span>      </span><span class="annot"><span class="annottext">[VName] -&gt; TypeBase (DimDecl VName) () -&gt; StructRetType
forall dim as. [VName] -&gt; TypeBase dim as -&gt; RetTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-var">RetType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">([StructRetType] -&gt; [VName]) -&gt; Map Name [StructRetType] -&gt; [VName]
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(StructRetType -&gt; [VName]) -&gt; [StructRetType] -&gt; [VName]
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">StructRetType -&gt; [VName]
forall dim as. RetTypeBase dim as -&gt; [VName]
</span><a href="Language.Futhark.Syntax.html#retDims"><span class="hs-identifier hs-var hs-var">retDims</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map Name [StructRetType]
</span><a href="#local-6989586621684549656"><span class="hs-identifier hs-var">ts_s</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TypeBase (DimDecl VName) () -&gt; StructRetType)
-&gt; TypeBase (DimDecl VName) () -&gt; StructRetType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-264"></span><span>        </span><span class="annot"><span class="annottext">ScalarTypeBase (DimDecl VName) () -&gt; TypeBase (DimDecl VName) ()
forall dim as. ScalarTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-var">Scalar</span></a></span><span> </span><span class="annot"><span class="annottext">(ScalarTypeBase (DimDecl VName) () -&gt; TypeBase (DimDecl VName) ())
-&gt; ScalarTypeBase (DimDecl VName) () -&gt; TypeBase (DimDecl VName) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Map Name [TypeBase (DimDecl VName) ()]
-&gt; ScalarTypeBase (DimDecl VName) ()
forall dim as. Map Name [TypeBase dim as] -&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Sum"><span class="hs-identifier hs-var">Sum</span></a></span><span> </span><span class="annot"><span class="annottext">(Map Name [TypeBase (DimDecl VName) ()]
 -&gt; ScalarTypeBase (DimDecl VName) ())
-&gt; Map Name [TypeBase (DimDecl VName) ()]
-&gt; ScalarTypeBase (DimDecl VName) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">([StructRetType] -&gt; [TypeBase (DimDecl VName) ()])
-&gt; Map Name [StructRetType]
-&gt; Map Name [TypeBase (DimDecl VName) ()]
forall a b k. (a -&gt; b) -&gt; Map k a -&gt; Map k b
</span><span class="hs-identifier hs-var">M.map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(StructRetType -&gt; TypeBase (DimDecl VName) ())
-&gt; [StructRetType] -&gt; [TypeBase (DimDecl VName) ()]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">StructRetType -&gt; TypeBase (DimDecl VName) ()
forall dim as. RetTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#retType"><span class="hs-identifier hs-var hs-var">retType</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map Name [StructRetType]
</span><a href="#local-6989586621684549656"><span class="hs-identifier hs-var">ts_s</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-265"></span><span>      </span><span class="annot"><span class="annottext">(Liftedness -&gt; Liftedness -&gt; Liftedness)
-&gt; Liftedness -&gt; [Liftedness] -&gt; Liftedness
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span> </span><span class="annot"><span class="annottext">Liftedness -&gt; Liftedness -&gt; Liftedness
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">max</span></span><span> </span><span class="annot"><span class="annottext">Liftedness
</span><a href="Language.Futhark.Syntax.html#Unlifted"><span class="hs-identifier hs-var">Unlifted</span></a></span><span> </span><span class="annot"><span class="annottext">[Liftedness]
</span><a href="#local-6989586621684549652"><span class="hs-identifier hs-var">ls</span></a></span><span>
</span><span id="line-266"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-267"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#evalTypeExp"><span class="hs-identifier hs-var">evalTypeExp</span></a></span><span> </span><span id="local-6989586621684549649"><span class="annot"><span class="annottext">ote :: TypeExp Name
</span><a href="#local-6989586621684549649"><span class="hs-identifier hs-var">ote</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Language.Futhark.Syntax.html#TEApply"><span class="hs-identifier hs-type">TEApply</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-268"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684549647"><span class="annot"><span class="annottext">QualName Name
</span><a href="#local-6989586621684549647"><span class="hs-identifier hs-var">tname</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684549646"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549646"><span class="hs-identifier hs-var">tname_loc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684549645"><span class="annot"><span class="annottext">[TypeArgExp Name]
</span><a href="#local-6989586621684549645"><span class="hs-identifier hs-var">targs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TypeExp Name -&gt; m (QualName Name, SrcLoc, [TypeArgExp Name])
forall (m :: * -&gt; *).
MonadTypeChecker m =&gt;
TypeExp Name -&gt; m (QualName Name, SrcLoc, [TypeArgExp Name])
</span><a href="#local-6989586621684549644"><span class="hs-identifier hs-var">rootAndArgs</span></a></span><span> </span><span class="annot"><span class="annottext">TypeExp Name
</span><a href="#local-6989586621684549649"><span class="hs-identifier hs-var">ote</span></a></span><span>
</span><span id="line-269"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684549643"><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684549643"><span class="hs-identifier hs-var">tname'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684549642"><span class="annot"><span class="annottext">[TypeParam]
</span><a href="#local-6989586621684549642"><span class="hs-identifier hs-var">ps</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684549641"><span class="annot"><span class="annottext">StructRetType
</span><a href="#local-6989586621684549641"><span class="hs-identifier hs-var">tname_t</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684549640"><span class="annot"><span class="annottext">Liftedness
</span><a href="#local-6989586621684549640"><span class="hs-identifier hs-var">l</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SrcLoc
-&gt; QualName Name
-&gt; m (QualName VName, [TypeParam], StructRetType, Liftedness)
forall (m :: * -&gt; *).
MonadTypeChecker m =&gt;
SrcLoc
-&gt; QualName Name
-&gt; m (QualName VName, [TypeParam], StructRetType, Liftedness)
</span><a href="Language.Futhark.TypeChecker.Monad.html#lookupType"><span class="hs-identifier hs-var">lookupType</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549639"><span class="hs-identifier hs-var">tloc</span></a></span><span> </span><span class="annot"><span class="annottext">QualName Name
</span><a href="#local-6989586621684549647"><span class="hs-identifier hs-var">tname</span></a></span><span>
</span><span id="line-270"></span><span>  </span><span class="annot"><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-type">RetType</span></a></span><span> </span><span id="local-6989586621684549638"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549638"><span class="hs-identifier hs-var">t_dims</span></a></span></span><span> </span><span id="local-6989586621684549637"><span class="annot"><span class="annottext">TypeBase (DimDecl VName) ()
</span><a href="#local-6989586621684549637"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StructRetType -&gt; m StructRetType
forall (m :: * -&gt; *).
MonadTypeChecker m =&gt;
StructRetType -&gt; m StructRetType
</span><a href="Language.Futhark.TypeChecker.Types.html#renameRetType"><span class="hs-identifier hs-var">renameRetType</span></a></span><span> </span><span class="annot"><span class="annottext">StructRetType
</span><a href="#local-6989586621684549641"><span class="hs-identifier hs-var">tname_t</span></a></span><span>
</span><span id="line-271"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">[TypeParam] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[TypeParam]
</span><a href="#local-6989586621684549642"><span class="hs-identifier hs-var">ps</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">[TypeArgExp Name] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[TypeArgExp Name]
</span><a href="#local-6989586621684549645"><span class="hs-identifier hs-var">targs</span></a></span><span>
</span><span id="line-272"></span><span>    </span><span class="hs-keyword">then</span><span>
</span><span id="line-273"></span><span>      </span><span class="annot"><span class="annottext">SrcLoc
-&gt; Notes
-&gt; Doc
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
forall (m :: * -&gt; *) loc a.
(MonadTypeChecker m, Located loc) =&gt;
loc -&gt; Notes -&gt; Doc -&gt; m a
</span><a href="Language.Futhark.TypeChecker.Monad.html#typeError"><span class="hs-identifier hs-var">typeError</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549639"><span class="hs-identifier hs-var">tloc</span></a></span><span> </span><span class="annot"><span class="annottext">Notes
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; m (TypeExp VName, [VName], StructRetType, Liftedness))
-&gt; Doc -&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-274"></span><span>        </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Type constructor&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><a href="Language.Futhark.Core.html#pquote"><span class="hs-identifier hs-var">pquote</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QualName Name -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">QualName Name
</span><a href="#local-6989586621684549647"><span class="hs-identifier hs-var">tname</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;requires&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TypeParam] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[TypeParam]
</span><a href="#local-6989586621684549642"><span class="hs-identifier hs-var">ps</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-275"></span><span>          </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;arguments, but provided&quot;</span></span><span>
</span><span id="line-276"></span><span>          </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TypeArgExp Name] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[TypeArgExp Name]
</span><a href="#local-6989586621684549645"><span class="hs-identifier hs-var">targs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;.&quot;</span></span><span>
</span><span id="line-277"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-278"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684549636"><span class="annot"><span class="annottext">[TypeArgExp VName]
</span><a href="#local-6989586621684549636"><span class="hs-identifier hs-var">targs'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684549635"><span class="annot"><span class="annottext">[[VName]]
</span><a href="#local-6989586621684549635"><span class="hs-identifier hs-var">dims</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684549634"><span class="annot"><span class="annottext">[Map VName (Subst StructRetType)]
</span><a href="#local-6989586621684549634"><span class="hs-identifier hs-var">substs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(TypeArgExp VName, [VName], Map VName (Subst StructRetType))]
-&gt; ([TypeArgExp VName], [[VName]],
    [Map VName (Subst StructRetType)])
forall a b c. [(a, b, c)] -&gt; ([a], [b], [c])
</span><span class="hs-identifier hs-var">unzip3</span></span><span> </span><span class="annot"><span class="annottext">([(TypeArgExp VName, [VName], Map VName (Subst StructRetType))]
 -&gt; ([TypeArgExp VName], [[VName]],
     [Map VName (Subst StructRetType)]))
-&gt; m [(TypeArgExp VName, [VName], Map VName (Subst StructRetType))]
-&gt; m ([TypeArgExp VName], [[VName]],
      [Map VName (Subst StructRetType)])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(TypeParam
 -&gt; TypeArgExp Name
 -&gt; m (TypeArgExp VName, [VName], Map VName (Subst StructRetType)))
-&gt; [TypeParam]
-&gt; [TypeArgExp Name]
-&gt; m [(TypeArgExp VName, [VName], Map VName (Subst StructRetType))]
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m [c]
</span><span class="hs-identifier hs-var">zipWithM</span></span><span> </span><span class="annot"><span class="annottext">TypeParam
-&gt; TypeArgExp Name
-&gt; m (TypeArgExp VName, [VName], Map VName (Subst StructRetType))
forall {m :: * -&gt; *} {k}.
(MonadTypeChecker m, Eq k, IsName k) =&gt;
TypeParamBase k
-&gt; TypeArgExp Name
-&gt; m (TypeArgExp VName, [VName], Map k (Subst StructRetType))
</span><a href="#local-6989586621684549632"><span class="hs-identifier hs-var">checkArgApply</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeParam]
</span><a href="#local-6989586621684549642"><span class="hs-identifier hs-var">ps</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeArgExp Name]
</span><a href="#local-6989586621684549645"><span class="hs-identifier hs-var">targs</span></a></span><span>
</span><span id="line-279"></span><span>      </span><span class="annot"><span class="annottext">(TypeExp VName, [VName], StructRetType, Liftedness)
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-280"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">(TypeExp VName -&gt; TypeArgExp VName -&gt; TypeExp VName)
-&gt; TypeExp VName -&gt; [TypeArgExp VName] -&gt; TypeExp VName
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621684549630"><span class="annot"><span class="annottext">TypeExp VName
</span><a href="#local-6989586621684549630"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621684549629"><span class="annot"><span class="annottext">TypeArgExp VName
</span><a href="#local-6989586621684549629"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TypeExp VName -&gt; TypeArgExp VName -&gt; SrcLoc -&gt; TypeExp VName
forall vn. TypeExp vn -&gt; TypeArgExp vn -&gt; SrcLoc -&gt; TypeExp vn
</span><a href="Language.Futhark.Syntax.html#TEApply"><span class="hs-identifier hs-var">TEApply</span></a></span><span> </span><span class="annot"><span class="annottext">TypeExp VName
</span><a href="#local-6989586621684549630"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">TypeArgExp VName
</span><a href="#local-6989586621684549629"><span class="hs-identifier hs-var">y</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549639"><span class="hs-identifier hs-var">tloc</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QualName VName -&gt; SrcLoc -&gt; TypeExp VName
forall vn. QualName vn -&gt; SrcLoc -&gt; TypeExp vn
</span><a href="Language.Futhark.Syntax.html#TEVar"><span class="hs-identifier hs-var">TEVar</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684549643"><span class="hs-identifier hs-var">tname'</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549646"><span class="hs-identifier hs-var">tname_loc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TypeArgExp VName]
</span><a href="#local-6989586621684549636"><span class="hs-identifier hs-var">targs'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-281"></span><span>          </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><span id="line-282"></span><span>          </span><span class="annot"><span class="annottext">[VName] -&gt; TypeBase (DimDecl VName) () -&gt; StructRetType
forall dim as. [VName] -&gt; TypeBase dim as -&gt; RetTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-var">RetType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549638"><span class="hs-identifier hs-var">t_dims</span></a></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[[VName]] -&gt; [VName]
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">[[VName]]
</span><a href="#local-6989586621684549635"><span class="hs-identifier hs-var">dims</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TypeBase (DimDecl VName) () -&gt; StructRetType)
-&gt; TypeBase (DimDecl VName) () -&gt; StructRetType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TypeSubs
-&gt; TypeBase (DimDecl VName) () -&gt; TypeBase (DimDecl VName) ()
forall a. Substitutable a =&gt; TypeSubs -&gt; a -&gt; a
</span><a href="Language.Futhark.TypeChecker.Types.html#applySubst"><span class="hs-identifier hs-var">applySubst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
-&gt; Map VName (Subst StructRetType) -&gt; Maybe (Subst StructRetType)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-operator hs-var">`M.lookup`</span></span><span> </span><span class="annot"><span class="annottext">[Map VName (Subst StructRetType)]
-&gt; Map VName (Subst StructRetType)
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">[Map VName (Subst StructRetType)]
</span><a href="#local-6989586621684549634"><span class="hs-identifier hs-var">substs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) ()
</span><a href="#local-6989586621684549637"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-283"></span><span>          </span><span class="annot"><span class="annottext">Liftedness
</span><a href="#local-6989586621684549640"><span class="hs-identifier hs-var">l</span></a></span><span>
</span><span id="line-284"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-285"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-286"></span><span>    </span><span id="local-6989586621684549639"><span class="annot"><span class="annottext">tloc :: SrcLoc
</span><a href="#local-6989586621684549639"><span class="hs-identifier hs-var hs-var">tloc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeExp Name -&gt; SrcLoc
forall a. Located a =&gt; a -&gt; SrcLoc
</span><span class="hs-identifier hs-var">srclocOf</span></span><span> </span><span class="annot"><span class="annottext">TypeExp Name
</span><a href="#local-6989586621684549649"><span class="hs-identifier hs-var">ote</span></a></span><span>
</span><span id="line-287"></span><span>
</span><span id="line-288"></span><span>    </span><span id="local-6989586621684550416"><span class="annot"><a href="#local-6989586621684549644"><span class="hs-identifier hs-type">rootAndArgs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Monad.html#MonadTypeChecker"><span class="hs-identifier hs-type">MonadTypeChecker</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684550416"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeExp"><span class="hs-identifier hs-type">TypeExp</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684550416"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#QualName"><span class="hs-identifier hs-type">QualName</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SrcLoc</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeArgExp"><span class="hs-identifier hs-type">TypeArgExp</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span></span><span>
</span><span id="line-289"></span><span>    </span><span id="local-6989586621684549644"><span class="annot"><span class="annottext">rootAndArgs :: forall (m :: * -&gt; *).
MonadTypeChecker m =&gt;
TypeExp Name -&gt; m (QualName Name, SrcLoc, [TypeArgExp Name])
</span><a href="#local-6989586621684549644"><span class="hs-identifier hs-var hs-var">rootAndArgs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TEVar"><span class="hs-identifier hs-type">TEVar</span></a></span><span> </span><span id="local-6989586621684549611"><span class="annot"><span class="annottext">QualName Name
</span><a href="#local-6989586621684549611"><span class="hs-identifier hs-var">qn</span></a></span></span><span> </span><span id="local-6989586621684549610"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549610"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(QualName Name, SrcLoc, [TypeArgExp Name])
-&gt; m (QualName Name, SrcLoc, [TypeArgExp Name])
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QualName Name
</span><a href="#local-6989586621684549611"><span class="hs-identifier hs-var">qn</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549610"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-290"></span><span>    </span><span class="annot"><a href="#local-6989586621684549644"><span class="hs-identifier hs-var">rootAndArgs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TEApply"><span class="hs-identifier hs-type">TEApply</span></a></span><span> </span><span id="local-6989586621684549609"><span class="annot"><span class="annottext">TypeExp Name
</span><a href="#local-6989586621684549609"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span id="local-6989586621684549608"><span class="annot"><span class="annottext">TypeArgExp Name
</span><a href="#local-6989586621684549608"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-291"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684549607"><span class="annot"><span class="annottext">QualName Name
</span><a href="#local-6989586621684549607"><span class="hs-identifier hs-var">op'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684549606"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549606"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684549605"><span class="annot"><span class="annottext">[TypeArgExp Name]
</span><a href="#local-6989586621684549605"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TypeExp Name -&gt; m (QualName Name, SrcLoc, [TypeArgExp Name])
forall (m :: * -&gt; *).
MonadTypeChecker m =&gt;
TypeExp Name -&gt; m (QualName Name, SrcLoc, [TypeArgExp Name])
</span><a href="#local-6989586621684549644"><span class="hs-identifier hs-var">rootAndArgs</span></a></span><span> </span><span class="annot"><span class="annottext">TypeExp Name
</span><a href="#local-6989586621684549609"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-292"></span><span>      </span><span class="annot"><span class="annottext">(QualName Name, SrcLoc, [TypeArgExp Name])
-&gt; m (QualName Name, SrcLoc, [TypeArgExp Name])
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QualName Name
</span><a href="#local-6989586621684549607"><span class="hs-identifier hs-var">op'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549606"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TypeArgExp Name]
</span><a href="#local-6989586621684549605"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeArgExp Name] -&gt; [TypeArgExp Name] -&gt; [TypeArgExp Name]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TypeArgExp Name
</span><a href="#local-6989586621684549608"><span class="hs-identifier hs-var">arg</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-293"></span><span>    </span><span class="annot"><a href="#local-6989586621684549644"><span class="hs-identifier hs-var">rootAndArgs</span></a></span><span> </span><span id="local-6989586621684549604"><span class="annot"><span class="annottext">TypeExp Name
</span><a href="#local-6989586621684549604"><span class="hs-identifier hs-var">te'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-294"></span><span>      </span><span class="annot"><span class="annottext">SrcLoc
-&gt; Notes -&gt; Doc -&gt; m (QualName Name, SrcLoc, [TypeArgExp Name])
forall (m :: * -&gt; *) loc a.
(MonadTypeChecker m, Located loc) =&gt;
loc -&gt; Notes -&gt; Doc -&gt; m a
</span><a href="Language.Futhark.TypeChecker.Monad.html#typeError"><span class="hs-identifier hs-var">typeError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeExp Name -&gt; SrcLoc
forall a. Located a =&gt; a -&gt; SrcLoc
</span><span class="hs-identifier hs-var">srclocOf</span></span><span> </span><span class="annot"><span class="annottext">TypeExp Name
</span><a href="#local-6989586621684549604"><span class="hs-identifier hs-var">te'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Notes
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; m (QualName Name, SrcLoc, [TypeArgExp Name]))
-&gt; Doc -&gt; m (QualName Name, SrcLoc, [TypeArgExp Name])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-295"></span><span>        </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Type&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><a href="Language.Futhark.Core.html#pquote"><span class="hs-identifier hs-var">pquote</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeExp Name -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">TypeExp Name
</span><a href="#local-6989586621684549604"><span class="hs-identifier hs-var">te'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;is not a type constructor.&quot;</span></span><span>
</span><span id="line-296"></span><span>
</span><span id="line-297"></span><span>    </span><span id="local-6989586621684549632"><span class="annot"><span class="annottext">checkArgApply :: TypeParamBase k
-&gt; TypeArgExp Name
-&gt; m (TypeArgExp VName, [VName], Map k (Subst StructRetType))
</span><a href="#local-6989586621684549632"><span class="hs-identifier hs-var hs-var">checkArgApply</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeParamDim"><span class="hs-identifier hs-type">TypeParamDim</span></a></span><span> </span><span id="local-6989586621684549573"><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621684549573"><span class="hs-identifier hs-var">pv</span></a></span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeArgExpDim"><span class="hs-identifier hs-type">TypeArgExpDim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#DimExpNamed"><span class="hs-identifier hs-type">DimExpNamed</span></a></span><span> </span><span id="local-6989586621684549571"><span class="annot"><span class="annottext">QualName Name
</span><a href="#local-6989586621684549571"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621684549570"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549570"><span class="hs-identifier hs-var">dloc</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684549569"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549569"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-298"></span><span>      </span><span id="local-6989586621684549568"><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684549568"><span class="hs-identifier hs-var">v'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SrcLoc -&gt; QualName Name -&gt; m (QualName VName)
forall (m :: * -&gt; *).
MonadTypeChecker m =&gt;
SrcLoc -&gt; QualName Name -&gt; m (QualName VName)
</span><a href="Language.Futhark.TypeChecker.Monad.html#checkNamedDim"><span class="hs-identifier hs-var">checkNamedDim</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549569"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">QualName Name
</span><a href="#local-6989586621684549571"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-299"></span><span>      </span><span class="annot"><span class="annottext">(TypeArgExp VName, [VName], Map k (Subst StructRetType))
-&gt; m (TypeArgExp VName, [VName], Map k (Subst StructRetType))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-300"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">DimExp VName -&gt; SrcLoc -&gt; TypeArgExp VName
forall vn. DimExp vn -&gt; SrcLoc -&gt; TypeArgExp vn
</span><a href="Language.Futhark.Syntax.html#TypeArgExpDim"><span class="hs-identifier hs-var">TypeArgExpDim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QualName VName -&gt; SrcLoc -&gt; DimExp VName
forall vn. QualName vn -&gt; SrcLoc -&gt; DimExp vn
</span><a href="Language.Futhark.Syntax.html#DimExpNamed"><span class="hs-identifier hs-var">DimExpNamed</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684549568"><span class="hs-identifier hs-var">v'</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549570"><span class="hs-identifier hs-var">dloc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549569"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-301"></span><span>          </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><span id="line-302"></span><span>          </span><span class="annot"><span class="annottext">k -&gt; Subst StructRetType -&gt; Map k (Subst StructRetType)
forall k a. k -&gt; a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.singleton</span></span><span> </span><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621684549573"><span class="hs-identifier hs-var">pv</span></a></span><span> </span><span class="annot"><span class="annottext">(Subst StructRetType -&gt; Map k (Subst StructRetType))
-&gt; Subst StructRetType -&gt; Map k (Subst StructRetType)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DimDecl VName -&gt; Subst StructRetType
forall t. DimDecl VName -&gt; Subst t
</span><a href="Language.Futhark.TypeChecker.Types.html#SizeSubst"><span class="hs-identifier hs-var">SizeSubst</span></a></span><span> </span><span class="annot"><span class="annottext">(DimDecl VName -&gt; Subst StructRetType)
-&gt; DimDecl VName -&gt; Subst StructRetType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">QualName VName -&gt; DimDecl VName
forall vn. QualName vn -&gt; DimDecl vn
</span><a href="Language.Futhark.Syntax.html#NamedDim"><span class="hs-identifier hs-var">NamedDim</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684549568"><span class="hs-identifier hs-var">v'</span></a></span><span>
</span><span id="line-303"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-304"></span><span>    </span><span class="annot"><a href="#local-6989586621684549632"><span class="hs-identifier hs-var">checkArgApply</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeParamDim"><span class="hs-identifier hs-type">TypeParamDim</span></a></span><span> </span><span id="local-6989586621684549566"><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621684549566"><span class="hs-identifier hs-var">pv</span></a></span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeArgExpDim"><span class="hs-identifier hs-type">TypeArgExpDim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#DimExpConst"><span class="hs-identifier hs-type">DimExpConst</span></a></span><span> </span><span id="local-6989586621684549565"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684549565"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621684549564"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549564"><span class="hs-identifier hs-var">dloc</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684549563"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549563"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-305"></span><span>      </span><span class="annot"><span class="annottext">(TypeArgExp VName, [VName], Map k (Subst StructRetType))
-&gt; m (TypeArgExp VName, [VName], Map k (Subst StructRetType))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-306"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">DimExp VName -&gt; SrcLoc -&gt; TypeArgExp VName
forall vn. DimExp vn -&gt; SrcLoc -&gt; TypeArgExp vn
</span><a href="Language.Futhark.Syntax.html#TypeArgExpDim"><span class="hs-identifier hs-var">TypeArgExpDim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; SrcLoc -&gt; DimExp VName
forall vn. Int -&gt; SrcLoc -&gt; DimExp vn
</span><a href="Language.Futhark.Syntax.html#DimExpConst"><span class="hs-identifier hs-var">DimExpConst</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684549565"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549564"><span class="hs-identifier hs-var">dloc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549563"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-307"></span><span>          </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><span id="line-308"></span><span>          </span><span class="annot"><span class="annottext">k -&gt; Subst StructRetType -&gt; Map k (Subst StructRetType)
forall k a. k -&gt; a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.singleton</span></span><span> </span><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621684549566"><span class="hs-identifier hs-var">pv</span></a></span><span> </span><span class="annot"><span class="annottext">(Subst StructRetType -&gt; Map k (Subst StructRetType))
-&gt; Subst StructRetType -&gt; Map k (Subst StructRetType)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DimDecl VName -&gt; Subst StructRetType
forall t. DimDecl VName -&gt; Subst t
</span><a href="Language.Futhark.TypeChecker.Types.html#SizeSubst"><span class="hs-identifier hs-var">SizeSubst</span></a></span><span> </span><span class="annot"><span class="annottext">(DimDecl VName -&gt; Subst StructRetType)
-&gt; DimDecl VName -&gt; Subst StructRetType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; DimDecl VName
forall vn. Int -&gt; DimDecl vn
</span><a href="Language.Futhark.Syntax.html#ConstDim"><span class="hs-identifier hs-var">ConstDim</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684549565"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-309"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-310"></span><span>    </span><span class="annot"><a href="#local-6989586621684549632"><span class="hs-identifier hs-var">checkArgApply</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeParamDim"><span class="hs-identifier hs-type">TypeParamDim</span></a></span><span> </span><span id="local-6989586621684549562"><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621684549562"><span class="hs-identifier hs-var">pv</span></a></span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeArgExpDim"><span class="hs-identifier hs-type">TypeArgExpDim</span></a></span><span> </span><span class="annot"><span class="annottext">DimExp Name
</span><a href="Language.Futhark.Syntax.html#DimExpAny"><span class="hs-identifier hs-var">DimExpAny</span></a></span><span> </span><span id="local-6989586621684549561"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549561"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-311"></span><span>      </span><span id="local-6989586621684549560"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684549560"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; m VName
forall (m :: * -&gt; *). MonadTypeChecker m =&gt; Name -&gt; m VName
</span><a href="Language.Futhark.TypeChecker.Monad.html#newTypeName"><span class="hs-identifier hs-var">newTypeName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-string">&quot;d&quot;</span></span><span>
</span><span id="line-312"></span><span>      </span><span class="annot"><span class="annottext">(TypeArgExp VName, [VName], Map k (Subst StructRetType))
-&gt; m (TypeArgExp VName, [VName], Map k (Subst StructRetType))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-313"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">DimExp VName -&gt; SrcLoc -&gt; TypeArgExp VName
forall vn. DimExp vn -&gt; SrcLoc -&gt; TypeArgExp vn
</span><a href="Language.Futhark.Syntax.html#TypeArgExpDim"><span class="hs-identifier hs-var">TypeArgExpDim</span></a></span><span> </span><span class="annot"><span class="annottext">DimExp VName
forall vn. DimExp vn
</span><a href="Language.Futhark.Syntax.html#DimExpAny"><span class="hs-identifier hs-var">DimExpAny</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549561"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-314"></span><span>          </span><span class="hs-special">[</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684549560"><span class="hs-identifier hs-var">d</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><span id="line-315"></span><span>          </span><span class="annot"><span class="annottext">k -&gt; Subst StructRetType -&gt; Map k (Subst StructRetType)
forall k a. k -&gt; a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.singleton</span></span><span> </span><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621684549562"><span class="hs-identifier hs-var">pv</span></a></span><span> </span><span class="annot"><span class="annottext">(Subst StructRetType -&gt; Map k (Subst StructRetType))
-&gt; Subst StructRetType -&gt; Map k (Subst StructRetType)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DimDecl VName -&gt; Subst StructRetType
forall t. DimDecl VName -&gt; Subst t
</span><a href="Language.Futhark.TypeChecker.Types.html#SizeSubst"><span class="hs-identifier hs-var">SizeSubst</span></a></span><span> </span><span class="annot"><span class="annottext">(DimDecl VName -&gt; Subst StructRetType)
-&gt; DimDecl VName -&gt; Subst StructRetType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">QualName VName -&gt; DimDecl VName
forall vn. QualName vn -&gt; DimDecl vn
</span><a href="Language.Futhark.Syntax.html#NamedDim"><span class="hs-identifier hs-var">NamedDim</span></a></span><span> </span><span class="annot"><span class="annottext">(QualName VName -&gt; DimDecl VName)
-&gt; QualName VName -&gt; DimDecl VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; QualName VName
forall v. v -&gt; QualName v
</span><a href="Language.Futhark.Prop.html#qualName"><span class="hs-identifier hs-var">qualName</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684549560"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-316"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-317"></span><span>    </span><span class="annot"><a href="#local-6989586621684549632"><span class="hs-identifier hs-var">checkArgApply</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeParamType"><span class="hs-identifier hs-type">TypeParamType</span></a></span><span> </span><span class="annot"><span class="annottext">Liftedness
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684549558"><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621684549558"><span class="hs-identifier hs-var">pv</span></a></span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeArgExpType"><span class="hs-identifier hs-type">TypeArgExpType</span></a></span><span> </span><span id="local-6989586621684549556"><span class="annot"><span class="annottext">TypeExp Name
</span><a href="#local-6989586621684549556"><span class="hs-identifier hs-var">te</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-318"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684549555"><span class="annot"><span class="annottext">TypeExp VName
</span><a href="#local-6989586621684549555"><span class="hs-identifier hs-var">te'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684549554"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549554"><span class="hs-identifier hs-var">svars</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-type">RetType</span></a></span><span> </span><span id="local-6989586621684549553"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549553"><span class="hs-identifier hs-var">dims</span></a></span></span><span> </span><span id="local-6989586621684549552"><span class="annot"><span class="annottext">TypeBase (DimDecl VName) ()
</span><a href="#local-6989586621684549552"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Liftedness
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TypeExp Name
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
forall (m :: * -&gt; *).
MonadTypeChecker m =&gt;
TypeExp Name
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
</span><a href="Language.Futhark.TypeChecker.Types.html#evalTypeExp"><span class="hs-identifier hs-var">evalTypeExp</span></a></span><span> </span><span class="annot"><span class="annottext">TypeExp Name
</span><a href="#local-6989586621684549556"><span class="hs-identifier hs-var">te</span></a></span><span>
</span><span id="line-319"></span><span>      </span><span class="annot"><span class="annottext">(TypeArgExp VName, [VName], Map k (Subst StructRetType))
-&gt; m (TypeArgExp VName, [VName], Map k (Subst StructRetType))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-320"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">TypeExp VName -&gt; TypeArgExp VName
forall vn. TypeExp vn -&gt; TypeArgExp vn
</span><a href="Language.Futhark.Syntax.html#TypeArgExpType"><span class="hs-identifier hs-var">TypeArgExpType</span></a></span><span> </span><span class="annot"><span class="annottext">TypeExp VName
</span><a href="#local-6989586621684549555"><span class="hs-identifier hs-var">te'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-321"></span><span>          </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549554"><span class="hs-identifier hs-var">svars</span></a></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549553"><span class="hs-identifier hs-var">dims</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-322"></span><span>          </span><span class="annot"><span class="annottext">k -&gt; Subst StructRetType -&gt; Map k (Subst StructRetType)
forall k a. k -&gt; a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.singleton</span></span><span> </span><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621684549558"><span class="hs-identifier hs-var">pv</span></a></span><span> </span><span class="annot"><span class="annottext">(Subst StructRetType -&gt; Map k (Subst StructRetType))
-&gt; Subst StructRetType -&gt; Map k (Subst StructRetType)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TypeParam] -&gt; StructRetType -&gt; Subst StructRetType
forall t. [TypeParam] -&gt; t -&gt; Subst t
</span><a href="Language.Futhark.TypeChecker.Types.html#Subst"><span class="hs-identifier hs-var">Subst</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(StructRetType -&gt; Subst StructRetType)
-&gt; StructRetType -&gt; Subst StructRetType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; TypeBase (DimDecl VName) () -&gt; StructRetType
forall dim as. [VName] -&gt; TypeBase dim as -&gt; RetTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-var">RetType</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) ()
</span><a href="#local-6989586621684549552"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-323"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-324"></span><span>    </span><span class="annot"><a href="#local-6989586621684549632"><span class="hs-identifier hs-var">checkArgApply</span></a></span><span> </span><span id="local-6989586621684549550"><span class="annot"><span class="annottext">TypeParamBase k
</span><a href="#local-6989586621684549550"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621684549549"><span class="annot"><span class="annottext">TypeArgExp Name
</span><a href="#local-6989586621684549549"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-325"></span><span>      </span><span class="annot"><span class="annottext">SrcLoc
-&gt; Notes
-&gt; Doc
-&gt; m (TypeArgExp VName, [VName], Map k (Subst StructRetType))
forall (m :: * -&gt; *) loc a.
(MonadTypeChecker m, Located loc) =&gt;
loc -&gt; Notes -&gt; Doc -&gt; m a
</span><a href="Language.Futhark.TypeChecker.Monad.html#typeError"><span class="hs-identifier hs-var">typeError</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549639"><span class="hs-identifier hs-var">tloc</span></a></span><span> </span><span class="annot"><span class="annottext">Notes
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; m (TypeArgExp VName, [VName], Map k (Subst StructRetType)))
-&gt; Doc
-&gt; m (TypeArgExp VName, [VName], Map k (Subst StructRetType))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-326"></span><span>        </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Type argument&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">TypeArgExp Name -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">TypeArgExp Name
</span><a href="#local-6989586621684549549"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-327"></span><span>          </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;not valid for a type parameter&quot;</span></span><span>
</span><span id="line-328"></span><span>          </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">TypeParamBase k -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">TypeParamBase k
</span><a href="#local-6989586621684549550"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;.&quot;</span></span><span>
</span><span id="line-329"></span><span>
</span><span id="line-330"></span><span id="local-6989586621684549548"><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#checkTypeExp"><span class="hs-identifier hs-type">checkTypeExp</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-331"></span><span>  </span><span class="annot"><a href="Language.Futhark.TypeChecker.Monad.html#MonadTypeChecker"><span class="hs-identifier hs-type">MonadTypeChecker</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684549548"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-332"></span><span>  </span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeExp"><span class="hs-identifier hs-type">TypeExp</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-333"></span><span>  </span><span class="annot"><a href="#local-6989586621684549548"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeExp"><span class="hs-identifier hs-type">TypeExp</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#StructRetType"><span class="hs-identifier hs-type">StructRetType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#Liftedness"><span class="hs-identifier hs-type">Liftedness</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-334"></span><span id="checkTypeExp"><span class="annot"><span class="annottext">checkTypeExp :: forall (m :: * -&gt; *).
MonadTypeChecker m =&gt;
TypeExp Name
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
</span><a href="Language.Futhark.TypeChecker.Types.html#checkTypeExp"><span class="hs-identifier hs-var hs-var">checkTypeExp</span></a></span></span><span> </span><span id="local-6989586621684549542"><span class="annot"><span class="annottext">TypeExp Name
</span><a href="#local-6989586621684549542"><span class="hs-identifier hs-var">te</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-335"></span><span>  </span><span class="annot"><span class="annottext">TypeExp Name -&gt; m ()
forall (m :: * -&gt; *). MonadTypeChecker m =&gt; TypeExp Name -&gt; m ()
</span><a href="Language.Futhark.TypeChecker.Types.html#checkForDuplicateNamesInType"><span class="hs-identifier hs-var">checkForDuplicateNamesInType</span></a></span><span> </span><span class="annot"><span class="annottext">TypeExp Name
</span><a href="#local-6989586621684549542"><span class="hs-identifier hs-var">te</span></a></span><span>
</span><span id="line-336"></span><span>  </span><span class="annot"><span class="annottext">TypeExp Name
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
forall (m :: * -&gt; *).
MonadTypeChecker m =&gt;
TypeExp Name
-&gt; m (TypeExp VName, [VName], StructRetType, Liftedness)
</span><a href="Language.Futhark.TypeChecker.Types.html#evalTypeExp"><span class="hs-identifier hs-var">evalTypeExp</span></a></span><span> </span><span class="annot"><span class="annottext">TypeExp Name
</span><a href="#local-6989586621684549542"><span class="hs-identifier hs-var">te</span></a></span><span>
</span><span id="line-337"></span><span>
</span><span id="line-338"></span><span class="hs-comment">-- | Check for duplication of names inside a pattern group.  Produces</span><span>
</span><span id="line-339"></span><span class="hs-comment">-- a description of all names used in the pattern group.</span><span>
</span><span id="line-340"></span><span id="local-6989586621684550401"><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#checkForDuplicateNames"><span class="hs-identifier hs-type">checkForDuplicateNames</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-341"></span><span>  </span><span class="annot"><a href="Language.Futhark.TypeChecker.Monad.html#MonadTypeChecker"><span class="hs-identifier hs-type">MonadTypeChecker</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684550401"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-342"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Prop.html#UncheckedPat"><span class="hs-identifier hs-type">UncheckedPat</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-343"></span><span>  </span><span class="annot"><a href="#local-6989586621684550401"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-344"></span><span id="checkForDuplicateNames"><span class="annot"><span class="annottext">checkForDuplicateNames :: forall (m :: * -&gt; *). MonadTypeChecker m =&gt; [UncheckedPat] -&gt; m ()
</span><a href="Language.Futhark.TypeChecker.Types.html#checkForDuplicateNames"><span class="hs-identifier hs-var hs-var">checkForDuplicateNames</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StateT (Map Name SrcLoc) m () -&gt; Map Name SrcLoc -&gt; m ()
forall (m :: * -&gt; *) s a. Monad m =&gt; StateT s m a -&gt; s -&gt; m a
</span><span class="hs-operator hs-var">`evalStateT`</span></span><span> </span><span class="annot"><span class="annottext">Map Name SrcLoc
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(StateT (Map Name SrcLoc) m () -&gt; m ())
-&gt; ([UncheckedPat] -&gt; StateT (Map Name SrcLoc) m ())
-&gt; [UncheckedPat]
-&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(UncheckedPat -&gt; StateT (Map Name SrcLoc) m ())
-&gt; [UncheckedPat] -&gt; StateT (Map Name SrcLoc) m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="annot"><span class="annottext">UncheckedPat -&gt; StateT (Map Name SrcLoc) m ()
forall {k} {t :: (* -&gt; *) -&gt; * -&gt; *} {m :: * -&gt; *} {f :: * -&gt; *}.
(MonadState (Map k SrcLoc) (t m), Pretty k, MonadTypeChecker m,
 MonadTrans t, Ord k) =&gt;
PatBase f k -&gt; t m ()
</span><a href="#local-6989586621684549522"><span class="hs-identifier hs-var">check</span></a></span><span>
</span><span id="line-345"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-346"></span><span>    </span><span id="local-6989586621684549522"><span class="annot"><span class="annottext">check :: PatBase f k -&gt; t m ()
</span><a href="#local-6989586621684549522"><span class="hs-identifier hs-var hs-var">check</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span id="local-6989586621684549498"><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621684549498"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="annot"><span class="annottext">f PatType
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684549497"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549497"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">k -&gt; SrcLoc -&gt; t m ()
forall {k} {a} {t :: (* -&gt; *) -&gt; * -&gt; *} {m :: * -&gt; *}.
(MonadState (Map k a) (t m), Located a, Pretty k,
 MonadTypeChecker m, MonadTrans t, Ord k) =&gt;
k -&gt; a -&gt; t m ()
</span><a href="#local-6989586621684549496"><span class="hs-identifier hs-var">seen</span></a></span><span> </span><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621684549498"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549497"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-347"></span><span>    </span><span class="annot"><a href="#local-6989586621684549522"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#PatParens"><span class="hs-identifier hs-type">PatParens</span></a></span><span> </span><span id="local-6989586621684549494"><span class="annot"><span class="annottext">PatBase f k
</span><a href="#local-6989586621684549494"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatBase f k -&gt; t m ()
</span><a href="#local-6989586621684549522"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase f k
</span><a href="#local-6989586621684549494"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-348"></span><span>    </span><span class="annot"><a href="#local-6989586621684549522"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#PatAttr"><span class="hs-identifier hs-type">PatAttr</span></a></span><span> </span><span class="annot"><span class="annottext">AttrInfo k
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684549492"><span class="annot"><span class="annottext">PatBase f k
</span><a href="#local-6989586621684549492"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatBase f k -&gt; t m ()
</span><a href="#local-6989586621684549522"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase f k
</span><a href="#local-6989586621684549492"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-349"></span><span>    </span><span class="annot"><a href="#local-6989586621684549522"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#Wildcard"><span class="hs-identifier hs-type">Wildcard</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; t m ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-350"></span><span>    </span><span class="annot"><a href="#local-6989586621684549522"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TuplePat"><span class="hs-identifier hs-type">TuplePat</span></a></span><span> </span><span id="local-6989586621684549489"><span class="annot"><span class="annottext">[PatBase f k]
</span><a href="#local-6989586621684549489"><span class="hs-identifier hs-var">ps</span></a></span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(PatBase f k -&gt; t m ()) -&gt; [PatBase f k] -&gt; t m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="annot"><span class="annottext">PatBase f k -&gt; t m ()
</span><a href="#local-6989586621684549522"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span class="annot"><span class="annottext">[PatBase f k]
</span><a href="#local-6989586621684549489"><span class="hs-identifier hs-var">ps</span></a></span><span>
</span><span id="line-351"></span><span>    </span><span class="annot"><a href="#local-6989586621684549522"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#RecordPat"><span class="hs-identifier hs-type">RecordPat</span></a></span><span> </span><span id="local-6989586621684549487"><span class="annot"><span class="annottext">[(Name, PatBase f k)]
</span><a href="#local-6989586621684549487"><span class="hs-identifier hs-var">fs</span></a></span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Name, PatBase f k) -&gt; t m ()) -&gt; [(Name, PatBase f k)] -&gt; t m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatBase f k -&gt; t m ()
</span><a href="#local-6989586621684549522"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span class="annot"><span class="annottext">(PatBase f k -&gt; t m ())
-&gt; ((Name, PatBase f k) -&gt; PatBase f k)
-&gt; (Name, PatBase f k)
-&gt; t m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Name, PatBase f k) -&gt; PatBase f k
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Name, PatBase f k)]
</span><a href="#local-6989586621684549487"><span class="hs-identifier hs-var">fs</span></a></span><span>
</span><span id="line-352"></span><span>    </span><span class="annot"><a href="#local-6989586621684549522"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#PatAscription"><span class="hs-identifier hs-type">PatAscription</span></a></span><span> </span><span id="local-6989586621684549485"><span class="annot"><span class="annottext">PatBase f k
</span><a href="#local-6989586621684549485"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="annot"><span class="annottext">TypeDeclBase f k
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatBase f k -&gt; t m ()
</span><a href="#local-6989586621684549522"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase f k
</span><a href="#local-6989586621684549485"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-353"></span><span>    </span><span class="annot"><a href="#local-6989586621684549522"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#PatLit"><span class="hs-identifier hs-type">PatLit</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; t m ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-354"></span><span>    </span><span class="annot"><a href="#local-6989586621684549522"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#PatConstr"><span class="hs-identifier hs-type">PatConstr</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">f PatType
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684549482"><span class="annot"><span class="annottext">[PatBase f k]
</span><a href="#local-6989586621684549482"><span class="hs-identifier hs-var">ps</span></a></span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(PatBase f k -&gt; t m ()) -&gt; [PatBase f k] -&gt; t m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="annot"><span class="annottext">PatBase f k -&gt; t m ()
</span><a href="#local-6989586621684549522"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span class="annot"><span class="annottext">[PatBase f k]
</span><a href="#local-6989586621684549482"><span class="hs-identifier hs-var">ps</span></a></span><span>
</span><span id="line-355"></span><span>
</span><span id="line-356"></span><span>    </span><span id="local-6989586621684549496"><span class="annot"><span class="annottext">seen :: k -&gt; a -&gt; t m ()
</span><a href="#local-6989586621684549496"><span class="hs-identifier hs-var hs-var">seen</span></a></span></span><span> </span><span id="local-6989586621684549457"><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621684549457"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621684549456"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684549456"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-357"></span><span>      </span><span id="local-6989586621684549455"><span class="annot"><span class="annottext">Maybe a
</span><a href="#local-6989586621684549455"><span class="hs-identifier hs-var">already</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Map k a -&gt; Maybe a) -&gt; t m (Maybe a)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">((Map k a -&gt; Maybe a) -&gt; t m (Maybe a))
-&gt; (Map k a -&gt; Maybe a) -&gt; t m (Maybe a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">k -&gt; Map k a -&gt; Maybe a
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621684549457"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-358"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe a
</span><a href="#local-6989586621684549455"><span class="hs-identifier hs-var">already</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-359"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684549453"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684549453"><span class="hs-identifier hs-var">prev_loc</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-360"></span><span>          </span><span class="annot"><span class="annottext">m () -&gt; t m ()
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; t m ()) -&gt; m () -&gt; t m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-361"></span><span>            </span><span class="annot"><span class="annottext">a -&gt; Notes -&gt; Doc -&gt; m ()
forall (m :: * -&gt; *) loc a.
(MonadTypeChecker m, Located loc) =&gt;
loc -&gt; Notes -&gt; Doc -&gt; m a
</span><a href="Language.Futhark.TypeChecker.Monad.html#typeError"><span class="hs-identifier hs-var">typeError</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684549456"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">Notes
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; m ()) -&gt; Doc -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-362"></span><span>              </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Name&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><a href="Language.Futhark.Core.html#pquote"><span class="hs-identifier hs-var">pquote</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">k -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621684549457"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;also bound at&quot;</span></span><span>
</span><span id="line-363"></span><span>                </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Doc
</span><span class="hs-identifier hs-var">text</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; String
forall a. Located a =&gt; a -&gt; String
</span><a href="Language.Futhark.Core.html#locStr"><span class="hs-identifier hs-var">locStr</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684549453"><span class="hs-identifier hs-var">prev_loc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;.&quot;</span></span><span>
</span><span id="line-364"></span><span>        </span><span class="annot"><span class="annottext">Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-365"></span><span>          </span><span class="annot"><span class="annottext">(Map k a -&gt; Map k a) -&gt; t m ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((Map k a -&gt; Map k a) -&gt; t m ()) -&gt; (Map k a -&gt; Map k a) -&gt; t m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">k -&gt; a -&gt; Map k a -&gt; Map k a
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621684549457"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684549456"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-366"></span><span>
</span><span id="line-367"></span><span class="hs-comment">-- | Check whether the type contains arrow types that define the same</span><span>
</span><span id="line-368"></span><span class="hs-comment">-- parameter.  These might also exist further down, but that's not</span><span>
</span><span id="line-369"></span><span class="hs-comment">-- really a problem - we mostly do this checking to help the user,</span><span>
</span><span id="line-370"></span><span class="hs-comment">-- since it is likely an error, but it's easy to assign a semantics to</span><span>
</span><span id="line-371"></span><span class="hs-comment">-- it (normal name shadowing).</span><span>
</span><span id="line-372"></span><span id="local-6989586621684550402"><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#checkForDuplicateNamesInType"><span class="hs-identifier hs-type">checkForDuplicateNamesInType</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-373"></span><span>  </span><span class="annot"><a href="Language.Futhark.TypeChecker.Monad.html#MonadTypeChecker"><span class="hs-identifier hs-type">MonadTypeChecker</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684550402"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-374"></span><span>  </span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeExp"><span class="hs-identifier hs-type">TypeExp</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-375"></span><span>  </span><span class="annot"><a href="#local-6989586621684550402"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-376"></span><span id="checkForDuplicateNamesInType"><span class="annot"><span class="annottext">checkForDuplicateNamesInType :: forall (m :: * -&gt; *). MonadTypeChecker m =&gt; TypeExp Name -&gt; m ()
</span><a href="Language.Futhark.TypeChecker.Types.html#checkForDuplicateNamesInType"><span class="hs-identifier hs-var hs-var">checkForDuplicateNamesInType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map Name SrcLoc -&gt; TypeExp Name -&gt; m ()
forall {vn} {m :: * -&gt; *}.
(MonadTypeChecker m, Pretty vn, Ord vn) =&gt;
Map vn SrcLoc -&gt; TypeExp vn -&gt; m ()
</span><a href="#local-6989586621684549442"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span class="annot"><span class="annottext">Map Name SrcLoc
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-377"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-378"></span><span>    </span><span id="local-6989586621684549429"><span class="annot"><span class="annottext">bad :: a -&gt; loc -&gt; a -&gt; m a
</span><a href="#local-6989586621684549429"><span class="hs-identifier hs-var hs-var">bad</span></a></span></span><span> </span><span id="local-6989586621684549428"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684549428"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621684549427"><span class="annot"><span class="annottext">loc
</span><a href="#local-6989586621684549427"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span id="local-6989586621684549426"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684549426"><span class="hs-identifier hs-var">prev_loc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-379"></span><span>      </span><span class="annot"><span class="annottext">loc -&gt; Notes -&gt; Doc -&gt; m a
forall (m :: * -&gt; *) loc a.
(MonadTypeChecker m, Located loc) =&gt;
loc -&gt; Notes -&gt; Doc -&gt; m a
</span><a href="Language.Futhark.TypeChecker.Monad.html#typeError"><span class="hs-identifier hs-var">typeError</span></a></span><span> </span><span class="annot"><span class="annottext">loc
</span><a href="#local-6989586621684549427"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">Notes
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; m a) -&gt; Doc -&gt; m a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-380"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; Doc
</span><span class="hs-identifier hs-var">text</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Name&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><a href="Language.Futhark.Core.html#pquote"><span class="hs-identifier hs-var">pquote</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684549428"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-381"></span><span>          </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;also bound at&quot;</span></span><span>
</span><span id="line-382"></span><span>          </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Doc
</span><span class="hs-identifier hs-var">text</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; String
forall a. Located a =&gt; a -&gt; String
</span><a href="Language.Futhark.Core.html#locStr"><span class="hs-identifier hs-var">locStr</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684549426"><span class="hs-identifier hs-var">prev_loc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;.&quot;</span></span><span>
</span><span id="line-383"></span><span>
</span><span id="line-384"></span><span>    </span><span id="local-6989586621684549442"><span class="annot"><span class="annottext">check :: Map vn SrcLoc -&gt; TypeExp vn -&gt; m ()
</span><a href="#local-6989586621684549442"><span class="hs-identifier hs-var hs-var">check</span></a></span></span><span> </span><span id="local-6989586621684549396"><span class="annot"><span class="annottext">Map vn SrcLoc
</span><a href="#local-6989586621684549396"><span class="hs-identifier hs-var">seen</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TEArrow"><span class="hs-identifier hs-type">TEArrow</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684549395"><span class="annot"><span class="annottext">vn
</span><a href="#local-6989586621684549395"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684549394"><span class="annot"><span class="annottext">TypeExp vn
</span><a href="#local-6989586621684549394"><span class="hs-identifier hs-var">t1</span></a></span></span><span> </span><span id="local-6989586621684549393"><span class="annot"><span class="annottext">TypeExp vn
</span><a href="#local-6989586621684549393"><span class="hs-identifier hs-var">t2</span></a></span></span><span> </span><span id="local-6989586621684549392"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549392"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-385"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684549391"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549391"><span class="hs-identifier hs-var">prev_loc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">vn -&gt; Map vn SrcLoc -&gt; Maybe SrcLoc
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">vn
</span><a href="#local-6989586621684549395"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Map vn SrcLoc
</span><a href="#local-6989586621684549396"><span class="hs-identifier hs-var">seen</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-386"></span><span>        </span><span class="annot"><span class="annottext">vn -&gt; SrcLoc -&gt; SrcLoc -&gt; m ()
forall {m :: * -&gt; *} {a} {loc} {a} {a}.
(MonadTypeChecker m, Pretty a, Located loc, Located a) =&gt;
a -&gt; loc -&gt; a -&gt; m a
</span><a href="#local-6989586621684549429"><span class="hs-identifier hs-var">bad</span></a></span><span> </span><span class="annot"><span class="annottext">vn
</span><a href="#local-6989586621684549395"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549392"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549391"><span class="hs-identifier hs-var">prev_loc</span></a></span><span>
</span><span id="line-387"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-388"></span><span>        </span><span class="annot"><span class="annottext">Map vn SrcLoc -&gt; TypeExp vn -&gt; m ()
</span><a href="#local-6989586621684549442"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span class="annot"><span class="annottext">Map vn SrcLoc
</span><a href="#local-6989586621684549390"><span class="hs-identifier hs-var">seen'</span></a></span><span> </span><span class="annot"><span class="annottext">TypeExp vn
</span><a href="#local-6989586621684549394"><span class="hs-identifier hs-var">t1</span></a></span><span> </span><span class="annot"><span class="annottext">m () -&gt; m () -&gt; m ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Map vn SrcLoc -&gt; TypeExp vn -&gt; m ()
</span><a href="#local-6989586621684549442"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span class="annot"><span class="annottext">Map vn SrcLoc
</span><a href="#local-6989586621684549390"><span class="hs-identifier hs-var">seen'</span></a></span><span> </span><span class="annot"><span class="annottext">TypeExp vn
</span><a href="#local-6989586621684549393"><span class="hs-identifier hs-var">t2</span></a></span><span>
</span><span id="line-389"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-390"></span><span>        </span><span id="local-6989586621684549390"><span class="annot"><span class="annottext">seen' :: Map vn SrcLoc
</span><a href="#local-6989586621684549390"><span class="hs-identifier hs-var hs-var">seen'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">vn -&gt; SrcLoc -&gt; Map vn SrcLoc -&gt; Map vn SrcLoc
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">vn
</span><a href="#local-6989586621684549395"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549392"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">Map vn SrcLoc
</span><a href="#local-6989586621684549396"><span class="hs-identifier hs-var">seen</span></a></span><span>
</span><span id="line-391"></span><span>    </span><span class="annot"><a href="#local-6989586621684549442"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span id="local-6989586621684549388"><span class="annot"><span class="annottext">Map vn SrcLoc
</span><a href="#local-6989586621684549388"><span class="hs-identifier hs-var">seen</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TEArrow"><span class="hs-identifier hs-type">TEArrow</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe vn
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span id="local-6989586621684549387"><span class="annot"><span class="annottext">TypeExp vn
</span><a href="#local-6989586621684549387"><span class="hs-identifier hs-var">t1</span></a></span></span><span> </span><span id="local-6989586621684549386"><span class="annot"><span class="annottext">TypeExp vn
</span><a href="#local-6989586621684549386"><span class="hs-identifier hs-var">t2</span></a></span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-392"></span><span>      </span><span class="annot"><span class="annottext">Map vn SrcLoc -&gt; TypeExp vn -&gt; m ()
</span><a href="#local-6989586621684549442"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span class="annot"><span class="annottext">Map vn SrcLoc
</span><a href="#local-6989586621684549388"><span class="hs-identifier hs-var">seen</span></a></span><span> </span><span class="annot"><span class="annottext">TypeExp vn
</span><a href="#local-6989586621684549387"><span class="hs-identifier hs-var">t1</span></a></span><span> </span><span class="annot"><span class="annottext">m () -&gt; m () -&gt; m ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Map vn SrcLoc -&gt; TypeExp vn -&gt; m ()
</span><a href="#local-6989586621684549442"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span class="annot"><span class="annottext">Map vn SrcLoc
</span><a href="#local-6989586621684549388"><span class="hs-identifier hs-var">seen</span></a></span><span> </span><span class="annot"><span class="annottext">TypeExp vn
</span><a href="#local-6989586621684549386"><span class="hs-identifier hs-var">t2</span></a></span><span>
</span><span id="line-393"></span><span>    </span><span class="annot"><a href="#local-6989586621684549442"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span id="local-6989586621684549385"><span class="annot"><span class="annottext">Map vn SrcLoc
</span><a href="#local-6989586621684549385"><span class="hs-identifier hs-var">seen</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TETuple"><span class="hs-identifier hs-type">TETuple</span></a></span><span> </span><span id="local-6989586621684549384"><span class="annot"><span class="annottext">[TypeExp vn]
</span><a href="#local-6989586621684549384"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TypeExp vn -&gt; m ()) -&gt; [TypeExp vn] -&gt; m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map vn SrcLoc -&gt; TypeExp vn -&gt; m ()
</span><a href="#local-6989586621684549442"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span class="annot"><span class="annottext">Map vn SrcLoc
</span><a href="#local-6989586621684549385"><span class="hs-identifier hs-var">seen</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TypeExp vn]
</span><a href="#local-6989586621684549384"><span class="hs-identifier hs-var">ts</span></a></span><span>
</span><span id="line-394"></span><span>    </span><span class="annot"><a href="#local-6989586621684549442"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span id="local-6989586621684549383"><span class="annot"><span class="annottext">Map vn SrcLoc
</span><a href="#local-6989586621684549383"><span class="hs-identifier hs-var">seen</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TERecord"><span class="hs-identifier hs-type">TERecord</span></a></span><span> </span><span id="local-6989586621684549382"><span class="annot"><span class="annottext">[(Name, TypeExp vn)]
</span><a href="#local-6989586621684549382"><span class="hs-identifier hs-var">fs</span></a></span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Name, TypeExp vn) -&gt; m ()) -&gt; [(Name, TypeExp vn)] -&gt; m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map vn SrcLoc -&gt; TypeExp vn -&gt; m ()
</span><a href="#local-6989586621684549442"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span class="annot"><span class="annottext">Map vn SrcLoc
</span><a href="#local-6989586621684549383"><span class="hs-identifier hs-var">seen</span></a></span><span> </span><span class="annot"><span class="annottext">(TypeExp vn -&gt; m ())
-&gt; ((Name, TypeExp vn) -&gt; TypeExp vn) -&gt; (Name, TypeExp vn) -&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Name, TypeExp vn) -&gt; TypeExp vn
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Name, TypeExp vn)]
</span><a href="#local-6989586621684549382"><span class="hs-identifier hs-var">fs</span></a></span><span>
</span><span id="line-395"></span><span>    </span><span class="annot"><a href="#local-6989586621684549442"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span id="local-6989586621684549381"><span class="annot"><span class="annottext">Map vn SrcLoc
</span><a href="#local-6989586621684549381"><span class="hs-identifier hs-var">seen</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TEUnique"><span class="hs-identifier hs-type">TEUnique</span></a></span><span> </span><span id="local-6989586621684549380"><span class="annot"><span class="annottext">TypeExp vn
</span><a href="#local-6989586621684549380"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map vn SrcLoc -&gt; TypeExp vn -&gt; m ()
</span><a href="#local-6989586621684549442"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span class="annot"><span class="annottext">Map vn SrcLoc
</span><a href="#local-6989586621684549381"><span class="hs-identifier hs-var">seen</span></a></span><span> </span><span class="annot"><span class="annottext">TypeExp vn
</span><a href="#local-6989586621684549380"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-396"></span><span>    </span><span class="annot"><a href="#local-6989586621684549442"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span id="local-6989586621684549379"><span class="annot"><span class="annottext">Map vn SrcLoc
</span><a href="#local-6989586621684549379"><span class="hs-identifier hs-var">seen</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TESum"><span class="hs-identifier hs-type">TESum</span></a></span><span> </span><span id="local-6989586621684549378"><span class="annot"><span class="annottext">[(Name, [TypeExp vn])]
</span><a href="#local-6989586621684549378"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Name, [TypeExp vn]) -&gt; m [()]) -&gt; [(Name, [TypeExp vn])] -&gt; m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TypeExp vn -&gt; m ()) -&gt; [TypeExp vn] -&gt; m [()]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map vn SrcLoc -&gt; TypeExp vn -&gt; m ()
</span><a href="#local-6989586621684549442"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span class="annot"><span class="annottext">Map vn SrcLoc
</span><a href="#local-6989586621684549379"><span class="hs-identifier hs-var">seen</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([TypeExp vn] -&gt; m [()])
-&gt; ((Name, [TypeExp vn]) -&gt; [TypeExp vn])
-&gt; (Name, [TypeExp vn])
-&gt; m [()]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Name, [TypeExp vn]) -&gt; [TypeExp vn]
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Name, [TypeExp vn])]
</span><a href="#local-6989586621684549378"><span class="hs-identifier hs-var">cs</span></a></span><span>
</span><span id="line-397"></span><span>    </span><span class="annot"><a href="#local-6989586621684549442"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span id="local-6989586621684549377"><span class="annot"><span class="annottext">Map vn SrcLoc
</span><a href="#local-6989586621684549377"><span class="hs-identifier hs-var">seen</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TEApply"><span class="hs-identifier hs-type">TEApply</span></a></span><span> </span><span id="local-6989586621684549376"><span class="annot"><span class="annottext">TypeExp vn
</span><a href="#local-6989586621684549376"><span class="hs-identifier hs-var">t1</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeArgExpType"><span class="hs-identifier hs-type">TypeArgExpType</span></a></span><span> </span><span id="local-6989586621684549375"><span class="annot"><span class="annottext">TypeExp vn
</span><a href="#local-6989586621684549375"><span class="hs-identifier hs-var">t2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-398"></span><span>      </span><span class="annot"><span class="annottext">Map vn SrcLoc -&gt; TypeExp vn -&gt; m ()
</span><a href="#local-6989586621684549442"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span class="annot"><span class="annottext">Map vn SrcLoc
</span><a href="#local-6989586621684549377"><span class="hs-identifier hs-var">seen</span></a></span><span> </span><span class="annot"><span class="annottext">TypeExp vn
</span><a href="#local-6989586621684549376"><span class="hs-identifier hs-var">t1</span></a></span><span> </span><span class="annot"><span class="annottext">m () -&gt; m () -&gt; m ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Map vn SrcLoc -&gt; TypeExp vn -&gt; m ()
</span><a href="#local-6989586621684549442"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span class="annot"><span class="annottext">Map vn SrcLoc
</span><a href="#local-6989586621684549377"><span class="hs-identifier hs-var">seen</span></a></span><span> </span><span class="annot"><span class="annottext">TypeExp vn
</span><a href="#local-6989586621684549375"><span class="hs-identifier hs-var">t2</span></a></span><span>
</span><span id="line-399"></span><span>    </span><span class="annot"><a href="#local-6989586621684549442"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span id="local-6989586621684549374"><span class="annot"><span class="annottext">Map vn SrcLoc
</span><a href="#local-6989586621684549374"><span class="hs-identifier hs-var">seen</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TEApply"><span class="hs-identifier hs-type">TEApply</span></a></span><span> </span><span id="local-6989586621684549373"><span class="annot"><span class="annottext">TypeExp vn
</span><a href="#local-6989586621684549373"><span class="hs-identifier hs-var">t1</span></a></span></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeArgExpDim"><span class="hs-identifier hs-type">TypeArgExpDim</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-400"></span><span>      </span><span class="annot"><span class="annottext">Map vn SrcLoc -&gt; TypeExp vn -&gt; m ()
</span><a href="#local-6989586621684549442"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span class="annot"><span class="annottext">Map vn SrcLoc
</span><a href="#local-6989586621684549374"><span class="hs-identifier hs-var">seen</span></a></span><span> </span><span class="annot"><span class="annottext">TypeExp vn
</span><a href="#local-6989586621684549373"><span class="hs-identifier hs-var">t1</span></a></span><span>
</span><span id="line-401"></span><span>    </span><span class="annot"><a href="#local-6989586621684549442"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span id="local-6989586621684549372"><span class="annot"><span class="annottext">Map vn SrcLoc
</span><a href="#local-6989586621684549372"><span class="hs-identifier hs-var">seen</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TEDim"><span class="hs-identifier hs-type">TEDim</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684549371"><span class="annot"><span class="annottext">vn
</span><a href="#local-6989586621684549371"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684549370"><span class="annot"><span class="annottext">[vn]
</span><a href="#local-6989586621684549370"><span class="hs-identifier hs-var">vs</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684549369"><span class="annot"><span class="annottext">TypeExp vn
</span><a href="#local-6989586621684549369"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621684549368"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549368"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-402"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684549367"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549367"><span class="hs-identifier hs-var">prev_loc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">vn -&gt; Map vn SrcLoc -&gt; Maybe SrcLoc
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">vn
</span><a href="#local-6989586621684549371"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Map vn SrcLoc
</span><a href="#local-6989586621684549372"><span class="hs-identifier hs-var">seen</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-403"></span><span>        </span><span class="annot"><span class="annottext">vn -&gt; SrcLoc -&gt; SrcLoc -&gt; m ()
forall {m :: * -&gt; *} {a} {loc} {a} {a}.
(MonadTypeChecker m, Pretty a, Located loc, Located a) =&gt;
a -&gt; loc -&gt; a -&gt; m a
</span><a href="#local-6989586621684549429"><span class="hs-identifier hs-var">bad</span></a></span><span> </span><span class="annot"><span class="annottext">vn
</span><a href="#local-6989586621684549371"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549368"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549367"><span class="hs-identifier hs-var">prev_loc</span></a></span><span>
</span><span id="line-404"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-405"></span><span>        </span><span class="annot"><span class="annottext">Map vn SrcLoc -&gt; TypeExp vn -&gt; m ()
</span><a href="#local-6989586621684549442"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">vn -&gt; SrcLoc -&gt; Map vn SrcLoc -&gt; Map vn SrcLoc
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">vn
</span><a href="#local-6989586621684549371"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549368"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">Map vn SrcLoc
</span><a href="#local-6989586621684549372"><span class="hs-identifier hs-var">seen</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[vn] -&gt; TypeExp vn -&gt; SrcLoc -&gt; TypeExp vn
forall vn. [vn] -&gt; TypeExp vn -&gt; SrcLoc -&gt; TypeExp vn
</span><a href="Language.Futhark.Syntax.html#TEDim"><span class="hs-identifier hs-var">TEDim</span></a></span><span> </span><span class="annot"><span class="annottext">[vn]
</span><a href="#local-6989586621684549370"><span class="hs-identifier hs-var">vs</span></a></span><span> </span><span class="annot"><span class="annottext">TypeExp vn
</span><a href="#local-6989586621684549369"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549368"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-406"></span><span>    </span><span class="annot"><a href="#local-6989586621684549442"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span id="local-6989586621684549366"><span class="annot"><span class="annottext">Map vn SrcLoc
</span><a href="#local-6989586621684549366"><span class="hs-identifier hs-var">seen</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TEDim"><span class="hs-identifier hs-type">TEDim</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span id="local-6989586621684549365"><span class="annot"><span class="annottext">TypeExp vn
</span><a href="#local-6989586621684549365"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-407"></span><span>      </span><span class="annot"><span class="annottext">Map vn SrcLoc -&gt; TypeExp vn -&gt; m ()
</span><a href="#local-6989586621684549442"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span class="annot"><span class="annottext">Map vn SrcLoc
</span><a href="#local-6989586621684549366"><span class="hs-identifier hs-var">seen</span></a></span><span> </span><span class="annot"><span class="annottext">TypeExp vn
</span><a href="#local-6989586621684549365"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-408"></span><span>    </span><span class="annot"><a href="#local-6989586621684549442"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span class="annot"><span class="annottext">Map vn SrcLoc
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#TEArray"><span class="hs-identifier hs-type">TEArray</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-409"></span><span>    </span><span class="annot"><a href="#local-6989586621684549442"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span class="annot"><span class="annottext">Map vn SrcLoc
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#TEVar"><span class="hs-identifier hs-type">TEVar</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-410"></span><span>
</span><span id="line-411"></span><span class="hs-comment">-- | @checkTypeParams ps m@ checks the type parameters @ps@, then</span><span>
</span><span id="line-412"></span><span class="hs-comment">-- invokes the continuation @m@ with the checked parameters, while</span><span>
</span><span id="line-413"></span><span class="hs-comment">-- extending the monadic name map with @ps@.</span><span>
</span><span id="line-414"></span><span id="local-6989586621684550345"><span id="local-6989586621684550346"><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#checkTypeParams"><span class="hs-identifier hs-type">checkTypeParams</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-415"></span><span>  </span><span class="annot"><a href="Language.Futhark.TypeChecker.Monad.html#MonadTypeChecker"><span class="hs-identifier hs-type">MonadTypeChecker</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684550346"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-416"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeParamBase"><span class="hs-identifier hs-type">TypeParamBase</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-417"></span><span>  </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeParamBase"><span class="hs-identifier hs-type">TypeParamBase</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684550346"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684550345"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-418"></span><span>  </span><span class="annot"><a href="#local-6989586621684550346"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684550345"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-419"></span><span id="checkTypeParams"><span class="annot"><span class="annottext">checkTypeParams :: forall (m :: * -&gt; *) a.
MonadTypeChecker m =&gt;
[TypeParamBase Name] -&gt; ([TypeParam] -&gt; m a) -&gt; m a
</span><a href="Language.Futhark.TypeChecker.Types.html#checkTypeParams"><span class="hs-identifier hs-var hs-var">checkTypeParams</span></a></span></span><span> </span><span id="local-6989586621684549348"><span class="annot"><span class="annottext">[TypeParamBase Name]
</span><a href="#local-6989586621684549348"><span class="hs-identifier hs-var">ps</span></a></span></span><span> </span><span id="local-6989586621684549347"><span class="annot"><span class="annottext">[TypeParam] -&gt; m a
</span><a href="#local-6989586621684549347"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-420"></span><span>  </span><span class="annot"><span class="annottext">[(Namespace, Name)] -&gt; m a -&gt; m a
forall (m :: * -&gt; *) a.
MonadTypeChecker m =&gt;
[(Namespace, Name)] -&gt; m a -&gt; m a
</span><a href="Language.Futhark.TypeChecker.Monad.html#bindSpaced"><span class="hs-identifier hs-var">bindSpaced</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TypeParamBase Name -&gt; (Namespace, Name))
-&gt; [TypeParamBase Name] -&gt; [(Namespace, Name)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TypeParamBase Name -&gt; (Namespace, Name)
forall {b}. TypeParamBase b -&gt; (Namespace, b)
</span><a href="#local-6989586621684549346"><span class="hs-identifier hs-var">typeParamSpace</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeParamBase Name]
</span><a href="#local-6989586621684549348"><span class="hs-identifier hs-var">ps</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m a -&gt; m a) -&gt; m a -&gt; m a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-421"></span><span>    </span><span class="annot"><span class="annottext">[TypeParam] -&gt; m a
</span><a href="#local-6989586621684549347"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">([TypeParam] -&gt; m a) -&gt; m [TypeParam] -&gt; m a
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">StateT (Map (Namespace, Name) SrcLoc) m [TypeParam]
-&gt; Map (Namespace, Name) SrcLoc -&gt; m [TypeParam]
forall (m :: * -&gt; *) s a. Monad m =&gt; StateT s m a -&gt; s -&gt; m a
</span><span class="hs-identifier hs-var">evalStateT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TypeParamBase Name
 -&gt; StateT (Map (Namespace, Name) SrcLoc) m TypeParam)
-&gt; [TypeParamBase Name]
-&gt; StateT (Map (Namespace, Name) SrcLoc) m [TypeParam]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">TypeParamBase Name
-&gt; StateT (Map (Namespace, Name) SrcLoc) m TypeParam
forall {t :: (* -&gt; *) -&gt; * -&gt; *} {m :: * -&gt; *}.
(MonadState (Map (Namespace, Name) SrcLoc) (t m),
 MonadTypeChecker m, MonadTrans t) =&gt;
TypeParamBase Name -&gt; t m TypeParam
</span><a href="#local-6989586621684549344"><span class="hs-identifier hs-var">checkTypeParam</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeParamBase Name]
</span><a href="#local-6989586621684549348"><span class="hs-identifier hs-var">ps</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map (Namespace, Name) SrcLoc
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-422"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-423"></span><span>    </span><span id="local-6989586621684549346"><span class="annot"><span class="annottext">typeParamSpace :: TypeParamBase b -&gt; (Namespace, b)
</span><a href="#local-6989586621684549346"><span class="hs-identifier hs-var hs-var">typeParamSpace</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeParamDim"><span class="hs-identifier hs-type">TypeParamDim</span></a></span><span> </span><span id="local-6989586621684549343"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684549343"><span class="hs-identifier hs-var">pv</span></a></span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Namespace
</span><a href="Language.Futhark.Semantic.html#Term"><span class="hs-identifier hs-var">Term</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684549343"><span class="hs-identifier hs-var">pv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-424"></span><span>    </span><span class="annot"><a href="#local-6989586621684549346"><span class="hs-identifier hs-var">typeParamSpace</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeParamType"><span class="hs-identifier hs-type">TypeParamType</span></a></span><span> </span><span class="annot"><span class="annottext">Liftedness
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684549342"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684549342"><span class="hs-identifier hs-var">pv</span></a></span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Namespace
</span><a href="Language.Futhark.Semantic.html#Type"><span class="hs-identifier hs-var">Type</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684549342"><span class="hs-identifier hs-var">pv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-425"></span><span>
</span><span id="line-426"></span><span>    </span><span id="local-6989586621684549314"><span class="annot"><span class="annottext">checkParamName :: Namespace -&gt; Name -&gt; SrcLoc -&gt; t m VName
</span><a href="#local-6989586621684549314"><span class="hs-identifier hs-var hs-var">checkParamName</span></a></span></span><span> </span><span id="local-6989586621684549313"><span class="annot"><span class="annottext">Namespace
</span><a href="#local-6989586621684549313"><span class="hs-identifier hs-var">ns</span></a></span></span><span> </span><span id="local-6989586621684549312"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684549312"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621684549311"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549311"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-427"></span><span>      </span><span id="local-6989586621684549310"><span class="annot"><span class="annottext">Maybe SrcLoc
</span><a href="#local-6989586621684549310"><span class="hs-identifier hs-var">seen</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Map (Namespace, Name) SrcLoc -&gt; Maybe SrcLoc)
-&gt; t m (Maybe SrcLoc)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">((Map (Namespace, Name) SrcLoc -&gt; Maybe SrcLoc)
 -&gt; t m (Maybe SrcLoc))
-&gt; (Map (Namespace, Name) SrcLoc -&gt; Maybe SrcLoc)
-&gt; t m (Maybe SrcLoc)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Namespace, Name) -&gt; Map (Namespace, Name) SrcLoc -&gt; Maybe SrcLoc
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Namespace
</span><a href="#local-6989586621684549313"><span class="hs-identifier hs-var">ns</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684549312"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-428"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe SrcLoc
</span><a href="#local-6989586621684549310"><span class="hs-identifier hs-var">seen</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-429"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684549309"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549309"><span class="hs-identifier hs-var">prev</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-430"></span><span>          </span><span class="annot"><span class="annottext">m VName -&gt; t m VName
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(m VName -&gt; t m VName) -&gt; m VName -&gt; t m VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-431"></span><span>            </span><span class="annot"><span class="annottext">SrcLoc -&gt; Notes -&gt; Doc -&gt; m VName
forall (m :: * -&gt; *) loc a.
(MonadTypeChecker m, Located loc) =&gt;
loc -&gt; Notes -&gt; Doc -&gt; m a
</span><a href="Language.Futhark.TypeChecker.Monad.html#typeError"><span class="hs-identifier hs-var">typeError</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549311"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">Notes
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; m VName) -&gt; Doc -&gt; m VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-432"></span><span>              </span><span class="annot"><span class="annottext">String -&gt; Doc
</span><span class="hs-identifier hs-var">text</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Type parameter&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><a href="Language.Futhark.Core.html#pquote"><span class="hs-identifier hs-var">pquote</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684549312"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-433"></span><span>                </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;previously defined at&quot;</span></span><span>
</span><span id="line-434"></span><span>                </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Doc
</span><span class="hs-identifier hs-var">text</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SrcLoc -&gt; String
forall a. Located a =&gt; a -&gt; String
</span><a href="Language.Futhark.Core.html#locStr"><span class="hs-identifier hs-var">locStr</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549309"><span class="hs-identifier hs-var">prev</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;.&quot;</span></span><span>
</span><span id="line-435"></span><span>        </span><span class="annot"><span class="annottext">Maybe SrcLoc
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-436"></span><span>          </span><span class="annot"><span class="annottext">(Map (Namespace, Name) SrcLoc -&gt; Map (Namespace, Name) SrcLoc)
-&gt; t m ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((Map (Namespace, Name) SrcLoc -&gt; Map (Namespace, Name) SrcLoc)
 -&gt; t m ())
-&gt; (Map (Namespace, Name) SrcLoc -&gt; Map (Namespace, Name) SrcLoc)
-&gt; t m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Namespace, Name)
-&gt; SrcLoc
-&gt; Map (Namespace, Name) SrcLoc
-&gt; Map (Namespace, Name) SrcLoc
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Namespace
</span><a href="#local-6989586621684549313"><span class="hs-identifier hs-var">ns</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684549312"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549311"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-437"></span><span>          </span><span class="annot"><span class="annottext">m VName -&gt; t m VName
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(m VName -&gt; t m VName) -&gt; m VName -&gt; t m VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Namespace -&gt; Name -&gt; SrcLoc -&gt; m VName
forall (m :: * -&gt; *).
MonadTypeChecker m =&gt;
Namespace -&gt; Name -&gt; SrcLoc -&gt; m VName
</span><a href="Language.Futhark.TypeChecker.Monad.html#checkName"><span class="hs-identifier hs-var">checkName</span></a></span><span> </span><span class="annot"><span class="annottext">Namespace
</span><a href="#local-6989586621684549313"><span class="hs-identifier hs-var">ns</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684549312"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549311"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-438"></span><span>
</span><span id="line-439"></span><span>    </span><span id="local-6989586621684549344"><span class="annot"><span class="annottext">checkTypeParam :: TypeParamBase Name -&gt; t m TypeParam
</span><a href="#local-6989586621684549344"><span class="hs-identifier hs-var hs-var">checkTypeParam</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeParamDim"><span class="hs-identifier hs-type">TypeParamDim</span></a></span><span> </span><span id="local-6989586621684549290"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684549290"><span class="hs-identifier hs-var">pv</span></a></span></span><span> </span><span id="local-6989586621684549289"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549289"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-440"></span><span>      </span><span class="annot"><span class="annottext">VName -&gt; SrcLoc -&gt; TypeParam
forall vn. vn -&gt; SrcLoc -&gt; TypeParamBase vn
</span><a href="Language.Futhark.Syntax.html#TypeParamDim"><span class="hs-identifier hs-var">TypeParamDim</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SrcLoc -&gt; TypeParam)
-&gt; t m VName -&gt; t m (SrcLoc -&gt; TypeParam)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Namespace -&gt; Name -&gt; SrcLoc -&gt; t m VName
forall {t :: (* -&gt; *) -&gt; * -&gt; *} {m :: * -&gt; *}.
(MonadState (Map (Namespace, Name) SrcLoc) (t m),
 MonadTypeChecker m, MonadTrans t) =&gt;
Namespace -&gt; Name -&gt; SrcLoc -&gt; t m VName
</span><a href="#local-6989586621684549314"><span class="hs-identifier hs-var">checkParamName</span></a></span><span> </span><span class="annot"><span class="annottext">Namespace
</span><a href="Language.Futhark.Semantic.html#Term"><span class="hs-identifier hs-var">Term</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684549290"><span class="hs-identifier hs-var">pv</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549289"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">t m (SrcLoc -&gt; TypeParam) -&gt; t m SrcLoc -&gt; t m TypeParam
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc -&gt; t m SrcLoc
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549289"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-441"></span><span>    </span><span class="annot"><a href="#local-6989586621684549344"><span class="hs-identifier hs-var">checkTypeParam</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeParamType"><span class="hs-identifier hs-type">TypeParamType</span></a></span><span> </span><span id="local-6989586621684549288"><span class="annot"><span class="annottext">Liftedness
</span><a href="#local-6989586621684549288"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span id="local-6989586621684549287"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684549287"><span class="hs-identifier hs-var">pv</span></a></span></span><span> </span><span id="local-6989586621684549286"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549286"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-442"></span><span>      </span><span class="annot"><span class="annottext">Liftedness -&gt; VName -&gt; SrcLoc -&gt; TypeParam
forall vn. Liftedness -&gt; vn -&gt; SrcLoc -&gt; TypeParamBase vn
</span><a href="Language.Futhark.Syntax.html#TypeParamType"><span class="hs-identifier hs-var">TypeParamType</span></a></span><span> </span><span class="annot"><span class="annottext">Liftedness
</span><a href="#local-6989586621684549288"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SrcLoc -&gt; TypeParam)
-&gt; t m VName -&gt; t m (SrcLoc -&gt; TypeParam)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Namespace -&gt; Name -&gt; SrcLoc -&gt; t m VName
forall {t :: (* -&gt; *) -&gt; * -&gt; *} {m :: * -&gt; *}.
(MonadState (Map (Namespace, Name) SrcLoc) (t m),
 MonadTypeChecker m, MonadTrans t) =&gt;
Namespace -&gt; Name -&gt; SrcLoc -&gt; t m VName
</span><a href="#local-6989586621684549314"><span class="hs-identifier hs-var">checkParamName</span></a></span><span> </span><span class="annot"><span class="annottext">Namespace
</span><a href="Language.Futhark.Semantic.html#Type"><span class="hs-identifier hs-var">Type</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684549287"><span class="hs-identifier hs-var">pv</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549286"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">t m (SrcLoc -&gt; TypeParam) -&gt; t m SrcLoc -&gt; t m TypeParam
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc -&gt; t m SrcLoc
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549286"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-443"></span><span>
</span><span id="line-444"></span><span class="hs-comment">-- | Construct a type argument corresponding to a type parameter.</span><span>
</span><span id="line-445"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#typeParamToArg"><span class="hs-identifier hs-type">typeParamToArg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.html#TypeParam"><span class="hs-identifier hs-type">TypeParam</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.html#StructTypeArg"><span class="hs-identifier hs-type">StructTypeArg</span></a></span><span>
</span><span id="line-446"></span><span id="typeParamToArg"><span class="annot"><span class="annottext">typeParamToArg :: TypeParam -&gt; StructTypeArg
</span><a href="Language.Futhark.TypeChecker.Types.html#typeParamToArg"><span class="hs-identifier hs-var hs-var">typeParamToArg</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeParamDim"><span class="hs-identifier hs-type">TypeParamDim</span></a></span><span> </span><span id="local-6989586621684549285"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684549285"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621684549284"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549284"><span class="hs-identifier hs-var">ploc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-447"></span><span>  </span><span class="annot"><span class="annottext">DimDecl VName -&gt; SrcLoc -&gt; StructTypeArg
forall dim. dim -&gt; SrcLoc -&gt; TypeArg dim
</span><a href="Language.Futhark.Syntax.html#TypeArgDim"><span class="hs-identifier hs-var">TypeArgDim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QualName VName -&gt; DimDecl VName
forall vn. QualName vn -&gt; DimDecl vn
</span><a href="Language.Futhark.Syntax.html#NamedDim"><span class="hs-identifier hs-var">NamedDim</span></a></span><span> </span><span class="annot"><span class="annottext">(QualName VName -&gt; DimDecl VName)
-&gt; QualName VName -&gt; DimDecl VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; QualName VName
forall v. v -&gt; QualName v
</span><a href="Language.Futhark.Prop.html#qualName"><span class="hs-identifier hs-var">qualName</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684549285"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549284"><span class="hs-identifier hs-var">ploc</span></a></span><span>
</span><span id="line-448"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#typeParamToArg"><span class="hs-identifier hs-var">typeParamToArg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeParamType"><span class="hs-identifier hs-type">TypeParamType</span></a></span><span> </span><span class="annot"><span class="annottext">Liftedness
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684549283"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684549283"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621684549282"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549282"><span class="hs-identifier hs-var">ploc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-449"></span><span>  </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) () -&gt; SrcLoc -&gt; StructTypeArg
forall dim. TypeBase dim () -&gt; SrcLoc -&gt; TypeArg dim
</span><a href="Language.Futhark.Syntax.html#TypeArgType"><span class="hs-identifier hs-var">TypeArgType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScalarTypeBase (DimDecl VName) () -&gt; TypeBase (DimDecl VName) ()
forall dim as. ScalarTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-var">Scalar</span></a></span><span> </span><span class="annot"><span class="annottext">(ScalarTypeBase (DimDecl VName) () -&gt; TypeBase (DimDecl VName) ())
-&gt; ScalarTypeBase (DimDecl VName) () -&gt; TypeBase (DimDecl VName) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">()
-&gt; Uniqueness
-&gt; TypeName
-&gt; [StructTypeArg]
-&gt; ScalarTypeBase (DimDecl VName) ()
forall dim as.
as
-&gt; Uniqueness -&gt; TypeName -&gt; [TypeArg dim] -&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#TypeVar"><span class="hs-identifier hs-var">TypeVar</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="Language.Futhark.Core.html#Nonunique"><span class="hs-identifier hs-var">Nonunique</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; TypeName
</span><a href="Language.Futhark.Prop.html#typeName"><span class="hs-identifier hs-var">typeName</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684549283"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684549282"><span class="hs-identifier hs-var">ploc</span></a></span><span>
</span><span id="line-450"></span><span>
</span><span id="line-451"></span><span class="hs-comment">-- | A type substitution may be a substitution or a yet-unknown</span><span>
</span><span id="line-452"></span><span class="hs-comment">-- substitution (but which is certainly an overloaded primitive</span><span>
</span><span id="line-453"></span><span class="hs-comment">-- type!).  The latter is used to remove aliases from types that are</span><span>
</span><span id="line-454"></span><span class="hs-comment">-- yet-unknown but that we know cannot carry aliases (see issue #682).</span><span>
</span><span id="line-455"></span><span class="hs-keyword">data</span><span> </span><span id="Subst"><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#Subst"><span class="hs-identifier hs-var">Subst</span></a></span></span><span> </span><span id="local-6989586621684550501"><span class="annot"><a href="#local-6989586621684550501"><span class="hs-identifier hs-type">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Subst"><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#Subst"><span class="hs-identifier hs-var">Subst</span></a></span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.html#TypeParam"><span class="hs-identifier hs-type">TypeParam</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><a href="#local-6989586621684550501"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="PrimSubst"><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#PrimSubst"><span class="hs-identifier hs-var">PrimSubst</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="SizeSubst"><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#SizeSubst"><span class="hs-identifier hs-var">SizeSubst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#DimDecl"><span class="hs-identifier hs-type">DimDecl</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-456"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684549265"><span id="local-6989586621684549267"><span id="local-6989586621684549278"><span class="annot"><span class="annottext">Int -&gt; Subst t -&gt; ShowS
[Subst t] -&gt; ShowS
Subst t -&gt; String
(Int -&gt; Subst t -&gt; ShowS)
-&gt; (Subst t -&gt; String) -&gt; ([Subst t] -&gt; ShowS) -&gt; Show (Subst t)
forall t. Show t =&gt; Int -&gt; Subst t -&gt; ShowS
forall t. Show t =&gt; [Subst t] -&gt; ShowS
forall t. Show t =&gt; Subst t -&gt; String
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [Subst t] -&gt; ShowS
$cshowList :: forall t. Show t =&gt; [Subst t] -&gt; ShowS
show :: Subst t -&gt; String
$cshow :: forall t. Show t =&gt; Subst t -&gt; String
showsPrec :: Int -&gt; Subst t -&gt; ShowS
$cshowsPrec :: forall t. Show t =&gt; Int -&gt; Subst t -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-457"></span><span>
</span><span id="line-458"></span><span id="local-6989586621684550327"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621684549257"><span id="local-6989586621684549259"><span class="annot"><span class="hs-identifier hs-type">Pretty</span></span><span> </span><span class="annot"><a href="#local-6989586621684550327"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Pretty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684550327"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-459"></span><span>  </span><span id="local-6989586621684549244"><span class="annot"><span class="annottext">ppr :: Subst t -&gt; Doc
</span><a href="#local-6989586621684549244"><span class="hs-identifier hs-var hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span id="local-6989586621684549243"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621684549243"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">t -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621684549243"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-460"></span><span>  </span><span class="annot"><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span id="local-6989586621684549242"><span class="annot"><span class="annottext">[TypeParam]
</span><a href="#local-6989586621684549242"><span class="hs-identifier hs-var">tps</span></a></span></span><span> </span><span id="local-6989586621684549241"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621684549241"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Doc] -&gt; Doc
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TypeParam -&gt; Doc) -&gt; [TypeParam] -&gt; [Doc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TypeParam -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">[TypeParam]
</span><a href="#local-6989586621684549242"><span class="hs-identifier hs-var">tps</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-identifier hs-var">colon</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">t -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621684549241"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-461"></span><span>  </span><span class="annot"><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">Subst t
</span><a href="Language.Futhark.TypeChecker.Types.html#PrimSubst"><span class="hs-identifier hs-var">PrimSubst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;#&lt;primsubst&gt;&quot;</span></span><span>
</span><span id="line-462"></span><span>  </span><span class="annot"><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#SizeSubst"><span class="hs-identifier hs-type">SizeSubst</span></a></span><span> </span><span id="local-6989586621684549239"><span class="annot"><span class="annottext">DimDecl VName
</span><a href="#local-6989586621684549239"><span class="hs-identifier hs-var">d</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DimDecl VName -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">DimDecl VName
</span><a href="#local-6989586621684549239"><span class="hs-identifier hs-var">d</span></a></span></span><span>
</span><span id="line-463"></span><span>
</span><span id="line-464"></span><span class="hs-comment">-- | Create a type substitution corresponding to a type binding.</span><span>
</span><span id="line-465"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#substFromAbbr"><span class="hs-identifier hs-type">substFromAbbr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Semantic.html#TypeBinding"><span class="hs-identifier hs-type">TypeBinding</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#StructRetType"><span class="hs-identifier hs-type">StructRetType</span></a></span><span>
</span><span id="line-466"></span><span id="substFromAbbr"><span class="annot"><span class="annottext">substFromAbbr :: TypeBinding -&gt; Subst StructRetType
</span><a href="Language.Futhark.TypeChecker.Types.html#substFromAbbr"><span class="hs-identifier hs-var hs-var">substFromAbbr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Semantic.html#TypeAbbr"><span class="hs-identifier hs-type">TypeAbbr</span></a></span><span> </span><span class="annot"><span class="annottext">Liftedness
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684549237"><span class="annot"><span class="annottext">[TypeParam]
</span><a href="#local-6989586621684549237"><span class="hs-identifier hs-var">ps</span></a></span></span><span> </span><span id="local-6989586621684549236"><span class="annot"><span class="annottext">StructRetType
</span><a href="#local-6989586621684549236"><span class="hs-identifier hs-var">rt</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TypeParam] -&gt; StructRetType -&gt; Subst StructRetType
forall t. [TypeParam] -&gt; t -&gt; Subst t
</span><a href="Language.Futhark.TypeChecker.Types.html#Subst"><span class="hs-identifier hs-var">Subst</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeParam]
</span><a href="#local-6989586621684549237"><span class="hs-identifier hs-var">ps</span></a></span><span> </span><span class="annot"><span class="annottext">StructRetType
</span><a href="#local-6989586621684549236"><span class="hs-identifier hs-var">rt</span></a></span><span>
</span><span id="line-467"></span><span>
</span><span id="line-468"></span><span class="hs-comment">-- | Substitutions to apply in a type.</span><span>
</span><span id="line-469"></span><span class="hs-keyword">type</span><span> </span><span id="TypeSubs"><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#TypeSubs"><span class="hs-identifier hs-var">TypeSubs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#StructRetType"><span class="hs-identifier hs-type">StructRetType</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-470"></span><span>
</span><span id="line-471"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621684549233"><span class="annot"><span class="hs-identifier hs-type">Functor</span></span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-472"></span><span>  </span><span id="local-6989586621684549231"><span class="annot"><span class="annottext">fmap :: forall a b. (a -&gt; b) -&gt; Subst a -&gt; Subst b
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">fmap</span></span></span><span> </span><span id="local-6989586621684549230"><span class="annot"><span class="annottext">a -&gt; b
</span><a href="#local-6989586621684549230"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span id="local-6989586621684549229"><span class="annot"><span class="annottext">[TypeParam]
</span><a href="#local-6989586621684549229"><span class="hs-identifier hs-var">ps</span></a></span></span><span> </span><span id="local-6989586621684549228"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684549228"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TypeParam] -&gt; b -&gt; Subst b
forall t. [TypeParam] -&gt; t -&gt; Subst t
</span><a href="Language.Futhark.TypeChecker.Types.html#Subst"><span class="hs-identifier hs-var">Subst</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeParam]
</span><a href="#local-6989586621684549229"><span class="hs-identifier hs-var">ps</span></a></span><span> </span><span class="annot"><span class="annottext">(b -&gt; Subst b) -&gt; b -&gt; Subst b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; b
</span><a href="#local-6989586621684549230"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684549228"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-473"></span><span>  </span><span class="annot"><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; b
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Subst a
</span><a href="Language.Futhark.TypeChecker.Types.html#PrimSubst"><span class="hs-identifier hs-var">PrimSubst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst b
forall t. Subst t
</span><a href="Language.Futhark.TypeChecker.Types.html#PrimSubst"><span class="hs-identifier hs-var">PrimSubst</span></a></span><span>
</span><span id="line-474"></span><span>  </span><span class="annot"><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; b
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#SizeSubst"><span class="hs-identifier hs-type">SizeSubst</span></a></span><span> </span><span id="local-6989586621684549227"><span class="annot"><span class="annottext">DimDecl VName
</span><a href="#local-6989586621684549227"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DimDecl VName -&gt; Subst b
forall t. DimDecl VName -&gt; Subst t
</span><a href="Language.Futhark.TypeChecker.Types.html#SizeSubst"><span class="hs-identifier hs-var">SizeSubst</span></a></span><span> </span><span class="annot"><span class="annottext">DimDecl VName
</span><a href="#local-6989586621684549227"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-475"></span><span>
</span><span id="line-476"></span><span class="hs-comment">-- | Class of types which allow for substitution of types with no</span><span>
</span><span id="line-477"></span><span class="hs-comment">-- annotations for type variable names.</span><span>
</span><span id="line-478"></span><span class="hs-keyword">class</span><span> </span><span id="Substitutable"><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#Substitutable"><span class="hs-identifier hs-var">Substitutable</span></a></span></span><span> </span><span id="local-6989586621684550492"><span class="annot"><a href="#local-6989586621684550492"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-479"></span><span>  </span><span id="applySubst"><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#applySubst"><span class="hs-identifier hs-type">applySubst</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#TypeSubs"><span class="hs-identifier hs-type">TypeSubs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684550492"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684550492"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-480"></span><span>
</span><span id="line-481"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#Substitutable"><span class="hs-identifier hs-type">Substitutable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#RetTypeBase"><span class="hs-identifier hs-type">RetTypeBase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#DimDecl"><span class="hs-identifier hs-type">DimDecl</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-482"></span><span>  </span><span id="local-6989586621684549223"><span class="annot"><span class="annottext">applySubst :: TypeSubs -&gt; StructRetType -&gt; StructRetType
</span><a href="#local-6989586621684549223"><span class="hs-identifier hs-var hs-var hs-var hs-var">applySubst</span></a></span></span><span> </span><span id="local-6989586621684549222"><span class="annot"><span class="annottext">TypeSubs
</span><a href="#local-6989586621684549222"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-type">RetType</span></a></span><span> </span><span id="local-6989586621684549221"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549221"><span class="hs-identifier hs-var">dims</span></a></span></span><span> </span><span id="local-6989586621684549220"><span class="annot"><span class="annottext">TypeBase (DimDecl VName) ()
</span><a href="#local-6989586621684549220"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-483"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-type">RetType</span></a></span><span> </span><span id="local-6989586621684549218"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549218"><span class="hs-identifier hs-var">more_dims</span></a></span></span><span> </span><span id="local-6989586621684549217"><span class="annot"><span class="annottext">TypeBase (DimDecl VName) ()
</span><a href="#local-6989586621684549217"><span class="hs-identifier hs-var">t'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeSubs -&gt; TypeBase (DimDecl VName) () -&gt; StructRetType
forall as.
Monoid as =&gt;
(VName -&gt; Maybe (Subst (RetTypeBase (DimDecl VName) as)))
-&gt; TypeBase (DimDecl VName) as -&gt; RetTypeBase (DimDecl VName) as
</span><a href="Language.Futhark.TypeChecker.Types.html#substTypesRet"><span class="hs-identifier hs-var">substTypesRet</span></a></span><span> </span><span class="annot"><span class="annottext">TypeSubs
</span><a href="#local-6989586621684549222"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) ()
</span><a href="#local-6989586621684549220"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-484"></span><span>     </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; TypeBase (DimDecl VName) () -&gt; StructRetType
forall dim as. [VName] -&gt; TypeBase dim as -&gt; RetTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-var">RetType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549221"><span class="hs-identifier hs-var">dims</span></a></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549218"><span class="hs-identifier hs-var">more_dims</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) ()
</span><a href="#local-6989586621684549217"><span class="hs-identifier hs-var">t'</span></a></span><span>
</span><span id="line-485"></span><span>
</span><span id="line-486"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#Substitutable"><span class="hs-identifier hs-type">Substitutable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#RetTypeBase"><span class="hs-identifier hs-type">RetTypeBase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#DimDecl"><span class="hs-identifier hs-type">DimDecl</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#Aliasing"><span class="hs-identifier hs-type">Aliasing</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-487"></span><span>  </span><span id="local-6989586621684549213"><span class="annot"><span class="annottext">applySubst :: TypeSubs
-&gt; RetTypeBase (DimDecl VName) Aliasing
-&gt; RetTypeBase (DimDecl VName) Aliasing
</span><a href="#local-6989586621684549213"><span class="hs-identifier hs-var hs-var hs-var hs-var">applySubst</span></a></span></span><span> </span><span id="local-6989586621684549212"><span class="annot"><span class="annottext">TypeSubs
</span><a href="#local-6989586621684549212"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-type">RetType</span></a></span><span> </span><span id="local-6989586621684549211"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549211"><span class="hs-identifier hs-var">dims</span></a></span></span><span> </span><span id="local-6989586621684549210"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684549210"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-488"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-type">RetType</span></a></span><span> </span><span id="local-6989586621684549205"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549205"><span class="hs-identifier hs-var">more_dims</span></a></span></span><span> </span><span id="local-6989586621684549204"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684549204"><span class="hs-identifier hs-var">t'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Maybe (Subst (RetTypeBase (DimDecl VName) Aliasing)))
-&gt; PatType -&gt; RetTypeBase (DimDecl VName) Aliasing
forall as.
Monoid as =&gt;
(VName -&gt; Maybe (Subst (RetTypeBase (DimDecl VName) as)))
-&gt; TypeBase (DimDecl VName) as -&gt; RetTypeBase (DimDecl VName) as
</span><a href="Language.Futhark.TypeChecker.Types.html#substTypesRet"><span class="hs-identifier hs-var">substTypesRet</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Maybe (Subst (RetTypeBase (DimDecl VName) Aliasing))
</span><a href="#local-6989586621684549203"><span class="hs-identifier hs-var">f'</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684549210"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-489"></span><span>     </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; PatType -&gt; RetTypeBase (DimDecl VName) Aliasing
forall dim as. [VName] -&gt; TypeBase dim as -&gt; RetTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-var">RetType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549211"><span class="hs-identifier hs-var">dims</span></a></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549205"><span class="hs-identifier hs-var">more_dims</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684549204"><span class="hs-identifier hs-var">t'</span></a></span><span>
</span><span id="line-490"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-491"></span><span>      </span><span id="local-6989586621684549203"><span class="annot"><span class="annottext">f' :: VName -&gt; Maybe (Subst (RetTypeBase (DimDecl VName) Aliasing))
</span><a href="#local-6989586621684549203"><span class="hs-identifier hs-var hs-var">f'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Subst StructRetType
 -&gt; Subst (RetTypeBase (DimDecl VName) Aliasing))
-&gt; Maybe (Subst StructRetType)
-&gt; Maybe (Subst (RetTypeBase (DimDecl VName) Aliasing))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(StructRetType -&gt; RetTypeBase (DimDecl VName) Aliasing)
-&gt; Subst StructRetType
-&gt; Subst (RetTypeBase (DimDecl VName) Aliasing)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(() -&gt; Aliasing)
-&gt; StructRetType -&gt; RetTypeBase (DimDecl VName) Aliasing
forall (p :: * -&gt; * -&gt; *) b c a.
Bifunctor p =&gt;
(b -&gt; c) -&gt; p a b -&gt; p a c
</span><span class="hs-identifier hs-var">second</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Aliasing -&gt; () -&gt; Aliasing
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">Aliasing
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe (Subst StructRetType)
 -&gt; Maybe (Subst (RetTypeBase (DimDecl VName) Aliasing)))
-&gt; TypeSubs
-&gt; VName
-&gt; Maybe (Subst (RetTypeBase (DimDecl VName) Aliasing))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TypeSubs
</span><a href="#local-6989586621684549212"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-492"></span><span>
</span><span id="line-493"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#Substitutable"><span class="hs-identifier hs-type">Substitutable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeBase"><span class="hs-identifier hs-type">TypeBase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#DimDecl"><span class="hs-identifier hs-type">DimDecl</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-494"></span><span>  </span><span id="local-6989586621684549192"><span class="annot"><span class="annottext">applySubst :: TypeSubs
-&gt; TypeBase (DimDecl VName) () -&gt; TypeBase (DimDecl VName) ()
</span><a href="#local-6989586621684549192"><span class="hs-identifier hs-var hs-var hs-var hs-var">applySubst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeSubs
-&gt; TypeBase (DimDecl VName) () -&gt; TypeBase (DimDecl VName) ()
forall as.
Monoid as =&gt;
(VName -&gt; Maybe (Subst (RetTypeBase (DimDecl VName) as)))
-&gt; TypeBase (DimDecl VName) as -&gt; TypeBase (DimDecl VName) as
</span><a href="Language.Futhark.TypeChecker.Types.html#substTypesAny"><span class="hs-identifier hs-var">substTypesAny</span></a></span><span>
</span><span id="line-495"></span><span>
</span><span id="line-496"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#Substitutable"><span class="hs-identifier hs-type">Substitutable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeBase"><span class="hs-identifier hs-type">TypeBase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#DimDecl"><span class="hs-identifier hs-type">DimDecl</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#Aliasing"><span class="hs-identifier hs-type">Aliasing</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-497"></span><span>  </span><span id="local-6989586621684549183"><span class="annot"><span class="annottext">applySubst :: TypeSubs -&gt; PatType -&gt; PatType
</span><a href="#local-6989586621684549183"><span class="hs-identifier hs-var hs-var hs-var hs-var">applySubst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Maybe (Subst (RetTypeBase (DimDecl VName) Aliasing)))
-&gt; PatType -&gt; PatType
forall as.
Monoid as =&gt;
(VName -&gt; Maybe (Subst (RetTypeBase (DimDecl VName) as)))
-&gt; TypeBase (DimDecl VName) as -&gt; TypeBase (DimDecl VName) as
</span><a href="Language.Futhark.TypeChecker.Types.html#substTypesAny"><span class="hs-identifier hs-var">substTypesAny</span></a></span><span> </span><span class="annot"><span class="annottext">((VName -&gt; Maybe (Subst (RetTypeBase (DimDecl VName) Aliasing)))
 -&gt; PatType -&gt; PatType)
-&gt; (TypeSubs
    -&gt; VName -&gt; Maybe (Subst (RetTypeBase (DimDecl VName) Aliasing)))
-&gt; TypeSubs
-&gt; PatType
-&gt; PatType
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Subst StructRetType
 -&gt; Subst (RetTypeBase (DimDecl VName) Aliasing))
-&gt; Maybe (Subst StructRetType)
-&gt; Maybe (Subst (RetTypeBase (DimDecl VName) Aliasing))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(StructRetType -&gt; RetTypeBase (DimDecl VName) Aliasing)
-&gt; Subst StructRetType
-&gt; Subst (RetTypeBase (DimDecl VName) Aliasing)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(() -&gt; Aliasing)
-&gt; StructRetType -&gt; RetTypeBase (DimDecl VName) Aliasing
forall (p :: * -&gt; * -&gt; *) b c a.
Bifunctor p =&gt;
(b -&gt; c) -&gt; p a b -&gt; p a c
</span><span class="hs-identifier hs-var">second</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Aliasing -&gt; () -&gt; Aliasing
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">Aliasing
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe (Subst StructRetType)
 -&gt; Maybe (Subst (RetTypeBase (DimDecl VName) Aliasing)))
-&gt; TypeSubs
-&gt; VName
-&gt; Maybe (Subst (RetTypeBase (DimDecl VName) Aliasing))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span class="hs-special">)</span><span>
</span><span id="line-498"></span><span>
</span><span id="line-499"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#Substitutable"><span class="hs-identifier hs-type">Substitutable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#DimDecl"><span class="hs-identifier hs-type">DimDecl</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-500"></span><span>  </span><span id="local-6989586621684549180"><span class="annot"><span class="annottext">applySubst :: TypeSubs -&gt; DimDecl VName -&gt; DimDecl VName
</span><a href="#local-6989586621684549180"><span class="hs-identifier hs-var hs-var hs-var hs-var">applySubst</span></a></span></span><span> </span><span id="local-6989586621684549179"><span class="annot"><span class="annottext">TypeSubs
</span><a href="#local-6989586621684549179"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#NamedDim"><span class="hs-identifier hs-type">NamedDim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#QualName"><span class="hs-identifier hs-type">QualName</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684549177"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684549177"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-501"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#SizeSubst"><span class="hs-identifier hs-type">SizeSubst</span></a></span><span> </span><span id="local-6989586621684549176"><span class="annot"><span class="annottext">DimDecl VName
</span><a href="#local-6989586621684549176"><span class="hs-identifier hs-var">d</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TypeSubs
</span><a href="#local-6989586621684549179"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684549177"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DimDecl VName
</span><a href="#local-6989586621684549176"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-502"></span><span>  </span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#applySubst"><span class="hs-identifier hs-var">applySubst</span></a></span><span> </span><span class="annot"><span class="annottext">TypeSubs
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684549175"><span class="annot"><span class="annottext">DimDecl VName
</span><a href="#local-6989586621684549175"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DimDecl VName
</span><a href="#local-6989586621684549175"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-503"></span><span>
</span><span id="line-504"></span><span id="local-6989586621684550306"><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#Substitutable"><span class="hs-identifier hs-type">Substitutable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684550306"><span class="hs-identifier hs-type">d</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#Substitutable"><span class="hs-identifier hs-type">Substitutable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#ShapeDecl"><span class="hs-identifier hs-type">ShapeDecl</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684550306"><span class="hs-identifier hs-type">d</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-505"></span><span>  </span><span id="local-6989586621684549168"><span class="annot"><span class="annottext">applySubst :: TypeSubs -&gt; ShapeDecl d -&gt; ShapeDecl d
</span><a href="#local-6989586621684549168"><span class="hs-identifier hs-var hs-var hs-var hs-var">applySubst</span></a></span></span><span> </span><span id="local-6989586621684549167"><span class="annot"><span class="annottext">TypeSubs
</span><a href="#local-6989586621684549167"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(d -&gt; d) -&gt; ShapeDecl d -&gt; ShapeDecl d
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">((d -&gt; d) -&gt; ShapeDecl d -&gt; ShapeDecl d)
-&gt; (d -&gt; d) -&gt; ShapeDecl d -&gt; ShapeDecl d
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TypeSubs -&gt; d -&gt; d
forall a. Substitutable a =&gt; TypeSubs -&gt; a -&gt; a
</span><a href="Language.Futhark.TypeChecker.Types.html#applySubst"><span class="hs-identifier hs-var">applySubst</span></a></span><span> </span><span class="annot"><span class="annottext">TypeSubs
</span><a href="#local-6989586621684549167"><span class="hs-identifier hs-var">f</span></a></span></span><span>
</span><span id="line-506"></span><span>
</span><span id="line-507"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#Substitutable"><span class="hs-identifier hs-type">Substitutable</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-508"></span><span>  </span><span id="local-6989586621684549160"><span class="annot"><span class="annottext">applySubst :: TypeSubs -&gt; Pat -&gt; Pat
</span><a href="#local-6989586621684549160"><span class="hs-identifier hs-var hs-var hs-var hs-var">applySubst</span></a></span></span><span> </span><span id="local-6989586621684549159"><span class="annot"><span class="annottext">TypeSubs
</span><a href="#local-6989586621684549159"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Identity Pat -&gt; Pat
forall a. Identity a -&gt; a
</span><span class="hs-identifier hs-var hs-var">runIdentity</span></span><span> </span><span class="annot"><span class="annottext">(Identity Pat -&gt; Pat) -&gt; (Pat -&gt; Identity Pat) -&gt; Pat -&gt; Pat
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ASTMapper Identity -&gt; Pat -&gt; Identity Pat
forall x (m :: * -&gt; *).
(ASTMappable x, Monad m) =&gt;
ASTMapper m -&gt; x -&gt; m x
</span><a href="Language.Futhark.Traversals.html#astMap"><span class="hs-identifier hs-var">astMap</span></a></span><span> </span><span class="annot"><span class="annottext">ASTMapper Identity
</span><a href="#local-6989586621684549156"><span class="hs-identifier hs-var">mapper</span></a></span><span>
</span><span id="line-509"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-510"></span><span>      </span><span id="local-6989586621684549156"><span class="annot"><span class="annottext">mapper :: ASTMapper Identity
</span><a href="#local-6989586621684549156"><span class="hs-identifier hs-var hs-var">mapper</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-511"></span><span>        </span><span class="annot"><span class="annottext">ASTMapper :: forall (m :: * -&gt; *).
(ExpBase Info VName -&gt; m (ExpBase Info VName))
-&gt; (VName -&gt; m VName)
-&gt; (QualName VName -&gt; m (QualName VName))
-&gt; (TypeBase (DimDecl VName) () -&gt; m (TypeBase (DimDecl VName) ()))
-&gt; (PatType -&gt; m PatType)
-&gt; (StructRetType -&gt; m StructRetType)
-&gt; (RetTypeBase (DimDecl VName) Aliasing
    -&gt; m (RetTypeBase (DimDecl VName) Aliasing))
-&gt; ASTMapper m
</span><a href="Language.Futhark.Traversals.html#ASTMapper"><span class="hs-identifier hs-type">ASTMapper</span></a></span><span>
</span><span id="line-512"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">mapOnExp :: ExpBase Info VName -&gt; Identity (ExpBase Info VName)
</span><a href="#local-6989586621684549142"><span class="hs-identifier hs-var">mapOnExp</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExpBase Info VName -&gt; Identity (ExpBase Info VName)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span class="hs-special">,</span><span>
</span><span id="line-513"></span><span>            </span><span class="annot"><span class="annottext">mapOnName :: VName -&gt; Identity VName
</span><a href="#local-6989586621684549141"><span class="hs-identifier hs-var">mapOnName</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Identity VName
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span class="hs-special">,</span><span>
</span><span id="line-514"></span><span>            </span><span class="annot"><span class="annottext">mapOnQualName :: QualName VName -&gt; Identity (QualName VName)
</span><a href="#local-6989586621684549140"><span class="hs-identifier hs-var">mapOnQualName</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QualName VName -&gt; Identity (QualName VName)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span class="hs-special">,</span><span>
</span><span id="line-515"></span><span>            </span><span class="annot"><span class="annottext">mapOnStructType :: TypeBase (DimDecl VName) ()
-&gt; Identity (TypeBase (DimDecl VName) ())
</span><a href="#local-6989586621684549139"><span class="hs-identifier hs-var">mapOnStructType</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) ()
-&gt; Identity (TypeBase (DimDecl VName) ())
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(TypeBase (DimDecl VName) ()
 -&gt; Identity (TypeBase (DimDecl VName) ()))
-&gt; (TypeBase (DimDecl VName) () -&gt; TypeBase (DimDecl VName) ())
-&gt; TypeBase (DimDecl VName) ()
-&gt; Identity (TypeBase (DimDecl VName) ())
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TypeSubs
-&gt; TypeBase (DimDecl VName) () -&gt; TypeBase (DimDecl VName) ()
forall a. Substitutable a =&gt; TypeSubs -&gt; a -&gt; a
</span><a href="Language.Futhark.TypeChecker.Types.html#applySubst"><span class="hs-identifier hs-var">applySubst</span></a></span><span> </span><span class="annot"><span class="annottext">TypeSubs
</span><a href="#local-6989586621684549159"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-516"></span><span>            </span><span class="annot"><span class="annottext">mapOnPatType :: PatType -&gt; Identity PatType
</span><a href="#local-6989586621684549138"><span class="hs-identifier hs-var">mapOnPatType</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatType -&gt; Identity PatType
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; Identity PatType)
-&gt; (PatType -&gt; PatType) -&gt; PatType -&gt; Identity PatType
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TypeSubs -&gt; PatType -&gt; PatType
forall a. Substitutable a =&gt; TypeSubs -&gt; a -&gt; a
</span><a href="Language.Futhark.TypeChecker.Types.html#applySubst"><span class="hs-identifier hs-var">applySubst</span></a></span><span> </span><span class="annot"><span class="annottext">TypeSubs
</span><a href="#local-6989586621684549159"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-517"></span><span>            </span><span class="annot"><span class="annottext">mapOnStructRetType :: StructRetType -&gt; Identity StructRetType
</span><a href="#local-6989586621684549137"><span class="hs-identifier hs-var">mapOnStructRetType</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StructRetType -&gt; Identity StructRetType
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(StructRetType -&gt; Identity StructRetType)
-&gt; (StructRetType -&gt; StructRetType)
-&gt; StructRetType
-&gt; Identity StructRetType
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TypeSubs -&gt; StructRetType -&gt; StructRetType
forall a. Substitutable a =&gt; TypeSubs -&gt; a -&gt; a
</span><a href="Language.Futhark.TypeChecker.Types.html#applySubst"><span class="hs-identifier hs-var">applySubst</span></a></span><span> </span><span class="annot"><span class="annottext">TypeSubs
</span><a href="#local-6989586621684549159"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-518"></span><span>            </span><span class="annot"><span class="annottext">mapOnPatRetType :: RetTypeBase (DimDecl VName) Aliasing
-&gt; Identity (RetTypeBase (DimDecl VName) Aliasing)
</span><a href="#local-6989586621684549136"><span class="hs-identifier hs-var">mapOnPatRetType</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RetTypeBase (DimDecl VName) Aliasing
-&gt; Identity (RetTypeBase (DimDecl VName) Aliasing)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(RetTypeBase (DimDecl VName) Aliasing
 -&gt; Identity (RetTypeBase (DimDecl VName) Aliasing))
-&gt; (RetTypeBase (DimDecl VName) Aliasing
    -&gt; RetTypeBase (DimDecl VName) Aliasing)
-&gt; RetTypeBase (DimDecl VName) Aliasing
-&gt; Identity (RetTypeBase (DimDecl VName) Aliasing)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TypeSubs
-&gt; RetTypeBase (DimDecl VName) Aliasing
-&gt; RetTypeBase (DimDecl VName) Aliasing
forall a. Substitutable a =&gt; TypeSubs -&gt; a -&gt; a
</span><a href="Language.Futhark.TypeChecker.Types.html#applySubst"><span class="hs-identifier hs-var">applySubst</span></a></span><span> </span><span class="annot"><span class="annottext">TypeSubs
</span><a href="#local-6989586621684549159"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-519"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-520"></span><span>
</span><span id="line-521"></span><span id="local-6989586621684550295"><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#applyType"><span class="hs-identifier hs-type">applyType</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-522"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Monoid</span></span><span> </span><span class="annot"><a href="#local-6989586621684550295"><span class="hs-identifier hs-type">als</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-523"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.html#TypeParam"><span class="hs-identifier hs-type">TypeParam</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-524"></span><span>  </span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeBase"><span class="hs-identifier hs-type">TypeBase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#DimDecl"><span class="hs-identifier hs-type">DimDecl</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621684550295"><span class="hs-identifier hs-type">als</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-525"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.html#StructTypeArg"><span class="hs-identifier hs-type">StructTypeArg</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-526"></span><span>  </span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeBase"><span class="hs-identifier hs-type">TypeBase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#DimDecl"><span class="hs-identifier hs-type">DimDecl</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621684550295"><span class="hs-identifier hs-type">als</span></a></span></span><span>
</span><span id="line-527"></span><span id="applyType"><span class="annot"><span class="annottext">applyType :: forall als.
Monoid als =&gt;
[TypeParam]
-&gt; TypeBase (DimDecl VName) als
-&gt; [StructTypeArg]
-&gt; TypeBase (DimDecl VName) als
</span><a href="Language.Futhark.TypeChecker.Types.html#applyType"><span class="hs-identifier hs-var hs-var">applyType</span></a></span></span><span> </span><span id="local-6989586621684549131"><span class="annot"><span class="annottext">[TypeParam]
</span><a href="#local-6989586621684549131"><span class="hs-identifier hs-var">ps</span></a></span></span><span> </span><span id="local-6989586621684549130"><span class="annot"><span class="annottext">TypeBase (DimDecl VName) als
</span><a href="#local-6989586621684549130"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621684549129"><span class="annot"><span class="annottext">[StructTypeArg]
</span><a href="#local-6989586621684549129"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Maybe (Subst (RetTypeBase (DimDecl VName) als)))
-&gt; TypeBase (DimDecl VName) als -&gt; TypeBase (DimDecl VName) als
forall as.
Monoid as =&gt;
(VName -&gt; Maybe (Subst (RetTypeBase (DimDecl VName) as)))
-&gt; TypeBase (DimDecl VName) as -&gt; TypeBase (DimDecl VName) as
</span><a href="Language.Futhark.TypeChecker.Types.html#substTypesAny"><span class="hs-identifier hs-var">substTypesAny</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
-&gt; Map VName (Subst (RetTypeBase (DimDecl VName) als))
-&gt; Maybe (Subst (RetTypeBase (DimDecl VName) als))
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-operator hs-var">`M.lookup`</span></span><span> </span><span class="annot"><span class="annottext">Map VName (Subst (RetTypeBase (DimDecl VName) als))
</span><a href="#local-6989586621684549128"><span class="hs-identifier hs-var">substs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) als
</span><a href="#local-6989586621684549130"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-528"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-529"></span><span>    </span><span id="local-6989586621684549128"><span class="annot"><span class="annottext">substs :: Map VName (Subst (RetTypeBase (DimDecl VName) als))
</span><a href="#local-6989586621684549128"><span class="hs-identifier hs-var hs-var">substs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VName, Subst (RetTypeBase (DimDecl VName) als))]
-&gt; Map VName (Subst (RetTypeBase (DimDecl VName) als))
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="annot"><span class="annottext">([(VName, Subst (RetTypeBase (DimDecl VName) als))]
 -&gt; Map VName (Subst (RetTypeBase (DimDecl VName) als)))
-&gt; [(VName, Subst (RetTypeBase (DimDecl VName) als))]
-&gt; Map VName (Subst (RetTypeBase (DimDecl VName) als))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(TypeParam
 -&gt; StructTypeArg
 -&gt; (VName, Subst (RetTypeBase (DimDecl VName) als)))
-&gt; [TypeParam]
-&gt; [StructTypeArg]
-&gt; [(VName, Subst (RetTypeBase (DimDecl VName) als))]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">TypeParam
-&gt; StructTypeArg
-&gt; (VName, Subst (RetTypeBase (DimDecl VName) als))
forall {as} {a}.
(Monoid as, Eq a, IsName a) =&gt;
TypeParamBase a
-&gt; StructTypeArg -&gt; (a, Subst (RetTypeBase (DimDecl VName) as))
</span><a href="#local-6989586621684549122"><span class="hs-identifier hs-var">mkSubst</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeParam]
</span><a href="#local-6989586621684549131"><span class="hs-identifier hs-var">ps</span></a></span><span> </span><span class="annot"><span class="annottext">[StructTypeArg]
</span><a href="#local-6989586621684549129"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-530"></span><span>    </span><span class="hs-comment">-- We are assuming everything has already been type-checked for correctness.</span><span>
</span><span id="line-531"></span><span>    </span><span id="local-6989586621684549122"><span class="annot"><span class="annottext">mkSubst :: TypeParamBase a
-&gt; StructTypeArg -&gt; (a, Subst (RetTypeBase (DimDecl VName) as))
</span><a href="#local-6989586621684549122"><span class="hs-identifier hs-var hs-var">mkSubst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeParamDim"><span class="hs-identifier hs-type">TypeParamDim</span></a></span><span> </span><span id="local-6989586621684549100"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684549100"><span class="hs-identifier hs-var">pv</span></a></span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeArgDim"><span class="hs-identifier hs-type">TypeArgDim</span></a></span><span> </span><span id="local-6989586621684549099"><span class="annot"><span class="annottext">DimDecl VName
</span><a href="#local-6989586621684549099"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-532"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684549100"><span class="hs-identifier hs-var">pv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DimDecl VName -&gt; Subst (RetTypeBase (DimDecl VName) as)
forall t. DimDecl VName -&gt; Subst t
</span><a href="Language.Futhark.TypeChecker.Types.html#SizeSubst"><span class="hs-identifier hs-var">SizeSubst</span></a></span><span> </span><span class="annot"><span class="annottext">DimDecl VName
</span><a href="#local-6989586621684549099"><span class="hs-identifier hs-var">d</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-533"></span><span>    </span><span class="annot"><a href="#local-6989586621684549122"><span class="hs-identifier hs-var">mkSubst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeParamType"><span class="hs-identifier hs-type">TypeParamType</span></a></span><span> </span><span class="annot"><span class="annottext">Liftedness
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684549098"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684549098"><span class="hs-identifier hs-var">pv</span></a></span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeArgType"><span class="hs-identifier hs-type">TypeArgType</span></a></span><span> </span><span id="local-6989586621684549097"><span class="annot"><span class="annottext">TypeBase (DimDecl VName) ()
</span><a href="#local-6989586621684549097"><span class="hs-identifier hs-var">at</span></a></span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-534"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684549098"><span class="hs-identifier hs-var">pv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TypeParam]
-&gt; RetTypeBase (DimDecl VName) as
-&gt; Subst (RetTypeBase (DimDecl VName) as)
forall t. [TypeParam] -&gt; t -&gt; Subst t
</span><a href="Language.Futhark.TypeChecker.Types.html#Subst"><span class="hs-identifier hs-var">Subst</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(RetTypeBase (DimDecl VName) as
 -&gt; Subst (RetTypeBase (DimDecl VName) as))
-&gt; RetTypeBase (DimDecl VName) as
-&gt; Subst (RetTypeBase (DimDecl VName) as)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName]
-&gt; TypeBase (DimDecl VName) as -&gt; RetTypeBase (DimDecl VName) as
forall dim as. [VName] -&gt; TypeBase dim as -&gt; RetTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-var">RetType</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(TypeBase (DimDecl VName) as -&gt; RetTypeBase (DimDecl VName) as)
-&gt; TypeBase (DimDecl VName) as -&gt; RetTypeBase (DimDecl VName) as
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(() -&gt; as)
-&gt; TypeBase (DimDecl VName) () -&gt; TypeBase (DimDecl VName) as
forall (p :: * -&gt; * -&gt; *) b c a.
Bifunctor p =&gt;
(b -&gt; c) -&gt; p a b -&gt; p a c
</span><span class="hs-identifier hs-var">second</span></span><span> </span><span class="annot"><span class="annottext">() -&gt; as
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) ()
</span><a href="#local-6989586621684549097"><span class="hs-identifier hs-var">at</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-535"></span><span>    </span><span class="annot"><a href="#local-6989586621684549122"><span class="hs-identifier hs-var">mkSubst</span></a></span><span> </span><span id="local-6989586621684549096"><span class="annot"><span class="annottext">TypeParamBase a
</span><a href="#local-6989586621684549096"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621684549095"><span class="annot"><span class="annottext">StructTypeArg
</span><a href="#local-6989586621684549095"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-536"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; (a, Subst (RetTypeBase (DimDecl VName) as))
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; (a, Subst (RetTypeBase (DimDecl VName) as)))
-&gt; String -&gt; (a, Subst (RetTypeBase (DimDecl VName) as))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;applyType mkSubst: cannot substitute &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">StructTypeArg -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">StructTypeArg
</span><a href="#local-6989586621684549095"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; for &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">TypeParamBase a -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">TypeParamBase a
</span><a href="#local-6989586621684549096"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-537"></span><span>
</span><span id="line-538"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#substTypesRet"><span class="hs-identifier hs-type">substTypesRet</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-539"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621684550320"><span class="annot"><a href="#local-6989586621684550320"><span class="hs-keyword hs-type">as</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-540"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Monoid</span></span><span> </span><span class="annot"><a href="#local-6989586621684550320"><span class="hs-keyword hs-type">as</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-541"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#RetTypeBase"><span class="hs-identifier hs-type">RetTypeBase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#DimDecl"><span class="hs-identifier hs-type">DimDecl</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621684550320"><span class="hs-keyword hs-type">as</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-542"></span><span>  </span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeBase"><span class="hs-identifier hs-type">TypeBase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#DimDecl"><span class="hs-identifier hs-type">DimDecl</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621684550320"><span class="hs-keyword hs-type">as</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-543"></span><span>  </span><span class="annot"><a href="Language.Futhark.Syntax.html#RetTypeBase"><span class="hs-identifier hs-type">RetTypeBase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#DimDecl"><span class="hs-identifier hs-type">DimDecl</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621684550320"><span class="hs-keyword hs-type">as</span></a></span><span>
</span><span id="line-544"></span><span id="substTypesRet"><span class="annot"><span class="annottext">substTypesRet :: forall as.
Monoid as =&gt;
(VName -&gt; Maybe (Subst (RetTypeBase (DimDecl VName) as)))
-&gt; TypeBase (DimDecl VName) as -&gt; RetTypeBase (DimDecl VName) as
</span><a href="Language.Futhark.TypeChecker.Types.html#substTypesRet"><span class="hs-identifier hs-var hs-var">substTypesRet</span></a></span></span><span> </span><span id="local-6989586621684549045"><span class="annot"><span class="annottext">VName -&gt; Maybe (Subst (RetTypeBase (DimDecl VName) as))
</span><a href="#local-6989586621684549045"><span class="hs-identifier hs-var">lookupSubst</span></a></span></span><span> </span><span id="local-6989586621684549044"><span class="annot"><span class="annottext">TypeBase (DimDecl VName) as
</span><a href="#local-6989586621684549044"><span class="hs-identifier hs-var">ot</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-545"></span><span>  </span><span class="annot"><span class="annottext">(TypeBase (DimDecl VName) as
 -&gt; [VName] -&gt; RetTypeBase (DimDecl VName) as)
-&gt; (TypeBase (DimDecl VName) as, [VName])
-&gt; RetTypeBase (DimDecl VName) as
forall a b c. (a -&gt; b -&gt; c) -&gt; (a, b) -&gt; c
</span><span class="hs-identifier hs-var">uncurry</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">([VName]
 -&gt; TypeBase (DimDecl VName) as -&gt; RetTypeBase (DimDecl VName) as)
-&gt; TypeBase (DimDecl VName) as
-&gt; [VName]
-&gt; RetTypeBase (DimDecl VName) as
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
-&gt; TypeBase (DimDecl VName) as -&gt; RetTypeBase (DimDecl VName) as
forall dim as. [VName] -&gt; TypeBase dim as -&gt; RetTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-var">RetType</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((TypeBase (DimDecl VName) as, [VName])
 -&gt; RetTypeBase (DimDecl VName) as)
-&gt; (TypeBase (DimDecl VName) as, [VName])
-&gt; RetTypeBase (DimDecl VName) as
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">State [VName] (TypeBase (DimDecl VName) as)
-&gt; [VName] -&gt; (TypeBase (DimDecl VName) as, [VName])
forall s a. State s a -&gt; s -&gt; (a, s)
</span><span class="hs-identifier hs-var">runState</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) as
-&gt; State [VName] (TypeBase (DimDecl VName) as)
</span><a href="#local-6989586621684549042"><span class="hs-identifier hs-var">onType</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) as
</span><a href="#local-6989586621684549044"><span class="hs-identifier hs-var">ot</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-546"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-547"></span><span>    </span><span class="hs-comment">-- In case we are substituting the same RetType in multiple</span><span>
</span><span id="line-548"></span><span>    </span><span class="hs-comment">-- places, we must ensure each instance is given distinct</span><span>
</span><span id="line-549"></span><span>    </span><span class="hs-comment">-- dimensions.  E.g. substituting 'a &#8614; ?[n].[n]bool' into '(a,a)'</span><span>
</span><span id="line-550"></span><span>    </span><span class="hs-comment">-- should give '?[n][m].([n]bool,[m]bool)'.</span><span>
</span><span id="line-551"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-552"></span><span>    </span><span class="hs-comment">-- XXX: the size names we invent here not globally unique.  This</span><span>
</span><span id="line-553"></span><span>    </span><span class="hs-comment">-- is _probably_ not a problem, since substituting types with</span><span>
</span><span id="line-554"></span><span>    </span><span class="hs-comment">-- outermost non-null existential sizes is done only when type</span><span>
</span><span id="line-555"></span><span>    </span><span class="hs-comment">-- checking modules.</span><span>
</span><span id="line-556"></span><span>    </span><span id="local-6989586621684549029"><span class="annot"><span class="annottext">freshDims :: RetTypeBase (DimDecl VName) as
-&gt; f (RetTypeBase (DimDecl VName) as)
</span><a href="#local-6989586621684549029"><span class="hs-identifier hs-var hs-var">freshDims</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-type">RetType</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span id="local-6989586621684549028"><span class="annot"><span class="annottext">TypeBase (DimDecl VName) as
</span><a href="#local-6989586621684549028"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RetTypeBase (DimDecl VName) as
-&gt; f (RetTypeBase (DimDecl VName) as)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(RetTypeBase (DimDecl VName) as
 -&gt; f (RetTypeBase (DimDecl VName) as))
-&gt; RetTypeBase (DimDecl VName) as
-&gt; f (RetTypeBase (DimDecl VName) as)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName]
-&gt; TypeBase (DimDecl VName) as -&gt; RetTypeBase (DimDecl VName) as
forall dim as. [VName] -&gt; TypeBase dim as -&gt; RetTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-var">RetType</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) as
</span><a href="#local-6989586621684549028"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-557"></span><span>    </span><span class="annot"><a href="#local-6989586621684549029"><span class="hs-identifier hs-var">freshDims</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-type">RetType</span></a></span><span> </span><span id="local-6989586621684549027"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549027"><span class="hs-identifier hs-var">ext</span></a></span></span><span> </span><span id="local-6989586621684549026"><span class="annot"><span class="annottext">TypeBase (DimDecl VName) as
</span><a href="#local-6989586621684549026"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-558"></span><span>      </span><span id="local-6989586621684549025"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549025"><span class="hs-identifier hs-var">seen_ext</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">f [VName]
forall s (m :: * -&gt; *). MonadState s m =&gt; m s
</span><span class="hs-identifier hs-var">get</span></span><span>
</span><span id="line-559"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Bool) -&gt; [VName] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; [VName] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549025"><span class="hs-identifier hs-var">seen_ext</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549027"><span class="hs-identifier hs-var">ext</span></a></span><span>
</span><span id="line-560"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">RetTypeBase (DimDecl VName) as
-&gt; f (RetTypeBase (DimDecl VName) as)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(RetTypeBase (DimDecl VName) as
 -&gt; f (RetTypeBase (DimDecl VName) as))
-&gt; RetTypeBase (DimDecl VName) as
-&gt; f (RetTypeBase (DimDecl VName) as)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName]
-&gt; TypeBase (DimDecl VName) as -&gt; RetTypeBase (DimDecl VName) as
forall dim as. [VName] -&gt; TypeBase dim as -&gt; RetTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-var">RetType</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549027"><span class="hs-identifier hs-var">ext</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) as
</span><a href="#local-6989586621684549026"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-561"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-562"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684549019"><span class="annot"><span class="annottext">start :: Int
</span><a href="#local-6989586621684549019"><span class="hs-identifier hs-var hs-var">start</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; Int
forall (t :: * -&gt; *) a. (Foldable t, Ord a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">maximum</span></span><span> </span><span class="annot"><span class="annottext">([Int] -&gt; Int) -&gt; [Int] -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Int) -&gt; [VName] -&gt; [Int]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Int
</span><a href="Language.Futhark.Core.html#baseTag"><span class="hs-identifier hs-var">baseTag</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549025"><span class="hs-identifier hs-var">seen_ext</span></a></span><span>
</span><span id="line-563"></span><span>              </span><span id="local-6989586621684549012"><span class="annot"><span class="annottext">ext' :: [VName]
</span><a href="#local-6989586621684549012"><span class="hs-identifier hs-var hs-var">ext'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; Int -&gt; VName) -&gt; [Name] -&gt; [Int] -&gt; [VName]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Int -&gt; VName
</span><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-var">VName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(VName -&gt; Name) -&gt; [VName] -&gt; [Name]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Name
</span><a href="Language.Futhark.Core.html#baseName"><span class="hs-identifier hs-var">baseName</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549027"><span class="hs-identifier hs-var">ext</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684549019"><span class="hs-identifier hs-var">start</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">..</span><span class="hs-special">]</span><span>
</span><span id="line-564"></span><span>              </span><span id="local-6989586621684549007"><span class="annot"><span class="annottext">extsubsts :: Map VName (Subst t)
</span><a href="#local-6989586621684549007"><span class="hs-identifier hs-var hs-var">extsubsts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VName, Subst t)] -&gt; Map VName (Subst t)
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="annot"><span class="annottext">([(VName, Subst t)] -&gt; Map VName (Subst t))
-&gt; [(VName, Subst t)] -&gt; Map VName (Subst t)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [Subst t] -&gt; [(VName, Subst t)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549027"><span class="hs-identifier hs-var">ext</span></a></span><span> </span><span class="annot"><span class="annottext">([Subst t] -&gt; [(VName, Subst t)])
-&gt; [Subst t] -&gt; [(VName, Subst t)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Subst t) -&gt; [VName] -&gt; [Subst t]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DimDecl VName -&gt; Subst t
forall t. DimDecl VName -&gt; Subst t
</span><a href="Language.Futhark.TypeChecker.Types.html#SizeSubst"><span class="hs-identifier hs-var">SizeSubst</span></a></span><span> </span><span class="annot"><span class="annottext">(DimDecl VName -&gt; Subst t)
-&gt; (VName -&gt; DimDecl VName) -&gt; VName -&gt; Subst t
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">QualName VName -&gt; DimDecl VName
forall vn. QualName vn -&gt; DimDecl vn
</span><a href="Language.Futhark.Syntax.html#NamedDim"><span class="hs-identifier hs-var">NamedDim</span></a></span><span> </span><span class="annot"><span class="annottext">(QualName VName -&gt; DimDecl VName)
-&gt; (VName -&gt; QualName VName) -&gt; VName -&gt; DimDecl VName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; QualName VName
forall v. v -&gt; QualName v
</span><a href="Language.Futhark.Prop.html#qualName"><span class="hs-identifier hs-var">qualName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549012"><span class="hs-identifier hs-var">ext'</span></a></span><span>
</span><span id="line-565"></span><span>              </span><span class="annot"><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-type">RetType</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span id="local-6989586621684549004"><span class="annot"><span class="annottext">TypeBase (DimDecl VName) as
</span><a href="#local-6989586621684549004"><span class="hs-identifier hs-var">t'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Maybe (Subst (RetTypeBase (DimDecl VName) as)))
-&gt; TypeBase (DimDecl VName) as -&gt; RetTypeBase (DimDecl VName) as
forall as.
Monoid as =&gt;
(VName -&gt; Maybe (Subst (RetTypeBase (DimDecl VName) as)))
-&gt; TypeBase (DimDecl VName) as -&gt; RetTypeBase (DimDecl VName) as
</span><a href="Language.Futhark.TypeChecker.Types.html#substTypesRet"><span class="hs-identifier hs-var">substTypesRet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
-&gt; Map VName (Subst (RetTypeBase (DimDecl VName) as))
-&gt; Maybe (Subst (RetTypeBase (DimDecl VName) as))
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-operator hs-var">`M.lookup`</span></span><span> </span><span class="annot"><span class="annottext">Map VName (Subst (RetTypeBase (DimDecl VName) as))
forall {t}. Map VName (Subst t)
</span><a href="#local-6989586621684549007"><span class="hs-identifier hs-var">extsubsts</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) as
</span><a href="#local-6989586621684549026"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-566"></span><span>          </span><span class="annot"><span class="annottext">RetTypeBase (DimDecl VName) as
-&gt; f (RetTypeBase (DimDecl VName) as)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(RetTypeBase (DimDecl VName) as
 -&gt; f (RetTypeBase (DimDecl VName) as))
-&gt; RetTypeBase (DimDecl VName) as
-&gt; f (RetTypeBase (DimDecl VName) as)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName]
-&gt; TypeBase (DimDecl VName) as -&gt; RetTypeBase (DimDecl VName) as
forall dim as. [VName] -&gt; TypeBase dim as -&gt; RetTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-var">RetType</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684549012"><span class="hs-identifier hs-var">ext'</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) as
</span><a href="#local-6989586621684549004"><span class="hs-identifier hs-var">t'</span></a></span><span>
</span><span id="line-567"></span><span>
</span><span id="line-568"></span><span>    </span><span class="annot"><a href="#local-6989586621684549042"><span class="hs-identifier hs-type">onType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeBase"><span class="hs-identifier hs-type">TypeBase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#DimDecl"><span class="hs-identifier hs-type">DimDecl</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621684550320"><span class="hs-keyword hs-type">as</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">State</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeBase"><span class="hs-identifier hs-type">TypeBase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#DimDecl"><span class="hs-identifier hs-type">DimDecl</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621684550320"><span class="hs-keyword hs-type">as</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-569"></span><span>
</span><span id="line-570"></span><span>    </span><span id="local-6989586621684549042"><span class="annot"><span class="annottext">onType :: TypeBase (DimDecl VName) as
-&gt; State [VName] (TypeBase (DimDecl VName) as)
</span><a href="#local-6989586621684549042"><span class="hs-identifier hs-var hs-var">onType</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span id="local-6989586621684549003"><span class="annot"><span class="annottext">as
</span><a href="#local-6989586621684549003"><span class="hs-identifier hs-var">als</span></a></span></span><span> </span><span id="local-6989586621684549002"><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684549002"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span id="local-6989586621684549001"><span class="annot"><span class="annottext">ScalarTypeBase (DimDecl VName) ()
</span><a href="#local-6989586621684549001"><span class="hs-identifier hs-var">et</span></a></span></span><span> </span><span id="local-6989586621684549000"><span class="annot"><span class="annottext">ShapeDecl (DimDecl VName)
</span><a href="#local-6989586621684549000"><span class="hs-identifier hs-var">shape</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-571"></span><span>      </span><span id="local-6989586621684548999"><span class="annot"><span class="annottext">TypeBase (DimDecl VName) as
</span><a href="#local-6989586621684548999"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-572"></span><span>        </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) as
-&gt; ShapeDecl (DimDecl VName)
-&gt; Uniqueness
-&gt; TypeBase (DimDecl VName) as
forall as dim.
Monoid as =&gt;
TypeBase dim as -&gt; ShapeDecl dim -&gt; Uniqueness -&gt; TypeBase dim as
</span><a href="Language.Futhark.Prop.html#arrayOf"><span class="hs-identifier hs-var">arrayOf</span></a></span><span> </span><span class="annot"><span class="annottext">(TypeBase (DimDecl VName) as
 -&gt; ShapeDecl (DimDecl VName)
 -&gt; Uniqueness
 -&gt; TypeBase (DimDecl VName) as)
-&gt; State [VName] (TypeBase (DimDecl VName) as)
-&gt; StateT
     [VName]
     Identity
     (ShapeDecl (DimDecl VName)
      -&gt; Uniqueness -&gt; TypeBase (DimDecl VName) as)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) as
-&gt; State [VName] (TypeBase (DimDecl VName) as)
</span><a href="#local-6989586621684549042"><span class="hs-identifier hs-var">onType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScalarTypeBase (DimDecl VName) () -&gt; TypeBase (DimDecl VName) ()
forall dim as. ScalarTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-var">Scalar</span></a></span><span> </span><span class="annot"><span class="annottext">ScalarTypeBase (DimDecl VName) ()
</span><a href="#local-6989586621684549001"><span class="hs-identifier hs-var">et</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) () -&gt; as -&gt; TypeBase (DimDecl VName) as
forall dim asf ast. TypeBase dim asf -&gt; ast -&gt; TypeBase dim ast
</span><a href="Language.Futhark.Prop.html#setAliases"><span class="hs-operator hs-var">`setAliases`</span></a></span><span> </span><span class="annot"><span class="annottext">as
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span>
</span><span id="line-573"></span><span>          </span><span class="annot"><span class="annottext">StateT
  [VName]
  Identity
  (ShapeDecl (DimDecl VName)
   -&gt; Uniqueness -&gt; TypeBase (DimDecl VName) as)
-&gt; StateT [VName] Identity (ShapeDecl (DimDecl VName))
-&gt; StateT
     [VName] Identity (Uniqueness -&gt; TypeBase (DimDecl VName) as)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">ShapeDecl (DimDecl VName)
-&gt; StateT [VName] Identity (ShapeDecl (DimDecl VName))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeSubs -&gt; ShapeDecl (DimDecl VName) -&gt; ShapeDecl (DimDecl VName)
forall a. Substitutable a =&gt; TypeSubs -&gt; a -&gt; a
</span><a href="Language.Futhark.TypeChecker.Types.html#applySubst"><span class="hs-identifier hs-var">applySubst</span></a></span><span> </span><span class="annot"><span class="annottext">TypeSubs
</span><a href="#local-6989586621684548997"><span class="hs-identifier hs-var">lookupSubst'</span></a></span><span> </span><span class="annot"><span class="annottext">ShapeDecl (DimDecl VName)
</span><a href="#local-6989586621684549000"><span class="hs-identifier hs-var">shape</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-574"></span><span>          </span><span class="annot"><span class="annottext">StateT [VName] Identity (Uniqueness -&gt; TypeBase (DimDecl VName) as)
-&gt; StateT [VName] Identity Uniqueness
-&gt; State [VName] (TypeBase (DimDecl VName) as)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Uniqueness -&gt; StateT [VName] Identity Uniqueness
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684549002"><span class="hs-identifier hs-var">u</span></a></span><span>
</span><span id="line-575"></span><span>      </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) as
-&gt; State [VName] (TypeBase (DimDecl VName) as)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(TypeBase (DimDecl VName) as
 -&gt; State [VName] (TypeBase (DimDecl VName) as))
-&gt; TypeBase (DimDecl VName) as
-&gt; State [VName] (TypeBase (DimDecl VName) as)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) as
</span><a href="#local-6989586621684548999"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) as -&gt; as -&gt; TypeBase (DimDecl VName) as
forall dim asf ast. TypeBase dim asf -&gt; ast -&gt; TypeBase dim ast
</span><a href="Language.Futhark.Prop.html#setAliases"><span class="hs-operator hs-var">`setAliases`</span></a></span><span> </span><span class="annot"><span class="annottext">as
</span><a href="#local-6989586621684549003"><span class="hs-identifier hs-var">als</span></a></span><span>
</span><span id="line-576"></span><span>    </span><span class="annot"><a href="#local-6989586621684549042"><span class="hs-identifier hs-var">onType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Prim"><span class="hs-identifier hs-type">Prim</span></a></span><span> </span><span id="local-6989586621684548996"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684548996"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) as
-&gt; State [VName] (TypeBase (DimDecl VName) as)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(TypeBase (DimDecl VName) as
 -&gt; State [VName] (TypeBase (DimDecl VName) as))
-&gt; TypeBase (DimDecl VName) as
-&gt; State [VName] (TypeBase (DimDecl VName) as)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ScalarTypeBase (DimDecl VName) as -&gt; TypeBase (DimDecl VName) as
forall dim as. ScalarTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-var">Scalar</span></a></span><span> </span><span class="annot"><span class="annottext">(ScalarTypeBase (DimDecl VName) as -&gt; TypeBase (DimDecl VName) as)
-&gt; ScalarTypeBase (DimDecl VName) as -&gt; TypeBase (DimDecl VName) as
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; ScalarTypeBase (DimDecl VName) as
forall dim as. PrimType -&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684548996"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-577"></span><span>    </span><span class="annot"><a href="#local-6989586621684549042"><span class="hs-identifier hs-var">onType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeVar"><span class="hs-identifier hs-type">TypeVar</span></a></span><span> </span><span id="local-6989586621684548995"><span class="annot"><span class="annottext">as
</span><a href="#local-6989586621684548995"><span class="hs-identifier hs-var">als</span></a></span></span><span> </span><span id="local-6989586621684548994"><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684548994"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span id="local-6989586621684548993"><span class="annot"><span class="annottext">TypeName
</span><a href="#local-6989586621684548993"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621684548992"><span class="annot"><span class="annottext">[StructTypeArg]
</span><a href="#local-6989586621684548992"><span class="hs-identifier hs-var">targs</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-578"></span><span>      </span><span id="local-6989586621684548991"><span class="annot"><span class="annottext">[StructTypeArg]
</span><a href="#local-6989586621684548991"><span class="hs-identifier hs-var">targs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(StructTypeArg -&gt; StateT [VName] Identity StructTypeArg)
-&gt; [StructTypeArg] -&gt; StateT [VName] Identity [StructTypeArg]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">StructTypeArg -&gt; StateT [VName] Identity StructTypeArg
forall {m :: * -&gt; *}.
MonadState [VName] m =&gt;
StructTypeArg -&gt; m StructTypeArg
</span><a href="#local-6989586621684548990"><span class="hs-identifier hs-var">subsTypeArg</span></a></span><span> </span><span class="annot"><span class="annottext">[StructTypeArg]
</span><a href="#local-6989586621684548992"><span class="hs-identifier hs-var">targs</span></a></span><span>
</span><span id="line-579"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Maybe (Subst (RetTypeBase (DimDecl VName) as))
</span><a href="#local-6989586621684549045"><span class="hs-identifier hs-var">lookupSubst</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Maybe (Subst (RetTypeBase (DimDecl VName) as)))
-&gt; VName -&gt; Maybe (Subst (RetTypeBase (DimDecl VName) as))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">QualName VName -&gt; VName
forall vn. QualName vn -&gt; vn
</span><a href="Language.Futhark.Syntax.html#qualLeaf"><span class="hs-identifier hs-var hs-var">qualLeaf</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeName -&gt; QualName VName
</span><a href="Language.Futhark.Syntax.html#qualNameFromTypeName"><span class="hs-identifier hs-var">qualNameFromTypeName</span></a></span><span> </span><span class="annot"><span class="annottext">TypeName
</span><a href="#local-6989586621684548993"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-580"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span id="local-6989586621684548987"><span class="annot"><span class="annottext">[TypeParam]
</span><a href="#local-6989586621684548987"><span class="hs-identifier hs-var">ps</span></a></span></span><span> </span><span id="local-6989586621684548986"><span class="annot"><span class="annottext">RetTypeBase (DimDecl VName) as
</span><a href="#local-6989586621684548986"><span class="hs-identifier hs-var">rt</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-581"></span><span>          </span><span class="annot"><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-type">RetType</span></a></span><span> </span><span id="local-6989586621684548985"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684548985"><span class="hs-identifier hs-var">ext</span></a></span></span><span> </span><span id="local-6989586621684548984"><span class="annot"><span class="annottext">TypeBase (DimDecl VName) as
</span><a href="#local-6989586621684548984"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RetTypeBase (DimDecl VName) as
-&gt; StateT [VName] Identity (RetTypeBase (DimDecl VName) as)
forall {f :: * -&gt; *} {as}.
(MonadState [VName] f, Monoid as) =&gt;
RetTypeBase (DimDecl VName) as
-&gt; f (RetTypeBase (DimDecl VName) as)
</span><a href="#local-6989586621684549029"><span class="hs-identifier hs-var">freshDims</span></a></span><span> </span><span class="annot"><span class="annottext">RetTypeBase (DimDecl VName) as
</span><a href="#local-6989586621684548986"><span class="hs-identifier hs-var">rt</span></a></span><span>
</span><span id="line-582"></span><span>          </span><span class="annot"><span class="annottext">([VName] -&gt; [VName]) -&gt; StateT [VName] Identity ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684548985"><span class="hs-identifier hs-var">ext</span></a></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span class="hs-special">)</span><span>
</span><span id="line-583"></span><span>          </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) as
-&gt; State [VName] (TypeBase (DimDecl VName) as)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(TypeBase (DimDecl VName) as
 -&gt; State [VName] (TypeBase (DimDecl VName) as))
-&gt; TypeBase (DimDecl VName) as
-&gt; State [VName] (TypeBase (DimDecl VName) as)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-584"></span><span>            </span><span class="annot"><span class="annottext">[TypeParam]
-&gt; TypeBase (DimDecl VName) as
-&gt; [StructTypeArg]
-&gt; TypeBase (DimDecl VName) as
forall als.
Monoid als =&gt;
[TypeParam]
-&gt; TypeBase (DimDecl VName) als
-&gt; [StructTypeArg]
-&gt; TypeBase (DimDecl VName) als
</span><a href="Language.Futhark.TypeChecker.Types.html#applyType"><span class="hs-identifier hs-var">applyType</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeParam]
</span><a href="#local-6989586621684548987"><span class="hs-identifier hs-var">ps</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) as
</span><a href="#local-6989586621684548984"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) as -&gt; as -&gt; TypeBase (DimDecl VName) as
forall dim asf ast. TypeBase dim asf -&gt; ast -&gt; TypeBase dim ast
</span><a href="Language.Futhark.Prop.html#setAliases"><span class="hs-operator hs-var">`setAliases`</span></a></span><span> </span><span class="annot"><span class="annottext">as
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[StructTypeArg]
</span><a href="#local-6989586621684548991"><span class="hs-identifier hs-var">targs'</span></a></span><span>
</span><span id="line-585"></span><span>              </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) as
-&gt; Uniqueness -&gt; TypeBase (DimDecl VName) as
forall dim as. TypeBase dim as -&gt; Uniqueness -&gt; TypeBase dim as
</span><a href="Language.Futhark.Prop.html#setUniqueness"><span class="hs-operator hs-var">`setUniqueness`</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684548994"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) as
-&gt; (as -&gt; as) -&gt; TypeBase (DimDecl VName) as
forall dim asf ast.
TypeBase dim asf -&gt; (asf -&gt; ast) -&gt; TypeBase dim ast
</span><a href="Language.Futhark.Prop.html#addAliases"><span class="hs-operator hs-var">`addAliases`</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">as -&gt; as -&gt; as
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">as
</span><a href="#local-6989586621684548995"><span class="hs-identifier hs-var">als</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-586"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Subst (RetTypeBase (DimDecl VName) as)
</span><a href="Language.Futhark.TypeChecker.Types.html#PrimSubst"><span class="hs-identifier hs-var">PrimSubst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-587"></span><span>          </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) as
-&gt; State [VName] (TypeBase (DimDecl VName) as)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(TypeBase (DimDecl VName) as
 -&gt; State [VName] (TypeBase (DimDecl VName) as))
-&gt; TypeBase (DimDecl VName) as
-&gt; State [VName] (TypeBase (DimDecl VName) as)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ScalarTypeBase (DimDecl VName) as -&gt; TypeBase (DimDecl VName) as
forall dim as. ScalarTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-var">Scalar</span></a></span><span> </span><span class="annot"><span class="annottext">(ScalarTypeBase (DimDecl VName) as -&gt; TypeBase (DimDecl VName) as)
-&gt; ScalarTypeBase (DimDecl VName) as -&gt; TypeBase (DimDecl VName) as
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">as
-&gt; Uniqueness
-&gt; TypeName
-&gt; [StructTypeArg]
-&gt; ScalarTypeBase (DimDecl VName) as
forall dim as.
as
-&gt; Uniqueness -&gt; TypeName -&gt; [TypeArg dim] -&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#TypeVar"><span class="hs-identifier hs-var">TypeVar</span></a></span><span> </span><span class="annot"><span class="annottext">as
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684548994"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">TypeName
</span><a href="#local-6989586621684548993"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">[StructTypeArg]
</span><a href="#local-6989586621684548991"><span class="hs-identifier hs-var">targs'</span></a></span><span>
</span><span id="line-588"></span><span>        </span><span class="annot"><span class="annottext">Maybe (Subst (RetTypeBase (DimDecl VName) as))
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-589"></span><span>          </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) as
-&gt; State [VName] (TypeBase (DimDecl VName) as)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(TypeBase (DimDecl VName) as
 -&gt; State [VName] (TypeBase (DimDecl VName) as))
-&gt; TypeBase (DimDecl VName) as
-&gt; State [VName] (TypeBase (DimDecl VName) as)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ScalarTypeBase (DimDecl VName) as -&gt; TypeBase (DimDecl VName) as
forall dim as. ScalarTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-var">Scalar</span></a></span><span> </span><span class="annot"><span class="annottext">(ScalarTypeBase (DimDecl VName) as -&gt; TypeBase (DimDecl VName) as)
-&gt; ScalarTypeBase (DimDecl VName) as -&gt; TypeBase (DimDecl VName) as
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">as
-&gt; Uniqueness
-&gt; TypeName
-&gt; [StructTypeArg]
-&gt; ScalarTypeBase (DimDecl VName) as
forall dim as.
as
-&gt; Uniqueness -&gt; TypeName -&gt; [TypeArg dim] -&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#TypeVar"><span class="hs-identifier hs-var">TypeVar</span></a></span><span> </span><span class="annot"><span class="annottext">as
</span><a href="#local-6989586621684548995"><span class="hs-identifier hs-var">als</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684548994"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">TypeName
</span><a href="#local-6989586621684548993"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">[StructTypeArg]
</span><a href="#local-6989586621684548991"><span class="hs-identifier hs-var">targs'</span></a></span><span>
</span><span id="line-590"></span><span>    </span><span class="annot"><a href="#local-6989586621684549042"><span class="hs-identifier hs-var">onType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Record"><span class="hs-identifier hs-type">Record</span></a></span><span> </span><span id="local-6989586621684548982"><span class="annot"><span class="annottext">Map Name (TypeBase (DimDecl VName) as)
</span><a href="#local-6989586621684548982"><span class="hs-identifier hs-var">ts</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-591"></span><span>      </span><span class="annot"><span class="annottext">ScalarTypeBase (DimDecl VName) as -&gt; TypeBase (DimDecl VName) as
forall dim as. ScalarTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-var">Scalar</span></a></span><span> </span><span class="annot"><span class="annottext">(ScalarTypeBase (DimDecl VName) as -&gt; TypeBase (DimDecl VName) as)
-&gt; (Map Name (TypeBase (DimDecl VName) as)
    -&gt; ScalarTypeBase (DimDecl VName) as)
-&gt; Map Name (TypeBase (DimDecl VName) as)
-&gt; TypeBase (DimDecl VName) as
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Map Name (TypeBase (DimDecl VName) as)
-&gt; ScalarTypeBase (DimDecl VName) as
forall dim as. Map Name (TypeBase dim as) -&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Record"><span class="hs-identifier hs-var">Record</span></a></span><span> </span><span class="annot"><span class="annottext">(Map Name (TypeBase (DimDecl VName) as)
 -&gt; TypeBase (DimDecl VName) as)
-&gt; StateT [VName] Identity (Map Name (TypeBase (DimDecl VName) as))
-&gt; State [VName] (TypeBase (DimDecl VName) as)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(TypeBase (DimDecl VName) as
 -&gt; State [VName] (TypeBase (DimDecl VName) as))
-&gt; Map Name (TypeBase (DimDecl VName) as)
-&gt; StateT [VName] Identity (Map Name (TypeBase (DimDecl VName) as))
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) as
-&gt; State [VName] (TypeBase (DimDecl VName) as)
</span><a href="#local-6989586621684549042"><span class="hs-identifier hs-var">onType</span></a></span><span> </span><span class="annot"><span class="annottext">Map Name (TypeBase (DimDecl VName) as)
</span><a href="#local-6989586621684548982"><span class="hs-identifier hs-var">ts</span></a></span><span>
</span><span id="line-592"></span><span>    </span><span class="annot"><a href="#local-6989586621684549042"><span class="hs-identifier hs-var">onType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Arrow"><span class="hs-identifier hs-type">Arrow</span></a></span><span> </span><span id="local-6989586621684548981"><span class="annot"><span class="annottext">as
</span><a href="#local-6989586621684548981"><span class="hs-identifier hs-var">als</span></a></span></span><span> </span><span id="local-6989586621684548980"><span class="annot"><span class="annottext">PName
</span><a href="#local-6989586621684548980"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621684548979"><span class="annot"><span class="annottext">TypeBase (DimDecl VName) as
</span><a href="#local-6989586621684548979"><span class="hs-identifier hs-var">t1</span></a></span></span><span> </span><span id="local-6989586621684548978"><span class="annot"><span class="annottext">RetTypeBase (DimDecl VName) as
</span><a href="#local-6989586621684548978"><span class="hs-identifier hs-var">t2</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-593"></span><span>      </span><span class="annot"><span class="annottext">ScalarTypeBase (DimDecl VName) as -&gt; TypeBase (DimDecl VName) as
forall dim as. ScalarTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-var">Scalar</span></a></span><span> </span><span class="annot"><span class="annottext">(ScalarTypeBase (DimDecl VName) as -&gt; TypeBase (DimDecl VName) as)
-&gt; StateT [VName] Identity (ScalarTypeBase (DimDecl VName) as)
-&gt; State [VName] (TypeBase (DimDecl VName) as)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">as
-&gt; PName
-&gt; TypeBase (DimDecl VName) as
-&gt; RetTypeBase (DimDecl VName) as
-&gt; ScalarTypeBase (DimDecl VName) as
forall dim as.
as
-&gt; PName
-&gt; TypeBase dim as
-&gt; RetTypeBase dim as
-&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Arrow"><span class="hs-identifier hs-var">Arrow</span></a></span><span> </span><span class="annot"><span class="annottext">as
</span><a href="#local-6989586621684548981"><span class="hs-identifier hs-var">als</span></a></span><span> </span><span class="annot"><span class="annottext">PName
</span><a href="#local-6989586621684548980"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">(TypeBase (DimDecl VName) as
 -&gt; RetTypeBase (DimDecl VName) as
 -&gt; ScalarTypeBase (DimDecl VName) as)
-&gt; State [VName] (TypeBase (DimDecl VName) as)
-&gt; StateT
     [VName]
     Identity
     (RetTypeBase (DimDecl VName) as
      -&gt; ScalarTypeBase (DimDecl VName) as)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) as
-&gt; State [VName] (TypeBase (DimDecl VName) as)
</span><a href="#local-6989586621684549042"><span class="hs-identifier hs-var">onType</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) as
</span><a href="#local-6989586621684548979"><span class="hs-identifier hs-var">t1</span></a></span><span> </span><span class="annot"><span class="annottext">StateT
  [VName]
  Identity
  (RetTypeBase (DimDecl VName) as
   -&gt; ScalarTypeBase (DimDecl VName) as)
-&gt; StateT [VName] Identity (RetTypeBase (DimDecl VName) as)
-&gt; StateT [VName] Identity (ScalarTypeBase (DimDecl VName) as)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">RetTypeBase (DimDecl VName) as
-&gt; StateT [VName] Identity (RetTypeBase (DimDecl VName) as)
forall {m :: * -&gt; *}.
MonadState [VName] m =&gt;
RetTypeBase (DimDecl VName) as
-&gt; m (RetTypeBase (DimDecl VName) as)
</span><a href="#local-6989586621684548977"><span class="hs-identifier hs-var">onRetType</span></a></span><span> </span><span class="annot"><span class="annottext">RetTypeBase (DimDecl VName) as
</span><a href="#local-6989586621684548978"><span class="hs-identifier hs-var">t2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-594"></span><span>    </span><span class="annot"><a href="#local-6989586621684549042"><span class="hs-identifier hs-var">onType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Sum"><span class="hs-identifier hs-type">Sum</span></a></span><span> </span><span id="local-6989586621684548976"><span class="annot"><span class="annottext">Map Name [TypeBase (DimDecl VName) as]
</span><a href="#local-6989586621684548976"><span class="hs-identifier hs-var">ts</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-595"></span><span>      </span><span class="annot"><span class="annottext">ScalarTypeBase (DimDecl VName) as -&gt; TypeBase (DimDecl VName) as
forall dim as. ScalarTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-var">Scalar</span></a></span><span> </span><span class="annot"><span class="annottext">(ScalarTypeBase (DimDecl VName) as -&gt; TypeBase (DimDecl VName) as)
-&gt; (Map Name [TypeBase (DimDecl VName) as]
    -&gt; ScalarTypeBase (DimDecl VName) as)
-&gt; Map Name [TypeBase (DimDecl VName) as]
-&gt; TypeBase (DimDecl VName) as
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Map Name [TypeBase (DimDecl VName) as]
-&gt; ScalarTypeBase (DimDecl VName) as
forall dim as. Map Name [TypeBase dim as] -&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Sum"><span class="hs-identifier hs-var">Sum</span></a></span><span> </span><span class="annot"><span class="annottext">(Map Name [TypeBase (DimDecl VName) as]
 -&gt; TypeBase (DimDecl VName) as)
-&gt; StateT [VName] Identity (Map Name [TypeBase (DimDecl VName) as])
-&gt; State [VName] (TypeBase (DimDecl VName) as)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">([TypeBase (DimDecl VName) as]
 -&gt; StateT [VName] Identity [TypeBase (DimDecl VName) as])
-&gt; Map Name [TypeBase (DimDecl VName) as]
-&gt; StateT [VName] Identity (Map Name [TypeBase (DimDecl VName) as])
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TypeBase (DimDecl VName) as
 -&gt; State [VName] (TypeBase (DimDecl VName) as))
-&gt; [TypeBase (DimDecl VName) as]
-&gt; StateT [VName] Identity [TypeBase (DimDecl VName) as]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) as
-&gt; State [VName] (TypeBase (DimDecl VName) as)
</span><a href="#local-6989586621684549042"><span class="hs-identifier hs-var">onType</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map Name [TypeBase (DimDecl VName) as]
</span><a href="#local-6989586621684548976"><span class="hs-identifier hs-var">ts</span></a></span><span>
</span><span id="line-596"></span><span>
</span><span id="line-597"></span><span>    </span><span id="local-6989586621684548977"><span class="annot"><span class="annottext">onRetType :: RetTypeBase (DimDecl VName) as
-&gt; m (RetTypeBase (DimDecl VName) as)
</span><a href="#local-6989586621684548977"><span class="hs-identifier hs-var hs-var">onRetType</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-type">RetType</span></a></span><span> </span><span id="local-6989586621684548964"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684548964"><span class="hs-identifier hs-var">dims</span></a></span></span><span> </span><span id="local-6989586621684548963"><span class="annot"><span class="annottext">TypeBase (DimDecl VName) as
</span><a href="#local-6989586621684548963"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-598"></span><span>      </span><span id="local-6989586621684548962"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684548962"><span class="hs-identifier hs-var">ext</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m [VName]
forall s (m :: * -&gt; *). MonadState s m =&gt; m s
</span><span class="hs-identifier hs-var">get</span></span><span>
</span><span id="line-599"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684548961"><span class="annot"><span class="annottext">TypeBase (DimDecl VName) as
</span><a href="#local-6989586621684548961"><span class="hs-identifier hs-var">t'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684548960"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684548960"><span class="hs-identifier hs-var">ext'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">State [VName] (TypeBase (DimDecl VName) as)
-&gt; [VName] -&gt; (TypeBase (DimDecl VName) as, [VName])
forall s a. State s a -&gt; s -&gt; (a, s)
</span><span class="hs-identifier hs-var">runState</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) as
-&gt; State [VName] (TypeBase (DimDecl VName) as)
</span><a href="#local-6989586621684549042"><span class="hs-identifier hs-var">onType</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) as
</span><a href="#local-6989586621684548963"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684548962"><span class="hs-identifier hs-var">ext</span></a></span><span>
</span><span id="line-600"></span><span>          </span><span id="local-6989586621684548958"><span class="annot"><span class="annottext">new_ext :: [VName]
</span><a href="#local-6989586621684548958"><span class="hs-identifier hs-var hs-var">new_ext</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684548960"><span class="hs-identifier hs-var">ext'</span></a></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [VName]
forall a. Eq a =&gt; [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">\\</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684548962"><span class="hs-identifier hs-var">ext</span></a></span><span>
</span><span id="line-601"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) as
</span><a href="#local-6989586621684548963"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-602"></span><span>        </span><span class="annot"><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#Arrow"><span class="hs-identifier hs-type">Arrow</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-603"></span><span>          </span><span class="annot"><span class="annottext">[VName] -&gt; m ()
forall s (m :: * -&gt; *). MonadState s m =&gt; s -&gt; m ()
</span><span class="hs-identifier hs-var">put</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684548960"><span class="hs-identifier hs-var">ext'</span></a></span><span>
</span><span id="line-604"></span><span>          </span><span class="annot"><span class="annottext">RetTypeBase (DimDecl VName) as
-&gt; m (RetTypeBase (DimDecl VName) as)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(RetTypeBase (DimDecl VName) as
 -&gt; m (RetTypeBase (DimDecl VName) as))
-&gt; RetTypeBase (DimDecl VName) as
-&gt; m (RetTypeBase (DimDecl VName) as)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName]
-&gt; TypeBase (DimDecl VName) as -&gt; RetTypeBase (DimDecl VName) as
forall dim as. [VName] -&gt; TypeBase dim as -&gt; RetTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-var">RetType</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684548964"><span class="hs-identifier hs-var">dims</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) as
</span><a href="#local-6989586621684548961"><span class="hs-identifier hs-var">t'</span></a></span><span>
</span><span id="line-605"></span><span>        </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) as
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-606"></span><span>          </span><span class="annot"><span class="annottext">RetTypeBase (DimDecl VName) as
-&gt; m (RetTypeBase (DimDecl VName) as)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(RetTypeBase (DimDecl VName) as
 -&gt; m (RetTypeBase (DimDecl VName) as))
-&gt; RetTypeBase (DimDecl VName) as
-&gt; m (RetTypeBase (DimDecl VName) as)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName]
-&gt; TypeBase (DimDecl VName) as -&gt; RetTypeBase (DimDecl VName) as
forall dim as. [VName] -&gt; TypeBase dim as -&gt; RetTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-var">RetType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684548958"><span class="hs-identifier hs-var">new_ext</span></a></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [VName]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684548964"><span class="hs-identifier hs-var">dims</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) as
</span><a href="#local-6989586621684548961"><span class="hs-identifier hs-var">t'</span></a></span><span>
</span><span id="line-607"></span><span>
</span><span id="line-608"></span><span>    </span><span id="local-6989586621684548990"><span class="annot"><span class="annottext">subsTypeArg :: StructTypeArg -&gt; m StructTypeArg
</span><a href="#local-6989586621684548990"><span class="hs-identifier hs-var hs-var">subsTypeArg</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeArgType"><span class="hs-identifier hs-type">TypeArgType</span></a></span><span> </span><span id="local-6989586621684548948"><span class="annot"><span class="annottext">TypeBase (DimDecl VName) ()
</span><a href="#local-6989586621684548948"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621684548947"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684548947"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-609"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-type">RetType</span></a></span><span> </span><span id="local-6989586621684548945"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684548945"><span class="hs-identifier hs-var">dims</span></a></span></span><span> </span><span id="local-6989586621684548944"><span class="annot"><span class="annottext">TypeBase (DimDecl VName) ()
</span><a href="#local-6989586621684548944"><span class="hs-identifier hs-var">t'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeSubs -&gt; TypeBase (DimDecl VName) () -&gt; StructRetType
forall as.
Monoid as =&gt;
(VName -&gt; Maybe (Subst (RetTypeBase (DimDecl VName) as)))
-&gt; TypeBase (DimDecl VName) as -&gt; RetTypeBase (DimDecl VName) as
</span><a href="Language.Futhark.TypeChecker.Types.html#substTypesRet"><span class="hs-identifier hs-var">substTypesRet</span></a></span><span> </span><span class="annot"><span class="annottext">TypeSubs
</span><a href="#local-6989586621684548997"><span class="hs-identifier hs-var">lookupSubst'</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) ()
</span><a href="#local-6989586621684548948"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-610"></span><span>      </span><span class="annot"><span class="annottext">([VName] -&gt; [VName]) -&gt; m ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684548945"><span class="hs-identifier hs-var">dims</span></a></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span class="hs-special">)</span><span>
</span><span id="line-611"></span><span>      </span><span class="annot"><span class="annottext">StructTypeArg -&gt; m StructTypeArg
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(StructTypeArg -&gt; m StructTypeArg)
-&gt; StructTypeArg -&gt; m StructTypeArg
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) () -&gt; SrcLoc -&gt; StructTypeArg
forall dim. TypeBase dim () -&gt; SrcLoc -&gt; TypeArg dim
</span><a href="Language.Futhark.Syntax.html#TypeArgType"><span class="hs-identifier hs-var">TypeArgType</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) ()
</span><a href="#local-6989586621684548944"><span class="hs-identifier hs-var">t'</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684548947"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-612"></span><span>    </span><span class="annot"><a href="#local-6989586621684548990"><span class="hs-identifier hs-var">subsTypeArg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeArgDim"><span class="hs-identifier hs-type">TypeArgDim</span></a></span><span> </span><span id="local-6989586621684548943"><span class="annot"><span class="annottext">DimDecl VName
</span><a href="#local-6989586621684548943"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621684548942"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684548942"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-613"></span><span>      </span><span class="annot"><span class="annottext">StructTypeArg -&gt; m StructTypeArg
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(StructTypeArg -&gt; m StructTypeArg)
-&gt; StructTypeArg -&gt; m StructTypeArg
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DimDecl VName -&gt; SrcLoc -&gt; StructTypeArg
forall dim. dim -&gt; SrcLoc -&gt; TypeArg dim
</span><a href="Language.Futhark.Syntax.html#TypeArgDim"><span class="hs-identifier hs-var">TypeArgDim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeSubs -&gt; DimDecl VName -&gt; DimDecl VName
forall a. Substitutable a =&gt; TypeSubs -&gt; a -&gt; a
</span><a href="Language.Futhark.TypeChecker.Types.html#applySubst"><span class="hs-identifier hs-var">applySubst</span></a></span><span> </span><span class="annot"><span class="annottext">TypeSubs
</span><a href="#local-6989586621684548997"><span class="hs-identifier hs-var">lookupSubst'</span></a></span><span> </span><span class="annot"><span class="annottext">DimDecl VName
</span><a href="#local-6989586621684548943"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684548942"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-614"></span><span>
</span><span id="line-615"></span><span>    </span><span id="local-6989586621684548997"><span class="annot"><span class="annottext">lookupSubst' :: TypeSubs
</span><a href="#local-6989586621684548997"><span class="hs-identifier hs-var hs-var">lookupSubst'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Subst (RetTypeBase (DimDecl VName) as) -&gt; Subst StructRetType)
-&gt; Maybe (Subst (RetTypeBase (DimDecl VName) as))
-&gt; Maybe (Subst StructRetType)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(RetTypeBase (DimDecl VName) as -&gt; StructRetType)
-&gt; Subst (RetTypeBase (DimDecl VName) as) -&gt; Subst StructRetType
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">((RetTypeBase (DimDecl VName) as -&gt; StructRetType)
 -&gt; Subst (RetTypeBase (DimDecl VName) as) -&gt; Subst StructRetType)
-&gt; (RetTypeBase (DimDecl VName) as -&gt; StructRetType)
-&gt; Subst (RetTypeBase (DimDecl VName) as)
-&gt; Subst StructRetType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(as -&gt; ()) -&gt; RetTypeBase (DimDecl VName) as -&gt; StructRetType
forall (p :: * -&gt; * -&gt; *) b c a.
Bifunctor p =&gt;
(b -&gt; c) -&gt; p a b -&gt; p a c
</span><span class="hs-identifier hs-var">second</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; as -&gt; ()
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe (Subst (RetTypeBase (DimDecl VName) as))
 -&gt; Maybe (Subst StructRetType))
-&gt; (VName -&gt; Maybe (Subst (RetTypeBase (DimDecl VName) as)))
-&gt; TypeSubs
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Maybe (Subst (RetTypeBase (DimDecl VName) as))
</span><a href="#local-6989586621684549045"><span class="hs-identifier hs-var">lookupSubst</span></a></span><span>
</span><span id="line-616"></span><span>
</span><span id="line-617"></span><span class="hs-comment">-- | Perform substitutions, from type names to types, on a type. Works</span><span>
</span><span id="line-618"></span><span class="hs-comment">-- regardless of what shape and uniqueness information is attached to the type.</span><span>
</span><span id="line-619"></span><span id="local-6989586621684550308"><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#substTypesAny"><span class="hs-identifier hs-type">substTypesAny</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-620"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Monoid</span></span><span> </span><span class="annot"><a href="#local-6989586621684550308"><span class="hs-keyword hs-type">as</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-621"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#RetTypeBase"><span class="hs-identifier hs-type">RetTypeBase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#DimDecl"><span class="hs-identifier hs-type">DimDecl</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621684550308"><span class="hs-keyword hs-type">as</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-622"></span><span>  </span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeBase"><span class="hs-identifier hs-type">TypeBase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#DimDecl"><span class="hs-identifier hs-type">DimDecl</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621684550308"><span class="hs-keyword hs-type">as</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-623"></span><span>  </span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeBase"><span class="hs-identifier hs-type">TypeBase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#DimDecl"><span class="hs-identifier hs-type">DimDecl</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621684550308"><span class="hs-keyword hs-type">as</span></a></span></span><span>
</span><span id="line-624"></span><span id="substTypesAny"><span class="annot"><span class="annottext">substTypesAny :: forall as.
Monoid as =&gt;
(VName -&gt; Maybe (Subst (RetTypeBase (DimDecl VName) as)))
-&gt; TypeBase (DimDecl VName) as -&gt; TypeBase (DimDecl VName) as
</span><a href="Language.Futhark.TypeChecker.Types.html#substTypesAny"><span class="hs-identifier hs-var hs-var">substTypesAny</span></a></span></span><span> </span><span id="local-6989586621684548935"><span class="annot"><span class="annottext">VName -&gt; Maybe (Subst (RetTypeBase (DimDecl VName) as))
</span><a href="#local-6989586621684548935"><span class="hs-identifier hs-var">lookupSubst</span></a></span></span><span> </span><span id="local-6989586621684548934"><span class="annot"><span class="annottext">TypeBase (DimDecl VName) as
</span><a href="#local-6989586621684548934"><span class="hs-identifier hs-var">ot</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-625"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Maybe (Subst (RetTypeBase (DimDecl VName) as)))
-&gt; TypeBase (DimDecl VName) as -&gt; RetTypeBase (DimDecl VName) as
forall as.
Monoid as =&gt;
(VName -&gt; Maybe (Subst (RetTypeBase (DimDecl VName) as)))
-&gt; TypeBase (DimDecl VName) as -&gt; RetTypeBase (DimDecl VName) as
</span><a href="Language.Futhark.TypeChecker.Types.html#substTypesRet"><span class="hs-identifier hs-var">substTypesRet</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Maybe (Subst (RetTypeBase (DimDecl VName) as))
</span><a href="#local-6989586621684548935"><span class="hs-identifier hs-var">lookupSubst</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) as
</span><a href="#local-6989586621684548934"><span class="hs-identifier hs-var">ot</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-626"></span><span>    </span><span class="annot"><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-type">RetType</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span id="local-6989586621684548933"><span class="annot"><span class="annottext">TypeBase (DimDecl VName) as
</span><a href="#local-6989586621684548933"><span class="hs-identifier hs-var">ot'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) as
</span><a href="#local-6989586621684548933"><span class="hs-identifier hs-var">ot'</span></a></span><span>
</span><span id="line-627"></span><span>    </span><span class="annot"><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-type">RetType</span></a></span><span> </span><span id="local-6989586621684548932"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684548932"><span class="hs-identifier hs-var">dims</span></a></span></span><span> </span><span id="local-6989586621684548931"><span class="annot"><span class="annottext">TypeBase (DimDecl VName) as
</span><a href="#local-6989586621684548931"><span class="hs-identifier hs-var">ot'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-628"></span><span>      </span><span class="hs-comment">-- XXX HACK FIXME: turn any sizes that propagate to the top into</span><span>
</span><span id="line-629"></span><span>      </span><span class="hs-comment">-- AnyDim.  This should _never_ happen during type-checking, but</span><span>
</span><span id="line-630"></span><span>      </span><span class="hs-comment">-- may happen as we substitute types during monomorphisation and</span><span>
</span><span id="line-631"></span><span>      </span><span class="hs-comment">-- defunctorisation later on. See Note [AnyDim]</span><span>
</span><span id="line-632"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684548928"><span class="annot"><span class="annottext">toAny :: DimDecl VName -&gt; DimDecl VName
</span><a href="#local-6989586621684548928"><span class="hs-identifier hs-var hs-var">toAny</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#NamedDim"><span class="hs-identifier hs-type">NamedDim</span></a></span><span> </span><span id="local-6989586621684548927"><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684548927"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-633"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">QualName VName -&gt; VName
forall vn. QualName vn -&gt; vn
</span><a href="Language.Futhark.Syntax.html#qualLeaf"><span class="hs-identifier hs-var hs-var">qualLeaf</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684548927"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [VName] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684548932"><span class="hs-identifier hs-var">dims</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe VName -&gt; DimDecl VName
forall vn. Maybe vn -&gt; DimDecl vn
</span><a href="Language.Futhark.Syntax.html#AnyDim"><span class="hs-identifier hs-var">AnyDim</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe VName
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-634"></span><span>          </span><span class="annot"><a href="#local-6989586621684548928"><span class="hs-identifier hs-var">toAny</span></a></span><span> </span><span id="local-6989586621684548925"><span class="annot"><span class="annottext">DimDecl VName
</span><a href="#local-6989586621684548925"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DimDecl VName
</span><a href="#local-6989586621684548925"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-635"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">(DimDecl VName -&gt; DimDecl VName)
-&gt; TypeBase (DimDecl VName) as -&gt; TypeBase (DimDecl VName) as
forall (p :: * -&gt; * -&gt; *) a b c.
Bifunctor p =&gt;
(a -&gt; b) -&gt; p a c -&gt; p b c
</span><span class="hs-identifier hs-var">first</span></span><span> </span><span class="annot"><span class="annottext">DimDecl VName -&gt; DimDecl VName
</span><a href="#local-6989586621684548928"><span class="hs-identifier hs-var">toAny</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) as
</span><a href="#local-6989586621684548931"><span class="hs-identifier hs-var">ot'</span></a></span><span>
</span><span id="line-636"></span><span>
</span><span id="line-637"></span><span class="hs-comment">-- Note [AnyDim]</span><span>
</span><span id="line-638"></span><span class="hs-comment">--</span><span>
</span><span id="line-639"></span><span class="hs-comment">-- Consider a program:</span><span>
</span><span id="line-640"></span><span class="hs-comment">--</span><span>
</span><span id="line-641"></span><span class="hs-comment">-- module m : { type~ t } = { type~ t = ?[n].[n]bool }</span><span>
</span><span id="line-642"></span><span class="hs-comment">-- let f (x: m.t) (y: m.t) = 0</span><span>
</span><span id="line-643"></span><span class="hs-comment">--</span><span>
</span><span id="line-644"></span><span class="hs-comment">-- After defunctorisation (and inlining the definitions of types), we</span><span>
</span><span id="line-645"></span><span class="hs-comment">-- want this:</span><span>
</span><span id="line-646"></span><span class="hs-comment">--</span><span>
</span><span id="line-647"></span><span class="hs-comment">-- let f [n][m] (x: [n]bool) (y: [m]bool) = 0</span><span>
</span><span id="line-648"></span><span class="hs-comment">--</span><span>
</span><span id="line-649"></span><span class="hs-comment">-- But this means that defunctorisation would need to redo some amount</span><span>
</span><span id="line-650"></span><span class="hs-comment">-- of size inference.  Not so complicated in the example above, but</span><span>
</span><span id="line-651"></span><span class="hs-comment">-- what if loops and branches are involved?</span><span>
</span><span id="line-652"></span><span class="hs-comment">--</span><span>
</span><span id="line-653"></span><span class="hs-comment">-- So instead, what defunctorisation actually does is produce this:</span><span>
</span><span id="line-654"></span><span class="hs-comment">--</span><span>
</span><span id="line-655"></span><span class="hs-comment">-- let f (x: []bool) (y: []bool) = 0</span><span>
</span><span id="line-656"></span><span class="hs-comment">--</span><span>
</span><span id="line-657"></span><span class="hs-comment">-- I.e. we put in empty dimensions (AnyDim), which are much later</span><span>
</span><span id="line-658"></span><span class="hs-comment">-- turned into distinct sizes in Futhark.Internalise.Exps.  This will</span><span>
</span><span id="line-659"></span><span class="hs-comment">-- result in unnecessary dynamic size checks, which will hopefully be</span><span>
</span><span id="line-660"></span><span class="hs-comment">-- optimised away.</span><span>
</span><span id="line-661"></span><span class="hs-comment">--</span><span>
</span><span id="line-662"></span><span class="hs-comment">-- Important: The type checker will _never_ produce programs with</span><span>
</span><span id="line-663"></span><span class="hs-comment">-- AnyDim, but unfortunately some of the compilation steps</span><span>
</span><span id="line-664"></span><span class="hs-comment">-- (defunctorisation, monomorphisation, defunctionalisation) will do</span><span>
</span><span id="line-665"></span><span class="hs-comment">-- so.  Similarly, the core language is also perfectly well behaved.</span><span>
</span><span id="line-666"></span><span class="hs-comment">--</span><span>
</span><span id="line-667"></span><span class="hs-comment">-- Example with monomorphisation:</span><span>
</span><span id="line-668"></span><span class="hs-comment">--</span><span>
</span><span id="line-669"></span><span class="hs-comment">-- let f '~a (b: bool) (x: () -&gt; a) (y: () -&gt; a) : a = if b then x () else y ()</span><span>
</span><span id="line-670"></span><span class="hs-comment">-- let g = f true (\() -&gt; [1]) (\() -&gt; [1,2])</span><span>
</span><span id="line-671"></span><span class="hs-comment">--</span><span>
</span><span id="line-672"></span><span class="hs-comment">-- This should produce:</span><span>
</span><span id="line-673"></span><span class="hs-comment">--</span><span>
</span><span id="line-674"></span><span class="hs-comment">-- let f (b: bool) (x: () -&gt; ?[n].[n]i32) (y: () -&gt; ?[m].[m]i32) : ?[k].[k]i32 =</span><span>
</span><span id="line-675"></span><span class="hs-comment">--   if b then x () else y ()</span><span>
</span><span id="line-676"></span><span class="hs-comment">--</span><span>
</span><span id="line-677"></span><span class="hs-comment">-- Not so easy!  Again, what we actually produce is</span><span>
</span><span id="line-678"></span><span class="hs-comment">--</span><span>
</span><span id="line-679"></span><span class="hs-comment">-- let f (b: bool) (x: () -&gt; []i32) (y: () -&gt; []i32) : []i32 =</span><span>
</span><span id="line-680"></span><span class="hs-comment">--   if b then x () else y ()</span><span>
</span><span id="line-681"></span></pre></body></html>