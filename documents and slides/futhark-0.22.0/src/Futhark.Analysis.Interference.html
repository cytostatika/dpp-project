<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE ConstraintKinds #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-4"></span><span>
</span><span id="line-5"></span><span class="hs-comment">-- | Interference analysis for Futhark programs.</span><span>
</span><span id="line-6"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Futhark.Analysis.Interference</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.Interference.html#Graph"><span class="hs-identifier">Graph</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Analysis.Interference.html#analyseProgGPU"><span class="hs-identifier">analyseProgGPU</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-7"></span><span>
</span><span id="line-8"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Reader</span></span><span>
</span><span id="line-9"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Foldable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">toList</span></span><span class="hs-special">)</span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Function</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-operator">(&amp;)</span></span><span class="hs-special">)</span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Functor</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-operator">(&lt;&amp;&gt;)</span></span><span class="hs-special">)</span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Map</span></span><span class="hs-special">)</span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">catMaybes</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">fromMaybe</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">mapMaybe</span></span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Set</span></span><span class="hs-special">)</span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S</span></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Analysis.LastUse.html"><span class="hs-identifier">Futhark.Analysis.LastUse</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.LastUse.html#LastUseMap"><span class="hs-identifier">LastUseMap</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.Analysis.LastUse.html"><span class="hs-identifier">Futhark.Analysis.LastUse</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">LastUse</span></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.Analysis.MemAlias.html"><span class="hs-identifier">Futhark.Analysis.MemAlias</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">MemAlias</span></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html"><span class="hs-identifier">Futhark.IR.GPUMem</span></a></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Util.html"><span class="hs-identifier">Futhark.Util</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Util.html#invertMap"><span class="hs-identifier">invertMap</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-22"></span><span>
</span><span id="line-23"></span><span class="hs-comment">-- | The set of 'VName' currently in use.</span><span>
</span><span id="line-24"></span><span class="hs-keyword">type</span><span> </span><span id="InUse"><span class="annot"><a href="Futhark.Analysis.Interference.html#InUse"><span class="hs-identifier hs-var">InUse</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span>
</span><span id="line-25"></span><span>
</span><span id="line-26"></span><span class="hs-comment">-- | The set of 'VName' that are no longer in use.</span><span>
</span><span id="line-27"></span><span class="hs-keyword">type</span><span> </span><span id="LastUsed"><span class="annot"><a href="Futhark.Analysis.Interference.html#LastUsed"><span class="hs-identifier hs-var">LastUsed</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span>
</span><span id="line-28"></span><span>
</span><span id="line-29"></span><span class="hs-comment">-- | An interference graph. An element @(x, y)@ in the set means that there is</span><span>
</span><span id="line-30"></span><span class="hs-comment">-- an undirected edge between @x@ and @y@, and therefore the lifetimes of @x@</span><span>
</span><span id="line-31"></span><span class="hs-comment">-- and @y@ overlap and they &quot;interfere&quot; with each other. We assume that pairs</span><span>
</span><span id="line-32"></span><span class="hs-comment">-- are always normalized, such that @x@ &lt; @y@, before inserting. This should</span><span>
</span><span id="line-33"></span><span class="hs-comment">-- prevent any duplicates. We also don't allow any pairs where @x == y@.</span><span>
</span><span id="line-34"></span><span class="hs-keyword">type</span><span> </span><span id="Graph"><span class="annot"><a href="Futhark.Analysis.Interference.html#Graph"><span class="hs-identifier hs-var">Graph</span></a></span></span><span> </span><span id="local-6989586621684450151"><span class="annot"><a href="#local-6989586621684450151"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621684450151"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621684450151"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span>
</span><span id="line-36"></span><span class="hs-comment">-- | Insert an edge between two values into the graph.</span><span>
</span><span id="line-37"></span><span id="local-6989586621684450429"><span class="annot"><a href="Futhark.Analysis.Interference.html#makeEdge"><span class="hs-identifier hs-type">makeEdge</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621684450429"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684450429"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684450429"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Analysis.Interference.html#Graph"><span class="hs-identifier hs-type">Graph</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684450429"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-38"></span><span id="makeEdge"><span class="annot"><span class="annottext">makeEdge :: forall a. Ord a =&gt; a -&gt; a -&gt; Graph a
</span><a href="Futhark.Analysis.Interference.html#makeEdge"><span class="hs-identifier hs-var hs-var">makeEdge</span></a></span></span><span> </span><span id="local-6989586621684450141"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684450141"><span class="hs-identifier hs-var">v1</span></a></span></span><span> </span><span id="local-6989586621684450140"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684450140"><span class="hs-identifier hs-var">v2</span></a></span></span><span>
</span><span id="line-39"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684450141"><span class="hs-identifier hs-var">v1</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684450140"><span class="hs-identifier hs-var">v2</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Graph a
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-40"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(a, a) -&gt; Graph a
forall a. a -&gt; Set a
</span><span class="hs-identifier hs-var">S.singleton</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">min</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684450141"><span class="hs-identifier hs-var">v1</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684450140"><span class="hs-identifier hs-var">v2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">max</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684450141"><span class="hs-identifier hs-var">v1</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684450140"><span class="hs-identifier hs-var">v2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span>
</span><span id="line-42"></span><span class="hs-comment">-- | Compute the cartesian product of two foldable collections, using the given</span><span>
</span><span id="line-43"></span><span class="hs-comment">-- combinator function.</span><span>
</span><span id="line-44"></span><span id="local-6989586621684450421"><span id="local-6989586621684450422"><span id="local-6989586621684450423"><span class="annot"><a href="Futhark.Analysis.Interference.html#cartesian"><span class="hs-identifier hs-type">cartesian</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monoid</span></span><span> </span><span class="annot"><a href="#local-6989586621684450423"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Foldable</span></span><span> </span><span class="annot"><a href="#local-6989586621684450422"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621684450421"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684450421"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684450423"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684450422"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684450421"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684450422"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684450421"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684450423"><span class="hs-identifier hs-type">m</span></a></span></span></span></span><span>
</span><span id="line-45"></span><span id="cartesian"><span class="annot"><span class="annottext">cartesian :: forall m (t :: * -&gt; *) a.
(Monoid m, Foldable t) =&gt;
(a -&gt; a -&gt; m) -&gt; t a -&gt; t a -&gt; m
</span><a href="Futhark.Analysis.Interference.html#cartesian"><span class="hs-identifier hs-var hs-var">cartesian</span></a></span></span><span> </span><span id="local-6989586621684450129"><span class="annot"><span class="annottext">a -&gt; a -&gt; m
</span><a href="#local-6989586621684450129"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621684450128"><span class="annot"><span class="annottext">t a
</span><a href="#local-6989586621684450128"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span id="local-6989586621684450127"><span class="annot"><span class="annottext">t a
</span><a href="#local-6989586621684450127"><span class="hs-identifier hs-var">ys</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-46"></span><span>  </span><span class="annot"><span class="annottext">((a, a) -&gt; m) -&gt; [(a, a)] -&gt; m
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(a -&gt; a -&gt; m) -&gt; (a, a) -&gt; m
forall a b c. (a -&gt; b -&gt; c) -&gt; (a, b) -&gt; c
</span><span class="hs-identifier hs-var">uncurry</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; m
</span><a href="#local-6989586621684450129"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684450124"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684450123"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621684450124"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684450124"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">t a -&gt; [a]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><span class="hs-identifier hs-var">toList</span></span><span> </span><span class="annot"><span class="annottext">t a
</span><a href="#local-6989586621684450128"><span class="hs-identifier hs-var">xs</span></a></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684450123"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684450123"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">t a -&gt; [a]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><span class="hs-identifier hs-var">toList</span></span><span> </span><span class="annot"><span class="annottext">t a
</span><a href="#local-6989586621684450127"><span class="hs-identifier hs-var">ys</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-47"></span><span>
</span><span id="line-48"></span><span id="local-6989586621684450410"><span class="annot"><a href="Futhark.Analysis.Interference.html#analyseStm"><span class="hs-identifier hs-type">analyseStm</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-49"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#LocalScope"><span class="hs-identifier hs-type">LocalScope</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684450410"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-50"></span><span>  </span><span class="annot"><a href="Futhark.Analysis.LastUse.html#LastUseMap"><span class="hs-identifier hs-type">LastUseMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-51"></span><span>  </span><span class="annot"><a href="Futhark.Analysis.Interference.html#InUse"><span class="hs-identifier hs-type">InUse</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-52"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-53"></span><span>  </span><span class="annot"><a href="#local-6989586621684450410"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.Interference.html#InUse"><span class="hs-identifier hs-type">InUse</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Analysis.Interference.html#LastUsed"><span class="hs-identifier hs-type">LastUsed</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Analysis.Interference.html#Graph"><span class="hs-identifier hs-type">Graph</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-54"></span><span id="analyseStm"><span class="annot"><span class="annottext">analyseStm :: forall (m :: * -&gt; *).
LocalScope GPUMem m =&gt;
LastUseMap -&gt; Names -&gt; Stm GPUMem -&gt; m (Names, Names, Graph VName)
</span><a href="Futhark.Analysis.Interference.html#analyseStm"><span class="hs-identifier hs-var hs-var">analyseStm</span></a></span></span><span> </span><span id="local-6989586621684450079"><span class="annot"><span class="annottext">LastUseMap
</span><a href="#local-6989586621684450079"><span class="hs-identifier hs-var">lumap</span></a></span></span><span> </span><span id="local-6989586621684450078"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684450078"><span class="hs-identifier hs-var">inuse0</span></a></span></span><span> </span><span id="local-6989586621684450077"><span class="annot"><span class="annottext">Stm GPUMem
</span><a href="#local-6989586621684450077"><span class="hs-identifier hs-var">stm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-55"></span><span>  </span><span class="annot"><span class="annottext">Stm GPUMem
-&gt; m (Names, Names, Graph VName) -&gt; m (Names, Names, Graph VName)
forall rep a (m :: * -&gt; *) b.
(Scoped rep a, LocalScope rep m) =&gt;
a -&gt; m b -&gt; m b
</span><a href="Futhark.IR.Prop.Scope.html#inScopeOf"><span class="hs-identifier hs-var">inScopeOf</span></a></span><span> </span><span class="annot"><span class="annottext">Stm GPUMem
</span><a href="#local-6989586621684450077"><span class="hs-identifier hs-var">stm</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Names, Names, Graph VName) -&gt; m (Names, Names, Graph VName))
-&gt; m (Names, Names, Graph VName) -&gt; m (Names, Names, Graph VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-56"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684450075"><span class="annot"><span class="annottext">pat_name :: VName
</span><a href="#local-6989586621684450075"><span class="hs-identifier hs-var hs-var">pat_name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatElemT LetDecMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">(PatElemT LetDecMem -&gt; VName) -&gt; PatElemT LetDecMem -&gt; VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[PatElemT LetDecMem] -&gt; PatElemT LetDecMem
forall a. [a] -&gt; a
</span><span class="hs-identifier hs-var">head</span></span><span> </span><span class="annot"><span class="annottext">([PatElemT LetDecMem] -&gt; PatElemT LetDecMem)
-&gt; [PatElemT LetDecMem] -&gt; PatElemT LetDecMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatT LetDecMem -&gt; [PatElemT LetDecMem]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span> </span><span class="annot"><span class="annottext">(PatT LetDecMem -&gt; [PatElemT LetDecMem])
-&gt; PatT LetDecMem -&gt; [PatElemT LetDecMem]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stm GPUMem -&gt; Pat GPUMem
forall rep. Stm rep -&gt; Pat rep
</span><a href="Futhark.IR.Syntax.html#stmPat"><span class="hs-identifier hs-var hs-var">stmPat</span></a></span><span> </span><span class="annot"><span class="annottext">Stm GPUMem
</span><a href="#local-6989586621684450077"><span class="hs-identifier hs-var">stm</span></a></span><span>
</span><span id="line-57"></span><span>
</span><span id="line-58"></span><span>    </span><span id="local-6989586621684450070"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684450070"><span class="hs-identifier hs-var">new_mems</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-59"></span><span>      </span><span class="annot"><span class="annottext">Stm GPUMem -&gt; Pat GPUMem
forall rep. Stm rep -&gt; Pat rep
</span><a href="Futhark.IR.Syntax.html#stmPat"><span class="hs-identifier hs-var hs-var">stmPat</span></a></span><span> </span><span class="annot"><span class="annottext">Stm GPUMem
</span><a href="#local-6989586621684450077"><span class="hs-identifier hs-var">stm</span></a></span><span>
</span><span id="line-60"></span><span>        </span><span class="annot"><span class="annottext">PatT LetDecMem
-&gt; (PatT LetDecMem -&gt; [PatElemT LetDecMem]) -&gt; [PatElemT LetDecMem]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">PatT LetDecMem -&gt; [PatElemT LetDecMem]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span>
</span><span id="line-61"></span><span>        </span><span class="annot"><span class="annottext">[PatElemT LetDecMem]
-&gt; ([PatElemT LetDecMem] -&gt; m [Maybe VName]) -&gt; m [Maybe VName]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">(PatElemT LetDecMem -&gt; m (Maybe VName))
-&gt; [PatElemT LetDecMem] -&gt; m [Maybe VName]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; m (Maybe VName)
forall (m :: * -&gt; *).
LocalScope GPUMem m =&gt;
VName -&gt; m (Maybe VName)
</span><a href="Futhark.Analysis.Interference.html#memInfo"><span class="hs-identifier hs-var">memInfo</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; m (Maybe VName))
-&gt; (PatElemT LetDecMem -&gt; VName)
-&gt; PatElemT LetDecMem
-&gt; m (Maybe VName)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PatElemT LetDecMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-62"></span><span>        </span><span class="annot"><span class="annottext">m [Maybe VName] -&gt; ([Maybe VName] -&gt; [VName]) -&gt; m [VName]
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Maybe VName] -&gt; [VName]
forall a. [Maybe a] -&gt; [a]
</span><span class="hs-identifier hs-var">catMaybes</span></span><span>
</span><span id="line-63"></span><span>        </span><span class="annot"><span class="annottext">m [VName] -&gt; ([VName] -&gt; Names) -&gt; m Names
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#namesFromList"><span class="hs-identifier hs-var">namesFromList</span></a></span><span>
</span><span id="line-64"></span><span>
</span><span id="line-65"></span><span>    </span><span class="hs-comment">-- `new_mems` should interfere with any mems inside the statement expression</span><span>
</span><span id="line-66"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684450065"><span class="annot"><span class="annottext">inuse_outside :: Names
</span><a href="#local-6989586621684450065"><span class="hs-identifier hs-var hs-var">inuse_outside</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684450078"><span class="hs-identifier hs-var">inuse0</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684450070"><span class="hs-identifier hs-var">new_mems</span></a></span><span>
</span><span id="line-67"></span><span>
</span><span id="line-68"></span><span>    </span><span class="hs-comment">-- `inuse` is the set of memory blocks that are inuse at the end of any code</span><span>
</span><span id="line-69"></span><span>    </span><span class="hs-comment">-- bodies inside the expression. `lus` is the set of all memory blocks that</span><span>
</span><span id="line-70"></span><span>    </span><span class="hs-comment">-- have reached their last use in any code bodies inside the</span><span>
</span><span id="line-71"></span><span>    </span><span class="hs-comment">-- expression. `graph` is the interference graph computed for any code</span><span>
</span><span id="line-72"></span><span>    </span><span class="hs-comment">-- bodies inside the expression.</span><span>
</span><span id="line-73"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684450064"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684450064"><span class="hs-identifier hs-var">inuse</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684450063"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684450063"><span class="hs-identifier hs-var">lus</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684450062"><span class="annot"><span class="annottext">Graph VName
</span><a href="#local-6989586621684450062"><span class="hs-identifier hs-var">graph</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LastUseMap -&gt; Names -&gt; Exp GPUMem -&gt; m (Names, Names, Graph VName)
forall (m :: * -&gt; *).
LocalScope GPUMem m =&gt;
LastUseMap -&gt; Names -&gt; Exp GPUMem -&gt; m (Names, Names, Graph VName)
</span><a href="Futhark.Analysis.Interference.html#analyseExp"><span class="hs-identifier hs-var">analyseExp</span></a></span><span> </span><span class="annot"><span class="annottext">LastUseMap
</span><a href="#local-6989586621684450079"><span class="hs-identifier hs-var">lumap</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684450065"><span class="hs-identifier hs-var">inuse_outside</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stm GPUMem -&gt; Exp GPUMem
forall rep. Stm rep -&gt; Exp rep
</span><a href="Futhark.IR.Syntax.html#stmExp"><span class="hs-identifier hs-var hs-var">stmExp</span></a></span><span> </span><span class="annot"><span class="annottext">Stm GPUMem
</span><a href="#local-6989586621684450077"><span class="hs-identifier hs-var">stm</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-74"></span><span>
</span><span id="line-75"></span><span>    </span><span id="local-6989586621684450059"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684450059"><span class="hs-identifier hs-var">last_use_mems</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-76"></span><span>      </span><span class="annot"><span class="annottext">VName -&gt; LastUseMap -&gt; Maybe Names
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684450075"><span class="hs-identifier hs-var">pat_name</span></a></span><span> </span><span class="annot"><span class="annottext">LastUseMap
</span><a href="#local-6989586621684450079"><span class="hs-identifier hs-var">lumap</span></a></span><span>
</span><span id="line-77"></span><span>        </span><span class="annot"><span class="annottext">Maybe Names -&gt; (Maybe Names -&gt; Names) -&gt; Names
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Maybe Names -&gt; Names
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-78"></span><span>        </span><span class="annot"><span class="annottext">Names -&gt; (Names -&gt; [VName]) -&gt; [VName]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">Names -&gt; [VName]
</span><a href="Futhark.IR.Prop.Names.html#namesToList"><span class="hs-identifier hs-var">namesToList</span></a></span><span>
</span><span id="line-79"></span><span>        </span><span class="annot"><span class="annottext">[VName] -&gt; ([VName] -&gt; m [Maybe VName]) -&gt; m [Maybe VName]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; m (Maybe VName)) -&gt; [VName] -&gt; m [Maybe VName]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; m (Maybe VName)
forall (m :: * -&gt; *).
LocalScope GPUMem m =&gt;
VName -&gt; m (Maybe VName)
</span><a href="Futhark.Analysis.Interference.html#memInfo"><span class="hs-identifier hs-var">memInfo</span></a></span><span>
</span><span id="line-80"></span><span>        </span><span class="annot"><span class="annottext">m [Maybe VName] -&gt; ([Maybe VName] -&gt; [VName]) -&gt; m [VName]
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Maybe VName] -&gt; [VName]
forall a. [Maybe a] -&gt; [a]
</span><span class="hs-identifier hs-var">catMaybes</span></span><span>
</span><span id="line-81"></span><span>        </span><span class="annot"><span class="annottext">m [VName] -&gt; ([VName] -&gt; Names) -&gt; m Names
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#namesFromList"><span class="hs-identifier hs-var">namesFromList</span></a></span><span>
</span><span id="line-82"></span><span>        </span><span class="annot"><span class="annottext">m Names -&gt; (Names -&gt; Names) -&gt; m Names
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#namesIntersection"><span class="hs-identifier hs-var">namesIntersection</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684450065"><span class="hs-identifier hs-var">inuse_outside</span></a></span><span>
</span><span id="line-83"></span><span>
</span><span id="line-84"></span><span>    </span><span class="annot"><span class="annottext">(Names, Names, Graph VName) -&gt; m (Names, Names, Graph VName)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-85"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684450065"><span class="hs-identifier hs-var">inuse_outside</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#namesSubtract"><span class="hs-operator hs-var">`namesSubtract`</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684450059"><span class="hs-identifier hs-var">last_use_mems</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#namesSubtract"><span class="hs-operator hs-var">`namesSubtract`</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684450063"><span class="hs-identifier hs-var">lus</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-86"></span><span>          </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684450070"><span class="hs-identifier hs-var">new_mems</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-87"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684450063"><span class="hs-identifier hs-var">lus</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684450059"><span class="hs-identifier hs-var">last_use_mems</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#namesSubtract"><span class="hs-operator hs-var">`namesSubtract`</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684450070"><span class="hs-identifier hs-var">new_mems</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-88"></span><span>        </span><span class="annot"><span class="annottext">Graph VName
</span><a href="#local-6989586621684450062"><span class="hs-identifier hs-var">graph</span></a></span><span>
</span><span id="line-89"></span><span>          </span><span class="annot"><span class="annottext">Graph VName -&gt; Graph VName -&gt; Graph VName
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; VName -&gt; Graph VName)
-&gt; [VName] -&gt; [VName] -&gt; Graph VName
forall m (t :: * -&gt; *) a.
(Monoid m, Foldable t) =&gt;
(a -&gt; a -&gt; m) -&gt; t a -&gt; t a -&gt; m
</span><a href="Futhark.Analysis.Interference.html#cartesian"><span class="hs-identifier hs-var">cartesian</span></a></span><span>
</span><span id="line-90"></span><span>            </span><span class="annot"><span class="annottext">VName -&gt; VName -&gt; Graph VName
forall a. Ord a =&gt; a -&gt; a -&gt; Graph a
</span><a href="Futhark.Analysis.Interference.html#makeEdge"><span class="hs-identifier hs-var">makeEdge</span></a></span><span>
</span><span id="line-91"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Names -&gt; [VName]
</span><a href="Futhark.IR.Prop.Names.html#namesToList"><span class="hs-identifier hs-var">namesToList</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684450065"><span class="hs-identifier hs-var">inuse_outside</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-92"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Names -&gt; [VName]
</span><a href="Futhark.IR.Prop.Names.html#namesToList"><span class="hs-identifier hs-var">namesToList</span></a></span><span> </span><span class="annot"><span class="annottext">(Names -&gt; [VName]) -&gt; Names -&gt; [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684450065"><span class="hs-identifier hs-var">inuse_outside</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684450064"><span class="hs-identifier hs-var">inuse</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684450063"><span class="hs-identifier hs-var">lus</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684450059"><span class="hs-identifier hs-var">last_use_mems</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-93"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-94"></span><span>
</span><span id="line-95"></span><span class="hs-comment">-- We conservatively treat all memory arguments to a DoLoop to</span><span>
</span><span id="line-96"></span><span class="hs-comment">-- interfere with each other, as well as anything used inside the</span><span>
</span><span id="line-97"></span><span class="hs-comment">-- loop.  This could potentially be improved by looking at the</span><span>
</span><span id="line-98"></span><span class="hs-comment">-- interference computed by the loop body wrt. the loop arguments, but</span><span>
</span><span id="line-99"></span><span class="hs-comment">-- probably very few programs would benefit from this.</span><span>
</span><span id="line-100"></span><span class="annot"><a href="Futhark.Analysis.Interference.html#analyseLoopParams"><span class="hs-identifier hs-type">analyseLoopParams</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-101"></span><span>  </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#FParam"><span class="hs-identifier hs-type">FParam</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-102"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.Interference.html#InUse"><span class="hs-identifier hs-type">InUse</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Analysis.Interference.html#LastUsed"><span class="hs-identifier hs-type">LastUsed</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Analysis.Interference.html#Graph"><span class="hs-identifier hs-type">Graph</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-103"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.Interference.html#InUse"><span class="hs-identifier hs-type">InUse</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Analysis.Interference.html#LastUsed"><span class="hs-identifier hs-type">LastUsed</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Analysis.Interference.html#Graph"><span class="hs-identifier hs-type">Graph</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-104"></span><span id="analyseLoopParams"><span class="annot"><span class="annottext">analyseLoopParams :: [(FParam GPUMem, SubExp)]
-&gt; (Names, Names, Graph VName) -&gt; (Names, Names, Graph VName)
</span><a href="Futhark.Analysis.Interference.html#analyseLoopParams"><span class="hs-identifier hs-var hs-var">analyseLoopParams</span></a></span></span><span> </span><span id="local-6989586621684450053"><span class="annot"><span class="annottext">[(FParam GPUMem, SubExp)]
</span><a href="#local-6989586621684450053"><span class="hs-identifier hs-var">merge</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684450052"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684450052"><span class="hs-identifier hs-var">inuse</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684450051"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684450051"><span class="hs-identifier hs-var">lastused</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684450050"><span class="annot"><span class="annottext">Graph VName
</span><a href="#local-6989586621684450050"><span class="hs-identifier hs-var">graph</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-105"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684450052"><span class="hs-identifier hs-var">inuse</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684450051"><span class="hs-identifier hs-var">lastused</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; VName -&gt; Graph VName)
-&gt; [VName] -&gt; [VName] -&gt; Graph VName
forall m (t :: * -&gt; *) a.
(Monoid m, Foldable t) =&gt;
(a -&gt; a -&gt; m) -&gt; t a -&gt; t a -&gt; m
</span><a href="Futhark.Analysis.Interference.html#cartesian"><span class="hs-identifier hs-var">cartesian</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; VName -&gt; Graph VName
forall a. Ord a =&gt; a -&gt; a -&gt; Graph a
</span><a href="Futhark.Analysis.Interference.html#makeEdge"><span class="hs-identifier hs-var">makeEdge</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684450049"><span class="hs-identifier hs-var">mems</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684450049"><span class="hs-identifier hs-var">mems</span></a></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [VName]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684450048"><span class="hs-identifier hs-var">inner_mems</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Graph VName -&gt; Graph VName -&gt; Graph VName
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Graph VName
</span><a href="#local-6989586621684450050"><span class="hs-identifier hs-var">graph</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-106"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-107"></span><span>    </span><span id="local-6989586621684450049"><span class="annot"><span class="annottext">mems :: [VName]
</span><a href="#local-6989586621684450049"><span class="hs-identifier hs-var hs-var">mems</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Param (MemInfo SubExp Uniqueness MemBind), SubExp)
 -&gt; Maybe VName)
-&gt; [(Param (MemInfo SubExp Uniqueness MemBind), SubExp)] -&gt; [VName]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">mapMaybe</span></span><span> </span><span class="annot"><span class="annottext">(Param (MemInfo SubExp Uniqueness MemBind), SubExp) -&gt; Maybe VName
forall {d} {u} {ret}.
(Param (MemInfo d u ret), SubExp) -&gt; Maybe VName
</span><a href="#local-6989586621684450047"><span class="hs-identifier hs-var">isMemArg</span></a></span><span> </span><span class="annot"><span class="annottext">[(FParam GPUMem, SubExp)]
[(Param (MemInfo SubExp Uniqueness MemBind), SubExp)]
</span><a href="#local-6989586621684450053"><span class="hs-identifier hs-var">merge</span></a></span><span>
</span><span id="line-108"></span><span>    </span><span id="local-6989586621684450048"><span class="annot"><span class="annottext">inner_mems :: [VName]
</span><a href="#local-6989586621684450048"><span class="hs-identifier hs-var hs-var">inner_mems</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Names -&gt; [VName]
</span><a href="Futhark.IR.Prop.Names.html#namesToList"><span class="hs-identifier hs-var">namesToList</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684450051"><span class="hs-identifier hs-var">lastused</span></a></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [VName]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Names -&gt; [VName]
</span><a href="Futhark.IR.Prop.Names.html#namesToList"><span class="hs-identifier hs-var">namesToList</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684450052"><span class="hs-identifier hs-var">inuse</span></a></span><span>
</span><span id="line-109"></span><span>    </span><span id="local-6989586621684450047"><span class="annot"><span class="annottext">isMemArg :: (Param (MemInfo d u ret), SubExp) -&gt; Maybe VName
</span><a href="#local-6989586621684450047"><span class="hs-identifier hs-var hs-var">isMemArg</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Param"><span class="hs-identifier hs-type">Param</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#MemMem"><span class="hs-identifier hs-type">MemMem</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684450043"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684450043"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Maybe VName
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684450043"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-110"></span><span>    </span><span class="annot"><a href="#local-6989586621684450047"><span class="hs-identifier hs-var">isMemArg</span></a></span><span> </span><span class="annot"><span class="annottext">(Param (MemInfo d u ret), SubExp)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe VName
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-111"></span><span>
</span><span id="line-112"></span><span id="local-6989586621684450368"><span class="annot"><a href="Futhark.Analysis.Interference.html#analyseExp"><span class="hs-identifier hs-type">analyseExp</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-113"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#LocalScope"><span class="hs-identifier hs-type">LocalScope</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684450368"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-114"></span><span>  </span><span class="annot"><a href="Futhark.Analysis.LastUse.html#LastUseMap"><span class="hs-identifier hs-type">LastUseMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-115"></span><span>  </span><span class="annot"><a href="Futhark.Analysis.Interference.html#InUse"><span class="hs-identifier hs-type">InUse</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-116"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-117"></span><span>  </span><span class="annot"><a href="#local-6989586621684450368"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.Interference.html#InUse"><span class="hs-identifier hs-type">InUse</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Analysis.Interference.html#LastUsed"><span class="hs-identifier hs-type">LastUsed</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Analysis.Interference.html#Graph"><span class="hs-identifier hs-type">Graph</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-118"></span><span id="analyseExp"><span class="annot"><span class="annottext">analyseExp :: forall (m :: * -&gt; *).
LocalScope GPUMem m =&gt;
LastUseMap -&gt; Names -&gt; Exp GPUMem -&gt; m (Names, Names, Graph VName)
</span><a href="Futhark.Analysis.Interference.html#analyseExp"><span class="hs-identifier hs-var hs-var">analyseExp</span></a></span></span><span> </span><span id="local-6989586621684450022"><span class="annot"><span class="annottext">LastUseMap
</span><a href="#local-6989586621684450022"><span class="hs-identifier hs-var">lumap</span></a></span></span><span> </span><span id="local-6989586621684450021"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684450021"><span class="hs-identifier hs-var">inuse_outside</span></a></span></span><span> </span><span id="local-6989586621684450020"><span class="annot"><span class="annottext">Exp GPUMem
</span><a href="#local-6989586621684450020"><span class="hs-identifier hs-var">expr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-119"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Exp GPUMem
</span><a href="#local-6989586621684450020"><span class="hs-identifier hs-var">expr</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-120"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#If"><span class="hs-identifier hs-type">If</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684450018"><span class="annot"><span class="annottext">BodyT GPUMem
</span><a href="#local-6989586621684450018"><span class="hs-identifier hs-var">then_body</span></a></span></span><span> </span><span id="local-6989586621684450017"><span class="annot"><span class="annottext">BodyT GPUMem
</span><a href="#local-6989586621684450017"><span class="hs-identifier hs-var">else_body</span></a></span></span><span> </span><span class="annot"><span class="annottext">IfDec (BranchType GPUMem)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-121"></span><span>      </span><span id="local-6989586621684450016"><span class="annot"><span class="annottext">(Names, Names, Graph VName)
</span><a href="#local-6989586621684450016"><span class="hs-identifier hs-var">res1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LastUseMap
-&gt; Names -&gt; BodyT GPUMem -&gt; m (Names, Names, Graph VName)
forall (m :: * -&gt; *).
LocalScope GPUMem m =&gt;
LastUseMap
-&gt; Names -&gt; BodyT GPUMem -&gt; m (Names, Names, Graph VName)
</span><a href="Futhark.Analysis.Interference.html#analyseBody"><span class="hs-identifier hs-var">analyseBody</span></a></span><span> </span><span class="annot"><span class="annottext">LastUseMap
</span><a href="#local-6989586621684450022"><span class="hs-identifier hs-var">lumap</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684450021"><span class="hs-identifier hs-var">inuse_outside</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT GPUMem
</span><a href="#local-6989586621684450018"><span class="hs-identifier hs-var">then_body</span></a></span><span>
</span><span id="line-122"></span><span>      </span><span id="local-6989586621684450014"><span class="annot"><span class="annottext">(Names, Names, Graph VName)
</span><a href="#local-6989586621684450014"><span class="hs-identifier hs-var">res2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LastUseMap
-&gt; Names -&gt; BodyT GPUMem -&gt; m (Names, Names, Graph VName)
forall (m :: * -&gt; *).
LocalScope GPUMem m =&gt;
LastUseMap
-&gt; Names -&gt; BodyT GPUMem -&gt; m (Names, Names, Graph VName)
</span><a href="Futhark.Analysis.Interference.html#analyseBody"><span class="hs-identifier hs-var">analyseBody</span></a></span><span> </span><span class="annot"><span class="annottext">LastUseMap
</span><a href="#local-6989586621684450022"><span class="hs-identifier hs-var">lumap</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684450021"><span class="hs-identifier hs-var">inuse_outside</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT GPUMem
</span><a href="#local-6989586621684450017"><span class="hs-identifier hs-var">else_body</span></a></span><span>
</span><span id="line-123"></span><span>      </span><span class="annot"><span class="annottext">(Names, Names, Graph VName) -&gt; m (Names, Names, Graph VName)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">((Names, Names, Graph VName) -&gt; m (Names, Names, Graph VName))
-&gt; (Names, Names, Graph VName) -&gt; m (Names, Names, Graph VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Names, Names, Graph VName)
</span><a href="#local-6989586621684450016"><span class="hs-identifier hs-var">res1</span></a></span><span> </span><span class="annot"><span class="annottext">(Names, Names, Graph VName)
-&gt; (Names, Names, Graph VName) -&gt; (Names, Names, Graph VName)
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Names, Names, Graph VName)
</span><a href="#local-6989586621684450014"><span class="hs-identifier hs-var">res2</span></a></span><span>
</span><span id="line-124"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#DoLoop"><span class="hs-identifier hs-type">DoLoop</span></a></span><span> </span><span id="local-6989586621684450012"><span class="annot"><span class="annottext">[(FParam GPUMem, SubExp)]
</span><a href="#local-6989586621684450012"><span class="hs-identifier hs-var">merge</span></a></span></span><span> </span><span class="annot"><span class="annottext">LoopForm GPUMem
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684450011"><span class="annot"><span class="annottext">BodyT GPUMem
</span><a href="#local-6989586621684450011"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-125"></span><span>      </span><span class="annot"><span class="annottext">[(FParam GPUMem, SubExp)]
-&gt; (Names, Names, Graph VName) -&gt; (Names, Names, Graph VName)
</span><a href="Futhark.Analysis.Interference.html#analyseLoopParams"><span class="hs-identifier hs-var">analyseLoopParams</span></a></span><span> </span><span class="annot"><span class="annottext">[(FParam GPUMem, SubExp)]
</span><a href="#local-6989586621684450012"><span class="hs-identifier hs-var">merge</span></a></span><span> </span><span class="annot"><span class="annottext">((Names, Names, Graph VName) -&gt; (Names, Names, Graph VName))
-&gt; m (Names, Names, Graph VName) -&gt; m (Names, Names, Graph VName)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">LastUseMap
-&gt; Names -&gt; BodyT GPUMem -&gt; m (Names, Names, Graph VName)
forall (m :: * -&gt; *).
LocalScope GPUMem m =&gt;
LastUseMap
-&gt; Names -&gt; BodyT GPUMem -&gt; m (Names, Names, Graph VName)
</span><a href="Futhark.Analysis.Interference.html#analyseBody"><span class="hs-identifier hs-var">analyseBody</span></a></span><span> </span><span class="annot"><span class="annottext">LastUseMap
</span><a href="#local-6989586621684450022"><span class="hs-identifier hs-var">lumap</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684450021"><span class="hs-identifier hs-var">inuse_outside</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT GPUMem
</span><a href="#local-6989586621684450011"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-126"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SegOp"><span class="hs-identifier hs-type">SegOp</span></a></span><span> </span><span id="local-6989586621684450006"><span class="annot"><span class="annottext">SegOp SegLevel GPUMem
</span><a href="#local-6989586621684450006"><span class="hs-identifier hs-var">segop</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-127"></span><span>      </span><span class="annot"><span class="annottext">LastUseMap
-&gt; Names -&gt; SegOp SegLevel GPUMem -&gt; m (Names, Names, Graph VName)
forall (m :: * -&gt; *) lvl.
LocalScope GPUMem m =&gt;
LastUseMap
-&gt; Names -&gt; SegOp lvl GPUMem -&gt; m (Names, Names, Graph VName)
</span><a href="Futhark.Analysis.Interference.html#analyseSegOp"><span class="hs-identifier hs-var">analyseSegOp</span></a></span><span> </span><span class="annot"><span class="annottext">LastUseMap
</span><a href="#local-6989586621684450022"><span class="hs-identifier hs-var">lumap</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684450021"><span class="hs-identifier hs-var">inuse_outside</span></a></span><span> </span><span class="annot"><span class="annottext">SegOp SegLevel GPUMem
</span><a href="#local-6989586621684450006"><span class="hs-identifier hs-var">segop</span></a></span><span>
</span><span id="line-128"></span><span>    </span><span class="annot"><span class="annottext">Exp GPUMem
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-129"></span><span>      </span><span class="annot"><span class="annottext">(Names, Names, Graph VName) -&gt; m (Names, Names, Graph VName)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Names, Names, Graph VName)
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-130"></span><span>
</span><span id="line-131"></span><span id="local-6989586621684450326"><span class="annot"><a href="Futhark.Analysis.Interference.html#analyseKernelBody"><span class="hs-identifier hs-type">analyseKernelBody</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-132"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#LocalScope"><span class="hs-identifier hs-type">LocalScope</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684450326"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-133"></span><span>  </span><span class="annot"><a href="Futhark.Analysis.LastUse.html#LastUseMap"><span class="hs-identifier hs-type">LastUseMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-134"></span><span>  </span><span class="annot"><a href="Futhark.Analysis.Interference.html#InUse"><span class="hs-identifier hs-type">InUse</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-135"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-type">KernelBody</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-136"></span><span>  </span><span class="annot"><a href="#local-6989586621684450326"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.Interference.html#InUse"><span class="hs-identifier hs-type">InUse</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Analysis.Interference.html#LastUsed"><span class="hs-identifier hs-type">LastUsed</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Analysis.Interference.html#Graph"><span class="hs-identifier hs-type">Graph</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-137"></span><span id="analyseKernelBody"><span class="annot"><span class="annottext">analyseKernelBody :: forall (m :: * -&gt; *).
LocalScope GPUMem m =&gt;
LastUseMap
-&gt; Names -&gt; KernelBody GPUMem -&gt; m (Names, Names, Graph VName)
</span><a href="Futhark.Analysis.Interference.html#analyseKernelBody"><span class="hs-identifier hs-var hs-var">analyseKernelBody</span></a></span></span><span> </span><span id="local-6989586621684450001"><span class="annot"><span class="annottext">LastUseMap
</span><a href="#local-6989586621684450001"><span class="hs-identifier hs-var">lumap</span></a></span></span><span> </span><span id="local-6989586621684450000"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684450000"><span class="hs-identifier hs-var">inuse</span></a></span></span><span> </span><span id="local-6989586621684449999"><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684449999"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LastUseMap -&gt; Names -&gt; Stms GPUMem -&gt; m (Names, Names, Graph VName)
forall (m :: * -&gt; *).
LocalScope GPUMem m =&gt;
LastUseMap -&gt; Names -&gt; Stms GPUMem -&gt; m (Names, Names, Graph VName)
</span><a href="Futhark.Analysis.Interference.html#analyseStms"><span class="hs-identifier hs-var">analyseStms</span></a></span><span> </span><span class="annot"><span class="annottext">LastUseMap
</span><a href="#local-6989586621684450001"><span class="hs-identifier hs-var">lumap</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684450000"><span class="hs-identifier hs-var">inuse</span></a></span><span> </span><span class="annot"><span class="annottext">(Stms GPUMem -&gt; m (Names, Names, Graph VName))
-&gt; Stms GPUMem -&gt; m (Names, Names, Graph VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem -&gt; Stms GPUMem
forall rep. KernelBody rep -&gt; Stms rep
</span><a href="Futhark.IR.SegOp.html#kernelBodyStms"><span class="hs-identifier hs-var hs-var">kernelBodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684449999"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-138"></span><span>
</span><span id="line-139"></span><span id="local-6989586621684450338"><span class="annot"><a href="Futhark.Analysis.Interference.html#analyseBody"><span class="hs-identifier hs-type">analyseBody</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-140"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#LocalScope"><span class="hs-identifier hs-type">LocalScope</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684450338"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-141"></span><span>  </span><span class="annot"><a href="Futhark.Analysis.LastUse.html#LastUseMap"><span class="hs-identifier hs-type">LastUseMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-142"></span><span>  </span><span class="annot"><a href="Futhark.Analysis.Interference.html#InUse"><span class="hs-identifier hs-type">InUse</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-143"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-144"></span><span>  </span><span class="annot"><a href="#local-6989586621684450338"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.Interference.html#InUse"><span class="hs-identifier hs-type">InUse</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Analysis.Interference.html#LastUsed"><span class="hs-identifier hs-type">LastUsed</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Analysis.Interference.html#Graph"><span class="hs-identifier hs-type">Graph</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-145"></span><span id="analyseBody"><span class="annot"><span class="annottext">analyseBody :: forall (m :: * -&gt; *).
LocalScope GPUMem m =&gt;
LastUseMap
-&gt; Names -&gt; BodyT GPUMem -&gt; m (Names, Names, Graph VName)
</span><a href="Futhark.Analysis.Interference.html#analyseBody"><span class="hs-identifier hs-var hs-var">analyseBody</span></a></span></span><span> </span><span id="local-6989586621684449993"><span class="annot"><span class="annottext">LastUseMap
</span><a href="#local-6989586621684449993"><span class="hs-identifier hs-var">lumap</span></a></span></span><span> </span><span id="local-6989586621684449992"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684449992"><span class="hs-identifier hs-var">inuse</span></a></span></span><span> </span><span id="local-6989586621684449991"><span class="annot"><span class="annottext">BodyT GPUMem
</span><a href="#local-6989586621684449991"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LastUseMap -&gt; Names -&gt; Stms GPUMem -&gt; m (Names, Names, Graph VName)
forall (m :: * -&gt; *).
LocalScope GPUMem m =&gt;
LastUseMap -&gt; Names -&gt; Stms GPUMem -&gt; m (Names, Names, Graph VName)
</span><a href="Futhark.Analysis.Interference.html#analyseStms"><span class="hs-identifier hs-var">analyseStms</span></a></span><span> </span><span class="annot"><span class="annottext">LastUseMap
</span><a href="#local-6989586621684449993"><span class="hs-identifier hs-var">lumap</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684449992"><span class="hs-identifier hs-var">inuse</span></a></span><span> </span><span class="annot"><span class="annottext">(Stms GPUMem -&gt; m (Names, Names, Graph VName))
-&gt; Stms GPUMem -&gt; m (Names, Names, Graph VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BodyT GPUMem -&gt; Stms GPUMem
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT GPUMem
</span><a href="#local-6989586621684449991"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-146"></span><span>
</span><span id="line-147"></span><span id="local-6989586621684450322"><span class="annot"><a href="Futhark.Analysis.Interference.html#analyseStms"><span class="hs-identifier hs-type">analyseStms</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-148"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#LocalScope"><span class="hs-identifier hs-type">LocalScope</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684450322"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-149"></span><span>  </span><span class="annot"><a href="Futhark.Analysis.LastUse.html#LastUseMap"><span class="hs-identifier hs-type">LastUseMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-150"></span><span>  </span><span class="annot"><a href="Futhark.Analysis.Interference.html#InUse"><span class="hs-identifier hs-type">InUse</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-151"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-152"></span><span>  </span><span class="annot"><a href="#local-6989586621684450322"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.Interference.html#InUse"><span class="hs-identifier hs-type">InUse</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Analysis.Interference.html#LastUsed"><span class="hs-identifier hs-type">LastUsed</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Analysis.Interference.html#Graph"><span class="hs-identifier hs-type">Graph</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-153"></span><span id="analyseStms"><span class="annot"><span class="annottext">analyseStms :: forall (m :: * -&gt; *).
LocalScope GPUMem m =&gt;
LastUseMap -&gt; Names -&gt; Stms GPUMem -&gt; m (Names, Names, Graph VName)
</span><a href="Futhark.Analysis.Interference.html#analyseStms"><span class="hs-identifier hs-var hs-var">analyseStms</span></a></span></span><span> </span><span id="local-6989586621684449975"><span class="annot"><span class="annottext">LastUseMap
</span><a href="#local-6989586621684449975"><span class="hs-identifier hs-var">lumap</span></a></span></span><span> </span><span id="local-6989586621684449974"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684449974"><span class="hs-identifier hs-var">inuse0</span></a></span></span><span> </span><span id="local-6989586621684449973"><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684449973"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-154"></span><span>  </span><span class="annot"><span class="annottext">Stms GPUMem
-&gt; m (Names, Names, Graph VName) -&gt; m (Names, Names, Graph VName)
forall rep a (m :: * -&gt; *) b.
(Scoped rep a, LocalScope rep m) =&gt;
a -&gt; m b -&gt; m b
</span><a href="Futhark.IR.Prop.Scope.html#inScopeOf"><span class="hs-identifier hs-var">inScopeOf</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684449973"><span class="hs-identifier hs-var">stms</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Names, Names, Graph VName) -&gt; m (Names, Names, Graph VName))
-&gt; m (Names, Names, Graph VName) -&gt; m (Names, Names, Graph VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((Names, Names, Graph VName)
 -&gt; Stm GPUMem -&gt; m (Names, Names, Graph VName))
-&gt; (Names, Names, Graph VName)
-&gt; [Stm GPUMem]
-&gt; m (Names, Names, Graph VName)
forall (t :: * -&gt; *) (m :: * -&gt; *) b a.
(Foldable t, Monad m) =&gt;
(b -&gt; a -&gt; m b) -&gt; b -&gt; t a -&gt; m b
</span><span class="hs-identifier hs-var">foldM</span></span><span> </span><span class="annot"><span class="annottext">(Names, Names, Graph VName)
-&gt; Stm GPUMem -&gt; m (Names, Names, Graph VName)
</span><a href="#local-6989586621684449971"><span class="hs-identifier hs-var">helper</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684449974"><span class="hs-identifier hs-var">inuse0</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Graph VName
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Stm GPUMem] -&gt; m (Names, Names, Graph VName))
-&gt; [Stm GPUMem] -&gt; m (Names, Names, Graph VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stms GPUMem -&gt; [Stm GPUMem]
forall rep. Stms rep -&gt; [Stm rep]
</span><a href="Futhark.IR.Syntax.html#stmsToList"><span class="hs-identifier hs-var">stmsToList</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684449973"><span class="hs-identifier hs-var">stms</span></a></span><span>
</span><span id="line-155"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-156"></span><span>    </span><span id="local-6989586621684449971"><span class="annot"><span class="annottext">helper :: (Names, Names, Graph VName)
-&gt; Stm GPUMem -&gt; m (Names, Names, Graph VName)
</span><a href="#local-6989586621684449971"><span class="hs-identifier hs-var hs-var">helper</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684449969"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684449969"><span class="hs-identifier hs-var">inuse</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684449968"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684449968"><span class="hs-identifier hs-var">lus</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684449967"><span class="annot"><span class="annottext">Graph VName
</span><a href="#local-6989586621684449967"><span class="hs-identifier hs-var">graph</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684449966"><span class="annot"><span class="annottext">Stm GPUMem
</span><a href="#local-6989586621684449966"><span class="hs-identifier hs-var">stm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-157"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684449965"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684449965"><span class="hs-identifier hs-var">inuse'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684449964"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684449964"><span class="hs-identifier hs-var">lus'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684449963"><span class="annot"><span class="annottext">Graph VName
</span><a href="#local-6989586621684449963"><span class="hs-identifier hs-var">graph'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LastUseMap -&gt; Names -&gt; Stm GPUMem -&gt; m (Names, Names, Graph VName)
forall (m :: * -&gt; *).
LocalScope GPUMem m =&gt;
LastUseMap -&gt; Names -&gt; Stm GPUMem -&gt; m (Names, Names, Graph VName)
</span><a href="Futhark.Analysis.Interference.html#analyseStm"><span class="hs-identifier hs-var">analyseStm</span></a></span><span> </span><span class="annot"><span class="annottext">LastUseMap
</span><a href="#local-6989586621684449975"><span class="hs-identifier hs-var">lumap</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684449969"><span class="hs-identifier hs-var">inuse</span></a></span><span> </span><span class="annot"><span class="annottext">Stm GPUMem
</span><a href="#local-6989586621684449966"><span class="hs-identifier hs-var">stm</span></a></span><span>
</span><span id="line-158"></span><span>      </span><span class="annot"><span class="annottext">(Names, Names, Graph VName) -&gt; m (Names, Names, Graph VName)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684449965"><span class="hs-identifier hs-var">inuse'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684449964"><span class="hs-identifier hs-var">lus'</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684449968"><span class="hs-identifier hs-var">lus</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Graph VName
</span><a href="#local-6989586621684449963"><span class="hs-identifier hs-var">graph'</span></a></span><span> </span><span class="annot"><span class="annottext">Graph VName -&gt; Graph VName -&gt; Graph VName
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Graph VName
</span><a href="#local-6989586621684449967"><span class="hs-identifier hs-var">graph</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-159"></span><span>
</span><span id="line-160"></span><span id="local-6989586621684450327"><span id="local-6989586621684450328"><span class="annot"><a href="Futhark.Analysis.Interference.html#analyseSegOp"><span class="hs-identifier hs-type">analyseSegOp</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-161"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#LocalScope"><span class="hs-identifier hs-type">LocalScope</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684450328"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-162"></span><span>  </span><span class="annot"><a href="Futhark.Analysis.LastUse.html#LastUseMap"><span class="hs-identifier hs-type">LastUseMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-163"></span><span>  </span><span class="annot"><a href="Futhark.Analysis.Interference.html#InUse"><span class="hs-identifier hs-type">InUse</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-164"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegOp"><span class="hs-identifier hs-type">SegOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684450327"><span class="hs-identifier hs-type">lvl</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-165"></span><span>  </span><span class="annot"><a href="#local-6989586621684450328"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.Interference.html#InUse"><span class="hs-identifier hs-type">InUse</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Analysis.Interference.html#LastUsed"><span class="hs-identifier hs-type">LastUsed</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Analysis.Interference.html#Graph"><span class="hs-identifier hs-type">Graph</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-166"></span><span id="analyseSegOp"><span class="annot"><span class="annottext">analyseSegOp :: forall (m :: * -&gt; *) lvl.
LocalScope GPUMem m =&gt;
LastUseMap
-&gt; Names -&gt; SegOp lvl GPUMem -&gt; m (Names, Names, Graph VName)
</span><a href="Futhark.Analysis.Interference.html#analyseSegOp"><span class="hs-identifier hs-var hs-var">analyseSegOp</span></a></span></span><span> </span><span id="local-6989586621684449941"><span class="annot"><span class="annottext">LastUseMap
</span><a href="#local-6989586621684449941"><span class="hs-identifier hs-var">lumap</span></a></span></span><span> </span><span id="local-6989586621684449940"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684449940"><span class="hs-identifier hs-var">inuse</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#SegMap"><span class="hs-identifier hs-type">SegMap</span></a></span><span> </span><span class="annot"><span class="annottext">lvl
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684449938"><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684449938"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-167"></span><span>  </span><span class="annot"><span class="annottext">LastUseMap
-&gt; Names -&gt; KernelBody GPUMem -&gt; m (Names, Names, Graph VName)
forall (m :: * -&gt; *).
LocalScope GPUMem m =&gt;
LastUseMap
-&gt; Names -&gt; KernelBody GPUMem -&gt; m (Names, Names, Graph VName)
</span><a href="Futhark.Analysis.Interference.html#analyseKernelBody"><span class="hs-identifier hs-var">analyseKernelBody</span></a></span><span> </span><span class="annot"><span class="annottext">LastUseMap
</span><a href="#local-6989586621684449941"><span class="hs-identifier hs-var">lumap</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684449940"><span class="hs-identifier hs-var">inuse</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684449938"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-168"></span><span class="annot"><a href="Futhark.Analysis.Interference.html#analyseSegOp"><span class="hs-identifier hs-var">analyseSegOp</span></a></span><span> </span><span id="local-6989586621684449937"><span class="annot"><span class="annottext">LastUseMap
</span><a href="#local-6989586621684449937"><span class="hs-identifier hs-var">lumap</span></a></span></span><span> </span><span id="local-6989586621684449936"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684449936"><span class="hs-identifier hs-var">inuse</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#SegRed"><span class="hs-identifier hs-type">SegRed</span></a></span><span> </span><span class="annot"><span class="annottext">lvl
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684449934"><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684449934"><span class="hs-identifier hs-var">binops</span></a></span></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684449933"><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684449933"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-169"></span><span>  </span><span class="annot"><span class="annottext">LastUseMap
-&gt; Names
-&gt; [SegBinOp GPUMem]
-&gt; KernelBody GPUMem
-&gt; m (Names, Names, Graph VName)
forall (m :: * -&gt; *).
LocalScope GPUMem m =&gt;
LastUseMap
-&gt; Names
-&gt; [SegBinOp GPUMem]
-&gt; KernelBody GPUMem
-&gt; m (Names, Names, Graph VName)
</span><a href="Futhark.Analysis.Interference.html#segWithBinOps"><span class="hs-identifier hs-var">segWithBinOps</span></a></span><span> </span><span class="annot"><span class="annottext">LastUseMap
</span><a href="#local-6989586621684449937"><span class="hs-identifier hs-var">lumap</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684449936"><span class="hs-identifier hs-var">inuse</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684449934"><span class="hs-identifier hs-var">binops</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684449933"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-170"></span><span class="annot"><a href="Futhark.Analysis.Interference.html#analyseSegOp"><span class="hs-identifier hs-var">analyseSegOp</span></a></span><span> </span><span id="local-6989586621684449931"><span class="annot"><span class="annottext">LastUseMap
</span><a href="#local-6989586621684449931"><span class="hs-identifier hs-var">lumap</span></a></span></span><span> </span><span id="local-6989586621684449930"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684449930"><span class="hs-identifier hs-var">inuse</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#SegScan"><span class="hs-identifier hs-type">SegScan</span></a></span><span> </span><span class="annot"><span class="annottext">lvl
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684449928"><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684449928"><span class="hs-identifier hs-var">binops</span></a></span></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684449927"><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684449927"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-171"></span><span>  </span><span class="annot"><span class="annottext">LastUseMap
-&gt; Names
-&gt; [SegBinOp GPUMem]
-&gt; KernelBody GPUMem
-&gt; m (Names, Names, Graph VName)
forall (m :: * -&gt; *).
LocalScope GPUMem m =&gt;
LastUseMap
-&gt; Names
-&gt; [SegBinOp GPUMem]
-&gt; KernelBody GPUMem
-&gt; m (Names, Names, Graph VName)
</span><a href="Futhark.Analysis.Interference.html#segWithBinOps"><span class="hs-identifier hs-var">segWithBinOps</span></a></span><span> </span><span class="annot"><span class="annottext">LastUseMap
</span><a href="#local-6989586621684449931"><span class="hs-identifier hs-var">lumap</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684449930"><span class="hs-identifier hs-var">inuse</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684449928"><span class="hs-identifier hs-var">binops</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684449927"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-172"></span><span class="annot"><a href="Futhark.Analysis.Interference.html#analyseSegOp"><span class="hs-identifier hs-var">analyseSegOp</span></a></span><span> </span><span id="local-6989586621684449926"><span class="annot"><span class="annottext">LastUseMap
</span><a href="#local-6989586621684449926"><span class="hs-identifier hs-var">lumap</span></a></span></span><span> </span><span id="local-6989586621684449925"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684449925"><span class="hs-identifier hs-var">inuse</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#SegHist"><span class="hs-identifier hs-type">SegHist</span></a></span><span> </span><span class="annot"><span class="annottext">lvl
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684449923"><span class="annot"><span class="annottext">[HistOp GPUMem]
</span><a href="#local-6989586621684449923"><span class="hs-identifier hs-var">histops</span></a></span></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684449922"><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684449922"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-173"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684449921"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684449921"><span class="hs-identifier hs-var">inuse'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684449920"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684449920"><span class="hs-identifier hs-var">lus'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684449919"><span class="annot"><span class="annottext">Graph VName
</span><a href="#local-6989586621684449919"><span class="hs-identifier hs-var">graph</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LastUseMap
-&gt; Names -&gt; KernelBody GPUMem -&gt; m (Names, Names, Graph VName)
forall (m :: * -&gt; *).
LocalScope GPUMem m =&gt;
LastUseMap
-&gt; Names -&gt; KernelBody GPUMem -&gt; m (Names, Names, Graph VName)
</span><a href="Futhark.Analysis.Interference.html#analyseKernelBody"><span class="hs-identifier hs-var">analyseKernelBody</span></a></span><span> </span><span class="annot"><span class="annottext">LastUseMap
</span><a href="#local-6989586621684449926"><span class="hs-identifier hs-var">lumap</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684449925"><span class="hs-identifier hs-var">inuse</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684449922"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-174"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684449918"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684449918"><span class="hs-identifier hs-var">inuse''</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684449917"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684449917"><span class="hs-identifier hs-var">lus''</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684449916"><span class="annot"><span class="annottext">Graph VName
</span><a href="#local-6989586621684449916"><span class="hs-identifier hs-var">graph'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Names, Names, Graph VName)] -&gt; (Names, Names, Graph VName)
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">([(Names, Names, Graph VName)] -&gt; (Names, Names, Graph VName))
-&gt; m [(Names, Names, Graph VName)] -&gt; m (Names, Names, Graph VName)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(HistOp GPUMem -&gt; m (Names, Names, Graph VName))
-&gt; [HistOp GPUMem] -&gt; m [(Names, Names, Graph VName)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LastUseMap
-&gt; Names -&gt; HistOp GPUMem -&gt; m (Names, Names, Graph VName)
forall (m :: * -&gt; *).
LocalScope GPUMem m =&gt;
LastUseMap
-&gt; Names -&gt; HistOp GPUMem -&gt; m (Names, Names, Graph VName)
</span><a href="Futhark.Analysis.Interference.html#analyseHistOp"><span class="hs-identifier hs-var">analyseHistOp</span></a></span><span> </span><span class="annot"><span class="annottext">LastUseMap
</span><a href="#local-6989586621684449926"><span class="hs-identifier hs-var">lumap</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684449921"><span class="hs-identifier hs-var">inuse'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[HistOp GPUMem]
</span><a href="#local-6989586621684449923"><span class="hs-identifier hs-var">histops</span></a></span><span>
</span><span id="line-175"></span><span>  </span><span class="annot"><span class="annottext">(Names, Names, Graph VName) -&gt; m (Names, Names, Graph VName)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684449918"><span class="hs-identifier hs-var">inuse''</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684449920"><span class="hs-identifier hs-var">lus'</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684449917"><span class="hs-identifier hs-var">lus''</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Graph VName
</span><a href="#local-6989586621684449919"><span class="hs-identifier hs-var">graph</span></a></span><span> </span><span class="annot"><span class="annottext">Graph VName -&gt; Graph VName -&gt; Graph VName
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Graph VName
</span><a href="#local-6989586621684449916"><span class="hs-identifier hs-var">graph'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-176"></span><span>
</span><span id="line-177"></span><span id="local-6989586621684450306"><span class="annot"><a href="Futhark.Analysis.Interference.html#segWithBinOps"><span class="hs-identifier hs-type">segWithBinOps</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-178"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#LocalScope"><span class="hs-identifier hs-type">LocalScope</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684450306"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-179"></span><span>  </span><span class="annot"><a href="Futhark.Analysis.LastUse.html#LastUseMap"><span class="hs-identifier hs-type">LastUseMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-180"></span><span>  </span><span class="annot"><a href="Futhark.Analysis.Interference.html#InUse"><span class="hs-identifier hs-type">InUse</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-181"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.SegOp.html#SegBinOp"><span class="hs-identifier hs-type">SegBinOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-182"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-type">KernelBody</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-183"></span><span>  </span><span class="annot"><a href="#local-6989586621684450306"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.Interference.html#InUse"><span class="hs-identifier hs-type">InUse</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Analysis.Interference.html#LastUsed"><span class="hs-identifier hs-type">LastUsed</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Analysis.Interference.html#Graph"><span class="hs-identifier hs-type">Graph</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-184"></span><span id="segWithBinOps"><span class="annot"><span class="annottext">segWithBinOps :: forall (m :: * -&gt; *).
LocalScope GPUMem m =&gt;
LastUseMap
-&gt; Names
-&gt; [SegBinOp GPUMem]
-&gt; KernelBody GPUMem
-&gt; m (Names, Names, Graph VName)
</span><a href="Futhark.Analysis.Interference.html#segWithBinOps"><span class="hs-identifier hs-var hs-var">segWithBinOps</span></a></span></span><span> </span><span id="local-6989586621684449896"><span class="annot"><span class="annottext">LastUseMap
</span><a href="#local-6989586621684449896"><span class="hs-identifier hs-var">lumap</span></a></span></span><span> </span><span id="local-6989586621684449895"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684449895"><span class="hs-identifier hs-var">inuse</span></a></span></span><span> </span><span id="local-6989586621684449894"><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684449894"><span class="hs-identifier hs-var">binops</span></a></span></span><span> </span><span id="local-6989586621684449893"><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684449893"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-185"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684449892"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684449892"><span class="hs-identifier hs-var">inuse'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684449891"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684449891"><span class="hs-identifier hs-var">lus'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684449890"><span class="annot"><span class="annottext">Graph VName
</span><a href="#local-6989586621684449890"><span class="hs-identifier hs-var">graph</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LastUseMap
-&gt; Names -&gt; KernelBody GPUMem -&gt; m (Names, Names, Graph VName)
forall (m :: * -&gt; *).
LocalScope GPUMem m =&gt;
LastUseMap
-&gt; Names -&gt; KernelBody GPUMem -&gt; m (Names, Names, Graph VName)
</span><a href="Futhark.Analysis.Interference.html#analyseKernelBody"><span class="hs-identifier hs-var">analyseKernelBody</span></a></span><span> </span><span class="annot"><span class="annottext">LastUseMap
</span><a href="#local-6989586621684449896"><span class="hs-identifier hs-var">lumap</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684449895"><span class="hs-identifier hs-var">inuse</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684449893"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-186"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684449889"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684449889"><span class="hs-identifier hs-var">inuse''</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684449888"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684449888"><span class="hs-identifier hs-var">lus''</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684449887"><span class="annot"><span class="annottext">Graph VName
</span><a href="#local-6989586621684449887"><span class="hs-identifier hs-var">graph'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-187"></span><span>    </span><span class="annot"><span class="annottext">[(Names, Names, Graph VName)] -&gt; (Names, Names, Graph VName)
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span>
</span><span id="line-188"></span><span>      </span><span class="annot"><span class="annottext">([(Names, Names, Graph VName)] -&gt; (Names, Names, Graph VName))
-&gt; m [(Names, Names, Graph VName)] -&gt; m (Names, Names, Graph VName)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(SegBinOp GPUMem -&gt; m (Names, Names, Graph VName))
-&gt; [SegBinOp GPUMem] -&gt; m [(Names, Names, Graph VName)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span>
</span><span id="line-189"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LastUseMap
-&gt; Names -&gt; SegBinOp GPUMem -&gt; m (Names, Names, Graph VName)
forall (m :: * -&gt; *).
LocalScope GPUMem m =&gt;
LastUseMap
-&gt; Names -&gt; SegBinOp GPUMem -&gt; m (Names, Names, Graph VName)
</span><a href="Futhark.Analysis.Interference.html#analyseSegBinOp"><span class="hs-identifier hs-var">analyseSegBinOp</span></a></span><span> </span><span class="annot"><span class="annottext">LastUseMap
</span><a href="#local-6989586621684449896"><span class="hs-identifier hs-var">lumap</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684449892"><span class="hs-identifier hs-var">inuse'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-190"></span><span>        </span><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684449894"><span class="hs-identifier hs-var">binops</span></a></span><span>
</span><span id="line-191"></span><span>  </span><span class="annot"><span class="annottext">(Names, Names, Graph VName) -&gt; m (Names, Names, Graph VName)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684449889"><span class="hs-identifier hs-var">inuse''</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684449891"><span class="hs-identifier hs-var">lus'</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684449888"><span class="hs-identifier hs-var">lus''</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Graph VName
</span><a href="#local-6989586621684449890"><span class="hs-identifier hs-var">graph</span></a></span><span> </span><span class="annot"><span class="annottext">Graph VName -&gt; Graph VName -&gt; Graph VName
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Graph VName
</span><a href="#local-6989586621684449887"><span class="hs-identifier hs-var">graph'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-192"></span><span>
</span><span id="line-193"></span><span id="local-6989586621684450302"><span class="annot"><a href="Futhark.Analysis.Interference.html#analyseSegBinOp"><span class="hs-identifier hs-type">analyseSegBinOp</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-194"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#LocalScope"><span class="hs-identifier hs-type">LocalScope</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684450302"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-195"></span><span>  </span><span class="annot"><a href="Futhark.Analysis.LastUse.html#LastUseMap"><span class="hs-identifier hs-type">LastUseMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-196"></span><span>  </span><span class="annot"><a href="Futhark.Analysis.Interference.html#InUse"><span class="hs-identifier hs-type">InUse</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-197"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegBinOp"><span class="hs-identifier hs-type">SegBinOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-198"></span><span>  </span><span class="annot"><a href="#local-6989586621684450302"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.Interference.html#InUse"><span class="hs-identifier hs-type">InUse</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Analysis.Interference.html#LastUsed"><span class="hs-identifier hs-type">LastUsed</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Analysis.Interference.html#Graph"><span class="hs-identifier hs-type">Graph</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-199"></span><span id="analyseSegBinOp"><span class="annot"><span class="annottext">analyseSegBinOp :: forall (m :: * -&gt; *).
LocalScope GPUMem m =&gt;
LastUseMap
-&gt; Names -&gt; SegBinOp GPUMem -&gt; m (Names, Names, Graph VName)
</span><a href="Futhark.Analysis.Interference.html#analyseSegBinOp"><span class="hs-identifier hs-var hs-var">analyseSegBinOp</span></a></span></span><span> </span><span id="local-6989586621684449883"><span class="annot"><span class="annottext">LastUseMap
</span><a href="#local-6989586621684449883"><span class="hs-identifier hs-var">lumap</span></a></span></span><span> </span><span id="local-6989586621684449882"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684449882"><span class="hs-identifier hs-var">inuse</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#SegBinOp"><span class="hs-identifier hs-type">SegBinOp</span></a></span><span> </span><span class="annot"><span class="annottext">Commutativity
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684449880"><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684449880"><span class="hs-identifier hs-var">lambda</span></a></span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Shape
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-200"></span><span>  </span><span class="annot"><span class="annottext">LastUseMap
-&gt; Names -&gt; Lambda GPUMem -&gt; m (Names, Names, Graph VName)
forall (m :: * -&gt; *).
LocalScope GPUMem m =&gt;
LastUseMap
-&gt; Names -&gt; Lambda GPUMem -&gt; m (Names, Names, Graph VName)
</span><a href="Futhark.Analysis.Interference.html#analyseLambda"><span class="hs-identifier hs-var">analyseLambda</span></a></span><span> </span><span class="annot"><span class="annottext">LastUseMap
</span><a href="#local-6989586621684449883"><span class="hs-identifier hs-var">lumap</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684449882"><span class="hs-identifier hs-var">inuse</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684449880"><span class="hs-identifier hs-var">lambda</span></a></span><span>
</span><span id="line-201"></span><span>
</span><span id="line-202"></span><span id="local-6989586621684450304"><span class="annot"><a href="Futhark.Analysis.Interference.html#analyseHistOp"><span class="hs-identifier hs-type">analyseHistOp</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-203"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#LocalScope"><span class="hs-identifier hs-type">LocalScope</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684450304"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-204"></span><span>  </span><span class="annot"><a href="Futhark.Analysis.LastUse.html#LastUseMap"><span class="hs-identifier hs-type">LastUseMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-205"></span><span>  </span><span class="annot"><a href="Futhark.Analysis.Interference.html#InUse"><span class="hs-identifier hs-type">InUse</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-206"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#HistOp"><span class="hs-identifier hs-type">HistOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-207"></span><span>  </span><span class="annot"><a href="#local-6989586621684450304"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.Interference.html#InUse"><span class="hs-identifier hs-type">InUse</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Analysis.Interference.html#LastUsed"><span class="hs-identifier hs-type">LastUsed</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Analysis.Interference.html#Graph"><span class="hs-identifier hs-type">Graph</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-208"></span><span id="analyseHistOp"><span class="annot"><span class="annottext">analyseHistOp :: forall (m :: * -&gt; *).
LocalScope GPUMem m =&gt;
LastUseMap
-&gt; Names -&gt; HistOp GPUMem -&gt; m (Names, Names, Graph VName)
</span><a href="Futhark.Analysis.Interference.html#analyseHistOp"><span class="hs-identifier hs-var hs-var">analyseHistOp</span></a></span></span><span> </span><span id="local-6989586621684449876"><span class="annot"><span class="annottext">LastUseMap
</span><a href="#local-6989586621684449876"><span class="hs-identifier hs-var">lumap</span></a></span></span><span> </span><span id="local-6989586621684449875"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684449875"><span class="hs-identifier hs-var">inuse</span></a></span></span><span> </span><span id="local-6989586621684449874"><span class="annot"><span class="annottext">HistOp GPUMem
</span><a href="#local-6989586621684449874"><span class="hs-identifier hs-var">histop</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-209"></span><span>  </span><span class="annot"><span class="annottext">LastUseMap
-&gt; Names -&gt; Lambda GPUMem -&gt; m (Names, Names, Graph VName)
forall (m :: * -&gt; *).
LocalScope GPUMem m =&gt;
LastUseMap
-&gt; Names -&gt; Lambda GPUMem -&gt; m (Names, Names, Graph VName)
</span><a href="Futhark.Analysis.Interference.html#analyseLambda"><span class="hs-identifier hs-var">analyseLambda</span></a></span><span> </span><span class="annot"><span class="annottext">LastUseMap
</span><a href="#local-6989586621684449876"><span class="hs-identifier hs-var">lumap</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684449875"><span class="hs-identifier hs-var">inuse</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HistOp GPUMem -&gt; Lambda GPUMem
forall rep. HistOp rep -&gt; Lambda rep
</span><a href="Futhark.IR.SegOp.html#histOp"><span class="hs-identifier hs-var hs-var">histOp</span></a></span><span> </span><span class="annot"><span class="annottext">HistOp GPUMem
</span><a href="#local-6989586621684449874"><span class="hs-identifier hs-var">histop</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-210"></span><span>
</span><span id="line-211"></span><span id="local-6989586621684450297"><span class="annot"><a href="Futhark.Analysis.Interference.html#analyseLambda"><span class="hs-identifier hs-type">analyseLambda</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-212"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#LocalScope"><span class="hs-identifier hs-type">LocalScope</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684450297"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-213"></span><span>  </span><span class="annot"><a href="Futhark.Analysis.LastUse.html#LastUseMap"><span class="hs-identifier hs-type">LastUseMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-214"></span><span>  </span><span class="annot"><a href="Futhark.Analysis.Interference.html#InUse"><span class="hs-identifier hs-type">InUse</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-215"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-216"></span><span>  </span><span class="annot"><a href="#local-6989586621684450297"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.Interference.html#InUse"><span class="hs-identifier hs-type">InUse</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Analysis.Interference.html#LastUsed"><span class="hs-identifier hs-type">LastUsed</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Analysis.Interference.html#Graph"><span class="hs-identifier hs-type">Graph</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-217"></span><span id="analyseLambda"><span class="annot"><span class="annottext">analyseLambda :: forall (m :: * -&gt; *).
LocalScope GPUMem m =&gt;
LastUseMap
-&gt; Names -&gt; Lambda GPUMem -&gt; m (Names, Names, Graph VName)
</span><a href="Futhark.Analysis.Interference.html#analyseLambda"><span class="hs-identifier hs-var hs-var">analyseLambda</span></a></span></span><span> </span><span id="local-6989586621684449870"><span class="annot"><span class="annottext">LastUseMap
</span><a href="#local-6989586621684449870"><span class="hs-identifier hs-var">lumap</span></a></span></span><span> </span><span id="local-6989586621684449869"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684449869"><span class="hs-identifier hs-var">inuse</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><span class="annottext">[LParam GPUMem]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684449867"><span class="annot"><span class="annottext">BodyT GPUMem
</span><a href="#local-6989586621684449867"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-218"></span><span>  </span><span class="annot"><span class="annottext">LastUseMap
-&gt; Names -&gt; BodyT GPUMem -&gt; m (Names, Names, Graph VName)
forall (m :: * -&gt; *).
LocalScope GPUMem m =&gt;
LastUseMap
-&gt; Names -&gt; BodyT GPUMem -&gt; m (Names, Names, Graph VName)
</span><a href="Futhark.Analysis.Interference.html#analyseBody"><span class="hs-identifier hs-var">analyseBody</span></a></span><span> </span><span class="annot"><span class="annottext">LastUseMap
</span><a href="#local-6989586621684449870"><span class="hs-identifier hs-var">lumap</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684449869"><span class="hs-identifier hs-var">inuse</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT GPUMem
</span><a href="#local-6989586621684449867"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-219"></span><span>
</span><span id="line-220"></span><span class="annot"><a href="Futhark.Analysis.Interference.html#analyseProgGPU"><span class="hs-identifier hs-type">analyseProgGPU</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Prog"><span class="hs-identifier hs-type">Prog</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Analysis.Interference.html#Graph"><span class="hs-identifier hs-type">Graph</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span>
</span><span id="line-221"></span><span id="analyseProgGPU"><span class="annot"><span class="annottext">analyseProgGPU :: Prog GPUMem -&gt; Graph VName
</span><a href="Futhark.Analysis.Interference.html#analyseProgGPU"><span class="hs-identifier hs-var hs-var">analyseProgGPU</span></a></span></span><span> </span><span id="local-6989586621684449866"><span class="annot"><span class="annottext">Prog GPUMem
</span><a href="#local-6989586621684449866"><span class="hs-identifier hs-var">prog</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-222"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684449865"><span class="annot"><span class="annottext">LastUseMap
</span><a href="#local-6989586621684449865"><span class="hs-identifier hs-var">lumap</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Names
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Prog GPUMem -&gt; (LastUseMap, Names)
</span><a href="Futhark.Analysis.LastUse.html#analyseGPUMem"><span class="hs-identifier hs-var">LastUse.analyseGPUMem</span></a></span><span> </span><span class="annot"><span class="annottext">Prog GPUMem
</span><a href="#local-6989586621684449866"><span class="hs-identifier hs-var">prog</span></a></span><span>
</span><span id="line-223"></span><span>      </span><span id="local-6989586621684449863"><span class="annot"><span class="annottext">graph :: Graph VName
</span><a href="#local-6989586621684449863"><span class="hs-identifier hs-var hs-var">graph</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-224"></span><span>        </span><span class="annot"><span class="annottext">(FunDef GPUMem -&gt; Graph VName) -&gt; [FunDef GPUMem] -&gt; Graph VName
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span>
</span><span id="line-225"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684449862"><span class="annot"><span class="annottext">FunDef GPUMem
</span><a href="#local-6989586621684449862"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-226"></span><span>              </span><span class="annot"><span class="annottext">Reader (Scope GPUMem) (Graph VName) -&gt; Scope GPUMem -&gt; Graph VName
forall r a. Reader r a -&gt; r -&gt; a
</span><span class="hs-identifier hs-var">runReader</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LastUseMap -&gt; Stms GPUMem -&gt; Reader (Scope GPUMem) (Graph VName)
forall (m :: * -&gt; *).
LocalScope GPUMem m =&gt;
LastUseMap -&gt; Stms GPUMem -&gt; m (Graph VName)
</span><a href="Futhark.Analysis.Interference.html#analyseGPU"><span class="hs-identifier hs-var">analyseGPU</span></a></span><span> </span><span class="annot"><span class="annottext">LastUseMap
</span><a href="#local-6989586621684449865"><span class="hs-identifier hs-var">lumap</span></a></span><span> </span><span class="annot"><span class="annottext">(Stms GPUMem -&gt; Reader (Scope GPUMem) (Graph VName))
-&gt; Stms GPUMem -&gt; Reader (Scope GPUMem) (Graph VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BodyT GPUMem -&gt; Stms GPUMem
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">(BodyT GPUMem -&gt; Stms GPUMem) -&gt; BodyT GPUMem -&gt; Stms GPUMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FunDef GPUMem -&gt; BodyT GPUMem
forall rep. FunDef rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#funDefBody"><span class="hs-identifier hs-var hs-var">funDefBody</span></a></span><span> </span><span class="annot"><span class="annottext">FunDef GPUMem
</span><a href="#local-6989586621684449862"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Scope GPUMem -&gt; Graph VName) -&gt; Scope GPUMem -&gt; Graph VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-227"></span><span>                </span><span class="annot"><span class="annottext">FunDef GPUMem -&gt; Scope GPUMem
forall rep a. Scoped rep a =&gt; a -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOf"><span class="hs-identifier hs-var">scopeOf</span></a></span><span> </span><span class="annot"><span class="annottext">FunDef GPUMem
</span><a href="#local-6989586621684449862"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-228"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-229"></span><span>          </span><span class="annot"><span class="annottext">([FunDef GPUMem] -&gt; Graph VName) -&gt; [FunDef GPUMem] -&gt; Graph VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Prog GPUMem -&gt; [FunDef GPUMem]
forall rep. Prog rep -&gt; [FunDef rep]
</span><a href="Futhark.IR.Syntax.html#progFuns"><span class="hs-identifier hs-var hs-var">progFuns</span></a></span><span> </span><span class="annot"><span class="annottext">Prog GPUMem
</span><a href="#local-6989586621684449866"><span class="hs-identifier hs-var">prog</span></a></span><span>
</span><span id="line-230"></span><span>      </span><span id="local-6989586621684449856"><span class="annot"><span class="annottext">graph' :: Graph VName
</span><a href="#local-6989586621684449856"><span class="hs-identifier hs-var hs-var">graph'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MemAliases -&gt; Graph VName -&gt; Graph VName
</span><a href="Futhark.Analysis.Interference.html#applyAliases"><span class="hs-identifier hs-var">applyAliases</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Prog GPUMem -&gt; MemAliases
</span><a href="Futhark.Analysis.MemAlias.html#analyzeGPUMem"><span class="hs-identifier hs-var">MemAlias.analyzeGPUMem</span></a></span><span> </span><span class="annot"><span class="annottext">Prog GPUMem
</span><a href="#local-6989586621684449866"><span class="hs-identifier hs-var">prog</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Graph VName
</span><a href="#local-6989586621684449863"><span class="hs-identifier hs-var">graph</span></a></span><span>
</span><span id="line-231"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Graph VName
</span><a href="#local-6989586621684449856"><span class="hs-identifier hs-var">graph'</span></a></span><span>
</span><span id="line-232"></span><span>
</span><span id="line-233"></span><span class="annot"><a href="Futhark.Analysis.Interference.html#applyAliases"><span class="hs-identifier hs-type">applyAliases</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Analysis.MemAlias.html#MemAliases"><span class="hs-identifier hs-type">MemAlias.MemAliases</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Analysis.Interference.html#Graph"><span class="hs-identifier hs-type">Graph</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Analysis.Interference.html#Graph"><span class="hs-identifier hs-type">Graph</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span>
</span><span id="line-234"></span><span id="applyAliases"><span class="annot"><span class="annottext">applyAliases :: MemAliases -&gt; Graph VName -&gt; Graph VName
</span><a href="Futhark.Analysis.Interference.html#applyAliases"><span class="hs-identifier hs-var hs-var">applyAliases</span></a></span></span><span> </span><span id="local-6989586621684449853"><span class="annot"><span class="annottext">MemAliases
</span><a href="#local-6989586621684449853"><span class="hs-identifier hs-var">aliases</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-235"></span><span>  </span><span class="hs-comment">-- For each pair @(x, y)@ in graph, all memory aliases of x should interfere with all memory aliases of y</span><span>
</span><span id="line-236"></span><span>  </span><span class="annot"><span class="annottext">((VName, VName) -&gt; Graph VName) -&gt; Graph VName -&gt; Graph VName
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span>
</span><span id="line-237"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684449852"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684449852"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684449851"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684449851"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-238"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684449850"><span class="annot"><span class="annottext">xs :: Names
</span><a href="#local-6989586621684449850"><span class="hs-identifier hs-var hs-var">xs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MemAliases -&gt; VName -&gt; Names
</span><a href="Futhark.Analysis.MemAlias.html#aliasesOf"><span class="hs-identifier hs-var">MemAlias.aliasesOf</span></a></span><span> </span><span class="annot"><span class="annottext">MemAliases
</span><a href="#local-6989586621684449853"><span class="hs-identifier hs-var">aliases</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684449852"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#oneName"><span class="hs-identifier hs-var">oneName</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684449852"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-239"></span><span>            </span><span id="local-6989586621684449847"><span class="annot"><span class="annottext">ys :: Names
</span><a href="#local-6989586621684449847"><span class="hs-identifier hs-var hs-var">ys</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MemAliases -&gt; VName -&gt; Names
</span><a href="Futhark.Analysis.MemAlias.html#aliasesOf"><span class="hs-identifier hs-var">MemAlias.aliasesOf</span></a></span><span> </span><span class="annot"><span class="annottext">MemAliases
</span><a href="#local-6989586621684449853"><span class="hs-identifier hs-var">aliases</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684449851"><span class="hs-identifier hs-var">y</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#oneName"><span class="hs-identifier hs-var">oneName</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684449851"><span class="hs-identifier hs-var">y</span></a></span><span>
</span><span id="line-240"></span><span>         </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; VName -&gt; Graph VName)
-&gt; [VName] -&gt; [VName] -&gt; Graph VName
forall m (t :: * -&gt; *) a.
(Monoid m, Foldable t) =&gt;
(a -&gt; a -&gt; m) -&gt; t a -&gt; t a -&gt; m
</span><a href="Futhark.Analysis.Interference.html#cartesian"><span class="hs-identifier hs-var">cartesian</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; VName -&gt; Graph VName
forall a. Ord a =&gt; a -&gt; a -&gt; Graph a
</span><a href="Futhark.Analysis.Interference.html#makeEdge"><span class="hs-identifier hs-var">makeEdge</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Names -&gt; [VName]
</span><a href="Futhark.IR.Prop.Names.html#namesToList"><span class="hs-identifier hs-var">namesToList</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684449850"><span class="hs-identifier hs-var">xs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Names -&gt; [VName]
</span><a href="Futhark.IR.Prop.Names.html#namesToList"><span class="hs-identifier hs-var">namesToList</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684449847"><span class="hs-identifier hs-var">ys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-241"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-242"></span><span>
</span><span id="line-243"></span><span class="hs-comment">-- | Perform interference analysis on the given statements. The result is a</span><span>
</span><span id="line-244"></span><span class="hs-comment">-- triple of the names currently in use, names that hit their last use somewhere</span><span>
</span><span id="line-245"></span><span class="hs-comment">-- within, and the resulting graph.</span><span>
</span><span id="line-246"></span><span id="local-6989586621684450288"><span class="annot"><a href="Futhark.Analysis.Interference.html#analyseGPU"><span class="hs-identifier hs-type">analyseGPU</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-247"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#LocalScope"><span class="hs-identifier hs-type">LocalScope</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684450288"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-248"></span><span>  </span><span class="annot"><a href="Futhark.Analysis.LastUse.html#LastUseMap"><span class="hs-identifier hs-type">LastUseMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-249"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-250"></span><span>  </span><span class="annot"><a href="#local-6989586621684450288"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.Interference.html#Graph"><span class="hs-identifier hs-type">Graph</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-251"></span><span id="analyseGPU"><span class="annot"><span class="annottext">analyseGPU :: forall (m :: * -&gt; *).
LocalScope GPUMem m =&gt;
LastUseMap -&gt; Stms GPUMem -&gt; m (Graph VName)
</span><a href="Futhark.Analysis.Interference.html#analyseGPU"><span class="hs-identifier hs-var hs-var">analyseGPU</span></a></span></span><span> </span><span id="local-6989586621684449812"><span class="annot"><span class="annottext">LastUseMap
</span><a href="#local-6989586621684449812"><span class="hs-identifier hs-var">lumap</span></a></span></span><span> </span><span id="local-6989586621684449811"><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684449811"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-252"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Names
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Names
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684449810"><span class="annot"><span class="annottext">Graph VName
</span><a href="#local-6989586621684449810"><span class="hs-identifier hs-var">graph</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LastUseMap -&gt; Stms GPUMem -&gt; m (Names, Names, Graph VName)
forall (m :: * -&gt; *).
LocalScope GPUMem m =&gt;
LastUseMap -&gt; Stms GPUMem -&gt; m (Names, Names, Graph VName)
</span><a href="Futhark.Analysis.Interference.html#analyseGPU%27"><span class="hs-identifier hs-var">analyseGPU'</span></a></span><span> </span><span class="annot"><span class="annottext">LastUseMap
</span><a href="#local-6989586621684449812"><span class="hs-identifier hs-var">lumap</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684449811"><span class="hs-identifier hs-var">stms</span></a></span><span>
</span><span id="line-253"></span><span>  </span><span class="hs-comment">-- We need to insert edges between memory blocks which differ in size, if they</span><span>
</span><span id="line-254"></span><span>  </span><span class="hs-comment">-- are in DefaultSpace. The problem is that during memory expansion,</span><span>
</span><span id="line-255"></span><span>  </span><span class="hs-comment">-- DefaultSpace arrays in kernels are interleaved. If the element sizes of two</span><span>
</span><span id="line-256"></span><span>  </span><span class="hs-comment">-- merged memory blocks are different, threads might try to read and write to</span><span>
</span><span id="line-257"></span><span>  </span><span class="hs-comment">-- overlapping memory positions. More information here:</span><span>
</span><span id="line-258"></span><span>  </span><span class="hs-comment">-- https://munksgaard.me/technical-diary/2020-12-30.html#org210775b</span><span>
</span><span id="line-259"></span><span>  </span><span id="local-6989586621684449808"><span class="annot"><span class="annottext">Map VName Space
</span><a href="#local-6989586621684449808"><span class="hs-identifier hs-var">spaces</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Space -&gt; Bool) -&gt; Map VName Space -&gt; Map VName Space
forall a k. (a -&gt; Bool) -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Space -&gt; Space -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="Futhark.IR.Syntax.Core.html#DefaultSpace"><span class="hs-identifier hs-var">DefaultSpace</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Map VName Space -&gt; Map VName Space)
-&gt; m (Map VName Space) -&gt; m (Map VName Space)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Stms GPUMem -&gt; m (Map VName Space)
forall (m :: * -&gt; *).
LocalScope GPUMem m =&gt;
Stms GPUMem -&gt; m (Map VName Space)
</span><a href="Futhark.Analysis.Interference.html#memSpaces"><span class="hs-identifier hs-var">memSpaces</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684449811"><span class="hs-identifier hs-var">stms</span></a></span><span>
</span><span id="line-260"></span><span>  </span><span id="local-6989586621684449804"><span class="annot"><span class="annottext">Map Int (Set VName)
</span><a href="#local-6989586621684449804"><span class="hs-identifier hs-var">inv_size_map</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-261"></span><span>    </span><span class="annot"><span class="annottext">Stms GPUMem -&gt; m (Map VName Int)
forall (m :: * -&gt; *).
LocalScope GPUMem m =&gt;
Stms GPUMem -&gt; m (Map VName Int)
</span><a href="Futhark.Analysis.Interference.html#memSizes"><span class="hs-identifier hs-var">memSizes</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684449811"><span class="hs-identifier hs-var">stms</span></a></span><span>
</span><span id="line-262"></span><span>      </span><span class="annot"><span class="annottext">m (Map VName Int)
-&gt; (Map VName Int -&gt; Map VName Int) -&gt; m (Map VName Int)
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Map VName Int -&gt; Set VName -&gt; Map VName Int)
-&gt; Set VName -&gt; Map VName Int -&gt; Map VName Int
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">Map VName Int -&gt; Set VName -&gt; Map VName Int
forall k a. Ord k =&gt; Map k a -&gt; Set k -&gt; Map k a
</span><span class="hs-identifier hs-var">M.restrictKeys</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; Set VName
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">S.fromList</span></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; Set VName) -&gt; [VName] -&gt; Set VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Map VName Space -&gt; [VName]
forall k a. Map k a -&gt; [k]
</span><span class="hs-identifier hs-var">M.keys</span></span><span> </span><span class="annot"><span class="annottext">Map VName Space
</span><a href="#local-6989586621684449808"><span class="hs-identifier hs-var">spaces</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-263"></span><span>      </span><span class="annot"><span class="annottext">m (Map VName Int)
-&gt; (Map VName Int -&gt; Map Int (Set VName))
-&gt; m (Map Int (Set VName))
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Map VName Int -&gt; Map Int (Set VName)
forall v k. (Ord v, Ord k) =&gt; Map k v -&gt; Map v (Set k)
</span><a href="Futhark.Util.html#invertMap"><span class="hs-identifier hs-var">invertMap</span></a></span><span>
</span><span id="line-264"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684449798"><span class="annot"><span class="annottext">new_edges :: Graph VName
</span><a href="#local-6989586621684449798"><span class="hs-identifier hs-var hs-var">new_edges</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-265"></span><span>        </span><span class="annot"><span class="annottext">(Set VName -&gt; Set VName -&gt; Graph VName)
-&gt; Map Int (Set VName) -&gt; Map Int (Set VName) -&gt; Graph VName
forall m (t :: * -&gt; *) a.
(Monoid m, Foldable t) =&gt;
(a -&gt; a -&gt; m) -&gt; t a -&gt; t a -&gt; m
</span><a href="Futhark.Analysis.Interference.html#cartesian"><span class="hs-identifier hs-var">cartesian</span></a></span><span>
</span><span id="line-266"></span><span>          </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621684449797"><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684449797"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621684449796"><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684449796"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684449797"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">Set VName -&gt; Set VName -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684449796"><span class="hs-identifier hs-var">y</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; VName -&gt; Graph VName)
-&gt; Set VName -&gt; Set VName -&gt; Graph VName
forall m (t :: * -&gt; *) a.
(Monoid m, Foldable t) =&gt;
(a -&gt; a -&gt; m) -&gt; t a -&gt; t a -&gt; m
</span><a href="Futhark.Analysis.Interference.html#cartesian"><span class="hs-identifier hs-var">cartesian</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; VName -&gt; Graph VName
forall a. Ord a =&gt; a -&gt; a -&gt; Graph a
</span><a href="Futhark.Analysis.Interference.html#makeEdge"><span class="hs-identifier hs-var">makeEdge</span></a></span><span> </span><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684449797"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684449796"><span class="hs-identifier hs-var">y</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Graph VName
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span>
</span><span id="line-267"></span><span>          </span><span class="annot"><span class="annottext">Map Int (Set VName)
</span><a href="#local-6989586621684449804"><span class="hs-identifier hs-var">inv_size_map</span></a></span><span>
</span><span id="line-268"></span><span>          </span><span class="annot"><span class="annottext">Map Int (Set VName)
</span><a href="#local-6989586621684449804"><span class="hs-identifier hs-var">inv_size_map</span></a></span><span>
</span><span id="line-269"></span><span>  </span><span class="annot"><span class="annottext">Graph VName -&gt; m (Graph VName)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Graph VName -&gt; m (Graph VName)) -&gt; Graph VName -&gt; m (Graph VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Graph VName
</span><a href="#local-6989586621684449810"><span class="hs-identifier hs-var">graph</span></a></span><span> </span><span class="annot"><span class="annottext">Graph VName -&gt; Graph VName -&gt; Graph VName
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Graph VName
</span><a href="#local-6989586621684449798"><span class="hs-identifier hs-var">new_edges</span></a></span><span>
</span><span id="line-270"></span><span>
</span><span id="line-271"></span><span class="hs-comment">-- | Return a mapping from memory blocks to their element sizes in the given</span><span>
</span><span id="line-272"></span><span class="hs-comment">-- statements.</span><span>
</span><span id="line-273"></span><span id="local-6989586621684450274"><span class="annot"><a href="Futhark.Analysis.Interference.html#memSizes"><span class="hs-identifier hs-type">memSizes</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#LocalScope"><span class="hs-identifier hs-type">LocalScope</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684450274"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684450274"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span></span><span>
</span><span id="line-274"></span><span id="memSizes"><span class="annot"><span class="annottext">memSizes :: forall (m :: * -&gt; *).
LocalScope GPUMem m =&gt;
Stms GPUMem -&gt; m (Map VName Int)
</span><a href="Futhark.Analysis.Interference.html#memSizes"><span class="hs-identifier hs-var hs-var">memSizes</span></a></span></span><span> </span><span id="local-6989586621684449779"><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684449779"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-275"></span><span>  </span><span class="annot"><span class="annottext">Stms GPUMem -&gt; m (Map VName Int) -&gt; m (Map VName Int)
forall rep a (m :: * -&gt; *) b.
(Scoped rep a, LocalScope rep m) =&gt;
a -&gt; m b -&gt; m b
</span><a href="Futhark.IR.Prop.Scope.html#inScopeOf"><span class="hs-identifier hs-var">inScopeOf</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684449779"><span class="hs-identifier hs-var">stms</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Map VName Int) -&gt; m (Map VName Int))
-&gt; m (Map VName Int) -&gt; m (Map VName Int)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">([Map VName Int] -&gt; Map VName Int)
-&gt; m [Map VName Int] -&gt; m (Map VName Int)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">[Map VName Int] -&gt; Map VName Int
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">(m [Map VName Int] -&gt; m (Map VName Int))
-&gt; ([Stm GPUMem] -&gt; m [Map VName Int])
-&gt; [Stm GPUMem]
-&gt; m (Map VName Int)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Stm GPUMem -&gt; m (Map VName Int))
-&gt; [Stm GPUMem] -&gt; m [Map VName Int]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Stm GPUMem -&gt; m (Map VName Int)
forall (m :: * -&gt; *).
LocalScope GPUMem m =&gt;
Stm GPUMem -&gt; m (Map VName Int)
</span><a href="#local-6989586621684449778"><span class="hs-identifier hs-var">memSizesStm</span></a></span><span> </span><span class="annot"><span class="annottext">([Stm GPUMem] -&gt; m (Map VName Int))
-&gt; [Stm GPUMem] -&gt; m (Map VName Int)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stms GPUMem -&gt; [Stm GPUMem]
forall rep. Stms rep -&gt; [Stm rep]
</span><a href="Futhark.IR.Syntax.html#stmsToList"><span class="hs-identifier hs-var">stmsToList</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684449779"><span class="hs-identifier hs-var">stms</span></a></span><span>
</span><span id="line-276"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-277"></span><span>    </span><span id="local-6989586621684450256"><span class="annot"><a href="#local-6989586621684449778"><span class="hs-identifier hs-type">memSizesStm</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#LocalScope"><span class="hs-identifier hs-type">LocalScope</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684450256"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684450256"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span></span><span>
</span><span id="line-278"></span><span>    </span><span id="local-6989586621684449778"><span class="annot"><span class="annottext">memSizesStm :: forall (m :: * -&gt; *).
LocalScope GPUMem m =&gt;
Stm GPUMem -&gt; m (Map VName Int)
</span><a href="#local-6989586621684449778"><span class="hs-identifier hs-var hs-var">memSizesStm</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684449759"><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684449759"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec GPUMem)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684449758"><span class="annot"><span class="annottext">Exp GPUMem
</span><a href="#local-6989586621684449758"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-279"></span><span>      </span><span id="local-6989586621684449757"><span class="annot"><span class="annottext">Map VName Int
</span><a href="#local-6989586621684449757"><span class="hs-identifier hs-var">arraySizes</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">([Map VName Int] -&gt; Map VName Int)
-&gt; m [Map VName Int] -&gt; m (Map VName Int)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">[Map VName Int] -&gt; Map VName Int
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">(m [Map VName Int] -&gt; m (Map VName Int))
-&gt; ([VName] -&gt; m [Map VName Int]) -&gt; [VName] -&gt; m (Map VName Int)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; m (Map VName Int)) -&gt; [VName] -&gt; m [Map VName Int]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; m (Map VName Int)
forall (m :: * -&gt; *).
LocalScope GPUMem m =&gt;
VName -&gt; m (Map VName Int)
</span><a href="Futhark.Analysis.Interference.html#memElemSize"><span class="hs-identifier hs-var">memElemSize</span></a></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; m (Map VName Int)) -&gt; [VName] -&gt; m (Map VName Int)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatT LetDecMem -&gt; [VName]
forall dec. PatT dec -&gt; [VName]
</span><a href="Futhark.IR.Prop.Patterns.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem
PatT LetDecMem
</span><a href="#local-6989586621684449759"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-280"></span><span>      </span><span id="local-6989586621684449754"><span class="annot"><span class="annottext">Map VName Int
</span><a href="#local-6989586621684449754"><span class="hs-identifier hs-var">arraySizes'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Exp GPUMem -&gt; m (Map VName Int)
forall (m :: * -&gt; *).
LocalScope GPUMem m =&gt;
Exp GPUMem -&gt; m (Map VName Int)
</span><a href="#local-6989586621684449753"><span class="hs-identifier hs-var">memSizesExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp GPUMem
</span><a href="#local-6989586621684449758"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-281"></span><span>      </span><span class="annot"><span class="annottext">Map VName Int -&gt; m (Map VName Int)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Map VName Int -&gt; m (Map VName Int))
-&gt; Map VName Int -&gt; m (Map VName Int)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Map VName Int
</span><a href="#local-6989586621684449757"><span class="hs-identifier hs-var">arraySizes</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName Int -&gt; Map VName Int -&gt; Map VName Int
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Map VName Int
</span><a href="#local-6989586621684449754"><span class="hs-identifier hs-var">arraySizes'</span></a></span><span>
</span><span id="line-282"></span><span>    </span><span id="local-6989586621684450248"><span class="annot"><a href="#local-6989586621684449753"><span class="hs-identifier hs-type">memSizesExp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#LocalScope"><span class="hs-identifier hs-type">LocalScope</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684450248"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684450248"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span></span><span>
</span><span id="line-283"></span><span>    </span><span id="local-6989586621684449753"><span class="annot"><span class="annottext">memSizesExp :: forall (m :: * -&gt; *).
LocalScope GPUMem m =&gt;
Exp GPUMem -&gt; m (Map VName Int)
</span><a href="#local-6989586621684449753"><span class="hs-identifier hs-var hs-var">memSizesExp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SegOp"><span class="hs-identifier hs-type">SegOp</span></a></span><span> </span><span id="local-6989586621684449730"><span class="annot"><span class="annottext">SegOp SegLevel GPUMem
</span><a href="#local-6989586621684449730"><span class="hs-identifier hs-var">segop</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-284"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684449729"><span class="annot"><span class="annottext">body :: KernelBody GPUMem
</span><a href="#local-6989586621684449729"><span class="hs-identifier hs-var hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SegOp SegLevel GPUMem -&gt; KernelBody GPUMem
forall lvl rep. SegOp lvl rep -&gt; KernelBody rep
</span><a href="Futhark.IR.SegOp.html#segBody"><span class="hs-identifier hs-var">segBody</span></a></span><span> </span><span class="annot"><span class="annottext">SegOp SegLevel GPUMem
</span><a href="#local-6989586621684449730"><span class="hs-identifier hs-var">segop</span></a></span><span>
</span><span id="line-285"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Stms GPUMem -&gt; m (Map VName Int) -&gt; m (Map VName Int)
forall rep a (m :: * -&gt; *) b.
(Scoped rep a, LocalScope rep m) =&gt;
a -&gt; m b -&gt; m b
</span><a href="Futhark.IR.Prop.Scope.html#inScopeOf"><span class="hs-identifier hs-var">inScopeOf</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelBody GPUMem -&gt; Stms GPUMem
forall rep. KernelBody rep -&gt; Stms rep
</span><a href="Futhark.IR.SegOp.html#kernelBodyStms"><span class="hs-identifier hs-var hs-var">kernelBodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684449729"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m (Map VName Int) -&gt; m (Map VName Int))
-&gt; m (Map VName Int) -&gt; m (Map VName Int)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-286"></span><span>            </span><span class="annot"><span class="annottext">([Map VName Int] -&gt; Map VName Int)
-&gt; m [Map VName Int] -&gt; m (Map VName Int)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">[Map VName Int] -&gt; Map VName Int
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span>
</span><span id="line-287"></span><span>              </span><span class="annot"><span class="annottext">(m [Map VName Int] -&gt; m (Map VName Int))
-&gt; ([Stm GPUMem] -&gt; m [Map VName Int])
-&gt; [Stm GPUMem]
-&gt; m (Map VName Int)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Stm GPUMem -&gt; m (Map VName Int))
-&gt; [Stm GPUMem] -&gt; m [Map VName Int]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Stm GPUMem -&gt; m (Map VName Int)
forall (m :: * -&gt; *).
LocalScope GPUMem m =&gt;
Stm GPUMem -&gt; m (Map VName Int)
</span><a href="#local-6989586621684449778"><span class="hs-identifier hs-var">memSizesStm</span></a></span><span>
</span><span id="line-288"></span><span>              </span><span class="annot"><span class="annottext">([Stm GPUMem] -&gt; m (Map VName Int))
-&gt; [Stm GPUMem] -&gt; m (Map VName Int)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stms GPUMem -&gt; [Stm GPUMem]
forall rep. Stms rep -&gt; [Stm rep]
</span><a href="Futhark.IR.Syntax.html#stmsToList"><span class="hs-identifier hs-var">stmsToList</span></a></span><span> </span><span class="annot"><span class="annottext">(Stms GPUMem -&gt; [Stm GPUMem]) -&gt; Stms GPUMem -&gt; [Stm GPUMem]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem -&gt; Stms GPUMem
forall rep. KernelBody rep -&gt; Stms rep
</span><a href="Futhark.IR.SegOp.html#kernelBodyStms"><span class="hs-identifier hs-var hs-var">kernelBodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684449729"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-289"></span><span>    </span><span class="annot"><a href="#local-6989586621684449753"><span class="hs-identifier hs-var">memSizesExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#If"><span class="hs-identifier hs-type">If</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684449727"><span class="annot"><span class="annottext">BodyT GPUMem
</span><a href="#local-6989586621684449727"><span class="hs-identifier hs-var">then_body</span></a></span></span><span> </span><span id="local-6989586621684449726"><span class="annot"><span class="annottext">BodyT GPUMem
</span><a href="#local-6989586621684449726"><span class="hs-identifier hs-var">else_body</span></a></span></span><span> </span><span class="annot"><span class="annottext">IfDec (BranchType GPUMem)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-290"></span><span>      </span><span id="local-6989586621684449725"><span class="annot"><span class="annottext">Map VName Int
</span><a href="#local-6989586621684449725"><span class="hs-identifier hs-var">then_res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Stms GPUMem -&gt; m (Map VName Int)
forall (m :: * -&gt; *).
LocalScope GPUMem m =&gt;
Stms GPUMem -&gt; m (Map VName Int)
</span><a href="Futhark.Analysis.Interference.html#memSizes"><span class="hs-identifier hs-var">memSizes</span></a></span><span> </span><span class="annot"><span class="annottext">(Stms GPUMem -&gt; m (Map VName Int))
-&gt; Stms GPUMem -&gt; m (Map VName Int)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BodyT GPUMem -&gt; Stms GPUMem
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT GPUMem
</span><a href="#local-6989586621684449727"><span class="hs-identifier hs-var">then_body</span></a></span><span>
</span><span id="line-291"></span><span>      </span><span id="local-6989586621684449724"><span class="annot"><span class="annottext">Map VName Int
</span><a href="#local-6989586621684449724"><span class="hs-identifier hs-var">else_res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Stms GPUMem -&gt; m (Map VName Int)
forall (m :: * -&gt; *).
LocalScope GPUMem m =&gt;
Stms GPUMem -&gt; m (Map VName Int)
</span><a href="Futhark.Analysis.Interference.html#memSizes"><span class="hs-identifier hs-var">memSizes</span></a></span><span> </span><span class="annot"><span class="annottext">(Stms GPUMem -&gt; m (Map VName Int))
-&gt; Stms GPUMem -&gt; m (Map VName Int)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BodyT GPUMem -&gt; Stms GPUMem
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT GPUMem
</span><a href="#local-6989586621684449726"><span class="hs-identifier hs-var">else_body</span></a></span><span>
</span><span id="line-292"></span><span>      </span><span class="annot"><span class="annottext">Map VName Int -&gt; m (Map VName Int)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Map VName Int -&gt; m (Map VName Int))
-&gt; Map VName Int -&gt; m (Map VName Int)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Map VName Int
</span><a href="#local-6989586621684449725"><span class="hs-identifier hs-var">then_res</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName Int -&gt; Map VName Int -&gt; Map VName Int
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Map VName Int
</span><a href="#local-6989586621684449724"><span class="hs-identifier hs-var">else_res</span></a></span><span>
</span><span id="line-293"></span><span>    </span><span class="annot"><a href="#local-6989586621684449753"><span class="hs-identifier hs-var">memSizesExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#DoLoop"><span class="hs-identifier hs-type">DoLoop</span></a></span><span> </span><span class="annot"><span class="annottext">[(FParam GPUMem, SubExp)]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">LoopForm GPUMem
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684449723"><span class="annot"><span class="annottext">BodyT GPUMem
</span><a href="#local-6989586621684449723"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-294"></span><span>      </span><span class="annot"><span class="annottext">Stms GPUMem -&gt; m (Map VName Int)
forall (m :: * -&gt; *).
LocalScope GPUMem m =&gt;
Stms GPUMem -&gt; m (Map VName Int)
</span><a href="Futhark.Analysis.Interference.html#memSizes"><span class="hs-identifier hs-var">memSizes</span></a></span><span> </span><span class="annot"><span class="annottext">(Stms GPUMem -&gt; m (Map VName Int))
-&gt; Stms GPUMem -&gt; m (Map VName Int)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BodyT GPUMem -&gt; Stms GPUMem
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT GPUMem
</span><a href="#local-6989586621684449723"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-295"></span><span>    </span><span class="annot"><a href="#local-6989586621684449753"><span class="hs-identifier hs-var">memSizesExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp GPUMem
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map VName Int -&gt; m (Map VName Int)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Map VName Int
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-296"></span><span>
</span><span id="line-297"></span><span class="hs-comment">-- | Return a mapping from memory blocks to the space they are allocated in.</span><span>
</span><span id="line-298"></span><span id="local-6989586621684450275"><span class="annot"><a href="Futhark.Analysis.Interference.html#memSpaces"><span class="hs-identifier hs-type">memSpaces</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#LocalScope"><span class="hs-identifier hs-type">LocalScope</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684450275"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684450275"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-299"></span><span id="memSpaces"><span class="annot"><span class="annottext">memSpaces :: forall (m :: * -&gt; *).
LocalScope GPUMem m =&gt;
Stms GPUMem -&gt; m (Map VName Space)
</span><a href="Futhark.Analysis.Interference.html#memSpaces"><span class="hs-identifier hs-var hs-var">memSpaces</span></a></span></span><span> </span><span id="local-6989586621684449704"><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684449704"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-300"></span><span>  </span><span class="annot"><span class="annottext">Map VName Space -&gt; m (Map VName Space)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Map VName Space -&gt; m (Map VName Space))
-&gt; Map VName Space -&gt; m (Map VName Space)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Stm GPUMem -&gt; Map VName Space) -&gt; Stms GPUMem -&gt; Map VName Space
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">Stm GPUMem -&gt; Map VName Space
</span><a href="#local-6989586621684449703"><span class="hs-identifier hs-var">getSpacesStm</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684449704"><span class="hs-identifier hs-var">stms</span></a></span><span>
</span><span id="line-301"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-302"></span><span>    </span><span class="annot"><a href="#local-6989586621684449703"><span class="hs-identifier hs-type">getSpacesStm</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span>
</span><span id="line-303"></span><span>    </span><span id="local-6989586621684449703"><span class="annot"><span class="annottext">getSpacesStm :: Stm GPUMem -&gt; Map VName Space
</span><a href="#local-6989586621684449703"><span class="hs-identifier hs-var hs-var">getSpacesStm</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#PatElem"><span class="hs-identifier hs-type">PatElem</span></a></span><span> </span><span id="local-6989586621684449700"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684449700"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="annot"><span class="annottext">LetDec GPUMem
</span><span class="hs-identifier">_</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec GPUMem)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#Alloc"><span class="hs-identifier hs-type">Alloc</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684449698"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684449698"><span class="hs-identifier hs-var">sp</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-304"></span><span>      </span><span class="annot"><span class="annottext">VName -&gt; Space -&gt; Map VName Space
forall k a. k -&gt; a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.singleton</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684449700"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684449698"><span class="hs-identifier hs-var">sp</span></a></span><span>
</span><span id="line-305"></span><span>    </span><span class="annot"><a href="#local-6989586621684449703"><span class="hs-identifier hs-var">getSpacesStm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec GPUMem)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#Alloc"><span class="hs-identifier hs-type">Alloc</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Space
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Map VName Space
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;impossible&quot;</span></span><span>
</span><span id="line-306"></span><span>    </span><span class="annot"><a href="#local-6989586621684449703"><span class="hs-identifier hs-var">getSpacesStm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec GPUMem)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SegOp"><span class="hs-identifier hs-type">SegOp</span></a></span><span> </span><span id="local-6989586621684449695"><span class="annot"><span class="annottext">SegOp SegLevel GPUMem
</span><a href="#local-6989586621684449695"><span class="hs-identifier hs-var">segop</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-307"></span><span>      </span><span class="annot"><span class="annottext">(Stm GPUMem -&gt; Map VName Space) -&gt; Stms GPUMem -&gt; Map VName Space
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">Stm GPUMem -&gt; Map VName Space
</span><a href="#local-6989586621684449703"><span class="hs-identifier hs-var">getSpacesStm</span></a></span><span> </span><span class="annot"><span class="annottext">(Stms GPUMem -&gt; Map VName Space) -&gt; Stms GPUMem -&gt; Map VName Space
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem -&gt; Stms GPUMem
forall rep. KernelBody rep -&gt; Stms rep
</span><a href="Futhark.IR.SegOp.html#kernelBodyStms"><span class="hs-identifier hs-var hs-var">kernelBodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelBody GPUMem -&gt; Stms GPUMem)
-&gt; KernelBody GPUMem -&gt; Stms GPUMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegOp SegLevel GPUMem -&gt; KernelBody GPUMem
forall lvl rep. SegOp lvl rep -&gt; KernelBody rep
</span><a href="Futhark.IR.SegOp.html#segBody"><span class="hs-identifier hs-var">segBody</span></a></span><span> </span><span class="annot"><span class="annottext">SegOp SegLevel GPUMem
</span><a href="#local-6989586621684449695"><span class="hs-identifier hs-var">segop</span></a></span><span>
</span><span id="line-308"></span><span>    </span><span class="annot"><a href="#local-6989586621684449703"><span class="hs-identifier hs-var">getSpacesStm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec GPUMem)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#If"><span class="hs-identifier hs-type">If</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684449694"><span class="annot"><span class="annottext">BodyT GPUMem
</span><a href="#local-6989586621684449694"><span class="hs-identifier hs-var">then_body</span></a></span></span><span> </span><span id="local-6989586621684449693"><span class="annot"><span class="annottext">BodyT GPUMem
</span><a href="#local-6989586621684449693"><span class="hs-identifier hs-var">else_body</span></a></span></span><span> </span><span class="annot"><span class="annottext">IfDec (BranchType GPUMem)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-309"></span><span>      </span><span class="annot"><span class="annottext">(Stm GPUMem -&gt; Map VName Space) -&gt; Stms GPUMem -&gt; Map VName Space
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">Stm GPUMem -&gt; Map VName Space
</span><a href="#local-6989586621684449703"><span class="hs-identifier hs-var">getSpacesStm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BodyT GPUMem -&gt; Stms GPUMem
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT GPUMem
</span><a href="#local-6989586621684449694"><span class="hs-identifier hs-var">then_body</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-310"></span><span>        </span><span class="annot"><span class="annottext">Map VName Space -&gt; Map VName Space -&gt; Map VName Space
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Stm GPUMem -&gt; Map VName Space) -&gt; Stms GPUMem -&gt; Map VName Space
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">Stm GPUMem -&gt; Map VName Space
</span><a href="#local-6989586621684449703"><span class="hs-identifier hs-var">getSpacesStm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BodyT GPUMem -&gt; Stms GPUMem
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT GPUMem
</span><a href="#local-6989586621684449693"><span class="hs-identifier hs-var">else_body</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-311"></span><span>    </span><span class="annot"><a href="#local-6989586621684449703"><span class="hs-identifier hs-var">getSpacesStm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec GPUMem)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#DoLoop"><span class="hs-identifier hs-type">DoLoop</span></a></span><span> </span><span class="annot"><span class="annottext">[(FParam GPUMem, SubExp)]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">LoopForm GPUMem
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684449692"><span class="annot"><span class="annottext">BodyT GPUMem
</span><a href="#local-6989586621684449692"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-312"></span><span>      </span><span class="annot"><span class="annottext">(Stm GPUMem -&gt; Map VName Space) -&gt; Stms GPUMem -&gt; Map VName Space
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">Stm GPUMem -&gt; Map VName Space
</span><a href="#local-6989586621684449703"><span class="hs-identifier hs-var">getSpacesStm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BodyT GPUMem -&gt; Stms GPUMem
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT GPUMem
</span><a href="#local-6989586621684449692"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-313"></span><span>    </span><span class="annot"><a href="#local-6989586621684449703"><span class="hs-identifier hs-var">getSpacesStm</span></a></span><span> </span><span class="annot"><span class="annottext">Stm GPUMem
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map VName Space
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-314"></span><span>
</span><span id="line-315"></span><span id="local-6989586621684450278"><span class="annot"><a href="Futhark.Analysis.Interference.html#analyseGPU%27"><span class="hs-identifier hs-type">analyseGPU'</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-316"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#LocalScope"><span class="hs-identifier hs-type">LocalScope</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684450278"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-317"></span><span>  </span><span class="annot"><a href="Futhark.Analysis.LastUse.html#LastUseMap"><span class="hs-identifier hs-type">LastUseMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-318"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-319"></span><span>  </span><span class="annot"><a href="#local-6989586621684450278"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.Interference.html#InUse"><span class="hs-identifier hs-type">InUse</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Analysis.Interference.html#LastUsed"><span class="hs-identifier hs-type">LastUsed</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Analysis.Interference.html#Graph"><span class="hs-identifier hs-type">Graph</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-320"></span><span id="analyseGPU%27"><span class="annot"><span class="annottext">analyseGPU' :: forall (m :: * -&gt; *).
LocalScope GPUMem m =&gt;
LastUseMap -&gt; Stms GPUMem -&gt; m (Names, Names, Graph VName)
</span><a href="Futhark.Analysis.Interference.html#analyseGPU%27"><span class="hs-identifier hs-var hs-var">analyseGPU'</span></a></span></span><span> </span><span id="local-6989586621684449677"><span class="annot"><span class="annottext">LastUseMap
</span><a href="#local-6989586621684449677"><span class="hs-identifier hs-var">lumap</span></a></span></span><span> </span><span id="local-6989586621684449676"><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684449676"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-321"></span><span>  </span><span class="annot"><span class="annottext">[(Names, Names, Graph VName)] -&gt; (Names, Names, Graph VName)
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">([(Names, Names, Graph VName)] -&gt; (Names, Names, Graph VName))
-&gt; (Seq (Names, Names, Graph VName)
    -&gt; [(Names, Names, Graph VName)])
-&gt; Seq (Names, Names, Graph VName)
-&gt; (Names, Names, Graph VName)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Seq (Names, Names, Graph VName) -&gt; [(Names, Names, Graph VName)]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><span class="hs-identifier hs-var">toList</span></span><span> </span><span class="annot"><span class="annottext">(Seq (Names, Names, Graph VName) -&gt; (Names, Names, Graph VName))
-&gt; m (Seq (Names, Names, Graph VName))
-&gt; m (Names, Names, Graph VName)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Stm GPUMem -&gt; m (Names, Names, Graph VName))
-&gt; Stms GPUMem -&gt; m (Seq (Names, Names, Graph VName))
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Stm GPUMem -&gt; m (Names, Names, Graph VName)
forall (m :: * -&gt; *).
LocalScope GPUMem m =&gt;
Stm GPUMem -&gt; m (Names, Names, Graph VName)
</span><a href="#local-6989586621684449675"><span class="hs-identifier hs-var">helper</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684449676"><span class="hs-identifier hs-var">stms</span></a></span><span>
</span><span id="line-322"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-323"></span><span>    </span><span id="local-6989586621684450235"><span class="annot"><a href="#local-6989586621684449675"><span class="hs-identifier hs-type">helper</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-324"></span><span>      </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#LocalScope"><span class="hs-identifier hs-type">LocalScope</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684450235"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-325"></span><span>      </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-326"></span><span>      </span><span class="annot"><a href="#local-6989586621684450235"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.Interference.html#InUse"><span class="hs-identifier hs-type">InUse</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Analysis.Interference.html#LastUsed"><span class="hs-identifier hs-type">LastUsed</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Analysis.Interference.html#Graph"><span class="hs-identifier hs-type">Graph</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-327"></span><span>    </span><span id="local-6989586621684449675"><span class="annot"><span class="annottext">helper :: forall (m :: * -&gt; *).
LocalScope GPUMem m =&gt;
Stm GPUMem -&gt; m (Names, Names, Graph VName)
</span><a href="#local-6989586621684449675"><span class="hs-identifier hs-var hs-var">helper</span></a></span></span><span> </span><span id="local-6989586621684449649"><span class="annot"><span class="annottext">stm :: Stm GPUMem
</span><a href="#local-6989586621684449649"><span class="hs-identifier hs-var">stm</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">stmExp :: forall rep. Stm rep -&gt; Exp rep
</span><a href="Futhark.IR.Syntax.html#stmExp"><span class="hs-identifier hs-var">stmExp</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SegOp"><span class="hs-identifier hs-type">SegOp</span></a></span><span> </span><span id="local-6989586621684449648"><span class="annot"><span class="annottext">SegOp SegLevel GPUMem
</span><a href="#local-6989586621684449648"><span class="hs-identifier hs-var">segop</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-328"></span><span>      </span><span class="annot"><span class="annottext">Stm GPUMem
-&gt; m (Names, Names, Graph VName) -&gt; m (Names, Names, Graph VName)
forall rep a (m :: * -&gt; *) b.
(Scoped rep a, LocalScope rep m) =&gt;
a -&gt; m b -&gt; m b
</span><a href="Futhark.IR.Prop.Scope.html#inScopeOf"><span class="hs-identifier hs-var">inScopeOf</span></a></span><span> </span><span class="annot"><span class="annottext">Stm GPUMem
</span><a href="#local-6989586621684449649"><span class="hs-identifier hs-var">stm</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Names, Names, Graph VName) -&gt; m (Names, Names, Graph VName))
-&gt; m (Names, Names, Graph VName) -&gt; m (Names, Names, Graph VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LastUseMap
-&gt; Names -&gt; SegOp SegLevel GPUMem -&gt; m (Names, Names, Graph VName)
forall (m :: * -&gt; *) lvl.
LocalScope GPUMem m =&gt;
LastUseMap
-&gt; Names -&gt; SegOp lvl GPUMem -&gt; m (Names, Names, Graph VName)
</span><a href="Futhark.Analysis.Interference.html#analyseSegOp"><span class="hs-identifier hs-var">analyseSegOp</span></a></span><span> </span><span class="annot"><span class="annottext">LastUseMap
</span><a href="#local-6989586621684449677"><span class="hs-identifier hs-var">lumap</span></a></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">SegOp SegLevel GPUMem
</span><a href="#local-6989586621684449648"><span class="hs-identifier hs-var">segop</span></a></span><span>
</span><span id="line-329"></span><span>    </span><span class="annot"><a href="#local-6989586621684449675"><span class="hs-identifier hs-var">helper</span></a></span><span> </span><span id="local-6989586621684449647"><span class="annot"><span class="annottext">stm :: Stm GPUMem
</span><a href="#local-6989586621684449647"><span class="hs-identifier hs-var">stm</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">stmExp :: forall rep. Stm rep -&gt; Exp rep
</span><a href="Futhark.IR.Syntax.html#stmExp"><span class="hs-identifier hs-var">stmExp</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#If"><span class="hs-identifier hs-type">If</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684449646"><span class="annot"><span class="annottext">BodyT GPUMem
</span><a href="#local-6989586621684449646"><span class="hs-identifier hs-var">then_body</span></a></span></span><span> </span><span id="local-6989586621684449645"><span class="annot"><span class="annottext">BodyT GPUMem
</span><a href="#local-6989586621684449645"><span class="hs-identifier hs-var">else_body</span></a></span></span><span> </span><span class="annot"><span class="annottext">IfDec (BranchType GPUMem)
</span><span class="hs-identifier">_</span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-330"></span><span>      </span><span class="annot"><span class="annottext">Stm GPUMem
-&gt; m (Names, Names, Graph VName) -&gt; m (Names, Names, Graph VName)
forall rep a (m :: * -&gt; *) b.
(Scoped rep a, LocalScope rep m) =&gt;
a -&gt; m b -&gt; m b
</span><a href="Futhark.IR.Prop.Scope.html#inScopeOf"><span class="hs-identifier hs-var">inScopeOf</span></a></span><span> </span><span class="annot"><span class="annottext">Stm GPUMem
</span><a href="#local-6989586621684449647"><span class="hs-identifier hs-var">stm</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Names, Names, Graph VName) -&gt; m (Names, Names, Graph VName))
-&gt; m (Names, Names, Graph VName) -&gt; m (Names, Names, Graph VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-331"></span><span>        </span><span id="local-6989586621684449644"><span class="annot"><span class="annottext">(Names, Names, Graph VName)
</span><a href="#local-6989586621684449644"><span class="hs-identifier hs-var">res1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LastUseMap -&gt; Stms GPUMem -&gt; m (Names, Names, Graph VName)
forall (m :: * -&gt; *).
LocalScope GPUMem m =&gt;
LastUseMap -&gt; Stms GPUMem -&gt; m (Names, Names, Graph VName)
</span><a href="Futhark.Analysis.Interference.html#analyseGPU%27"><span class="hs-identifier hs-var">analyseGPU'</span></a></span><span> </span><span class="annot"><span class="annottext">LastUseMap
</span><a href="#local-6989586621684449677"><span class="hs-identifier hs-var">lumap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BodyT GPUMem -&gt; Stms GPUMem
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT GPUMem
</span><a href="#local-6989586621684449646"><span class="hs-identifier hs-var">then_body</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-332"></span><span>        </span><span id="local-6989586621684449643"><span class="annot"><span class="annottext">(Names, Names, Graph VName)
</span><a href="#local-6989586621684449643"><span class="hs-identifier hs-var">res2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LastUseMap -&gt; Stms GPUMem -&gt; m (Names, Names, Graph VName)
forall (m :: * -&gt; *).
LocalScope GPUMem m =&gt;
LastUseMap -&gt; Stms GPUMem -&gt; m (Names, Names, Graph VName)
</span><a href="Futhark.Analysis.Interference.html#analyseGPU%27"><span class="hs-identifier hs-var">analyseGPU'</span></a></span><span> </span><span class="annot"><span class="annottext">LastUseMap
</span><a href="#local-6989586621684449677"><span class="hs-identifier hs-var">lumap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BodyT GPUMem -&gt; Stms GPUMem
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT GPUMem
</span><a href="#local-6989586621684449645"><span class="hs-identifier hs-var">else_body</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-333"></span><span>        </span><span class="annot"><span class="annottext">(Names, Names, Graph VName) -&gt; m (Names, Names, Graph VName)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Names, Names, Graph VName)
</span><a href="#local-6989586621684449644"><span class="hs-identifier hs-var">res1</span></a></span><span> </span><span class="annot"><span class="annottext">(Names, Names, Graph VName)
-&gt; (Names, Names, Graph VName) -&gt; (Names, Names, Graph VName)
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Names, Names, Graph VName)
</span><a href="#local-6989586621684449643"><span class="hs-identifier hs-var">res2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-334"></span><span>    </span><span class="annot"><a href="#local-6989586621684449675"><span class="hs-identifier hs-var">helper</span></a></span><span> </span><span id="local-6989586621684449642"><span class="annot"><span class="annottext">stm :: Stm GPUMem
</span><a href="#local-6989586621684449642"><span class="hs-identifier hs-var">stm</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">stmExp :: forall rep. Stm rep -&gt; Exp rep
</span><a href="Futhark.IR.Syntax.html#stmExp"><span class="hs-identifier hs-var">stmExp</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#DoLoop"><span class="hs-identifier hs-type">DoLoop</span></a></span><span> </span><span id="local-6989586621684449641"><span class="annot"><span class="annottext">[(FParam GPUMem, SubExp)]
</span><a href="#local-6989586621684449641"><span class="hs-identifier hs-var">merge</span></a></span></span><span> </span><span class="annot"><span class="annottext">LoopForm GPUMem
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684449640"><span class="annot"><span class="annottext">BodyT GPUMem
</span><a href="#local-6989586621684449640"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-335"></span><span>      </span><span class="annot"><span class="annottext">((Names, Names, Graph VName) -&gt; (Names, Names, Graph VName))
-&gt; m (Names, Names, Graph VName) -&gt; m (Names, Names, Graph VName)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(FParam GPUMem, SubExp)]
-&gt; (Names, Names, Graph VName) -&gt; (Names, Names, Graph VName)
</span><a href="Futhark.Analysis.Interference.html#analyseLoopParams"><span class="hs-identifier hs-var">analyseLoopParams</span></a></span><span> </span><span class="annot"><span class="annottext">[(FParam GPUMem, SubExp)]
</span><a href="#local-6989586621684449641"><span class="hs-identifier hs-var">merge</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m (Names, Names, Graph VName) -&gt; m (Names, Names, Graph VName))
-&gt; (m (Names, Names, Graph VName) -&gt; m (Names, Names, Graph VName))
-&gt; m (Names, Names, Graph VName)
-&gt; m (Names, Names, Graph VName)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Stm GPUMem
-&gt; m (Names, Names, Graph VName) -&gt; m (Names, Names, Graph VName)
forall rep a (m :: * -&gt; *) b.
(Scoped rep a, LocalScope rep m) =&gt;
a -&gt; m b -&gt; m b
</span><a href="Futhark.IR.Prop.Scope.html#inScopeOf"><span class="hs-identifier hs-var">inScopeOf</span></a></span><span> </span><span class="annot"><span class="annottext">Stm GPUMem
</span><a href="#local-6989586621684449642"><span class="hs-identifier hs-var">stm</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Names, Names, Graph VName) -&gt; m (Names, Names, Graph VName))
-&gt; m (Names, Names, Graph VName) -&gt; m (Names, Names, Graph VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-336"></span><span>        </span><span class="annot"><span class="annottext">LastUseMap -&gt; Stms GPUMem -&gt; m (Names, Names, Graph VName)
forall (m :: * -&gt; *).
LocalScope GPUMem m =&gt;
LastUseMap -&gt; Stms GPUMem -&gt; m (Names, Names, Graph VName)
</span><a href="Futhark.Analysis.Interference.html#analyseGPU%27"><span class="hs-identifier hs-var">analyseGPU'</span></a></span><span> </span><span class="annot"><span class="annottext">LastUseMap
</span><a href="#local-6989586621684449677"><span class="hs-identifier hs-var">lumap</span></a></span><span> </span><span class="annot"><span class="annottext">(Stms GPUMem -&gt; m (Names, Names, Graph VName))
-&gt; Stms GPUMem -&gt; m (Names, Names, Graph VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BodyT GPUMem -&gt; Stms GPUMem
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT GPUMem
</span><a href="#local-6989586621684449640"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-337"></span><span>    </span><span class="annot"><a href="#local-6989586621684449675"><span class="hs-identifier hs-var">helper</span></a></span><span> </span><span id="local-6989586621684449639"><span class="annot"><span class="annottext">Stm GPUMem
</span><a href="#local-6989586621684449639"><span class="hs-identifier hs-var">stm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-338"></span><span>      </span><span class="annot"><span class="annottext">Stm GPUMem
-&gt; m (Names, Names, Graph VName) -&gt; m (Names, Names, Graph VName)
forall rep a (m :: * -&gt; *) b.
(Scoped rep a, LocalScope rep m) =&gt;
a -&gt; m b -&gt; m b
</span><a href="Futhark.IR.Prop.Scope.html#inScopeOf"><span class="hs-identifier hs-var">inScopeOf</span></a></span><span> </span><span class="annot"><span class="annottext">Stm GPUMem
</span><a href="#local-6989586621684449639"><span class="hs-identifier hs-var">stm</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Names, Names, Graph VName) -&gt; m (Names, Names, Graph VName))
-&gt; m (Names, Names, Graph VName) -&gt; m (Names, Names, Graph VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Names, Names, Graph VName) -&gt; m (Names, Names, Graph VName)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Names, Names, Graph VName)
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-339"></span><span>
</span><span id="line-340"></span><span id="local-6989586621684450232"><span id="local-6989586621684450233"><span class="annot"><a href="Futhark.Analysis.Interference.html#nameInfoToMemInfo"><span class="hs-identifier hs-type">nameInfoToMemInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#Mem"><span class="hs-identifier hs-type">Mem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684450233"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684450232"><span class="hs-identifier hs-type">inner</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#NameInfo"><span class="hs-identifier hs-type">NameInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684450233"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#MemBound"><span class="hs-identifier hs-type">MemBound</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#NoUniqueness"><span class="hs-identifier hs-type">NoUniqueness</span></a></span></span></span><span>
</span><span id="line-341"></span><span id="nameInfoToMemInfo"><span class="annot"><span class="annottext">nameInfoToMemInfo :: forall rep inner. Mem rep inner =&gt; NameInfo rep -&gt; LetDecMem
</span><a href="Futhark.Analysis.Interference.html#nameInfoToMemInfo"><span class="hs-identifier hs-var hs-var">nameInfoToMemInfo</span></a></span></span><span> </span><span id="local-6989586621684449620"><span class="annot"><span class="annottext">NameInfo rep
</span><a href="#local-6989586621684449620"><span class="hs-identifier hs-var">info</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-342"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">NameInfo rep
</span><a href="#local-6989586621684449620"><span class="hs-identifier hs-var">info</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-343"></span><span>    </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#FParamName"><span class="hs-identifier hs-type">FParamName</span></a></span><span> </span><span id="local-6989586621684449618"><span class="annot"><span class="annottext">FParamInfo rep
</span><a href="#local-6989586621684449618"><span class="hs-identifier hs-var">summary</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MemInfo SubExp Uniqueness MemBind -&gt; LetDecMem
forall d u r. MemInfo d u r -&gt; MemInfo d NoUniqueness r
</span><a href="Futhark.IR.Mem.html#noUniquenessReturns"><span class="hs-identifier hs-var">noUniquenessReturns</span></a></span><span> </span><span class="annot"><span class="annottext">FParamInfo rep
MemInfo SubExp Uniqueness MemBind
</span><a href="#local-6989586621684449618"><span class="hs-identifier hs-var">summary</span></a></span><span>
</span><span id="line-344"></span><span>    </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#LParamName"><span class="hs-identifier hs-type">LParamName</span></a></span><span> </span><span id="local-6989586621684449615"><span class="annot"><span class="annottext">LParamInfo rep
</span><a href="#local-6989586621684449615"><span class="hs-identifier hs-var">summary</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LParamInfo rep
LetDecMem
</span><a href="#local-6989586621684449615"><span class="hs-identifier hs-var">summary</span></a></span><span>
</span><span id="line-345"></span><span>    </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#LetName"><span class="hs-identifier hs-type">LetName</span></a></span><span> </span><span id="local-6989586621684449613"><span class="annot"><span class="annottext">LetDec rep
</span><a href="#local-6989586621684449613"><span class="hs-identifier hs-var">summary</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LetDec rep -&gt; LetDecMem
forall t. HasLetDecMem t =&gt; t -&gt; LetDecMem
</span><a href="Futhark.IR.Mem.html#letDecMem"><span class="hs-identifier hs-var">letDecMem</span></a></span><span> </span><span class="annot"><span class="annottext">LetDec rep
</span><a href="#local-6989586621684449613"><span class="hs-identifier hs-var">summary</span></a></span><span>
</span><span id="line-346"></span><span>    </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#IndexName"><span class="hs-identifier hs-type">IndexName</span></a></span><span> </span><span id="local-6989586621684449610"><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684449610"><span class="hs-identifier hs-var">it</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; LetDecMem
forall d u ret. PrimType -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemPrim"><span class="hs-identifier hs-var">MemPrim</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimType -&gt; LetDecMem) -&gt; PrimType -&gt; LetDecMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IntType -&gt; PrimType
</span><a href="Futhark.IR.Primitive.html#IntType"><span class="hs-identifier hs-var">IntType</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684449610"><span class="hs-identifier hs-var">it</span></a></span><span>
</span><span id="line-347"></span><span>
</span><span id="line-348"></span><span id="local-6989586621684450378"><span class="annot"><a href="Futhark.Analysis.Interference.html#memInfo"><span class="hs-identifier hs-type">memInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#LocalScope"><span class="hs-identifier hs-type">LocalScope</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684450378"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684450378"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-349"></span><span id="memInfo"><span class="annot"><span class="annottext">memInfo :: forall (m :: * -&gt; *).
LocalScope GPUMem m =&gt;
VName -&gt; m (Maybe VName)
</span><a href="Futhark.Analysis.Interference.html#memInfo"><span class="hs-identifier hs-var hs-var">memInfo</span></a></span></span><span> </span><span id="local-6989586621684449584"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684449584"><span class="hs-identifier hs-var">vname</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-350"></span><span>  </span><span id="local-6989586621684449583"><span class="annot"><span class="annottext">Maybe LetDecMem
</span><a href="#local-6989586621684449583"><span class="hs-identifier hs-var">summary</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Scope GPUMem -&gt; Maybe LetDecMem) -&gt; m (Maybe LetDecMem)
forall rep (m :: * -&gt; *) a.
HasScope rep m =&gt;
(Scope rep -&gt; a) -&gt; m a
</span><a href="Futhark.IR.Prop.Scope.html#asksScope"><span class="hs-identifier hs-var">asksScope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(NameInfo GPUMem -&gt; LetDecMem)
-&gt; Maybe (NameInfo GPUMem) -&gt; Maybe LetDecMem
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">NameInfo GPUMem -&gt; LetDecMem
forall rep inner. Mem rep inner =&gt; NameInfo rep -&gt; LetDecMem
</span><a href="Futhark.Analysis.Interference.html#nameInfoToMemInfo"><span class="hs-identifier hs-var">nameInfoToMemInfo</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (NameInfo GPUMem) -&gt; Maybe LetDecMem)
-&gt; (Scope GPUMem -&gt; Maybe (NameInfo GPUMem))
-&gt; Scope GPUMem
-&gt; Maybe LetDecMem
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Scope GPUMem -&gt; Maybe (NameInfo GPUMem)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684449584"><span class="hs-identifier hs-var">vname</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-351"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe LetDecMem
</span><a href="#local-6989586621684449583"><span class="hs-identifier hs-var">summary</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-352"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-type">MemArray</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Shape
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">NoUniqueness
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#ArrayIn"><span class="hs-identifier hs-type">ArrayIn</span></a></span><span> </span><span id="local-6989586621684449579"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684449579"><span class="hs-identifier hs-var">mem</span></a></span></span><span> </span><span class="annot"><span class="annottext">IxFun
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-353"></span><span>      </span><span class="annot"><span class="annottext">Maybe VName -&gt; m (Maybe VName)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe VName -&gt; m (Maybe VName)) -&gt; Maybe VName -&gt; m (Maybe VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Maybe VName
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684449579"><span class="hs-identifier hs-var">mem</span></a></span><span>
</span><span id="line-354"></span><span>    </span><span class="annot"><span class="annottext">Maybe LetDecMem
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-355"></span><span>      </span><span class="annot"><span class="annottext">Maybe VName -&gt; m (Maybe VName)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe VName
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-356"></span><span>
</span><span id="line-357"></span><span class="hs-comment">-- | Returns a mapping from memory block to element size. The input is the</span><span>
</span><span id="line-358"></span><span class="hs-comment">-- `VName` of a variable (supposedly an array), and the result is a mapping from</span><span>
</span><span id="line-359"></span><span class="hs-comment">-- the memory block of that array to element size of the array.</span><span>
</span><span id="line-360"></span><span id="local-6989586621684450250"><span class="annot"><a href="Futhark.Analysis.Interference.html#memElemSize"><span class="hs-identifier hs-type">memElemSize</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#LocalScope"><span class="hs-identifier hs-type">LocalScope</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684450250"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684450250"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span></span><span>
</span><span id="line-361"></span><span id="memElemSize"><span class="annot"><span class="annottext">memElemSize :: forall (m :: * -&gt; *).
LocalScope GPUMem m =&gt;
VName -&gt; m (Map VName Int)
</span><a href="Futhark.Analysis.Interference.html#memElemSize"><span class="hs-identifier hs-var hs-var">memElemSize</span></a></span></span><span> </span><span id="local-6989586621684449556"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684449556"><span class="hs-identifier hs-var">vname</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-362"></span><span>  </span><span id="local-6989586621684449555"><span class="annot"><span class="annottext">Maybe LetDecMem
</span><a href="#local-6989586621684449555"><span class="hs-identifier hs-var">summary</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Scope GPUMem -&gt; Maybe LetDecMem) -&gt; m (Maybe LetDecMem)
forall rep (m :: * -&gt; *) a.
HasScope rep m =&gt;
(Scope rep -&gt; a) -&gt; m a
</span><a href="Futhark.IR.Prop.Scope.html#asksScope"><span class="hs-identifier hs-var">asksScope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(NameInfo GPUMem -&gt; LetDecMem)
-&gt; Maybe (NameInfo GPUMem) -&gt; Maybe LetDecMem
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">NameInfo GPUMem -&gt; LetDecMem
forall rep inner. Mem rep inner =&gt; NameInfo rep -&gt; LetDecMem
</span><a href="Futhark.Analysis.Interference.html#nameInfoToMemInfo"><span class="hs-identifier hs-var">nameInfoToMemInfo</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (NameInfo GPUMem) -&gt; Maybe LetDecMem)
-&gt; (Scope GPUMem -&gt; Maybe (NameInfo GPUMem))
-&gt; Scope GPUMem
-&gt; Maybe LetDecMem
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Scope GPUMem -&gt; Maybe (NameInfo GPUMem)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684449556"><span class="hs-identifier hs-var">vname</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-363"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe LetDecMem
</span><a href="#local-6989586621684449555"><span class="hs-identifier hs-var">summary</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-364"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-type">MemArray</span></a></span><span> </span><span id="local-6989586621684449554"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684449554"><span class="hs-identifier hs-var">pt</span></a></span></span><span> </span><span class="annot"><span class="annottext">Shape
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">NoUniqueness
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#ArrayIn"><span class="hs-identifier hs-type">ArrayIn</span></a></span><span> </span><span id="local-6989586621684449553"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684449553"><span class="hs-identifier hs-var">mem</span></a></span></span><span> </span><span class="annot"><span class="annottext">IxFun
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-365"></span><span>      </span><span class="annot"><span class="annottext">Map VName Int -&gt; m (Map VName Int)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Map VName Int -&gt; m (Map VName Int))
-&gt; Map VName Int -&gt; m (Map VName Int)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Int -&gt; Map VName Int
forall k a. k -&gt; a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.singleton</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684449553"><span class="hs-identifier hs-var">mem</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimType -&gt; Int
forall a. Num a =&gt; PrimType -&gt; a
</span><a href="Futhark.IR.Primitive.html#primByteSize"><span class="hs-identifier hs-var">primByteSize</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684449554"><span class="hs-identifier hs-var">pt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-366"></span><span>    </span><span class="annot"><span class="annottext">Maybe LetDecMem
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-367"></span><span>      </span><span class="annot"><span class="annottext">Map VName Int -&gt; m (Map VName Int)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Map VName Int
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-368"></span></pre></body></html>