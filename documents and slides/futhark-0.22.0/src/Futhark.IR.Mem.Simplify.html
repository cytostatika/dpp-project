<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE ConstraintKinds #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE FlexibleInstances #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE MultiParamTypeClasses #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-6"></span><span>
</span><span id="line-7"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Futhark.IR.Mem.Simplify</span><span>
</span><span id="line-8"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.Simplify.html#simplifyProgGeneric"><span class="hs-identifier">simplifyProgGeneric</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-9"></span><span>    </span><span class="annot"><a href="Futhark.IR.Mem.Simplify.html#simplifyStmsGeneric"><span class="hs-identifier">simplifyStmsGeneric</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-10"></span><span>    </span><span class="annot"><a href="Futhark.IR.Mem.Simplify.html#simpleGeneric"><span class="hs-identifier">simpleGeneric</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-11"></span><span>    </span><span class="annot"><a href="Futhark.IR.Mem.Simplify.html#SimplifyMemory"><span class="hs-identifier">SimplifyMemory</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-12"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-13"></span><span class="hs-keyword">where</span><span>
</span><span id="line-14"></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">find</span></span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.Analysis.SymbolTable.html"><span class="hs-identifier">Futhark.Analysis.SymbolTable</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">ST</span></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.Analysis.UsageTable.html"><span class="hs-identifier">Futhark.Analysis.UsageTable</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">UT</span></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Construct.html"><span class="hs-identifier">Futhark.Construct</span></a></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html"><span class="hs-identifier">Futhark.IR.Mem</span></a></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html"><span class="hs-identifier">Futhark.IR.Mem.IxFun</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">IxFun</span></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.html"><span class="hs-identifier">Futhark.Optimise.Simplify</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Simplify</span></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html"><span class="hs-identifier">Futhark.Optimise.Simplify.Engine</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Engine</span></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html"><span class="hs-identifier">Futhark.Optimise.Simplify.Rep</span></a></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Rule.html"><span class="hs-identifier">Futhark.Optimise.Simplify.Rule</span></a></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.html"><span class="hs-identifier">Futhark.Optimise.Simplify.Rules</span></a></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Pass.html"><span class="hs-identifier">Futhark.Pass</span></a></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html"><span class="hs-identifier">Futhark.Pass.ExplicitAllocations</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#simplifiable"><span class="hs-identifier">simplifiable</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Util.html"><span class="hs-identifier">Futhark.Util</span></a></span><span>
</span><span id="line-30"></span><span>
</span><span id="line-31"></span><span id="local-6989586621684408892"><span id="local-6989586621684408893"><span class="annot"><a href="Futhark.IR.Mem.Simplify.html#simpleGeneric"><span class="hs-identifier hs-type">simpleGeneric</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-32"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.Simplify.html#SimplifyMemory"><span class="hs-identifier hs-type">SimplifyMemory</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684408893"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684408892"><span class="hs-identifier hs-type">inner</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-33"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#OpWithWisdom"><span class="hs-identifier hs-type">OpWithWisdom</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684408892"><span class="hs-identifier hs-type">inner</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Analysis.UsageTable.html#UsageTable"><span class="hs-identifier hs-type">UT.UsageTable</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-34"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimplifyOp"><span class="hs-identifier hs-type">Simplify.SimplifyOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684408893"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#OpWithWisdom"><span class="hs-identifier hs-type">OpWithWisdom</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684408892"><span class="hs-identifier hs-type">inner</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-35"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleOps"><span class="hs-identifier hs-type">Simplify.SimpleOps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684408893"><span class="hs-identifier hs-type">rep</span></a></span></span></span><span>
</span><span id="line-36"></span><span id="simpleGeneric"><span class="annot"><span class="annottext">simpleGeneric :: forall rep inner.
SimplifyMemory rep inner =&gt;
(OpWithWisdom inner -&gt; UsageTable)
-&gt; SimplifyOp rep (OpWithWisdom inner) -&gt; SimpleOps rep
</span><a href="Futhark.IR.Mem.Simplify.html#simpleGeneric"><span class="hs-identifier hs-var hs-var">simpleGeneric</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(OpWithWisdom inner -&gt; UsageTable)
-&gt; (OpWithWisdom inner
    -&gt; SimpleM rep (OpWithWisdom inner, Seq (Stm (Wise rep))))
-&gt; SimpleOps rep
forall rep inner.
(SimplifiableRep rep, ExpDec rep ~ (), BodyDec rep ~ (),
 Mem rep inner) =&gt;
(OpWithWisdom inner -&gt; UsageTable)
-&gt; (OpWithWisdom inner
    -&gt; SimpleM rep (OpWithWisdom inner, Stms (Wise rep)))
-&gt; SimpleOps rep
</span><a href="Futhark.Pass.ExplicitAllocations.html#simplifiable"><span class="hs-identifier hs-var">simplifiable</span></a></span><span>
</span><span id="line-37"></span><span>
</span><span id="line-38"></span><span id="local-6989586621684408826"><span id="local-6989586621684408827"><span class="annot"><a href="Futhark.IR.Mem.Simplify.html#simplifyProgGeneric"><span class="hs-identifier hs-type">simplifyProgGeneric</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-39"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.Simplify.html#SimplifyMemory"><span class="hs-identifier hs-type">SimplifyMemory</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684408827"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684408826"><span class="hs-identifier hs-type">inner</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-40"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleOps"><span class="hs-identifier hs-type">Simplify.SimpleOps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684408827"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-41"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Prog"><span class="hs-identifier hs-type">Prog</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684408827"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-42"></span><span>  </span><span class="annot"><a href="Futhark.Pass.html#PassM"><span class="hs-identifier hs-type">PassM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Prog"><span class="hs-identifier hs-type">Prog</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684408827"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-43"></span><span id="simplifyProgGeneric"><span class="annot"><span class="annottext">simplifyProgGeneric :: forall rep inner.
SimplifyMemory rep inner =&gt;
SimpleOps rep -&gt; Prog rep -&gt; PassM (Prog rep)
</span><a href="Futhark.IR.Mem.Simplify.html#simplifyProgGeneric"><span class="hs-identifier hs-var hs-var">simplifyProgGeneric</span></a></span></span><span> </span><span id="local-6989586621684408453"><span class="annot"><span class="annottext">SimpleOps rep
</span><a href="#local-6989586621684408453"><span class="hs-identifier hs-var">ops</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-44"></span><span>  </span><span class="annot"><span class="annottext">SimpleOps rep
-&gt; RuleBook (Wise rep)
-&gt; HoistBlockers rep
-&gt; Prog rep
-&gt; PassM (Prog rep)
forall rep.
SimplifiableRep rep =&gt;
SimpleOps rep
-&gt; RuleBook (Wise rep)
-&gt; HoistBlockers rep
-&gt; Prog rep
-&gt; PassM (Prog rep)
</span><a href="Futhark.Optimise.Simplify.html#simplifyProg"><span class="hs-identifier hs-var">Simplify.simplifyProg</span></a></span><span>
</span><span id="line-45"></span><span>    </span><span class="annot"><span class="annottext">SimpleOps rep
</span><a href="#local-6989586621684408453"><span class="hs-identifier hs-var">ops</span></a></span><span>
</span><span id="line-46"></span><span>    </span><span class="annot"><span class="annottext">RuleBook (Wise rep)
forall rep inner. SimplifyMemory rep inner =&gt; RuleBook (Wise rep)
</span><a href="Futhark.IR.Mem.Simplify.html#callKernelRules"><span class="hs-identifier hs-var">callKernelRules</span></a></span><span>
</span><span id="line-47"></span><span>    </span><span class="annot"><span class="annottext">HoistBlockers rep
forall rep inner. (Op rep ~ MemOp inner) =&gt; HoistBlockers rep
</span><a href="Futhark.IR.Mem.Simplify.html#blockers"><span class="hs-identifier hs-var">blockers</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">blockHoistBranch :: BlockPred (Wise rep)
</span><a href="Futhark.Optimise.Simplify.Engine.html#blockHoistBranch"><span class="hs-identifier hs-var">Engine.blockHoistBranch</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlockPred (Wise rep)
forall {rep} {inner} {rep} {p}.
(Typed (LetDec rep), Op rep ~ MemOp inner) =&gt;
SymbolTable rep -&gt; p -&gt; Stm rep -&gt; Bool
</span><a href="#local-6989586621684408448"><span class="hs-identifier hs-var">blockAllocs</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-48"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-49"></span><span>    </span><span id="local-6989586621684408448"><span class="annot"><span class="annottext">blockAllocs :: SymbolTable rep -&gt; p -&gt; Stm rep -&gt; Bool
</span><a href="#local-6989586621684408448"><span class="hs-identifier hs-var hs-var">blockAllocs</span></a></span></span><span> </span><span id="local-6989586621684408437"><span class="annot"><span class="annottext">SymbolTable rep
</span><a href="#local-6989586621684408437"><span class="hs-identifier hs-var">vtable</span></a></span></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#Alloc"><span class="hs-identifier hs-type">Alloc</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-50"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SymbolTable rep -&gt; Bool
forall rep. SymbolTable rep -&gt; Bool
</span><a href="Futhark.Analysis.SymbolTable.html#simplifyMemory"><span class="hs-identifier hs-var hs-var">ST.simplifyMemory</span></a></span><span> </span><span class="annot"><span class="annottext">SymbolTable rep
</span><a href="#local-6989586621684408437"><span class="hs-identifier hs-var">vtable</span></a></span><span>
</span><span id="line-51"></span><span>    </span><span class="hs-comment">-- Do not hoist statements that produce arrays.  This is</span><span>
</span><span id="line-52"></span><span>    </span><span class="hs-comment">-- because in the KernelsMem representation, multiple</span><span>
</span><span id="line-53"></span><span>    </span><span class="hs-comment">-- arrays can be located in the same memory block, and moving</span><span>
</span><span id="line-54"></span><span>    </span><span class="hs-comment">-- their creation out of a branch can thus cause memory</span><span>
</span><span id="line-55"></span><span>    </span><span class="hs-comment">-- corruption.  At this point in the compiler we have probably</span><span>
</span><span id="line-56"></span><span>    </span><span class="hs-comment">-- already moved all the array creations that matter.</span><span>
</span><span id="line-57"></span><span>    </span><span class="annot"><a href="#local-6989586621684408448"><span class="hs-identifier hs-var">blockAllocs</span></a></span><span> </span><span class="annot"><span class="annottext">SymbolTable rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684408431"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684408431"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ExpT rep
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-58"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(TypeBase Shape NoUniqueness -&gt; Bool)
-&gt; [TypeBase Shape NoUniqueness] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness -&gt; Bool
forall shape u. TypeBase shape u -&gt; Bool
</span><a href="Futhark.IR.Prop.Types.html#primType"><span class="hs-identifier hs-var">primType</span></a></span><span> </span><span class="annot"><span class="annottext">([TypeBase Shape NoUniqueness] -&gt; Bool)
-&gt; [TypeBase Shape NoUniqueness] -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat rep -&gt; [TypeBase Shape NoUniqueness]
forall dec. Typed dec =&gt; PatT dec -&gt; [TypeBase Shape NoUniqueness]
</span><a href="Futhark.IR.Prop.Patterns.html#patTypes"><span class="hs-identifier hs-var">patTypes</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684408431"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-59"></span><span>
</span><span id="line-60"></span><span id="local-6989586621684408782"><span id="local-6989586621684408785"><span id="local-6989586621684408786"><span class="annot"><a href="Futhark.IR.Mem.Simplify.html#simplifyStmsGeneric"><span class="hs-identifier hs-type">simplifyStmsGeneric</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-61"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#HasScope"><span class="hs-identifier hs-type">HasScope</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684408786"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684408785"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-62"></span><span>    </span><span class="annot"><a href="Futhark.MonadFreshNames.html#MonadFreshNames"><span class="hs-identifier hs-type">MonadFreshNames</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684408785"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-63"></span><span>    </span><span class="annot"><a href="Futhark.IR.Mem.Simplify.html#SimplifyMemory"><span class="hs-identifier hs-type">SimplifyMemory</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684408786"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684408782"><span class="hs-identifier hs-type">inner</span></a></span><span>
</span><span id="line-64"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-65"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleOps"><span class="hs-identifier hs-type">Simplify.SimpleOps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684408786"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-66"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684408786"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-67"></span><span>  </span><span class="annot"><a href="#local-6989586621684408785"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684408786"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-68"></span><span id="simplifyStmsGeneric"><span class="annot"><span class="annottext">simplifyStmsGeneric :: forall rep (m :: * -&gt; *) inner.
(HasScope rep m, MonadFreshNames m, SimplifyMemory rep inner) =&gt;
SimpleOps rep -&gt; Stms rep -&gt; m (Stms rep)
</span><a href="Futhark.IR.Mem.Simplify.html#simplifyStmsGeneric"><span class="hs-identifier hs-var hs-var">simplifyStmsGeneric</span></a></span></span><span> </span><span id="local-6989586621684408356"><span class="annot"><span class="annottext">SimpleOps rep
</span><a href="#local-6989586621684408356"><span class="hs-identifier hs-var">ops</span></a></span></span><span> </span><span id="local-6989586621684408355"><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684408355"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-69"></span><span>  </span><span id="local-6989586621684408354"><span class="annot"><span class="annottext">Scope rep
</span><a href="#local-6989586621684408354"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (Scope rep)
forall rep (m :: * -&gt; *). HasScope rep m =&gt; m (Scope rep)
</span><a href="Futhark.IR.Prop.Scope.html#askScope"><span class="hs-identifier hs-var">askScope</span></a></span><span>
</span><span id="line-70"></span><span>  </span><span class="annot"><span class="annottext">SimpleOps rep
-&gt; RuleBook (Wise rep)
-&gt; HoistBlockers rep
-&gt; Scope rep
-&gt; Stms rep
-&gt; m (Stms rep)
forall (m :: * -&gt; *) rep.
(MonadFreshNames m, SimplifiableRep rep) =&gt;
SimpleOps rep
-&gt; RuleBook (Wise rep)
-&gt; HoistBlockers rep
-&gt; Scope rep
-&gt; Stms rep
-&gt; m (Stms rep)
</span><a href="Futhark.Optimise.Simplify.html#simplifyStms"><span class="hs-identifier hs-var">Simplify.simplifyStms</span></a></span><span>
</span><span id="line-71"></span><span>    </span><span class="annot"><span class="annottext">SimpleOps rep
</span><a href="#local-6989586621684408356"><span class="hs-identifier hs-var">ops</span></a></span><span>
</span><span id="line-72"></span><span>    </span><span class="annot"><span class="annottext">RuleBook (Wise rep)
forall rep inner. SimplifyMemory rep inner =&gt; RuleBook (Wise rep)
</span><a href="Futhark.IR.Mem.Simplify.html#callKernelRules"><span class="hs-identifier hs-var">callKernelRules</span></a></span><span>
</span><span id="line-73"></span><span>    </span><span class="annot"><span class="annottext">HoistBlockers rep
forall rep inner. (Op rep ~ MemOp inner) =&gt; HoistBlockers rep
</span><a href="Futhark.IR.Mem.Simplify.html#blockers"><span class="hs-identifier hs-var">blockers</span></a></span><span>
</span><span id="line-74"></span><span>    </span><span class="annot"><span class="annottext">Scope rep
</span><a href="#local-6989586621684408354"><span class="hs-identifier hs-var">scope</span></a></span><span>
</span><span id="line-75"></span><span>    </span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684408355"><span class="hs-identifier hs-var">stms</span></a></span><span>
</span><span id="line-76"></span><span>
</span><span id="line-77"></span><span id="local-6989586621684408771"><span id="local-6989586621684408772"><span class="annot"><a href="Futhark.IR.Mem.Simplify.html#isResultAlloc"><span class="hs-identifier hs-type">isResultAlloc</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684408772"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">~</span></span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#MemOp"><span class="hs-identifier hs-type">MemOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684408771"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#BlockPred"><span class="hs-identifier hs-type">Engine.BlockPred</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684408772"><span class="hs-identifier hs-type">rep</span></a></span></span></span><span>
</span><span id="line-78"></span><span id="isResultAlloc"><span class="annot"><span class="annottext">isResultAlloc :: forall rep op. (Op rep ~ MemOp op) =&gt; BlockPred rep
</span><a href="Futhark.IR.Mem.Simplify.html#isResultAlloc"><span class="hs-identifier hs-var hs-var">isResultAlloc</span></a></span></span><span> </span><span class="annot"><span class="annottext">SymbolTable rep
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684408346"><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684408346"><span class="hs-identifier hs-var">usage</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621684408344"><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684408344"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#Alloc"><span class="hs-identifier hs-type">Alloc</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-79"></span><span>  </span><span class="annot"><span class="annottext">VName -&gt; UsageTable -&gt; Bool
</span><a href="Futhark.Analysis.UsageTable.html#isInResult"><span class="hs-identifier hs-var">UT.isInResult</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT (LetDec rep) -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684408344"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684408346"><span class="hs-identifier hs-var">usage</span></a></span><span>
</span><span id="line-80"></span><span class="annot"><a href="Futhark.IR.Mem.Simplify.html#isResultAlloc"><span class="hs-identifier hs-var">isResultAlloc</span></a></span><span> </span><span class="annot"><span class="annottext">SymbolTable rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-81"></span><span>
</span><span id="line-82"></span><span id="local-6989586621684408340"><span id="local-6989586621684408341"><span class="annot"><a href="Futhark.IR.Mem.Simplify.html#isAlloc"><span class="hs-identifier hs-type">isAlloc</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684408341"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">~</span></span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#MemOp"><span class="hs-identifier hs-type">MemOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684408340"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#BlockPred"><span class="hs-identifier hs-type">Engine.BlockPred</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684408341"><span class="hs-identifier hs-type">rep</span></a></span></span></span><span>
</span><span id="line-83"></span><span id="isAlloc"><span class="annot"><span class="annottext">isAlloc :: forall rep op. (Op rep ~ MemOp op) =&gt; BlockPred rep
</span><a href="Futhark.IR.Mem.Simplify.html#isAlloc"><span class="hs-identifier hs-var hs-var">isAlloc</span></a></span></span><span> </span><span class="annot"><span class="annottext">SymbolTable rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#Alloc"><span class="hs-identifier hs-type">Alloc</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-84"></span><span class="annot"><a href="Futhark.IR.Mem.Simplify.html#isAlloc"><span class="hs-identifier hs-var">isAlloc</span></a></span><span> </span><span class="annot"><span class="annottext">SymbolTable rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-85"></span><span>
</span><span id="line-86"></span><span id="local-6989586621684408809"><span id="local-6989586621684408810"><span class="annot"><a href="Futhark.IR.Mem.Simplify.html#blockers"><span class="hs-identifier hs-type">blockers</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-87"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684408810"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">~</span></span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#MemOp"><span class="hs-identifier hs-type">MemOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684408809"><span class="hs-identifier hs-type">inner</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-88"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#HoistBlockers"><span class="hs-identifier hs-type">Simplify.HoistBlockers</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684408810"><span class="hs-identifier hs-type">rep</span></a></span></span></span><span>
</span><span id="line-89"></span><span id="blockers"><span class="annot"><span class="annottext">blockers :: forall rep inner. (Op rep ~ MemOp inner) =&gt; HoistBlockers rep
</span><a href="Futhark.IR.Mem.Simplify.html#blockers"><span class="hs-identifier hs-var hs-var">blockers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-90"></span><span>  </span><span class="annot"><span class="annottext">HoistBlockers rep
forall rep. HoistBlockers rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#noExtraHoistBlockers"><span class="hs-identifier hs-var">Engine.noExtraHoistBlockers</span></a></span><span>
</span><span id="line-91"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">blockHoistPar :: BlockPred (Wise rep)
</span><a href="Futhark.Optimise.Simplify.Engine.html#blockHoistPar"><span class="hs-identifier hs-var">Engine.blockHoistPar</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlockPred (Wise rep)
forall rep op. (Op rep ~ MemOp op) =&gt; BlockPred rep
</span><a href="Futhark.IR.Mem.Simplify.html#isAlloc"><span class="hs-identifier hs-var">isAlloc</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-92"></span><span>      </span><span class="annot"><span class="annottext">blockHoistSeq :: BlockPred (Wise rep)
</span><a href="Futhark.Optimise.Simplify.Engine.html#blockHoistSeq"><span class="hs-identifier hs-var">Engine.blockHoistSeq</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlockPred (Wise rep)
forall rep op. (Op rep ~ MemOp op) =&gt; BlockPred rep
</span><a href="Futhark.IR.Mem.Simplify.html#isResultAlloc"><span class="hs-identifier hs-var">isResultAlloc</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-93"></span><span>      </span><span class="annot"><span class="annottext">isAllocation :: Stm (Wise rep) -&gt; Bool
</span><a href="Futhark.Optimise.Simplify.Engine.html#isAllocation"><span class="hs-identifier hs-var">Engine.isAllocation</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlockPred (Wise rep)
forall rep op. (Op rep ~ MemOp op) =&gt; BlockPred rep
</span><a href="Futhark.IR.Mem.Simplify.html#isAlloc"><span class="hs-identifier hs-var">isAlloc</span></a></span><span> </span><span class="annot"><span class="annottext">SymbolTable (Wise rep)
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">UsageTable
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-94"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-95"></span><span>
</span><span id="line-96"></span><span class="hs-comment">-- | Some constraints that must hold for the simplification rules to work.</span><span>
</span><span id="line-97"></span><span class="hs-keyword">type</span><span> </span><span id="SimplifyMemory"><span class="annot"><a href="Futhark.IR.Mem.Simplify.html#SimplifyMemory"><span class="hs-identifier hs-var">SimplifyMemory</span></a></span></span><span> </span><span id="local-6989586621684408316"><span class="annot"><a href="#local-6989586621684408316"><span class="hs-identifier hs-type">rep</span></a></span></span><span> </span><span id="local-6989586621684408315"><span class="annot"><a href="#local-6989586621684408315"><span class="hs-identifier hs-type">inner</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-98"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimplifiableRep"><span class="hs-identifier hs-type">Simplify.SimplifiableRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684408316"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-99"></span><span>    </span><span class="annot"><a href="Futhark.IR.Rep.html#LetDec"><span class="hs-identifier hs-type">LetDec</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684408316"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">~</span></span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#LetDecMem"><span class="hs-identifier hs-type">LetDecMem</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-100"></span><span>    </span><span class="annot"><a href="Futhark.IR.Rep.html#ExpDec"><span class="hs-identifier hs-type">ExpDec</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684408316"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">~</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-101"></span><span>    </span><span class="annot"><a href="Futhark.IR.Rep.html#BodyDec"><span class="hs-identifier hs-type">BodyDec</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684408316"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">~</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-102"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#CanBeWise"><span class="hs-identifier hs-type">CanBeWise</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684408316"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-103"></span><span>    </span><span class="annot"><a href="Futhark.Builder.html#BuilderOps"><span class="hs-identifier hs-type">BuilderOps</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684408316"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-104"></span><span>    </span><span class="annot"><a href="Futhark.IR.Mem.html#Mem"><span class="hs-identifier hs-type">Mem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684408316"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684408315"><span class="hs-identifier hs-type">inner</span></a></span><span>
</span><span id="line-105"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-106"></span><span>
</span><span id="line-107"></span><span id="local-6989586621684408811"><span id="local-6989586621684408812"><span class="annot"><a href="Futhark.IR.Mem.Simplify.html#callKernelRules"><span class="hs-identifier hs-type">callKernelRules</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.Simplify.html#SimplifyMemory"><span class="hs-identifier hs-type">SimplifyMemory</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684408812"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684408811"><span class="hs-identifier hs-type">inner</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Rule.html#RuleBook"><span class="hs-identifier hs-type">RuleBook</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684408812"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-108"></span><span id="callKernelRules"><span class="annot"><span class="annottext">callKernelRules :: forall rep inner. SimplifyMemory rep inner =&gt; RuleBook (Wise rep)
</span><a href="Futhark.IR.Mem.Simplify.html#callKernelRules"><span class="hs-identifier hs-var hs-var">callKernelRules</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-109"></span><span>  </span><span class="annot"><span class="annottext">RuleBook (Wise rep)
forall rep.
(BuilderOps rep, TraverseOpStms rep, Aliased rep) =&gt;
RuleBook rep
</span><a href="Futhark.Optimise.Simplify.Rules.html#standardRules"><span class="hs-identifier hs-var">standardRules</span></a></span><span>
</span><span id="line-110"></span><span>    </span><span class="annot"><span class="annottext">RuleBook (Wise rep) -&gt; RuleBook (Wise rep) -&gt; RuleBook (Wise rep)
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[TopDownRule (Wise rep)]
-&gt; [BottomUpRule (Wise rep)] -&gt; RuleBook (Wise rep)
forall m. [TopDownRule m] -&gt; [BottomUpRule m] -&gt; RuleBook m
</span><a href="Futhark.Optimise.Simplify.Rule.html#ruleBook"><span class="hs-identifier hs-var">ruleBook</span></a></span><span>
</span><span id="line-111"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">RuleBasicOp (Wise rep) (TopDown (Wise rep))
-&gt; TopDownRule (Wise rep)
forall rep a. RuleBasicOp rep a -&gt; SimplificationRule rep a
</span><a href="Futhark.Optimise.Simplify.Rule.html#RuleBasicOp"><span class="hs-identifier hs-var">RuleBasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">RuleBasicOp (Wise rep) (TopDown (Wise rep))
forall rep u.
(BuilderOps rep, LetDec rep ~ (VarWisdom, MemBound u)) =&gt;
TopDownRuleBasicOp rep
</span><a href="Futhark.IR.Mem.Simplify.html#copyCopyToCopy"><span class="hs-identifier hs-var">copyCopyToCopy</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-112"></span><span>        </span><span class="annot"><span class="annottext">RuleIf (Wise rep) (TopDown (Wise rep)) -&gt; TopDownRule (Wise rep)
forall rep a. RuleIf rep a -&gt; SimplificationRule rep a
</span><a href="Futhark.Optimise.Simplify.Rule.html#RuleIf"><span class="hs-identifier hs-var">RuleIf</span></a></span><span> </span><span class="annot"><span class="annottext">RuleIf (Wise rep) (TopDown (Wise rep))
forall rep inner.
SimplifyMemory rep inner =&gt;
TopDownRuleIf (Wise rep)
</span><a href="Futhark.IR.Mem.Simplify.html#unExistentialiseMemory"><span class="hs-identifier hs-var">unExistentialiseMemory</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-113"></span><span>        </span><span class="annot"><span class="annottext">RuleOp (Wise rep) (TopDown (Wise rep)) -&gt; TopDownRule (Wise rep)
forall rep a. RuleOp rep a -&gt; SimplificationRule rep a
</span><a href="Futhark.Optimise.Simplify.Rule.html#RuleOp"><span class="hs-identifier hs-var">RuleOp</span></a></span><span> </span><span class="annot"><span class="annottext">RuleOp (Wise rep) (TopDown (Wise rep))
forall rep inner.
SimplifyMemory rep inner =&gt;
TopDownRuleOp (Wise rep)
</span><a href="Futhark.IR.Mem.Simplify.html#decertifySafeAlloc"><span class="hs-identifier hs-var">decertifySafeAlloc</span></a></span><span>
</span><span id="line-114"></span><span>      </span><span class="hs-special">]</span><span>
</span><span id="line-115"></span><span>      </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-116"></span><span>
</span><span id="line-117"></span><span class="hs-comment">-- | If a branch is returning some existential memory, but the size of</span><span>
</span><span id="line-118"></span><span class="hs-comment">-- the array is not existential, and the index function of the array</span><span>
</span><span id="line-119"></span><span class="hs-comment">-- does not refer to any names in the pattern, then we can create a</span><span>
</span><span id="line-120"></span><span class="hs-comment">-- block of the proper size and always return there.</span><span>
</span><span id="line-121"></span><span id="local-6989586621684408737"><span id="local-6989586621684408738"><span class="annot"><a href="Futhark.IR.Mem.Simplify.html#unExistentialiseMemory"><span class="hs-identifier hs-type">unExistentialiseMemory</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.Simplify.html#SimplifyMemory"><span class="hs-identifier hs-type">SimplifyMemory</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684408738"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684408737"><span class="hs-identifier hs-type">inner</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Rule.html#TopDownRuleIf"><span class="hs-identifier hs-type">TopDownRuleIf</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684408738"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-122"></span><span id="unExistentialiseMemory"><span class="annot"><span class="annottext">unExistentialiseMemory :: forall rep inner.
SimplifyMemory rep inner =&gt;
TopDownRuleIf (Wise rep)
</span><a href="Futhark.IR.Mem.Simplify.html#unExistentialiseMemory"><span class="hs-identifier hs-var hs-var">unExistentialiseMemory</span></a></span></span><span> </span><span id="local-6989586621684408125"><span class="annot"><span class="annottext">TopDown (Wise rep)
</span><a href="#local-6989586621684408125"><span class="hs-identifier hs-var">vtable</span></a></span></span><span> </span><span id="local-6989586621684408124"><span class="annot"><span class="annottext">Pat (Wise rep)
</span><a href="#local-6989586621684408124"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec (Wise rep))
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684408123"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684408123"><span class="hs-identifier hs-var">cond</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684408122"><span class="annot"><span class="annottext">BodyT (Wise rep)
</span><a href="#local-6989586621684408122"><span class="hs-identifier hs-var">tbranch</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684408121"><span class="annot"><span class="annottext">BodyT (Wise rep)
</span><a href="#local-6989586621684408121"><span class="hs-identifier hs-var">fbranch</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684408120"><span class="annot"><span class="annottext">IfDec (BranchType (Wise rep))
</span><a href="#local-6989586621684408120"><span class="hs-identifier hs-var">ifdec</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-123"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TopDown (Wise rep) -&gt; Bool
forall rep. SymbolTable rep -&gt; Bool
</span><a href="Futhark.Analysis.SymbolTable.html#simplifyMemory"><span class="hs-identifier hs-var hs-var">ST.simplifyMemory</span></a></span><span> </span><span class="annot"><span class="annottext">TopDown (Wise rep)
</span><a href="#local-6989586621684408125"><span class="hs-identifier hs-var">vtable</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-124"></span><span>    </span><span id="local-6989586621684408119"><span class="annot"><span class="annottext">[(PatElemT (VarWisdom, LetDecMem), PrimExp VName, VName, Space)]
</span><a href="#local-6989586621684408119"><span class="hs-identifier hs-var">fixable</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">([(PatElemT (VarWisdom, LetDecMem), PrimExp VName, VName, Space)]
 -&gt; PatElemT (VarWisdom, LetDecMem)
 -&gt; [(PatElemT (VarWisdom, LetDecMem), PrimExp VName, VName,
      Space)])
-&gt; [(PatElemT (VarWisdom, LetDecMem), PrimExp VName, VName, Space)]
-&gt; [PatElemT (VarWisdom, LetDecMem)]
-&gt; [(PatElemT (VarWisdom, LetDecMem), PrimExp VName, VName, Space)]
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl</span></span><span> </span><span class="annot"><span class="annottext">[(PatElemT (VarWisdom, LetDecMem), PrimExp VName, VName, Space)]
-&gt; PatElemT (VarWisdom, LetDecMem)
-&gt; [(PatElemT (VarWisdom, LetDecMem), PrimExp VName, VName, Space)]
</span><a href="#local-6989586621684408117"><span class="hs-identifier hs-var">hasConcretisableMemory</span></a></span><span> </span><span class="annot"><span class="annottext">[(PatElemT (VarWisdom, LetDecMem), PrimExp VName, VName, Space)]
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">([PatElemT (VarWisdom, LetDecMem)]
 -&gt; [(PatElemT (VarWisdom, LetDecMem), PrimExp VName, VName,
      Space)])
-&gt; [PatElemT (VarWisdom, LetDecMem)]
-&gt; [(PatElemT (VarWisdom, LetDecMem), PrimExp VName, VName, Space)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatT (VarWisdom, LetDecMem) -&gt; [PatElemT (VarWisdom, LetDecMem)]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span> </span><span class="annot"><span class="annottext">PatT (VarWisdom, LetDecMem)
Pat (Wise rep)
</span><a href="#local-6989586621684408124"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-125"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(PatElemT (VarWisdom, LetDecMem), PrimExp VName, VName, Space)]
-&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[(PatElemT (VarWisdom, LetDecMem), PrimExp VName, VName, Space)]
</span><a href="#local-6989586621684408119"><span class="hs-identifier hs-var">fixable</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleM (Wise rep) () -&gt; Rule (Wise rep)
forall rep. RuleM rep () -&gt; Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Simplify"><span class="hs-identifier hs-var">Simplify</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM (Wise rep) () -&gt; Rule (Wise rep))
-&gt; RuleM (Wise rep) () -&gt; Rule (Wise rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-126"></span><span>    </span><span class="hs-comment">-- Create non-existential memory blocks big enough to hold the</span><span>
</span><span id="line-127"></span><span>    </span><span class="hs-comment">-- arrays.</span><span>
</span><span id="line-128"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684408113"><span class="annot"><span class="annottext">[(VName, VName)]
</span><a href="#local-6989586621684408113"><span class="hs-identifier hs-var">arr_to_mem</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684408112"><span class="annot"><span class="annottext">[(VName, VName)]
</span><a href="#local-6989586621684408112"><span class="hs-identifier hs-var">oldmem_to_mem</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-129"></span><span>      </span><span class="annot"><span class="annottext">([((VName, VName), (VName, VName))]
 -&gt; ([(VName, VName)], [(VName, VName)]))
-&gt; RuleM (Wise rep) [((VName, VName), (VName, VName))]
-&gt; RuleM (Wise rep) ([(VName, VName)], [(VName, VName)])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">[((VName, VName), (VName, VName))]
-&gt; ([(VName, VName)], [(VName, VName)])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">(RuleM (Wise rep) [((VName, VName), (VName, VName))]
 -&gt; RuleM (Wise rep) ([(VName, VName)], [(VName, VName)]))
-&gt; RuleM (Wise rep) [((VName, VName), (VName, VName))]
-&gt; RuleM (Wise rep) ([(VName, VName)], [(VName, VName)])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-130"></span><span>        </span><span class="annot"><span class="annottext">[(PatElemT (VarWisdom, LetDecMem), PrimExp VName, VName, Space)]
-&gt; ((PatElemT (VarWisdom, LetDecMem), PrimExp VName, VName, Space)
    -&gt; RuleM (Wise rep) ((VName, VName), (VName, VName)))
-&gt; RuleM (Wise rep) [((VName, VName), (VName, VName))]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="annot"><span class="annottext">[(PatElemT (VarWisdom, LetDecMem), PrimExp VName, VName, Space)]
</span><a href="#local-6989586621684408119"><span class="hs-identifier hs-var">fixable</span></a></span><span> </span><span class="annot"><span class="annottext">(((PatElemT (VarWisdom, LetDecMem), PrimExp VName, VName, Space)
  -&gt; RuleM (Wise rep) ((VName, VName), (VName, VName)))
 -&gt; RuleM (Wise rep) [((VName, VName), (VName, VName))])
-&gt; ((PatElemT (VarWisdom, LetDecMem), PrimExp VName, VName, Space)
    -&gt; RuleM (Wise rep) ((VName, VName), (VName, VName)))
-&gt; RuleM (Wise rep) [((VName, VName), (VName, VName))]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684408109"><span class="annot"><span class="annottext">PatElemT (VarWisdom, LetDecMem)
</span><a href="#local-6989586621684408109"><span class="hs-identifier hs-var">arr_pe</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684408108"><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684408108"><span class="hs-identifier hs-var">mem_size</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684408107"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684408107"><span class="hs-identifier hs-var">oldmem</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684408106"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684408106"><span class="hs-identifier hs-var">space</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-131"></span><span>          </span><span id="local-6989586621684408105"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684408105"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; PrimExp VName -&gt; RuleM (Wise rep) SubExp
forall (m :: * -&gt; *) a.
(MonadBuilder m, ToExp a) =&gt;
String -&gt; a -&gt; m SubExp
</span><a href="Futhark.Construct.html#toSubExp"><span class="hs-identifier hs-var">toSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;size&quot;</span></span><span> </span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684408108"><span class="hs-identifier hs-var">mem_size</span></a></span><span>
</span><span id="line-132"></span><span>          </span><span id="local-6989586621684408103"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684408103"><span class="hs-identifier hs-var">mem</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; Exp (Rep (RuleM (Wise rep))) -&gt; RuleM (Wise rep) VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m VName
</span><a href="Futhark.Construct.html#letExp"><span class="hs-identifier hs-var">letExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;mem&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM (Wise rep))) -&gt; RuleM (Wise rep) VName)
-&gt; Exp (Rep (RuleM (Wise rep))) -&gt; RuleM (Wise rep) VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Op (Wise rep) -&gt; ExpT (Wise rep)
forall rep. Op rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-var">Op</span></a></span><span> </span><span class="annot"><span class="annottext">(Op (Wise rep) -&gt; ExpT (Wise rep))
-&gt; Op (Wise rep) -&gt; ExpT (Wise rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Space -&gt; MemOp (OpWithWisdom inner)
forall inner. SubExp -&gt; Space -&gt; MemOp inner
</span><a href="Futhark.IR.Mem.html#Alloc"><span class="hs-identifier hs-var">Alloc</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684408105"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684408106"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-133"></span><span>          </span><span class="annot"><span class="annottext">((VName, VName), (VName, VName))
-&gt; RuleM (Wise rep) ((VName, VName), (VName, VName))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT (VarWisdom, LetDecMem) -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (VarWisdom, LetDecMem)
</span><a href="#local-6989586621684408109"><span class="hs-identifier hs-var">arr_pe</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684408103"><span class="hs-identifier hs-var">mem</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684408107"><span class="hs-identifier hs-var">oldmem</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684408103"><span class="hs-identifier hs-var">mem</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-134"></span><span>
</span><span id="line-135"></span><span>    </span><span class="hs-comment">-- Update the branches to contain Copy expressions putting the</span><span>
</span><span id="line-136"></span><span>    </span><span class="hs-comment">-- arrays where they are expected.</span><span>
</span><span id="line-137"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684408101"><span class="annot"><span class="annottext">updateBody :: BodyT (Wise rep)
-&gt; RuleM (Wise rep) (Body (Rep (RuleM (Wise rep))))
</span><a href="#local-6989586621684408101"><span class="hs-identifier hs-var hs-var">updateBody</span></a></span></span><span> </span><span id="local-6989586621684408100"><span class="annot"><span class="annottext">BodyT (Wise rep)
</span><a href="#local-6989586621684408100"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleM (Wise rep) Result
-&gt; RuleM (Wise rep) (Body (Rep (RuleM (Wise rep))))
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
m Result -&gt; m (Body (Rep m))
</span><a href="Futhark.Construct.html#buildBody_"><span class="hs-identifier hs-var">buildBody_</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM (Wise rep) Result
 -&gt; RuleM (Wise rep) (Body (Rep (RuleM (Wise rep)))))
-&gt; RuleM (Wise rep) Result
-&gt; RuleM (Wise rep) (Body (Rep (RuleM (Wise rep))))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-138"></span><span>          </span><span id="local-6989586621684408098"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684408098"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Body (Rep (RuleM (Wise rep))) -&gt; RuleM (Wise rep) Result
forall (m :: * -&gt; *). MonadBuilder m =&gt; Body (Rep m) -&gt; m Result
</span><a href="Futhark.Builder.Class.html#bodyBind"><span class="hs-identifier hs-var">bodyBind</span></a></span><span> </span><span class="annot"><span class="annottext">Body (Rep (RuleM (Wise rep)))
BodyT (Wise rep)
</span><a href="#local-6989586621684408100"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-139"></span><span>          </span><span class="annot"><span class="annottext">(PatElemT (VarWisdom, LetDecMem)
 -&gt; SubExpRes -&gt; RuleM (Wise rep) SubExpRes)
-&gt; [PatElemT (VarWisdom, LetDecMem)]
-&gt; Result
-&gt; RuleM (Wise rep) Result
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m [c]
</span><span class="hs-identifier hs-var">zipWithM</span></span><span> </span><span class="annot"><span class="annottext">PatElemT (VarWisdom, LetDecMem)
-&gt; SubExpRes -&gt; RuleM (Wise rep) SubExpRes
</span><a href="#local-6989586621684408095"><span class="hs-identifier hs-var">updateResult</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatT (VarWisdom, LetDecMem) -&gt; [PatElemT (VarWisdom, LetDecMem)]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span> </span><span class="annot"><span class="annottext">PatT (VarWisdom, LetDecMem)
Pat (Wise rep)
</span><a href="#local-6989586621684408124"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684408098"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-140"></span><span>        </span><span id="local-6989586621684408095"><span class="annot"><span class="annottext">updateResult :: PatElemT (VarWisdom, LetDecMem)
-&gt; SubExpRes -&gt; RuleM (Wise rep) SubExpRes
</span><a href="#local-6989586621684408095"><span class="hs-identifier hs-var hs-var">updateResult</span></a></span></span><span> </span><span id="local-6989586621684408094"><span class="annot"><span class="annottext">PatElemT (VarWisdom, LetDecMem)
</span><a href="#local-6989586621684408094"><span class="hs-identifier hs-var">pat_elem</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-type">SubExpRes</span></a></span><span> </span><span id="local-6989586621684408092"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684408092"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684408090"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684408090"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-141"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684408089"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684408089"><span class="hs-identifier hs-var">mem</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; [(VName, VName)] -&gt; Maybe VName
forall a b. Eq a =&gt; a -&gt; [(a, b)] -&gt; Maybe b
</span><span class="hs-identifier hs-var">lookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT (VarWisdom, LetDecMem) -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (VarWisdom, LetDecMem)
</span><a href="#local-6989586621684408094"><span class="hs-identifier hs-var">pat_elem</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(VName, VName)]
</span><a href="#local-6989586621684408113"><span class="hs-identifier hs-var">arr_to_mem</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-142"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarWisdom
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-type">MemArray</span></a></span><span> </span><span id="local-6989586621684408086"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684408086"><span class="hs-identifier hs-var">pt</span></a></span></span><span> </span><span id="local-6989586621684408085"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684408085"><span class="hs-identifier hs-var">shape</span></a></span></span><span> </span><span id="local-6989586621684408084"><span class="annot"><span class="annottext">NoUniqueness
</span><a href="#local-6989586621684408084"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#ArrayIn"><span class="hs-identifier hs-type">ArrayIn</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684408082"><span class="annot"><span class="annottext">IxFun
</span><a href="#local-6989586621684408082"><span class="hs-identifier hs-var">ixfun</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PatElemT (VarWisdom, LetDecMem) -&gt; (VarWisdom, LetDecMem)
forall dec. PatElemT dec -&gt; dec
</span><a href="Futhark.IR.Syntax.Core.html#patElemDec"><span class="hs-identifier hs-var hs-var">patElemDec</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (VarWisdom, LetDecMem)
</span><a href="#local-6989586621684408094"><span class="hs-identifier hs-var">pat_elem</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-143"></span><span>            </span><span id="local-6989586621684408080"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684408080"><span class="hs-identifier hs-var">v_copy</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; RuleM (Wise rep) VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; String -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; RuleM (Wise rep) VName)
-&gt; String -&gt; RuleM (Wise rep) VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; String
</span><a href="Language.Futhark.Core.html#baseString"><span class="hs-identifier hs-var">baseString</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684408090"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_nonext_copy&quot;</span></span><span>
</span><span id="line-144"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684408077"><span class="annot"><span class="annottext">v_pat :: PatT LetDecMem
</span><a href="#local-6989586621684408077"><span class="hs-identifier hs-var hs-var">v_pat</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-145"></span><span>                  </span><span class="annot"><span class="annottext">[PatElemT LetDecMem] -&gt; PatT LetDecMem
forall dec. [PatElemT dec] -&gt; PatT dec
</span><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-var">Pat</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">VName -&gt; LetDecMem -&gt; PatElemT LetDecMem
forall dec. VName -&gt; dec -&gt; PatElemT dec
</span><a href="Futhark.IR.Syntax.Core.html#PatElem"><span class="hs-identifier hs-var">PatElem</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684408080"><span class="hs-identifier hs-var">v_copy</span></a></span><span> </span><span class="annot"><span class="annottext">(LetDecMem -&gt; PatElemT LetDecMem)
-&gt; LetDecMem -&gt; PatElemT LetDecMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; Shape -&gt; NoUniqueness -&gt; MemBind -&gt; LetDecMem
forall d u ret.
PrimType -&gt; ShapeBase d -&gt; u -&gt; ret -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-var">MemArray</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684408086"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684408085"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">NoUniqueness
</span><a href="#local-6989586621684408084"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">(MemBind -&gt; LetDecMem) -&gt; MemBind -&gt; LetDecMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; IxFun -&gt; MemBind
</span><a href="Futhark.IR.Mem.html#ArrayIn"><span class="hs-identifier hs-var">ArrayIn</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684408089"><span class="hs-identifier hs-var">mem</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun
</span><a href="#local-6989586621684408082"><span class="hs-identifier hs-var">ixfun</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-146"></span><span>            </span><span class="annot"><span class="annottext">Stm (Rep (RuleM (Wise rep))) -&gt; RuleM (Wise rep) ()
forall (m :: * -&gt; *). MonadBuilder m =&gt; Stm (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#addStm"><span class="hs-identifier hs-var">addStm</span></a></span><span> </span><span class="annot"><span class="annottext">(Stm (Rep (RuleM (Wise rep))) -&gt; RuleM (Wise rep) ())
-&gt; Stm (Rep (RuleM (Wise rep))) -&gt; RuleM (Wise rep) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat rep -&gt; StmAux (ExpDec rep) -&gt; ExpT (Wise rep) -&gt; Stm (Wise rep)
forall rep.
(ASTRep rep, CanBeWise (Op rep)) =&gt;
Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp (Wise rep) -&gt; Stm (Wise rep)
</span><a href="Futhark.Optimise.Simplify.Rep.html#mkWiseLetStm"><span class="hs-identifier hs-var">mkWiseLetStm</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
PatT LetDecMem
</span><a href="#local-6989586621684408077"><span class="hs-identifier hs-var">v_pat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; StmAux ()
forall dec. dec -&gt; StmAux dec
</span><a href="Futhark.IR.Prop.html#defAux"><span class="hs-identifier hs-var">defAux</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ExpT (Wise rep) -&gt; Stm (Wise rep))
-&gt; ExpT (Wise rep) -&gt; Stm (Wise rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT (Wise rep)
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Copy"><span class="hs-identifier hs-var">Copy</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684408090"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-147"></span><span>            </span><span class="annot"><span class="annottext">SubExpRes -&gt; RuleM (Wise rep) SubExpRes
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(SubExpRes -&gt; RuleM (Wise rep) SubExpRes)
-&gt; SubExpRes -&gt; RuleM (Wise rep) SubExpRes
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Certs -&gt; SubExp -&gt; SubExpRes
</span><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-var">SubExpRes</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684408092"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; SubExpRes) -&gt; SubExp -&gt; SubExpRes
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684408080"><span class="hs-identifier hs-var">v_copy</span></a></span><span>
</span><span id="line-148"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684408070"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684408070"><span class="hs-identifier hs-var">mem</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; [(VName, VName)] -&gt; Maybe VName
forall a b. Eq a =&gt; a -&gt; [(a, b)] -&gt; Maybe b
</span><span class="hs-identifier hs-var">lookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT (VarWisdom, LetDecMem) -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (VarWisdom, LetDecMem)
</span><a href="#local-6989586621684408094"><span class="hs-identifier hs-var">pat_elem</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(VName, VName)]
</span><a href="#local-6989586621684408112"><span class="hs-identifier hs-var">oldmem_to_mem</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-149"></span><span>            </span><span class="annot"><span class="annottext">SubExpRes -&gt; RuleM (Wise rep) SubExpRes
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(SubExpRes -&gt; RuleM (Wise rep) SubExpRes)
-&gt; SubExpRes -&gt; RuleM (Wise rep) SubExpRes
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Certs -&gt; SubExp -&gt; SubExpRes
</span><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-var">SubExpRes</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684408092"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; SubExpRes) -&gt; SubExp -&gt; SubExpRes
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684408070"><span class="hs-identifier hs-var">mem</span></a></span><span>
</span><span id="line-150"></span><span>        </span><span class="annot"><a href="#local-6989586621684408095"><span class="hs-identifier hs-var">updateResult</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (VarWisdom, LetDecMem)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684408069"><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684408069"><span class="hs-identifier hs-var">se</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-151"></span><span>          </span><span class="annot"><span class="annottext">SubExpRes -&gt; RuleM (Wise rep) SubExpRes
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684408069"><span class="hs-identifier hs-var">se</span></a></span><span>
</span><span id="line-152"></span><span>    </span><span id="local-6989586621684408068"><span class="annot"><span class="annottext">BodyT (Wise rep)
</span><a href="#local-6989586621684408068"><span class="hs-identifier hs-var">tbranch'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">BodyT (Wise rep)
-&gt; RuleM (Wise rep) (Body (Rep (RuleM (Wise rep))))
</span><a href="#local-6989586621684408101"><span class="hs-identifier hs-var">updateBody</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT (Wise rep)
</span><a href="#local-6989586621684408122"><span class="hs-identifier hs-var">tbranch</span></a></span><span>
</span><span id="line-153"></span><span>    </span><span id="local-6989586621684408067"><span class="annot"><span class="annottext">BodyT (Wise rep)
</span><a href="#local-6989586621684408067"><span class="hs-identifier hs-var">fbranch'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">BodyT (Wise rep)
-&gt; RuleM (Wise rep) (Body (Rep (RuleM (Wise rep))))
</span><a href="#local-6989586621684408101"><span class="hs-identifier hs-var">updateBody</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT (Wise rep)
</span><a href="#local-6989586621684408121"><span class="hs-identifier hs-var">fbranch</span></a></span><span>
</span><span id="line-154"></span><span>    </span><span class="annot"><span class="annottext">Pat (Rep (RuleM (Wise rep)))
-&gt; Exp (Rep (RuleM (Wise rep))) -&gt; RuleM (Wise rep) ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">Pat (Rep (RuleM (Wise rep)))
Pat (Wise rep)
</span><a href="#local-6989586621684408124"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM (Wise rep))) -&gt; RuleM (Wise rep) ())
-&gt; Exp (Rep (RuleM (Wise rep))) -&gt; RuleM (Wise rep) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp
-&gt; BodyT (Wise rep)
-&gt; BodyT (Wise rep)
-&gt; IfDec (BranchType (Wise rep))
-&gt; ExpT (Wise rep)
forall rep.
SubExp
-&gt; BodyT rep -&gt; BodyT rep -&gt; IfDec (BranchType rep) -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#If"><span class="hs-identifier hs-var">If</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684408123"><span class="hs-identifier hs-var">cond</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT (Wise rep)
</span><a href="#local-6989586621684408068"><span class="hs-identifier hs-var">tbranch'</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT (Wise rep)
</span><a href="#local-6989586621684408067"><span class="hs-identifier hs-var">fbranch'</span></a></span><span> </span><span class="annot"><span class="annottext">IfDec (BranchType (Wise rep))
</span><a href="#local-6989586621684408120"><span class="hs-identifier hs-var">ifdec</span></a></span><span>
</span><span id="line-155"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-156"></span><span>    </span><span id="local-6989586621684408064"><span class="annot"><span class="annottext">onlyUsedIn :: VName -&gt; VName -&gt; Bool
</span><a href="#local-6989586621684408064"><span class="hs-identifier hs-var hs-var">onlyUsedIn</span></a></span></span><span> </span><span id="local-6989586621684408063"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684408063"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621684408062"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684408062"><span class="hs-identifier hs-var">here</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-157"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool)
-&gt; ([PatElemT (VarWisdom, LetDecMem)] -&gt; Bool)
-&gt; [PatElemT (VarWisdom, LetDecMem)]
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(PatElemT (VarWisdom, LetDecMem) -&gt; Bool)
-&gt; [PatElemT (VarWisdom, LetDecMem)] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684408063"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#nameIn"><span class="hs-operator hs-var">`nameIn`</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Names -&gt; Bool)
-&gt; (PatElemT (VarWisdom, LetDecMem) -&gt; Names)
-&gt; PatElemT (VarWisdom, LetDecMem)
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PatElemT (VarWisdom, LetDecMem) -&gt; Names
forall a. FreeIn a =&gt; a -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#freeIn"><span class="hs-identifier hs-var">freeIn</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([PatElemT (VarWisdom, LetDecMem)] -&gt; Bool)
-&gt; ([PatElemT (VarWisdom, LetDecMem)]
    -&gt; [PatElemT (VarWisdom, LetDecMem)])
-&gt; [PatElemT (VarWisdom, LetDecMem)]
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(PatElemT (VarWisdom, LetDecMem) -&gt; Bool)
-&gt; [PatElemT (VarWisdom, LetDecMem)]
-&gt; [PatElemT (VarWisdom, LetDecMem)]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; VName -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684408062"><span class="hs-identifier hs-var">here</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Bool)
-&gt; (PatElemT (VarWisdom, LetDecMem) -&gt; VName)
-&gt; PatElemT (VarWisdom, LetDecMem)
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PatElemT (VarWisdom, LetDecMem) -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([PatElemT (VarWisdom, LetDecMem)] -&gt; Bool)
-&gt; [PatElemT (VarWisdom, LetDecMem)] -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-158"></span><span>        </span><span class="annot"><span class="annottext">PatT (VarWisdom, LetDecMem) -&gt; [PatElemT (VarWisdom, LetDecMem)]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span> </span><span class="annot"><span class="annottext">PatT (VarWisdom, LetDecMem)
Pat (Wise rep)
</span><a href="#local-6989586621684408124"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-159"></span><span>    </span><span id="local-6989586621684408056"><span class="annot"><span class="annottext">knownSize :: SubExp -&gt; Bool
</span><a href="#local-6989586621684408056"><span class="hs-identifier hs-var hs-var">knownSize</span></a></span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-160"></span><span>    </span><span class="annot"><a href="#local-6989586621684408056"><span class="hs-identifier hs-var">knownSize</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684408054"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684408054"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Bool
</span><a href="#local-6989586621684408053"><span class="hs-identifier hs-var">inContext</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684408054"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-161"></span><span>    </span><span id="local-6989586621684408053"><span class="annot"><span class="annottext">inContext :: VName -&gt; Bool
</span><a href="#local-6989586621684408053"><span class="hs-identifier hs-var hs-var">inContext</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; [VName] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">PatT (VarWisdom, LetDecMem) -&gt; [VName]
forall dec. PatT dec -&gt; [VName]
</span><a href="Futhark.IR.Prop.Patterns.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="annot"><span class="annottext">PatT (VarWisdom, LetDecMem)
Pat (Wise rep)
</span><a href="#local-6989586621684408124"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-162"></span><span>
</span><span id="line-163"></span><span>    </span><span id="local-6989586621684408117"><span class="annot"><span class="annottext">hasConcretisableMemory :: [(PatElemT (VarWisdom, LetDecMem), PrimExp VName, VName, Space)]
-&gt; PatElemT (VarWisdom, LetDecMem)
-&gt; [(PatElemT (VarWisdom, LetDecMem), PrimExp VName, VName, Space)]
</span><a href="#local-6989586621684408117"><span class="hs-identifier hs-var hs-var">hasConcretisableMemory</span></a></span></span><span> </span><span id="local-6989586621684408050"><span class="annot"><span class="annottext">[(PatElemT (VarWisdom, LetDecMem), PrimExp VName, VName, Space)]
</span><a href="#local-6989586621684408050"><span class="hs-identifier hs-var">fixable</span></a></span></span><span> </span><span id="local-6989586621684408049"><span class="annot"><span class="annottext">PatElemT (VarWisdom, LetDecMem)
</span><a href="#local-6989586621684408049"><span class="hs-identifier hs-var">pat_elem</span></a></span></span><span>
</span><span id="line-164"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarWisdom
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-type">MemArray</span></a></span><span> </span><span id="local-6989586621684408048"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684408048"><span class="hs-identifier hs-var">pt</span></a></span></span><span> </span><span id="local-6989586621684408047"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684408047"><span class="hs-identifier hs-var">shape</span></a></span></span><span> </span><span class="annot"><span class="annottext">NoUniqueness
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#ArrayIn"><span class="hs-identifier hs-type">ArrayIn</span></a></span><span> </span><span id="local-6989586621684408046"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684408046"><span class="hs-identifier hs-var">mem</span></a></span></span><span> </span><span id="local-6989586621684408045"><span class="annot"><span class="annottext">IxFun
</span><a href="#local-6989586621684408045"><span class="hs-identifier hs-var">ixfun</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PatElemT (VarWisdom, LetDecMem) -&gt; (VarWisdom, LetDecMem)
forall dec. PatElemT dec -&gt; dec
</span><a href="Futhark.IR.Syntax.Core.html#patElemDec"><span class="hs-identifier hs-var hs-var">patElemDec</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (VarWisdom, LetDecMem)
</span><a href="#local-6989586621684408049"><span class="hs-identifier hs-var">pat_elem</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-165"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684408044"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684408044"><span class="hs-identifier hs-var">j</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Mem"><span class="hs-identifier hs-type">Mem</span></a></span><span> </span><span id="local-6989586621684408042"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684408042"><span class="hs-identifier hs-var">space</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-166"></span><span>          </span><span class="annot"><span class="annottext">(PatElemT (VarWisdom, LetDecMem) -&gt; TypeBase Shape NoUniqueness)
-&gt; (Int, PatElemT (VarWisdom, LetDecMem))
-&gt; (Int, TypeBase Shape NoUniqueness)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">PatElemT (VarWisdom, LetDecMem) -&gt; TypeBase Shape NoUniqueness
forall dec.
Typed dec =&gt;
PatElemT dec -&gt; TypeBase Shape NoUniqueness
</span><a href="Futhark.IR.Prop.Patterns.html#patElemType"><span class="hs-identifier hs-var">patElemType</span></a></span><span>
</span><span id="line-167"></span><span>            </span><span class="annot"><span class="annottext">((Int, PatElemT (VarWisdom, LetDecMem))
 -&gt; (Int, TypeBase Shape NoUniqueness))
-&gt; Maybe (Int, PatElemT (VarWisdom, LetDecMem))
-&gt; Maybe (Int, TypeBase Shape NoUniqueness)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">((Int, PatElemT (VarWisdom, LetDecMem)) -&gt; Bool)
-&gt; [(Int, PatElemT (VarWisdom, LetDecMem))]
-&gt; Maybe (Int, PatElemT (VarWisdom, LetDecMem))
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Maybe a
</span><span class="hs-identifier hs-var">find</span></span><span>
</span><span id="line-168"></span><span>              </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684408046"><span class="hs-identifier hs-var">mem</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; VName -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Bool)
-&gt; ((Int, PatElemT (VarWisdom, LetDecMem)) -&gt; VName)
-&gt; (Int, PatElemT (VarWisdom, LetDecMem))
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PatElemT (VarWisdom, LetDecMem) -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">(PatElemT (VarWisdom, LetDecMem) -&gt; VName)
-&gt; ((Int, PatElemT (VarWisdom, LetDecMem))
    -&gt; PatElemT (VarWisdom, LetDecMem))
-&gt; (Int, PatElemT (VarWisdom, LetDecMem))
-&gt; VName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Int, PatElemT (VarWisdom, LetDecMem))
-&gt; PatElemT (VarWisdom, LetDecMem)
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">)</span><span>
</span><span id="line-169"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Int]
-&gt; [PatElemT (VarWisdom, LetDecMem)]
-&gt; [(Int, PatElemT (VarWisdom, LetDecMem))]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">..</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">([PatElemT (VarWisdom, LetDecMem)]
 -&gt; [(Int, PatElemT (VarWisdom, LetDecMem))])
-&gt; [PatElemT (VarWisdom, LetDecMem)]
-&gt; [(Int, PatElemT (VarWisdom, LetDecMem))]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatT (VarWisdom, LetDecMem) -&gt; [PatElemT (VarWisdom, LetDecMem)]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span> </span><span class="annot"><span class="annottext">PatT (VarWisdom, LetDecMem)
Pat (Wise rep)
</span><a href="#local-6989586621684408124"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-170"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684408039"><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684408039"><span class="hs-identifier hs-var">tse</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Result -&gt; Maybe SubExpRes
forall int a. Integral int =&gt; int -&gt; [a] -&gt; Maybe a
</span><a href="Futhark.Util.html#maybeNth"><span class="hs-identifier hs-var">maybeNth</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684408044"><span class="hs-identifier hs-var">j</span></a></span><span> </span><span class="annot"><span class="annottext">(Result -&gt; Maybe SubExpRes) -&gt; Result -&gt; Maybe SubExpRes
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BodyT (Wise rep) -&gt; Result
forall rep. BodyT rep -&gt; Result
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var hs-var">bodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT (Wise rep)
</span><a href="#local-6989586621684408122"><span class="hs-identifier hs-var">tbranch</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-171"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684408036"><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684408036"><span class="hs-identifier hs-var">fse</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Result -&gt; Maybe SubExpRes
forall int a. Integral int =&gt; int -&gt; [a] -&gt; Maybe a
</span><a href="Futhark.Util.html#maybeNth"><span class="hs-identifier hs-var">maybeNth</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684408044"><span class="hs-identifier hs-var">j</span></a></span><span> </span><span class="annot"><span class="annottext">(Result -&gt; Maybe SubExpRes) -&gt; Result -&gt; Maybe SubExpRes
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BodyT (Wise rep) -&gt; Result
forall rep. BodyT rep -&gt; Result
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var hs-var">bodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT (Wise rep)
</span><a href="#local-6989586621684408121"><span class="hs-identifier hs-var">fbranch</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-172"></span><span>        </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684408046"><span class="hs-identifier hs-var">mem</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; VName -&gt; Bool
</span><a href="#local-6989586621684408064"><span class="hs-operator hs-var">`onlyUsedIn`</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (VarWisdom, LetDecMem) -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (VarWisdom, LetDecMem)
</span><a href="#local-6989586621684408049"><span class="hs-identifier hs-var">pat_elem</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-173"></span><span>        </span><span class="annot"><span class="annottext">(SubExp -&gt; Bool) -&gt; [SubExp] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Bool
</span><a href="#local-6989586621684408056"><span class="hs-identifier hs-var">knownSize</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Shape -&gt; [SubExp]
forall d. ShapeBase d -&gt; [d]
</span><a href="Futhark.IR.Syntax.Core.html#shapeDims"><span class="hs-identifier hs-var hs-var">shapeDims</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684408047"><span class="hs-identifier hs-var">shape</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-174"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IxFun -&gt; Names
forall a. FreeIn a =&gt; a -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#freeIn"><span class="hs-identifier hs-var">freeIn</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun
</span><a href="#local-6989586621684408045"><span class="hs-identifier hs-var">ixfun</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#namesIntersect"><span class="hs-operator hs-var">`namesIntersect`</span></a></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#namesFromList"><span class="hs-identifier hs-var">namesFromList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatT (VarWisdom, LetDecMem) -&gt; [VName]
forall dec. PatT dec -&gt; [VName]
</span><a href="Futhark.IR.Prop.Patterns.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="annot"><span class="annottext">PatT (VarWisdom, LetDecMem)
Pat (Wise rep)
</span><a href="#local-6989586621684408124"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-175"></span><span>        </span><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684408036"><span class="hs-identifier hs-var">fse</span></a></span><span> </span><span class="annot"><span class="annottext">SubExpRes -&gt; SubExpRes -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684408039"><span class="hs-identifier hs-var">tse</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-176"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684408032"><span class="annot"><span class="annottext">mem_size :: PrimExp VName
</span><a href="#local-6989586621684408032"><span class="hs-identifier hs-var hs-var">mem_size</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-177"></span><span>              </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; PrimExp VName
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName -&gt; PrimExp VName)
-&gt; TPrimExp Int64 VName -&gt; PrimExp VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName] -&gt; TPrimExp Int64 VName
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">product</span></span><span> </span><span class="annot"><span class="annottext">([TPrimExp Int64 VName] -&gt; TPrimExp Int64 VName)
-&gt; [TPrimExp Int64 VName] -&gt; TPrimExp Int64 VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; PrimType -&gt; a
</span><a href="Futhark.IR.Primitive.html#primByteSize"><span class="hs-identifier hs-var">primByteSize</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684408048"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; [TPrimExp Int64 VName] -&gt; [TPrimExp Int64 VName]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName -&gt; TPrimExp Int64 VName)
-&gt; [TPrimExp Int64 VName] -&gt; [TPrimExp Int64 VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IxFun -&gt; [TPrimExp Int64 VName]
forall num. IxFun num -&gt; Shape num
</span><a href="Futhark.IR.Mem.IxFun.html#base"><span class="hs-identifier hs-var hs-var">IxFun.base</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun
</span><a href="#local-6989586621684408045"><span class="hs-identifier hs-var">ixfun</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-178"></span><span>         </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT (VarWisdom, LetDecMem)
</span><a href="#local-6989586621684408049"><span class="hs-identifier hs-var">pat_elem</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684408032"><span class="hs-identifier hs-var">mem_size</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684408046"><span class="hs-identifier hs-var">mem</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684408042"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(PatElemT (VarWisdom, LetDecMem), PrimExp VName, VName, Space)
-&gt; [(PatElemT (VarWisdom, LetDecMem), PrimExp VName, VName, Space)]
-&gt; [(PatElemT (VarWisdom, LetDecMem), PrimExp VName, VName, Space)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[(PatElemT (VarWisdom, LetDecMem), PrimExp VName, VName, Space)]
</span><a href="#local-6989586621684408050"><span class="hs-identifier hs-var">fixable</span></a></span><span>
</span><span id="line-179"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-180"></span><span>        </span><span class="annot"><span class="annottext">[(PatElemT (VarWisdom, LetDecMem), PrimExp VName, VName, Space)]
</span><a href="#local-6989586621684408050"><span class="hs-identifier hs-var">fixable</span></a></span><span>
</span><span id="line-181"></span><span class="annot"><a href="Futhark.IR.Mem.Simplify.html#unExistentialiseMemory"><span class="hs-identifier hs-var">unExistentialiseMemory</span></a></span><span> </span><span class="annot"><span class="annottext">TopDown (Wise rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Pat (Wise rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec (Wise rep))
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">(SubExp, BodyT (Wise rep), BodyT (Wise rep),
 IfDec (BranchType (Wise rep)))
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Rule (Wise rep)
forall rep. Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span>
</span><span id="line-182"></span><span>
</span><span id="line-183"></span><span class="hs-comment">-- | If we are copying something that is itself a copy, just copy the</span><span>
</span><span id="line-184"></span><span class="hs-comment">-- original one instead.</span><span>
</span><span id="line-185"></span><span id="local-6989586621684408742"><span id="local-6989586621684408743"><span class="annot"><a href="Futhark.IR.Mem.Simplify.html#copyCopyToCopy"><span class="hs-identifier hs-type">copyCopyToCopy</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-186"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.Builder.html#BuilderOps"><span class="hs-identifier hs-type">BuilderOps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684408743"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-187"></span><span>    </span><span class="annot"><a href="Futhark.IR.Rep.html#LetDec"><span class="hs-identifier hs-type">LetDec</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684408743"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">~</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#VarWisdom"><span class="hs-identifier hs-type">VarWisdom</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#MemBound"><span class="hs-identifier hs-type">MemBound</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684408742"><span class="hs-identifier hs-type">u</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-188"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-189"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Rule.html#TopDownRuleBasicOp"><span class="hs-identifier hs-type">TopDownRuleBasicOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684408743"><span class="hs-identifier hs-type">rep</span></a></span></span></span><span>
</span><span id="line-190"></span><span id="copyCopyToCopy"><span class="annot"><span class="annottext">copyCopyToCopy :: forall rep u.
(BuilderOps rep, LetDec rep ~ (VarWisdom, MemBound u)) =&gt;
TopDownRuleBasicOp rep
</span><a href="Futhark.IR.Mem.Simplify.html#copyCopyToCopy"><span class="hs-identifier hs-var hs-var">copyCopyToCopy</span></a></span></span><span> </span><span id="local-6989586621684408000"><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684408000"><span class="hs-identifier hs-var">vtable</span></a></span></span><span> </span><span id="local-6989586621684407999"><span class="annot"><span class="annottext">pat :: Pat rep
</span><a href="#local-6989586621684407999"><span class="hs-identifier hs-var">pat</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621684407998"><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684407998"><span class="hs-identifier hs-var">pat_elem</span></a></span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Copy"><span class="hs-identifier hs-type">Copy</span></a></span><span> </span><span id="local-6989586621684407997"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684407997"><span class="hs-identifier hs-var">v1</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-191"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Copy"><span class="hs-identifier hs-type">Copy</span></a></span><span> </span><span id="local-6989586621684407996"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684407996"><span class="hs-identifier hs-var">v2</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621684407995"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684407995"><span class="hs-identifier hs-var">v1_cs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; TopDown rep -&gt; Maybe (Exp rep, Certs)
forall rep. VName -&gt; SymbolTable rep -&gt; Maybe (Exp rep, Certs)
</span><a href="Futhark.Analysis.SymbolTable.html#lookupExp"><span class="hs-identifier hs-var">ST.lookupExp</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684407997"><span class="hs-identifier hs-var">v1</span></a></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684408000"><span class="hs-identifier hs-var">vtable</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-192"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarWisdom
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-type">MemArray</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Shape
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">u
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#ArrayIn"><span class="hs-identifier hs-type">ArrayIn</span></a></span><span> </span><span id="local-6989586621684407993"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684407993"><span class="hs-identifier hs-var">srcmem</span></a></span></span><span> </span><span id="local-6989586621684407992"><span class="annot"><span class="annottext">IxFun
</span><a href="#local-6989586621684407992"><span class="hs-identifier hs-var">src_ixfun</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-193"></span><span>      </span><span class="annot"><span class="annottext">Entry rep -&gt; Maybe (VarWisdom, MemBound u)
forall rep. Entry rep -&gt; Maybe (LetDec rep)
</span><a href="Futhark.Analysis.SymbolTable.html#entryLetBoundDec"><span class="hs-identifier hs-var">ST.entryLetBoundDec</span></a></span><span> </span><span class="annot"><span class="annottext">(Entry rep -&gt; Maybe (VarWisdom, MemBound u))
-&gt; Maybe (Entry rep) -&gt; Maybe (VarWisdom, MemBound u)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TopDown rep -&gt; Maybe (Entry rep)
forall rep. VName -&gt; SymbolTable rep -&gt; Maybe (Entry rep)
</span><a href="Futhark.Analysis.SymbolTable.html#lookup"><span class="hs-identifier hs-var">ST.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684407997"><span class="hs-identifier hs-var">v1</span></a></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684408000"><span class="hs-identifier hs-var">vtable</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-194"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Mem"><span class="hs-identifier hs-type">Mem</span></a></span><span> </span><span id="local-6989586621684407988"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684407988"><span class="hs-identifier hs-var">src_space</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; TopDown rep -&gt; Maybe (TypeBase Shape NoUniqueness)
forall rep.
ASTRep rep =&gt;
VName -&gt; SymbolTable rep -&gt; Maybe (TypeBase Shape NoUniqueness)
</span><a href="Futhark.Analysis.SymbolTable.html#lookupType"><span class="hs-identifier hs-var">ST.lookupType</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684407993"><span class="hs-identifier hs-var">srcmem</span></a></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684408000"><span class="hs-identifier hs-var">vtable</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-195"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarWisdom
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-type">MemArray</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Shape
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">u
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#ArrayIn"><span class="hs-identifier hs-type">ArrayIn</span></a></span><span> </span><span id="local-6989586621684407986"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684407986"><span class="hs-identifier hs-var">destmem</span></a></span></span><span> </span><span id="local-6989586621684407985"><span class="annot"><span class="annottext">IxFun
</span><a href="#local-6989586621684407985"><span class="hs-identifier hs-var">dest_ixfun</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PatElemT (VarWisdom, MemBound u) -&gt; (VarWisdom, MemBound u)
forall dec. PatElemT dec -&gt; dec
</span><a href="Futhark.IR.Syntax.Core.html#patElemDec"><span class="hs-identifier hs-var hs-var">patElemDec</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (VarWisdom, MemBound u)
PatElemT (LetDec rep)
</span><a href="#local-6989586621684407998"><span class="hs-identifier hs-var">pat_elem</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-196"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Mem"><span class="hs-identifier hs-type">Mem</span></a></span><span> </span><span id="local-6989586621684407984"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684407984"><span class="hs-identifier hs-var">dest_space</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; TopDown rep -&gt; Maybe (TypeBase Shape NoUniqueness)
forall rep.
ASTRep rep =&gt;
VName -&gt; SymbolTable rep -&gt; Maybe (TypeBase Shape NoUniqueness)
</span><a href="Futhark.Analysis.SymbolTable.html#lookupType"><span class="hs-identifier hs-var">ST.lookupType</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684407986"><span class="hs-identifier hs-var">destmem</span></a></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684408000"><span class="hs-identifier hs-var">vtable</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-197"></span><span>    </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684407988"><span class="hs-identifier hs-var">src_space</span></a></span><span> </span><span class="annot"><span class="annottext">Space -&gt; Space -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684407984"><span class="hs-identifier hs-var">dest_space</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-198"></span><span>    </span><span class="annot"><span class="annottext">IxFun
</span><a href="#local-6989586621684407985"><span class="hs-identifier hs-var">dest_ixfun</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun -&gt; IxFun -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">IxFun
</span><a href="#local-6989586621684407992"><span class="hs-identifier hs-var">src_ixfun</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-199"></span><span>    </span><span class="annot"><span class="annottext">RuleM rep () -&gt; Rule rep
forall rep. RuleM rep () -&gt; Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Simplify"><span class="hs-identifier hs-var">Simplify</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; Rule rep) -&gt; RuleM rep () -&gt; Rule rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Certs -&gt; RuleM rep () -&gt; RuleM rep ()
forall (m :: * -&gt; *) a. MonadBuilder m =&gt; Certs -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#certifying"><span class="hs-identifier hs-var">certifying</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684407995"><span class="hs-identifier hs-var">v1_cs</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; RuleM rep ()) -&gt; RuleM rep () -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat (Rep (RuleM rep)) -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
Pat (Rep (RuleM rep))
</span><a href="#local-6989586621684407999"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep ())
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; Exp rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; Exp rep) -&gt; BasicOp -&gt; Exp rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Copy"><span class="hs-identifier hs-var">Copy</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684407996"><span class="hs-identifier hs-var">v2</span></a></span><span>
</span><span id="line-200"></span><span class="annot"><a href="Futhark.IR.Mem.Simplify.html#copyCopyToCopy"><span class="hs-identifier hs-var">copyCopyToCopy</span></a></span><span> </span><span id="local-6989586621684407982"><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684407982"><span class="hs-identifier hs-var">vtable</span></a></span></span><span> </span><span id="local-6989586621684407981"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684407981"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Copy"><span class="hs-identifier hs-type">Copy</span></a></span><span> </span><span id="local-6989586621684407980"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684407980"><span class="hs-identifier hs-var">v0</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-201"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Rearrange"><span class="hs-identifier hs-type">Rearrange</span></a></span><span> </span><span id="local-6989586621684407978"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684407978"><span class="hs-identifier hs-var">perm</span></a></span></span><span> </span><span id="local-6989586621684407977"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684407977"><span class="hs-identifier hs-var">v1</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621684407976"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684407976"><span class="hs-identifier hs-var">v0_cs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; TopDown rep -&gt; Maybe (Exp rep, Certs)
forall rep. VName -&gt; SymbolTable rep -&gt; Maybe (Exp rep, Certs)
</span><a href="Futhark.Analysis.SymbolTable.html#lookupExp"><span class="hs-identifier hs-var">ST.lookupExp</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684407980"><span class="hs-identifier hs-var">v0</span></a></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684407982"><span class="hs-identifier hs-var">vtable</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-202"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Copy"><span class="hs-identifier hs-type">Copy</span></a></span><span> </span><span id="local-6989586621684407975"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684407975"><span class="hs-identifier hs-var">v2</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621684407974"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684407974"><span class="hs-identifier hs-var">v1_cs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; TopDown rep -&gt; Maybe (Exp rep, Certs)
forall rep. VName -&gt; SymbolTable rep -&gt; Maybe (Exp rep, Certs)
</span><a href="Futhark.Analysis.SymbolTable.html#lookupExp"><span class="hs-identifier hs-var">ST.lookupExp</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684407977"><span class="hs-identifier hs-var">v1</span></a></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684407982"><span class="hs-identifier hs-var">vtable</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleM rep () -&gt; Rule rep
forall rep. RuleM rep () -&gt; Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Simplify"><span class="hs-identifier hs-var">Simplify</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; Rule rep) -&gt; RuleM rep () -&gt; Rule rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-203"></span><span>    </span><span id="local-6989586621684407973"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684407973"><span class="hs-identifier hs-var">v0'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-204"></span><span>      </span><span class="annot"><span class="annottext">Certs -&gt; RuleM rep VName -&gt; RuleM rep VName
forall (m :: * -&gt; *) a. MonadBuilder m =&gt; Certs -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#certifying"><span class="hs-identifier hs-var">certifying</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684407976"><span class="hs-identifier hs-var">v0_cs</span></a></span><span> </span><span class="annot"><span class="annottext">Certs -&gt; Certs -&gt; Certs
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684407974"><span class="hs-identifier hs-var">v1_cs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(RuleM rep VName -&gt; RuleM rep VName)
-&gt; RuleM rep VName -&gt; RuleM rep VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-205"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m VName
</span><a href="Futhark.Construct.html#letExp"><span class="hs-identifier hs-var">letExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;rearrange_v0&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep VName)
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; Exp rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; Exp rep) -&gt; BasicOp -&gt; Exp rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; VName -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Rearrange"><span class="hs-identifier hs-var">Rearrange</span></a></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684407978"><span class="hs-identifier hs-var">perm</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684407975"><span class="hs-identifier hs-var">v2</span></a></span><span>
</span><span id="line-206"></span><span>    </span><span class="annot"><span class="annottext">Pat (Rep (RuleM rep)) -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
Pat (Rep (RuleM rep))
</span><a href="#local-6989586621684407981"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep ())
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; Exp rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; Exp rep) -&gt; BasicOp -&gt; Exp rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Copy"><span class="hs-identifier hs-var">Copy</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684407973"><span class="hs-identifier hs-var">v0'</span></a></span><span>
</span><span id="line-207"></span><span class="annot"><a href="Futhark.IR.Mem.Simplify.html#copyCopyToCopy"><span class="hs-identifier hs-var">copyCopyToCopy</span></a></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">BasicOp
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Rule rep
forall rep. Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span>
</span><span id="line-208"></span><span>
</span><span id="line-209"></span><span class="hs-comment">-- If an allocation is statically known to be safe, then we can remove</span><span>
</span><span id="line-210"></span><span class="hs-comment">-- the certificates on it.  This can help hoist things that would</span><span>
</span><span id="line-211"></span><span class="hs-comment">-- otherwise be stuck inside loops or branches.</span><span>
</span><span id="line-212"></span><span id="local-6989586621684408733"><span id="local-6989586621684408734"><span class="annot"><a href="Futhark.IR.Mem.Simplify.html#decertifySafeAlloc"><span class="hs-identifier hs-type">decertifySafeAlloc</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.Simplify.html#SimplifyMemory"><span class="hs-identifier hs-type">SimplifyMemory</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684408734"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684408733"><span class="hs-identifier hs-type">inner</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Rule.html#TopDownRuleOp"><span class="hs-identifier hs-type">TopDownRuleOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684408734"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-213"></span><span id="decertifySafeAlloc"><span class="annot"><span class="annottext">decertifySafeAlloc :: forall rep inner.
SimplifyMemory rep inner =&gt;
TopDownRuleOp (Wise rep)
</span><a href="Futhark.IR.Mem.Simplify.html#decertifySafeAlloc"><span class="hs-identifier hs-var hs-var">decertifySafeAlloc</span></a></span></span><span> </span><span class="annot"><span class="annottext">TopDown (Wise rep)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684407939"><span class="annot"><span class="annottext">Pat (Wise rep)
</span><a href="#local-6989586621684407939"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#StmAux"><span class="hs-identifier hs-type">StmAux</span></a></span><span> </span><span id="local-6989586621684407937"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684407937"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span id="local-6989586621684407936"><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684407936"><span class="hs-identifier hs-var">attrs</span></a></span></span><span> </span><span class="annot"><span class="annottext">ExpDec (Wise rep)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684407935"><span class="annot"><span class="annottext">Op (Wise rep)
</span><a href="#local-6989586621684407935"><span class="hs-identifier hs-var">op</span></a></span></span><span>
</span><span id="line-214"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684407937"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">Certs -&gt; Certs -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Certs
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">,</span><span>
</span><span id="line-215"></span><span>    </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Mem"><span class="hs-identifier hs-type">Mem</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><span class="hs-identifier">_</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PatT (VarWisdom, LetDecMem) -&gt; [TypeBase Shape NoUniqueness]
forall dec. Typed dec =&gt; PatT dec -&gt; [TypeBase Shape NoUniqueness]
</span><a href="Futhark.IR.Prop.Patterns.html#patTypes"><span class="hs-identifier hs-var">patTypes</span></a></span><span> </span><span class="annot"><span class="annottext">PatT (VarWisdom, LetDecMem)
Pat (Wise rep)
</span><a href="#local-6989586621684407939"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-216"></span><span>    </span><span class="annot"><span class="annottext">MemOp (OpWithWisdom inner) -&gt; Bool
forall op. IsOp op =&gt; op -&gt; Bool
</span><a href="Futhark.IR.Prop.html#safeOp"><span class="hs-identifier hs-var">safeOp</span></a></span><span> </span><span class="annot"><span class="annottext">Op (Wise rep)
MemOp (OpWithWisdom inner)
</span><a href="#local-6989586621684407935"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-217"></span><span>    </span><span class="annot"><span class="annottext">RuleM (Wise rep) () -&gt; Rule (Wise rep)
forall rep. RuleM rep () -&gt; Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Simplify"><span class="hs-identifier hs-var">Simplify</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM (Wise rep) () -&gt; Rule (Wise rep))
-&gt; RuleM (Wise rep) () -&gt; Rule (Wise rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Attrs -&gt; RuleM (Wise rep) () -&gt; RuleM (Wise rep) ()
forall (m :: * -&gt; *) a. MonadBuilder m =&gt; Attrs -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#attributing"><span class="hs-identifier hs-var">attributing</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684407936"><span class="hs-identifier hs-var">attrs</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM (Wise rep) () -&gt; RuleM (Wise rep) ())
-&gt; RuleM (Wise rep) () -&gt; RuleM (Wise rep) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat (Rep (RuleM (Wise rep)))
-&gt; Exp (Rep (RuleM (Wise rep))) -&gt; RuleM (Wise rep) ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">Pat (Rep (RuleM (Wise rep)))
Pat (Wise rep)
</span><a href="#local-6989586621684407939"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM (Wise rep))) -&gt; RuleM (Wise rep) ())
-&gt; Exp (Rep (RuleM (Wise rep))) -&gt; RuleM (Wise rep) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Op (Wise rep) -&gt; ExpT (Wise rep)
forall rep. Op rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-var">Op</span></a></span><span> </span><span class="annot"><span class="annottext">Op (Wise rep)
</span><a href="#local-6989586621684407935"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-218"></span><span class="annot"><a href="Futhark.IR.Mem.Simplify.html#decertifySafeAlloc"><span class="hs-identifier hs-var">decertifySafeAlloc</span></a></span><span> </span><span class="annot"><span class="annottext">TopDown (Wise rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Pat (Wise rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec (Wise rep))
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Op (Wise rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Rule (Wise rep)
forall rep. Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span>
</span><span id="line-219"></span></pre></body></html>