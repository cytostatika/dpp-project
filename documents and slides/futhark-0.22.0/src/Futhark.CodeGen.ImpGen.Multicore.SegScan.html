<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Futhark.CodeGen.ImpGen.Multicore.SegScan</span><span>
</span><span id="line-2"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegScan.html#compileSegScan"><span class="hs-identifier">compileSegScan</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-3"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-4"></span><span class="hs-keyword">where</span><span>
</span><span id="line-5"></span><span>
</span><span id="line-6"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span>
</span><span id="line-7"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">zip4</span></span><span class="hs-special">)</span><span>
</span><span id="line-8"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.Multicore.html"><span class="hs-identifier">Futhark.CodeGen.ImpCode.Multicore</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Imp</span></span><span>
</span><span id="line-9"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html"><span class="hs-identifier">Futhark.CodeGen.ImpGen</span></a></span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html"><span class="hs-identifier">Futhark.CodeGen.ImpGen.Multicore.Base</span></a></span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html"><span class="hs-identifier">Futhark.IR.MCMem</span></a></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Util.IntegralExp.html"><span class="hs-identifier">Futhark.Util.IntegralExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Util.IntegralExp.html#quot"><span class="hs-identifier">quot</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Util.IntegralExp.html#rem"><span class="hs-identifier">rem</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Prelude</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">quot</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">rem</span></span><span class="hs-special">)</span><span>
</span><span id="line-14"></span><span>
</span><span id="line-15"></span><span class="hs-comment">-- Compile a SegScan construct</span><span>
</span><span id="line-16"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegScan.html#compileSegScan"><span class="hs-identifier hs-type">compileSegScan</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-17"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-18"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegSpace"><span class="hs-identifier hs-type">SegSpace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-19"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.SegOp.html#SegBinOp"><span class="hs-identifier hs-type">SegBinOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-20"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-type">KernelBody</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-21"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#TV"><span class="hs-identifier hs-type">TV</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-22"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#MulticoreGen"><span class="hs-identifier hs-type">MulticoreGen</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.Multicore.html#Code"><span class="hs-identifier hs-type">Imp.Code</span></a></span><span>
</span><span id="line-23"></span><span id="compileSegScan"><span class="annot"><span class="annottext">compileSegScan :: Pat MCMem
-&gt; SegSpace
-&gt; [SegBinOp MCMem]
-&gt; KernelBody MCMem
-&gt; TV Int32
-&gt; MulticoreGen Code
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegScan.html#compileSegScan"><span class="hs-identifier hs-var hs-var">compileSegScan</span></a></span></span><span> </span><span id="local-6989586621684532256"><span class="annot"><span class="annottext">Pat MCMem
</span><a href="#local-6989586621684532256"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684532255"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684532255"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684532254"><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532254"><span class="hs-identifier hs-var">reds</span></a></span></span><span> </span><span id="local-6989586621684532253"><span class="annot"><span class="annottext">KernelBody MCMem
</span><a href="#local-6989586621684532253"><span class="hs-identifier hs-var">kbody</span></a></span></span><span> </span><span id="local-6989586621684532252"><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684532252"><span class="hs-identifier hs-var">nsubtasks</span></a></span></span><span>
</span><span id="line-24"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">(VName, SubExp)
</span><span class="hs-identifier">_</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; [(VName, SubExp)]
</span><a href="Futhark.IR.SegOp.html#unSegSpace"><span class="hs-identifier hs-var hs-var">unSegSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684532255"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-25"></span><span>    </span><span class="annot"><span class="annottext">Pat MCMem
-&gt; SegSpace
-&gt; [SegBinOp MCMem]
-&gt; KernelBody MCMem
-&gt; TV Int32
-&gt; MulticoreGen Code
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegScan.html#nonsegmentedScan"><span class="hs-identifier hs-var">nonsegmentedScan</span></a></span><span> </span><span class="annot"><span class="annottext">Pat MCMem
</span><a href="#local-6989586621684532256"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684532255"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532254"><span class="hs-identifier hs-var">reds</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody MCMem
</span><a href="#local-6989586621684532253"><span class="hs-identifier hs-var">kbody</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684532252"><span class="hs-identifier hs-var">nsubtasks</span></a></span><span>
</span><span id="line-26"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-27"></span><span>    </span><span class="annot"><span class="annottext">Pat MCMem
-&gt; SegSpace
-&gt; [SegBinOp MCMem]
-&gt; KernelBody MCMem
-&gt; MulticoreGen Code
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegScan.html#segmentedScan"><span class="hs-identifier hs-var">segmentedScan</span></a></span><span> </span><span class="annot"><span class="annottext">Pat MCMem
</span><a href="#local-6989586621684532256"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684532255"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532254"><span class="hs-identifier hs-var">reds</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody MCMem
</span><a href="#local-6989586621684532253"><span class="hs-identifier hs-var">kbody</span></a></span><span>
</span><span id="line-28"></span><span>
</span><span id="line-29"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegScan.html#xParams"><span class="hs-identifier hs-type">xParams</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegScan.html#yParams"><span class="hs-identifier hs-type">yParams</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegBinOp"><span class="hs-identifier hs-type">SegBinOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#LParam"><span class="hs-identifier hs-type">LParam</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-30"></span><span id="xParams"><span class="annot"><span class="annottext">xParams :: SegBinOp MCMem -&gt; [LParam MCMem]
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegScan.html#xParams"><span class="hs-identifier hs-var hs-var">xParams</span></a></span></span><span> </span><span id="local-6989586621684532246"><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684532246"><span class="hs-identifier hs-var">scan</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-31"></span><span>  </span><span class="annot"><span class="annottext">Int -&gt; [Param LParamMem] -&gt; [Param LParamMem]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">take</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; [SubExp]
forall rep. SegBinOp rep -&gt; [SubExp]
</span><a href="Futhark.IR.SegOp.html#segBinOpNeutral"><span class="hs-identifier hs-var hs-var">segBinOpNeutral</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684532246"><span class="hs-identifier hs-var">scan</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LambdaT MCMem -&gt; [LParam MCMem]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; LambdaT MCMem
forall rep. SegBinOp rep -&gt; Lambda rep
</span><a href="Futhark.IR.SegOp.html#segBinOpLambda"><span class="hs-identifier hs-var hs-var">segBinOpLambda</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684532246"><span class="hs-identifier hs-var">scan</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span id="yParams"><span class="annot"><span class="annottext">yParams :: SegBinOp MCMem -&gt; [LParam MCMem]
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegScan.html#yParams"><span class="hs-identifier hs-var hs-var">yParams</span></a></span></span><span> </span><span id="local-6989586621684532240"><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684532240"><span class="hs-identifier hs-var">scan</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-33"></span><span>  </span><span class="annot"><span class="annottext">Int -&gt; [Param LParamMem] -&gt; [Param LParamMem]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; [SubExp]
forall rep. SegBinOp rep -&gt; [SubExp]
</span><a href="Futhark.IR.SegOp.html#segBinOpNeutral"><span class="hs-identifier hs-var hs-var">segBinOpNeutral</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684532240"><span class="hs-identifier hs-var">scan</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LambdaT MCMem -&gt; [LParam MCMem]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; LambdaT MCMem
forall rep. SegBinOp rep -&gt; Lambda rep
</span><a href="Futhark.IR.SegOp.html#segBinOpLambda"><span class="hs-identifier hs-var hs-var">segBinOpLambda</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684532240"><span class="hs-identifier hs-var">scan</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-34"></span><span>
</span><span id="line-35"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegScan.html#lamBody"><span class="hs-identifier hs-type">lamBody</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegBinOp"><span class="hs-identifier hs-type">SegBinOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span>
</span><span id="line-36"></span><span id="lamBody"><span class="annot"><span class="annottext">lamBody :: SegBinOp MCMem -&gt; Body MCMem
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegScan.html#lamBody"><span class="hs-identifier hs-var hs-var">lamBody</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LambdaT MCMem -&gt; Body MCMem
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">(LambdaT MCMem -&gt; Body MCMem)
-&gt; (SegBinOp MCMem -&gt; LambdaT MCMem)
-&gt; SegBinOp MCMem
-&gt; Body MCMem
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; LambdaT MCMem
forall rep. SegBinOp rep -&gt; Lambda rep
</span><a href="Futhark.IR.SegOp.html#segBinOpLambda"><span class="hs-identifier hs-var hs-var">segBinOpLambda</span></a></span><span>
</span><span id="line-37"></span><span>
</span><span id="line-38"></span><span class="hs-comment">-- Arrays for storing worker results.</span><span>
</span><span id="line-39"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegScan.html#resultArrays"><span class="hs-identifier hs-type">resultArrays</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.SegOp.html#SegBinOp"><span class="hs-identifier hs-type">SegBinOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#MulticoreGen"><span class="hs-identifier hs-type">MulticoreGen</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><span id="line-40"></span><span id="resultArrays"><span class="annot"><span class="annottext">resultArrays :: String -&gt; [SegBinOp MCMem] -&gt; MulticoreGen [[VName]]
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegScan.html#resultArrays"><span class="hs-identifier hs-var hs-var">resultArrays</span></a></span></span><span> </span><span id="local-6989586621684532234"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621684532234"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621684532233"><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532233"><span class="hs-identifier hs-var">segops</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-41"></span><span>  </span><span class="annot"><span class="annottext">[SegBinOp MCMem]
-&gt; (SegBinOp MCMem -&gt; ImpM MCMem HostEnv Multicore [VName])
-&gt; MulticoreGen [[VName]]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532233"><span class="hs-identifier hs-var">segops</span></a></span><span> </span><span class="annot"><span class="annottext">((SegBinOp MCMem -&gt; ImpM MCMem HostEnv Multicore [VName])
 -&gt; MulticoreGen [[VName]])
-&gt; (SegBinOp MCMem -&gt; ImpM MCMem HostEnv Multicore [VName])
-&gt; MulticoreGen [[VName]]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#SegBinOp"><span class="hs-identifier hs-type">SegBinOp</span></a></span><span> </span><span class="annot"><span class="annottext">Commutativity
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684532230"><span class="annot"><span class="annottext">LambdaT MCMem
</span><a href="#local-6989586621684532230"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684532229"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684532229"><span class="hs-identifier hs-var">shape</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-42"></span><span>    </span><span class="annot"><span class="annottext">[Type]
-&gt; (Type -&gt; ImpM MCMem HostEnv Multicore VName)
-&gt; ImpM MCMem HostEnv Multicore [VName]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LambdaT MCMem -&gt; [Type]
forall rep. LambdaT rep -&gt; [Type]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT MCMem
</span><a href="#local-6989586621684532230"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Type -&gt; ImpM MCMem HostEnv Multicore VName)
 -&gt; ImpM MCMem HostEnv Multicore [VName])
-&gt; (Type -&gt; ImpM MCMem HostEnv Multicore VName)
-&gt; ImpM MCMem HostEnv Multicore [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684532227"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684532227"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-43"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684532226"><span class="annot"><span class="annottext">pt :: PrimType
</span><a href="#local-6989586621684532226"><span class="hs-identifier hs-var hs-var">pt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; PrimType
forall shape u. TypeBase shape u -&gt; PrimType
</span><a href="Futhark.IR.Prop.Types.html#elemType"><span class="hs-identifier hs-var">elemType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684532227"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-44"></span><span>          </span><span id="local-6989586621684532222"><span class="annot"><span class="annottext">full_shape :: Shape
</span><a href="#local-6989586621684532222"><span class="hs-identifier hs-var hs-var">full_shape</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684532229"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">Shape -&gt; Shape -&gt; Shape
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Shape
forall shape u. ArrayShape shape =&gt; TypeBase shape u -&gt; shape
</span><a href="Futhark.IR.Prop.Types.html#arrayShape"><span class="hs-identifier hs-var">arrayShape</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684532227"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-45"></span><span>      </span><span class="annot"><span class="annottext">String
-&gt; PrimType -&gt; Shape -&gt; Space -&gt; ImpM MCMem HostEnv Multicore VName
forall rep r op.
String -&gt; PrimType -&gt; Shape -&gt; Space -&gt; ImpM rep r op VName
</span><a href="Futhark.CodeGen.ImpGen.html#sAllocArray"><span class="hs-identifier hs-var">sAllocArray</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621684532234"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684532226"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684532222"><span class="hs-identifier hs-var">full_shape</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="Futhark.IR.Syntax.Core.html#DefaultSpace"><span class="hs-identifier hs-var">DefaultSpace</span></a></span><span>
</span><span id="line-46"></span><span>
</span><span id="line-47"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegScan.html#nonsegmentedScan"><span class="hs-identifier hs-type">nonsegmentedScan</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-48"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-49"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegSpace"><span class="hs-identifier hs-type">SegSpace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-50"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.SegOp.html#SegBinOp"><span class="hs-identifier hs-type">SegBinOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-51"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-type">KernelBody</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-52"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#TV"><span class="hs-identifier hs-type">TV</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-53"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#MulticoreGen"><span class="hs-identifier hs-type">MulticoreGen</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.Multicore.html#Code"><span class="hs-identifier hs-type">Imp.Code</span></a></span><span>
</span><span id="line-54"></span><span id="nonsegmentedScan"><span class="annot"><span class="annottext">nonsegmentedScan :: Pat MCMem
-&gt; SegSpace
-&gt; [SegBinOp MCMem]
-&gt; KernelBody MCMem
-&gt; TV Int32
-&gt; MulticoreGen Code
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegScan.html#nonsegmentedScan"><span class="hs-identifier hs-var hs-var">nonsegmentedScan</span></a></span></span><span> </span><span id="local-6989586621684532218"><span class="annot"><span class="annottext">Pat MCMem
</span><a href="#local-6989586621684532218"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684532217"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684532217"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684532216"><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532216"><span class="hs-identifier hs-var">scan_ops</span></a></span></span><span> </span><span id="local-6989586621684532215"><span class="annot"><span class="annottext">KernelBody MCMem
</span><a href="#local-6989586621684532215"><span class="hs-identifier hs-var">kbody</span></a></span></span><span> </span><span id="local-6989586621684532214"><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684532214"><span class="hs-identifier hs-var">nsubtasks</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-55"></span><span>  </span><span class="annot"><span class="annottext">Code -&gt; ImpM MCMem HostEnv Multicore ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; Code -&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe Exp -&gt; Code
forall a. String -&gt; Maybe Exp -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#DebugPrint"><span class="hs-identifier hs-var">Imp.DebugPrint</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;nonsegmented segScan&quot;</span></span><span> </span><span class="annot"><span class="annottext">Maybe Exp
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-56"></span><span>  </span><span class="annot"><span class="annottext">ImpM MCMem HostEnv Multicore () -&gt; MulticoreGen Code
forall rep r op. ImpM rep r op () -&gt; ImpM rep r op (Code op)
</span><a href="Futhark.CodeGen.ImpGen.html#collect"><span class="hs-identifier hs-var">collect</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM MCMem HostEnv Multicore () -&gt; MulticoreGen Code)
-&gt; ImpM MCMem HostEnv Multicore () -&gt; MulticoreGen Code
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-57"></span><span>    </span><span class="annot"><span class="annottext">Pat MCMem
-&gt; SegSpace
-&gt; [SegBinOp MCMem]
-&gt; KernelBody MCMem
-&gt; ImpM MCMem HostEnv Multicore ()
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegScan.html#scanStage1"><span class="hs-identifier hs-var">scanStage1</span></a></span><span> </span><span class="annot"><span class="annottext">Pat MCMem
</span><a href="#local-6989586621684532218"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684532217"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532216"><span class="hs-identifier hs-var">scan_ops</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody MCMem
</span><a href="#local-6989586621684532215"><span class="hs-identifier hs-var">kbody</span></a></span><span>
</span><span id="line-58"></span><span>
</span><span id="line-59"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684532209"><span class="annot"><span class="annottext">nsubtasks' :: TExp Int32
</span><a href="#local-6989586621684532209"><span class="hs-identifier hs-var hs-var">nsubtasks'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TV Int32 -&gt; TExp Int32
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684532214"><span class="hs-identifier hs-var">nsubtasks</span></a></span><span>
</span><span id="line-60"></span><span>    </span><span class="annot"><span class="annottext">TExp Bool
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op. TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684532209"><span class="hs-identifier hs-var">nsubtasks'</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Bool
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3E."><span class="hs-operator hs-var">.&gt;.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM MCMem HostEnv Multicore ()
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-61"></span><span>      </span><span id="local-6989586621684532205"><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532205"><span class="hs-identifier hs-var">scan_ops2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem] -&gt; MulticoreGen [SegBinOp MCMem]
</span><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#renameSegBinOp"><span class="hs-identifier hs-var">renameSegBinOp</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532216"><span class="hs-identifier hs-var">scan_ops</span></a></span><span>
</span><span id="line-62"></span><span>      </span><span class="annot"><span class="annottext">Pat MCMem
-&gt; TV Int32
-&gt; SegSpace
-&gt; [SegBinOp MCMem]
-&gt; KernelBody MCMem
-&gt; ImpM MCMem HostEnv Multicore ()
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegScan.html#scanStage2"><span class="hs-identifier hs-var">scanStage2</span></a></span><span> </span><span class="annot"><span class="annottext">Pat MCMem
</span><a href="#local-6989586621684532218"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684532214"><span class="hs-identifier hs-var">nsubtasks</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684532217"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532205"><span class="hs-identifier hs-var">scan_ops2</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody MCMem
</span><a href="#local-6989586621684532215"><span class="hs-identifier hs-var">kbody</span></a></span><span>
</span><span id="line-63"></span><span>      </span><span id="local-6989586621684532202"><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532202"><span class="hs-identifier hs-var">scan_ops3</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem] -&gt; MulticoreGen [SegBinOp MCMem]
</span><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#renameSegBinOp"><span class="hs-identifier hs-var">renameSegBinOp</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532216"><span class="hs-identifier hs-var">scan_ops</span></a></span><span>
</span><span id="line-64"></span><span>      </span><span class="annot"><span class="annottext">Pat MCMem
-&gt; SegSpace
-&gt; [SegBinOp MCMem]
-&gt; KernelBody MCMem
-&gt; ImpM MCMem HostEnv Multicore ()
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegScan.html#scanStage3"><span class="hs-identifier hs-var">scanStage3</span></a></span><span> </span><span class="annot"><span class="annottext">Pat MCMem
</span><a href="#local-6989586621684532218"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684532217"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532202"><span class="hs-identifier hs-var">scan_ops3</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody MCMem
</span><a href="#local-6989586621684532215"><span class="hs-identifier hs-var">kbody</span></a></span><span>
</span><span id="line-65"></span><span>
</span><span id="line-66"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegScan.html#scanStage1"><span class="hs-identifier hs-type">scanStage1</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-67"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-68"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegSpace"><span class="hs-identifier hs-type">SegSpace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-69"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.SegOp.html#SegBinOp"><span class="hs-identifier hs-type">SegBinOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-70"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-type">KernelBody</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-71"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#MulticoreGen"><span class="hs-identifier hs-type">MulticoreGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-72"></span><span id="scanStage1"><span class="annot"><span class="annottext">scanStage1 :: Pat MCMem
-&gt; SegSpace
-&gt; [SegBinOp MCMem]
-&gt; KernelBody MCMem
-&gt; ImpM MCMem HostEnv Multicore ()
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegScan.html#scanStage1"><span class="hs-identifier hs-var hs-var">scanStage1</span></a></span></span><span> </span><span id="local-6989586621684532200"><span class="annot"><span class="annottext">Pat MCMem
</span><a href="#local-6989586621684532200"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684532199"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684532199"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684532198"><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532198"><span class="hs-identifier hs-var">scan_ops</span></a></span></span><span> </span><span id="local-6989586621684532197"><span class="annot"><span class="annottext">KernelBody MCMem
</span><a href="#local-6989586621684532197"><span class="hs-identifier hs-var">kbody</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-73"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684532196"><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684532196"><span class="hs-identifier hs-var">all_scan_res</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532195"><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684532195"><span class="hs-identifier hs-var">map_res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [KernelResult] -&gt; ([KernelResult], [KernelResult])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SegBinOp MCMem] -&gt; Int
forall rep. [SegBinOp rep] -&gt; Int
</span><a href="Futhark.IR.SegOp.html#segBinOpResults"><span class="hs-identifier hs-var">segBinOpResults</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532198"><span class="hs-identifier hs-var">scan_ops</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([KernelResult] -&gt; ([KernelResult], [KernelResult]))
-&gt; [KernelResult] -&gt; ([KernelResult], [KernelResult])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KernelBody MCMem -&gt; [KernelResult]
forall rep. KernelBody rep -&gt; [KernelResult]
</span><a href="Futhark.IR.SegOp.html#kernelBodyResult"><span class="hs-identifier hs-var hs-var">kernelBodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody MCMem
</span><a href="#local-6989586621684532197"><span class="hs-identifier hs-var">kbody</span></a></span><span>
</span><span id="line-74"></span><span>      </span><span id="local-6989586621684532191"><span class="annot"><span class="annottext">per_scan_res :: [[KernelResult]]
</span><a href="#local-6989586621684532191"><span class="hs-identifier hs-var hs-var">per_scan_res</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem] -&gt; [KernelResult] -&gt; [[KernelResult]]
forall rep a. [SegBinOp rep] -&gt; [a] -&gt; [[a]]
</span><a href="Futhark.IR.SegOp.html#segBinOpChunks"><span class="hs-identifier hs-var">segBinOpChunks</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532198"><span class="hs-identifier hs-var">scan_ops</span></a></span><span> </span><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684532196"><span class="hs-identifier hs-var">all_scan_res</span></a></span><span>
</span><span id="line-75"></span><span>      </span><span id="local-6989586621684532189"><span class="annot"><span class="annottext">per_scan_pes :: [[PatElemT LParamMem]]
</span><a href="#local-6989586621684532189"><span class="hs-identifier hs-var hs-var">per_scan_pes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem] -&gt; [PatElemT LParamMem] -&gt; [[PatElemT LParamMem]]
forall rep a. [SegBinOp rep] -&gt; [a] -&gt; [[a]]
</span><a href="Futhark.IR.SegOp.html#segBinOpChunks"><span class="hs-identifier hs-var">segBinOpChunks</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532198"><span class="hs-identifier hs-var">scan_ops</span></a></span><span> </span><span class="annot"><span class="annottext">([PatElemT LParamMem] -&gt; [[PatElemT LParamMem]])
-&gt; [PatElemT LParamMem] -&gt; [[PatElemT LParamMem]]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatT LParamMem -&gt; [PatElemT LParamMem]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span> </span><span class="annot"><span class="annottext">Pat MCMem
PatT LParamMem
</span><a href="#local-6989586621684532200"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-76"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684532187"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684532187"><span class="hs-identifier hs-var">is</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532186"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684532186"><span class="hs-identifier hs-var">ns</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VName, SubExp)] -&gt; ([VName], [SubExp])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(VName, SubExp)] -&gt; ([VName], [SubExp]))
-&gt; [(VName, SubExp)] -&gt; ([VName], [SubExp])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; [(VName, SubExp)]
</span><a href="Futhark.IR.SegOp.html#unSegSpace"><span class="hs-identifier hs-var hs-var">unSegSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684532199"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-77"></span><span>      </span><span id="local-6989586621684532182"><span class="annot"><span class="annottext">ns' :: [TExp Int64]
</span><a href="#local-6989586621684532182"><span class="hs-identifier hs-var hs-var">ns'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684532186"><span class="hs-identifier hs-var">ns</span></a></span><span>
</span><span id="line-78"></span><span>  </span><span id="local-6989586621684532180"><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684532180"><span class="hs-identifier hs-var">iter</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; PrimType -&gt; ImpM MCMem HostEnv Multicore (TV Int64)
forall rep r op t. String -&gt; PrimType -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrim"><span class="hs-identifier hs-var">dPrim</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;iter&quot;</span></span><span> </span><span class="annot"><span class="annottext">(PrimType -&gt; ImpM MCMem HostEnv Multicore (TV Int64))
-&gt; PrimType -&gt; ImpM MCMem HostEnv Multicore (TV Int64)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IntType -&gt; PrimType
</span><a href="Futhark.IR.Primitive.html#IntType"><span class="hs-identifier hs-var">IntType</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span>
</span><span id="line-79"></span><span>
</span><span id="line-80"></span><span>  </span><span class="hs-comment">-- Stage 1 : each thread partially scans a chunk of the input</span><span>
</span><span id="line-81"></span><span>  </span><span class="hs-comment">-- Writes directly to the resulting array</span><span>
</span><span id="line-82"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684532176"><span class="annot"><span class="annottext">[[VName]]
</span><a href="#local-6989586621684532176"><span class="hs-identifier hs-var">local_accs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532175"><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684532175"><span class="hs-identifier hs-var">prebody</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MulticoreGen [[VName]]
-&gt; ImpM MCMem HostEnv Multicore ([[VName]], Code)
forall rep r op a. ImpM rep r op a -&gt; ImpM rep r op (a, Code op)
</span><a href="Futhark.CodeGen.ImpGen.html#collect%27"><span class="hs-identifier hs-var">collect'</span></a></span><span> </span><span class="annot"><span class="annottext">(MulticoreGen [[VName]]
 -&gt; ImpM MCMem HostEnv Multicore ([[VName]], Code))
-&gt; MulticoreGen [[VName]]
-&gt; ImpM MCMem HostEnv Multicore ([[VName]], Code)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-83"></span><span>    </span><span class="annot"><span class="annottext">Maybe (Exp MCMem) -&gt; Scope MCMem -&gt; ImpM MCMem HostEnv Multicore ()
forall rep inner r op.
Mem rep inner =&gt;
Maybe (Exp rep) -&gt; Scope rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dScope"><span class="hs-identifier hs-var">dScope</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp MCMem)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">(Scope MCMem -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; Scope MCMem -&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem] -&gt; Scope MCMem
forall rep dec. (LParamInfo rep ~ dec) =&gt; [Param dec] -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOfLParams"><span class="hs-identifier hs-var">scopeOfLParams</span></a></span><span> </span><span class="annot"><span class="annottext">([Param LParamMem] -&gt; Scope MCMem)
-&gt; [Param LParamMem] -&gt; Scope MCMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SegBinOp MCMem -&gt; [Param LParamMem])
-&gt; [SegBinOp MCMem] -&gt; [Param LParamMem]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LambdaT MCMem -&gt; [Param LParamMem]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">(LambdaT MCMem -&gt; [Param LParamMem])
-&gt; (SegBinOp MCMem -&gt; LambdaT MCMem)
-&gt; SegBinOp MCMem
-&gt; [Param LParamMem]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; LambdaT MCMem
forall rep. SegBinOp rep -&gt; Lambda rep
</span><a href="Futhark.IR.SegOp.html#segBinOpLambda"><span class="hs-identifier hs-var hs-var">segBinOpLambda</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532198"><span class="hs-identifier hs-var">scan_ops</span></a></span><span>
</span><span id="line-84"></span><span>    </span><span class="annot"><span class="annottext">[SegBinOp MCMem]
-&gt; (SegBinOp MCMem -&gt; ImpM MCMem HostEnv Multicore [VName])
-&gt; MulticoreGen [[VName]]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532198"><span class="hs-identifier hs-var">scan_ops</span></a></span><span> </span><span class="annot"><span class="annottext">((SegBinOp MCMem -&gt; ImpM MCMem HostEnv Multicore [VName])
 -&gt; MulticoreGen [[VName]])
-&gt; (SegBinOp MCMem -&gt; ImpM MCMem HostEnv Multicore [VName])
-&gt; MulticoreGen [[VName]]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684532170"><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684532170"><span class="hs-identifier hs-var">scan_op</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-85"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684532169"><span class="annot"><span class="annottext">shape :: Shape
</span><a href="#local-6989586621684532169"><span class="hs-identifier hs-var hs-var">shape</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; Shape
forall rep. SegBinOp rep -&gt; Shape
</span><a href="Futhark.IR.SegOp.html#segBinOpShape"><span class="hs-identifier hs-var hs-var">segBinOpShape</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684532170"><span class="hs-identifier hs-var">scan_op</span></a></span><span>
</span><span id="line-86"></span><span>          </span><span id="local-6989586621684532167"><span class="annot"><span class="annottext">ts :: [Type]
</span><a href="#local-6989586621684532167"><span class="hs-identifier hs-var hs-var">ts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LambdaT MCMem -&gt; [Type]
forall rep. LambdaT rep -&gt; [Type]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">(LambdaT MCMem -&gt; [Type]) -&gt; LambdaT MCMem -&gt; [Type]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; LambdaT MCMem
forall rep. SegBinOp rep -&gt; Lambda rep
</span><a href="Futhark.IR.SegOp.html#segBinOpLambda"><span class="hs-identifier hs-var hs-var">segBinOpLambda</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684532170"><span class="hs-identifier hs-var">scan_op</span></a></span><span>
</span><span id="line-87"></span><span>      </span><span class="annot"><span class="annottext">[(Param LParamMem, SubExp, Type)]
-&gt; ((Param LParamMem, SubExp, Type)
    -&gt; ImpM MCMem HostEnv Multicore VName)
-&gt; ImpM MCMem HostEnv Multicore [VName]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param LParamMem]
-&gt; [SubExp] -&gt; [Type] -&gt; [(Param LParamMem, SubExp, Type)]
forall a b c. [a] -&gt; [b] -&gt; [c] -&gt; [(a, b, c)]
</span><span class="hs-identifier hs-var">zip3</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; [LParam MCMem]
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegScan.html#xParams"><span class="hs-identifier hs-var">xParams</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684532170"><span class="hs-identifier hs-var">scan_op</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; [SubExp]
forall rep. SegBinOp rep -&gt; [SubExp]
</span><a href="Futhark.IR.SegOp.html#segBinOpNeutral"><span class="hs-identifier hs-var hs-var">segBinOpNeutral</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684532170"><span class="hs-identifier hs-var">scan_op</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684532167"><span class="hs-identifier hs-var">ts</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Param LParamMem, SubExp, Type)
  -&gt; ImpM MCMem HostEnv Multicore VName)
 -&gt; ImpM MCMem HostEnv Multicore [VName])
-&gt; ((Param LParamMem, SubExp, Type)
    -&gt; ImpM MCMem HostEnv Multicore VName)
-&gt; ImpM MCMem HostEnv Multicore [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684532165"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684532165"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532164"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684532164"><span class="hs-identifier hs-var">ne</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532163"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684532163"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-88"></span><span>        </span><span id="local-6989586621684532162"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684532162"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-89"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Shape -&gt; [SubExp]
forall d. ShapeBase d -&gt; [d]
</span><a href="Futhark.IR.Syntax.Core.html#shapeDims"><span class="hs-identifier hs-var hs-var">shapeDims</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684532169"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-90"></span><span>            </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">VName -&gt; ImpM MCMem HostEnv Multicore VName
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; ImpM MCMem HostEnv Multicore VName)
-&gt; VName -&gt; ImpM MCMem HostEnv Multicore VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684532165"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-91"></span><span>            </span><span class="annot"><span class="annottext">[SubExp]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-92"></span><span>              </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684532159"><span class="annot"><span class="annottext">pt :: PrimType
</span><a href="#local-6989586621684532159"><span class="hs-identifier hs-var hs-var">pt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; PrimType
forall shape u. TypeBase shape u -&gt; PrimType
</span><a href="Futhark.IR.Prop.Types.html#elemType"><span class="hs-identifier hs-var">elemType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684532163"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-93"></span><span>              </span><span class="annot"><span class="annottext">String
-&gt; PrimType -&gt; Shape -&gt; Space -&gt; ImpM MCMem HostEnv Multicore VName
forall rep r op.
String -&gt; PrimType -&gt; Shape -&gt; Space -&gt; ImpM rep r op VName
</span><a href="Futhark.CodeGen.ImpGen.html#sAllocArray"><span class="hs-identifier hs-var">sAllocArray</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;local_acc&quot;</span></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684532159"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684532169"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">Shape -&gt; Shape -&gt; Shape
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Shape
forall shape u. ArrayShape shape =&gt; TypeBase shape u -&gt; shape
</span><a href="Futhark.IR.Prop.Types.html#arrayShape"><span class="hs-identifier hs-var">arrayShape</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684532163"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="Futhark.IR.Syntax.Core.html#DefaultSpace"><span class="hs-identifier hs-var">DefaultSpace</span></a></span><span>
</span><span id="line-94"></span><span>
</span><span id="line-95"></span><span>        </span><span class="hs-comment">-- Now neutral-initialise the accumulator.</span><span>
</span><span id="line-96"></span><span>        </span><span class="annot"><span class="annottext">Shape
-&gt; ([TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
Shape -&gt; ([TExp Int64] -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sLoopNest"><span class="hs-identifier hs-var">sLoopNest</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; Shape
forall rep. SegBinOp rep -&gt; Shape
</span><a href="Futhark.IR.SegOp.html#segBinOpShape"><span class="hs-identifier hs-var hs-var">segBinOpShape</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684532170"><span class="hs-identifier hs-var">scan_op</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(([TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ())
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ([TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684532157"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684532157"><span class="hs-identifier hs-var">vec_is</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-97"></span><span>          </span><span class="annot"><span class="annottext">VName
-&gt; [TExp Int64]
-&gt; SubExp
-&gt; [TExp Int64]
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684532162"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684532157"><span class="hs-identifier hs-var">vec_is</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684532164"><span class="hs-identifier hs-var">ne</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-98"></span><span>
</span><span id="line-99"></span><span>        </span><span class="annot"><span class="annottext">VName -&gt; ImpM MCMem HostEnv Multicore VName
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684532162"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-100"></span><span>
</span><span id="line-101"></span><span>  </span><span id="local-6989586621684532155"><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684532155"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ImpM MCMem HostEnv Multicore () -&gt; MulticoreGen Code
forall rep r op. ImpM rep r op () -&gt; ImpM rep r op (Code op)
</span><a href="Futhark.CodeGen.ImpGen.html#collect"><span class="hs-identifier hs-var">collect</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM MCMem HostEnv Multicore () -&gt; MulticoreGen Code)
-&gt; ImpM MCMem HostEnv Multicore () -&gt; MulticoreGen Code
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-102"></span><span>    </span><span class="annot"><span class="annottext">(VName -&gt; TExp Int64 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; [VName] -&gt; [TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ()
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m ()
</span><span class="hs-identifier hs-var">zipWithM_</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TExp Int64 -&gt; ImpM MCMem HostEnv Multicore ()
forall t rep r op. VName -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV_"><span class="hs-identifier hs-var">dPrimV_</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684532187"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">([TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; [TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; TExp Int64 -&gt; [TExp Int64]
forall num. IntegralExp num =&gt; [num] -&gt; num -&gt; [num]
</span><a href="Futhark.IR.Prop.Reshape.html#unflattenIndex"><span class="hs-identifier hs-var">unflattenIndex</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684532182"><span class="hs-identifier hs-var">ns'</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; [TExp Int64]) -&gt; TExp Int64 -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TV Int64 -&gt; TExp Int64
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684532180"><span class="hs-identifier hs-var">iter</span></a></span><span>
</span><span id="line-103"></span><span>    </span><span class="annot"><span class="annottext">String
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;stage 1 scan body&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ImpM MCMem HostEnv Multicore ()
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-104"></span><span>      </span><span class="annot"><span class="annottext">Names
-&gt; Stms MCMem
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
Names -&gt; Stms rep -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileStms"><span class="hs-identifier hs-var">compileStms</span></a></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelBody MCMem -&gt; Stms MCMem
forall rep. KernelBody rep -&gt; Stms rep
</span><a href="Futhark.IR.SegOp.html#kernelBodyStms"><span class="hs-identifier hs-var hs-var">kernelBodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody MCMem
</span><a href="#local-6989586621684532197"><span class="hs-identifier hs-var">kbody</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM MCMem HostEnv Multicore ()
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-105"></span><span>        </span><span class="annot"><span class="annottext">String
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;write mapped values results to memory&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ImpM MCMem HostEnv Multicore ()
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-106"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684532148"><span class="annot"><span class="annottext">map_arrs :: [PatElemT LParamMem]
</span><a href="#local-6989586621684532148"><span class="hs-identifier hs-var hs-var">map_arrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [PatElemT LParamMem] -&gt; [PatElemT LParamMem]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SegBinOp MCMem] -&gt; Int
forall rep. [SegBinOp rep] -&gt; Int
</span><a href="Futhark.IR.SegOp.html#segBinOpResults"><span class="hs-identifier hs-var">segBinOpResults</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532198"><span class="hs-identifier hs-var">scan_ops</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([PatElemT LParamMem] -&gt; [PatElemT LParamMem])
-&gt; [PatElemT LParamMem] -&gt; [PatElemT LParamMem]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatT LParamMem -&gt; [PatElemT LParamMem]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span> </span><span class="annot"><span class="annottext">Pat MCMem
PatT LParamMem
</span><a href="#local-6989586621684532200"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-107"></span><span>          </span><span class="annot"><span class="annottext">(PatElemT LParamMem
 -&gt; KernelResult -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; [PatElemT LParamMem]
-&gt; [KernelResult]
-&gt; ImpM MCMem HostEnv Multicore ()
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m ()
</span><span class="hs-identifier hs-var">zipWithM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegSpace
-&gt; PatElem MCMem -&gt; KernelResult -&gt; ImpM MCMem HostEnv Multicore ()
</span><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#compileThreadResult"><span class="hs-identifier hs-var">compileThreadResult</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684532199"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684532148"><span class="hs-identifier hs-var">map_arrs</span></a></span><span> </span><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684532195"><span class="hs-identifier hs-var">map_res</span></a></span><span>
</span><span id="line-108"></span><span>
</span><span id="line-109"></span><span>        </span><span class="annot"><span class="annottext">[([PatElemT LParamMem], SegBinOp MCMem, [KernelResult], [VName])]
-&gt; (([PatElemT LParamMem], SegBinOp MCMem, [KernelResult], [VName])
    -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[[PatElemT LParamMem]]
-&gt; [SegBinOp MCMem]
-&gt; [[KernelResult]]
-&gt; [[VName]]
-&gt; [([PatElemT LParamMem], SegBinOp MCMem, [KernelResult],
     [VName])]
forall a b c d. [a] -&gt; [b] -&gt; [c] -&gt; [d] -&gt; [(a, b, c, d)]
</span><span class="hs-identifier hs-var">zip4</span></span><span> </span><span class="annot"><span class="annottext">[[PatElemT LParamMem]]
</span><a href="#local-6989586621684532189"><span class="hs-identifier hs-var">per_scan_pes</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532198"><span class="hs-identifier hs-var">scan_ops</span></a></span><span> </span><span class="annot"><span class="annottext">[[KernelResult]]
</span><a href="#local-6989586621684532191"><span class="hs-identifier hs-var">per_scan_res</span></a></span><span> </span><span class="annot"><span class="annottext">[[VName]]
</span><a href="#local-6989586621684532176"><span class="hs-identifier hs-var">local_accs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((([PatElemT LParamMem], SegBinOp MCMem, [KernelResult], [VName])
  -&gt; ImpM MCMem HostEnv Multicore ())
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; (([PatElemT LParamMem], SegBinOp MCMem, [KernelResult], [VName])
    -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684532145"><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684532145"><span class="hs-identifier hs-var">pes</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532144"><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684532144"><span class="hs-identifier hs-var">scan_op</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532143"><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684532143"><span class="hs-identifier hs-var">scan_res</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532142"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684532142"><span class="hs-identifier hs-var">acc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-110"></span><span>          </span><span class="annot"><span class="annottext">Shape
-&gt; ([TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
Shape -&gt; ([TExp Int64] -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sLoopNest"><span class="hs-identifier hs-var">sLoopNest</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; Shape
forall rep. SegBinOp rep -&gt; Shape
</span><a href="Futhark.IR.SegOp.html#segBinOpShape"><span class="hs-identifier hs-var hs-var">segBinOpShape</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684532144"><span class="hs-identifier hs-var">scan_op</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(([TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ())
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ([TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684532141"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684532141"><span class="hs-identifier hs-var">vec_is</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-111"></span><span>            </span><span class="hs-comment">-- Read accum value</span><span>
</span><span id="line-112"></span><span>            </span><span class="annot"><span class="annottext">[(Param LParamMem, VName)]
-&gt; ((Param LParamMem, VName) -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param LParamMem] -&gt; [VName] -&gt; [(Param LParamMem, VName)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; [LParam MCMem]
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegScan.html#xParams"><span class="hs-identifier hs-var">xParams</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684532144"><span class="hs-identifier hs-var">scan_op</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684532142"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Param LParamMem, VName) -&gt; ImpM MCMem HostEnv Multicore ())
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ((Param LParamMem, VName) -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684532140"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684532140"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532139"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684532139"><span class="hs-identifier hs-var">acc'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-113"></span><span>              </span><span class="annot"><span class="annottext">VName
-&gt; [TExp Int64]
-&gt; SubExp
-&gt; [TExp Int64]
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684532140"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684532139"><span class="hs-identifier hs-var">acc'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684532141"><span class="hs-identifier hs-var">vec_is</span></a></span><span>
</span><span id="line-114"></span><span>
</span><span id="line-115"></span><span>            </span><span class="hs-comment">-- Read next value</span><span>
</span><span id="line-116"></span><span>            </span><span class="annot"><span class="annottext">String
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Read next values&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ImpM MCMem HostEnv Multicore ()
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-117"></span><span>              </span><span class="annot"><span class="annottext">[(Param LParamMem, KernelResult)]
-&gt; ((Param LParamMem, KernelResult)
    -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param LParamMem]
-&gt; [KernelResult] -&gt; [(Param LParamMem, KernelResult)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; [LParam MCMem]
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegScan.html#yParams"><span class="hs-identifier hs-var">yParams</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684532144"><span class="hs-identifier hs-var">scan_op</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684532143"><span class="hs-identifier hs-var">scan_res</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Param LParamMem, KernelResult)
  -&gt; ImpM MCMem HostEnv Multicore ())
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ((Param LParamMem, KernelResult)
    -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684532137"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684532137"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532136"><span class="annot"><span class="annottext">KernelResult
</span><a href="#local-6989586621684532136"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-118"></span><span>                </span><span class="annot"><span class="annottext">VName
-&gt; [TExp Int64]
-&gt; SubExp
-&gt; [TExp Int64]
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684532137"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelResult -&gt; SubExp
</span><a href="Futhark.IR.SegOp.html#kernelResultSubExp"><span class="hs-identifier hs-var">kernelResultSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">KernelResult
</span><a href="#local-6989586621684532136"><span class="hs-identifier hs-var">se</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684532141"><span class="hs-identifier hs-var">vec_is</span></a></span><span>
</span><span id="line-119"></span><span>
</span><span id="line-120"></span><span>            </span><span class="annot"><span class="annottext">Names
-&gt; Stms MCMem
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
Names -&gt; Stms rep -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileStms"><span class="hs-identifier hs-var">compileStms</span></a></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Body MCMem -&gt; Stms MCMem
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">(Body MCMem -&gt; Stms MCMem) -&gt; Body MCMem -&gt; Stms MCMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; Body MCMem
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegScan.html#lamBody"><span class="hs-identifier hs-var">lamBody</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684532144"><span class="hs-identifier hs-var">scan_op</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM MCMem HostEnv Multicore ()
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-121"></span><span>              </span><span class="annot"><span class="annottext">[(VName, PatElemT LParamMem, SubExp)]
-&gt; ((VName, PatElemT LParamMem, SubExp)
    -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName]
-&gt; [PatElemT LParamMem]
-&gt; [SubExp]
-&gt; [(VName, PatElemT LParamMem, SubExp)]
forall a b c. [a] -&gt; [b] -&gt; [c] -&gt; [(a, b, c)]
</span><span class="hs-identifier hs-var">zip3</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684532142"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684532145"><span class="hs-identifier hs-var">pes</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [(VName, PatElemT LParamMem, SubExp)])
-&gt; [SubExp] -&gt; [(VName, PatElemT LParamMem, SubExp)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExpRes -&gt; SubExp) -&gt; [SubExpRes] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExpRes -&gt; SubExp
</span><a href="Futhark.IR.Syntax.html#resSubExp"><span class="hs-identifier hs-var hs-var">resSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExpRes] -&gt; [SubExp]) -&gt; [SubExpRes] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Body MCMem -&gt; [SubExpRes]
forall rep. BodyT rep -&gt; [SubExpRes]
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var hs-var">bodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">(Body MCMem -&gt; [SubExpRes]) -&gt; Body MCMem -&gt; [SubExpRes]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; Body MCMem
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegScan.html#lamBody"><span class="hs-identifier hs-var">lamBody</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684532144"><span class="hs-identifier hs-var">scan_op</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((VName, PatElemT LParamMem, SubExp)
  -&gt; ImpM MCMem HostEnv Multicore ())
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ((VName, PatElemT LParamMem, SubExp)
    -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-122"></span><span>                </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684532131"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684532131"><span class="hs-identifier hs-var">acc'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532130"><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684532130"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532129"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684532129"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-123"></span><span>                  </span><span class="annot"><span class="annottext">VName
-&gt; [TExp Int64]
-&gt; SubExp
-&gt; [TExp Int64]
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684532130"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(VName -&gt; TExp Int64) -&gt; [VName] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TExp Int64
forall a. a -&gt; TPrimExp Int64 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le64"><span class="hs-identifier hs-var">Imp.le64</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684532187"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; [TExp Int64] -&gt; [TExp Int64]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684532141"><span class="hs-identifier hs-var">vec_is</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684532129"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-124"></span><span>                  </span><span class="annot"><span class="annottext">VName
-&gt; [TExp Int64]
-&gt; SubExp
-&gt; [TExp Int64]
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684532131"><span class="hs-identifier hs-var">acc'</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684532141"><span class="hs-identifier hs-var">vec_is</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684532129"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-125"></span><span>
</span><span id="line-126"></span><span>  </span><span id="local-6989586621684532126"><span class="annot"><span class="annottext">[Param]
</span><a href="#local-6989586621684532126"><span class="hs-identifier hs-var">free_params</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Code -&gt; [VName] -&gt; MulticoreGen [Param]
</span><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#freeParams"><span class="hs-identifier hs-var">freeParams</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684532175"><span class="hs-identifier hs-var">prebody</span></a></span><span> </span><span class="annot"><span class="annottext">Code -&gt; Code -&gt; Code
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684532155"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegSpace -&gt; VName
</span><a href="Futhark.IR.SegOp.html#segFlat"><span class="hs-identifier hs-var hs-var">segFlat</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684532199"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [VName] -&gt; [VName]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TV Int64 -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684532180"><span class="hs-identifier hs-var">iter</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-127"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684532122"><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684532122"><span class="hs-identifier hs-var">body_allocs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532121"><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684532121"><span class="hs-identifier hs-var">body'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Code -&gt; (Code, Code)
</span><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#extractAllocations"><span class="hs-identifier hs-var">extractAllocations</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684532155"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-128"></span><span>  </span><span class="annot"><span class="annottext">Code -&gt; ImpM MCMem HostEnv Multicore ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; Code -&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Multicore -&gt; Code
forall a. a -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#Op"><span class="hs-identifier hs-var">Imp.Op</span></a></span><span> </span><span class="annot"><span class="annottext">(Multicore -&gt; Code) -&gt; Multicore -&gt; Code
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
-&gt; VName -&gt; Code -&gt; Code -&gt; Code -&gt; [Param] -&gt; VName -&gt; Multicore
</span><a href="Futhark.CodeGen.ImpCode.Multicore.html#ParLoop"><span class="hs-identifier hs-var">Imp.ParLoop</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;scan_stage_1&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int64 -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684532180"><span class="hs-identifier hs-var">iter</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684532122"><span class="hs-identifier hs-var">body_allocs</span></a></span><span> </span><span class="annot"><span class="annottext">Code -&gt; Code -&gt; Code
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684532175"><span class="hs-identifier hs-var">prebody</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684532121"><span class="hs-identifier hs-var">body'</span></a></span><span> </span><span class="annot"><span class="annottext">Code
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">[Param]
</span><a href="#local-6989586621684532126"><span class="hs-identifier hs-var">free_params</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Multicore) -&gt; VName -&gt; Multicore
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; VName
</span><a href="Futhark.IR.SegOp.html#segFlat"><span class="hs-identifier hs-var hs-var">segFlat</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684532199"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-129"></span><span>
</span><span id="line-130"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegScan.html#scanStage2"><span class="hs-identifier hs-type">scanStage2</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-131"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-132"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#TV"><span class="hs-identifier hs-type">TV</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-133"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegSpace"><span class="hs-identifier hs-type">SegSpace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-134"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.SegOp.html#SegBinOp"><span class="hs-identifier hs-type">SegBinOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-135"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-type">KernelBody</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-136"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#MulticoreGen"><span class="hs-identifier hs-type">MulticoreGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-137"></span><span id="scanStage2"><span class="annot"><span class="annottext">scanStage2 :: Pat MCMem
-&gt; TV Int32
-&gt; SegSpace
-&gt; [SegBinOp MCMem]
-&gt; KernelBody MCMem
-&gt; ImpM MCMem HostEnv Multicore ()
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegScan.html#scanStage2"><span class="hs-identifier hs-var hs-var">scanStage2</span></a></span></span><span> </span><span id="local-6989586621684532117"><span class="annot"><span class="annottext">Pat MCMem
</span><a href="#local-6989586621684532117"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684532116"><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684532116"><span class="hs-identifier hs-var">nsubtasks</span></a></span></span><span> </span><span id="local-6989586621684532115"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684532115"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684532114"><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532114"><span class="hs-identifier hs-var">scan_ops</span></a></span></span><span> </span><span id="local-6989586621684532113"><span class="annot"><span class="annottext">KernelBody MCMem
</span><a href="#local-6989586621684532113"><span class="hs-identifier hs-var">kbody</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-138"></span><span>  </span><span class="annot"><span class="annottext">Code -&gt; ImpM MCMem HostEnv Multicore ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; Code -&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe Exp -&gt; Code
forall a. String -&gt; Maybe Exp -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#DebugPrint"><span class="hs-identifier hs-var">Imp.DebugPrint</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;nonsegmentedScan stage 2&quot;</span></span><span> </span><span class="annot"><span class="annottext">Maybe Exp
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-139"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684532112"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684532112"><span class="hs-identifier hs-var">is</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532111"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684532111"><span class="hs-identifier hs-var">ns</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VName, SubExp)] -&gt; ([VName], [SubExp])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(VName, SubExp)] -&gt; ([VName], [SubExp]))
-&gt; [(VName, SubExp)] -&gt; ([VName], [SubExp])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; [(VName, SubExp)]
</span><a href="Futhark.IR.SegOp.html#unSegSpace"><span class="hs-identifier hs-var hs-var">unSegSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684532115"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-140"></span><span>      </span><span id="local-6989586621684532109"><span class="annot"><span class="annottext">ns_64 :: [TExp Int64]
</span><a href="#local-6989586621684532109"><span class="hs-identifier hs-var hs-var">ns_64</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684532111"><span class="hs-identifier hs-var">ns</span></a></span><span>
</span><span id="line-141"></span><span>      </span><span id="local-6989586621684532108"><span class="annot"><span class="annottext">per_scan_pes :: [[PatElemT LParamMem]]
</span><a href="#local-6989586621684532108"><span class="hs-identifier hs-var hs-var">per_scan_pes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem] -&gt; [PatElemT LParamMem] -&gt; [[PatElemT LParamMem]]
forall rep a. [SegBinOp rep] -&gt; [a] -&gt; [[a]]
</span><a href="Futhark.IR.SegOp.html#segBinOpChunks"><span class="hs-identifier hs-var">segBinOpChunks</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532114"><span class="hs-identifier hs-var">scan_ops</span></a></span><span> </span><span class="annot"><span class="annottext">([PatElemT LParamMem] -&gt; [[PatElemT LParamMem]])
-&gt; [PatElemT LParamMem] -&gt; [[PatElemT LParamMem]]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatT LParamMem -&gt; [PatElemT LParamMem]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span> </span><span class="annot"><span class="annottext">Pat MCMem
PatT LParamMem
</span><a href="#local-6989586621684532117"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-142"></span><span>      </span><span id="local-6989586621684532107"><span class="annot"><span class="annottext">nsubtasks' :: TExp Int32
</span><a href="#local-6989586621684532107"><span class="hs-identifier hs-var hs-var">nsubtasks'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TV Int32 -&gt; TExp Int32
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684532116"><span class="hs-identifier hs-var">nsubtasks</span></a></span><span>
</span><span id="line-143"></span><span>
</span><span id="line-144"></span><span>  </span><span class="annot"><span class="annottext">Maybe (Exp MCMem) -&gt; Scope MCMem -&gt; ImpM MCMem HostEnv Multicore ()
forall rep inner r op.
Mem rep inner =&gt;
Maybe (Exp rep) -&gt; Scope rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dScope"><span class="hs-identifier hs-var">dScope</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp MCMem)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">(Scope MCMem -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; Scope MCMem -&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem] -&gt; Scope MCMem
forall rep dec. (LParamInfo rep ~ dec) =&gt; [Param dec] -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOfLParams"><span class="hs-identifier hs-var">scopeOfLParams</span></a></span><span> </span><span class="annot"><span class="annottext">([Param LParamMem] -&gt; Scope MCMem)
-&gt; [Param LParamMem] -&gt; Scope MCMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SegBinOp MCMem -&gt; [Param LParamMem])
-&gt; [SegBinOp MCMem] -&gt; [Param LParamMem]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LambdaT MCMem -&gt; [Param LParamMem]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">(LambdaT MCMem -&gt; [Param LParamMem])
-&gt; (SegBinOp MCMem -&gt; LambdaT MCMem)
-&gt; SegBinOp MCMem
-&gt; [Param LParamMem]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; LambdaT MCMem
forall rep. SegBinOp rep -&gt; Lambda rep
</span><a href="Futhark.IR.SegOp.html#segBinOpLambda"><span class="hs-identifier hs-var hs-var">segBinOpLambda</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532114"><span class="hs-identifier hs-var">scan_ops</span></a></span><span>
</span><span id="line-145"></span><span>  </span><span id="local-6989586621684532106"><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684532106"><span class="hs-identifier hs-var">offset</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; TExp Int64 -&gt; ImpM MCMem HostEnv Multicore (TV Int64)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV"><span class="hs-identifier hs-var">dPrimV</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;offset&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int64
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">)</span><span>
</span><span id="line-146"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684532104"><span class="annot"><span class="annottext">offset' :: TExp Int64
</span><a href="#local-6989586621684532104"><span class="hs-identifier hs-var hs-var">offset'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TV Int64 -&gt; TExp Int64
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684532106"><span class="hs-identifier hs-var">offset</span></a></span><span>
</span><span id="line-147"></span><span>  </span><span id="local-6989586621684532103"><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684532103"><span class="hs-identifier hs-var">offset_index</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; TExp Int64 -&gt; ImpM MCMem HostEnv Multicore (TV Int64)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV"><span class="hs-identifier hs-var">dPrimV</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;offset_index&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int64
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">)</span><span>
</span><span id="line-148"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684532102"><span class="annot"><span class="annottext">offset_index' :: TExp Int64
</span><a href="#local-6989586621684532102"><span class="hs-identifier hs-var hs-var">offset_index'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TV Int64 -&gt; TExp Int64
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684532103"><span class="hs-identifier hs-var">offset_index</span></a></span><span>
</span><span id="line-149"></span><span>
</span><span id="line-150"></span><span>  </span><span class="hs-comment">-- Parameters used to find the chunk sizes</span><span>
</span><span id="line-151"></span><span>  </span><span class="hs-comment">-- Perhaps get this information from ``scheduling information``</span><span>
</span><span id="line-152"></span><span>  </span><span class="hs-comment">-- instead of computing it manually here.</span><span>
</span><span id="line-153"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684532094"><span class="annot"><span class="annottext">iter_pr_subtask :: TExp Int64
</span><a href="#local-6989586621684532094"><span class="hs-identifier hs-var hs-var">iter_pr_subtask</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; TExp Int64
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">product</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684532109"><span class="hs-identifier hs-var">ns_64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall e. IntegralExp e =&gt; e -&gt; e -&gt; e
</span><a href="Futhark.Util.IntegralExp.html#quot"><span class="hs-operator hs-var">`quot`</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int64
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684532107"><span class="hs-identifier hs-var">nsubtasks'</span></a></span><span>
</span><span id="line-154"></span><span>      </span><span id="local-6989586621684532084"><span class="annot"><span class="annottext">remainder :: TExp Int64
</span><a href="#local-6989586621684532084"><span class="hs-identifier hs-var hs-var">remainder</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; TExp Int64
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">product</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684532109"><span class="hs-identifier hs-var">ns_64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall e. IntegralExp e =&gt; e -&gt; e -&gt; e
</span><a href="Futhark.Util.IntegralExp.html#rem"><span class="hs-operator hs-var">`rem`</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int64
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684532107"><span class="hs-identifier hs-var">nsubtasks'</span></a></span><span>
</span><span id="line-155"></span><span>
</span><span id="line-156"></span><span>  </span><span id="local-6989586621684532083"><span class="annot"><span class="annottext">[[VName]]
</span><a href="#local-6989586621684532083"><span class="hs-identifier hs-var">accs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; [SegBinOp MCMem] -&gt; MulticoreGen [[VName]]
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegScan.html#resultArrays"><span class="hs-identifier hs-var">resultArrays</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;scan_stage_2_accum&quot;</span></span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532114"><span class="hs-identifier hs-var">scan_ops</span></a></span><span>
</span><span id="line-157"></span><span>  </span><span class="annot"><span class="annottext">[(SegBinOp MCMem, [VName])]
-&gt; ((SegBinOp MCMem, [VName]) -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SegBinOp MCMem] -&gt; [[VName]] -&gt; [(SegBinOp MCMem, [VName])]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532114"><span class="hs-identifier hs-var">scan_ops</span></a></span><span> </span><span class="annot"><span class="annottext">[[VName]]
</span><a href="#local-6989586621684532083"><span class="hs-identifier hs-var">accs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((SegBinOp MCMem, [VName]) -&gt; ImpM MCMem HostEnv Multicore ())
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ((SegBinOp MCMem, [VName]) -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684532082"><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684532082"><span class="hs-identifier hs-var">scan_op</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532081"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684532081"><span class="hs-identifier hs-var">acc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-158"></span><span>    </span><span class="annot"><span class="annottext">Shape
-&gt; ([TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
Shape -&gt; ([TExp Int64] -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sLoopNest"><span class="hs-identifier hs-var">sLoopNest</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; Shape
forall rep. SegBinOp rep -&gt; Shape
</span><a href="Futhark.IR.SegOp.html#segBinOpShape"><span class="hs-identifier hs-var hs-var">segBinOpShape</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684532082"><span class="hs-identifier hs-var">scan_op</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(([TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ())
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ([TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684532080"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684532080"><span class="hs-identifier hs-var">vec_is</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-159"></span><span>      </span><span class="annot"><span class="annottext">[(VName, SubExp)]
-&gt; ((VName, SubExp) -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; [SubExp] -&gt; [(VName, SubExp)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684532081"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [(VName, SubExp)]) -&gt; [SubExp] -&gt; [(VName, SubExp)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; [SubExp]
forall rep. SegBinOp rep -&gt; [SubExp]
</span><a href="Futhark.IR.SegOp.html#segBinOpNeutral"><span class="hs-identifier hs-var hs-var">segBinOpNeutral</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684532082"><span class="hs-identifier hs-var">scan_op</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((VName, SubExp) -&gt; ImpM MCMem HostEnv Multicore ())
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ((VName, SubExp) -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684532079"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684532079"><span class="hs-identifier hs-var">acc'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532078"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684532078"><span class="hs-identifier hs-var">ne</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-160"></span><span>        </span><span class="annot"><span class="annottext">VName
-&gt; [TExp Int64]
-&gt; SubExp
-&gt; [TExp Int64]
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684532079"><span class="hs-identifier hs-var">acc'</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684532080"><span class="hs-identifier hs-var">vec_is</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684532078"><span class="hs-identifier hs-var">ne</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-161"></span><span>
</span><span id="line-162"></span><span>  </span><span class="hs-comment">-- Perform sequential scan over the last element of each chunk</span><span>
</span><span id="line-163"></span><span>  </span><span class="annot"><span class="annottext">String
-&gt; TExp Int32
-&gt; (TExp Int32 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall t rep r op.
String
-&gt; TExp t -&gt; (TExp t -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sFor"><span class="hs-identifier hs-var">sFor</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;i&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684532107"><span class="hs-identifier hs-var">nsubtasks'</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((TExp Int32 -&gt; ImpM MCMem HostEnv Multicore ())
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; (TExp Int32 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684532076"><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684532076"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-164"></span><span>    </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684532106"><span class="hs-identifier hs-var">offset</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64 -&gt; TExp Int64 -&gt; ImpM MCMem HostEnv Multicore ()
forall t rep r op. TV t -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#%3C--"><span class="hs-operator hs-var">&lt;--</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684532094"><span class="hs-identifier hs-var">iter_pr_subtask</span></a></span><span>
</span><span id="line-165"></span><span>    </span><span class="annot"><span class="annottext">TExp Bool
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op. TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int64
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684532076"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Bool
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3C."><span class="hs-operator hs-var">.&lt;.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684532084"><span class="hs-identifier hs-var">remainder</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684532106"><span class="hs-identifier hs-var">offset</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64 -&gt; TExp Int64 -&gt; ImpM MCMem HostEnv Multicore ()
forall t rep r op. TV t -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#%3C--"><span class="hs-operator hs-var">&lt;--</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684532104"><span class="hs-identifier hs-var">offset'</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-166"></span><span>    </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684532103"><span class="hs-identifier hs-var">offset_index</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64 -&gt; TExp Int64 -&gt; ImpM MCMem HostEnv Multicore ()
forall t rep r op. TV t -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#%3C--"><span class="hs-operator hs-var">&lt;--</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684532102"><span class="hs-identifier hs-var">offset_index'</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684532104"><span class="hs-identifier hs-var">offset'</span></a></span><span>
</span><span id="line-167"></span><span>    </span><span class="annot"><span class="annottext">(VName -&gt; TExp Int64 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; [VName] -&gt; [TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ()
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m ()
</span><span class="hs-identifier hs-var">zipWithM_</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TExp Int64 -&gt; ImpM MCMem HostEnv Multicore ()
forall t rep r op. VName -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV_"><span class="hs-identifier hs-var">dPrimV_</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684532112"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">([TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; [TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; TExp Int64 -&gt; [TExp Int64]
forall num. IntegralExp num =&gt; [num] -&gt; num -&gt; [num]
</span><a href="Futhark.IR.Prop.Reshape.html#unflattenIndex"><span class="hs-identifier hs-var">unflattenIndex</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684532109"><span class="hs-identifier hs-var">ns_64</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; [TExp Int64]) -&gt; TExp Int64 -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684532102"><span class="hs-identifier hs-var">offset_index'</span></a></span><span>
</span><span id="line-168"></span><span>
</span><span id="line-169"></span><span>    </span><span class="annot"><span class="annottext">Names
-&gt; Stms MCMem
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
Names -&gt; Stms rep -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileStms"><span class="hs-identifier hs-var">compileStms</span></a></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelBody MCMem -&gt; Stms MCMem
forall rep. KernelBody rep -&gt; Stms rep
</span><a href="Futhark.IR.SegOp.html#kernelBodyStms"><span class="hs-identifier hs-var hs-var">kernelBodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody MCMem
</span><a href="#local-6989586621684532113"><span class="hs-identifier hs-var">kbody</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM MCMem HostEnv Multicore ()
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-170"></span><span>      </span><span class="annot"><span class="annottext">[([PatElemT LParamMem], SegBinOp MCMem, [VName])]
-&gt; (([PatElemT LParamMem], SegBinOp MCMem, [VName])
    -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[[PatElemT LParamMem]]
-&gt; [SegBinOp MCMem]
-&gt; [[VName]]
-&gt; [([PatElemT LParamMem], SegBinOp MCMem, [VName])]
forall a b c. [a] -&gt; [b] -&gt; [c] -&gt; [(a, b, c)]
</span><span class="hs-identifier hs-var">zip3</span></span><span> </span><span class="annot"><span class="annottext">[[PatElemT LParamMem]]
</span><a href="#local-6989586621684532108"><span class="hs-identifier hs-var">per_scan_pes</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532114"><span class="hs-identifier hs-var">scan_ops</span></a></span><span> </span><span class="annot"><span class="annottext">[[VName]]
</span><a href="#local-6989586621684532083"><span class="hs-identifier hs-var">accs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((([PatElemT LParamMem], SegBinOp MCMem, [VName])
  -&gt; ImpM MCMem HostEnv Multicore ())
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; (([PatElemT LParamMem], SegBinOp MCMem, [VName])
    -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684532072"><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684532072"><span class="hs-identifier hs-var">pes</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532071"><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684532071"><span class="hs-identifier hs-var">scan_op</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532070"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684532070"><span class="hs-identifier hs-var">acc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-171"></span><span>        </span><span class="annot"><span class="annottext">Shape
-&gt; ([TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
Shape -&gt; ([TExp Int64] -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sLoopNest"><span class="hs-identifier hs-var">sLoopNest</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; Shape
forall rep. SegBinOp rep -&gt; Shape
</span><a href="Futhark.IR.SegOp.html#segBinOpShape"><span class="hs-identifier hs-var hs-var">segBinOpShape</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684532071"><span class="hs-identifier hs-var">scan_op</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(([TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ())
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ([TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684532069"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684532069"><span class="hs-identifier hs-var">vec_is</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-172"></span><span>          </span><span class="annot"><span class="annottext">String
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Read carry in&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ImpM MCMem HostEnv Multicore ()
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-173"></span><span>            </span><span class="annot"><span class="annottext">[(Param LParamMem, VName)]
-&gt; ((Param LParamMem, VName) -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param LParamMem] -&gt; [VName] -&gt; [(Param LParamMem, VName)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; [LParam MCMem]
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegScan.html#xParams"><span class="hs-identifier hs-var">xParams</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684532071"><span class="hs-identifier hs-var">scan_op</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684532070"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Param LParamMem, VName) -&gt; ImpM MCMem HostEnv Multicore ())
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ((Param LParamMem, VName) -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684532068"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684532068"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532067"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684532067"><span class="hs-identifier hs-var">acc'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-174"></span><span>              </span><span class="annot"><span class="annottext">VName
-&gt; [TExp Int64]
-&gt; SubExp
-&gt; [TExp Int64]
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684532068"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684532067"><span class="hs-identifier hs-var">acc'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684532069"><span class="hs-identifier hs-var">vec_is</span></a></span><span>
</span><span id="line-175"></span><span>
</span><span id="line-176"></span><span>          </span><span class="annot"><span class="annottext">String
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Read next values&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ImpM MCMem HostEnv Multicore ()
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-177"></span><span>            </span><span class="annot"><span class="annottext">[(Param LParamMem, PatElemT LParamMem)]
-&gt; ((Param LParamMem, PatElemT LParamMem)
    -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param LParamMem]
-&gt; [PatElemT LParamMem] -&gt; [(Param LParamMem, PatElemT LParamMem)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; [LParam MCMem]
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegScan.html#yParams"><span class="hs-identifier hs-var">yParams</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684532071"><span class="hs-identifier hs-var">scan_op</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684532072"><span class="hs-identifier hs-var">pes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Param LParamMem, PatElemT LParamMem)
  -&gt; ImpM MCMem HostEnv Multicore ())
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ((Param LParamMem, PatElemT LParamMem)
    -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684532066"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684532066"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532065"><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684532065"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-178"></span><span>              </span><span class="annot"><span class="annottext">VName
-&gt; [TExp Int64]
-&gt; SubExp
-&gt; [TExp Int64]
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684532066"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SubExp) -&gt; VName -&gt; SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684532065"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684532102"><span class="hs-identifier hs-var">offset_index'</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; [TExp Int64] -&gt; [TExp Int64]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684532069"><span class="hs-identifier hs-var">vec_is</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-179"></span><span>
</span><span id="line-180"></span><span>          </span><span class="annot"><span class="annottext">Names
-&gt; Stms MCMem
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
Names -&gt; Stms rep -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileStms"><span class="hs-identifier hs-var">compileStms</span></a></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Body MCMem -&gt; Stms MCMem
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">(Body MCMem -&gt; Stms MCMem) -&gt; Body MCMem -&gt; Stms MCMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; Body MCMem
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegScan.html#lamBody"><span class="hs-identifier hs-var">lamBody</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684532071"><span class="hs-identifier hs-var">scan_op</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM MCMem HostEnv Multicore ()
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-181"></span><span>            </span><span class="annot"><span class="annottext">[(VName, PatElemT LParamMem, SubExp)]
-&gt; ((VName, PatElemT LParamMem, SubExp)
    -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName]
-&gt; [PatElemT LParamMem]
-&gt; [SubExp]
-&gt; [(VName, PatElemT LParamMem, SubExp)]
forall a b c. [a] -&gt; [b] -&gt; [c] -&gt; [(a, b, c)]
</span><span class="hs-identifier hs-var">zip3</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684532070"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684532072"><span class="hs-identifier hs-var">pes</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [(VName, PatElemT LParamMem, SubExp)])
-&gt; [SubExp] -&gt; [(VName, PatElemT LParamMem, SubExp)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExpRes -&gt; SubExp) -&gt; [SubExpRes] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExpRes -&gt; SubExp
</span><a href="Futhark.IR.Syntax.html#resSubExp"><span class="hs-identifier hs-var hs-var">resSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExpRes] -&gt; [SubExp]) -&gt; [SubExpRes] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Body MCMem -&gt; [SubExpRes]
forall rep. BodyT rep -&gt; [SubExpRes]
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var hs-var">bodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">(Body MCMem -&gt; [SubExpRes]) -&gt; Body MCMem -&gt; [SubExpRes]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; Body MCMem
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegScan.html#lamBody"><span class="hs-identifier hs-var">lamBody</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684532071"><span class="hs-identifier hs-var">scan_op</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((VName, PatElemT LParamMem, SubExp)
  -&gt; ImpM MCMem HostEnv Multicore ())
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ((VName, PatElemT LParamMem, SubExp)
    -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-182"></span><span>              </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684532064"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684532064"><span class="hs-identifier hs-var">acc'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532063"><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684532063"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532062"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684532062"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-183"></span><span>                </span><span class="annot"><span class="annottext">VName
-&gt; [TExp Int64]
-&gt; SubExp
-&gt; [TExp Int64]
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684532063"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684532102"><span class="hs-identifier hs-var">offset_index'</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; [TExp Int64] -&gt; [TExp Int64]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684532069"><span class="hs-identifier hs-var">vec_is</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684532062"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-184"></span><span>                </span><span class="annot"><span class="annottext">VName
-&gt; [TExp Int64]
-&gt; SubExp
-&gt; [TExp Int64]
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684532064"><span class="hs-identifier hs-var">acc'</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684532069"><span class="hs-identifier hs-var">vec_is</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684532062"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-185"></span><span>
</span><span id="line-186"></span><span class="hs-comment">-- Stage 3 : Finally each thread partially scans a chunk of the input</span><span>
</span><span id="line-187"></span><span class="hs-comment">--           reading its corresponding carry-in</span><span>
</span><span id="line-188"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegScan.html#scanStage3"><span class="hs-identifier hs-type">scanStage3</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-189"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-190"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegSpace"><span class="hs-identifier hs-type">SegSpace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-191"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.SegOp.html#SegBinOp"><span class="hs-identifier hs-type">SegBinOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-192"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-type">KernelBody</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-193"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#MulticoreGen"><span class="hs-identifier hs-type">MulticoreGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-194"></span><span id="scanStage3"><span class="annot"><span class="annottext">scanStage3 :: Pat MCMem
-&gt; SegSpace
-&gt; [SegBinOp MCMem]
-&gt; KernelBody MCMem
-&gt; ImpM MCMem HostEnv Multicore ()
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegScan.html#scanStage3"><span class="hs-identifier hs-var hs-var">scanStage3</span></a></span></span><span> </span><span id="local-6989586621684532061"><span class="annot"><span class="annottext">Pat MCMem
</span><a href="#local-6989586621684532061"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684532060"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684532060"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684532059"><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532059"><span class="hs-identifier hs-var">scan_ops</span></a></span></span><span> </span><span id="local-6989586621684532058"><span class="annot"><span class="annottext">KernelBody MCMem
</span><a href="#local-6989586621684532058"><span class="hs-identifier hs-var">kbody</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-195"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684532057"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684532057"><span class="hs-identifier hs-var">is</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532056"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684532056"><span class="hs-identifier hs-var">ns</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VName, SubExp)] -&gt; ([VName], [SubExp])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(VName, SubExp)] -&gt; ([VName], [SubExp]))
-&gt; [(VName, SubExp)] -&gt; ([VName], [SubExp])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; [(VName, SubExp)]
</span><a href="Futhark.IR.SegOp.html#unSegSpace"><span class="hs-identifier hs-var hs-var">unSegSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684532060"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-196"></span><span>      </span><span id="local-6989586621684532055"><span class="annot"><span class="annottext">all_scan_res :: [KernelResult]
</span><a href="#local-6989586621684532055"><span class="hs-identifier hs-var hs-var">all_scan_res</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [KernelResult] -&gt; [KernelResult]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">take</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SegBinOp MCMem] -&gt; Int
forall rep. [SegBinOp rep] -&gt; Int
</span><a href="Futhark.IR.SegOp.html#segBinOpResults"><span class="hs-identifier hs-var">segBinOpResults</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532059"><span class="hs-identifier hs-var">scan_ops</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([KernelResult] -&gt; [KernelResult])
-&gt; [KernelResult] -&gt; [KernelResult]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KernelBody MCMem -&gt; [KernelResult]
forall rep. KernelBody rep -&gt; [KernelResult]
</span><a href="Futhark.IR.SegOp.html#kernelBodyResult"><span class="hs-identifier hs-var hs-var">kernelBodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody MCMem
</span><a href="#local-6989586621684532058"><span class="hs-identifier hs-var">kbody</span></a></span><span>
</span><span id="line-197"></span><span>      </span><span id="local-6989586621684532054"><span class="annot"><span class="annottext">per_scan_res :: [[KernelResult]]
</span><a href="#local-6989586621684532054"><span class="hs-identifier hs-var hs-var">per_scan_res</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem] -&gt; [KernelResult] -&gt; [[KernelResult]]
forall rep a. [SegBinOp rep] -&gt; [a] -&gt; [[a]]
</span><a href="Futhark.IR.SegOp.html#segBinOpChunks"><span class="hs-identifier hs-var">segBinOpChunks</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532059"><span class="hs-identifier hs-var">scan_ops</span></a></span><span> </span><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684532055"><span class="hs-identifier hs-var">all_scan_res</span></a></span><span>
</span><span id="line-198"></span><span>      </span><span id="local-6989586621684532053"><span class="annot"><span class="annottext">per_scan_pes :: [[PatElemT LParamMem]]
</span><a href="#local-6989586621684532053"><span class="hs-identifier hs-var hs-var">per_scan_pes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem] -&gt; [PatElemT LParamMem] -&gt; [[PatElemT LParamMem]]
forall rep a. [SegBinOp rep] -&gt; [a] -&gt; [[a]]
</span><a href="Futhark.IR.SegOp.html#segBinOpChunks"><span class="hs-identifier hs-var">segBinOpChunks</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532059"><span class="hs-identifier hs-var">scan_ops</span></a></span><span> </span><span class="annot"><span class="annottext">([PatElemT LParamMem] -&gt; [[PatElemT LParamMem]])
-&gt; [PatElemT LParamMem] -&gt; [[PatElemT LParamMem]]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatT LParamMem -&gt; [PatElemT LParamMem]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span> </span><span class="annot"><span class="annottext">Pat MCMem
PatT LParamMem
</span><a href="#local-6989586621684532061"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-199"></span><span>      </span><span id="local-6989586621684532051"><span class="annot"><span class="annottext">ns' :: [TExp Int64]
</span><a href="#local-6989586621684532051"><span class="hs-identifier hs-var hs-var">ns'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684532056"><span class="hs-identifier hs-var">ns</span></a></span><span>
</span><span id="line-200"></span><span>
</span><span id="line-201"></span><span>  </span><span id="local-6989586621684532050"><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684532050"><span class="hs-identifier hs-var">iter</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; TExp Int64 -&gt; ImpM MCMem HostEnv Multicore (TV Int64)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV"><span class="hs-identifier hs-var">dPrimV</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;iter&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int64
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">)</span><span>
</span><span id="line-202"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684532049"><span class="annot"><span class="annottext">iter' :: TExp Int64
</span><a href="#local-6989586621684532049"><span class="hs-identifier hs-var hs-var">iter'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TV Int64 -&gt; TExp Int64
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684532050"><span class="hs-identifier hs-var">iter</span></a></span><span>
</span><span id="line-203"></span><span>
</span><span id="line-204"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684532048"><span class="annot"><span class="annottext">[[VName]]
</span><a href="#local-6989586621684532048"><span class="hs-identifier hs-var">local_accs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532047"><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684532047"><span class="hs-identifier hs-var">prebody</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MulticoreGen [[VName]]
-&gt; ImpM MCMem HostEnv Multicore ([[VName]], Code)
forall rep r op a. ImpM rep r op a -&gt; ImpM rep r op (a, Code op)
</span><a href="Futhark.CodeGen.ImpGen.html#collect%27"><span class="hs-identifier hs-var">collect'</span></a></span><span> </span><span class="annot"><span class="annottext">(MulticoreGen [[VName]]
 -&gt; ImpM MCMem HostEnv Multicore ([[VName]], Code))
-&gt; MulticoreGen [[VName]]
-&gt; ImpM MCMem HostEnv Multicore ([[VName]], Code)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-205"></span><span>    </span><span class="annot"><span class="annottext">Maybe (Exp MCMem) -&gt; Scope MCMem -&gt; ImpM MCMem HostEnv Multicore ()
forall rep inner r op.
Mem rep inner =&gt;
Maybe (Exp rep) -&gt; Scope rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dScope"><span class="hs-identifier hs-var">dScope</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp MCMem)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">(Scope MCMem -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; Scope MCMem -&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem] -&gt; Scope MCMem
forall rep dec. (LParamInfo rep ~ dec) =&gt; [Param dec] -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOfLParams"><span class="hs-identifier hs-var">scopeOfLParams</span></a></span><span> </span><span class="annot"><span class="annottext">([Param LParamMem] -&gt; Scope MCMem)
-&gt; [Param LParamMem] -&gt; Scope MCMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SegBinOp MCMem -&gt; [Param LParamMem])
-&gt; [SegBinOp MCMem] -&gt; [Param LParamMem]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LambdaT MCMem -&gt; [Param LParamMem]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">(LambdaT MCMem -&gt; [Param LParamMem])
-&gt; (SegBinOp MCMem -&gt; LambdaT MCMem)
-&gt; SegBinOp MCMem
-&gt; [Param LParamMem]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; LambdaT MCMem
forall rep. SegBinOp rep -&gt; Lambda rep
</span><a href="Futhark.IR.SegOp.html#segBinOpLambda"><span class="hs-identifier hs-var hs-var">segBinOpLambda</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532059"><span class="hs-identifier hs-var">scan_ops</span></a></span><span>
</span><span id="line-206"></span><span>    </span><span class="annot"><span class="annottext">[(SegBinOp MCMem, [PatElemT LParamMem])]
-&gt; ((SegBinOp MCMem, [PatElemT LParamMem])
    -&gt; ImpM MCMem HostEnv Multicore [VName])
-&gt; MulticoreGen [[VName]]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SegBinOp MCMem]
-&gt; [[PatElemT LParamMem]]
-&gt; [(SegBinOp MCMem, [PatElemT LParamMem])]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532059"><span class="hs-identifier hs-var">scan_ops</span></a></span><span> </span><span class="annot"><span class="annottext">[[PatElemT LParamMem]]
</span><a href="#local-6989586621684532053"><span class="hs-identifier hs-var">per_scan_pes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((SegBinOp MCMem, [PatElemT LParamMem])
  -&gt; ImpM MCMem HostEnv Multicore [VName])
 -&gt; MulticoreGen [[VName]])
-&gt; ((SegBinOp MCMem, [PatElemT LParamMem])
    -&gt; ImpM MCMem HostEnv Multicore [VName])
-&gt; MulticoreGen [[VName]]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684532046"><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684532046"><span class="hs-identifier hs-var">scan_op</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532045"><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684532045"><span class="hs-identifier hs-var">pes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-207"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684532044"><span class="annot"><span class="annottext">shape :: Shape
</span><a href="#local-6989586621684532044"><span class="hs-identifier hs-var hs-var">shape</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; Shape
forall rep. SegBinOp rep -&gt; Shape
</span><a href="Futhark.IR.SegOp.html#segBinOpShape"><span class="hs-identifier hs-var hs-var">segBinOpShape</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684532046"><span class="hs-identifier hs-var">scan_op</span></a></span><span>
</span><span id="line-208"></span><span>          </span><span id="local-6989586621684532043"><span class="annot"><span class="annottext">ts :: [Type]
</span><a href="#local-6989586621684532043"><span class="hs-identifier hs-var hs-var">ts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LambdaT MCMem -&gt; [Type]
forall rep. LambdaT rep -&gt; [Type]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">(LambdaT MCMem -&gt; [Type]) -&gt; LambdaT MCMem -&gt; [Type]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; LambdaT MCMem
forall rep. SegBinOp rep -&gt; Lambda rep
</span><a href="Futhark.IR.SegOp.html#segBinOpLambda"><span class="hs-identifier hs-var hs-var">segBinOpLambda</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684532046"><span class="hs-identifier hs-var">scan_op</span></a></span><span>
</span><span id="line-209"></span><span>      </span><span class="annot"><span class="annottext">[(Param LParamMem, PatElemT LParamMem, Type, SubExp)]
-&gt; ((Param LParamMem, PatElemT LParamMem, Type, SubExp)
    -&gt; ImpM MCMem HostEnv Multicore VName)
-&gt; ImpM MCMem HostEnv Multicore [VName]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param LParamMem]
-&gt; [PatElemT LParamMem]
-&gt; [Type]
-&gt; [SubExp]
-&gt; [(Param LParamMem, PatElemT LParamMem, Type, SubExp)]
forall a b c d. [a] -&gt; [b] -&gt; [c] -&gt; [d] -&gt; [(a, b, c, d)]
</span><span class="hs-identifier hs-var">zip4</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; [LParam MCMem]
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegScan.html#xParams"><span class="hs-identifier hs-var">xParams</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684532046"><span class="hs-identifier hs-var">scan_op</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684532045"><span class="hs-identifier hs-var">pes</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684532043"><span class="hs-identifier hs-var">ts</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [(Param LParamMem, PatElemT LParamMem, Type, SubExp)])
-&gt; [SubExp]
-&gt; [(Param LParamMem, PatElemT LParamMem, Type, SubExp)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; [SubExp]
forall rep. SegBinOp rep -&gt; [SubExp]
</span><a href="Futhark.IR.SegOp.html#segBinOpNeutral"><span class="hs-identifier hs-var hs-var">segBinOpNeutral</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684532046"><span class="hs-identifier hs-var">scan_op</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Param LParamMem, PatElemT LParamMem, Type, SubExp)
  -&gt; ImpM MCMem HostEnv Multicore VName)
 -&gt; ImpM MCMem HostEnv Multicore [VName])
-&gt; ((Param LParamMem, PatElemT LParamMem, Type, SubExp)
    -&gt; ImpM MCMem HostEnv Multicore VName)
-&gt; ImpM MCMem HostEnv Multicore [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684532042"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684532042"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532041"><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684532041"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532040"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684532040"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532039"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684532039"><span class="hs-identifier hs-var">ne</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-210"></span><span>        </span><span id="local-6989586621684532038"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684532038"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-211"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Shape -&gt; [SubExp]
forall d. ShapeBase d -&gt; [d]
</span><a href="Futhark.IR.Syntax.Core.html#shapeDims"><span class="hs-identifier hs-var hs-var">shapeDims</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684532044"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-212"></span><span>            </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">VName -&gt; ImpM MCMem HostEnv Multicore VName
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; ImpM MCMem HostEnv Multicore VName)
-&gt; VName -&gt; ImpM MCMem HostEnv Multicore VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684532042"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-213"></span><span>            </span><span class="annot"><span class="annottext">[SubExp]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-214"></span><span>              </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684532037"><span class="annot"><span class="annottext">pt :: PrimType
</span><a href="#local-6989586621684532037"><span class="hs-identifier hs-var hs-var">pt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; PrimType
forall shape u. TypeBase shape u -&gt; PrimType
</span><a href="Futhark.IR.Prop.Types.html#elemType"><span class="hs-identifier hs-var">elemType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684532040"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-215"></span><span>              </span><span class="annot"><span class="annottext">String
-&gt; PrimType -&gt; Shape -&gt; Space -&gt; ImpM MCMem HostEnv Multicore VName
forall rep r op.
String -&gt; PrimType -&gt; Shape -&gt; Space -&gt; ImpM rep r op VName
</span><a href="Futhark.CodeGen.ImpGen.html#sAllocArray"><span class="hs-identifier hs-var">sAllocArray</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;local_acc&quot;</span></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684532037"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684532044"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">Shape -&gt; Shape -&gt; Shape
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Shape
forall shape u. ArrayShape shape =&gt; TypeBase shape u -&gt; shape
</span><a href="Futhark.IR.Prop.Types.html#arrayShape"><span class="hs-identifier hs-var">arrayShape</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684532040"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="Futhark.IR.Syntax.Core.html#DefaultSpace"><span class="hs-identifier hs-var">DefaultSpace</span></a></span><span>
</span><span id="line-216"></span><span>
</span><span id="line-217"></span><span>        </span><span class="hs-comment">-- Initialise the accumulator with neutral from previous chunk.</span><span>
</span><span id="line-218"></span><span>        </span><span class="hs-comment">-- or read neutral if first ``iter``</span><span>
</span><span id="line-219"></span><span>        </span><span class="annot"><span class="annottext">Shape
-&gt; ([TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
Shape -&gt; ([TExp Int64] -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sLoopNest"><span class="hs-identifier hs-var">sLoopNest</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; Shape
forall rep. SegBinOp rep -&gt; Shape
</span><a href="Futhark.IR.SegOp.html#segBinOpShape"><span class="hs-identifier hs-var hs-var">segBinOpShape</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684532046"><span class="hs-identifier hs-var">scan_op</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(([TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ())
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ([TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684532036"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684532036"><span class="hs-identifier hs-var">vec_is</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-220"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684532031"><span class="annot"><span class="annottext">read_carry_in :: ImpM rep r op ()
</span><a href="#local-6989586621684532031"><span class="hs-identifier hs-var hs-var">read_carry_in</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-221"></span><span>                </span><span class="annot"><span class="annottext">VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684532038"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684532036"><span class="hs-identifier hs-var">vec_is</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SubExp) -&gt; VName -&gt; SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684532041"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684532049"><span class="hs-identifier hs-var">iter'</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; [TExp Int64] -&gt; [TExp Int64]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684532036"><span class="hs-identifier hs-var">vec_is</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-222"></span><span>              </span><span id="local-6989586621684532030"><span class="annot"><span class="annottext">read_neutral :: ImpM rep r op ()
</span><a href="#local-6989586621684532030"><span class="hs-identifier hs-var hs-var">read_neutral</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-223"></span><span>                </span><span class="annot"><span class="annottext">VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684532038"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684532036"><span class="hs-identifier hs-var">vec_is</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684532039"><span class="hs-identifier hs-var">ne</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-224"></span><span>          </span><span class="annot"><span class="annottext">TExp Bool
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
TExp Bool
-&gt; ImpM rep r op () -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sIf"><span class="hs-identifier hs-var">sIf</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684532049"><span class="hs-identifier hs-var">iter'</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Bool
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3D%3D."><span class="hs-operator hs-var">.==.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ImpM MCMem HostEnv Multicore ()
forall {rep} {r} {op}. ImpM rep r op ()
</span><a href="#local-6989586621684532030"><span class="hs-identifier hs-var">read_neutral</span></a></span><span> </span><span class="annot"><span class="annottext">ImpM MCMem HostEnv Multicore ()
forall {rep} {r} {op}. ImpM rep r op ()
</span><a href="#local-6989586621684532031"><span class="hs-identifier hs-var">read_carry_in</span></a></span><span>
</span><span id="line-225"></span><span>        </span><span class="annot"><span class="annottext">VName -&gt; ImpM MCMem HostEnv Multicore VName
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684532038"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-226"></span><span>
</span><span id="line-227"></span><span>  </span><span id="local-6989586621684532027"><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684532027"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ImpM MCMem HostEnv Multicore () -&gt; MulticoreGen Code
forall rep r op. ImpM rep r op () -&gt; ImpM rep r op (Code op)
</span><a href="Futhark.CodeGen.ImpGen.html#collect"><span class="hs-identifier hs-var">collect</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM MCMem HostEnv Multicore () -&gt; MulticoreGen Code)
-&gt; ImpM MCMem HostEnv Multicore () -&gt; MulticoreGen Code
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-228"></span><span>    </span><span class="annot"><span class="annottext">(VName -&gt; TExp Int64 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; [VName] -&gt; [TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ()
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m ()
</span><span class="hs-identifier hs-var">zipWithM_</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TExp Int64 -&gt; ImpM MCMem HostEnv Multicore ()
forall t rep r op. VName -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV_"><span class="hs-identifier hs-var">dPrimV_</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684532057"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">([TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; [TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; TExp Int64 -&gt; [TExp Int64]
forall num. IntegralExp num =&gt; [num] -&gt; num -&gt; [num]
</span><a href="Futhark.IR.Prop.Reshape.html#unflattenIndex"><span class="hs-identifier hs-var">unflattenIndex</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684532051"><span class="hs-identifier hs-var">ns'</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684532049"><span class="hs-identifier hs-var">iter'</span></a></span><span>
</span><span id="line-229"></span><span>    </span><span class="annot"><span class="annottext">String
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;stage 3 scan body&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ImpM MCMem HostEnv Multicore ()
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-230"></span><span>      </span><span class="annot"><span class="annottext">Names
-&gt; Stms MCMem
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
Names -&gt; Stms rep -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileStms"><span class="hs-identifier hs-var">compileStms</span></a></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelBody MCMem -&gt; Stms MCMem
forall rep. KernelBody rep -&gt; Stms rep
</span><a href="Futhark.IR.SegOp.html#kernelBodyStms"><span class="hs-identifier hs-var hs-var">kernelBodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody MCMem
</span><a href="#local-6989586621684532058"><span class="hs-identifier hs-var">kbody</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM MCMem HostEnv Multicore ()
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-231"></span><span>        </span><span class="annot"><span class="annottext">[([PatElemT LParamMem], SegBinOp MCMem, [KernelResult], [VName])]
-&gt; (([PatElemT LParamMem], SegBinOp MCMem, [KernelResult], [VName])
    -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[[PatElemT LParamMem]]
-&gt; [SegBinOp MCMem]
-&gt; [[KernelResult]]
-&gt; [[VName]]
-&gt; [([PatElemT LParamMem], SegBinOp MCMem, [KernelResult],
     [VName])]
forall a b c d. [a] -&gt; [b] -&gt; [c] -&gt; [d] -&gt; [(a, b, c, d)]
</span><span class="hs-identifier hs-var">zip4</span></span><span> </span><span class="annot"><span class="annottext">[[PatElemT LParamMem]]
</span><a href="#local-6989586621684532053"><span class="hs-identifier hs-var">per_scan_pes</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532059"><span class="hs-identifier hs-var">scan_ops</span></a></span><span> </span><span class="annot"><span class="annottext">[[KernelResult]]
</span><a href="#local-6989586621684532054"><span class="hs-identifier hs-var">per_scan_res</span></a></span><span> </span><span class="annot"><span class="annottext">[[VName]]
</span><a href="#local-6989586621684532048"><span class="hs-identifier hs-var">local_accs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((([PatElemT LParamMem], SegBinOp MCMem, [KernelResult], [VName])
  -&gt; ImpM MCMem HostEnv Multicore ())
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; (([PatElemT LParamMem], SegBinOp MCMem, [KernelResult], [VName])
    -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684532026"><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684532026"><span class="hs-identifier hs-var">pes</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532025"><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684532025"><span class="hs-identifier hs-var">scan_op</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532024"><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684532024"><span class="hs-identifier hs-var">scan_res</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532023"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684532023"><span class="hs-identifier hs-var">acc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-232"></span><span>          </span><span class="annot"><span class="annottext">Shape
-&gt; ([TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
Shape -&gt; ([TExp Int64] -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sLoopNest"><span class="hs-identifier hs-var">sLoopNest</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; Shape
forall rep. SegBinOp rep -&gt; Shape
</span><a href="Futhark.IR.SegOp.html#segBinOpShape"><span class="hs-identifier hs-var hs-var">segBinOpShape</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684532025"><span class="hs-identifier hs-var">scan_op</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(([TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ())
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ([TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684532022"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684532022"><span class="hs-identifier hs-var">vec_is</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-233"></span><span>            </span><span class="annot"><span class="annottext">[(Param LParamMem, VName)]
-&gt; ((Param LParamMem, VName) -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param LParamMem] -&gt; [VName] -&gt; [(Param LParamMem, VName)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; [LParam MCMem]
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegScan.html#xParams"><span class="hs-identifier hs-var">xParams</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684532025"><span class="hs-identifier hs-var">scan_op</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684532023"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Param LParamMem, VName) -&gt; ImpM MCMem HostEnv Multicore ())
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ((Param LParamMem, VName) -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684532021"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684532021"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532020"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684532020"><span class="hs-identifier hs-var">acc'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-234"></span><span>              </span><span class="annot"><span class="annottext">VName
-&gt; [TExp Int64]
-&gt; SubExp
-&gt; [TExp Int64]
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684532021"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684532020"><span class="hs-identifier hs-var">acc'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684532022"><span class="hs-identifier hs-var">vec_is</span></a></span><span>
</span><span id="line-235"></span><span>
</span><span id="line-236"></span><span>            </span><span class="hs-comment">-- Read next value</span><span>
</span><span id="line-237"></span><span>            </span><span class="annot"><span class="annottext">[(Param LParamMem, KernelResult)]
-&gt; ((Param LParamMem, KernelResult)
    -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param LParamMem]
-&gt; [KernelResult] -&gt; [(Param LParamMem, KernelResult)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; [LParam MCMem]
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegScan.html#yParams"><span class="hs-identifier hs-var">yParams</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684532025"><span class="hs-identifier hs-var">scan_op</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684532024"><span class="hs-identifier hs-var">scan_res</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Param LParamMem, KernelResult)
  -&gt; ImpM MCMem HostEnv Multicore ())
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ((Param LParamMem, KernelResult)
    -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684532019"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684532019"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532018"><span class="annot"><span class="annottext">KernelResult
</span><a href="#local-6989586621684532018"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-238"></span><span>              </span><span class="annot"><span class="annottext">VName
-&gt; [TExp Int64]
-&gt; SubExp
-&gt; [TExp Int64]
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684532019"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelResult -&gt; SubExp
</span><a href="Futhark.IR.SegOp.html#kernelResultSubExp"><span class="hs-identifier hs-var">kernelResultSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">KernelResult
</span><a href="#local-6989586621684532018"><span class="hs-identifier hs-var">se</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684532022"><span class="hs-identifier hs-var">vec_is</span></a></span><span>
</span><span id="line-239"></span><span>
</span><span id="line-240"></span><span>            </span><span class="annot"><span class="annottext">Names
-&gt; Stms MCMem
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
Names -&gt; Stms rep -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileStms"><span class="hs-identifier hs-var">compileStms</span></a></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Body MCMem -&gt; Stms MCMem
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">(Body MCMem -&gt; Stms MCMem) -&gt; Body MCMem -&gt; Stms MCMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; Body MCMem
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegScan.html#lamBody"><span class="hs-identifier hs-var">lamBody</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684532025"><span class="hs-identifier hs-var">scan_op</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM MCMem HostEnv Multicore ()
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-241"></span><span>              </span><span class="annot"><span class="annottext">[(PatElemT LParamMem, SubExp, VName)]
-&gt; ((PatElemT LParamMem, SubExp, VName)
    -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PatElemT LParamMem]
-&gt; [SubExp] -&gt; [VName] -&gt; [(PatElemT LParamMem, SubExp, VName)]
forall a b c. [a] -&gt; [b] -&gt; [c] -&gt; [(a, b, c)]
</span><span class="hs-identifier hs-var">zip3</span></span><span> </span><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684532026"><span class="hs-identifier hs-var">pes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SubExpRes -&gt; SubExp) -&gt; [SubExpRes] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExpRes -&gt; SubExp
</span><a href="Futhark.IR.Syntax.html#resSubExp"><span class="hs-identifier hs-var hs-var">resSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExpRes] -&gt; [SubExp]) -&gt; [SubExpRes] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Body MCMem -&gt; [SubExpRes]
forall rep. BodyT rep -&gt; [SubExpRes]
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var hs-var">bodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">(Body MCMem -&gt; [SubExpRes]) -&gt; Body MCMem -&gt; [SubExpRes]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; Body MCMem
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegScan.html#lamBody"><span class="hs-identifier hs-var">lamBody</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684532025"><span class="hs-identifier hs-var">scan_op</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684532023"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((PatElemT LParamMem, SubExp, VName)
  -&gt; ImpM MCMem HostEnv Multicore ())
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ((PatElemT LParamMem, SubExp, VName)
    -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-242"></span><span>                </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684532017"><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684532017"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532016"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684532016"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532015"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684532015"><span class="hs-identifier hs-var">acc'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-243"></span><span>                  </span><span class="annot"><span class="annottext">VName
-&gt; [TExp Int64]
-&gt; SubExp
-&gt; [TExp Int64]
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684532017"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(VName -&gt; TExp Int64) -&gt; [VName] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TExp Int64
forall a. a -&gt; TPrimExp Int64 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le64"><span class="hs-identifier hs-var">Imp.le64</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684532057"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; [TExp Int64] -&gt; [TExp Int64]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684532022"><span class="hs-identifier hs-var">vec_is</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684532016"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-244"></span><span>                  </span><span class="annot"><span class="annottext">VName
-&gt; [TExp Int64]
-&gt; SubExp
-&gt; [TExp Int64]
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684532015"><span class="hs-identifier hs-var">acc'</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684532022"><span class="hs-identifier hs-var">vec_is</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684532016"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-245"></span><span>
</span><span id="line-246"></span><span>  </span><span id="local-6989586621684532014"><span class="annot"><span class="annottext">[Param]
</span><a href="#local-6989586621684532014"><span class="hs-identifier hs-var">free_params'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Code -&gt; [VName] -&gt; MulticoreGen [Param]
</span><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#freeParams"><span class="hs-identifier hs-var">freeParams</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684532047"><span class="hs-identifier hs-var">prebody</span></a></span><span> </span><span class="annot"><span class="annottext">Code -&gt; Code -&gt; Code
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684532027"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegSpace -&gt; VName
</span><a href="Futhark.IR.SegOp.html#segFlat"><span class="hs-identifier hs-var hs-var">segFlat</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684532060"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [VName] -&gt; [VName]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TV Int64 -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684532050"><span class="hs-identifier hs-var">iter</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-247"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684532013"><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684532013"><span class="hs-identifier hs-var">body_allocs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532012"><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684532012"><span class="hs-identifier hs-var">body'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Code -&gt; (Code, Code)
</span><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#extractAllocations"><span class="hs-identifier hs-var">extractAllocations</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684532027"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-248"></span><span>  </span><span class="annot"><span class="annottext">Code -&gt; ImpM MCMem HostEnv Multicore ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; Code -&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Multicore -&gt; Code
forall a. a -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#Op"><span class="hs-identifier hs-var">Imp.Op</span></a></span><span> </span><span class="annot"><span class="annottext">(Multicore -&gt; Code) -&gt; Multicore -&gt; Code
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
-&gt; VName -&gt; Code -&gt; Code -&gt; Code -&gt; [Param] -&gt; VName -&gt; Multicore
</span><a href="Futhark.CodeGen.ImpCode.Multicore.html#ParLoop"><span class="hs-identifier hs-var">Imp.ParLoop</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;scan_stage_3&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int64 -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684532050"><span class="hs-identifier hs-var">iter</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684532013"><span class="hs-identifier hs-var">body_allocs</span></a></span><span> </span><span class="annot"><span class="annottext">Code -&gt; Code -&gt; Code
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684532047"><span class="hs-identifier hs-var">prebody</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684532012"><span class="hs-identifier hs-var">body'</span></a></span><span> </span><span class="annot"><span class="annottext">Code
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">[Param]
</span><a href="#local-6989586621684532014"><span class="hs-identifier hs-var">free_params'</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Multicore) -&gt; VName -&gt; Multicore
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; VName
</span><a href="Futhark.IR.SegOp.html#segFlat"><span class="hs-identifier hs-var hs-var">segFlat</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684532060"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-249"></span><span>
</span><span id="line-250"></span><span class="hs-comment">-- This implementation for a Segmented scan only</span><span>
</span><span id="line-251"></span><span class="hs-comment">-- parallelize over the segments and each segment is</span><span>
</span><span id="line-252"></span><span class="hs-comment">-- scanned sequentially.</span><span>
</span><span id="line-253"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegScan.html#segmentedScan"><span class="hs-identifier hs-type">segmentedScan</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-254"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-255"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegSpace"><span class="hs-identifier hs-type">SegSpace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-256"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.SegOp.html#SegBinOp"><span class="hs-identifier hs-type">SegBinOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-257"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-type">KernelBody</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-258"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#MulticoreGen"><span class="hs-identifier hs-type">MulticoreGen</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.Multicore.html#Code"><span class="hs-identifier hs-type">Imp.Code</span></a></span><span>
</span><span id="line-259"></span><span id="segmentedScan"><span class="annot"><span class="annottext">segmentedScan :: Pat MCMem
-&gt; SegSpace
-&gt; [SegBinOp MCMem]
-&gt; KernelBody MCMem
-&gt; MulticoreGen Code
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegScan.html#segmentedScan"><span class="hs-identifier hs-var hs-var">segmentedScan</span></a></span></span><span> </span><span id="local-6989586621684532011"><span class="annot"><span class="annottext">Pat MCMem
</span><a href="#local-6989586621684532011"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684532010"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684532010"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684532009"><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532009"><span class="hs-identifier hs-var">scan_ops</span></a></span></span><span> </span><span id="local-6989586621684532008"><span class="annot"><span class="annottext">KernelBody MCMem
</span><a href="#local-6989586621684532008"><span class="hs-identifier hs-var">kbody</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-260"></span><span>  </span><span class="annot"><span class="annottext">Code -&gt; ImpM MCMem HostEnv Multicore ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; Code -&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe Exp -&gt; Code
forall a. String -&gt; Maybe Exp -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#DebugPrint"><span class="hs-identifier hs-var">Imp.DebugPrint</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;segmented segScan&quot;</span></span><span> </span><span class="annot"><span class="annottext">Maybe Exp
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-261"></span><span>  </span><span class="annot"><span class="annottext">ImpM MCMem HostEnv Multicore () -&gt; MulticoreGen Code
forall rep r op. ImpM rep r op () -&gt; ImpM rep r op (Code op)
</span><a href="Futhark.CodeGen.ImpGen.html#collect"><span class="hs-identifier hs-var">collect</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM MCMem HostEnv Multicore () -&gt; MulticoreGen Code)
-&gt; ImpM MCMem HostEnv Multicore () -&gt; MulticoreGen Code
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-262"></span><span>    </span><span id="local-6989586621684532007"><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684532007"><span class="hs-identifier hs-var">segment_iter</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; PrimType -&gt; ImpM MCMem HostEnv Multicore (TV Int64)
forall rep r op t. String -&gt; PrimType -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrim"><span class="hs-identifier hs-var">dPrim</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;segment_iter&quot;</span></span><span> </span><span class="annot"><span class="annottext">(PrimType -&gt; ImpM MCMem HostEnv Multicore (TV Int64))
-&gt; PrimType -&gt; ImpM MCMem HostEnv Multicore (TV Int64)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IntType -&gt; PrimType
</span><a href="Futhark.IR.Primitive.html#IntType"><span class="hs-identifier hs-var">IntType</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span>
</span><span id="line-263"></span><span>    </span><span id="local-6989586621684532006"><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684532006"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TExp Int64
-&gt; Pat MCMem
-&gt; SegSpace
-&gt; [SegBinOp MCMem]
-&gt; KernelBody MCMem
-&gt; MulticoreGen Code
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegScan.html#compileSegScanBody"><span class="hs-identifier hs-var">compileSegScanBody</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int64 -&gt; TExp Int64
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684532007"><span class="hs-identifier hs-var">segment_iter</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Pat MCMem
</span><a href="#local-6989586621684532011"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684532010"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532009"><span class="hs-identifier hs-var">scan_ops</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody MCMem
</span><a href="#local-6989586621684532008"><span class="hs-identifier hs-var">kbody</span></a></span><span>
</span><span id="line-264"></span><span>    </span><span id="local-6989586621684532004"><span class="annot"><span class="annottext">[Param]
</span><a href="#local-6989586621684532004"><span class="hs-identifier hs-var">free_params</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Code -&gt; [VName] -&gt; MulticoreGen [Param]
</span><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#freeParams"><span class="hs-identifier hs-var">freeParams</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684532006"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegSpace -&gt; VName
</span><a href="Futhark.IR.SegOp.html#segFlat"><span class="hs-identifier hs-var hs-var">segFlat</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684532010"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [VName] -&gt; [VName]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TV Int64 -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684532007"><span class="hs-identifier hs-var">segment_iter</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-265"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684532003"><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684532003"><span class="hs-identifier hs-var">body_allocs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532002"><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684532002"><span class="hs-identifier hs-var">body'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Code -&gt; (Code, Code)
</span><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#extractAllocations"><span class="hs-identifier hs-var">extractAllocations</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684532006"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-266"></span><span>    </span><span class="annot"><span class="annottext">Code -&gt; ImpM MCMem HostEnv Multicore ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; Code -&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Multicore -&gt; Code
forall a. a -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#Op"><span class="hs-identifier hs-var">Imp.Op</span></a></span><span> </span><span class="annot"><span class="annottext">(Multicore -&gt; Code) -&gt; Multicore -&gt; Code
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
-&gt; VName -&gt; Code -&gt; Code -&gt; Code -&gt; [Param] -&gt; VName -&gt; Multicore
</span><a href="Futhark.CodeGen.ImpCode.Multicore.html#ParLoop"><span class="hs-identifier hs-var">Imp.ParLoop</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;seg_scan&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int64 -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684532007"><span class="hs-identifier hs-var">segment_iter</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684532003"><span class="hs-identifier hs-var">body_allocs</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684532002"><span class="hs-identifier hs-var">body'</span></a></span><span> </span><span class="annot"><span class="annottext">Code
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">[Param]
</span><a href="#local-6989586621684532004"><span class="hs-identifier hs-var">free_params</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Multicore) -&gt; VName -&gt; Multicore
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; VName
</span><a href="Futhark.IR.SegOp.html#segFlat"><span class="hs-identifier hs-var hs-var">segFlat</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684532010"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-267"></span><span>
</span><span id="line-268"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegScan.html#compileSegScanBody"><span class="hs-identifier hs-type">compileSegScanBody</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-269"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-270"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-271"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegSpace"><span class="hs-identifier hs-type">SegSpace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-272"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.SegOp.html#SegBinOp"><span class="hs-identifier hs-type">SegBinOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-273"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-type">KernelBody</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-274"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#MulticoreGen"><span class="hs-identifier hs-type">MulticoreGen</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.Multicore.html#Code"><span class="hs-identifier hs-type">Imp.Code</span></a></span><span>
</span><span id="line-275"></span><span id="compileSegScanBody"><span class="annot"><span class="annottext">compileSegScanBody :: TExp Int64
-&gt; Pat MCMem
-&gt; SegSpace
-&gt; [SegBinOp MCMem]
-&gt; KernelBody MCMem
-&gt; MulticoreGen Code
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegScan.html#compileSegScanBody"><span class="hs-identifier hs-var hs-var">compileSegScanBody</span></a></span></span><span> </span><span id="local-6989586621684532001"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684532001"><span class="hs-identifier hs-var">segment_i</span></a></span></span><span> </span><span id="local-6989586621684532000"><span class="annot"><span class="annottext">Pat MCMem
</span><a href="#local-6989586621684532000"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684531999"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684531999"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684531998"><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684531998"><span class="hs-identifier hs-var">scan_ops</span></a></span></span><span> </span><span id="local-6989586621684531997"><span class="annot"><span class="annottext">KernelBody MCMem
</span><a href="#local-6989586621684531997"><span class="hs-identifier hs-var">kbody</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-276"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684531996"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684531996"><span class="hs-identifier hs-var">is</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684531995"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684531995"><span class="hs-identifier hs-var">ns</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VName, SubExp)] -&gt; ([VName], [SubExp])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(VName, SubExp)] -&gt; ([VName], [SubExp]))
-&gt; [(VName, SubExp)] -&gt; ([VName], [SubExp])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; [(VName, SubExp)]
</span><a href="Futhark.IR.SegOp.html#unSegSpace"><span class="hs-identifier hs-var hs-var">unSegSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684531999"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-277"></span><span>      </span><span id="local-6989586621684531993"><span class="annot"><span class="annottext">ns_64 :: [TExp Int64]
</span><a href="#local-6989586621684531993"><span class="hs-identifier hs-var hs-var">ns_64</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684531995"><span class="hs-identifier hs-var">ns</span></a></span><span>
</span><span id="line-278"></span><span>
</span><span id="line-279"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684531992"><span class="annot"><span class="annottext">per_scan_pes :: [[PatElemT LParamMem]]
</span><a href="#local-6989586621684531992"><span class="hs-identifier hs-var hs-var">per_scan_pes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem] -&gt; [PatElemT LParamMem] -&gt; [[PatElemT LParamMem]]
forall rep a. [SegBinOp rep] -&gt; [a] -&gt; [[a]]
</span><a href="Futhark.IR.SegOp.html#segBinOpChunks"><span class="hs-identifier hs-var">segBinOpChunks</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684531998"><span class="hs-identifier hs-var">scan_ops</span></a></span><span> </span><span class="annot"><span class="annottext">([PatElemT LParamMem] -&gt; [[PatElemT LParamMem]])
-&gt; [PatElemT LParamMem] -&gt; [[PatElemT LParamMem]]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatT LParamMem -&gt; [PatElemT LParamMem]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span> </span><span class="annot"><span class="annottext">Pat MCMem
PatT LParamMem
</span><a href="#local-6989586621684532000"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-280"></span><span>  </span><span class="annot"><span class="annottext">ImpM MCMem HostEnv Multicore () -&gt; MulticoreGen Code
forall rep r op. ImpM rep r op () -&gt; ImpM rep r op (Code op)
</span><a href="Futhark.CodeGen.ImpGen.html#collect"><span class="hs-identifier hs-var">collect</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM MCMem HostEnv Multicore () -&gt; MulticoreGen Code)
-&gt; ImpM MCMem HostEnv Multicore () -&gt; MulticoreGen Code
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-281"></span><span>    </span><span class="annot"><span class="annottext">[(SegBinOp MCMem, [PatElemT LParamMem])]
-&gt; ((SegBinOp MCMem, [PatElemT LParamMem])
    -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SegBinOp MCMem]
-&gt; [[PatElemT LParamMem]]
-&gt; [(SegBinOp MCMem, [PatElemT LParamMem])]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684531998"><span class="hs-identifier hs-var">scan_ops</span></a></span><span> </span><span class="annot"><span class="annottext">[[PatElemT LParamMem]]
</span><a href="#local-6989586621684531992"><span class="hs-identifier hs-var">per_scan_pes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((SegBinOp MCMem, [PatElemT LParamMem])
  -&gt; ImpM MCMem HostEnv Multicore ())
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ((SegBinOp MCMem, [PatElemT LParamMem])
    -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684531991"><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684531991"><span class="hs-identifier hs-var">scan_op</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684531990"><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684531990"><span class="hs-identifier hs-var">scan_pes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-282"></span><span>      </span><span class="annot"><span class="annottext">Maybe (Exp MCMem) -&gt; Scope MCMem -&gt; ImpM MCMem HostEnv Multicore ()
forall rep inner r op.
Mem rep inner =&gt;
Maybe (Exp rep) -&gt; Scope rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dScope"><span class="hs-identifier hs-var">dScope</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp MCMem)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">(Scope MCMem -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; Scope MCMem -&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem] -&gt; Scope MCMem
forall rep dec. (LParamInfo rep ~ dec) =&gt; [Param dec] -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOfLParams"><span class="hs-identifier hs-var">scopeOfLParams</span></a></span><span> </span><span class="annot"><span class="annottext">([Param LParamMem] -&gt; Scope MCMem)
-&gt; [Param LParamMem] -&gt; Scope MCMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LambdaT MCMem -&gt; [LParam MCMem]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">(LambdaT MCMem -&gt; [LParam MCMem])
-&gt; LambdaT MCMem -&gt; [LParam MCMem]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; LambdaT MCMem
forall rep. SegBinOp rep -&gt; Lambda rep
</span><a href="Futhark.IR.SegOp.html#segBinOpLambda"><span class="hs-identifier hs-var hs-var">segBinOpLambda</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684531991"><span class="hs-identifier hs-var">scan_op</span></a></span><span>
</span><span id="line-283"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684531988"><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684531988"><span class="hs-identifier hs-var">scan_x_params</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684531987"><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684531987"><span class="hs-identifier hs-var">scan_y_params</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Param LParamMem] -&gt; ([Param LParamMem], [Param LParamMem])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; Int) -&gt; [SubExp] -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; [SubExp]
forall rep. SegBinOp rep -&gt; [SubExp]
</span><a href="Futhark.IR.SegOp.html#segBinOpNeutral"><span class="hs-identifier hs-var hs-var">segBinOpNeutral</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684531991"><span class="hs-identifier hs-var">scan_op</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Param LParamMem] -&gt; ([Param LParamMem], [Param LParamMem]))
-&gt; [Param LParamMem] -&gt; ([Param LParamMem], [Param LParamMem])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LambdaT MCMem -&gt; [Param LParamMem]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">(LambdaT MCMem -&gt; [Param LParamMem])
-&gt; (SegBinOp MCMem -&gt; LambdaT MCMem)
-&gt; SegBinOp MCMem
-&gt; [Param LParamMem]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; LambdaT MCMem
forall rep. SegBinOp rep -&gt; Lambda rep
</span><a href="Futhark.IR.SegOp.html#segBinOpLambda"><span class="hs-identifier hs-var hs-var">segBinOpLambda</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684531991"><span class="hs-identifier hs-var">scan_op</span></a></span><span>
</span><span id="line-284"></span><span>
</span><span id="line-285"></span><span>      </span><span class="annot"><span class="annottext">[(Param LParamMem, SubExp)]
-&gt; ((Param LParamMem, SubExp) -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param LParamMem] -&gt; [SubExp] -&gt; [(Param LParamMem, SubExp)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684531988"><span class="hs-identifier hs-var">scan_x_params</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [(Param LParamMem, SubExp)])
-&gt; [SubExp] -&gt; [(Param LParamMem, SubExp)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; [SubExp]
forall rep. SegBinOp rep -&gt; [SubExp]
</span><a href="Futhark.IR.SegOp.html#segBinOpNeutral"><span class="hs-identifier hs-var hs-var">segBinOpNeutral</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684531991"><span class="hs-identifier hs-var">scan_op</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Param LParamMem, SubExp) -&gt; ImpM MCMem HostEnv Multicore ())
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ((Param LParamMem, SubExp) -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684531986"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684531986"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684531985"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684531985"><span class="hs-identifier hs-var">ne</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-286"></span><span>        </span><span class="annot"><span class="annottext">VName
-&gt; [TExp Int64]
-&gt; SubExp
-&gt; [TExp Int64]
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684531986"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684531985"><span class="hs-identifier hs-var">ne</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-287"></span><span>
</span><span id="line-288"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684531984"><span class="annot"><span class="annottext">inner_bound :: TExp Int64
</span><a href="#local-6989586621684531984"><span class="hs-identifier hs-var hs-var">inner_bound</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; TExp Int64
forall a. [a] -&gt; a
</span><span class="hs-identifier hs-var">last</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684531993"><span class="hs-identifier hs-var">ns_64</span></a></span><span>
</span><span id="line-289"></span><span>      </span><span class="hs-comment">-- Perform a sequential scan over the segment ``segment_i``</span><span>
</span><span id="line-290"></span><span>      </span><span class="annot"><span class="annottext">String
-&gt; TExp Int64
-&gt; (TExp Int64 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall t rep r op.
String
-&gt; TExp t -&gt; (TExp t -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sFor"><span class="hs-identifier hs-var">sFor</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;i&quot;</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684531984"><span class="hs-identifier hs-var">inner_bound</span></a></span><span> </span><span class="annot"><span class="annottext">((TExp Int64 -&gt; ImpM MCMem HostEnv Multicore ())
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; (TExp Int64 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684531982"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684531982"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-291"></span><span>        </span><span class="annot"><span class="annottext">(VName -&gt; TExp Int64 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; [VName] -&gt; [TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ()
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m ()
</span><span class="hs-identifier hs-var">zipWithM_</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TExp Int64 -&gt; ImpM MCMem HostEnv Multicore ()
forall t rep r op. VName -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV_"><span class="hs-identifier hs-var">dPrimV_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; [VName]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">init</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684531996"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; [TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; TExp Int64 -&gt; [TExp Int64]
forall num. IntegralExp num =&gt; [num] -&gt; num -&gt; [num]
</span><a href="Futhark.IR.Prop.Reshape.html#unflattenIndex"><span class="hs-identifier hs-var">unflattenIndex</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TExp Int64] -&gt; [TExp Int64]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">init</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684531993"><span class="hs-identifier hs-var">ns_64</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684532001"><span class="hs-identifier hs-var">segment_i</span></a></span><span>
</span><span id="line-292"></span><span>        </span><span class="annot"><span class="annottext">VName -&gt; TExp Int64 -&gt; ImpM MCMem HostEnv Multicore ()
forall t rep r op. VName -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV_"><span class="hs-identifier hs-var">dPrimV_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; VName
forall a. [a] -&gt; a
</span><span class="hs-identifier hs-var">last</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684531996"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684531982"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-293"></span><span>        </span><span class="annot"><span class="annottext">Names
-&gt; Stms MCMem
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
Names -&gt; Stms rep -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileStms"><span class="hs-identifier hs-var">compileStms</span></a></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelBody MCMem -&gt; Stms MCMem
forall rep. KernelBody rep -&gt; Stms rep
</span><a href="Futhark.IR.SegOp.html#kernelBodyStms"><span class="hs-identifier hs-var hs-var">kernelBodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody MCMem
</span><a href="#local-6989586621684531997"><span class="hs-identifier hs-var">kbody</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM MCMem HostEnv Multicore ()
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-294"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684531979"><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684531979"><span class="hs-identifier hs-var">scan_res</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684531978"><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684531978"><span class="hs-identifier hs-var">map_res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [KernelResult] -&gt; ([KernelResult], [KernelResult])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; Int) -&gt; [SubExp] -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; [SubExp]
forall rep. SegBinOp rep -&gt; [SubExp]
</span><a href="Futhark.IR.SegOp.html#segBinOpNeutral"><span class="hs-identifier hs-var hs-var">segBinOpNeutral</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684531991"><span class="hs-identifier hs-var">scan_op</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([KernelResult] -&gt; ([KernelResult], [KernelResult]))
-&gt; [KernelResult] -&gt; ([KernelResult], [KernelResult])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KernelBody MCMem -&gt; [KernelResult]
forall rep. KernelBody rep -&gt; [KernelResult]
</span><a href="Futhark.IR.SegOp.html#kernelBodyResult"><span class="hs-identifier hs-var hs-var">kernelBodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody MCMem
</span><a href="#local-6989586621684531997"><span class="hs-identifier hs-var">kbody</span></a></span><span>
</span><span id="line-295"></span><span>          </span><span class="annot"><span class="annottext">String
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;write to-scan values to parameters&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ImpM MCMem HostEnv Multicore ()
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-296"></span><span>            </span><span class="annot"><span class="annottext">[(Param LParamMem, KernelResult)]
-&gt; ((Param LParamMem, KernelResult)
    -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param LParamMem]
-&gt; [KernelResult] -&gt; [(Param LParamMem, KernelResult)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684531987"><span class="hs-identifier hs-var">scan_y_params</span></a></span><span> </span><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684531979"><span class="hs-identifier hs-var">scan_res</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Param LParamMem, KernelResult)
  -&gt; ImpM MCMem HostEnv Multicore ())
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ((Param LParamMem, KernelResult)
    -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684531977"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684531977"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684531976"><span class="annot"><span class="annottext">KernelResult
</span><a href="#local-6989586621684531976"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-297"></span><span>              </span><span class="annot"><span class="annottext">VName
-&gt; [TExp Int64]
-&gt; SubExp
-&gt; [TExp Int64]
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684531977"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelResult -&gt; SubExp
</span><a href="Futhark.IR.SegOp.html#kernelResultSubExp"><span class="hs-identifier hs-var">kernelResultSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">KernelResult
</span><a href="#local-6989586621684531976"><span class="hs-identifier hs-var">se</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-298"></span><span>
</span><span id="line-299"></span><span>          </span><span class="annot"><span class="annottext">String
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;write mapped values results to memory&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ImpM MCMem HostEnv Multicore ()
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-300"></span><span>            </span><span class="annot"><span class="annottext">[(PatElemT LParamMem, KernelResult)]
-&gt; ((PatElemT LParamMem, KernelResult)
    -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PatElemT LParamMem]
-&gt; [KernelResult] -&gt; [(PatElemT LParamMem, KernelResult)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; [PatElemT LParamMem] -&gt; [PatElemT LParamMem]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; Int) -&gt; [SubExp] -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; [SubExp]
forall rep. SegBinOp rep -&gt; [SubExp]
</span><a href="Futhark.IR.SegOp.html#segBinOpNeutral"><span class="hs-identifier hs-var hs-var">segBinOpNeutral</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684531991"><span class="hs-identifier hs-var">scan_op</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([PatElemT LParamMem] -&gt; [PatElemT LParamMem])
-&gt; [PatElemT LParamMem] -&gt; [PatElemT LParamMem]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatT LParamMem -&gt; [PatElemT LParamMem]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span> </span><span class="annot"><span class="annottext">Pat MCMem
PatT LParamMem
</span><a href="#local-6989586621684532000"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684531978"><span class="hs-identifier hs-var">map_res</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((PatElemT LParamMem, KernelResult)
  -&gt; ImpM MCMem HostEnv Multicore ())
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ((PatElemT LParamMem, KernelResult)
    -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684531975"><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684531975"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684531974"><span class="annot"><span class="annottext">KernelResult
</span><a href="#local-6989586621684531974"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-301"></span><span>              </span><span class="annot"><span class="annottext">VName
-&gt; [TExp Int64]
-&gt; SubExp
-&gt; [TExp Int64]
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684531975"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(VName -&gt; TExp Int64) -&gt; [VName] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TExp Int64
forall a. a -&gt; TPrimExp Int64 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le64"><span class="hs-identifier hs-var">Imp.le64</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684531996"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelResult -&gt; SubExp
</span><a href="Futhark.IR.SegOp.html#kernelResultSubExp"><span class="hs-identifier hs-var">kernelResultSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">KernelResult
</span><a href="#local-6989586621684531974"><span class="hs-identifier hs-var">se</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-302"></span><span>
</span><span id="line-303"></span><span>          </span><span class="annot"><span class="annottext">String
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;combine with carry and write to memory&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ImpM MCMem HostEnv Multicore ()
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-304"></span><span>            </span><span class="annot"><span class="annottext">Names
-&gt; Stms MCMem
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
Names -&gt; Stms rep -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileStms"><span class="hs-identifier hs-var">compileStms</span></a></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Body MCMem -&gt; Stms MCMem
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">(Body MCMem -&gt; Stms MCMem) -&gt; Body MCMem -&gt; Stms MCMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LambdaT MCMem -&gt; Body MCMem
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">(LambdaT MCMem -&gt; Body MCMem) -&gt; LambdaT MCMem -&gt; Body MCMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; LambdaT MCMem
forall rep. SegBinOp rep -&gt; Lambda rep
</span><a href="Futhark.IR.SegOp.html#segBinOpLambda"><span class="hs-identifier hs-var hs-var">segBinOpLambda</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684531991"><span class="hs-identifier hs-var">scan_op</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM MCMem HostEnv Multicore ()
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-305"></span><span>              </span><span class="annot"><span class="annottext">[(Param LParamMem, PatElemT LParamMem, SubExp)]
-&gt; ((Param LParamMem, PatElemT LParamMem, SubExp)
    -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param LParamMem]
-&gt; [PatElemT LParamMem]
-&gt; [SubExp]
-&gt; [(Param LParamMem, PatElemT LParamMem, SubExp)]
forall a b c. [a] -&gt; [b] -&gt; [c] -&gt; [(a, b, c)]
</span><span class="hs-identifier hs-var">zip3</span></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684531988"><span class="hs-identifier hs-var">scan_x_params</span></a></span><span> </span><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684531990"><span class="hs-identifier hs-var">scan_pes</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [(Param LParamMem, PatElemT LParamMem, SubExp)])
-&gt; [SubExp] -&gt; [(Param LParamMem, PatElemT LParamMem, SubExp)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExpRes -&gt; SubExp) -&gt; [SubExpRes] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExpRes -&gt; SubExp
</span><a href="Futhark.IR.Syntax.html#resSubExp"><span class="hs-identifier hs-var hs-var">resSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExpRes] -&gt; [SubExp]) -&gt; [SubExpRes] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Body MCMem -&gt; [SubExpRes]
forall rep. BodyT rep -&gt; [SubExpRes]
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var hs-var">bodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">(Body MCMem -&gt; [SubExpRes]) -&gt; Body MCMem -&gt; [SubExpRes]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LambdaT MCMem -&gt; Body MCMem
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">(LambdaT MCMem -&gt; Body MCMem) -&gt; LambdaT MCMem -&gt; Body MCMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; LambdaT MCMem
forall rep. SegBinOp rep -&gt; Lambda rep
</span><a href="Futhark.IR.SegOp.html#segBinOpLambda"><span class="hs-identifier hs-var hs-var">segBinOpLambda</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684531991"><span class="hs-identifier hs-var">scan_op</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Param LParamMem, PatElemT LParamMem, SubExp)
  -&gt; ImpM MCMem HostEnv Multicore ())
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ((Param LParamMem, PatElemT LParamMem, SubExp)
    -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684531973"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684531973"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684531972"><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684531972"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684531971"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684531971"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-306"></span><span>                </span><span class="annot"><span class="annottext">VName
-&gt; [TExp Int64]
-&gt; SubExp
-&gt; [TExp Int64]
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684531972"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(VName -&gt; TExp Int64) -&gt; [VName] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TExp Int64
forall a. a -&gt; TPrimExp Int64 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le64"><span class="hs-identifier hs-var">Imp.le64</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684531996"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684531971"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-307"></span><span>                </span><span class="annot"><span class="annottext">VName
-&gt; [TExp Int64]
-&gt; SubExp
-&gt; [TExp Int64]
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684531973"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684531971"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-308"></span></pre></body></html>