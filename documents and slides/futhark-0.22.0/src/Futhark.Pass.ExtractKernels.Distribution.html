<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE ConstraintKinds #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE FlexibleInstances #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE MultiParamTypeClasses #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE TupleSections #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-9"></span><span>
</span><span id="line-10"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Futhark.Pass.ExtractKernels.Distribution</span><span>
</span><span id="line-11"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Target"><span class="hs-identifier">Target</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-12"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Targets"><span class="hs-identifier">Targets</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-13"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#ppTargets"><span class="hs-identifier">ppTargets</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-14"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#singleTarget"><span class="hs-identifier">singleTarget</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-15"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#outerTarget"><span class="hs-identifier">outerTarget</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-16"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#innerTarget"><span class="hs-identifier">innerTarget</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-17"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#pushInnerTarget"><span class="hs-identifier">pushInnerTarget</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-18"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#popInnerTarget"><span class="hs-identifier">popInnerTarget</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-19"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#targetsScope"><span class="hs-identifier">targetsScope</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-20"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#LoopNesting"><span class="hs-identifier">LoopNesting</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-21"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#ppLoopNesting"><span class="hs-identifier">ppLoopNesting</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-22"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#scopeOfLoopNesting"><span class="hs-identifier">scopeOfLoopNesting</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-23"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Nesting"><span class="hs-identifier">Nesting</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-24"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Nestings"><span class="hs-identifier">Nestings</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-25"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#ppNestings"><span class="hs-identifier">ppNestings</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-26"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#letBindInInnerNesting"><span class="hs-identifier">letBindInInnerNesting</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-27"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#singleNesting"><span class="hs-identifier">singleNesting</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-28"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#pushInnerNesting"><span class="hs-identifier">pushInnerNesting</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-29"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#KernelNest"><span class="hs-identifier">KernelNest</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-30"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#ppKernelNest"><span class="hs-identifier">ppKernelNest</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-31"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#newKernel"><span class="hs-identifier">newKernel</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-32"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#innermostKernelNesting"><span class="hs-identifier">innermostKernelNesting</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-33"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#pushKernelNesting"><span class="hs-identifier">pushKernelNesting</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-34"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#pushInnerKernelNesting"><span class="hs-identifier">pushInnerKernelNesting</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-35"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#scopeOfKernelNest"><span class="hs-identifier">scopeOfKernelNest</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-36"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#kernelNestLoops"><span class="hs-identifier">kernelNestLoops</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-37"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#kernelNestWidths"><span class="hs-identifier">kernelNestWidths</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-38"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#boundInKernelNest"><span class="hs-identifier">boundInKernelNest</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-39"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#boundInKernelNests"><span class="hs-identifier">boundInKernelNests</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-40"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#flatKernel"><span class="hs-identifier">flatKernel</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-41"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#constructKernel"><span class="hs-identifier">constructKernel</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-42"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#tryDistribute"><span class="hs-identifier">tryDistribute</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-43"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#tryDistributeStm"><span class="hs-identifier">tryDistributeStm</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-44"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span class="hs-keyword">where</span><span>
</span><span id="line-46"></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.RWS.Strict</span></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans.Maybe</span></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Bifunctor</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">second</span></span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Foldable</span></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">elemIndex</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">sortOn</span></span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map.Strict</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.html"><span class="hs-identifier">Futhark.IR</span></a></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.SegOp.html"><span class="hs-identifier">Futhark.IR.SegOp</span></a></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.MonadFreshNames.html"><span class="hs-identifier">Futhark.MonadFreshNames</span></a></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.BlockedKernel.html"><span class="hs-identifier">Futhark.Pass.ExtractKernels.BlockedKernel</span></a></span><span>
</span><span id="line-58"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.BlockedKernel.html#DistRep"><span class="hs-identifier">DistRep</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-59"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.BlockedKernel.html#KernelInput"><span class="hs-identifier">KernelInput</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-60"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.BlockedKernel.html#MkSegLevel"><span class="hs-identifier">MkSegLevel</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-61"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.BlockedKernel.html#mapKernel"><span class="hs-identifier">mapKernel</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-62"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.BlockedKernel.html#readKernelInput"><span class="hs-identifier">readKernelInput</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-63"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Tools.html"><span class="hs-identifier">Futhark.Tools</span></a></span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Transform.Rename.html"><span class="hs-identifier">Futhark.Transform.Rename</span></a></span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Util.html"><span class="hs-identifier">Futhark.Util</span></a></span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Util.Log.html"><span class="hs-identifier">Futhark.Util.Log</span></a></span><span>
</span><span id="line-68"></span><span>
</span><span id="line-69"></span><span class="hs-keyword">type</span><span> </span><span id="Target"><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Target"><span class="hs-identifier hs-var">Target</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#PatT"><span class="hs-identifier hs-type">PatT</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Result"><span class="hs-identifier hs-type">Result</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span>
</span><span id="line-71"></span><span class="hs-comment">-- | First pair element is the very innermost (&quot;current&quot;) target.  In</span><span>
</span><span id="line-72"></span><span class="hs-comment">-- the list, the outermost target comes first.  Invariant: Every</span><span>
</span><span id="line-73"></span><span class="hs-comment">-- element of a pattern must be present as the result of the</span><span>
</span><span id="line-74"></span><span class="hs-comment">-- immediately enclosing target.  This is ensured by 'pushInnerTarget'</span><span>
</span><span id="line-75"></span><span class="hs-comment">-- by removing unused pattern elements.</span><span>
</span><span id="line-76"></span><span class="hs-keyword">data</span><span> </span><span id="Targets"><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Targets"><span class="hs-identifier hs-var">Targets</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Targets"><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Targets"><span class="hs-identifier hs-var">Targets</span></a></span></span><span>
</span><span id="line-77"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="_innerTarget"><span class="annot"><span class="annottext">Targets -&gt; Target
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#_innerTarget"><span class="hs-identifier hs-var hs-var">_innerTarget</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Target"><span class="hs-identifier hs-type">Target</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-78"></span><span>    </span><span id="_outerTargets"><span class="annot"><span class="annottext">Targets -&gt; [Target]
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#_outerTargets"><span class="hs-identifier hs-var hs-var">_outerTargets</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Target"><span class="hs-identifier hs-type">Target</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-79"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-80"></span><span>
</span><span id="line-81"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#ppTargets"><span class="hs-identifier hs-type">ppTargets</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Targets"><span class="hs-identifier hs-type">Targets</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-82"></span><span id="ppTargets"><span class="annot"><span class="annottext">ppTargets :: Targets -&gt; String
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#ppTargets"><span class="hs-identifier hs-var hs-var">ppTargets</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Targets"><span class="hs-identifier hs-type">Targets</span></a></span><span> </span><span id="local-6989586621684402517"><span class="annot"><span class="annottext">Target
</span><a href="#local-6989586621684402517"><span class="hs-identifier hs-var">target</span></a></span></span><span> </span><span id="local-6989586621684402516"><span class="annot"><span class="annottext">[Target]
</span><a href="#local-6989586621684402516"><span class="hs-identifier hs-var">targets</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-83"></span><span>  </span><span class="annot"><span class="annottext">[String] -&gt; String
</span><span class="hs-identifier hs-var">unlines</span></span><span> </span><span class="annot"><span class="annottext">([String] -&gt; String) -&gt; [String] -&gt; String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Target -&gt; String) -&gt; [Target] -&gt; [String]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Target -&gt; String
forall {a} {a}. (Pretty a, Pretty a) =&gt; (a, a) -&gt; String
</span><a href="#local-6989586621684402514"><span class="hs-identifier hs-var">ppTarget</span></a></span><span> </span><span class="annot"><span class="annottext">([Target] -&gt; [String]) -&gt; [Target] -&gt; [String]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Target]
</span><a href="#local-6989586621684402516"><span class="hs-identifier hs-var">targets</span></a></span><span> </span><span class="annot"><span class="annottext">[Target] -&gt; [Target] -&gt; [Target]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Target
</span><a href="#local-6989586621684402517"><span class="hs-identifier hs-var">target</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-84"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-85"></span><span>    </span><span id="local-6989586621684402514"><span class="annot"><span class="annottext">ppTarget :: (a, a) -&gt; String
</span><a href="#local-6989586621684402514"><span class="hs-identifier hs-var hs-var">ppTarget</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684402509"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684402509"><span class="hs-identifier hs-var">pat</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684402508"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684402508"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684402509"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; &lt;- &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684402508"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-86"></span><span>
</span><span id="line-87"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#singleTarget"><span class="hs-identifier hs-type">singleTarget</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Target"><span class="hs-identifier hs-type">Target</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Targets"><span class="hs-identifier hs-type">Targets</span></a></span><span>
</span><span id="line-88"></span><span id="singleTarget"><span class="annot"><span class="annottext">singleTarget :: Target -&gt; Targets
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#singleTarget"><span class="hs-identifier hs-var hs-var">singleTarget</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Target -&gt; [Target] -&gt; Targets) -&gt; [Target] -&gt; Target -&gt; Targets
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">Target -&gt; [Target] -&gt; Targets
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#Targets"><span class="hs-identifier hs-var">Targets</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-89"></span><span>
</span><span id="line-90"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#outerTarget"><span class="hs-identifier hs-type">outerTarget</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Targets"><span class="hs-identifier hs-type">Targets</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Target"><span class="hs-identifier hs-type">Target</span></a></span><span>
</span><span id="line-91"></span><span id="outerTarget"><span class="annot"><span class="annottext">outerTarget :: Targets -&gt; Target
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#outerTarget"><span class="hs-identifier hs-var hs-var">outerTarget</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Targets"><span class="hs-identifier hs-type">Targets</span></a></span><span> </span><span id="local-6989586621684402505"><span class="annot"><span class="annottext">Target
</span><a href="#local-6989586621684402505"><span class="hs-identifier hs-var">inner_target</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Target
</span><a href="#local-6989586621684402505"><span class="hs-identifier hs-var">inner_target</span></a></span><span>
</span><span id="line-92"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#outerTarget"><span class="hs-identifier hs-var">outerTarget</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Targets"><span class="hs-identifier hs-type">Targets</span></a></span><span> </span><span class="annot"><span class="annottext">Target
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684402504"><span class="annot"><span class="annottext">Target
</span><a href="#local-6989586621684402504"><span class="hs-identifier hs-var">outer_target</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><span class="annottext">[Target]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Target
</span><a href="#local-6989586621684402504"><span class="hs-identifier hs-var">outer_target</span></a></span><span>
</span><span id="line-93"></span><span>
</span><span id="line-94"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#innerTarget"><span class="hs-identifier hs-type">innerTarget</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Targets"><span class="hs-identifier hs-type">Targets</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Target"><span class="hs-identifier hs-type">Target</span></a></span><span>
</span><span id="line-95"></span><span id="innerTarget"><span class="annot"><span class="annottext">innerTarget :: Targets -&gt; Target
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#innerTarget"><span class="hs-identifier hs-var hs-var">innerTarget</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Targets"><span class="hs-identifier hs-type">Targets</span></a></span><span> </span><span id="local-6989586621684402503"><span class="annot"><span class="annottext">Target
</span><a href="#local-6989586621684402503"><span class="hs-identifier hs-var">inner_target</span></a></span></span><span> </span><span class="annot"><span class="annottext">[Target]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Target
</span><a href="#local-6989586621684402503"><span class="hs-identifier hs-var">inner_target</span></a></span><span>
</span><span id="line-96"></span><span>
</span><span id="line-97"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#pushOuterTarget"><span class="hs-identifier hs-type">pushOuterTarget</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Target"><span class="hs-identifier hs-type">Target</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Targets"><span class="hs-identifier hs-type">Targets</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Targets"><span class="hs-identifier hs-type">Targets</span></a></span><span>
</span><span id="line-98"></span><span id="pushOuterTarget"><span class="annot"><span class="annottext">pushOuterTarget :: Target -&gt; Targets -&gt; Targets
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#pushOuterTarget"><span class="hs-identifier hs-var hs-var">pushOuterTarget</span></a></span></span><span> </span><span id="local-6989586621684402501"><span class="annot"><span class="annottext">Target
</span><a href="#local-6989586621684402501"><span class="hs-identifier hs-var">target</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Targets"><span class="hs-identifier hs-type">Targets</span></a></span><span> </span><span id="local-6989586621684402500"><span class="annot"><span class="annottext">Target
</span><a href="#local-6989586621684402500"><span class="hs-identifier hs-var">inner_target</span></a></span></span><span> </span><span id="local-6989586621684402499"><span class="annot"><span class="annottext">[Target]
</span><a href="#local-6989586621684402499"><span class="hs-identifier hs-var">targets</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-99"></span><span>  </span><span class="annot"><span class="annottext">Target -&gt; [Target] -&gt; Targets
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#Targets"><span class="hs-identifier hs-var">Targets</span></a></span><span> </span><span class="annot"><span class="annottext">Target
</span><a href="#local-6989586621684402500"><span class="hs-identifier hs-var">inner_target</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Target
</span><a href="#local-6989586621684402501"><span class="hs-identifier hs-var">target</span></a></span><span> </span><span class="annot"><span class="annottext">Target -&gt; [Target] -&gt; [Target]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Target]
</span><a href="#local-6989586621684402499"><span class="hs-identifier hs-var">targets</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-100"></span><span>
</span><span id="line-101"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#pushInnerTarget"><span class="hs-identifier hs-type">pushInnerTarget</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Target"><span class="hs-identifier hs-type">Target</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Targets"><span class="hs-identifier hs-type">Targets</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Targets"><span class="hs-identifier hs-type">Targets</span></a></span><span>
</span><span id="line-102"></span><span id="pushInnerTarget"><span class="annot"><span class="annottext">pushInnerTarget :: Target -&gt; Targets -&gt; Targets
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#pushInnerTarget"><span class="hs-identifier hs-var hs-var">pushInnerTarget</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684402498"><span class="annot"><span class="annottext">PatT Type
</span><a href="#local-6989586621684402498"><span class="hs-identifier hs-var">pat</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684402497"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684402497"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Targets"><span class="hs-identifier hs-type">Targets</span></a></span><span> </span><span id="local-6989586621684402496"><span class="annot"><span class="annottext">Target
</span><a href="#local-6989586621684402496"><span class="hs-identifier hs-var">inner_target</span></a></span></span><span> </span><span id="local-6989586621684402495"><span class="annot"><span class="annottext">[Target]
</span><a href="#local-6989586621684402495"><span class="hs-identifier hs-var">targets</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-103"></span><span>  </span><span class="annot"><span class="annottext">Target -&gt; [Target] -&gt; Targets
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#Targets"><span class="hs-identifier hs-var">Targets</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatT Type
</span><a href="#local-6989586621684402494"><span class="hs-identifier hs-var">pat'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684402493"><span class="hs-identifier hs-var">res'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Target]
</span><a href="#local-6989586621684402495"><span class="hs-identifier hs-var">targets</span></a></span><span> </span><span class="annot"><span class="annottext">[Target] -&gt; [Target] -&gt; [Target]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Target
</span><a href="#local-6989586621684402496"><span class="hs-identifier hs-var">inner_target</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-104"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-105"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684402492"><span class="annot"><span class="annottext">[PatElemT Type]
</span><a href="#local-6989586621684402492"><span class="hs-identifier hs-var">pes'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684402493"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684402493"><span class="hs-identifier hs-var">res'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(PatElemT Type, SubExpRes)] -&gt; ([PatElemT Type], Result)
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(PatElemT Type, SubExpRes)] -&gt; ([PatElemT Type], Result))
-&gt; [(PatElemT Type, SubExpRes)] -&gt; ([PatElemT Type], Result)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((PatElemT Type, SubExpRes) -&gt; Bool)
-&gt; [(PatElemT Type, SubExpRes)] -&gt; [(PatElemT Type, SubExpRes)]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT Type -&gt; Bool
</span><a href="#local-6989586621684402490"><span class="hs-identifier hs-var">used</span></a></span><span> </span><span class="annot"><span class="annottext">(PatElemT Type -&gt; Bool)
-&gt; ((PatElemT Type, SubExpRes) -&gt; PatElemT Type)
-&gt; (PatElemT Type, SubExpRes)
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(PatElemT Type, SubExpRes) -&gt; PatElemT Type
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(PatElemT Type, SubExpRes)] -&gt; [(PatElemT Type, SubExpRes)])
-&gt; [(PatElemT Type, SubExpRes)] -&gt; [(PatElemT Type, SubExpRes)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[PatElemT Type] -&gt; Result -&gt; [(PatElemT Type, SubExpRes)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatT Type -&gt; [PatElemT Type]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span> </span><span class="annot"><span class="annottext">PatT Type
</span><a href="#local-6989586621684402498"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684402497"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-106"></span><span>    </span><span id="local-6989586621684402494"><span class="annot"><span class="annottext">pat' :: PatT Type
</span><a href="#local-6989586621684402494"><span class="hs-identifier hs-var hs-var">pat'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[PatElemT Type] -&gt; PatT Type
forall dec. [PatElemT dec] -&gt; PatT dec
</span><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-var">Pat</span></a></span><span> </span><span class="annot"><span class="annottext">[PatElemT Type]
</span><a href="#local-6989586621684402492"><span class="hs-identifier hs-var">pes'</span></a></span><span>
</span><span id="line-107"></span><span>    </span><span id="local-6989586621684402486"><span class="annot"><span class="annottext">inner_used :: Names
</span><a href="#local-6989586621684402486"><span class="hs-identifier hs-var hs-var">inner_used</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Result -&gt; Names
forall a. FreeIn a =&gt; a -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#freeIn"><span class="hs-identifier hs-var">freeIn</span></a></span><span> </span><span class="annot"><span class="annottext">(Result -&gt; Names) -&gt; Result -&gt; Names
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Target -&gt; Result
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">Target
</span><a href="#local-6989586621684402496"><span class="hs-identifier hs-var">inner_target</span></a></span><span>
</span><span id="line-108"></span><span>    </span><span id="local-6989586621684402490"><span class="annot"><span class="annottext">used :: PatElemT Type -&gt; Bool
</span><a href="#local-6989586621684402490"><span class="hs-identifier hs-var hs-var">used</span></a></span></span><span> </span><span id="local-6989586621684402484"><span class="annot"><span class="annottext">PatElemT Type
</span><a href="#local-6989586621684402484"><span class="hs-identifier hs-var">pe</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatElemT Type -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT Type
</span><a href="#local-6989586621684402484"><span class="hs-identifier hs-var">pe</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#nameIn"><span class="hs-operator hs-var">`nameIn`</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684402486"><span class="hs-identifier hs-var">inner_used</span></a></span><span>
</span><span id="line-109"></span><span>
</span><span id="line-110"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#popInnerTarget"><span class="hs-identifier hs-type">popInnerTarget</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Targets"><span class="hs-identifier hs-type">Targets</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Target"><span class="hs-identifier hs-type">Target</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Targets"><span class="hs-identifier hs-type">Targets</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-111"></span><span id="popInnerTarget"><span class="annot"><span class="annottext">popInnerTarget :: Targets -&gt; Maybe (Target, Targets)
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#popInnerTarget"><span class="hs-identifier hs-var hs-var">popInnerTarget</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Targets"><span class="hs-identifier hs-type">Targets</span></a></span><span> </span><span id="local-6989586621684402481"><span class="annot"><span class="annottext">Target
</span><a href="#local-6989586621684402481"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621684402480"><span class="annot"><span class="annottext">[Target]
</span><a href="#local-6989586621684402480"><span class="hs-identifier hs-var">ts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-112"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[Target] -&gt; [Target]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[Target]
</span><a href="#local-6989586621684402480"><span class="hs-identifier hs-var">ts</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-113"></span><span>    </span><span id="local-6989586621684402478"><span class="annot"><span class="annottext">Target
</span><a href="#local-6989586621684402478"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684402477"><span class="annot"><span class="annottext">[Target]
</span><a href="#local-6989586621684402477"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Target, Targets) -&gt; Maybe (Target, Targets)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Target
</span><a href="#local-6989586621684402481"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Target -&gt; [Target] -&gt; Targets
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#Targets"><span class="hs-identifier hs-var">Targets</span></a></span><span> </span><span class="annot"><span class="annottext">Target
</span><a href="#local-6989586621684402478"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">([Target] -&gt; Targets) -&gt; [Target] -&gt; Targets
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Target] -&gt; [Target]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[Target]
</span><a href="#local-6989586621684402477"><span class="hs-identifier hs-var">xs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-114"></span><span>    </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (Target, Targets)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-115"></span><span>
</span><span id="line-116"></span><span id="local-6989586621684402878"><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#targetScope"><span class="hs-identifier hs-type">targetScope</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.BlockedKernel.html#DistRep"><span class="hs-identifier hs-type">DistRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684402878"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Target"><span class="hs-identifier hs-type">Target</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684402878"><span class="hs-identifier hs-type">rep</span></a></span></span><span>
</span><span id="line-117"></span><span id="targetScope"><span class="annot"><span class="annottext">targetScope :: forall rep. DistRep rep =&gt; Target -&gt; Scope rep
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#targetScope"><span class="hs-identifier hs-var hs-var">targetScope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatT Type -&gt; Scope rep
forall rep dec. (LetDec rep ~ dec) =&gt; PatT dec -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOfPat"><span class="hs-identifier hs-var">scopeOfPat</span></a></span><span> </span><span class="annot"><span class="annottext">(PatT Type -&gt; Scope rep)
-&gt; (Target -&gt; PatT Type) -&gt; Target -&gt; Scope rep
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Target -&gt; PatT Type
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span>
</span><span id="line-118"></span><span>
</span><span id="line-119"></span><span id="local-6989586621684402861"><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#targetsScope"><span class="hs-identifier hs-type">targetsScope</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.BlockedKernel.html#DistRep"><span class="hs-identifier hs-type">DistRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684402861"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Targets"><span class="hs-identifier hs-type">Targets</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684402861"><span class="hs-identifier hs-type">rep</span></a></span></span><span>
</span><span id="line-120"></span><span id="targetsScope"><span class="annot"><span class="annottext">targetsScope :: forall rep. DistRep rep =&gt; Targets -&gt; Scope rep
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#targetsScope"><span class="hs-identifier hs-var hs-var">targetsScope</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Targets"><span class="hs-identifier hs-type">Targets</span></a></span><span> </span><span id="local-6989586621684402439"><span class="annot"><span class="annottext">Target
</span><a href="#local-6989586621684402439"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621684402438"><span class="annot"><span class="annottext">[Target]
</span><a href="#local-6989586621684402438"><span class="hs-identifier hs-var">ts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Scope rep] -&gt; Scope rep
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">([Scope rep] -&gt; Scope rep) -&gt; [Scope rep] -&gt; Scope rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Target -&gt; Scope rep) -&gt; [Target] -&gt; [Scope rep]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Target -&gt; Scope rep
forall rep. DistRep rep =&gt; Target -&gt; Scope rep
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#targetScope"><span class="hs-identifier hs-var">targetScope</span></a></span><span> </span><span class="annot"><span class="annottext">([Target] -&gt; [Scope rep]) -&gt; [Target] -&gt; [Scope rep]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Target
</span><a href="#local-6989586621684402439"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Target -&gt; [Target] -&gt; [Target]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Target]
</span><a href="#local-6989586621684402438"><span class="hs-identifier hs-var">ts</span></a></span><span>
</span><span id="line-121"></span><span>
</span><span id="line-122"></span><span class="hs-keyword">data</span><span> </span><span id="LoopNesting"><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#LoopNesting"><span class="hs-identifier hs-var">LoopNesting</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="MapNesting"><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#MapNesting"><span class="hs-identifier hs-var">MapNesting</span></a></span></span><span>
</span><span id="line-123"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="loopNestingPat"><span class="annot"><span class="annottext">LoopNesting -&gt; PatT Type
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#loopNestingPat"><span class="hs-identifier hs-var hs-var">loopNestingPat</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#PatT"><span class="hs-identifier hs-type">PatT</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-124"></span><span>    </span><span id="loopNestingAux"><span class="annot"><span class="annottext">LoopNesting -&gt; StmAux ()
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#loopNestingAux"><span class="hs-identifier hs-var hs-var">loopNestingAux</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#StmAux"><span class="hs-identifier hs-type">StmAux</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-125"></span><span>    </span><span id="loopNestingWidth"><span class="annot"><span class="annottext">LoopNesting -&gt; SubExp
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#loopNestingWidth"><span class="hs-identifier hs-var hs-var">loopNestingWidth</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-126"></span><span>    </span><span id="loopNestingParamsAndArrs"><span class="annot"><span class="annottext">LoopNesting -&gt; [(Param Type, VName)]
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#loopNestingParamsAndArrs"><span class="hs-identifier hs-var hs-var">loopNestingParamsAndArrs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Param"><span class="hs-identifier hs-type">Param</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-127"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-128"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684402415"><span id="local-6989586621684402417"><span id="local-6989586621684402431"><span class="annot"><span class="annottext">Int -&gt; LoopNesting -&gt; String -&gt; String
[LoopNesting] -&gt; String -&gt; String
LoopNesting -&gt; String
(Int -&gt; LoopNesting -&gt; String -&gt; String)
-&gt; (LoopNesting -&gt; String)
-&gt; ([LoopNesting] -&gt; String -&gt; String)
-&gt; Show LoopNesting
forall a.
(Int -&gt; a -&gt; String -&gt; String)
-&gt; (a -&gt; String) -&gt; ([a] -&gt; String -&gt; String) -&gt; Show a
showList :: [LoopNesting] -&gt; String -&gt; String
$cshowList :: [LoopNesting] -&gt; String -&gt; String
show :: LoopNesting -&gt; String
$cshow :: LoopNesting -&gt; String
showsPrec :: Int -&gt; LoopNesting -&gt; String -&gt; String
$cshowsPrec :: Int -&gt; LoopNesting -&gt; String -&gt; String
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-129"></span><span>
</span><span id="line-130"></span><span id="local-6989586621684402837"><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#scopeOfLoopNesting"><span class="hs-identifier hs-type">scopeOfLoopNesting</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#LParamInfo"><span class="hs-identifier hs-type">LParamInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684402837"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">~</span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#LoopNesting"><span class="hs-identifier hs-type">LoopNesting</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684402837"><span class="hs-identifier hs-type">rep</span></a></span></span><span>
</span><span id="line-131"></span><span id="scopeOfLoopNesting"><span class="annot"><span class="annottext">scopeOfLoopNesting :: forall rep. (LParamInfo rep ~ Type) =&gt; LoopNesting -&gt; Scope rep
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#scopeOfLoopNesting"><span class="hs-identifier hs-var hs-var">scopeOfLoopNesting</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Param Type] -&gt; Scope rep
forall rep dec. (LParamInfo rep ~ dec) =&gt; [Param dec] -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOfLParams"><span class="hs-identifier hs-var">scopeOfLParams</span></a></span><span> </span><span class="annot"><span class="annottext">([Param Type] -&gt; Scope rep)
-&gt; (LoopNesting -&gt; [Param Type]) -&gt; LoopNesting -&gt; Scope rep
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">((Param Type, VName) -&gt; Param Type)
-&gt; [(Param Type, VName)] -&gt; [Param Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Param Type, VName) -&gt; Param Type
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">([(Param Type, VName)] -&gt; [Param Type])
-&gt; (LoopNesting -&gt; [(Param Type, VName)])
-&gt; LoopNesting
-&gt; [Param Type]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">LoopNesting -&gt; [(Param Type, VName)]
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#loopNestingParamsAndArrs"><span class="hs-identifier hs-var hs-var">loopNestingParamsAndArrs</span></a></span><span>
</span><span id="line-132"></span><span>
</span><span id="line-133"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#ppLoopNesting"><span class="hs-identifier hs-type">ppLoopNesting</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#LoopNesting"><span class="hs-identifier hs-type">LoopNesting</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-134"></span><span id="ppLoopNesting"><span class="annot"><span class="annottext">ppLoopNesting :: LoopNesting -&gt; String
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#ppLoopNesting"><span class="hs-identifier hs-var hs-var">ppLoopNesting</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#MapNesting"><span class="hs-identifier hs-type">MapNesting</span></a></span><span> </span><span class="annot"><span class="annottext">PatT Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StmAux ()
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684402394"><span class="annot"><span class="annottext">[(Param Type, VName)]
</span><a href="#local-6989586621684402394"><span class="hs-identifier hs-var">params_and_arrs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-135"></span><span>  </span><span class="annot"><span class="annottext">[Param Type] -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Param Type, VName) -&gt; Param Type)
-&gt; [(Param Type, VName)] -&gt; [Param Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Param Type, VName) -&gt; Param Type
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(Param Type, VName)]
</span><a href="#local-6989586621684402394"><span class="hs-identifier hs-var">params_and_arrs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-136"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; &lt;- &quot;</span></span><span>
</span><span id="line-137"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Param Type, VName) -&gt; VName) -&gt; [(Param Type, VName)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Param Type, VName) -&gt; VName
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">[(Param Type, VName)]
</span><a href="#local-6989586621684402394"><span class="hs-identifier hs-var">params_and_arrs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-138"></span><span>
</span><span id="line-139"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#loopNestingParams"><span class="hs-identifier hs-type">loopNestingParams</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#LoopNesting"><span class="hs-identifier hs-type">LoopNesting</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Param"><span class="hs-identifier hs-type">Param</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-140"></span><span id="loopNestingParams"><span class="annot"><span class="annottext">loopNestingParams :: LoopNesting -&gt; [Param Type]
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#loopNestingParams"><span class="hs-identifier hs-var hs-var">loopNestingParams</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Param Type, VName) -&gt; Param Type)
-&gt; [(Param Type, VName)] -&gt; [Param Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Param Type, VName) -&gt; Param Type
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">([(Param Type, VName)] -&gt; [Param Type])
-&gt; (LoopNesting -&gt; [(Param Type, VName)])
-&gt; LoopNesting
-&gt; [Param Type]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">LoopNesting -&gt; [(Param Type, VName)]
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#loopNestingParamsAndArrs"><span class="hs-identifier hs-var hs-var">loopNestingParamsAndArrs</span></a></span><span>
</span><span id="line-141"></span><span>
</span><span id="line-142"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#FreeIn"><span class="hs-identifier hs-type">FreeIn</span></a></span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#LoopNesting"><span class="hs-identifier hs-type">LoopNesting</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-143"></span><span>  </span><span id="local-6989586621684402365"><span class="annot"><span class="annottext">freeIn' :: LoopNesting -&gt; FV
</span><a href="Futhark.IR.Prop.Names.html#freeIn%27"><span class="hs-identifier hs-var hs-var hs-var hs-var">freeIn'</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#MapNesting"><span class="hs-identifier hs-type">MapNesting</span></a></span><span> </span><span id="local-6989586621684402363"><span class="annot"><span class="annottext">PatT Type
</span><a href="#local-6989586621684402363"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684402362"><span class="annot"><span class="annottext">StmAux ()
</span><a href="#local-6989586621684402362"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span id="local-6989586621684402361"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684402361"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684402360"><span class="annot"><span class="annottext">[(Param Type, VName)]
</span><a href="#local-6989586621684402360"><span class="hs-identifier hs-var">params_and_arrs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-144"></span><span>    </span><span class="annot"><span class="annottext">PatT Type -&gt; FV
forall a. FreeIn a =&gt; a -&gt; FV
</span><a href="Futhark.IR.Prop.Names.html#freeIn%27"><span class="hs-identifier hs-var">freeIn'</span></a></span><span> </span><span class="annot"><span class="annottext">PatT Type
</span><a href="#local-6989586621684402363"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">FV -&gt; FV -&gt; FV
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">StmAux () -&gt; FV
forall a. FreeIn a =&gt; a -&gt; FV
</span><a href="Futhark.IR.Prop.Names.html#freeIn%27"><span class="hs-identifier hs-var">freeIn'</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux ()
</span><a href="#local-6989586621684402362"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">FV -&gt; FV -&gt; FV
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; FV
forall a. FreeIn a =&gt; a -&gt; FV
</span><a href="Futhark.IR.Prop.Names.html#freeIn%27"><span class="hs-identifier hs-var">freeIn'</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684402361"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">FV -&gt; FV -&gt; FV
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[(Param Type, VName)] -&gt; FV
forall a. FreeIn a =&gt; a -&gt; FV
</span><a href="Futhark.IR.Prop.Names.html#freeIn%27"><span class="hs-identifier hs-var">freeIn'</span></a></span><span> </span><span class="annot"><span class="annottext">[(Param Type, VName)]
</span><a href="#local-6989586621684402360"><span class="hs-identifier hs-var">params_and_arrs</span></a></span><span>
</span><span id="line-145"></span><span>
</span><span id="line-146"></span><span class="hs-keyword">data</span><span> </span><span id="Nesting"><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Nesting"><span class="hs-identifier hs-var">Nesting</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Nesting"><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Nesting"><span class="hs-identifier hs-var">Nesting</span></a></span></span><span>
</span><span id="line-147"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="nestingLetBound"><span class="annot"><span class="annottext">Nesting -&gt; Names
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#nestingLetBound"><span class="hs-identifier hs-var hs-var">nestingLetBound</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-148"></span><span>    </span><span id="nestingLoop"><span class="annot"><span class="annottext">Nesting -&gt; LoopNesting
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#nestingLoop"><span class="hs-identifier hs-var hs-var">nestingLoop</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#LoopNesting"><span class="hs-identifier hs-type">LoopNesting</span></a></span><span>
</span><span id="line-149"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-150"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684402347"><span id="local-6989586621684402349"><span id="local-6989586621684402355"><span class="annot"><span class="annottext">Int -&gt; Nesting -&gt; String -&gt; String
[Nesting] -&gt; String -&gt; String
Nesting -&gt; String
(Int -&gt; Nesting -&gt; String -&gt; String)
-&gt; (Nesting -&gt; String)
-&gt; ([Nesting] -&gt; String -&gt; String)
-&gt; Show Nesting
forall a.
(Int -&gt; a -&gt; String -&gt; String)
-&gt; (a -&gt; String) -&gt; ([a] -&gt; String -&gt; String) -&gt; Show a
showList :: [Nesting] -&gt; String -&gt; String
$cshowList :: [Nesting] -&gt; String -&gt; String
show :: Nesting -&gt; String
$cshow :: Nesting -&gt; String
showsPrec :: Int -&gt; Nesting -&gt; String -&gt; String
$cshowsPrec :: Int -&gt; Nesting -&gt; String -&gt; String
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-151"></span><span>
</span><span id="line-152"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#letBindInNesting"><span class="hs-identifier hs-type">letBindInNesting</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Nesting"><span class="hs-identifier hs-type">Nesting</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Nesting"><span class="hs-identifier hs-type">Nesting</span></a></span><span>
</span><span id="line-153"></span><span id="letBindInNesting"><span class="annot"><span class="annottext">letBindInNesting :: Names -&gt; Nesting -&gt; Nesting
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#letBindInNesting"><span class="hs-identifier hs-var hs-var">letBindInNesting</span></a></span></span><span> </span><span id="local-6989586621684402345"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684402345"><span class="hs-identifier hs-var">newnames</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Nesting"><span class="hs-identifier hs-type">Nesting</span></a></span><span> </span><span id="local-6989586621684402344"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684402344"><span class="hs-identifier hs-var">oldnames</span></a></span></span><span> </span><span id="local-6989586621684402343"><span class="annot"><span class="annottext">LoopNesting
</span><a href="#local-6989586621684402343"><span class="hs-identifier hs-var">loop</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-154"></span><span>  </span><span class="annot"><span class="annottext">Names -&gt; LoopNesting -&gt; Nesting
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#Nesting"><span class="hs-identifier hs-var">Nesting</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684402344"><span class="hs-identifier hs-var">oldnames</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684402345"><span class="hs-identifier hs-var">newnames</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LoopNesting
</span><a href="#local-6989586621684402343"><span class="hs-identifier hs-var">loop</span></a></span><span>
</span><span id="line-155"></span><span class="hs-comment">-- ^ First pair element is the very innermost (&quot;current&quot;) nest.  In</span><span>
</span><span id="line-156"></span><span class="hs-comment">-- the list, the outermost nest comes first.</span><span>
</span><span id="line-157"></span><span>
</span><span id="line-158"></span><span class="hs-keyword">type</span><span> </span><span id="Nestings"><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Nestings"><span class="hs-identifier hs-var">Nestings</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Nesting"><span class="hs-identifier hs-type">Nesting</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Nesting"><span class="hs-identifier hs-type">Nesting</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-159"></span><span>
</span><span id="line-160"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#ppNestings"><span class="hs-identifier hs-type">ppNestings</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Nestings"><span class="hs-identifier hs-type">Nestings</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-161"></span><span id="ppNestings"><span class="annot"><span class="annottext">ppNestings :: Nestings -&gt; String
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#ppNestings"><span class="hs-identifier hs-var hs-var">ppNestings</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684402342"><span class="annot"><span class="annottext">Nesting
</span><a href="#local-6989586621684402342"><span class="hs-identifier hs-var">nesting</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684402341"><span class="annot"><span class="annottext">[Nesting]
</span><a href="#local-6989586621684402341"><span class="hs-identifier hs-var">nestings</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-162"></span><span>  </span><span class="annot"><span class="annottext">[String] -&gt; String
</span><span class="hs-identifier hs-var">unlines</span></span><span> </span><span class="annot"><span class="annottext">([String] -&gt; String) -&gt; [String] -&gt; String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Nesting -&gt; String) -&gt; [Nesting] -&gt; [String]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Nesting -&gt; String
</span><a href="#local-6989586621684402340"><span class="hs-identifier hs-var">ppNesting</span></a></span><span> </span><span class="annot"><span class="annottext">([Nesting] -&gt; [String]) -&gt; [Nesting] -&gt; [String]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Nesting]
</span><a href="#local-6989586621684402341"><span class="hs-identifier hs-var">nestings</span></a></span><span> </span><span class="annot"><span class="annottext">[Nesting] -&gt; [Nesting] -&gt; [Nesting]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Nesting
</span><a href="#local-6989586621684402342"><span class="hs-identifier hs-var">nesting</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-163"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-164"></span><span>    </span><span id="local-6989586621684402340"><span class="annot"><span class="annottext">ppNesting :: Nesting -&gt; String
</span><a href="#local-6989586621684402340"><span class="hs-identifier hs-var hs-var">ppNesting</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Nesting"><span class="hs-identifier hs-type">Nesting</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684402339"><span class="annot"><span class="annottext">LoopNesting
</span><a href="#local-6989586621684402339"><span class="hs-identifier hs-var">loop</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LoopNesting -&gt; String
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#ppLoopNesting"><span class="hs-identifier hs-var">ppLoopNesting</span></a></span><span> </span><span class="annot"><span class="annottext">LoopNesting
</span><a href="#local-6989586621684402339"><span class="hs-identifier hs-var">loop</span></a></span><span>
</span><span id="line-165"></span><span>
</span><span id="line-166"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#singleNesting"><span class="hs-identifier hs-type">singleNesting</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Nesting"><span class="hs-identifier hs-type">Nesting</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Nestings"><span class="hs-identifier hs-type">Nestings</span></a></span><span>
</span><span id="line-167"></span><span id="singleNesting"><span class="annot"><span class="annottext">singleNesting :: Nesting -&gt; Nestings
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#singleNesting"><span class="hs-identifier hs-var hs-var">singleNesting</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-special">,</span></span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-168"></span><span>
</span><span id="line-169"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#pushInnerNesting"><span class="hs-identifier hs-type">pushInnerNesting</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Nesting"><span class="hs-identifier hs-type">Nesting</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Nestings"><span class="hs-identifier hs-type">Nestings</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Nestings"><span class="hs-identifier hs-type">Nestings</span></a></span><span>
</span><span id="line-170"></span><span id="pushInnerNesting"><span class="annot"><span class="annottext">pushInnerNesting :: Nesting -&gt; Nestings -&gt; Nestings
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#pushInnerNesting"><span class="hs-identifier hs-var hs-var">pushInnerNesting</span></a></span></span><span> </span><span id="local-6989586621684402338"><span class="annot"><span class="annottext">Nesting
</span><a href="#local-6989586621684402338"><span class="hs-identifier hs-var">nesting</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684402337"><span class="annot"><span class="annottext">Nesting
</span><a href="#local-6989586621684402337"><span class="hs-identifier hs-var">inner_nesting</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684402336"><span class="annot"><span class="annottext">[Nesting]
</span><a href="#local-6989586621684402336"><span class="hs-identifier hs-var">nestings</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-171"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Nesting
</span><a href="#local-6989586621684402338"><span class="hs-identifier hs-var">nesting</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Nesting]
</span><a href="#local-6989586621684402336"><span class="hs-identifier hs-var">nestings</span></a></span><span> </span><span class="annot"><span class="annottext">[Nesting] -&gt; [Nesting] -&gt; [Nesting]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Nesting
</span><a href="#local-6989586621684402337"><span class="hs-identifier hs-var">inner_nesting</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-172"></span><span>
</span><span id="line-173"></span><span class="hs-comment">-- | Both parameters and let-bound.</span><span>
</span><span id="line-174"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#boundInNesting"><span class="hs-identifier hs-type">boundInNesting</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Nesting"><span class="hs-identifier hs-type">Nesting</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span>
</span><span id="line-175"></span><span id="boundInNesting"><span class="annot"><span class="annottext">boundInNesting :: Nesting -&gt; Names
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#boundInNesting"><span class="hs-identifier hs-var hs-var">boundInNesting</span></a></span></span><span> </span><span id="local-6989586621684402334"><span class="annot"><span class="annottext">Nesting
</span><a href="#local-6989586621684402334"><span class="hs-identifier hs-var">nesting</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-176"></span><span>  </span><span class="annot"><span class="annottext">[VName] -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#namesFromList"><span class="hs-identifier hs-var">namesFromList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Param Type -&gt; VName) -&gt; [Param Type] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Param Type -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LoopNesting -&gt; [Param Type]
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#loopNestingParams"><span class="hs-identifier hs-var">loopNestingParams</span></a></span><span> </span><span class="annot"><span class="annottext">LoopNesting
</span><a href="#local-6989586621684402331"><span class="hs-identifier hs-var">loop</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-177"></span><span>    </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Nesting -&gt; Names
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#nestingLetBound"><span class="hs-identifier hs-var hs-var">nestingLetBound</span></a></span><span> </span><span class="annot"><span class="annottext">Nesting
</span><a href="#local-6989586621684402334"><span class="hs-identifier hs-var">nesting</span></a></span><span>
</span><span id="line-178"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-179"></span><span>    </span><span id="local-6989586621684402331"><span class="annot"><span class="annottext">loop :: LoopNesting
</span><a href="#local-6989586621684402331"><span class="hs-identifier hs-var hs-var">loop</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Nesting -&gt; LoopNesting
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#nestingLoop"><span class="hs-identifier hs-var hs-var">nestingLoop</span></a></span><span> </span><span class="annot"><span class="annottext">Nesting
</span><a href="#local-6989586621684402334"><span class="hs-identifier hs-var">nesting</span></a></span><span>
</span><span id="line-180"></span><span>
</span><span id="line-181"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#letBindInInnerNesting"><span class="hs-identifier hs-type">letBindInInnerNesting</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Nestings"><span class="hs-identifier hs-type">Nestings</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Nestings"><span class="hs-identifier hs-type">Nestings</span></a></span><span>
</span><span id="line-182"></span><span id="letBindInInnerNesting"><span class="annot"><span class="annottext">letBindInInnerNesting :: Names -&gt; Nestings -&gt; Nestings
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#letBindInInnerNesting"><span class="hs-identifier hs-var hs-var">letBindInInnerNesting</span></a></span></span><span> </span><span id="local-6989586621684402330"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684402330"><span class="hs-identifier hs-var">names</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684402329"><span class="annot"><span class="annottext">Nesting
</span><a href="#local-6989586621684402329"><span class="hs-identifier hs-var">nest</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684402328"><span class="annot"><span class="annottext">[Nesting]
</span><a href="#local-6989586621684402328"><span class="hs-identifier hs-var">nestings</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-183"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Names -&gt; Nesting -&gt; Nesting
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#letBindInNesting"><span class="hs-identifier hs-var">letBindInNesting</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684402330"><span class="hs-identifier hs-var">names</span></a></span><span> </span><span class="annot"><span class="annottext">Nesting
</span><a href="#local-6989586621684402329"><span class="hs-identifier hs-var">nest</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Nesting]
</span><a href="#local-6989586621684402328"><span class="hs-identifier hs-var">nestings</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-184"></span><span>
</span><span id="line-185"></span><span class="hs-comment">-- | Note: first element is *outermost* nesting.  This is different</span><span>
</span><span id="line-186"></span><span class="hs-comment">-- from the similar types elsewhere!</span><span>
</span><span id="line-187"></span><span class="hs-keyword">type</span><span> </span><span id="KernelNest"><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#KernelNest"><span class="hs-identifier hs-var">KernelNest</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#LoopNesting"><span class="hs-identifier hs-type">LoopNesting</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#LoopNesting"><span class="hs-identifier hs-type">LoopNesting</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-188"></span><span>
</span><span id="line-189"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#ppKernelNest"><span class="hs-identifier hs-type">ppKernelNest</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#KernelNest"><span class="hs-identifier hs-type">KernelNest</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-190"></span><span id="ppKernelNest"><span class="annot"><span class="annottext">ppKernelNest :: KernelNest -&gt; String
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#ppKernelNest"><span class="hs-identifier hs-var hs-var">ppKernelNest</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684402327"><span class="annot"><span class="annottext">LoopNesting
</span><a href="#local-6989586621684402327"><span class="hs-identifier hs-var">nesting</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684402326"><span class="annot"><span class="annottext">[LoopNesting]
</span><a href="#local-6989586621684402326"><span class="hs-identifier hs-var">nestings</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-191"></span><span>  </span><span class="annot"><span class="annottext">[String] -&gt; String
</span><span class="hs-identifier hs-var">unlines</span></span><span> </span><span class="annot"><span class="annottext">([String] -&gt; String) -&gt; [String] -&gt; String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(LoopNesting -&gt; String) -&gt; [LoopNesting] -&gt; [String]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">LoopNesting -&gt; String
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#ppLoopNesting"><span class="hs-identifier hs-var">ppLoopNesting</span></a></span><span> </span><span class="annot"><span class="annottext">([LoopNesting] -&gt; [String]) -&gt; [LoopNesting] -&gt; [String]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LoopNesting
</span><a href="#local-6989586621684402327"><span class="hs-identifier hs-var">nesting</span></a></span><span> </span><span class="annot"><span class="annottext">LoopNesting -&gt; [LoopNesting] -&gt; [LoopNesting]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[LoopNesting]
</span><a href="#local-6989586621684402326"><span class="hs-identifier hs-var">nestings</span></a></span><span>
</span><span id="line-192"></span><span>
</span><span id="line-193"></span><span class="hs-comment">-- | Retrieve the innermost kernel nesting.</span><span>
</span><span id="line-194"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#innermostKernelNesting"><span class="hs-identifier hs-type">innermostKernelNesting</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#KernelNest"><span class="hs-identifier hs-type">KernelNest</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#LoopNesting"><span class="hs-identifier hs-type">LoopNesting</span></a></span><span>
</span><span id="line-195"></span><span id="innermostKernelNesting"><span class="annot"><span class="annottext">innermostKernelNesting :: KernelNest -&gt; LoopNesting
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#innermostKernelNesting"><span class="hs-identifier hs-var hs-var">innermostKernelNesting</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684402325"><span class="annot"><span class="annottext">LoopNesting
</span><a href="#local-6989586621684402325"><span class="hs-identifier hs-var">nest</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684402324"><span class="annot"><span class="annottext">[LoopNesting]
</span><a href="#local-6989586621684402324"><span class="hs-identifier hs-var">nests</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-196"></span><span>  </span><span class="annot"><span class="annottext">LoopNesting -&gt; Maybe LoopNesting -&gt; LoopNesting
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">LoopNesting
</span><a href="#local-6989586621684402325"><span class="hs-identifier hs-var">nest</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe LoopNesting -&gt; LoopNesting)
-&gt; Maybe LoopNesting -&gt; LoopNesting
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[LoopNesting] -&gt; Maybe LoopNesting
forall a. [a] -&gt; Maybe a
</span><a href="Futhark.Util.html#maybeHead"><span class="hs-identifier hs-var">maybeHead</span></a></span><span> </span><span class="annot"><span class="annottext">([LoopNesting] -&gt; Maybe LoopNesting)
-&gt; [LoopNesting] -&gt; Maybe LoopNesting
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[LoopNesting] -&gt; [LoopNesting]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[LoopNesting]
</span><a href="#local-6989586621684402324"><span class="hs-identifier hs-var">nests</span></a></span><span>
</span><span id="line-197"></span><span>
</span><span id="line-198"></span><span class="hs-comment">-- | Add new outermost nesting, pushing the current outermost to the</span><span>
</span><span id="line-199"></span><span class="hs-comment">-- list, also taking care to swap patterns if necessary.</span><span>
</span><span id="line-200"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#pushKernelNesting"><span class="hs-identifier hs-type">pushKernelNesting</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Target"><span class="hs-identifier hs-type">Target</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#LoopNesting"><span class="hs-identifier hs-type">LoopNesting</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#KernelNest"><span class="hs-identifier hs-type">KernelNest</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#KernelNest"><span class="hs-identifier hs-type">KernelNest</span></a></span><span>
</span><span id="line-201"></span><span id="pushKernelNesting"><span class="annot"><span class="annottext">pushKernelNesting :: Target -&gt; LoopNesting -&gt; KernelNest -&gt; KernelNest
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#pushKernelNesting"><span class="hs-identifier hs-var hs-var">pushKernelNesting</span></a></span></span><span> </span><span id="local-6989586621684402321"><span class="annot"><span class="annottext">Target
</span><a href="#local-6989586621684402321"><span class="hs-identifier hs-var">target</span></a></span></span><span> </span><span id="local-6989586621684402320"><span class="annot"><span class="annottext">LoopNesting
</span><a href="#local-6989586621684402320"><span class="hs-identifier hs-var">newnest</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684402319"><span class="annot"><span class="annottext">LoopNesting
</span><a href="#local-6989586621684402319"><span class="hs-identifier hs-var">nest</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684402318"><span class="annot"><span class="annottext">[LoopNesting]
</span><a href="#local-6989586621684402318"><span class="hs-identifier hs-var">nests</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-202"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">LoopNesting -&gt; Target -&gt; PatT Type -&gt; LoopNesting
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#fixNestingPatOrder"><span class="hs-identifier hs-var">fixNestingPatOrder</span></a></span><span> </span><span class="annot"><span class="annottext">LoopNesting
</span><a href="#local-6989586621684402320"><span class="hs-identifier hs-var">newnest</span></a></span><span> </span><span class="annot"><span class="annottext">Target
</span><a href="#local-6989586621684402321"><span class="hs-identifier hs-var">target</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LoopNesting -&gt; PatT Type
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#loopNestingPat"><span class="hs-identifier hs-var hs-var">loopNestingPat</span></a></span><span> </span><span class="annot"><span class="annottext">LoopNesting
</span><a href="#local-6989586621684402319"><span class="hs-identifier hs-var">nest</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-203"></span><span>    </span><span class="annot"><span class="annottext">LoopNesting
</span><a href="#local-6989586621684402319"><span class="hs-identifier hs-var">nest</span></a></span><span> </span><span class="annot"><span class="annottext">LoopNesting -&gt; [LoopNesting] -&gt; [LoopNesting]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[LoopNesting]
</span><a href="#local-6989586621684402318"><span class="hs-identifier hs-var">nests</span></a></span><span>
</span><span id="line-204"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-205"></span><span>
</span><span id="line-206"></span><span class="hs-comment">-- | Add new innermost nesting, pushing the current outermost to the</span><span>
</span><span id="line-207"></span><span class="hs-comment">-- list.  It is important that the 'Target' has the right order</span><span>
</span><span id="line-208"></span><span class="hs-comment">-- (non-permuted compared to what is expected by the outer nests).</span><span>
</span><span id="line-209"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#pushInnerKernelNesting"><span class="hs-identifier hs-type">pushInnerKernelNesting</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Target"><span class="hs-identifier hs-type">Target</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#LoopNesting"><span class="hs-identifier hs-type">LoopNesting</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#KernelNest"><span class="hs-identifier hs-type">KernelNest</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#KernelNest"><span class="hs-identifier hs-type">KernelNest</span></a></span><span>
</span><span id="line-210"></span><span id="pushInnerKernelNesting"><span class="annot"><span class="annottext">pushInnerKernelNesting :: Target -&gt; LoopNesting -&gt; KernelNest -&gt; KernelNest
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#pushInnerKernelNesting"><span class="hs-identifier hs-var hs-var">pushInnerKernelNesting</span></a></span></span><span> </span><span id="local-6989586621684402316"><span class="annot"><span class="annottext">Target
</span><a href="#local-6989586621684402316"><span class="hs-identifier hs-var">target</span></a></span></span><span> </span><span id="local-6989586621684402315"><span class="annot"><span class="annottext">LoopNesting
</span><a href="#local-6989586621684402315"><span class="hs-identifier hs-var">newnest</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684402314"><span class="annot"><span class="annottext">LoopNesting
</span><a href="#local-6989586621684402314"><span class="hs-identifier hs-var">nest</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684402313"><span class="annot"><span class="annottext">[LoopNesting]
</span><a href="#local-6989586621684402313"><span class="hs-identifier hs-var">nests</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-211"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LoopNesting
</span><a href="#local-6989586621684402314"><span class="hs-identifier hs-var">nest</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[LoopNesting]
</span><a href="#local-6989586621684402313"><span class="hs-identifier hs-var">nests</span></a></span><span> </span><span class="annot"><span class="annottext">[LoopNesting] -&gt; [LoopNesting] -&gt; [LoopNesting]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">LoopNesting -&gt; Target -&gt; PatT Type -&gt; LoopNesting
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#fixNestingPatOrder"><span class="hs-identifier hs-var">fixNestingPatOrder</span></a></span><span> </span><span class="annot"><span class="annottext">LoopNesting
</span><a href="#local-6989586621684402315"><span class="hs-identifier hs-var">newnest</span></a></span><span> </span><span class="annot"><span class="annottext">Target
</span><a href="#local-6989586621684402316"><span class="hs-identifier hs-var">target</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LoopNesting -&gt; PatT Type
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#loopNestingPat"><span class="hs-identifier hs-var hs-var">loopNestingPat</span></a></span><span> </span><span class="annot"><span class="annottext">LoopNesting
</span><a href="#local-6989586621684402312"><span class="hs-identifier hs-var">innermost</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-212"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-213"></span><span>    </span><span id="local-6989586621684402312"><span class="annot"><span class="annottext">innermost :: LoopNesting
</span><a href="#local-6989586621684402312"><span class="hs-identifier hs-var hs-var">innermost</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[LoopNesting] -&gt; [LoopNesting]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[LoopNesting]
</span><a href="#local-6989586621684402313"><span class="hs-identifier hs-var">nests</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-214"></span><span>      </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LoopNesting
</span><a href="#local-6989586621684402314"><span class="hs-identifier hs-var">nest</span></a></span><span>
</span><span id="line-215"></span><span>      </span><span id="local-6989586621684402311"><span class="annot"><span class="annottext">LoopNesting
</span><a href="#local-6989586621684402311"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><span class="annottext">[LoopNesting]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LoopNesting
</span><a href="#local-6989586621684402311"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-216"></span><span>
</span><span id="line-217"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#fixNestingPatOrder"><span class="hs-identifier hs-type">fixNestingPatOrder</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#LoopNesting"><span class="hs-identifier hs-type">LoopNesting</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Target"><span class="hs-identifier hs-type">Target</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#PatT"><span class="hs-identifier hs-type">PatT</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#LoopNesting"><span class="hs-identifier hs-type">LoopNesting</span></a></span><span>
</span><span id="line-218"></span><span id="fixNestingPatOrder"><span class="annot"><span class="annottext">fixNestingPatOrder :: LoopNesting -&gt; Target -&gt; PatT Type -&gt; LoopNesting
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#fixNestingPatOrder"><span class="hs-identifier hs-var hs-var">fixNestingPatOrder</span></a></span></span><span> </span><span id="local-6989586621684402310"><span class="annot"><span class="annottext">LoopNesting
</span><a href="#local-6989586621684402310"><span class="hs-identifier hs-var">nest</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatT Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684402309"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684402309"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684402308"><span class="annot"><span class="annottext">PatT Type
</span><a href="#local-6989586621684402308"><span class="hs-identifier hs-var">inner_pat</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-219"></span><span>  </span><span class="annot"><span class="annottext">LoopNesting
</span><a href="#local-6989586621684402310"><span class="hs-identifier hs-var">nest</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">loopNestingPat :: PatT Type
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#loopNestingPat"><span class="hs-identifier hs-var">loopNestingPat</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Ident] -&gt; PatT Type
</span><a href="Futhark.IR.Prop.Patterns.html#basicPat"><span class="hs-identifier hs-var">basicPat</span></a></span><span> </span><span class="annot"><span class="annottext">[Ident]
</span><a href="#local-6989586621684402306"><span class="hs-identifier hs-var">pat'</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-220"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-221"></span><span>    </span><span id="local-6989586621684402305"><span class="annot"><span class="annottext">pat :: PatT Type
</span><a href="#local-6989586621684402305"><span class="hs-identifier hs-var hs-var">pat</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LoopNesting -&gt; PatT Type
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#loopNestingPat"><span class="hs-identifier hs-var hs-var">loopNestingPat</span></a></span><span> </span><span class="annot"><span class="annottext">LoopNesting
</span><a href="#local-6989586621684402310"><span class="hs-identifier hs-var">nest</span></a></span><span>
</span><span id="line-222"></span><span>    </span><span id="local-6989586621684402306"><span class="annot"><span class="annottext">pat' :: [Ident]
</span><a href="#local-6989586621684402306"><span class="hs-identifier hs-var hs-var">pat'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Ident, SubExpRes) -&gt; Ident) -&gt; [(Ident, SubExpRes)] -&gt; [Ident]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Ident, SubExpRes) -&gt; Ident
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(Ident, SubExpRes)]
</span><a href="#local-6989586621684402304"><span class="hs-identifier hs-var">fixed_target</span></a></span><span>
</span><span id="line-223"></span><span>    </span><span id="local-6989586621684402304"><span class="annot"><span class="annottext">fixed_target :: [(Ident, SubExpRes)]
</span><a href="#local-6989586621684402304"><span class="hs-identifier hs-var hs-var">fixed_target</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Ident, SubExpRes) -&gt; Int)
-&gt; [(Ident, SubExpRes)] -&gt; [(Ident, SubExpRes)]
forall b a. Ord b =&gt; (a -&gt; b) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">sortOn</span></span><span> </span><span class="annot"><span class="annottext">(Ident, SubExpRes) -&gt; Int
</span><a href="#local-6989586621684402303"><span class="hs-identifier hs-var">posInInnerPat</span></a></span><span> </span><span class="annot"><span class="annottext">([(Ident, SubExpRes)] -&gt; [(Ident, SubExpRes)])
-&gt; [(Ident, SubExpRes)] -&gt; [(Ident, SubExpRes)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Ident] -&gt; Result -&gt; [(Ident, SubExpRes)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatT Type -&gt; [Ident]
forall dec. Typed dec =&gt; PatT dec -&gt; [Ident]
</span><a href="Futhark.IR.Prop.Patterns.html#patIdents"><span class="hs-identifier hs-var">patIdents</span></a></span><span> </span><span class="annot"><span class="annottext">PatT Type
</span><a href="#local-6989586621684402305"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684402309"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-224"></span><span>    </span><span id="local-6989586621684402303"><span class="annot"><span class="annottext">posInInnerPat :: (Ident, SubExpRes) -&gt; Int
</span><a href="#local-6989586621684402303"><span class="hs-identifier hs-var hs-var">posInInnerPat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ident
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-type">SubExpRes</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684402299"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684402299"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Maybe Int -&gt; Int
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Int -&gt; Int) -&gt; Maybe Int -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [VName] -&gt; Maybe Int
forall a. Eq a =&gt; a -&gt; [a] -&gt; Maybe Int
</span><span class="hs-identifier hs-var">elemIndex</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684402299"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; Maybe Int) -&gt; [VName] -&gt; Maybe Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatT Type -&gt; [VName]
forall dec. PatT dec -&gt; [VName]
</span><a href="Futhark.IR.Prop.Patterns.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="annot"><span class="annottext">PatT Type
</span><a href="#local-6989586621684402308"><span class="hs-identifier hs-var">inner_pat</span></a></span><span>
</span><span id="line-225"></span><span>    </span><span class="annot"><a href="#local-6989586621684402303"><span class="hs-identifier hs-var">posInInnerPat</span></a></span><span> </span><span class="annot"><span class="annottext">(Ident, SubExpRes)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-226"></span><span>
</span><span id="line-227"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#newKernel"><span class="hs-identifier hs-type">newKernel</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#LoopNesting"><span class="hs-identifier hs-type">LoopNesting</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#KernelNest"><span class="hs-identifier hs-type">KernelNest</span></a></span><span>
</span><span id="line-228"></span><span id="newKernel"><span class="annot"><span class="annottext">newKernel :: LoopNesting -&gt; KernelNest
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#newKernel"><span class="hs-identifier hs-var hs-var">newKernel</span></a></span></span><span> </span><span id="local-6989586621684402297"><span class="annot"><span class="annottext">LoopNesting
</span><a href="#local-6989586621684402297"><span class="hs-identifier hs-var">nest</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LoopNesting
</span><a href="#local-6989586621684402297"><span class="hs-identifier hs-var">nest</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-229"></span><span>
</span><span id="line-230"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#kernelNestLoops"><span class="hs-identifier hs-type">kernelNestLoops</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#KernelNest"><span class="hs-identifier hs-type">KernelNest</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#LoopNesting"><span class="hs-identifier hs-type">LoopNesting</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-231"></span><span id="kernelNestLoops"><span class="annot"><span class="annottext">kernelNestLoops :: KernelNest -&gt; [LoopNesting]
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#kernelNestLoops"><span class="hs-identifier hs-var hs-var">kernelNestLoops</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684402296"><span class="annot"><span class="annottext">LoopNesting
</span><a href="#local-6989586621684402296"><span class="hs-identifier hs-var">loop</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684402295"><span class="annot"><span class="annottext">[LoopNesting]
</span><a href="#local-6989586621684402295"><span class="hs-identifier hs-var">loops</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LoopNesting
</span><a href="#local-6989586621684402296"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="annot"><span class="annottext">LoopNesting -&gt; [LoopNesting] -&gt; [LoopNesting]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[LoopNesting]
</span><a href="#local-6989586621684402295"><span class="hs-identifier hs-var">loops</span></a></span><span>
</span><span id="line-232"></span><span>
</span><span id="line-233"></span><span id="local-6989586621684402811"><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#scopeOfKernelNest"><span class="hs-identifier hs-type">scopeOfKernelNest</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Rep.html#LParamInfo"><span class="hs-identifier hs-type">LParamInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684402811"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">~</span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#KernelNest"><span class="hs-identifier hs-type">KernelNest</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684402811"><span class="hs-identifier hs-type">rep</span></a></span></span><span>
</span><span id="line-234"></span><span id="scopeOfKernelNest"><span class="annot"><span class="annottext">scopeOfKernelNest :: forall rep. (LParamInfo rep ~ Type) =&gt; KernelNest -&gt; Scope rep
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#scopeOfKernelNest"><span class="hs-identifier hs-var hs-var">scopeOfKernelNest</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(LoopNesting -&gt; Scope rep) -&gt; [LoopNesting] -&gt; Scope rep
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">LoopNesting -&gt; Scope rep
forall rep. (LParamInfo rep ~ Type) =&gt; LoopNesting -&gt; Scope rep
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#scopeOfLoopNesting"><span class="hs-identifier hs-var">scopeOfLoopNesting</span></a></span><span> </span><span class="annot"><span class="annottext">([LoopNesting] -&gt; Scope rep)
-&gt; (KernelNest -&gt; [LoopNesting]) -&gt; KernelNest -&gt; Scope rep
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">KernelNest -&gt; [LoopNesting]
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#kernelNestLoops"><span class="hs-identifier hs-var">kernelNestLoops</span></a></span><span>
</span><span id="line-235"></span><span>
</span><span id="line-236"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#boundInKernelNest"><span class="hs-identifier hs-type">boundInKernelNest</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#KernelNest"><span class="hs-identifier hs-type">KernelNest</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span>
</span><span id="line-237"></span><span id="boundInKernelNest"><span class="annot"><span class="annottext">boundInKernelNest :: KernelNest -&gt; Names
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#boundInKernelNest"><span class="hs-identifier hs-var hs-var">boundInKernelNest</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Names] -&gt; Names
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">([Names] -&gt; Names)
-&gt; (KernelNest -&gt; [Names]) -&gt; KernelNest -&gt; Names
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">KernelNest -&gt; [Names]
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#boundInKernelNests"><span class="hs-identifier hs-var">boundInKernelNests</span></a></span><span>
</span><span id="line-238"></span><span>
</span><span id="line-239"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#boundInKernelNests"><span class="hs-identifier hs-type">boundInKernelNests</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#KernelNest"><span class="hs-identifier hs-type">KernelNest</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-240"></span><span id="boundInKernelNests"><span class="annot"><span class="annottext">boundInKernelNests :: KernelNest -&gt; [Names]
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#boundInKernelNests"><span class="hs-identifier hs-var hs-var">boundInKernelNests</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-241"></span><span>  </span><span class="annot"><span class="annottext">(LoopNesting -&gt; Names) -&gt; [LoopNesting] -&gt; [Names]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#namesFromList"><span class="hs-identifier hs-var">namesFromList</span></a></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; Names)
-&gt; (LoopNesting -&gt; [VName]) -&gt; LoopNesting -&gt; Names
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">((Param Type, VName) -&gt; VName) -&gt; [(Param Type, VName)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param Type -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">(Param Type -&gt; VName)
-&gt; ((Param Type, VName) -&gt; Param Type)
-&gt; (Param Type, VName)
-&gt; VName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Param Type, VName) -&gt; Param Type
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(Param Type, VName)] -&gt; [VName])
-&gt; (LoopNesting -&gt; [(Param Type, VName)]) -&gt; LoopNesting -&gt; [VName]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">LoopNesting -&gt; [(Param Type, VName)]
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#loopNestingParamsAndArrs"><span class="hs-identifier hs-var hs-var">loopNestingParamsAndArrs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-242"></span><span>    </span><span class="annot"><span class="annottext">([LoopNesting] -&gt; [Names])
-&gt; (KernelNest -&gt; [LoopNesting]) -&gt; KernelNest -&gt; [Names]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">KernelNest -&gt; [LoopNesting]
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#kernelNestLoops"><span class="hs-identifier hs-var">kernelNestLoops</span></a></span><span>
</span><span id="line-243"></span><span>
</span><span id="line-244"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#kernelNestWidths"><span class="hs-identifier hs-type">kernelNestWidths</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#KernelNest"><span class="hs-identifier hs-type">KernelNest</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-245"></span><span id="kernelNestWidths"><span class="annot"><span class="annottext">kernelNestWidths :: KernelNest -&gt; [SubExp]
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#kernelNestWidths"><span class="hs-identifier hs-var hs-var">kernelNestWidths</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(LoopNesting -&gt; SubExp) -&gt; [LoopNesting] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">LoopNesting -&gt; SubExp
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#loopNestingWidth"><span class="hs-identifier hs-var hs-var">loopNestingWidth</span></a></span><span> </span><span class="annot"><span class="annottext">([LoopNesting] -&gt; [SubExp])
-&gt; (KernelNest -&gt; [LoopNesting]) -&gt; KernelNest -&gt; [SubExp]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">KernelNest -&gt; [LoopNesting]
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#kernelNestLoops"><span class="hs-identifier hs-var">kernelNestLoops</span></a></span><span>
</span><span id="line-246"></span><span>
</span><span id="line-247"></span><span id="local-6989586621684402805"><span id="local-6989586621684402806"><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#constructKernel"><span class="hs-identifier hs-type">constructKernel</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-248"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExtractKernels.BlockedKernel.html#DistRep"><span class="hs-identifier hs-type">DistRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684402806"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.MonadFreshNames.html#MonadFreshNames"><span class="hs-identifier hs-type">MonadFreshNames</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684402805"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#LocalScope"><span class="hs-identifier hs-type">LocalScope</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684402806"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684402805"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-249"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.BlockedKernel.html#MkSegLevel"><span class="hs-identifier hs-type">MkSegLevel</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684402806"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684402805"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-250"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#KernelNest"><span class="hs-identifier hs-type">KernelNest</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-251"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684402806"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-252"></span><span>  </span><span class="annot"><a href="#local-6989586621684402805"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684402806"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684402806"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-253"></span><span id="constructKernel"><span class="annot"><span class="annottext">constructKernel :: forall rep (m :: * -&gt; *).
(DistRep rep, MonadFreshNames m, LocalScope rep m) =&gt;
MkSegLevel rep m -&gt; KernelNest -&gt; Body rep -&gt; m (Stm rep, Stms rep)
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#constructKernel"><span class="hs-identifier hs-var hs-var">constructKernel</span></a></span></span><span> </span><span id="local-6989586621684402143"><span class="annot"><span class="annottext">MkSegLevel rep m
</span><a href="#local-6989586621684402143"><span class="hs-identifier hs-var">mk_lvl</span></a></span></span><span> </span><span id="local-6989586621684402142"><span class="annot"><span class="annottext">KernelNest
</span><a href="#local-6989586621684402142"><span class="hs-identifier hs-var">kernel_nest</span></a></span></span><span> </span><span id="local-6989586621684402141"><span class="annot"><span class="annottext">Body rep
</span><a href="#local-6989586621684402141"><span class="hs-identifier hs-var">inner_body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BuilderT rep m (Stm rep) -&gt; m (Stm rep, Stms rep)
forall (m :: * -&gt; *) somerep rep a.
(MonadFreshNames m, HasScope somerep m, SameScope somerep rep) =&gt;
BuilderT rep m a -&gt; m (a, Stms rep)
</span><a href="Futhark.Builder.html#runBuilderT%27"><span class="hs-identifier hs-var">runBuilderT'</span></a></span><span> </span><span class="annot"><span class="annottext">(BuilderT rep m (Stm rep) -&gt; m (Stm rep, Stms rep))
-&gt; BuilderT rep m (Stm rep) -&gt; m (Stm rep, Stms rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-254"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684402139"><span class="annot"><span class="annottext">[(VName, SubExp)]
</span><a href="#local-6989586621684402139"><span class="hs-identifier hs-var">ispace</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684402138"><span class="annot"><span class="annottext">[KernelInput]
</span><a href="#local-6989586621684402138"><span class="hs-identifier hs-var">inps</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">KernelNest -&gt; BuilderT rep m ([(VName, SubExp)], [KernelInput])
forall (m :: * -&gt; *).
MonadFreshNames m =&gt;
KernelNest -&gt; m ([(VName, SubExp)], [KernelInput])
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#flatKernel"><span class="hs-identifier hs-var">flatKernel</span></a></span><span> </span><span class="annot"><span class="annottext">KernelNest
</span><a href="#local-6989586621684402142"><span class="hs-identifier hs-var">kernel_nest</span></a></span><span>
</span><span id="line-255"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684402137"><span class="annot"><span class="annottext">aux :: StmAux ()
</span><a href="#local-6989586621684402137"><span class="hs-identifier hs-var hs-var">aux</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LoopNesting -&gt; StmAux ()
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#loopNestingAux"><span class="hs-identifier hs-var hs-var">loopNestingAux</span></a></span><span> </span><span class="annot"><span class="annottext">LoopNesting
</span><a href="#local-6989586621684402136"><span class="hs-identifier hs-var">first_nest</span></a></span><span>
</span><span id="line-256"></span><span>      </span><span id="local-6989586621684402135"><span class="annot"><span class="annottext">ispace_scope :: Map VName (NameInfo rep)
</span><a href="#local-6989586621684402135"><span class="hs-identifier hs-var hs-var">ispace_scope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VName, NameInfo rep)] -&gt; Map VName (NameInfo rep)
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="annot"><span class="annottext">([(VName, NameInfo rep)] -&gt; Map VName (NameInfo rep))
-&gt; [(VName, NameInfo rep)] -&gt; Map VName (NameInfo rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [NameInfo rep] -&gt; [(VName, NameInfo rep)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((VName, SubExp) -&gt; VName) -&gt; [(VName, SubExp)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(VName, SubExp) -&gt; VName
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(VName, SubExp)]
</span><a href="#local-6989586621684402139"><span class="hs-identifier hs-var">ispace</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([NameInfo rep] -&gt; [(VName, NameInfo rep)])
-&gt; [NameInfo rep] -&gt; [(VName, NameInfo rep)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">NameInfo rep -&gt; [NameInfo rep]
forall a. a -&gt; [a]
</span><span class="hs-identifier hs-var">repeat</span></span><span> </span><span class="annot"><span class="annottext">(NameInfo rep -&gt; [NameInfo rep]) -&gt; NameInfo rep -&gt; [NameInfo rep]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IntType -&gt; NameInfo rep
forall rep. IntType -&gt; NameInfo rep
</span><a href="Futhark.IR.Prop.Scope.html#IndexName"><span class="hs-identifier hs-var">IndexName</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span>
</span><span id="line-257"></span><span>      </span><span id="local-6989586621684402130"><span class="annot"><span class="annottext">pat :: PatT Type
</span><a href="#local-6989586621684402130"><span class="hs-identifier hs-var hs-var">pat</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LoopNesting -&gt; PatT Type
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#loopNestingPat"><span class="hs-identifier hs-var hs-var">loopNestingPat</span></a></span><span> </span><span class="annot"><span class="annottext">LoopNesting
</span><a href="#local-6989586621684402136"><span class="hs-identifier hs-var">first_nest</span></a></span><span>
</span><span id="line-258"></span><span>      </span><span id="local-6989586621684402129"><span class="annot"><span class="annottext">rts :: [Type]
</span><a href="#local-6989586621684402129"><span class="hs-identifier hs-var hs-var">rts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Type) -&gt; [Type] -&gt; [Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Type -&gt; Type
forall u. Int -&gt; TypeBase Shape u -&gt; TypeBase Shape u
</span><a href="Futhark.IR.Prop.Types.html#stripArray"><span class="hs-identifier hs-var">stripArray</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(VName, SubExp)] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[(VName, SubExp)]
</span><a href="#local-6989586621684402139"><span class="hs-identifier hs-var">ispace</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Type] -&gt; [Type]) -&gt; [Type] -&gt; [Type]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatT Type -&gt; [Type]
forall dec. Typed dec =&gt; PatT dec -&gt; [Type]
</span><a href="Futhark.IR.Prop.Patterns.html#patTypes"><span class="hs-identifier hs-var">patTypes</span></a></span><span> </span><span class="annot"><span class="annottext">PatT Type
</span><a href="#local-6989586621684402130"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-259"></span><span>
</span><span id="line-260"></span><span>  </span><span id="local-6989586621684402125"><span class="annot"><span class="annottext">KernelBody rep
</span><a href="#local-6989586621684402125"><span class="hs-identifier hs-var">inner_body'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(([KernelResult], Stms rep) -&gt; KernelBody rep)
-&gt; BuilderT rep m ([KernelResult], Stms rep)
-&gt; BuilderT rep m (KernelBody rep)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">([KernelResult] -&gt; Stms rep -&gt; KernelBody rep)
-&gt; ([KernelResult], Stms rep) -&gt; KernelBody rep
forall a b c. (a -&gt; b -&gt; c) -&gt; (a, b) -&gt; c
</span><span class="hs-identifier hs-var">uncurry</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Stms rep -&gt; [KernelResult] -&gt; KernelBody rep)
-&gt; [KernelResult] -&gt; Stms rep -&gt; KernelBody rep
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BodyDec rep -&gt; Stms rep -&gt; [KernelResult] -&gt; KernelBody rep
forall rep.
BodyDec rep -&gt; Stms rep -&gt; [KernelResult] -&gt; KernelBody rep
</span><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-var">KernelBody</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(BuilderT rep m ([KernelResult], Stms rep)
 -&gt; BuilderT rep m (KernelBody rep))
-&gt; BuilderT rep m ([KernelResult], Stms rep)
-&gt; BuilderT rep m (KernelBody rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-261"></span><span>    </span><span class="annot"><span class="annottext">Builder rep [KernelResult]
-&gt; BuilderT rep m ([KernelResult], Stms rep)
forall (m :: * -&gt; *) somerep rep a.
(MonadFreshNames m, HasScope somerep m, SameScope somerep rep) =&gt;
Builder rep a -&gt; m (a, Stms rep)
</span><a href="Futhark.Builder.html#runBuilder"><span class="hs-identifier hs-var">runBuilder</span></a></span><span> </span><span class="annot"><span class="annottext">(Builder rep [KernelResult]
 -&gt; BuilderT rep m ([KernelResult], Stms rep))
-&gt; Builder rep [KernelResult]
-&gt; BuilderT rep m ([KernelResult], Stms rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-262"></span><span>      </span><span class="annot"><span class="annottext">Map VName (NameInfo rep)
-&gt; Builder rep [KernelResult] -&gt; Builder rep [KernelResult]
forall rep (m :: * -&gt; *) a.
LocalScope rep m =&gt;
Scope rep -&gt; m a -&gt; m a
</span><a href="Futhark.IR.Prop.Scope.html#localScope"><span class="hs-identifier hs-var">localScope</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName (NameInfo rep)
</span><a href="#local-6989586621684402135"><span class="hs-identifier hs-var">ispace_scope</span></a></span><span> </span><span class="annot"><span class="annottext">(Builder rep [KernelResult] -&gt; Builder rep [KernelResult])
-&gt; Builder rep [KernelResult] -&gt; Builder rep [KernelResult]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-263"></span><span>        </span><span class="annot"><span class="annottext">(KernelInput -&gt; BuilderT rep (State VNameSource) ())
-&gt; [KernelInput] -&gt; BuilderT rep (State VNameSource) ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="annot"><span class="annottext">KernelInput -&gt; BuilderT rep (State VNameSource) ()
forall (m :: * -&gt; *).
(DistRep (Rep m), MonadBuilder m) =&gt;
KernelInput -&gt; m ()
</span><a href="Futhark.Pass.ExtractKernels.BlockedKernel.html#readKernelInput"><span class="hs-identifier hs-var">readKernelInput</span></a></span><span> </span><span class="annot"><span class="annottext">([KernelInput] -&gt; BuilderT rep (State VNameSource) ())
-&gt; [KernelInput] -&gt; BuilderT rep (State VNameSource) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(KernelInput -&gt; Bool) -&gt; [KernelInput] -&gt; [KernelInput]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="annot"><span class="annottext">KernelInput -&gt; Bool
</span><a href="#local-6989586621684402119"><span class="hs-identifier hs-var">inputIsUsed</span></a></span><span> </span><span class="annot"><span class="annottext">[KernelInput]
</span><a href="#local-6989586621684402138"><span class="hs-identifier hs-var">inps</span></a></span><span>
</span><span id="line-264"></span><span>        </span><span id="local-6989586621684402118"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684402118"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Body (Rep (BuilderT rep (State VNameSource)))
-&gt; BuilderT rep (State VNameSource) Result
forall (m :: * -&gt; *). MonadBuilder m =&gt; Body (Rep m) -&gt; m Result
</span><a href="Futhark.Builder.Class.html#bodyBind"><span class="hs-identifier hs-var">bodyBind</span></a></span><span> </span><span class="annot"><span class="annottext">Body rep
Body (Rep (BuilderT rep (State VNameSource)))
</span><a href="#local-6989586621684402141"><span class="hs-identifier hs-var">inner_body</span></a></span><span>
</span><span id="line-265"></span><span>        </span><span class="annot"><span class="annottext">Result
-&gt; (SubExpRes -&gt; BuilderT rep (State VNameSource) KernelResult)
-&gt; Builder rep [KernelResult]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684402118"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="annot"><span class="annottext">((SubExpRes -&gt; BuilderT rep (State VNameSource) KernelResult)
 -&gt; Builder rep [KernelResult])
-&gt; (SubExpRes -&gt; BuilderT rep (State VNameSource) KernelResult)
-&gt; Builder rep [KernelResult]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-type">SubExpRes</span></a></span><span> </span><span id="local-6989586621684402115"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684402115"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span id="local-6989586621684402114"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684402114"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">KernelResult -&gt; BuilderT rep (State VNameSource) KernelResult
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(KernelResult -&gt; BuilderT rep (State VNameSource) KernelResult)
-&gt; KernelResult -&gt; BuilderT rep (State VNameSource) KernelResult
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ResultManifest -&gt; Certs -&gt; SubExp -&gt; KernelResult
</span><a href="Futhark.IR.SegOp.html#Returns"><span class="hs-identifier hs-var">Returns</span></a></span><span> </span><span class="annot"><span class="annottext">ResultManifest
</span><a href="Futhark.IR.SegOp.html#ResultMaySimplify"><span class="hs-identifier hs-var">ResultMaySimplify</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684402115"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684402114"><span class="hs-identifier hs-var">se</span></a></span><span>
</span><span id="line-266"></span><span>
</span><span id="line-267"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684402111"><span class="annot"><span class="annottext">SegOp (SegOpLevel rep) rep
</span><a href="#local-6989586621684402111"><span class="hs-identifier hs-var">segop</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684402110"><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684402110"><span class="hs-identifier hs-var">aux_stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (SegOp (SegOpLevel rep) rep, Stms rep)
-&gt; BuilderT rep m (SegOp (SegOpLevel rep) rep, Stms rep)
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(m (SegOp (SegOpLevel rep) rep, Stms rep)
 -&gt; BuilderT rep m (SegOp (SegOpLevel rep) rep, Stms rep))
-&gt; m (SegOp (SegOpLevel rep) rep, Stms rep)
-&gt; BuilderT rep m (SegOp (SegOpLevel rep) rep, Stms rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MkSegLevel rep m
-&gt; [(VName, SubExp)]
-&gt; [KernelInput]
-&gt; [Type]
-&gt; KernelBody rep
-&gt; m (SegOp (SegOpLevel rep) rep, Stms rep)
forall rep (m :: * -&gt; *).
(DistRep rep, HasScope rep m, MonadFreshNames m) =&gt;
MkSegLevel rep m
-&gt; [(VName, SubExp)]
-&gt; [KernelInput]
-&gt; [Type]
-&gt; KernelBody rep
-&gt; m (SegOp (SegOpLevel rep) rep, Stms rep)
</span><a href="Futhark.Pass.ExtractKernels.BlockedKernel.html#mapKernel"><span class="hs-identifier hs-var">mapKernel</span></a></span><span> </span><span class="annot"><span class="annottext">MkSegLevel rep m
</span><a href="#local-6989586621684402143"><span class="hs-identifier hs-var">mk_lvl</span></a></span><span> </span><span class="annot"><span class="annottext">[(VName, SubExp)]
</span><a href="#local-6989586621684402139"><span class="hs-identifier hs-var">ispace</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684402129"><span class="hs-identifier hs-var">rts</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody rep
</span><a href="#local-6989586621684402125"><span class="hs-identifier hs-var">inner_body'</span></a></span><span>
</span><span id="line-268"></span><span>
</span><span id="line-269"></span><span>  </span><span class="annot"><span class="annottext">Stms (Rep (BuilderT rep m)) -&gt; BuilderT rep m ()
forall (m :: * -&gt; *). MonadBuilder m =&gt; Stms (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#addStms"><span class="hs-identifier hs-var">addStms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms rep
Stms (Rep (BuilderT rep m))
</span><a href="#local-6989586621684402110"><span class="hs-identifier hs-var">aux_stms</span></a></span><span>
</span><span id="line-270"></span><span>
</span><span id="line-271"></span><span>  </span><span class="annot"><span class="annottext">Stm rep -&gt; BuilderT rep m (Stm rep)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Stm rep -&gt; BuilderT rep m (Stm rep))
-&gt; Stm rep -&gt; BuilderT rep m (Stm rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">PatT Type
Pat rep
</span><a href="#local-6989586621684402130"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux ()
StmAux (ExpDec rep)
</span><a href="#local-6989586621684402137"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp rep -&gt; Stm rep) -&gt; Exp rep -&gt; Stm rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Op rep -&gt; Exp rep
forall rep. Op rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-var">Op</span></a></span><span> </span><span class="annot"><span class="annottext">(Op rep -&gt; Exp rep) -&gt; Op rep -&gt; Exp rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegOp (SegOpLevel rep) rep -&gt; Op rep
forall rep. HasSegOp rep =&gt; SegOp (SegOpLevel rep) rep -&gt; Op rep
</span><a href="Futhark.IR.SegOp.html#segOp"><span class="hs-identifier hs-var">segOp</span></a></span><span> </span><span class="annot"><span class="annottext">SegOp (SegOpLevel rep) rep
</span><a href="#local-6989586621684402111"><span class="hs-identifier hs-var">segop</span></a></span><span>
</span><span id="line-272"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-273"></span><span>    </span><span id="local-6989586621684402136"><span class="annot"><span class="annottext">first_nest :: LoopNesting
</span><a href="#local-6989586621684402136"><span class="hs-identifier hs-var hs-var">first_nest</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">KernelNest -&gt; LoopNesting
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">KernelNest
</span><a href="#local-6989586621684402142"><span class="hs-identifier hs-var">kernel_nest</span></a></span><span>
</span><span id="line-274"></span><span>    </span><span id="local-6989586621684402119"><span class="annot"><span class="annottext">inputIsUsed :: KernelInput -&gt; Bool
</span><a href="#local-6989586621684402119"><span class="hs-identifier hs-var hs-var">inputIsUsed</span></a></span></span><span> </span><span id="local-6989586621684402104"><span class="annot"><span class="annottext">KernelInput
</span><a href="#local-6989586621684402104"><span class="hs-identifier hs-var">input</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">KernelInput -&gt; VName
</span><a href="Futhark.Pass.ExtractKernels.BlockedKernel.html#kernelInputName"><span class="hs-identifier hs-var hs-var">kernelInputName</span></a></span><span> </span><span class="annot"><span class="annottext">KernelInput
</span><a href="#local-6989586621684402104"><span class="hs-identifier hs-var">input</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#nameIn"><span class="hs-operator hs-var">`nameIn`</span></a></span><span> </span><span class="annot"><span class="annottext">Body rep -&gt; Names
forall a. FreeIn a =&gt; a -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#freeIn"><span class="hs-identifier hs-var">freeIn</span></a></span><span> </span><span class="annot"><span class="annottext">Body rep
</span><a href="#local-6989586621684402141"><span class="hs-identifier hs-var">inner_body</span></a></span><span>
</span><span id="line-275"></span><span>
</span><span id="line-276"></span><span class="hs-comment">-- | Flatten a kernel nesting to:</span><span>
</span><span id="line-277"></span><span class="hs-comment">--</span><span>
</span><span id="line-278"></span><span class="hs-comment">--  (1) The index space.</span><span>
</span><span id="line-279"></span><span class="hs-comment">--</span><span>
</span><span id="line-280"></span><span class="hs-comment">--  (2) The kernel inputs - note that some of these may be unused.</span><span>
</span><span id="line-281"></span><span id="local-6989586621684402748"><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#flatKernel"><span class="hs-identifier hs-type">flatKernel</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-282"></span><span>  </span><span class="annot"><a href="Futhark.MonadFreshNames.html#MonadFreshNames"><span class="hs-identifier hs-type">MonadFreshNames</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684402748"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-283"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#KernelNest"><span class="hs-identifier hs-type">KernelNest</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-284"></span><span>  </span><span class="annot"><a href="#local-6989586621684402748"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Pass.ExtractKernels.BlockedKernel.html#KernelInput"><span class="hs-identifier hs-type">KernelInput</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span></span><span>
</span><span id="line-285"></span><span id="flatKernel"><span class="annot"><span class="annottext">flatKernel :: forall (m :: * -&gt; *).
MonadFreshNames m =&gt;
KernelNest -&gt; m ([(VName, SubExp)], [KernelInput])
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#flatKernel"><span class="hs-identifier hs-var hs-var">flatKernel</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#MapNesting"><span class="hs-identifier hs-type">MapNesting</span></a></span><span> </span><span class="annot"><span class="annottext">PatT Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StmAux ()
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684402086"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684402086"><span class="hs-identifier hs-var">nesting_w</span></a></span></span><span> </span><span id="local-6989586621684402085"><span class="annot"><span class="annottext">[(Param Type, VName)]
</span><a href="#local-6989586621684402085"><span class="hs-identifier hs-var">params_and_arrs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-286"></span><span>  </span><span id="local-6989586621684402084"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684402084"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; m VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; String -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;gtid&quot;</span></span><span>
</span><span id="line-287"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684402082"><span class="annot"><span class="annottext">inps :: [KernelInput]
</span><a href="#local-6989586621684402082"><span class="hs-identifier hs-var hs-var">inps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-288"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Type -&gt; VName -&gt; [SubExp] -&gt; KernelInput
</span><a href="Futhark.Pass.ExtractKernels.BlockedKernel.html#KernelInput"><span class="hs-identifier hs-var">KernelInput</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684402080"><span class="hs-identifier hs-var">pname</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684402079"><span class="hs-identifier hs-var">ptype</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684402078"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684402084"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-289"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Param"><span class="hs-identifier hs-type">Param</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684402080"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684402080"><span class="hs-identifier hs-var">pname</span></a></span></span><span> </span><span id="local-6989586621684402079"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684402079"><span class="hs-identifier hs-var">ptype</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684402078"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684402078"><span class="hs-identifier hs-var">arr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Param Type, VName)]
</span><a href="#local-6989586621684402085"><span class="hs-identifier hs-var">params_and_arrs</span></a></span><span>
</span><span id="line-290"></span><span>        </span><span class="hs-special">]</span><span>
</span><span id="line-291"></span><span>  </span><span class="annot"><span class="annottext">([(VName, SubExp)], [KernelInput])
-&gt; m ([(VName, SubExp)], [KernelInput])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684402084"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684402086"><span class="hs-identifier hs-var">nesting_w</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[KernelInput]
</span><a href="#local-6989586621684402082"><span class="hs-identifier hs-var">inps</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-292"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#flatKernel"><span class="hs-identifier hs-var">flatKernel</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#MapNesting"><span class="hs-identifier hs-type">MapNesting</span></a></span><span> </span><span class="annot"><span class="annottext">PatT Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StmAux ()
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684402076"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684402076"><span class="hs-identifier hs-var">nesting_w</span></a></span></span><span> </span><span id="local-6989586621684402075"><span class="annot"><span class="annottext">[(Param Type, VName)]
</span><a href="#local-6989586621684402075"><span class="hs-identifier hs-var">params_and_arrs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684402074"><span class="annot"><span class="annottext">LoopNesting
</span><a href="#local-6989586621684402074"><span class="hs-identifier hs-var">nest</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684402073"><span class="annot"><span class="annottext">[LoopNesting]
</span><a href="#local-6989586621684402073"><span class="hs-identifier hs-var">nests</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-293"></span><span>  </span><span id="local-6989586621684402072"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684402072"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; m VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; String -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;gtid&quot;</span></span><span>
</span><span id="line-294"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684402071"><span class="annot"><span class="annottext">[(VName, SubExp)]
</span><a href="#local-6989586621684402071"><span class="hs-identifier hs-var">ispace</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684402070"><span class="annot"><span class="annottext">[KernelInput]
</span><a href="#local-6989586621684402070"><span class="hs-identifier hs-var">inps</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">KernelNest -&gt; m ([(VName, SubExp)], [KernelInput])
forall (m :: * -&gt; *).
MonadFreshNames m =&gt;
KernelNest -&gt; m ([(VName, SubExp)], [KernelInput])
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#flatKernel"><span class="hs-identifier hs-var">flatKernel</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LoopNesting
</span><a href="#local-6989586621684402074"><span class="hs-identifier hs-var">nest</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[LoopNesting]
</span><a href="#local-6989586621684402073"><span class="hs-identifier hs-var">nests</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-295"></span><span>
</span><span id="line-296"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684402069"><span class="annot"><span class="annottext">inps' :: [KernelInput]
</span><a href="#local-6989586621684402069"><span class="hs-identifier hs-var hs-var">inps'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(KernelInput -&gt; KernelInput) -&gt; [KernelInput] -&gt; [KernelInput]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">KernelInput -&gt; KernelInput
</span><a href="#local-6989586621684402068"><span class="hs-identifier hs-var">fixupInput</span></a></span><span> </span><span class="annot"><span class="annottext">[KernelInput]
</span><a href="#local-6989586621684402070"><span class="hs-identifier hs-var">inps</span></a></span><span>
</span><span id="line-297"></span><span>      </span><span id="local-6989586621684402067"><span class="annot"><span class="annottext">isParam :: KernelInput -&gt; Maybe VName
</span><a href="#local-6989586621684402067"><span class="hs-identifier hs-var hs-var">isParam</span></a></span></span><span> </span><span id="local-6989586621684402066"><span class="annot"><span class="annottext">KernelInput
</span><a href="#local-6989586621684402066"><span class="hs-identifier hs-var">inp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-298"></span><span>        </span><span class="annot"><span class="annottext">(Param Type, VName) -&gt; VName
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">((Param Type, VName) -&gt; VName)
-&gt; Maybe (Param Type, VName) -&gt; Maybe VName
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">((Param Type, VName) -&gt; Bool)
-&gt; [(Param Type, VName)] -&gt; Maybe (Param Type, VName)
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Maybe a
</span><span class="hs-identifier hs-var">find</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; VName -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">KernelInput -&gt; VName
</span><a href="Futhark.Pass.ExtractKernels.BlockedKernel.html#kernelInputArray"><span class="hs-identifier hs-var hs-var">kernelInputArray</span></a></span><span> </span><span class="annot"><span class="annottext">KernelInput
</span><a href="#local-6989586621684402066"><span class="hs-identifier hs-var">inp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Bool)
-&gt; ((Param Type, VName) -&gt; VName) -&gt; (Param Type, VName) -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Param Type -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">(Param Type -&gt; VName)
-&gt; ((Param Type, VName) -&gt; Param Type)
-&gt; (Param Type, VName)
-&gt; VName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Param Type, VName) -&gt; Param Type
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Param Type, VName)]
</span><a href="#local-6989586621684402075"><span class="hs-identifier hs-var">params_and_arrs</span></a></span><span>
</span><span id="line-299"></span><span>      </span><span id="local-6989586621684402068"><span class="annot"><span class="annottext">fixupInput :: KernelInput -&gt; KernelInput
</span><a href="#local-6989586621684402068"><span class="hs-identifier hs-var hs-var">fixupInput</span></a></span></span><span> </span><span id="local-6989586621684402062"><span class="annot"><span class="annottext">KernelInput
</span><a href="#local-6989586621684402062"><span class="hs-identifier hs-var">inp</span></a></span></span><span>
</span><span id="line-300"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684402061"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684402061"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">KernelInput -&gt; Maybe VName
</span><a href="#local-6989586621684402067"><span class="hs-identifier hs-var">isParam</span></a></span><span> </span><span class="annot"><span class="annottext">KernelInput
</span><a href="#local-6989586621684402062"><span class="hs-identifier hs-var">inp</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-301"></span><span>          </span><span class="annot"><span class="annottext">KernelInput
</span><a href="#local-6989586621684402062"><span class="hs-identifier hs-var">inp</span></a></span><span>
</span><span id="line-302"></span><span>            </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">kernelInputArray :: VName
</span><a href="Futhark.Pass.ExtractKernels.BlockedKernel.html#kernelInputArray"><span class="hs-identifier hs-var">kernelInputArray</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684402061"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-303"></span><span>              </span><span class="annot"><span class="annottext">kernelInputIndices :: [SubExp]
</span><a href="Futhark.Pass.ExtractKernels.BlockedKernel.html#kernelInputIndices"><span class="hs-identifier hs-var">kernelInputIndices</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684402072"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; [SubExp] -&gt; [SubExp]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">KernelInput -&gt; [SubExp]
</span><a href="Futhark.Pass.ExtractKernels.BlockedKernel.html#kernelInputIndices"><span class="hs-identifier hs-var hs-var">kernelInputIndices</span></a></span><span> </span><span class="annot"><span class="annottext">KernelInput
</span><a href="#local-6989586621684402062"><span class="hs-identifier hs-var">inp</span></a></span><span>
</span><span id="line-304"></span><span>            </span><span class="hs-special">}</span><span>
</span><span id="line-305"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-306"></span><span>          </span><span class="annot"><span class="annottext">KernelInput
</span><a href="#local-6989586621684402062"><span class="hs-identifier hs-var">inp</span></a></span><span>
</span><span id="line-307"></span><span>
</span><span id="line-308"></span><span>  </span><span class="annot"><span class="annottext">([(VName, SubExp)], [KernelInput])
-&gt; m ([(VName, SubExp)], [KernelInput])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684402072"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684402076"><span class="hs-identifier hs-var">nesting_w</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(VName, SubExp) -&gt; [(VName, SubExp)] -&gt; [(VName, SubExp)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[(VName, SubExp)]
</span><a href="#local-6989586621684402071"><span class="hs-identifier hs-var">ispace</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VName -&gt; [KernelInput]
</span><a href="#local-6989586621684402059"><span class="hs-identifier hs-var">extra_inps</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684402072"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">[KernelInput] -&gt; [KernelInput] -&gt; [KernelInput]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[KernelInput]
</span><a href="#local-6989586621684402069"><span class="hs-identifier hs-var">inps'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-309"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-310"></span><span>    </span><span id="local-6989586621684402059"><span class="annot"><span class="annottext">extra_inps :: VName -&gt; [KernelInput]
</span><a href="#local-6989586621684402059"><span class="hs-identifier hs-var hs-var">extra_inps</span></a></span></span><span> </span><span id="local-6989586621684402058"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684402058"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-311"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Type -&gt; VName -&gt; [SubExp] -&gt; KernelInput
</span><a href="Futhark.Pass.ExtractKernels.BlockedKernel.html#KernelInput"><span class="hs-identifier hs-var">KernelInput</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684402057"><span class="hs-identifier hs-var">pname</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684402056"><span class="hs-identifier hs-var">ptype</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684402055"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684402058"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-312"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Param"><span class="hs-identifier hs-type">Param</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684402057"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684402057"><span class="hs-identifier hs-var">pname</span></a></span></span><span> </span><span id="local-6989586621684402056"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684402056"><span class="hs-identifier hs-var">ptype</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684402055"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684402055"><span class="hs-identifier hs-var">arr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Param Type, VName)]
</span><a href="#local-6989586621684402075"><span class="hs-identifier hs-var">params_and_arrs</span></a></span><span>
</span><span id="line-313"></span><span>      </span><span class="hs-special">]</span><span>
</span><span id="line-314"></span><span>
</span><span id="line-315"></span><span class="hs-comment">-- | Description of distribution to do.</span><span>
</span><span id="line-316"></span><span class="hs-keyword">data</span><span> </span><span id="DistributionBody"><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#DistributionBody"><span class="hs-identifier hs-var">DistributionBody</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="DistributionBody"><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#DistributionBody"><span class="hs-identifier hs-var">DistributionBody</span></a></span></span><span>
</span><span id="line-317"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="distributionTarget"><span class="annot"><span class="annottext">DistributionBody -&gt; Targets
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#distributionTarget"><span class="hs-identifier hs-var hs-var">distributionTarget</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Targets"><span class="hs-identifier hs-type">Targets</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-318"></span><span>    </span><span id="distributionFreeInBody"><span class="annot"><span class="annottext">DistributionBody -&gt; Names
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#distributionFreeInBody"><span class="hs-identifier hs-var hs-var">distributionFreeInBody</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-319"></span><span>    </span><span id="distributionIdentityMap"><span class="annot"><span class="annottext">DistributionBody -&gt; Map VName Ident
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#distributionIdentityMap"><span class="hs-identifier hs-var hs-var">distributionIdentityMap</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Ident"><span class="hs-identifier hs-type">Ident</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-320"></span><span>    </span><span class="hs-comment">-- | Also related to avoiding identity mapping.</span><span>
</span><span id="line-321"></span><span>    </span><span id="distributionExpandTarget"><span class="annot"><span class="annottext">DistributionBody -&gt; Target -&gt; Target
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#distributionExpandTarget"><span class="hs-identifier hs-var hs-var">distributionExpandTarget</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Target"><span class="hs-identifier hs-type">Target</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Target"><span class="hs-identifier hs-type">Target</span></a></span><span>
</span><span id="line-322"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-323"></span><span>
</span><span id="line-324"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#distributionInnerPat"><span class="hs-identifier hs-type">distributionInnerPat</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#DistributionBody"><span class="hs-identifier hs-type">DistributionBody</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#PatT"><span class="hs-identifier hs-type">PatT</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span>
</span><span id="line-325"></span><span id="distributionInnerPat"><span class="annot"><span class="annottext">distributionInnerPat :: DistributionBody -&gt; PatT Type
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#distributionInnerPat"><span class="hs-identifier hs-var hs-var">distributionInnerPat</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Target -&gt; PatT Type
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">(Target -&gt; PatT Type)
-&gt; (DistributionBody -&gt; Target) -&gt; DistributionBody -&gt; PatT Type
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Targets -&gt; Target
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#innerTarget"><span class="hs-identifier hs-var">innerTarget</span></a></span><span> </span><span class="annot"><span class="annottext">(Targets -&gt; Target)
-&gt; (DistributionBody -&gt; Targets) -&gt; DistributionBody -&gt; Target
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">DistributionBody -&gt; Targets
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#distributionTarget"><span class="hs-identifier hs-var hs-var">distributionTarget</span></a></span><span>
</span><span id="line-326"></span><span>
</span><span id="line-327"></span><span id="local-6989586621684402684"><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#distributionBodyFromStms"><span class="hs-identifier hs-type">distributionBodyFromStms</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-328"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.html#ASTRep"><span class="hs-identifier hs-type">ASTRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684402684"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-329"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Targets"><span class="hs-identifier hs-type">Targets</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-330"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684402684"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-331"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#DistributionBody"><span class="hs-identifier hs-type">DistributionBody</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Result"><span class="hs-identifier hs-type">Result</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-332"></span><span id="distributionBodyFromStms"><span class="annot"><span class="annottext">distributionBodyFromStms :: forall rep.
ASTRep rep =&gt;
Targets -&gt; Stms rep -&gt; (DistributionBody, Result)
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#distributionBodyFromStms"><span class="hs-identifier hs-var hs-var">distributionBodyFromStms</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Targets"><span class="hs-identifier hs-type">Targets</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684402003"><span class="annot"><span class="annottext">PatT Type
</span><a href="#local-6989586621684402003"><span class="hs-identifier hs-var">inner_pat</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684402002"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684402002"><span class="hs-identifier hs-var">inner_res</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684402001"><span class="annot"><span class="annottext">[Target]
</span><a href="#local-6989586621684402001"><span class="hs-identifier hs-var">targets</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684402000"><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684402000"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-333"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684401999"><span class="annot"><span class="annottext">bound_by_stms :: Names
</span><a href="#local-6989586621684401999"><span class="hs-identifier hs-var hs-var">bound_by_stms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#namesFromList"><span class="hs-identifier hs-var">namesFromList</span></a></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; Names) -&gt; [VName] -&gt; Names
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Map VName (NameInfo rep) -&gt; [VName]
forall k a. Map k a -&gt; [k]
</span><span class="hs-identifier hs-var">M.keys</span></span><span> </span><span class="annot"><span class="annottext">(Map VName (NameInfo rep) -&gt; [VName])
-&gt; Map VName (NameInfo rep) -&gt; [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stms rep -&gt; Map VName (NameInfo rep)
forall rep a. Scoped rep a =&gt; a -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOf"><span class="hs-identifier hs-var">scopeOf</span></a></span><span> </span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684402000"><span class="hs-identifier hs-var">stms</span></a></span><span>
</span><span id="line-334"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684401996"><span class="annot"><span class="annottext">PatT Type
</span><a href="#local-6989586621684401996"><span class="hs-identifier hs-var">inner_pat'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684401995"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684401995"><span class="hs-identifier hs-var">inner_res'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684401994"><span class="annot"><span class="annottext">Map VName Ident
</span><a href="#local-6989586621684401994"><span class="hs-identifier hs-var">inner_identity_map</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684401993"><span class="annot"><span class="annottext">Target -&gt; Target
</span><a href="#local-6989586621684401993"><span class="hs-identifier hs-var">inner_expand_target</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-335"></span><span>        </span><span class="annot"><span class="annottext">Names
-&gt; PatT Type
-&gt; Result
-&gt; (PatT Type, Result, Map VName Ident, Target -&gt; Target)
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#removeIdentityMappingGeneral"><span class="hs-identifier hs-var">removeIdentityMappingGeneral</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684401999"><span class="hs-identifier hs-var">bound_by_stms</span></a></span><span> </span><span class="annot"><span class="annottext">PatT Type
</span><a href="#local-6989586621684402003"><span class="hs-identifier hs-var">inner_pat</span></a></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684402002"><span class="hs-identifier hs-var">inner_res</span></a></span><span>
</span><span id="line-336"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">DistributionBody :: Targets
-&gt; Names
-&gt; Map VName Ident
-&gt; (Target -&gt; Target)
-&gt; DistributionBody
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#DistributionBody"><span class="hs-identifier hs-type">DistributionBody</span></a></span><span>
</span><span id="line-337"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">distributionTarget :: Targets
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#distributionTarget"><span class="hs-identifier hs-var">distributionTarget</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Target -&gt; [Target] -&gt; Targets
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#Targets"><span class="hs-identifier hs-var">Targets</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatT Type
</span><a href="#local-6989586621684401996"><span class="hs-identifier hs-var">inner_pat'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684401995"><span class="hs-identifier hs-var">inner_res'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Target]
</span><a href="#local-6989586621684402001"><span class="hs-identifier hs-var">targets</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-338"></span><span>            </span><span class="annot"><span class="annottext">distributionFreeInBody :: Names
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#distributionFreeInBody"><span class="hs-identifier hs-var">distributionFreeInBody</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Stm rep -&gt; Names) -&gt; Stms rep -&gt; Names
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; Names
forall a. FreeIn a =&gt; a -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#freeIn"><span class="hs-identifier hs-var">freeIn</span></a></span><span> </span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684402000"><span class="hs-identifier hs-var">stms</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#namesSubtract"><span class="hs-operator hs-var">`namesSubtract`</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684401999"><span class="hs-identifier hs-var">bound_by_stms</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-339"></span><span>            </span><span class="annot"><span class="annottext">distributionIdentityMap :: Map VName Ident
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#distributionIdentityMap"><span class="hs-identifier hs-var">distributionIdentityMap</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map VName Ident
</span><a href="#local-6989586621684401994"><span class="hs-identifier hs-var">inner_identity_map</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-340"></span><span>            </span><span class="annot"><span class="annottext">distributionExpandTarget :: Target -&gt; Target
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#distributionExpandTarget"><span class="hs-identifier hs-var">distributionExpandTarget</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Target -&gt; Target
</span><a href="#local-6989586621684401993"><span class="hs-identifier hs-var">inner_expand_target</span></a></span><span>
</span><span id="line-341"></span><span>          </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><span id="line-342"></span><span>        </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684401995"><span class="hs-identifier hs-var">inner_res'</span></a></span><span>
</span><span id="line-343"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-344"></span><span>
</span><span id="line-345"></span><span id="local-6989586621684402674"><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#distributionBodyFromStm"><span class="hs-identifier hs-type">distributionBodyFromStm</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-346"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.html#ASTRep"><span class="hs-identifier hs-type">ASTRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684402674"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-347"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Targets"><span class="hs-identifier hs-type">Targets</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-348"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684402674"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-349"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#DistributionBody"><span class="hs-identifier hs-type">DistributionBody</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Result"><span class="hs-identifier hs-type">Result</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-350"></span><span id="distributionBodyFromStm"><span class="annot"><span class="annottext">distributionBodyFromStm :: forall rep.
ASTRep rep =&gt;
Targets -&gt; Stm rep -&gt; (DistributionBody, Result)
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#distributionBodyFromStm"><span class="hs-identifier hs-var hs-var">distributionBodyFromStm</span></a></span></span><span> </span><span id="local-6989586621684401987"><span class="annot"><span class="annottext">Targets
</span><a href="#local-6989586621684401987"><span class="hs-identifier hs-var">targets</span></a></span></span><span> </span><span id="local-6989586621684401986"><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684401986"><span class="hs-identifier hs-var">stm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-351"></span><span>  </span><span class="annot"><span class="annottext">Targets -&gt; Stms rep -&gt; (DistributionBody, Result)
forall rep.
ASTRep rep =&gt;
Targets -&gt; Stms rep -&gt; (DistributionBody, Result)
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#distributionBodyFromStms"><span class="hs-identifier hs-var">distributionBodyFromStms</span></a></span><span> </span><span class="annot"><span class="annottext">Targets
</span><a href="#local-6989586621684401987"><span class="hs-identifier hs-var">targets</span></a></span><span> </span><span class="annot"><span class="annottext">(Stms rep -&gt; (DistributionBody, Result))
-&gt; Stms rep -&gt; (DistributionBody, Result)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; Stms rep
forall rep. Stm rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#oneStm"><span class="hs-identifier hs-var">oneStm</span></a></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684401986"><span class="hs-identifier hs-var">stm</span></a></span><span>
</span><span id="line-352"></span><span>
</span><span id="line-353"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#createKernelNest"><span class="hs-identifier hs-type">createKernelNest</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-354"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621684402670"><span class="annot"><a href="#local-6989586621684402670"><span class="hs-identifier hs-type">rep</span></a></span></span><span> </span><span id="local-6989586621684402671"><span class="annot"><a href="#local-6989586621684402671"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-355"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.MonadFreshNames.html#MonadFreshNames"><span class="hs-identifier hs-type">MonadFreshNames</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684402671"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#HasScope"><span class="hs-identifier hs-type">HasScope</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684402670"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684402671"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-356"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Nestings"><span class="hs-identifier hs-type">Nestings</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-357"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#DistributionBody"><span class="hs-identifier hs-type">DistributionBody</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-358"></span><span>  </span><span class="annot"><a href="#local-6989586621684402671"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Targets"><span class="hs-identifier hs-type">Targets</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#KernelNest"><span class="hs-identifier hs-type">KernelNest</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-359"></span><span id="createKernelNest"><span class="annot"><span class="annottext">createKernelNest :: forall rep (m :: * -&gt; *).
(MonadFreshNames m, HasScope rep m) =&gt;
Nestings -&gt; DistributionBody -&gt; m (Maybe (Targets, KernelNest))
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#createKernelNest"><span class="hs-identifier hs-var hs-var">createKernelNest</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684401923"><span class="annot"><span class="annottext">Nesting
</span><a href="#local-6989586621684401923"><span class="hs-identifier hs-var">inner_nest</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684401922"><span class="annot"><span class="annottext">[Nesting]
</span><a href="#local-6989586621684401922"><span class="hs-identifier hs-var">nests</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684401921"><span class="annot"><span class="annottext">DistributionBody
</span><a href="#local-6989586621684401921"><span class="hs-identifier hs-var">distrib_body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-360"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Targets"><span class="hs-identifier hs-type">Targets</span></a></span><span> </span><span id="local-6989586621684401920"><span class="annot"><span class="annottext">Target
</span><a href="#local-6989586621684401920"><span class="hs-identifier hs-var">target</span></a></span></span><span> </span><span id="local-6989586621684401919"><span class="annot"><span class="annottext">[Target]
</span><a href="#local-6989586621684401919"><span class="hs-identifier hs-var">targets</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DistributionBody -&gt; Targets
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#distributionTarget"><span class="hs-identifier hs-var hs-var">distributionTarget</span></a></span><span> </span><span class="annot"><span class="annottext">DistributionBody
</span><a href="#local-6989586621684401921"><span class="hs-identifier hs-var">distrib_body</span></a></span><span>
</span><span id="line-361"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Nesting] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Nesting]
</span><a href="#local-6989586621684401922"><span class="hs-identifier hs-var">nests</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">[Target] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Target]
</span><a href="#local-6989586621684401919"><span class="hs-identifier hs-var">targets</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-362"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; m ()
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; m ()) -&gt; String -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-363"></span><span>      </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Nests and targets do not match!\n&quot;</span></span><span>
</span><span id="line-364"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;nests: &quot;</span></span><span>
</span><span id="line-365"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Nestings -&gt; String
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#ppNestings"><span class="hs-identifier hs-var">ppNestings</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Nesting
</span><a href="#local-6989586621684401923"><span class="hs-identifier hs-var">inner_nest</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Nesting]
</span><a href="#local-6989586621684401922"><span class="hs-identifier hs-var">nests</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-366"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;\ntargets:&quot;</span></span><span>
</span><span id="line-367"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Targets -&gt; String
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#ppTargets"><span class="hs-identifier hs-var">ppTargets</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Target -&gt; [Target] -&gt; Targets
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#Targets"><span class="hs-identifier hs-var">Targets</span></a></span><span> </span><span class="annot"><span class="annottext">Target
</span><a href="#local-6989586621684401920"><span class="hs-identifier hs-var">target</span></a></span><span> </span><span class="annot"><span class="annottext">[Target]
</span><a href="#local-6989586621684401919"><span class="hs-identifier hs-var">targets</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-368"></span><span>  </span><span class="annot"><span class="annottext">MaybeT m (Targets, KernelNest) -&gt; m (Maybe (Targets, KernelNest))
forall (m :: * -&gt; *) a. MaybeT m a -&gt; m (Maybe a)
</span><span class="hs-identifier hs-var hs-var">runMaybeT</span></span><span> </span><span class="annot"><span class="annottext">(MaybeT m (Targets, KernelNest) -&gt; m (Maybe (Targets, KernelNest)))
-&gt; MaybeT m (Targets, KernelNest)
-&gt; m (Maybe (Targets, KernelNest))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((KernelNest, Names, Targets) -&gt; (Targets, KernelNest))
-&gt; MaybeT m (KernelNest, Names, Targets)
-&gt; MaybeT m (Targets, KernelNest)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">(KernelNest, Names, Targets) -&gt; (Targets, KernelNest)
forall {b} {b} {a}. (b, b, a) -&gt; (a, b)
</span><a href="#local-6989586621684401915"><span class="hs-identifier hs-var">prepare</span></a></span><span> </span><span class="annot"><span class="annottext">(MaybeT m (KernelNest, Names, Targets)
 -&gt; MaybeT m (Targets, KernelNest))
-&gt; MaybeT m (KernelNest, Names, Targets)
-&gt; MaybeT m (Targets, KernelNest)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(Nesting, Target)] -&gt; MaybeT m (KernelNest, Names, Targets)
</span><a href="#local-6989586621684401914"><span class="hs-identifier hs-var">recurse</span></a></span><span> </span><span class="annot"><span class="annottext">([(Nesting, Target)] -&gt; MaybeT m (KernelNest, Names, Targets))
-&gt; [(Nesting, Target)] -&gt; MaybeT m (KernelNest, Names, Targets)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Nesting] -&gt; [Target] -&gt; [(Nesting, Target)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Nesting]
</span><a href="#local-6989586621684401922"><span class="hs-identifier hs-var">nests</span></a></span><span> </span><span class="annot"><span class="annottext">[Target]
</span><a href="#local-6989586621684401919"><span class="hs-identifier hs-var">targets</span></a></span><span>
</span><span id="line-369"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-370"></span><span>    </span><span id="local-6989586621684401915"><span class="annot"><span class="annottext">prepare :: (b, b, a) -&gt; (a, b)
</span><a href="#local-6989586621684401915"><span class="hs-identifier hs-var hs-var">prepare</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684401913"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684401913"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684401912"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684401912"><span class="hs-identifier hs-var">z</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684401912"><span class="hs-identifier hs-var">z</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684401913"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-371"></span><span>    </span><span id="local-6989586621684401911"><span class="annot"><span class="annottext">bound_in_nest :: Names
</span><a href="#local-6989586621684401911"><span class="hs-identifier hs-var hs-var">bound_in_nest</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Names] -&gt; Names
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">([Names] -&gt; Names) -&gt; [Names] -&gt; Names
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Nesting -&gt; Names) -&gt; [Nesting] -&gt; [Names]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Nesting -&gt; Names
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#boundInNesting"><span class="hs-identifier hs-var">boundInNesting</span></a></span><span> </span><span class="annot"><span class="annottext">([Nesting] -&gt; [Names]) -&gt; [Nesting] -&gt; [Names]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Nesting
</span><a href="#local-6989586621684401923"><span class="hs-identifier hs-var">inner_nest</span></a></span><span> </span><span class="annot"><span class="annottext">Nesting -&gt; [Nesting] -&gt; [Nesting]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Nesting]
</span><a href="#local-6989586621684401922"><span class="hs-identifier hs-var">nests</span></a></span><span>
</span><span id="line-372"></span><span>    </span><span id="local-6989586621684401910"><span class="annot"><span class="annottext">distributableType :: Type -&gt; Bool
</span><a href="#local-6989586621684401910"><span class="hs-identifier hs-var hs-var">distributableType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-373"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Names -&gt; Bool) -&gt; (Type -&gt; Names) -&gt; Type -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#namesIntersection"><span class="hs-identifier hs-var">namesIntersection</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684401911"><span class="hs-identifier hs-var">bound_in_nest</span></a></span><span> </span><span class="annot"><span class="annottext">(Names -&gt; Names) -&gt; (Type -&gt; Names) -&gt; Type -&gt; Names
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; Names
forall a. FreeIn a =&gt; a -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#freeIn"><span class="hs-identifier hs-var">freeIn</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; Names) -&gt; (Type -&gt; [SubExp]) -&gt; Type -&gt; Names
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; [SubExp]
forall u. TypeBase Shape u -&gt; [SubExp]
</span><a href="Futhark.IR.Prop.Types.html#arrayDims"><span class="hs-identifier hs-var">arrayDims</span></a></span><span>
</span><span id="line-374"></span><span>
</span><span id="line-375"></span><span>    </span><span class="annot"><a href="#local-6989586621684401907"><span class="hs-identifier hs-type">distributeAtNesting</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-376"></span><span>      </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Nesting"><span class="hs-identifier hs-type">Nesting</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-377"></span><span>      </span><span class="annot"><a href="Futhark.IR.Syntax.html#PatT"><span class="hs-identifier hs-type">PatT</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-378"></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#LoopNesting"><span class="hs-identifier hs-type">LoopNesting</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#KernelNest"><span class="hs-identifier hs-type">KernelNest</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-379"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Ident"><span class="hs-identifier hs-type">Ident</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-380"></span><span>      </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Ident"><span class="hs-identifier hs-type">Ident</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-381"></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Target"><span class="hs-identifier hs-type">Target</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Targets"><span class="hs-identifier hs-type">Targets</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-382"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">MaybeT</span></span><span> </span><span class="annot"><a href="#local-6989586621684402671"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#KernelNest"><span class="hs-identifier hs-type">KernelNest</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Targets"><span class="hs-identifier hs-type">Targets</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-383"></span><span>    </span><span id="local-6989586621684401907"><span class="annot"><span class="annottext">distributeAtNesting :: Nesting
-&gt; PatT Type
-&gt; (LoopNesting -&gt; KernelNest, Names)
-&gt; Map VName Ident
-&gt; [Ident]
-&gt; (Target -&gt; Targets)
-&gt; MaybeT m (KernelNest, Names, Targets)
</span><a href="#local-6989586621684401907"><span class="hs-identifier hs-var hs-var">distributeAtNesting</span></a></span></span><span>
</span><span id="line-384"></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Nesting"><span class="hs-identifier hs-type">Nesting</span></a></span><span> </span><span id="local-6989586621684401906"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684401906"><span class="hs-identifier hs-var">nest_let_bound</span></a></span></span><span> </span><span id="local-6989586621684401905"><span class="annot"><span class="annottext">LoopNesting
</span><a href="#local-6989586621684401905"><span class="hs-identifier hs-var">nest</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-385"></span><span>      </span><span id="local-6989586621684401904"><span class="annot"><span class="annottext">PatT Type
</span><a href="#local-6989586621684401904"><span class="hs-identifier hs-var">pat</span></a></span></span><span>
</span><span id="line-386"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684401903"><span class="annot"><span class="annottext">LoopNesting -&gt; KernelNest
</span><a href="#local-6989586621684401903"><span class="hs-identifier hs-var">add_to_kernel</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684401902"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684401902"><span class="hs-identifier hs-var">free_in_kernel</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-387"></span><span>      </span><span id="local-6989586621684401901"><span class="annot"><span class="annottext">Map VName Ident
</span><a href="#local-6989586621684401901"><span class="hs-identifier hs-var">identity_map</span></a></span></span><span>
</span><span id="line-388"></span><span>      </span><span id="local-6989586621684401900"><span class="annot"><span class="annottext">[Ident]
</span><a href="#local-6989586621684401900"><span class="hs-identifier hs-var">inner_returned_arrs</span></a></span></span><span>
</span><span id="line-389"></span><span>      </span><span id="local-6989586621684401899"><span class="annot"><span class="annottext">Target -&gt; Targets
</span><a href="#local-6989586621684401899"><span class="hs-identifier hs-var">addTarget</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-390"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684401898"><span class="annot"><span class="annottext">nest' :: LoopNesting
</span><a href="#local-6989586621684401898"><span class="hs-identifier hs-var">nest'</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#MapNesting"><span class="hs-identifier hs-type">MapNesting</span></a></span><span> </span><span class="annot"><span class="annottext">PatT Type
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684401897"><span class="annot"><span class="annottext">StmAux ()
</span><a href="#local-6989586621684401897"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span id="local-6989586621684401896"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684401896"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684401895"><span class="annot"><span class="annottext">[(Param Type, VName)]
</span><a href="#local-6989586621684401895"><span class="hs-identifier hs-var">params_and_arrs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-391"></span><span>              </span><span class="annot"><span class="annottext">Names -&gt; LoopNesting -&gt; LoopNesting
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#removeUnusedNestingParts"><span class="hs-identifier hs-var">removeUnusedNestingParts</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684401902"><span class="hs-identifier hs-var">free_in_kernel</span></a></span><span> </span><span class="annot"><span class="annottext">LoopNesting
</span><a href="#local-6989586621684401905"><span class="hs-identifier hs-var">nest</span></a></span><span>
</span><span id="line-392"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621684401893"><span class="annot"><span class="annottext">[Param Type]
</span><a href="#local-6989586621684401893"><span class="hs-identifier hs-var">params</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684401892"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684401892"><span class="hs-identifier hs-var">arrs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Param Type, VName)] -&gt; ([Param Type], [VName])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">[(Param Type, VName)]
</span><a href="#local-6989586621684401895"><span class="hs-identifier hs-var">params_and_arrs</span></a></span><span>
</span><span id="line-393"></span><span>            </span><span id="local-6989586621684401891"><span class="annot"><span class="annottext">param_names :: Names
</span><a href="#local-6989586621684401891"><span class="hs-identifier hs-var hs-var">param_names</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#namesFromList"><span class="hs-identifier hs-var">namesFromList</span></a></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; Names) -&gt; [VName] -&gt; Names
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Param Type -&gt; VName) -&gt; [Param Type] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Param Type -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">[Param Type]
</span><a href="#local-6989586621684401893"><span class="hs-identifier hs-var">params</span></a></span><span>
</span><span id="line-394"></span><span>            </span><span id="local-6989586621684401890"><span class="annot"><span class="annottext">free_in_kernel' :: Names
</span><a href="#local-6989586621684401890"><span class="hs-identifier hs-var hs-var">free_in_kernel'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-395"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LoopNesting -&gt; Names
forall a. FreeIn a =&gt; a -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#freeIn"><span class="hs-identifier hs-var">freeIn</span></a></span><span> </span><span class="annot"><span class="annottext">LoopNesting
</span><a href="#local-6989586621684401898"><span class="hs-identifier hs-var">nest'</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684401902"><span class="hs-identifier hs-var">free_in_kernel</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#namesSubtract"><span class="hs-operator hs-var">`namesSubtract`</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684401891"><span class="hs-identifier hs-var">param_names</span></a></span><span>
</span><span id="line-396"></span><span>            </span><span id="local-6989586621684401889"><span class="annot"><span class="annottext">required_from_nest :: Names
</span><a href="#local-6989586621684401889"><span class="hs-identifier hs-var hs-var">required_from_nest</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-397"></span><span>              </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684401890"><span class="hs-identifier hs-var">free_in_kernel'</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#namesIntersection"><span class="hs-operator hs-var">`namesIntersection`</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684401906"><span class="hs-identifier hs-var">nest_let_bound</span></a></span><span>
</span><span id="line-398"></span><span>
</span><span id="line-399"></span><span>        </span><span id="local-6989586621684401888"><span class="annot"><span class="annottext">[Ident]
</span><a href="#local-6989586621684401888"><span class="hs-identifier hs-var">required_from_nest_idents</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-400"></span><span>          </span><span class="annot"><span class="annottext">[VName] -&gt; (VName -&gt; MaybeT m Ident) -&gt; MaybeT m [Ident]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Names -&gt; [VName]
</span><a href="Futhark.IR.Prop.Names.html#namesToList"><span class="hs-identifier hs-var">namesToList</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684401889"><span class="hs-identifier hs-var">required_from_nest</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((VName -&gt; MaybeT m Ident) -&gt; MaybeT m [Ident])
-&gt; (VName -&gt; MaybeT m Ident) -&gt; MaybeT m [Ident]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684401886"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684401886"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-401"></span><span>            </span><span id="local-6989586621684401885"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684401885"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m Type -&gt; MaybeT m Type
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(m Type -&gt; MaybeT m Type) -&gt; m Type -&gt; MaybeT m Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; m Type
forall rep (m :: * -&gt; *). HasScope rep m =&gt; VName -&gt; m Type
</span><a href="Futhark.IR.Prop.Scope.html#lookupType"><span class="hs-identifier hs-var">lookupType</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684401886"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-402"></span><span>            </span><span class="annot"><span class="annottext">Ident -&gt; MaybeT m Ident
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Ident -&gt; MaybeT m Ident) -&gt; Ident -&gt; MaybeT m Ident
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Type -&gt; Ident
</span><a href="Futhark.IR.Syntax.Core.html#Ident"><span class="hs-identifier hs-var">Ident</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684401886"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684401885"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-403"></span><span>
</span><span id="line-404"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621684401882"><span class="annot"><span class="annottext">[Param Type]
</span><a href="#local-6989586621684401882"><span class="hs-identifier hs-var">free_params</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684401881"><span class="annot"><span class="annottext">[Ident]
</span><a href="#local-6989586621684401881"><span class="hs-identifier hs-var">free_arrs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684401880"><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621684401880"><span class="hs-identifier hs-var">bind_in_target</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-405"></span><span>          </span><span class="annot"><span class="annottext">([(Param Type, Ident, Bool)] -&gt; ([Param Type], [Ident], [Bool]))
-&gt; MaybeT m [(Param Type, Ident, Bool)]
-&gt; MaybeT m ([Param Type], [Ident], [Bool])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">[(Param Type, Ident, Bool)] -&gt; ([Param Type], [Ident], [Bool])
forall a b c. [(a, b, c)] -&gt; ([a], [b], [c])
</span><span class="hs-identifier hs-var">unzip3</span></span><span> </span><span class="annot"><span class="annottext">(MaybeT m [(Param Type, Ident, Bool)]
 -&gt; MaybeT m ([Param Type], [Ident], [Bool]))
-&gt; MaybeT m [(Param Type, Ident, Bool)]
-&gt; MaybeT m ([Param Type], [Ident], [Bool])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-406"></span><span>            </span><span class="annot"><span class="annottext">[Ident]
-&gt; (Ident -&gt; MaybeT m (Param Type, Ident, Bool))
-&gt; MaybeT m [(Param Type, Ident, Bool)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Ident]
</span><a href="#local-6989586621684401900"><span class="hs-identifier hs-var">inner_returned_arrs</span></a></span><span> </span><span class="annot"><span class="annottext">[Ident] -&gt; [Ident] -&gt; [Ident]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Ident]
</span><a href="#local-6989586621684401888"><span class="hs-identifier hs-var">required_from_nest_idents</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Ident -&gt; MaybeT m (Param Type, Ident, Bool))
 -&gt; MaybeT m [(Param Type, Ident, Bool)])
-&gt; (Ident -&gt; MaybeT m (Param Type, Ident, Bool))
-&gt; MaybeT m [(Param Type, Ident, Bool)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-407"></span><span>              </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Ident"><span class="hs-identifier hs-type">Ident</span></a></span><span> </span><span id="local-6989586621684401878"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684401878"><span class="hs-identifier hs-var">pname</span></a></span></span><span> </span><span id="local-6989586621684401877"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684401877"><span class="hs-identifier hs-var">ptype</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-408"></span><span>                </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Map VName Ident -&gt; Maybe Ident
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684401878"><span class="hs-identifier hs-var">pname</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName Ident
</span><a href="#local-6989586621684401901"><span class="hs-identifier hs-var">identity_map</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-409"></span><span>                  </span><span class="annot"><span class="annottext">Maybe Ident
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-410"></span><span>                    </span><span id="local-6989586621684401875"><span class="annot"><span class="annottext">Ident
</span><a href="#local-6989586621684401875"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-411"></span><span>                      </span><span class="annot"><span class="annottext">String -&gt; Type -&gt; MaybeT m Ident
forall (m :: * -&gt; *).
MonadFreshNames m =&gt;
String -&gt; Type -&gt; m Ident
</span><a href="Futhark.MonadFreshNames.html#newIdent"><span class="hs-identifier hs-var">newIdent</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; String
</span><a href="Language.Futhark.Core.html#baseString"><span class="hs-identifier hs-var">baseString</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684401878"><span class="hs-identifier hs-var">pname</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_r&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Type -&gt; MaybeT m Ident) -&gt; Type -&gt; MaybeT m Ident
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; SubExp -&gt; Type
forall d.
ArrayShape (ShapeBase d) =&gt;
TypeBase (ShapeBase d) NoUniqueness
-&gt; d -&gt; TypeBase (ShapeBase d) NoUniqueness
</span><a href="Futhark.IR.Prop.Types.html#arrayOfRow"><span class="hs-identifier hs-var">arrayOfRow</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684401877"><span class="hs-identifier hs-var">ptype</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684401896"><span class="hs-identifier hs-var">w</span></a></span><span>
</span><span id="line-412"></span><span>                    </span><span class="annot"><span class="annottext">(Param Type, Ident, Bool) -&gt; MaybeT m (Param Type, Ident, Bool)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-413"></span><span>                      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Attrs -&gt; VName -&gt; Type -&gt; Param Type
forall dec. Attrs -&gt; VName -&gt; dec -&gt; Param dec
</span><a href="Futhark.IR.Syntax.Core.html#Param"><span class="hs-identifier hs-var">Param</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684401878"><span class="hs-identifier hs-var">pname</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684401877"><span class="hs-identifier hs-var">ptype</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-414"></span><span>                        </span><span class="annot"><span class="annottext">Ident
</span><a href="#local-6989586621684401875"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-415"></span><span>                        </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-416"></span><span>                      </span><span class="hs-special">)</span><span>
</span><span id="line-417"></span><span>                  </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684401871"><span class="annot"><span class="annottext">Ident
</span><a href="#local-6989586621684401871"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-418"></span><span>                    </span><span class="annot"><span class="annottext">(Param Type, Ident, Bool) -&gt; MaybeT m (Param Type, Ident, Bool)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-419"></span><span>                      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Attrs -&gt; VName -&gt; Type -&gt; Param Type
forall dec. Attrs -&gt; VName -&gt; dec -&gt; Param dec
</span><a href="Futhark.IR.Syntax.Core.html#Param"><span class="hs-identifier hs-var">Param</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684401878"><span class="hs-identifier hs-var">pname</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684401877"><span class="hs-identifier hs-var">ptype</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-420"></span><span>                        </span><span class="annot"><span class="annottext">Ident
</span><a href="#local-6989586621684401871"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-421"></span><span>                        </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-422"></span><span>                      </span><span class="hs-special">)</span><span>
</span><span id="line-423"></span><span>
</span><span id="line-424"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684401870"><span class="annot"><span class="annottext">free_arrs_pat :: PatT Type
</span><a href="#local-6989586621684401870"><span class="hs-identifier hs-var hs-var">free_arrs_pat</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-425"></span><span>              </span><span class="annot"><span class="annottext">[Ident] -&gt; PatT Type
</span><a href="Futhark.IR.Prop.Patterns.html#basicPat"><span class="hs-identifier hs-var">basicPat</span></a></span><span> </span><span class="annot"><span class="annottext">([Ident] -&gt; PatT Type) -&gt; [Ident] -&gt; PatT Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((Bool, Ident) -&gt; Ident) -&gt; [(Bool, Ident)] -&gt; [Ident]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Bool, Ident) -&gt; Ident
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">([(Bool, Ident)] -&gt; [Ident]) -&gt; [(Bool, Ident)] -&gt; [Ident]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((Bool, Ident) -&gt; Bool) -&gt; [(Bool, Ident)] -&gt; [(Bool, Ident)]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="annot"><span class="annottext">(Bool, Ident) -&gt; Bool
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">([(Bool, Ident)] -&gt; [(Bool, Ident)])
-&gt; [(Bool, Ident)] -&gt; [(Bool, Ident)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Bool] -&gt; [Ident] -&gt; [(Bool, Ident)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621684401880"><span class="hs-identifier hs-var">bind_in_target</span></a></span><span> </span><span class="annot"><span class="annottext">[Ident]
</span><a href="#local-6989586621684401881"><span class="hs-identifier hs-var">free_arrs</span></a></span><span>
</span><span id="line-426"></span><span>            </span><span id="local-6989586621684401869"><span class="annot"><span class="annottext">free_params_pat :: [Param Type]
</span><a href="#local-6989586621684401869"><span class="hs-identifier hs-var hs-var">free_params_pat</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-427"></span><span>              </span><span class="annot"><span class="annottext">((Bool, Param Type) -&gt; Param Type)
-&gt; [(Bool, Param Type)] -&gt; [Param Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Bool, Param Type) -&gt; Param Type
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">([(Bool, Param Type)] -&gt; [Param Type])
-&gt; [(Bool, Param Type)] -&gt; [Param Type]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((Bool, Param Type) -&gt; Bool)
-&gt; [(Bool, Param Type)] -&gt; [(Bool, Param Type)]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="annot"><span class="annottext">(Bool, Param Type) -&gt; Bool
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">([(Bool, Param Type)] -&gt; [(Bool, Param Type)])
-&gt; [(Bool, Param Type)] -&gt; [(Bool, Param Type)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Bool] -&gt; [Param Type] -&gt; [(Bool, Param Type)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621684401880"><span class="hs-identifier hs-var">bind_in_target</span></a></span><span> </span><span class="annot"><span class="annottext">[Param Type]
</span><a href="#local-6989586621684401882"><span class="hs-identifier hs-var">free_params</span></a></span><span>
</span><span id="line-428"></span><span>
</span><span id="line-429"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621684401868"><span class="annot"><span class="annottext">[Param Type]
</span><a href="#local-6989586621684401868"><span class="hs-identifier hs-var">actual_params</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684401867"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684401867"><span class="hs-identifier hs-var">actual_arrs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-430"></span><span>              </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">[Param Type]
</span><a href="#local-6989586621684401893"><span class="hs-identifier hs-var">params</span></a></span><span> </span><span class="annot"><span class="annottext">[Param Type] -&gt; [Param Type] -&gt; [Param Type]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Param Type]
</span><a href="#local-6989586621684401882"><span class="hs-identifier hs-var">free_params</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-431"></span><span>                </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684401892"><span class="hs-identifier hs-var">arrs</span></a></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">(Ident -&gt; VName) -&gt; [Ident] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Ident -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#identName"><span class="hs-identifier hs-var hs-var">identName</span></a></span><span> </span><span class="annot"><span class="annottext">[Ident]
</span><a href="#local-6989586621684401881"><span class="hs-identifier hs-var">free_arrs</span></a></span><span>
</span><span id="line-432"></span><span>              </span><span class="hs-special">)</span><span>
</span><span id="line-433"></span><span>            </span><span id="local-6989586621684401865"><span class="annot"><span class="annottext">actual_param_names :: Names
</span><a href="#local-6989586621684401865"><span class="hs-identifier hs-var hs-var">actual_param_names</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-434"></span><span>              </span><span class="annot"><span class="annottext">[VName] -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#namesFromList"><span class="hs-identifier hs-var">namesFromList</span></a></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; Names) -&gt; [VName] -&gt; Names
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Param Type -&gt; VName) -&gt; [Param Type] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Param Type -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">[Param Type]
</span><a href="#local-6989586621684401868"><span class="hs-identifier hs-var">actual_params</span></a></span><span>
</span><span id="line-435"></span><span>
</span><span id="line-436"></span><span>            </span><span id="local-6989586621684401864"><span class="annot"><span class="annottext">nest'' :: LoopNesting
</span><a href="#local-6989586621684401864"><span class="hs-identifier hs-var hs-var">nest''</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-437"></span><span>              </span><span class="annot"><span class="annottext">Names -&gt; LoopNesting -&gt; LoopNesting
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#removeUnusedNestingParts"><span class="hs-identifier hs-var">removeUnusedNestingParts</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684401902"><span class="hs-identifier hs-var">free_in_kernel</span></a></span><span> </span><span class="annot"><span class="annottext">(LoopNesting -&gt; LoopNesting) -&gt; LoopNesting -&gt; LoopNesting
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-438"></span><span>                </span><span class="annot"><span class="annottext">PatT Type
-&gt; StmAux () -&gt; SubExp -&gt; [(Param Type, VName)] -&gt; LoopNesting
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#MapNesting"><span class="hs-identifier hs-var">MapNesting</span></a></span><span> </span><span class="annot"><span class="annottext">PatT Type
</span><a href="#local-6989586621684401904"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux ()
</span><a href="#local-6989586621684401897"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684401896"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">([(Param Type, VName)] -&gt; LoopNesting)
-&gt; [(Param Type, VName)] -&gt; LoopNesting
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Param Type] -&gt; [VName] -&gt; [(Param Type, VName)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Param Type]
</span><a href="#local-6989586621684401868"><span class="hs-identifier hs-var">actual_params</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684401867"><span class="hs-identifier hs-var">actual_arrs</span></a></span><span>
</span><span id="line-439"></span><span>
</span><span id="line-440"></span><span>            </span><span id="local-6989586621684401863"><span class="annot"><span class="annottext">free_in_kernel'' :: Names
</span><a href="#local-6989586621684401863"><span class="hs-identifier hs-var hs-var">free_in_kernel''</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-441"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LoopNesting -&gt; Names
forall a. FreeIn a =&gt; a -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#freeIn"><span class="hs-identifier hs-var">freeIn</span></a></span><span> </span><span class="annot"><span class="annottext">LoopNesting
</span><a href="#local-6989586621684401864"><span class="hs-identifier hs-var">nest''</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684401902"><span class="hs-identifier hs-var">free_in_kernel</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#namesSubtract"><span class="hs-operator hs-var">`namesSubtract`</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684401865"><span class="hs-identifier hs-var">actual_param_names</span></a></span><span>
</span><span id="line-442"></span><span>
</span><span id="line-443"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; MaybeT m () -&gt; MaybeT m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span>
</span><span id="line-444"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">(Param Type -&gt; Bool) -&gt; [Param Type] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Bool
</span><a href="#local-6989586621684401910"><span class="hs-identifier hs-var">distributableType</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Bool) -&gt; (Param Type -&gt; Type) -&gt; Param Type -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Param Type -&gt; Type
forall dec. Typed dec =&gt; Param dec -&gt; Type
</span><a href="Futhark.IR.Prop.Patterns.html#paramType"><span class="hs-identifier hs-var">paramType</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Param Type] -&gt; Bool) -&gt; [Param Type] -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-445"></span><span>              </span><span class="annot"><span class="annottext">LoopNesting -&gt; [Param Type]
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#loopNestingParams"><span class="hs-identifier hs-var">loopNestingParams</span></a></span><span> </span><span class="annot"><span class="annottext">LoopNesting
</span><a href="#local-6989586621684401864"><span class="hs-identifier hs-var">nest''</span></a></span><span>
</span><span id="line-446"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-447"></span><span>          </span><span class="annot"><span class="annottext">(MaybeT m () -&gt; MaybeT m ()) -&gt; MaybeT m () -&gt; MaybeT m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; MaybeT m ()
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Would induce irregular array&quot;</span></span><span>
</span><span id="line-448"></span><span>        </span><span class="annot"><span class="annottext">(KernelNest, Names, Targets)
-&gt; MaybeT m (KernelNest, Names, Targets)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-449"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">LoopNesting -&gt; KernelNest
</span><a href="#local-6989586621684401903"><span class="hs-identifier hs-var">add_to_kernel</span></a></span><span> </span><span class="annot"><span class="annottext">LoopNesting
</span><a href="#local-6989586621684401864"><span class="hs-identifier hs-var">nest''</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-450"></span><span>            </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684401863"><span class="hs-identifier hs-var">free_in_kernel''</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-451"></span><span>            </span><span class="annot"><span class="annottext">Target -&gt; Targets
</span><a href="#local-6989586621684401899"><span class="hs-identifier hs-var">addTarget</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatT Type
</span><a href="#local-6989586621684401870"><span class="hs-identifier hs-var">free_arrs_pat</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Result
</span><a href="Futhark.IR.Syntax.html#varsRes"><span class="hs-identifier hs-var">varsRes</span></a></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; Result) -&gt; [VName] -&gt; Result
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Param Type -&gt; VName) -&gt; [Param Type] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Param Type -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">[Param Type]
</span><a href="#local-6989586621684401869"><span class="hs-identifier hs-var">free_params_pat</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-452"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-453"></span><span>
</span><span id="line-454"></span><span>    </span><span class="annot"><a href="#local-6989586621684401914"><span class="hs-identifier hs-type">recurse</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Nesting"><span class="hs-identifier hs-type">Nesting</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Target"><span class="hs-identifier hs-type">Target</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MaybeT</span></span><span> </span><span class="annot"><a href="#local-6989586621684402671"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#KernelNest"><span class="hs-identifier hs-type">KernelNest</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Targets"><span class="hs-identifier hs-type">Targets</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-455"></span><span>    </span><span id="local-6989586621684401914"><span class="annot"><span class="annottext">recurse :: [(Nesting, Target)] -&gt; MaybeT m (KernelNest, Names, Targets)
</span><a href="#local-6989586621684401914"><span class="hs-identifier hs-var hs-var">recurse</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-456"></span><span>      </span><span class="annot"><span class="annottext">Nesting
-&gt; PatT Type
-&gt; (LoopNesting -&gt; KernelNest, Names)
-&gt; Map VName Ident
-&gt; [Ident]
-&gt; (Target -&gt; Targets)
-&gt; MaybeT m (KernelNest, Names, Targets)
</span><a href="#local-6989586621684401907"><span class="hs-identifier hs-var">distributeAtNesting</span></a></span><span>
</span><span id="line-457"></span><span>        </span><span class="annot"><span class="annottext">Nesting
</span><a href="#local-6989586621684401923"><span class="hs-identifier hs-var">inner_nest</span></a></span><span>
</span><span id="line-458"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DistributionBody -&gt; PatT Type
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#distributionInnerPat"><span class="hs-identifier hs-var">distributionInnerPat</span></a></span><span> </span><span class="annot"><span class="annottext">DistributionBody
</span><a href="#local-6989586621684401921"><span class="hs-identifier hs-var">distrib_body</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-459"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">LoopNesting -&gt; KernelNest
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#newKernel"><span class="hs-identifier hs-var">newKernel</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-460"></span><span>          </span><span class="annot"><span class="annottext">DistributionBody -&gt; Names
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#distributionFreeInBody"><span class="hs-identifier hs-var hs-var">distributionFreeInBody</span></a></span><span> </span><span class="annot"><span class="annottext">DistributionBody
</span><a href="#local-6989586621684401921"><span class="hs-identifier hs-var">distrib_body</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#namesIntersection"><span class="hs-operator hs-var">`namesIntersection`</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684401911"><span class="hs-identifier hs-var">bound_in_nest</span></a></span><span>
</span><span id="line-461"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-462"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DistributionBody -&gt; Map VName Ident
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#distributionIdentityMap"><span class="hs-identifier hs-var hs-var">distributionIdentityMap</span></a></span><span> </span><span class="annot"><span class="annottext">DistributionBody
</span><a href="#local-6989586621684401921"><span class="hs-identifier hs-var">distrib_body</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-463"></span><span>        </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-464"></span><span>        </span><span class="annot"><span class="annottext">((Target -&gt; Targets) -&gt; MaybeT m (KernelNest, Names, Targets))
-&gt; (Target -&gt; Targets) -&gt; MaybeT m (KernelNest, Names, Targets)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Target -&gt; Targets
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#singleTarget"><span class="hs-identifier hs-var">singleTarget</span></a></span><span> </span><span class="annot"><span class="annottext">(Target -&gt; Targets) -&gt; (Target -&gt; Target) -&gt; Target -&gt; Targets
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">DistributionBody -&gt; Target -&gt; Target
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#distributionExpandTarget"><span class="hs-identifier hs-var hs-var">distributionExpandTarget</span></a></span><span> </span><span class="annot"><span class="annottext">DistributionBody
</span><a href="#local-6989586621684401921"><span class="hs-identifier hs-var">distrib_body</span></a></span><span>
</span><span id="line-465"></span><span>    </span><span class="annot"><a href="#local-6989586621684401914"><span class="hs-identifier hs-var">recurse</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621684401859"><span class="annot"><span class="annottext">Nesting
</span><a href="#local-6989586621684401859"><span class="hs-identifier hs-var">nest</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684401858"><span class="annot"><span class="annottext">PatT Type
</span><a href="#local-6989586621684401858"><span class="hs-identifier hs-var">pat</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684401857"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684401857"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684401856"><span class="annot"><span class="annottext">[(Nesting, Target)]
</span><a href="#local-6989586621684401856"><span class="hs-identifier hs-var">nests'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-466"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684401855"><span class="annot"><span class="annottext">kernel :: KernelNest
</span><a href="#local-6989586621684401855"><span class="hs-identifier hs-var">kernel</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621684401854"><span class="annot"><span class="annottext">LoopNesting
</span><a href="#local-6989586621684401854"><span class="hs-identifier hs-var">outer</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[LoopNesting]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621684401853"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684401853"><span class="hs-identifier hs-var">kernel_free</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684401852"><span class="annot"><span class="annottext">Targets
</span><a href="#local-6989586621684401852"><span class="hs-identifier hs-var">kernel_targets</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Nesting, Target)] -&gt; MaybeT m (KernelNest, Names, Targets)
</span><a href="#local-6989586621684401914"><span class="hs-identifier hs-var">recurse</span></a></span><span> </span><span class="annot"><span class="annottext">[(Nesting, Target)]
</span><a href="#local-6989586621684401856"><span class="hs-identifier hs-var">nests'</span></a></span><span>
</span><span id="line-467"></span><span>
</span><span id="line-468"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684401851"><span class="annot"><span class="annottext">PatT Type
</span><a href="#local-6989586621684401851"><span class="hs-identifier hs-var">pat'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684401850"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684401850"><span class="hs-identifier hs-var">res'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684401849"><span class="annot"><span class="annottext">Map VName Ident
</span><a href="#local-6989586621684401849"><span class="hs-identifier hs-var">identity_map</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684401848"><span class="annot"><span class="annottext">Target -&gt; Target
</span><a href="#local-6989586621684401848"><span class="hs-identifier hs-var">expand_target</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-469"></span><span>            </span><span class="annot"><span class="annottext">Names
-&gt; PatT Type
-&gt; Result
-&gt; (PatT Type, Result, Map VName Ident, Target -&gt; Target)
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#removeIdentityMappingFromNesting"><span class="hs-identifier hs-var">removeIdentityMappingFromNesting</span></a></span><span>
</span><span id="line-470"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#namesFromList"><span class="hs-identifier hs-var">namesFromList</span></a></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; Names) -&gt; [VName] -&gt; Names
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatT Type -&gt; [VName]
forall dec. PatT dec -&gt; [VName]
</span><a href="Futhark.IR.Prop.Patterns.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="annot"><span class="annottext">(PatT Type -&gt; [VName]) -&gt; PatT Type -&gt; [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LoopNesting -&gt; PatT Type
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#loopNestingPat"><span class="hs-identifier hs-var hs-var">loopNestingPat</span></a></span><span> </span><span class="annot"><span class="annottext">LoopNesting
</span><a href="#local-6989586621684401854"><span class="hs-identifier hs-var">outer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-471"></span><span>              </span><span class="annot"><span class="annottext">PatT Type
</span><a href="#local-6989586621684401858"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-472"></span><span>              </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684401857"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-473"></span><span>
</span><span id="line-474"></span><span>      </span><span class="annot"><span class="annottext">Nesting
-&gt; PatT Type
-&gt; (LoopNesting -&gt; KernelNest, Names)
-&gt; Map VName Ident
-&gt; [Ident]
-&gt; (Target -&gt; Targets)
-&gt; MaybeT m (KernelNest, Names, Targets)
</span><a href="#local-6989586621684401907"><span class="hs-identifier hs-var">distributeAtNesting</span></a></span><span>
</span><span id="line-475"></span><span>        </span><span class="annot"><span class="annottext">Nesting
</span><a href="#local-6989586621684401859"><span class="hs-identifier hs-var">nest</span></a></span><span>
</span><span id="line-476"></span><span>        </span><span class="annot"><span class="annottext">PatT Type
</span><a href="#local-6989586621684401851"><span class="hs-identifier hs-var">pat'</span></a></span><span>
</span><span id="line-477"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684401846"><span class="annot"><span class="annottext">LoopNesting
</span><a href="#local-6989586621684401846"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Target -&gt; LoopNesting -&gt; KernelNest -&gt; KernelNest
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#pushKernelNesting"><span class="hs-identifier hs-var">pushKernelNesting</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatT Type
</span><a href="#local-6989586621684401851"><span class="hs-identifier hs-var">pat'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684401850"><span class="hs-identifier hs-var">res'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LoopNesting
</span><a href="#local-6989586621684401846"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">KernelNest
</span><a href="#local-6989586621684401855"><span class="hs-identifier hs-var">kernel</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-478"></span><span>          </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684401853"><span class="hs-identifier hs-var">kernel_free</span></a></span><span>
</span><span id="line-479"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-480"></span><span>        </span><span class="annot"><span class="annottext">Map VName Ident
</span><a href="#local-6989586621684401849"><span class="hs-identifier hs-var">identity_map</span></a></span><span>
</span><span id="line-481"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatT Type -&gt; [Ident]
forall dec. Typed dec =&gt; PatT dec -&gt; [Ident]
</span><a href="Futhark.IR.Prop.Patterns.html#patIdents"><span class="hs-identifier hs-var">patIdents</span></a></span><span> </span><span class="annot"><span class="annottext">(PatT Type -&gt; [Ident]) -&gt; PatT Type -&gt; [Ident]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Target -&gt; PatT Type
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">(Target -&gt; PatT Type) -&gt; Target -&gt; PatT Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Targets -&gt; Target
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#outerTarget"><span class="hs-identifier hs-var">outerTarget</span></a></span><span> </span><span class="annot"><span class="annottext">Targets
</span><a href="#local-6989586621684401852"><span class="hs-identifier hs-var">kernel_targets</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-482"></span><span>        </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Target -&gt; Targets -&gt; Targets
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#pushOuterTarget"><span class="hs-operator hs-var">`pushOuterTarget`</span></a></span><span> </span><span class="annot"><span class="annottext">Targets
</span><a href="#local-6989586621684401852"><span class="hs-identifier hs-var">kernel_targets</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Target -&gt; Targets) -&gt; (Target -&gt; Target) -&gt; Target -&gt; Targets
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Target -&gt; Target
</span><a href="#local-6989586621684401848"><span class="hs-identifier hs-var">expand_target</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-483"></span><span>
</span><span id="line-484"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#removeUnusedNestingParts"><span class="hs-identifier hs-type">removeUnusedNestingParts</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#LoopNesting"><span class="hs-identifier hs-type">LoopNesting</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#LoopNesting"><span class="hs-identifier hs-type">LoopNesting</span></a></span><span>
</span><span id="line-485"></span><span id="removeUnusedNestingParts"><span class="annot"><span class="annottext">removeUnusedNestingParts :: Names -&gt; LoopNesting -&gt; LoopNesting
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#removeUnusedNestingParts"><span class="hs-identifier hs-var hs-var">removeUnusedNestingParts</span></a></span></span><span> </span><span id="local-6989586621684401845"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684401845"><span class="hs-identifier hs-var">used</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#MapNesting"><span class="hs-identifier hs-type">MapNesting</span></a></span><span> </span><span id="local-6989586621684401844"><span class="annot"><span class="annottext">PatT Type
</span><a href="#local-6989586621684401844"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684401843"><span class="annot"><span class="annottext">StmAux ()
</span><a href="#local-6989586621684401843"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span id="local-6989586621684401842"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684401842"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684401841"><span class="annot"><span class="annottext">[(Param Type, VName)]
</span><a href="#local-6989586621684401841"><span class="hs-identifier hs-var">params_and_arrs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-486"></span><span>  </span><span class="annot"><span class="annottext">PatT Type
-&gt; StmAux () -&gt; SubExp -&gt; [(Param Type, VName)] -&gt; LoopNesting
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#MapNesting"><span class="hs-identifier hs-var">MapNesting</span></a></span><span> </span><span class="annot"><span class="annottext">PatT Type
</span><a href="#local-6989586621684401844"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux ()
</span><a href="#local-6989586621684401843"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684401842"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">([(Param Type, VName)] -&gt; LoopNesting)
-&gt; [(Param Type, VName)] -&gt; LoopNesting
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Param Type] -&gt; [VName] -&gt; [(Param Type, VName)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Param Type]
</span><a href="#local-6989586621684401840"><span class="hs-identifier hs-var">used_params</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684401839"><span class="hs-identifier hs-var">used_arrs</span></a></span><span>
</span><span id="line-487"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-488"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684401838"><span class="annot"><span class="annottext">[Param Type]
</span><a href="#local-6989586621684401838"><span class="hs-identifier hs-var">params</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684401837"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684401837"><span class="hs-identifier hs-var">arrs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Param Type, VName)] -&gt; ([Param Type], [VName])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">[(Param Type, VName)]
</span><a href="#local-6989586621684401841"><span class="hs-identifier hs-var">params_and_arrs</span></a></span><span>
</span><span id="line-489"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684401840"><span class="annot"><span class="annottext">[Param Type]
</span><a href="#local-6989586621684401840"><span class="hs-identifier hs-var">used_params</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684401839"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684401839"><span class="hs-identifier hs-var">used_arrs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-490"></span><span>      </span><span class="annot"><span class="annottext">[(Param Type, VName)] -&gt; ([Param Type], [VName])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(Param Type, VName)] -&gt; ([Param Type], [VName]))
-&gt; [(Param Type, VName)] -&gt; ([Param Type], [VName])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((Param Type, VName) -&gt; Bool)
-&gt; [(Param Type, VName)] -&gt; [(Param Type, VName)]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#nameIn"><span class="hs-operator hs-var">`nameIn`</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684401845"><span class="hs-identifier hs-var">used</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Bool)
-&gt; ((Param Type, VName) -&gt; VName) -&gt; (Param Type, VName) -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Param Type -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">(Param Type -&gt; VName)
-&gt; ((Param Type, VName) -&gt; Param Type)
-&gt; (Param Type, VName)
-&gt; VName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Param Type, VName) -&gt; Param Type
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(Param Type, VName)] -&gt; [(Param Type, VName)])
-&gt; [(Param Type, VName)] -&gt; [(Param Type, VName)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Param Type] -&gt; [VName] -&gt; [(Param Type, VName)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Param Type]
</span><a href="#local-6989586621684401838"><span class="hs-identifier hs-var">params</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684401837"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-491"></span><span>
</span><span id="line-492"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#removeIdentityMappingGeneral"><span class="hs-identifier hs-type">removeIdentityMappingGeneral</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-493"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-494"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#PatT"><span class="hs-identifier hs-type">PatT</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-495"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Result"><span class="hs-identifier hs-type">Result</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-496"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#PatT"><span class="hs-identifier hs-type">PatT</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-497"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#Result"><span class="hs-identifier hs-type">Result</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-498"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Ident"><span class="hs-identifier hs-type">Ident</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-499"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Target"><span class="hs-identifier hs-type">Target</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Target"><span class="hs-identifier hs-type">Target</span></a></span><span>
</span><span id="line-500"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-501"></span><span id="removeIdentityMappingGeneral"><span class="annot"><span class="annottext">removeIdentityMappingGeneral :: Names
-&gt; PatT Type
-&gt; Result
-&gt; (PatT Type, Result, Map VName Ident, Target -&gt; Target)
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#removeIdentityMappingGeneral"><span class="hs-identifier hs-var hs-var">removeIdentityMappingGeneral</span></a></span></span><span> </span><span id="local-6989586621684401836"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684401836"><span class="hs-identifier hs-var">bound</span></a></span></span><span> </span><span id="local-6989586621684401835"><span class="annot"><span class="annottext">PatT Type
</span><a href="#local-6989586621684401835"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684401834"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684401834"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-502"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684401833"><span class="annot"><span class="annottext">[(PatElemT Type, (Certs, VName))]
</span><a href="#local-6989586621684401833"><span class="hs-identifier hs-var">identities</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684401832"><span class="annot"><span class="annottext">[(PatElemT Type, SubExpRes)]
</span><a href="#local-6989586621684401832"><span class="hs-identifier hs-var">not_identities</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-503"></span><span>        </span><span class="annot"><span class="annottext">((PatElemT Type, SubExpRes)
 -&gt; Either
      (PatElemT Type, (Certs, VName)) (PatElemT Type, SubExpRes))
-&gt; [(PatElemT Type, SubExpRes)]
-&gt; ([(PatElemT Type, (Certs, VName))],
    [(PatElemT Type, SubExpRes)])
forall a b c. (a -&gt; Either b c) -&gt; [a] -&gt; ([b], [c])
</span><a href="Futhark.Util.html#mapEither"><span class="hs-identifier hs-var">mapEither</span></a></span><span> </span><span class="annot"><span class="annottext">(PatElemT Type, SubExpRes)
-&gt; Either
     (PatElemT Type, (Certs, VName)) (PatElemT Type, SubExpRes)
</span><a href="#local-6989586621684401830"><span class="hs-identifier hs-var">isIdentity</span></a></span><span> </span><span class="annot"><span class="annottext">([(PatElemT Type, SubExpRes)]
 -&gt; ([(PatElemT Type, (Certs, VName))],
     [(PatElemT Type, SubExpRes)]))
-&gt; [(PatElemT Type, SubExpRes)]
-&gt; ([(PatElemT Type, (Certs, VName))],
    [(PatElemT Type, SubExpRes)])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[PatElemT Type] -&gt; Result -&gt; [(PatElemT Type, SubExpRes)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatT Type -&gt; [PatElemT Type]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span> </span><span class="annot"><span class="annottext">PatT Type
</span><a href="#local-6989586621684401835"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684401834"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-504"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684401829"><span class="annot"><span class="annottext">[PatElemT Type]
</span><a href="#local-6989586621684401829"><span class="hs-identifier hs-var">not_identity_patElems</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684401828"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684401828"><span class="hs-identifier hs-var">not_identity_res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(PatElemT Type, SubExpRes)] -&gt; ([PatElemT Type], Result)
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">[(PatElemT Type, SubExpRes)]
</span><a href="#local-6989586621684401832"><span class="hs-identifier hs-var">not_identities</span></a></span><span>
</span><span id="line-505"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684401827"><span class="annot"><span class="annottext">[PatElemT Type]
</span><a href="#local-6989586621684401827"><span class="hs-identifier hs-var">identity_patElems</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684401826"><span class="annot"><span class="annottext">[(Certs, VName)]
</span><a href="#local-6989586621684401826"><span class="hs-identifier hs-var">identity_res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(PatElemT Type, (Certs, VName))]
-&gt; ([PatElemT Type], [(Certs, VName)])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">[(PatElemT Type, (Certs, VName))]
</span><a href="#local-6989586621684401833"><span class="hs-identifier hs-var">identities</span></a></span><span>
</span><span id="line-506"></span><span>      </span><span id="local-6989586621684401825"><span class="annot"><span class="annottext">expandTarget :: Target -&gt; Target
</span><a href="#local-6989586621684401825"><span class="hs-identifier hs-var hs-var">expandTarget</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684401824"><span class="annot"><span class="annottext">PatT Type
</span><a href="#local-6989586621684401824"><span class="hs-identifier hs-var">tpat</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684401823"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684401823"><span class="hs-identifier hs-var">tres</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-507"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">[PatElemT Type] -&gt; PatT Type
forall dec. [PatElemT dec] -&gt; PatT dec
</span><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-var">Pat</span></a></span><span> </span><span class="annot"><span class="annottext">([PatElemT Type] -&gt; PatT Type) -&gt; [PatElemT Type] -&gt; PatT Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatT Type -&gt; [PatElemT Type]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span> </span><span class="annot"><span class="annottext">PatT Type
</span><a href="#local-6989586621684401824"><span class="hs-identifier hs-var">tpat</span></a></span><span> </span><span class="annot"><span class="annottext">[PatElemT Type] -&gt; [PatElemT Type] -&gt; [PatElemT Type]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[PatElemT Type]
</span><a href="#local-6989586621684401827"><span class="hs-identifier hs-var">identity_patElems</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-508"></span><span>          </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684401823"><span class="hs-identifier hs-var">tres</span></a></span><span> </span><span class="annot"><span class="annottext">Result -&gt; Result -&gt; Result
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">((Certs, VName) -&gt; SubExpRes) -&gt; [(Certs, VName)] -&gt; Result
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Certs -&gt; SubExp -&gt; SubExpRes) -&gt; (Certs, SubExp) -&gt; SubExpRes
forall a b c. (a -&gt; b -&gt; c) -&gt; (a, b) -&gt; c
</span><span class="hs-identifier hs-var">uncurry</span></span><span> </span><span class="annot"><span class="annottext">Certs -&gt; SubExp -&gt; SubExpRes
</span><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-var">SubExpRes</span></a></span><span> </span><span class="annot"><span class="annottext">((Certs, SubExp) -&gt; SubExpRes)
-&gt; ((Certs, VName) -&gt; (Certs, SubExp))
-&gt; (Certs, VName)
-&gt; SubExpRes
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SubExp) -&gt; (Certs, VName) -&gt; (Certs, SubExp)
forall (p :: * -&gt; * -&gt; *) b c a.
Bifunctor p =&gt;
(b -&gt; c) -&gt; p a b -&gt; p a c
</span><span class="hs-identifier hs-var">second</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Certs, VName)]
</span><a href="#local-6989586621684401826"><span class="hs-identifier hs-var">identity_res</span></a></span><span>
</span><span id="line-509"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-510"></span><span>      </span><span id="local-6989586621684401822"><span class="annot"><span class="annottext">identity_map :: Map VName Ident
</span><a href="#local-6989586621684401822"><span class="hs-identifier hs-var hs-var">identity_map</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-511"></span><span>        </span><span class="annot"><span class="annottext">[(VName, Ident)] -&gt; Map VName Ident
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="annot"><span class="annottext">([(VName, Ident)] -&gt; Map VName Ident)
-&gt; [(VName, Ident)] -&gt; Map VName Ident
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [Ident] -&gt; [(VName, Ident)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Certs, VName) -&gt; VName) -&gt; [(Certs, VName)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Certs, VName) -&gt; VName
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">[(Certs, VName)]
</span><a href="#local-6989586621684401826"><span class="hs-identifier hs-var">identity_res</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Ident] -&gt; [(VName, Ident)]) -&gt; [Ident] -&gt; [(VName, Ident)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(PatElemT Type -&gt; Ident) -&gt; [PatElemT Type] -&gt; [Ident]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">PatElemT Type -&gt; Ident
forall dec. Typed dec =&gt; PatElemT dec -&gt; Ident
</span><a href="Futhark.IR.Prop.Patterns.html#patElemIdent"><span class="hs-identifier hs-var">patElemIdent</span></a></span><span> </span><span class="annot"><span class="annottext">[PatElemT Type]
</span><a href="#local-6989586621684401827"><span class="hs-identifier hs-var">identity_patElems</span></a></span><span>
</span><span id="line-512"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">[PatElemT Type] -&gt; PatT Type
forall dec. [PatElemT dec] -&gt; PatT dec
</span><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-var">Pat</span></a></span><span> </span><span class="annot"><span class="annottext">[PatElemT Type]
</span><a href="#local-6989586621684401829"><span class="hs-identifier hs-var">not_identity_patElems</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-513"></span><span>        </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684401828"><span class="hs-identifier hs-var">not_identity_res</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-514"></span><span>        </span><span class="annot"><span class="annottext">Map VName Ident
</span><a href="#local-6989586621684401822"><span class="hs-identifier hs-var">identity_map</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-515"></span><span>        </span><span class="annot"><span class="annottext">Target -&gt; Target
</span><a href="#local-6989586621684401825"><span class="hs-identifier hs-var">expandTarget</span></a></span><span>
</span><span id="line-516"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-517"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-518"></span><span>    </span><span id="local-6989586621684401830"><span class="annot"><span class="annottext">isIdentity :: (PatElemT Type, SubExpRes)
-&gt; Either
     (PatElemT Type, (Certs, VName)) (PatElemT Type, SubExpRes)
</span><a href="#local-6989586621684401830"><span class="hs-identifier hs-var hs-var">isIdentity</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684401820"><span class="annot"><span class="annottext">PatElemT Type
</span><a href="#local-6989586621684401820"><span class="hs-identifier hs-var">patElem</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-type">SubExpRes</span></a></span><span> </span><span id="local-6989586621684401819"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684401819"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684401818"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684401818"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-519"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684401818"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#nameIn"><span class="hs-operator hs-var">`nameIn`</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684401836"><span class="hs-identifier hs-var">bound</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(PatElemT Type, (Certs, VName))
-&gt; Either
     (PatElemT Type, (Certs, VName)) (PatElemT Type, SubExpRes)
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT Type
</span><a href="#local-6989586621684401820"><span class="hs-identifier hs-var">patElem</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684401819"><span class="hs-identifier hs-var">cs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684401818"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-520"></span><span>    </span><span class="annot"><a href="#local-6989586621684401830"><span class="hs-identifier hs-var">isIdentity</span></a></span><span> </span><span id="local-6989586621684401816"><span class="annot"><span class="annottext">(PatElemT Type, SubExpRes)
</span><a href="#local-6989586621684401816"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(PatElemT Type, SubExpRes)
-&gt; Either
     (PatElemT Type, (Certs, VName)) (PatElemT Type, SubExpRes)
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">(PatElemT Type, SubExpRes)
</span><a href="#local-6989586621684401816"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-521"></span><span>
</span><span id="line-522"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#removeIdentityMappingFromNesting"><span class="hs-identifier hs-type">removeIdentityMappingFromNesting</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-523"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-524"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#PatT"><span class="hs-identifier hs-type">PatT</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-525"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Result"><span class="hs-identifier hs-type">Result</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-526"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#PatT"><span class="hs-identifier hs-type">PatT</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-527"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#Result"><span class="hs-identifier hs-type">Result</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-528"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Ident"><span class="hs-identifier hs-type">Ident</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-529"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Target"><span class="hs-identifier hs-type">Target</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Target"><span class="hs-identifier hs-type">Target</span></a></span><span>
</span><span id="line-530"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-531"></span><span id="removeIdentityMappingFromNesting"><span class="annot"><span class="annottext">removeIdentityMappingFromNesting :: Names
-&gt; PatT Type
-&gt; Result
-&gt; (PatT Type, Result, Map VName Ident, Target -&gt; Target)
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#removeIdentityMappingFromNesting"><span class="hs-identifier hs-var hs-var">removeIdentityMappingFromNesting</span></a></span></span><span> </span><span id="local-6989586621684401815"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684401815"><span class="hs-identifier hs-var">bound_in_nesting</span></a></span></span><span> </span><span id="local-6989586621684401814"><span class="annot"><span class="annottext">PatT Type
</span><a href="#local-6989586621684401814"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684401813"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684401813"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-532"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684401812"><span class="annot"><span class="annottext">PatT Type
</span><a href="#local-6989586621684401812"><span class="hs-identifier hs-var">pat'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684401811"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684401811"><span class="hs-identifier hs-var">res'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684401810"><span class="annot"><span class="annottext">Map VName Ident
</span><a href="#local-6989586621684401810"><span class="hs-identifier hs-var">identity_map</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684401809"><span class="annot"><span class="annottext">Target -&gt; Target
</span><a href="#local-6989586621684401809"><span class="hs-identifier hs-var">expand_target</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-533"></span><span>        </span><span class="annot"><span class="annottext">Names
-&gt; PatT Type
-&gt; Result
-&gt; (PatT Type, Result, Map VName Ident, Target -&gt; Target)
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#removeIdentityMappingGeneral"><span class="hs-identifier hs-var">removeIdentityMappingGeneral</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684401815"><span class="hs-identifier hs-var">bound_in_nesting</span></a></span><span> </span><span class="annot"><span class="annottext">PatT Type
</span><a href="#local-6989586621684401814"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684401813"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-534"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatT Type
</span><a href="#local-6989586621684401812"><span class="hs-identifier hs-var">pat'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684401811"><span class="hs-identifier hs-var">res'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map VName Ident
</span><a href="#local-6989586621684401810"><span class="hs-identifier hs-var">identity_map</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Target -&gt; Target
</span><a href="#local-6989586621684401809"><span class="hs-identifier hs-var">expand_target</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-535"></span><span>
</span><span id="line-536"></span><span id="local-6989586621684402625"><span id="local-6989586621684402626"><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#tryDistribute"><span class="hs-identifier hs-type">tryDistribute</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-537"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.BlockedKernel.html#DistRep"><span class="hs-identifier hs-type">DistRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684402626"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-538"></span><span>    </span><span class="annot"><a href="Futhark.MonadFreshNames.html#MonadFreshNames"><span class="hs-identifier hs-type">MonadFreshNames</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684402625"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-539"></span><span>    </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#LocalScope"><span class="hs-identifier hs-type">LocalScope</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684402626"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684402625"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-540"></span><span>    </span><span class="annot"><a href="Futhark.Util.Log.html#MonadLogger"><span class="hs-identifier hs-type">MonadLogger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684402625"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-541"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-542"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.BlockedKernel.html#MkSegLevel"><span class="hs-identifier hs-type">MkSegLevel</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684402626"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684402625"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-543"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Nestings"><span class="hs-identifier hs-type">Nestings</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-544"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Targets"><span class="hs-identifier hs-type">Targets</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-545"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684402626"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-546"></span><span>  </span><span class="annot"><a href="#local-6989586621684402625"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Targets"><span class="hs-identifier hs-type">Targets</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684402626"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-547"></span><span id="tryDistribute"><span class="annot"><span class="annottext">tryDistribute :: forall rep (m :: * -&gt; *).
(DistRep rep, MonadFreshNames m, LocalScope rep m,
 MonadLogger m) =&gt;
MkSegLevel rep m
-&gt; Nestings -&gt; Targets -&gt; Stms rep -&gt; m (Maybe (Targets, Stms rep))
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#tryDistribute"><span class="hs-identifier hs-var hs-var">tryDistribute</span></a></span></span><span> </span><span class="annot"><span class="annottext">MkSegLevel rep m
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Nestings
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684401720"><span class="annot"><span class="annottext">Targets
</span><a href="#local-6989586621684401720"><span class="hs-identifier hs-var">targets</span></a></span></span><span> </span><span id="local-6989586621684401719"><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684401719"><span class="hs-identifier hs-var">stms</span></a></span></span><span>
</span><span id="line-548"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Stms rep -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684401719"><span class="hs-identifier hs-var">stms</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-549"></span><span>    </span><span class="hs-comment">-- No point in distributing an empty kernel.</span><span>
</span><span id="line-550"></span><span>    </span><span class="annot"><span class="annottext">Maybe (Targets, Stms rep) -&gt; m (Maybe (Targets, Stms rep))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (Targets, Stms rep) -&gt; m (Maybe (Targets, Stms rep)))
-&gt; Maybe (Targets, Stms rep) -&gt; m (Maybe (Targets, Stms rep))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Targets, Stms rep) -&gt; Maybe (Targets, Stms rep)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Targets
</span><a href="#local-6989586621684401720"><span class="hs-identifier hs-var">targets</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stms rep
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span>
</span><span id="line-551"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#tryDistribute"><span class="hs-identifier hs-var">tryDistribute</span></a></span><span> </span><span id="local-6989586621684401717"><span class="annot"><span class="annottext">MkSegLevel rep m
</span><a href="#local-6989586621684401717"><span class="hs-identifier hs-var">mk_lvl</span></a></span></span><span> </span><span id="local-6989586621684401716"><span class="annot"><span class="annottext">Nestings
</span><a href="#local-6989586621684401716"><span class="hs-identifier hs-var">nest</span></a></span></span><span> </span><span id="local-6989586621684401715"><span class="annot"><span class="annottext">Targets
</span><a href="#local-6989586621684401715"><span class="hs-identifier hs-var">targets</span></a></span></span><span> </span><span id="local-6989586621684401714"><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684401714"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-552"></span><span>  </span><span class="annot"><span class="annottext">Nestings -&gt; DistributionBody -&gt; m (Maybe (Targets, KernelNest))
forall rep (m :: * -&gt; *).
(MonadFreshNames m, HasScope rep m) =&gt;
Nestings -&gt; DistributionBody -&gt; m (Maybe (Targets, KernelNest))
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#createKernelNest"><span class="hs-identifier hs-var">createKernelNest</span></a></span><span> </span><span class="annot"><span class="annottext">Nestings
</span><a href="#local-6989586621684401716"><span class="hs-identifier hs-var">nest</span></a></span><span> </span><span class="annot"><span class="annottext">DistributionBody
</span><a href="#local-6989586621684401713"><span class="hs-identifier hs-var">dist_body</span></a></span><span>
</span><span id="line-553"></span><span>    </span><span class="annot"><span class="annottext">m (Maybe (Targets, KernelNest))
-&gt; (Maybe (Targets, KernelNest) -&gt; m (Maybe (Targets, Stms rep)))
-&gt; m (Maybe (Targets, Stms rep))
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-554"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684401712"><span class="annot"><span class="annottext">Targets
</span><a href="#local-6989586621684401712"><span class="hs-identifier hs-var">targets'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684401711"><span class="annot"><span class="annottext">KernelNest
</span><a href="#local-6989586621684401711"><span class="hs-identifier hs-var">distributed</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-555"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621684401710"><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684401710"><span class="hs-identifier hs-var">kernel_stm</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684401709"><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684401709"><span class="hs-identifier hs-var">w_stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-556"></span><span>          </span><span class="annot"><span class="annottext">Scope rep -&gt; m (Stm rep, Stms rep) -&gt; m (Stm rep, Stms rep)
forall rep (m :: * -&gt; *) a.
LocalScope rep m =&gt;
Scope rep -&gt; m a -&gt; m a
</span><a href="Futhark.IR.Prop.Scope.html#localScope"><span class="hs-identifier hs-var">localScope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Targets -&gt; Scope rep
forall rep. DistRep rep =&gt; Targets -&gt; Scope rep
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#targetsScope"><span class="hs-identifier hs-var">targetsScope</span></a></span><span> </span><span class="annot"><span class="annottext">Targets
</span><a href="#local-6989586621684401712"><span class="hs-identifier hs-var">targets'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m (Stm rep, Stms rep) -&gt; m (Stm rep, Stms rep))
-&gt; m (Stm rep, Stms rep) -&gt; m (Stm rep, Stms rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-557"></span><span>            </span><span class="annot"><span class="annottext">MkSegLevel rep m -&gt; KernelNest -&gt; Body rep -&gt; m (Stm rep, Stms rep)
forall rep (m :: * -&gt; *).
(DistRep rep, MonadFreshNames m, LocalScope rep m) =&gt;
MkSegLevel rep m -&gt; KernelNest -&gt; Body rep -&gt; m (Stm rep, Stms rep)
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#constructKernel"><span class="hs-identifier hs-var">constructKernel</span></a></span><span> </span><span class="annot"><span class="annottext">MkSegLevel rep m
</span><a href="#local-6989586621684401717"><span class="hs-identifier hs-var">mk_lvl</span></a></span><span> </span><span class="annot"><span class="annottext">KernelNest
</span><a href="#local-6989586621684401711"><span class="hs-identifier hs-var">distributed</span></a></span><span> </span><span class="annot"><span class="annottext">(Body rep -&gt; m (Stm rep, Stms rep))
-&gt; Body rep -&gt; m (Stm rep, Stms rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stms rep -&gt; Result -&gt; Body rep
forall rep. Buildable rep =&gt; Stms rep -&gt; Result -&gt; Body rep
</span><a href="Futhark.Builder.Class.html#mkBody"><span class="hs-identifier hs-var">mkBody</span></a></span><span> </span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684401714"><span class="hs-identifier hs-var">stms</span></a></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684401707"><span class="hs-identifier hs-var">inner_body_res</span></a></span><span>
</span><span id="line-558"></span><span>        </span><span id="local-6989586621684401706"><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684401706"><span class="hs-identifier hs-var">distributed'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; m (Stm rep)
forall rep (m :: * -&gt; *).
(Renameable rep, MonadFreshNames m) =&gt;
Stm rep -&gt; m (Stm rep)
</span><a href="Futhark.Transform.Rename.html#renameStm"><span class="hs-identifier hs-var">renameStm</span></a></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684401710"><span class="hs-identifier hs-var">kernel_stm</span></a></span><span>
</span><span id="line-559"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; m ()
forall (m :: * -&gt; *) a. (MonadLogger m, ToLog a) =&gt; a -&gt; m ()
</span><a href="Futhark.Util.Log.html#logMsg"><span class="hs-identifier hs-var">logMsg</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; m ()) -&gt; String -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-560"></span><span>          </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;distributing\n&quot;</span></span><span>
</span><span id="line-561"></span><span>            </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[String] -&gt; String
</span><span class="hs-identifier hs-var">unlines</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Stm rep -&gt; String) -&gt; [Stm rep] -&gt; [String]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">([Stm rep] -&gt; [String]) -&gt; [Stm rep] -&gt; [String]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stms rep -&gt; [Stm rep]
forall rep. Stms rep -&gt; [Stm rep]
</span><a href="Futhark.IR.Syntax.html#stmsToList"><span class="hs-identifier hs-var">stmsToList</span></a></span><span> </span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684401714"><span class="hs-identifier hs-var">stms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-562"></span><span>            </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Result -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Target -&gt; Result
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">(Target -&gt; Result) -&gt; Target -&gt; Result
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Targets -&gt; Target
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#innerTarget"><span class="hs-identifier hs-var">innerTarget</span></a></span><span> </span><span class="annot"><span class="annottext">Targets
</span><a href="#local-6989586621684401715"><span class="hs-identifier hs-var">targets</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-563"></span><span>            </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;\nas\n&quot;</span></span><span>
</span><span id="line-564"></span><span>            </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684401706"><span class="hs-identifier hs-var">distributed'</span></a></span><span>
</span><span id="line-565"></span><span>            </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;\ndue to targets\n&quot;</span></span><span>
</span><span id="line-566"></span><span>            </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Targets -&gt; String
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#ppTargets"><span class="hs-identifier hs-var">ppTargets</span></a></span><span> </span><span class="annot"><span class="annottext">Targets
</span><a href="#local-6989586621684401715"><span class="hs-identifier hs-var">targets</span></a></span><span>
</span><span id="line-567"></span><span>            </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;\nand with new targets\n&quot;</span></span><span>
</span><span id="line-568"></span><span>            </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Targets -&gt; String
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#ppTargets"><span class="hs-identifier hs-var">ppTargets</span></a></span><span> </span><span class="annot"><span class="annottext">Targets
</span><a href="#local-6989586621684401712"><span class="hs-identifier hs-var">targets'</span></a></span><span>
</span><span id="line-569"></span><span>        </span><span class="annot"><span class="annottext">Maybe (Targets, Stms rep) -&gt; m (Maybe (Targets, Stms rep))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (Targets, Stms rep) -&gt; m (Maybe (Targets, Stms rep)))
-&gt; Maybe (Targets, Stms rep) -&gt; m (Maybe (Targets, Stms rep))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Targets, Stms rep) -&gt; Maybe (Targets, Stms rep)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Targets
</span><a href="#local-6989586621684401712"><span class="hs-identifier hs-var">targets'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684401709"><span class="hs-identifier hs-var">w_stms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms rep -&gt; Stms rep -&gt; Stms rep
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; Stms rep
forall rep. Stm rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#oneStm"><span class="hs-identifier hs-var">oneStm</span></a></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684401706"><span class="hs-identifier hs-var">distributed'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-570"></span><span>      </span><span class="annot"><span class="annottext">Maybe (Targets, KernelNest)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-571"></span><span>        </span><span class="annot"><span class="annottext">Maybe (Targets, Stms rep) -&gt; m (Maybe (Targets, Stms rep))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Targets, Stms rep)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-572"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-573"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684401713"><span class="annot"><span class="annottext">DistributionBody
</span><a href="#local-6989586621684401713"><span class="hs-identifier hs-var">dist_body</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684401707"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684401707"><span class="hs-identifier hs-var">inner_body_res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Targets -&gt; Stms rep -&gt; (DistributionBody, Result)
forall rep.
ASTRep rep =&gt;
Targets -&gt; Stms rep -&gt; (DistributionBody, Result)
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#distributionBodyFromStms"><span class="hs-identifier hs-var">distributionBodyFromStms</span></a></span><span> </span><span class="annot"><span class="annottext">Targets
</span><a href="#local-6989586621684401715"><span class="hs-identifier hs-var">targets</span></a></span><span> </span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684401714"><span class="hs-identifier hs-var">stms</span></a></span><span>
</span><span id="line-574"></span><span>
</span><span id="line-575"></span><span id="local-6989586621684402603"><span id="local-6989586621684402604"><span id="local-6989586621684402605"><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#tryDistributeStm"><span class="hs-identifier hs-type">tryDistributeStm</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-576"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.MonadFreshNames.html#MonadFreshNames"><span class="hs-identifier hs-type">MonadFreshNames</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684402605"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#HasScope"><span class="hs-identifier hs-type">HasScope</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684402604"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684402605"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.html#ASTRep"><span class="hs-identifier hs-type">ASTRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684402603"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-577"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Nestings"><span class="hs-identifier hs-type">Nestings</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-578"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Targets"><span class="hs-identifier hs-type">Targets</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-579"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684402603"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-580"></span><span>  </span><span class="annot"><a href="#local-6989586621684402605"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Result"><span class="hs-identifier hs-type">Result</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#Targets"><span class="hs-identifier hs-type">Targets</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.Distribution.html#KernelNest"><span class="hs-identifier hs-type">KernelNest</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-581"></span><span id="tryDistributeStm"><span class="annot"><span class="annottext">tryDistributeStm :: forall (m :: * -&gt; *) t rep.
(MonadFreshNames m, HasScope t m, ASTRep rep) =&gt;
Nestings
-&gt; Targets -&gt; Stm rep -&gt; m (Maybe (Result, Targets, KernelNest))
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#tryDistributeStm"><span class="hs-identifier hs-var hs-var">tryDistributeStm</span></a></span></span><span> </span><span id="local-6989586621684401692"><span class="annot"><span class="annottext">Nestings
</span><a href="#local-6989586621684401692"><span class="hs-identifier hs-var">nest</span></a></span></span><span> </span><span id="local-6989586621684401691"><span class="annot"><span class="annottext">Targets
</span><a href="#local-6989586621684401691"><span class="hs-identifier hs-var">targets</span></a></span></span><span> </span><span id="local-6989586621684401690"><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684401690"><span class="hs-identifier hs-var">stm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-582"></span><span>  </span><span class="annot"><span class="annottext">((Targets, KernelNest) -&gt; (Result, Targets, KernelNest))
-&gt; Maybe (Targets, KernelNest)
-&gt; Maybe (Result, Targets, KernelNest)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">(Targets, KernelNest) -&gt; (Result, Targets, KernelNest)
</span><a href="#local-6989586621684401689"><span class="hs-identifier hs-var">addRes</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (Targets, KernelNest)
 -&gt; Maybe (Result, Targets, KernelNest))
-&gt; m (Maybe (Targets, KernelNest))
-&gt; m (Maybe (Result, Targets, KernelNest))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Nestings -&gt; DistributionBody -&gt; m (Maybe (Targets, KernelNest))
forall rep (m :: * -&gt; *).
(MonadFreshNames m, HasScope rep m) =&gt;
Nestings -&gt; DistributionBody -&gt; m (Maybe (Targets, KernelNest))
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#createKernelNest"><span class="hs-identifier hs-var">createKernelNest</span></a></span><span> </span><span class="annot"><span class="annottext">Nestings
</span><a href="#local-6989586621684401692"><span class="hs-identifier hs-var">nest</span></a></span><span> </span><span class="annot"><span class="annottext">DistributionBody
</span><a href="#local-6989586621684401688"><span class="hs-identifier hs-var">dist_body</span></a></span><span>
</span><span id="line-583"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-584"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684401688"><span class="annot"><span class="annottext">DistributionBody
</span><a href="#local-6989586621684401688"><span class="hs-identifier hs-var">dist_body</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684401687"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684401687"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Targets -&gt; Stm rep -&gt; (DistributionBody, Result)
forall rep.
ASTRep rep =&gt;
Targets -&gt; Stm rep -&gt; (DistributionBody, Result)
</span><a href="Futhark.Pass.ExtractKernels.Distribution.html#distributionBodyFromStm"><span class="hs-identifier hs-var">distributionBodyFromStm</span></a></span><span> </span><span class="annot"><span class="annottext">Targets
</span><a href="#local-6989586621684401691"><span class="hs-identifier hs-var">targets</span></a></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684401690"><span class="hs-identifier hs-var">stm</span></a></span><span>
</span><span id="line-585"></span><span>    </span><span id="local-6989586621684401689"><span class="annot"><span class="annottext">addRes :: (Targets, KernelNest) -&gt; (Result, Targets, KernelNest)
</span><a href="#local-6989586621684401689"><span class="hs-identifier hs-var hs-var">addRes</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684401686"><span class="annot"><span class="annottext">Targets
</span><a href="#local-6989586621684401686"><span class="hs-identifier hs-var">targets'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684401685"><span class="annot"><span class="annottext">KernelNest
</span><a href="#local-6989586621684401685"><span class="hs-identifier hs-var">kernel_nest</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684401687"><span class="hs-identifier hs-var">res</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Targets
</span><a href="#local-6989586621684401686"><span class="hs-identifier hs-var">targets'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">KernelNest
</span><a href="#local-6989586621684401685"><span class="hs-identifier hs-var">kernel_nest</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-586"></span></pre></body></html>