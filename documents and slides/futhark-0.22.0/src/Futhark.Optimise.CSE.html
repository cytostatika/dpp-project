<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE FlexibleInstances #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE MultiParamTypeClasses #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE UndecidableInstances #-}</span><span>
</span><span id="line-5"></span><span>
</span><span id="line-6"></span><span class="hs-comment">-- | This module implements common-subexpression elimination.  This</span><span>
</span><span id="line-7"></span><span class="hs-comment">-- module does not actually remove the duplicate, but only replaces</span><span>
</span><span id="line-8"></span><span class="hs-comment">-- one with a diference to the other.  E.g:</span><span>
</span><span id="line-9"></span><span class="hs-comment">--</span><span>
</span><span id="line-10"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-11"></span><span class="hs-comment">--   let a = x + y</span><span>
</span><span id="line-12"></span><span class="hs-comment">--   let b = x + y</span><span>
</span><span id="line-13"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-14"></span><span class="hs-comment">--</span><span>
</span><span id="line-15"></span><span class="hs-comment">-- becomes:</span><span>
</span><span id="line-16"></span><span class="hs-comment">--</span><span>
</span><span id="line-17"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-18"></span><span class="hs-comment">--   let a = x + y</span><span>
</span><span id="line-19"></span><span class="hs-comment">--   let b = a</span><span>
</span><span id="line-20"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-21"></span><span class="hs-comment">--</span><span>
</span><span id="line-22"></span><span class="hs-comment">-- After which copy propagation in the simplifier will actually remove</span><span>
</span><span id="line-23"></span><span class="hs-comment">-- the definition of @b@.</span><span>
</span><span id="line-24"></span><span class="hs-comment">--</span><span>
</span><span id="line-25"></span><span class="hs-comment">-- Our CSE is still rather stupid.  No normalisation is performed, so</span><span>
</span><span id="line-26"></span><span class="hs-comment">-- the expressions @x+y@ and @y+x@ will be considered distinct.</span><span>
</span><span id="line-27"></span><span class="hs-comment">-- Furthermore, no expression with its own binding will be considered</span><span>
</span><span id="line-28"></span><span class="hs-comment">-- equal to any other, since the variable names will be distinct.</span><span>
</span><span id="line-29"></span><span class="hs-comment">-- This affects SOACs in particular.</span><span>
</span><span id="line-30"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Futhark.Optimise.CSE</span><span>
</span><span id="line-31"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.Optimise.CSE.html#performCSE"><span class="hs-identifier">performCSE</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-32"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.CSE.html#performCSEOnFunDef"><span class="hs-identifier">performCSEOnFunDef</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-33"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.CSE.html#performCSEOnStms"><span class="hs-identifier">performCSEOnStms</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-34"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.CSE.html#CSEInOp"><span class="hs-identifier">CSEInOp</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-35"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-36"></span><span class="hs-keyword">where</span><span>
</span><span id="line-37"></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Reader</span></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map.Strict</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">isJust</span></span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Analysis.Alias.html"><span class="hs-identifier">Futhark.Analysis.Alias</span></a></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.html"><span class="hs-identifier">Futhark.IR</span></a></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.Aliases.html"><span class="hs-identifier">Futhark.IR.Aliases</span></a></span><span>
</span><span id="line-44"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.IR.Aliases.html#Aliases"><span class="hs-identifier">Aliases</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-45"></span><span>    </span><span class="annot"><a href="Futhark.IR.Aliases.html#consumedInStms"><span class="hs-identifier">consumedInStms</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-46"></span><span>    </span><span class="annot"><a href="Futhark.IR.Aliases.html#mkStmsAliases"><span class="hs-identifier">mkStmsAliases</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-47"></span><span>    </span><span class="annot"><a href="Futhark.IR.Aliases.html#removeFunDefAliases"><span class="hs-identifier">removeFunDefAliases</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-48"></span><span>    </span><span class="annot"><a href="Futhark.IR.Aliases.html#removeProgAliases"><span class="hs-identifier">removeProgAliases</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-49"></span><span>    </span><span class="annot"><a href="Futhark.IR.Aliases.html#removeStmAliases"><span class="hs-identifier">removeStmAliases</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-50"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html"><span class="hs-identifier">Futhark.IR.GPU</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">GPU</span></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.IR.MC.html"><span class="hs-identifier">Futhark.IR.MC</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">MC</span></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html"><span class="hs-identifier">Futhark.IR.Mem</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Memory</span></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Aliases.html"><span class="hs-identifier">Futhark.IR.Prop.Aliases</span></a></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html"><span class="hs-identifier">Futhark.IR.SOACS.SOAC</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">SOAC</span></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Pass.html"><span class="hs-identifier">Futhark.Pass</span></a></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Transform.Substitute.html"><span class="hs-identifier">Futhark.Transform.Substitute</span></a></span><span>
</span><span id="line-58"></span><span>
</span><span id="line-59"></span><span class="hs-comment">-- | Perform CSE on every function in a program.</span><span>
</span><span id="line-60"></span><span class="hs-comment">--</span><span>
</span><span id="line-61"></span><span class="hs-comment">-- If the boolean argument is false, the pass will not perform CSE on</span><span>
</span><span id="line-62"></span><span class="hs-comment">-- expressions producing arrays. This should be disabled when the rep has</span><span>
</span><span id="line-63"></span><span class="hs-comment">-- memory information, since at that point arrays have identity beyond their</span><span>
</span><span id="line-64"></span><span class="hs-comment">-- value.</span><span>
</span><span id="line-65"></span><span id="local-6989586621684431840"><span class="annot"><a href="Futhark.Optimise.CSE.html#performCSE"><span class="hs-identifier hs-type">performCSE</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-66"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.html#ASTRep"><span class="hs-identifier hs-type">ASTRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431840"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-67"></span><span>    </span><span class="annot"><a href="Futhark.IR.Prop.Aliases.html#CanBeAliased"><span class="hs-identifier hs-type">CanBeAliased</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431840"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-68"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.CSE.html#CSEInOp"><span class="hs-identifier hs-type">CSEInOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Prop.Aliases.html#OpWithAliases"><span class="hs-identifier hs-type">OpWithAliases</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431840"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-69"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-70"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-71"></span><span>  </span><span class="annot"><a href="Futhark.Pass.html#Pass"><span class="hs-identifier hs-type">Pass</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431840"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431840"><span class="hs-identifier hs-type">rep</span></a></span></span><span>
</span><span id="line-72"></span><span id="performCSE"><span class="annot"><span class="annottext">performCSE :: forall rep.
(ASTRep rep, CanBeAliased (Op rep),
 CSEInOp (OpWithAliases (Op rep))) =&gt;
Bool -&gt; Pass rep rep
</span><a href="Futhark.Optimise.CSE.html#performCSE"><span class="hs-identifier hs-var hs-var">performCSE</span></a></span></span><span> </span><span id="local-6989586621684431500"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684431500"><span class="hs-identifier hs-var">cse_arrays</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-73"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; String -&gt; (Prog rep -&gt; PassM (Prog rep)) -&gt; Pass rep rep
forall fromrep torep.
String
-&gt; String
-&gt; (Prog fromrep -&gt; PassM (Prog torep))
-&gt; Pass fromrep torep
</span><a href="Futhark.Pass.html#Pass"><span class="hs-identifier hs-var">Pass</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;CSE&quot;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Combine common subexpressions.&quot;</span></span><span> </span><span class="annot"><span class="annottext">((Prog rep -&gt; PassM (Prog rep)) -&gt; Pass rep rep)
-&gt; (Prog rep -&gt; PassM (Prog rep)) -&gt; Pass rep rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-74"></span><span>    </span><span class="annot"><span class="annottext">(Prog (Aliases rep) -&gt; Prog rep)
-&gt; PassM (Prog (Aliases rep)) -&gt; PassM (Prog rep)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Prog (Aliases rep) -&gt; Prog rep
forall rep. CanBeAliased (Op rep) =&gt; Prog (Aliases rep) -&gt; Prog rep
</span><a href="Futhark.IR.Aliases.html#removeProgAliases"><span class="hs-identifier hs-var">removeProgAliases</span></a></span><span>
</span><span id="line-75"></span><span>      </span><span class="annot"><span class="annottext">(PassM (Prog (Aliases rep)) -&gt; PassM (Prog rep))
-&gt; (Prog rep -&gt; PassM (Prog (Aliases rep)))
-&gt; Prog rep
-&gt; PassM (Prog rep)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Stms (Aliases rep) -&gt; PassM (Stms (Aliases rep)))
-&gt; (Stms (Aliases rep)
    -&gt; FunDef (Aliases rep) -&gt; PassM (FunDef (Aliases rep)))
-&gt; Prog (Aliases rep)
-&gt; PassM (Prog (Aliases rep))
forall fromrep torep.
(Stms fromrep -&gt; PassM (Stms torep))
-&gt; (Stms torep -&gt; FunDef fromrep -&gt; PassM (FunDef torep))
-&gt; Prog fromrep
-&gt; PassM (Prog torep)
</span><a href="Futhark.Pass.html#intraproceduralTransformationWithConsts"><span class="hs-identifier hs-var">intraproceduralTransformationWithConsts</span></a></span><span> </span><span class="annot"><span class="annottext">Stms (Aliases rep) -&gt; PassM (Stms (Aliases rep))
forall {f :: * -&gt; *} {rep}.
(Applicative f, ASTRep rep, Aliased rep, CSEInOp (Op rep)) =&gt;
Stms rep -&gt; f (Stms rep)
</span><a href="#local-6989586621684431496"><span class="hs-identifier hs-var">onConsts</span></a></span><span> </span><span class="annot"><span class="annottext">Stms (Aliases rep)
-&gt; FunDef (Aliases rep) -&gt; PassM (FunDef (Aliases rep))
forall {f :: * -&gt; *} {rep} {p}.
(Applicative f, ASTRep rep, Aliased rep, CSEInOp (Op rep)) =&gt;
p -&gt; FunDef rep -&gt; f (FunDef rep)
</span><a href="#local-6989586621684431495"><span class="hs-identifier hs-var">onFun</span></a></span><span>
</span><span id="line-76"></span><span>      </span><span class="annot"><span class="annottext">(Prog (Aliases rep) -&gt; PassM (Prog (Aliases rep)))
-&gt; (Prog rep -&gt; Prog (Aliases rep))
-&gt; Prog rep
-&gt; PassM (Prog (Aliases rep))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Prog rep -&gt; Prog (Aliases rep)
forall rep.
(ASTRep rep, CanBeAliased (Op rep)) =&gt;
Prog rep -&gt; Prog (Aliases rep)
</span><a href="Futhark.Analysis.Alias.html#aliasAnalysis"><span class="hs-identifier hs-var">aliasAnalysis</span></a></span><span>
</span><span id="line-77"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-78"></span><span>    </span><span id="local-6989586621684431496"><span class="annot"><span class="annottext">onConsts :: Stms rep -&gt; f (Stms rep)
</span><a href="#local-6989586621684431496"><span class="hs-identifier hs-var hs-var">onConsts</span></a></span></span><span> </span><span id="local-6989586621684431476"><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684431476"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-79"></span><span>      </span><span class="annot"><span class="annottext">Stms rep -&gt; f (Stms rep)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Stms rep -&gt; f (Stms rep)) -&gt; Stms rep -&gt; f (Stms rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-80"></span><span>        </span><span class="annot"><span class="annottext">(Stms rep, ()) -&gt; Stms rep
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">((Stms rep, ()) -&gt; Stms rep) -&gt; (Stms rep, ()) -&gt; Stms rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-81"></span><span>          </span><span class="annot"><span class="annottext">Reader (CSEState rep) (Stms rep, ())
-&gt; CSEState rep -&gt; (Stms rep, ())
forall r a. Reader r a -&gt; r -&gt; a
</span><span class="hs-identifier hs-var">runReader</span></span><span>
</span><span id="line-82"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Names
-&gt; [Stm rep] -&gt; CSEM rep () -&gt; Reader (CSEState rep) (Stms rep, ())
forall rep a.
(ASTRep rep, Aliased rep, CSEInOp (Op rep)) =&gt;
Names -&gt; [Stm rep] -&gt; CSEM rep a -&gt; CSEM rep (Stms rep, a)
</span><a href="Futhark.Optimise.CSE.html#cseInStms"><span class="hs-identifier hs-var">cseInStms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms rep -&gt; Names
forall rep. Aliased rep =&gt; Stms rep -&gt; Names
</span><a href="Futhark.IR.Aliases.html#consumedInStms"><span class="hs-identifier hs-var">consumedInStms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684431476"><span class="hs-identifier hs-var">stms</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms rep -&gt; [Stm rep]
forall rep. Stms rep -&gt; [Stm rep]
</span><a href="Futhark.IR.Syntax.html#stmsToList"><span class="hs-identifier hs-var">stmsToList</span></a></span><span> </span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684431476"><span class="hs-identifier hs-var">stms</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; CSEM rep ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-83"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; CSEState rep
forall rep. Bool -&gt; CSEState rep
</span><a href="Futhark.Optimise.CSE.html#newCSEState"><span class="hs-identifier hs-var">newCSEState</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684431500"><span class="hs-identifier hs-var">cse_arrays</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-84"></span><span>    </span><span id="local-6989586621684431495"><span class="annot"><span class="annottext">onFun :: p -&gt; FunDef rep -&gt; f (FunDef rep)
</span><a href="#local-6989586621684431495"><span class="hs-identifier hs-var hs-var">onFun</span></a></span></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FunDef rep -&gt; f (FunDef rep)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(FunDef rep -&gt; f (FunDef rep))
-&gt; (FunDef rep -&gt; FunDef rep) -&gt; FunDef rep -&gt; f (FunDef rep)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; FunDef rep -&gt; FunDef rep
forall rep.
(ASTRep rep, Aliased rep, CSEInOp (Op rep)) =&gt;
Bool -&gt; FunDef rep -&gt; FunDef rep
</span><a href="Futhark.Optimise.CSE.html#cseInFunDef"><span class="hs-identifier hs-var">cseInFunDef</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684431500"><span class="hs-identifier hs-var">cse_arrays</span></a></span><span>
</span><span id="line-85"></span><span>
</span><span id="line-86"></span><span class="hs-comment">-- | Perform CSE on a single function.</span><span>
</span><span id="line-87"></span><span class="hs-comment">--</span><span>
</span><span id="line-88"></span><span class="hs-comment">-- If the boolean argument is false, the pass will not perform CSE on</span><span>
</span><span id="line-89"></span><span class="hs-comment">-- expressions producing arrays. This should be disabled when the rep has</span><span>
</span><span id="line-90"></span><span class="hs-comment">-- memory information, since at that point arrays have identity beyond their</span><span>
</span><span id="line-91"></span><span class="hs-comment">-- value.</span><span>
</span><span id="line-92"></span><span id="local-6989586621684431781"><span class="annot"><a href="Futhark.Optimise.CSE.html#performCSEOnFunDef"><span class="hs-identifier hs-type">performCSEOnFunDef</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-93"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.html#ASTRep"><span class="hs-identifier hs-type">ASTRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431781"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-94"></span><span>    </span><span class="annot"><a href="Futhark.IR.Prop.Aliases.html#CanBeAliased"><span class="hs-identifier hs-type">CanBeAliased</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431781"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-95"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.CSE.html#CSEInOp"><span class="hs-identifier hs-type">CSEInOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Prop.Aliases.html#OpWithAliases"><span class="hs-identifier hs-type">OpWithAliases</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431781"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-96"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-97"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-98"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#FunDef"><span class="hs-identifier hs-type">FunDef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431781"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-99"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#FunDef"><span class="hs-identifier hs-type">FunDef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431781"><span class="hs-identifier hs-type">rep</span></a></span></span><span>
</span><span id="line-100"></span><span id="performCSEOnFunDef"><span class="annot"><span class="annottext">performCSEOnFunDef :: forall rep.
(ASTRep rep, CanBeAliased (Op rep),
 CSEInOp (OpWithAliases (Op rep))) =&gt;
Bool -&gt; FunDef rep -&gt; FunDef rep
</span><a href="Futhark.Optimise.CSE.html#performCSEOnFunDef"><span class="hs-identifier hs-var hs-var">performCSEOnFunDef</span></a></span></span><span> </span><span id="local-6989586621684431443"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684431443"><span class="hs-identifier hs-var">cse_arrays</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-101"></span><span>  </span><span class="annot"><span class="annottext">FunDef (Aliases rep) -&gt; FunDef rep
forall rep.
CanBeAliased (Op rep) =&gt;
FunDef (Aliases rep) -&gt; FunDef rep
</span><a href="Futhark.IR.Aliases.html#removeFunDefAliases"><span class="hs-identifier hs-var">removeFunDefAliases</span></a></span><span> </span><span class="annot"><span class="annottext">(FunDef (Aliases rep) -&gt; FunDef rep)
-&gt; (FunDef rep -&gt; FunDef (Aliases rep)) -&gt; FunDef rep -&gt; FunDef rep
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; FunDef (Aliases rep) -&gt; FunDef (Aliases rep)
forall rep.
(ASTRep rep, Aliased rep, CSEInOp (Op rep)) =&gt;
Bool -&gt; FunDef rep -&gt; FunDef rep
</span><a href="Futhark.Optimise.CSE.html#cseInFunDef"><span class="hs-identifier hs-var">cseInFunDef</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684431443"><span class="hs-identifier hs-var">cse_arrays</span></a></span><span> </span><span class="annot"><span class="annottext">(FunDef (Aliases rep) -&gt; FunDef (Aliases rep))
-&gt; (FunDef rep -&gt; FunDef (Aliases rep))
-&gt; FunDef rep
-&gt; FunDef (Aliases rep)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">FunDef rep -&gt; FunDef (Aliases rep)
forall rep.
(ASTRep rep, CanBeAliased (Op rep)) =&gt;
FunDef rep -&gt; FunDef (Aliases rep)
</span><a href="Futhark.Analysis.Alias.html#analyseFun"><span class="hs-identifier hs-var">analyseFun</span></a></span><span>
</span><span id="line-102"></span><span>
</span><span id="line-103"></span><span class="hs-comment">-- | Perform CSE on some statements.</span><span>
</span><span id="line-104"></span><span class="hs-comment">--</span><span>
</span><span id="line-105"></span><span class="hs-comment">-- If the boolean argument is false, the pass will not perform CSE on</span><span>
</span><span id="line-106"></span><span class="hs-comment">-- expressions producing arrays. This should be disabled when the rep has</span><span>
</span><span id="line-107"></span><span class="hs-comment">-- memory information, since at that point arrays have identity beyond their</span><span>
</span><span id="line-108"></span><span class="hs-comment">-- value.</span><span>
</span><span id="line-109"></span><span id="local-6989586621684431777"><span class="annot"><a href="Futhark.Optimise.CSE.html#performCSEOnStms"><span class="hs-identifier hs-type">performCSEOnStms</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-110"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.html#ASTRep"><span class="hs-identifier hs-type">ASTRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431777"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-111"></span><span>    </span><span class="annot"><a href="Futhark.IR.Prop.Aliases.html#CanBeAliased"><span class="hs-identifier hs-type">CanBeAliased</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431777"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-112"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.CSE.html#CSEInOp"><span class="hs-identifier hs-type">CSEInOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Prop.Aliases.html#OpWithAliases"><span class="hs-identifier hs-type">OpWithAliases</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431777"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-113"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-114"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-115"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431777"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-116"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431777"><span class="hs-identifier hs-type">rep</span></a></span></span><span>
</span><span id="line-117"></span><span id="performCSEOnStms"><span class="annot"><span class="annottext">performCSEOnStms :: forall rep.
(ASTRep rep, CanBeAliased (Op rep),
 CSEInOp (OpWithAliases (Op rep))) =&gt;
Bool -&gt; Stms rep -&gt; Stms rep
</span><a href="Futhark.Optimise.CSE.html#performCSEOnStms"><span class="hs-identifier hs-var hs-var">performCSEOnStms</span></a></span></span><span> </span><span id="local-6989586621684431420"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684431420"><span class="hs-identifier hs-var">cse_arrays</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-118"></span><span>  </span><span class="annot"><span class="annottext">(Stm (Aliases rep) -&gt; Stm rep)
-&gt; Seq (Stm (Aliases rep)) -&gt; Seq (Stm rep)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Stm (Aliases rep) -&gt; Stm rep
forall rep. CanBeAliased (Op rep) =&gt; Stm (Aliases rep) -&gt; Stm rep
</span><a href="Futhark.IR.Aliases.html#removeStmAliases"><span class="hs-identifier hs-var">removeStmAliases</span></a></span><span> </span><span class="annot"><span class="annottext">(Seq (Stm (Aliases rep)) -&gt; Seq (Stm rep))
-&gt; (Seq (Stm rep) -&gt; Seq (Stm (Aliases rep)))
-&gt; Seq (Stm rep)
-&gt; Seq (Stm rep)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Seq (Stm (Aliases rep)) -&gt; Seq (Stm (Aliases rep))
forall {rep}.
(ASTRep rep, Aliased rep, CSEInOp (Op rep)) =&gt;
Stms rep -&gt; Stms rep
</span><a href="#local-6989586621684431419"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">(Seq (Stm (Aliases rep)) -&gt; Seq (Stm (Aliases rep)))
-&gt; (Seq (Stm rep) -&gt; Seq (Stm (Aliases rep)))
-&gt; Seq (Stm rep)
-&gt; Seq (Stm (Aliases rep))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Seq (Stm (Aliases rep)), AliasesAndConsumed)
-&gt; Seq (Stm (Aliases rep))
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">((Seq (Stm (Aliases rep)), AliasesAndConsumed)
 -&gt; Seq (Stm (Aliases rep)))
-&gt; (Seq (Stm rep) -&gt; (Seq (Stm (Aliases rep)), AliasesAndConsumed))
-&gt; Seq (Stm rep)
-&gt; Seq (Stm (Aliases rep))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">AliasTable
-&gt; Seq (Stm rep) -&gt; (Seq (Stm (Aliases rep)), AliasesAndConsumed)
forall rep.
(ASTRep rep, CanBeAliased (Op rep)) =&gt;
AliasTable -&gt; Stms rep -&gt; (Stms (Aliases rep), AliasesAndConsumed)
</span><a href="Futhark.Analysis.Alias.html#analyseStms"><span class="hs-identifier hs-var">analyseStms</span></a></span><span> </span><span class="annot"><span class="annottext">AliasTable
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-119"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-120"></span><span>    </span><span id="local-6989586621684431419"><span class="annot"><span class="annottext">f :: Stms rep -&gt; Stms rep
</span><a href="#local-6989586621684431419"><span class="hs-identifier hs-var hs-var">f</span></a></span></span><span> </span><span id="local-6989586621684431404"><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684431404"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-121"></span><span>      </span><span class="annot"><span class="annottext">(Stms rep, ()) -&gt; Stms rep
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">((Stms rep, ()) -&gt; Stms rep) -&gt; (Stms rep, ()) -&gt; Stms rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-122"></span><span>        </span><span class="annot"><span class="annottext">Reader (CSEState rep) (Stms rep, ())
-&gt; CSEState rep -&gt; (Stms rep, ())
forall r a. Reader r a -&gt; r -&gt; a
</span><span class="hs-identifier hs-var">runReader</span></span><span>
</span><span id="line-123"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Names
-&gt; [Stm rep] -&gt; CSEM rep () -&gt; Reader (CSEState rep) (Stms rep, ())
forall rep a.
(ASTRep rep, Aliased rep, CSEInOp (Op rep)) =&gt;
Names -&gt; [Stm rep] -&gt; CSEM rep a -&gt; CSEM rep (Stms rep, a)
</span><a href="Futhark.Optimise.CSE.html#cseInStms"><span class="hs-identifier hs-var">cseInStms</span></a></span><span>
</span><span id="line-124"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms rep -&gt; Names
forall rep. Aliased rep =&gt; Stms rep -&gt; Names
</span><a href="Futhark.IR.Aliases.html#consumedInStms"><span class="hs-identifier hs-var">consumedInStms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684431404"><span class="hs-identifier hs-var">stms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-125"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms rep -&gt; [Stm rep]
forall rep. Stms rep -&gt; [Stm rep]
</span><a href="Futhark.IR.Syntax.html#stmsToList"><span class="hs-identifier hs-var">stmsToList</span></a></span><span> </span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684431404"><span class="hs-identifier hs-var">stms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-126"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; CSEM rep ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-127"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-128"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; CSEState rep
forall rep. Bool -&gt; CSEState rep
</span><a href="Futhark.Optimise.CSE.html#newCSEState"><span class="hs-identifier hs-var">newCSEState</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684431420"><span class="hs-identifier hs-var">cse_arrays</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-129"></span><span>
</span><span id="line-130"></span><span id="local-6989586621684431782"><span class="annot"><a href="Futhark.Optimise.CSE.html#cseInFunDef"><span class="hs-identifier hs-type">cseInFunDef</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-131"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Prop.html#ASTRep"><span class="hs-identifier hs-type">ASTRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431782"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Aliases.html#Aliased"><span class="hs-identifier hs-type">Aliased</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431782"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Optimise.CSE.html#CSEInOp"><span class="hs-identifier hs-type">CSEInOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431782"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-132"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-133"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#FunDef"><span class="hs-identifier hs-type">FunDef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431782"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-134"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#FunDef"><span class="hs-identifier hs-type">FunDef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431782"><span class="hs-identifier hs-type">rep</span></a></span></span><span>
</span><span id="line-135"></span><span id="cseInFunDef"><span class="annot"><span class="annottext">cseInFunDef :: forall rep.
(ASTRep rep, Aliased rep, CSEInOp (Op rep)) =&gt;
Bool -&gt; FunDef rep -&gt; FunDef rep
</span><a href="Futhark.Optimise.CSE.html#cseInFunDef"><span class="hs-identifier hs-var hs-var">cseInFunDef</span></a></span></span><span> </span><span id="local-6989586621684431387"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684431387"><span class="hs-identifier hs-var">cse_arrays</span></a></span></span><span> </span><span id="local-6989586621684431386"><span class="annot"><span class="annottext">FunDef rep
</span><a href="#local-6989586621684431386"><span class="hs-identifier hs-var">fundec</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-136"></span><span>  </span><span class="annot"><span class="annottext">FunDef rep
</span><a href="#local-6989586621684431386"><span class="hs-identifier hs-var">fundec</span></a></span><span>
</span><span id="line-137"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">funDefBody :: BodyT rep
</span><a href="Futhark.IR.Syntax.html#funDefBody"><span class="hs-identifier hs-var">funDefBody</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-138"></span><span>        </span><span class="annot"><span class="annottext">Reader (CSEState rep) (BodyT rep) -&gt; CSEState rep -&gt; BodyT rep
forall r a. Reader r a -&gt; r -&gt; a
</span><span class="hs-identifier hs-var">runReader</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Diet] -&gt; BodyT rep -&gt; Reader (CSEState rep) (BodyT rep)
forall rep.
(ASTRep rep, Aliased rep, CSEInOp (Op rep)) =&gt;
[Diet] -&gt; Body rep -&gt; CSEM rep (Body rep)
</span><a href="Futhark.Optimise.CSE.html#cseInBody"><span class="hs-identifier hs-var">cseInBody</span></a></span><span> </span><span class="annot"><span class="annottext">[Diet]
</span><a href="#local-6989586621684431383"><span class="hs-identifier hs-var">ds</span></a></span><span> </span><span class="annot"><span class="annottext">(BodyT rep -&gt; Reader (CSEState rep) (BodyT rep))
-&gt; BodyT rep -&gt; Reader (CSEState rep) (BodyT rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FunDef rep -&gt; BodyT rep
forall rep. FunDef rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#funDefBody"><span class="hs-identifier hs-var hs-var">funDefBody</span></a></span><span> </span><span class="annot"><span class="annottext">FunDef rep
</span><a href="#local-6989586621684431386"><span class="hs-identifier hs-var">fundec</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(CSEState rep -&gt; BodyT rep) -&gt; CSEState rep -&gt; BodyT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; CSEState rep
forall rep. Bool -&gt; CSEState rep
</span><a href="Futhark.Optimise.CSE.html#newCSEState"><span class="hs-identifier hs-var">newCSEState</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684431387"><span class="hs-identifier hs-var">cse_arrays</span></a></span><span>
</span><span id="line-139"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-140"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-141"></span><span>    </span><span class="hs-comment">-- XXX: we treat every non-entry result as a consumption here, because we</span><span>
</span><span id="line-142"></span><span>    </span><span class="hs-comment">-- our core language is not strong enough to fully capture the</span><span>
</span><span id="line-143"></span><span>    </span><span class="hs-comment">-- aliases we want, so we are turning some parts off (see #803,</span><span>
</span><span id="line-144"></span><span>    </span><span class="hs-comment">-- #1241, and the related comment in TypeCheck.hs).  This is not a</span><span>
</span><span id="line-145"></span><span>    </span><span class="hs-comment">-- practical problem while we still perform such aggressive</span><span>
</span><span id="line-146"></span><span>    </span><span class="hs-comment">-- inlining.</span><span>
</span><span id="line-147"></span><span>    </span><span id="local-6989586621684431383"><span class="annot"><span class="annottext">ds :: [Diet]
</span><a href="#local-6989586621684431383"><span class="hs-identifier hs-var hs-var">ds</span></a></span></span><span>
</span><span id="line-148"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Maybe EntryPoint -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="annot"><span class="annottext">(Maybe EntryPoint -&gt; Bool) -&gt; Maybe EntryPoint -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FunDef rep -&gt; Maybe EntryPoint
forall rep. FunDef rep -&gt; Maybe EntryPoint
</span><a href="Futhark.IR.Syntax.html#funDefEntryPoint"><span class="hs-identifier hs-var hs-var">funDefEntryPoint</span></a></span><span> </span><span class="annot"><span class="annottext">FunDef rep
</span><a href="#local-6989586621684431386"><span class="hs-identifier hs-var">fundec</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(RetType rep -&gt; Diet) -&gt; [RetType rep] -&gt; [Diet]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeBase ExtShape Uniqueness -&gt; Diet
forall shape. TypeBase shape Uniqueness -&gt; Diet
</span><a href="Futhark.IR.Prop.Types.html#diet"><span class="hs-identifier hs-var">diet</span></a></span><span> </span><span class="annot"><span class="annottext">(TypeBase ExtShape Uniqueness -&gt; Diet)
-&gt; (RetType rep -&gt; TypeBase ExtShape Uniqueness)
-&gt; RetType rep
-&gt; Diet
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">RetType rep -&gt; TypeBase ExtShape Uniqueness
forall t. DeclExtTyped t =&gt; t -&gt; TypeBase ExtShape Uniqueness
</span><a href="Futhark.IR.Prop.Types.html#declExtTypeOf"><span class="hs-identifier hs-var">declExtTypeOf</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([RetType rep] -&gt; [Diet]) -&gt; [RetType rep] -&gt; [Diet]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FunDef rep -&gt; [RetType rep]
forall rep. FunDef rep -&gt; [RetType rep]
</span><a href="Futhark.IR.Syntax.html#funDefRetType"><span class="hs-identifier hs-var hs-var">funDefRetType</span></a></span><span> </span><span class="annot"><span class="annottext">FunDef rep
</span><a href="#local-6989586621684431386"><span class="hs-identifier hs-var">fundec</span></a></span><span>
</span><span id="line-149"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(RetType rep -&gt; Diet) -&gt; [RetType rep] -&gt; [Diet]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">RetType rep -&gt; Diet
forall {t}. DeclExtTyped t =&gt; t -&gt; Diet
</span><a href="#local-6989586621684431374"><span class="hs-identifier hs-var">retDiet</span></a></span><span> </span><span class="annot"><span class="annottext">([RetType rep] -&gt; [Diet]) -&gt; [RetType rep] -&gt; [Diet]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FunDef rep -&gt; [RetType rep]
forall rep. FunDef rep -&gt; [RetType rep]
</span><a href="Futhark.IR.Syntax.html#funDefRetType"><span class="hs-identifier hs-var hs-var">funDefRetType</span></a></span><span> </span><span class="annot"><span class="annottext">FunDef rep
</span><a href="#local-6989586621684431386"><span class="hs-identifier hs-var">fundec</span></a></span><span>
</span><span id="line-150"></span><span>    </span><span id="local-6989586621684431374"><span class="annot"><span class="annottext">retDiet :: t -&gt; Diet
</span><a href="#local-6989586621684431374"><span class="hs-identifier hs-var hs-var">retDiet</span></a></span></span><span> </span><span id="local-6989586621684431371"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621684431371"><span class="hs-identifier hs-var">t</span></a></span></span><span>
</span><span id="line-151"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TypeBase ExtShape Uniqueness -&gt; Bool
forall shape u. TypeBase shape u -&gt; Bool
</span><a href="Futhark.IR.Prop.Types.html#primType"><span class="hs-identifier hs-var">primType</span></a></span><span> </span><span class="annot"><span class="annottext">(TypeBase ExtShape Uniqueness -&gt; Bool)
-&gt; TypeBase ExtShape Uniqueness -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">t -&gt; TypeBase ExtShape Uniqueness
forall t. DeclExtTyped t =&gt; t -&gt; TypeBase ExtShape Uniqueness
</span><a href="Futhark.IR.Prop.Types.html#declExtTypeOf"><span class="hs-identifier hs-var">declExtTypeOf</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621684431371"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Diet
</span><a href="Futhark.IR.Syntax.Core.html#Observe"><span class="hs-identifier hs-var">Observe</span></a></span><span>
</span><span id="line-152"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Diet
</span><a href="Futhark.IR.Syntax.Core.html#Consume"><span class="hs-identifier hs-var">Consume</span></a></span><span>
</span><span id="line-153"></span><span>
</span><span id="line-154"></span><span class="hs-keyword">type</span><span> </span><span id="CSEM"><span class="annot"><a href="Futhark.Optimise.CSE.html#CSEM"><span class="hs-identifier hs-var">CSEM</span></a></span></span><span> </span><span id="local-6989586621684431367"><span class="annot"><a href="#local-6989586621684431367"><span class="hs-identifier hs-type">rep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reader</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.CSE.html#CSEState"><span class="hs-identifier hs-type">CSEState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431367"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-155"></span><span>
</span><span id="line-156"></span><span id="local-6989586621684431754"><span class="annot"><a href="Futhark.Optimise.CSE.html#cseInBody"><span class="hs-identifier hs-type">cseInBody</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-157"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Prop.html#ASTRep"><span class="hs-identifier hs-type">ASTRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431754"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Aliases.html#Aliased"><span class="hs-identifier hs-type">Aliased</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431754"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Optimise.CSE.html#CSEInOp"><span class="hs-identifier hs-type">CSEInOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431754"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-158"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Diet"><span class="hs-identifier hs-type">Diet</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-159"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431754"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-160"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.CSE.html#CSEM"><span class="hs-identifier hs-type">CSEM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431754"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431754"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-161"></span><span id="cseInBody"><span class="annot"><span class="annottext">cseInBody :: forall rep.
(ASTRep rep, Aliased rep, CSEInOp (Op rep)) =&gt;
[Diet] -&gt; Body rep -&gt; CSEM rep (Body rep)
</span><a href="Futhark.Optimise.CSE.html#cseInBody"><span class="hs-identifier hs-var hs-var">cseInBody</span></a></span></span><span> </span><span id="local-6989586621684431345"><span class="annot"><span class="annottext">[Diet]
</span><a href="#local-6989586621684431345"><span class="hs-identifier hs-var">ds</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span id="local-6989586621684431343"><span class="annot"><span class="annottext">BodyDec rep
</span><a href="#local-6989586621684431343"><span class="hs-identifier hs-var">bodydec</span></a></span></span><span> </span><span id="local-6989586621684431342"><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684431342"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span id="local-6989586621684431341"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684431341"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-162"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684431340"><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684431340"><span class="hs-identifier hs-var">stms'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684431339"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684431339"><span class="hs-identifier hs-var">res'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-163"></span><span>    </span><span class="annot"><span class="annottext">Names
-&gt; [Stm rep] -&gt; CSEM rep Result -&gt; CSEM rep (Stms rep, Result)
forall rep a.
(ASTRep rep, Aliased rep, CSEInOp (Op rep)) =&gt;
Names -&gt; [Stm rep] -&gt; CSEM rep a -&gt; CSEM rep (Stms rep, a)
</span><a href="Futhark.Optimise.CSE.html#cseInStms"><span class="hs-identifier hs-var">cseInStms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684431338"><span class="hs-identifier hs-var">res_cons</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684431337"><span class="hs-identifier hs-var">stms_cons</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms rep -&gt; [Stm rep]
forall rep. Stms rep -&gt; [Stm rep]
</span><a href="Futhark.IR.Syntax.html#stmsToList"><span class="hs-identifier hs-var">stmsToList</span></a></span><span> </span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684431342"><span class="hs-identifier hs-var">stms</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(CSEM rep Result -&gt; CSEM rep (Stms rep, Result))
-&gt; CSEM rep Result -&gt; CSEM rep (Stms rep, Result)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-164"></span><span>      </span><span class="annot"><a href="Futhark.Optimise.CSE.html#CSEState"><span class="hs-identifier hs-type">CSEState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExpressionSubstitutions rep
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684431335"><span class="annot"><span class="annottext">NameSubstitutions
</span><a href="#local-6989586621684431335"><span class="hs-identifier hs-var">nsubsts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ReaderT (CSEState rep) Identity (CSEState rep)
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-165"></span><span>      </span><span class="annot"><span class="annottext">Result -&gt; CSEM rep Result
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Result -&gt; CSEM rep Result) -&gt; Result -&gt; CSEM rep Result
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">NameSubstitutions -&gt; Result -&gt; Result
forall a. Substitute a =&gt; NameSubstitutions -&gt; a -&gt; a
</span><a href="Futhark.Transform.Substitute.html#substituteNames"><span class="hs-identifier hs-var">substituteNames</span></a></span><span> </span><span class="annot"><span class="annottext">NameSubstitutions
</span><a href="#local-6989586621684431335"><span class="hs-identifier hs-var">nsubsts</span></a></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684431341"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-166"></span><span>  </span><span class="annot"><span class="annottext">BodyT rep -&gt; CSEM rep (BodyT rep)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(BodyT rep -&gt; CSEM rep (BodyT rep))
-&gt; BodyT rep -&gt; CSEM rep (BodyT rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BodyDec rep -&gt; Stms rep -&gt; Result -&gt; BodyT rep
forall rep. BodyDec rep -&gt; Stms rep -&gt; Result -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-var">Body</span></a></span><span> </span><span class="annot"><span class="annottext">BodyDec rep
</span><a href="#local-6989586621684431343"><span class="hs-identifier hs-var">bodydec</span></a></span><span> </span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684431340"><span class="hs-identifier hs-var">stms'</span></a></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684431339"><span class="hs-identifier hs-var">res'</span></a></span><span>
</span><span id="line-167"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-168"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684431331"><span class="annot"><span class="annottext">[Names]
</span><a href="#local-6989586621684431331"><span class="hs-identifier hs-var">res_als</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684431337"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684431337"><span class="hs-identifier hs-var">stms_cons</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stms rep -&gt; Result -&gt; ([Names], Names)
forall rep. Aliased rep =&gt; Stms rep -&gt; Result -&gt; ([Names], Names)
</span><a href="Futhark.IR.Aliases.html#mkStmsAliases"><span class="hs-identifier hs-var">mkStmsAliases</span></a></span><span> </span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684431342"><span class="hs-identifier hs-var">stms</span></a></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684431341"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-169"></span><span>    </span><span id="local-6989586621684431338"><span class="annot"><span class="annottext">res_cons :: Names
</span><a href="#local-6989586621684431338"><span class="hs-identifier hs-var hs-var">res_cons</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Names] -&gt; Names
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">([Names] -&gt; Names) -&gt; [Names] -&gt; Names
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Diet -&gt; Names -&gt; Names) -&gt; [Diet] -&gt; [Names] -&gt; [Names]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">Diet -&gt; Names -&gt; Names
forall {p}. Monoid p =&gt; Diet -&gt; p -&gt; p
</span><a href="#local-6989586621684431326"><span class="hs-identifier hs-var">consumeResult</span></a></span><span> </span><span class="annot"><span class="annottext">[Diet]
</span><a href="#local-6989586621684431345"><span class="hs-identifier hs-var">ds</span></a></span><span> </span><span class="annot"><span class="annottext">[Names]
</span><a href="#local-6989586621684431331"><span class="hs-identifier hs-var">res_als</span></a></span><span>
</span><span id="line-170"></span><span>    </span><span id="local-6989586621684431326"><span class="annot"><span class="annottext">consumeResult :: Diet -&gt; p -&gt; p
</span><a href="#local-6989586621684431326"><span class="hs-identifier hs-var hs-var">consumeResult</span></a></span></span><span> </span><span class="annot"><span class="annottext">Diet
</span><a href="Futhark.IR.Syntax.Core.html#Consume"><span class="hs-identifier hs-var">Consume</span></a></span><span> </span><span id="local-6989586621684431323"><span class="annot"><span class="annottext">p
</span><a href="#local-6989586621684431323"><span class="hs-identifier hs-var">als</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">p
</span><a href="#local-6989586621684431323"><span class="hs-identifier hs-var">als</span></a></span><span>
</span><span id="line-171"></span><span>    </span><span class="annot"><a href="#local-6989586621684431326"><span class="hs-identifier hs-var">consumeResult</span></a></span><span> </span><span class="annot"><span class="annottext">Diet
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">p
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-172"></span><span>
</span><span id="line-173"></span><span id="local-6989586621684431718"><span class="annot"><a href="Futhark.Optimise.CSE.html#cseInLambda"><span class="hs-identifier hs-type">cseInLambda</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-174"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Prop.html#ASTRep"><span class="hs-identifier hs-type">ASTRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431718"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Aliases.html#Aliased"><span class="hs-identifier hs-type">Aliased</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431718"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Optimise.CSE.html#CSEInOp"><span class="hs-identifier hs-type">CSEInOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431718"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-175"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431718"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-176"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.CSE.html#CSEM"><span class="hs-identifier hs-type">CSEM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431718"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431718"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-177"></span><span id="cseInLambda"><span class="annot"><span class="annottext">cseInLambda :: forall rep.
(ASTRep rep, Aliased rep, CSEInOp (Op rep)) =&gt;
Lambda rep -&gt; CSEM rep (Lambda rep)
</span><a href="Futhark.Optimise.CSE.html#cseInLambda"><span class="hs-identifier hs-var hs-var">cseInLambda</span></a></span></span><span> </span><span id="local-6989586621684431310"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684431310"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-178"></span><span>  </span><span id="local-6989586621684431309"><span class="annot"><span class="annottext">Body rep
</span><a href="#local-6989586621684431309"><span class="hs-identifier hs-var">body'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Diet] -&gt; Body rep -&gt; CSEM rep (Body rep)
forall rep.
(ASTRep rep, Aliased rep, CSEInOp (Op rep)) =&gt;
[Diet] -&gt; Body rep -&gt; CSEM rep (Body rep)
</span><a href="Futhark.Optimise.CSE.html#cseInBody"><span class="hs-identifier hs-var">cseInBody</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Type -&gt; Diet) -&gt; [Type] -&gt; [Diet]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Diet -&gt; Type -&gt; Diet
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">Diet
</span><a href="Futhark.IR.Syntax.Core.html#Observe"><span class="hs-identifier hs-var">Observe</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Type] -&gt; [Diet]) -&gt; [Type] -&gt; [Diet]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; [Type]
forall rep. LambdaT rep -&gt; [Type]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684431310"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Body rep -&gt; CSEM rep (Body rep))
-&gt; Body rep -&gt; CSEM rep (Body rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; Body rep
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684431310"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-179"></span><span>  </span><span class="annot"><span class="annottext">Lambda rep -&gt; CSEM rep (Lambda rep)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684431310"><span class="hs-identifier hs-var">lam</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">lambdaBody :: Body rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var">lambdaBody</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Body rep
</span><a href="#local-6989586621684431309"><span class="hs-identifier hs-var">body'</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-180"></span><span>
</span><span id="line-181"></span><span id="local-6989586621684431788"><span id="local-6989586621684431789"><span class="annot"><a href="Futhark.Optimise.CSE.html#cseInStms"><span class="hs-identifier hs-type">cseInStms</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-182"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Prop.html#ASTRep"><span class="hs-identifier hs-type">ASTRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431789"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Aliases.html#Aliased"><span class="hs-identifier hs-type">Aliased</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431789"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Optimise.CSE.html#CSEInOp"><span class="hs-identifier hs-type">CSEInOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431789"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-183"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-184"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431789"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-185"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.CSE.html#CSEM"><span class="hs-identifier hs-type">CSEM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431789"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431788"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-186"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.CSE.html#CSEM"><span class="hs-identifier hs-type">CSEM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431789"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431789"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621684431788"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-187"></span><span id="cseInStms"><span class="annot"><span class="annottext">cseInStms :: forall rep a.
(ASTRep rep, Aliased rep, CSEInOp (Op rep)) =&gt;
Names -&gt; [Stm rep] -&gt; CSEM rep a -&gt; CSEM rep (Stms rep, a)
</span><a href="Futhark.Optimise.CSE.html#cseInStms"><span class="hs-identifier hs-var hs-var">cseInStms</span></a></span></span><span> </span><span class="annot"><span class="annottext">Names
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span id="local-6989586621684431280"><span class="annot"><span class="annottext">CSEM rep a
</span><a href="#local-6989586621684431280"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-188"></span><span>  </span><span id="local-6989586621684431279"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684431279"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CSEM rep a
</span><a href="#local-6989586621684431280"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-189"></span><span>  </span><span class="annot"><span class="annottext">(Stms rep, a) -&gt; CSEM rep (Stms rep, a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms rep
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684431279"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-190"></span><span class="annot"><a href="Futhark.Optimise.CSE.html#cseInStms"><span class="hs-identifier hs-var">cseInStms</span></a></span><span> </span><span id="local-6989586621684431278"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684431278"><span class="hs-identifier hs-var">consumed</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684431277"><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684431277"><span class="hs-identifier hs-var">stm</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684431276"><span class="annot"><span class="annottext">[Stm rep]
</span><a href="#local-6989586621684431276"><span class="hs-identifier hs-var">stms</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684431275"><span class="annot"><span class="annottext">CSEM rep a
</span><a href="#local-6989586621684431275"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-191"></span><span>  </span><span class="annot"><span class="annottext">Names
-&gt; Stm rep
-&gt; ([Stm rep] -&gt; CSEM rep (Stms rep, a))
-&gt; CSEM rep (Stms rep, a)
forall rep a.
ASTRep rep =&gt;
Names -&gt; Stm rep -&gt; ([Stm rep] -&gt; CSEM rep a) -&gt; CSEM rep a
</span><a href="Futhark.Optimise.CSE.html#cseInStm"><span class="hs-identifier hs-var">cseInStm</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684431278"><span class="hs-identifier hs-var">consumed</span></a></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684431277"><span class="hs-identifier hs-var">stm</span></a></span><span> </span><span class="annot"><span class="annottext">(([Stm rep] -&gt; CSEM rep (Stms rep, a)) -&gt; CSEM rep (Stms rep, a))
-&gt; ([Stm rep] -&gt; CSEM rep (Stms rep, a)) -&gt; CSEM rep (Stms rep, a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684431273"><span class="annot"><span class="annottext">[Stm rep]
</span><a href="#local-6989586621684431273"><span class="hs-identifier hs-var">stm'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-192"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684431272"><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684431272"><span class="hs-identifier hs-var">stms'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684431271"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684431271"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Names -&gt; [Stm rep] -&gt; CSEM rep a -&gt; CSEM rep (Stms rep, a)
forall rep a.
(ASTRep rep, Aliased rep, CSEInOp (Op rep)) =&gt;
Names -&gt; [Stm rep] -&gt; CSEM rep a -&gt; CSEM rep (Stms rep, a)
</span><a href="Futhark.Optimise.CSE.html#cseInStms"><span class="hs-identifier hs-var">cseInStms</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684431278"><span class="hs-identifier hs-var">consumed</span></a></span><span> </span><span class="annot"><span class="annottext">[Stm rep]
</span><a href="#local-6989586621684431276"><span class="hs-identifier hs-var">stms</span></a></span><span> </span><span class="annot"><span class="annottext">CSEM rep a
</span><a href="#local-6989586621684431275"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-193"></span><span>    </span><span id="local-6989586621684431270"><span class="annot"><span class="annottext">[Stm rep]
</span><a href="#local-6989586621684431270"><span class="hs-identifier hs-var">stm''</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Stm rep -&gt; ReaderT (CSEState rep) Identity (Stm rep))
-&gt; [Stm rep] -&gt; ReaderT (CSEState rep) Identity [Stm rep]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; ReaderT (CSEState rep) Identity (Stm rep)
forall {rep}.
(ASTRep rep, Aliased rep, CSEInOp (Op rep)) =&gt;
Stm rep -&gt; ReaderT (CSEState rep) Identity (Stm rep)
</span><a href="#local-6989586621684431268"><span class="hs-identifier hs-var">nestedCSE</span></a></span><span> </span><span class="annot"><span class="annottext">[Stm rep]
</span><a href="#local-6989586621684431273"><span class="hs-identifier hs-var">stm'</span></a></span><span>
</span><span id="line-194"></span><span>    </span><span class="annot"><span class="annottext">(Stms rep, a) -&gt; CSEM rep (Stms rep, a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Stm rep] -&gt; Stms rep
forall rep. [Stm rep] -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#stmsFromList"><span class="hs-identifier hs-var">stmsFromList</span></a></span><span> </span><span class="annot"><span class="annottext">[Stm rep]
</span><a href="#local-6989586621684431270"><span class="hs-identifier hs-var">stm''</span></a></span><span> </span><span class="annot"><span class="annottext">Stms rep -&gt; Stms rep -&gt; Stms rep
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684431272"><span class="hs-identifier hs-var">stms'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684431271"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-195"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-196"></span><span>    </span><span id="local-6989586621684431268"><span class="annot"><span class="annottext">nestedCSE :: Stm rep -&gt; ReaderT (CSEState rep) Identity (Stm rep)
</span><a href="#local-6989586621684431268"><span class="hs-identifier hs-var hs-var">nestedCSE</span></a></span></span><span> </span><span id="local-6989586621684431242"><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684431242"><span class="hs-identifier hs-var">stm'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-197"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684431233"><span class="annot"><span class="annottext">ds :: [Diet]
</span><a href="#local-6989586621684431233"><span class="hs-identifier hs-var hs-var">ds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-198"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; Exp rep
forall rep. Stm rep -&gt; Exp rep
</span><a href="Futhark.IR.Syntax.html#stmExp"><span class="hs-identifier hs-var hs-var">stmExp</span></a></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684431242"><span class="hs-identifier hs-var">stm'</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-199"></span><span>              </span><span class="annot"><a href="Futhark.IR.Syntax.html#DoLoop"><span class="hs-identifier hs-type">DoLoop</span></a></span><span> </span><span id="local-6989586621684431230"><span class="annot"><span class="annottext">[(Param (FParamInfo rep), SubExp)]
</span><a href="#local-6989586621684431230"><span class="hs-identifier hs-var">merge</span></a></span></span><span> </span><span class="annot"><span class="annottext">LoopForm rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">((Param (FParamInfo rep), SubExp) -&gt; Diet)
-&gt; [(Param (FParamInfo rep), SubExp)] -&gt; [Diet]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeBase Shape Uniqueness -&gt; Diet
forall shape. TypeBase shape Uniqueness -&gt; Diet
</span><a href="Futhark.IR.Prop.Types.html#diet"><span class="hs-identifier hs-var">diet</span></a></span><span> </span><span class="annot"><span class="annottext">(TypeBase Shape Uniqueness -&gt; Diet)
-&gt; ((Param (FParamInfo rep), SubExp) -&gt; TypeBase Shape Uniqueness)
-&gt; (Param (FParamInfo rep), SubExp)
-&gt; Diet
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Param (FParamInfo rep) -&gt; TypeBase Shape Uniqueness
forall t. DeclTyped t =&gt; t -&gt; TypeBase Shape Uniqueness
</span><a href="Futhark.IR.Prop.Types.html#declTypeOf"><span class="hs-identifier hs-var">declTypeOf</span></a></span><span> </span><span class="annot"><span class="annottext">(Param (FParamInfo rep) -&gt; TypeBase Shape Uniqueness)
-&gt; ((Param (FParamInfo rep), SubExp) -&gt; Param (FParamInfo rep))
-&gt; (Param (FParamInfo rep), SubExp)
-&gt; TypeBase Shape Uniqueness
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Param (FParamInfo rep), SubExp) -&gt; Param (FParamInfo rep)
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Param (FParamInfo rep), SubExp)]
</span><a href="#local-6989586621684431230"><span class="hs-identifier hs-var">merge</span></a></span><span>
</span><span id="line-200"></span><span>              </span><span class="annot"><span class="annottext">Exp rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(PatElemT (LetDec rep) -&gt; Diet)
-&gt; [PatElemT (LetDec rep)] -&gt; [Diet]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep) -&gt; Diet
forall {dec}. PatElemT dec -&gt; Diet
</span><a href="#local-6989586621684431228"><span class="hs-identifier hs-var">patElemDiet</span></a></span><span> </span><span class="annot"><span class="annottext">([PatElemT (LetDec rep)] -&gt; [Diet])
-&gt; [PatElemT (LetDec rep)] -&gt; [Diet]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatT (LetDec rep) -&gt; [PatElemT (LetDec rep)]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span> </span><span class="annot"><span class="annottext">(PatT (LetDec rep) -&gt; [PatElemT (LetDec rep)])
-&gt; PatT (LetDec rep) -&gt; [PatElemT (LetDec rep)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; PatT (LetDec rep)
forall rep. Stm rep -&gt; Pat rep
</span><a href="Futhark.IR.Syntax.html#stmPat"><span class="hs-identifier hs-var hs-var">stmPat</span></a></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684431242"><span class="hs-identifier hs-var">stm'</span></a></span><span>
</span><span id="line-201"></span><span>      </span><span id="local-6989586621684431225"><span class="annot"><span class="annottext">Exp rep
</span><a href="#local-6989586621684431225"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Mapper rep rep (ReaderT (CSEState rep) Identity)
-&gt; Exp rep -&gt; ReaderT (CSEState rep) Identity (Exp rep)
forall (m :: * -&gt; *) frep trep.
(Applicative m, Monad m) =&gt;
Mapper frep trep m -&gt; Exp frep -&gt; m (Exp trep)
</span><a href="Futhark.IR.Traversals.html#mapExpM"><span class="hs-identifier hs-var">mapExpM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Diet] -&gt; Mapper rep rep (ReaderT (CSEState rep) Identity)
forall {trep}.
(ASTRep trep, Aliased trep, CSEInOp (Op trep)) =&gt;
[Diet] -&gt; Mapper trep trep (ReaderT (CSEState trep) Identity)
</span><a href="#local-6989586621684431223"><span class="hs-identifier hs-var">cse</span></a></span><span> </span><span class="annot"><span class="annottext">[Diet]
</span><a href="#local-6989586621684431233"><span class="hs-identifier hs-var">ds</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Exp rep -&gt; ReaderT (CSEState rep) Identity (Exp rep))
-&gt; Exp rep -&gt; ReaderT (CSEState rep) Identity (Exp rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; Exp rep
forall rep. Stm rep -&gt; Exp rep
</span><a href="Futhark.IR.Syntax.html#stmExp"><span class="hs-identifier hs-var hs-var">stmExp</span></a></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684431242"><span class="hs-identifier hs-var">stm'</span></a></span><span>
</span><span id="line-202"></span><span>      </span><span class="annot"><span class="annottext">Stm rep -&gt; ReaderT (CSEState rep) Identity (Stm rep)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684431242"><span class="hs-identifier hs-var">stm'</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">stmExp :: Exp rep
</span><a href="Futhark.IR.Syntax.html#stmExp"><span class="hs-identifier hs-var">stmExp</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Exp rep
</span><a href="#local-6989586621684431225"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-203"></span><span>
</span><span id="line-204"></span><span>    </span><span id="local-6989586621684431223"><span class="annot"><span class="annottext">cse :: [Diet] -&gt; Mapper trep trep (ReaderT (CSEState trep) Identity)
</span><a href="#local-6989586621684431223"><span class="hs-identifier hs-var hs-var">cse</span></a></span></span><span> </span><span id="local-6989586621684431208"><span class="annot"><span class="annottext">[Diet]
</span><a href="#local-6989586621684431208"><span class="hs-identifier hs-var">ds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-205"></span><span>      </span><span class="annot"><span class="annottext">Mapper trep trep (ReaderT (CSEState trep) Identity)
forall (m :: * -&gt; *) rep. Monad m =&gt; Mapper rep rep m
</span><a href="Futhark.IR.Traversals.html#identityMapper"><span class="hs-identifier hs-var">identityMapper</span></a></span><span>
</span><span id="line-206"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">mapOnBody :: Scope trep
-&gt; Body trep -&gt; ReaderT (CSEState trep) Identity (Body trep)
</span><a href="Futhark.IR.Traversals.html#mapOnBody"><span class="hs-identifier hs-var">mapOnBody</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Body trep -&gt; ReaderT (CSEState trep) Identity (Body trep))
-&gt; Scope trep
-&gt; Body trep
-&gt; ReaderT (CSEState trep) Identity (Body trep)
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">((Body trep -&gt; ReaderT (CSEState trep) Identity (Body trep))
 -&gt; Scope trep
 -&gt; Body trep
 -&gt; ReaderT (CSEState trep) Identity (Body trep))
-&gt; (Body trep -&gt; ReaderT (CSEState trep) Identity (Body trep))
-&gt; Scope trep
-&gt; Body trep
-&gt; ReaderT (CSEState trep) Identity (Body trep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Diet] -&gt; Body trep -&gt; ReaderT (CSEState trep) Identity (Body trep)
forall rep.
(ASTRep rep, Aliased rep, CSEInOp (Op rep)) =&gt;
[Diet] -&gt; Body rep -&gt; CSEM rep (Body rep)
</span><a href="Futhark.Optimise.CSE.html#cseInBody"><span class="hs-identifier hs-var">cseInBody</span></a></span><span> </span><span class="annot"><span class="annottext">[Diet]
</span><a href="#local-6989586621684431208"><span class="hs-identifier hs-var">ds</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-207"></span><span>          </span><span class="annot"><span class="annottext">mapOnOp :: Op trep -&gt; ReaderT (CSEState trep) Identity (Op trep)
</span><a href="Futhark.IR.Traversals.html#mapOnOp"><span class="hs-identifier hs-var">mapOnOp</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Op trep -&gt; ReaderT (CSEState trep) Identity (Op trep)
forall op rep. CSEInOp op =&gt; op -&gt; CSEM rep op
</span><a href="Futhark.Optimise.CSE.html#cseInOp"><span class="hs-identifier hs-var">cseInOp</span></a></span><span>
</span><span id="line-208"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-209"></span><span>
</span><span id="line-210"></span><span>    </span><span id="local-6989586621684431228"><span class="annot"><span class="annottext">patElemDiet :: PatElemT dec -&gt; Diet
</span><a href="#local-6989586621684431228"><span class="hs-identifier hs-var hs-var">patElemDiet</span></a></span></span><span> </span><span id="local-6989586621684431203"><span class="annot"><span class="annottext">PatElemT dec
</span><a href="#local-6989586621684431203"><span class="hs-identifier hs-var">pe</span></a></span></span><span>
</span><span id="line-211"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">PatElemT dec -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT dec
</span><a href="#local-6989586621684431203"><span class="hs-identifier hs-var">pe</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#nameIn"><span class="hs-operator hs-var">`nameIn`</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684431278"><span class="hs-identifier hs-var">consumed</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Diet
</span><a href="Futhark.IR.Syntax.Core.html#Consume"><span class="hs-identifier hs-var">Consume</span></a></span><span>
</span><span id="line-212"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Diet
</span><a href="Futhark.IR.Syntax.Core.html#Observe"><span class="hs-identifier hs-var">Observe</span></a></span><span>
</span><span id="line-213"></span><span>
</span><span id="line-214"></span><span class="hs-comment">-- A small amount of normalisation of expressions that otherwise would</span><span>
</span><span id="line-215"></span><span class="hs-comment">-- be different for pointless reasons.</span><span>
</span><span id="line-216"></span><span id="local-6989586621684431669"><span class="annot"><a href="Futhark.Optimise.CSE.html#normExp"><span class="hs-identifier hs-type">normExp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431669"><span class="hs-identifier hs-type">lore</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431669"><span class="hs-identifier hs-type">lore</span></a></span></span><span>
</span><span id="line-217"></span><span id="normExp"><span class="annot"><span class="annottext">normExp :: forall lore. Exp lore -&gt; Exp lore
</span><a href="Futhark.Optimise.CSE.html#normExp"><span class="hs-identifier hs-var hs-var">normExp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Apply"><span class="hs-identifier hs-type">Apply</span></a></span><span> </span><span id="local-6989586621684431194"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684431194"><span class="hs-identifier hs-var">fname</span></a></span></span><span> </span><span id="local-6989586621684431193"><span class="annot"><span class="annottext">[(SubExp, Diet)]
</span><a href="#local-6989586621684431193"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621684431192"><span class="annot"><span class="annottext">[RetType lore]
</span><a href="#local-6989586621684431192"><span class="hs-identifier hs-var">ret</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684431191"><span class="annot"><span class="annottext">Safety
</span><a href="#local-6989586621684431191"><span class="hs-identifier hs-var">safety</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[SrcLoc]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-218"></span><span>  </span><span class="annot"><span class="annottext">Name
-&gt; [(SubExp, Diet)]
-&gt; [RetType lore]
-&gt; (Safety, SrcLoc, [SrcLoc])
-&gt; ExpT lore
forall rep.
Name
-&gt; [(SubExp, Diet)]
-&gt; [RetType rep]
-&gt; (Safety, SrcLoc, [SrcLoc])
-&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#Apply"><span class="hs-identifier hs-var">Apply</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684431194"><span class="hs-identifier hs-var">fname</span></a></span><span> </span><span class="annot"><span class="annottext">[(SubExp, Diet)]
</span><a href="#local-6989586621684431193"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">[RetType lore]
</span><a href="#local-6989586621684431192"><span class="hs-identifier hs-var">ret</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Safety
</span><a href="#local-6989586621684431191"><span class="hs-identifier hs-var">safety</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SrcLoc
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[SrcLoc]
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span>
</span><span id="line-219"></span><span class="annot"><a href="Futhark.Optimise.CSE.html#normExp"><span class="hs-identifier hs-var">normExp</span></a></span><span> </span><span id="local-6989586621684431190"><span class="annot"><span class="annottext">ExpT lore
</span><a href="#local-6989586621684431190"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExpT lore
</span><a href="#local-6989586621684431190"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-220"></span><span>
</span><span id="line-221"></span><span id="local-6989586621684431705"><span id="local-6989586621684431706"><span class="annot"><a href="Futhark.Optimise.CSE.html#cseInStm"><span class="hs-identifier hs-type">cseInStm</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-222"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.html#ASTRep"><span class="hs-identifier hs-type">ASTRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431706"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-223"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-224"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431706"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-225"></span><span>  </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431706"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.CSE.html#CSEM"><span class="hs-identifier hs-type">CSEM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431706"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431705"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-226"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.CSE.html#CSEM"><span class="hs-identifier hs-type">CSEM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431706"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431705"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-227"></span><span id="cseInStm"><span class="annot"><span class="annottext">cseInStm :: forall rep a.
ASTRep rep =&gt;
Names -&gt; Stm rep -&gt; ([Stm rep] -&gt; CSEM rep a) -&gt; CSEM rep a
</span><a href="Futhark.Optimise.CSE.html#cseInStm"><span class="hs-identifier hs-var hs-var">cseInStm</span></a></span></span><span> </span><span id="local-6989586621684431134"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684431134"><span class="hs-identifier hs-var">consumed</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684431132"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684431132"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#StmAux"><span class="hs-identifier hs-type">StmAux</span></a></span><span> </span><span id="local-6989586621684431130"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684431130"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span id="local-6989586621684431129"><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684431129"><span class="hs-identifier hs-var">attrs</span></a></span></span><span> </span><span id="local-6989586621684431128"><span class="annot"><span class="annottext">ExpDec rep
</span><a href="#local-6989586621684431128"><span class="hs-identifier hs-var">edec</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684431127"><span class="annot"><span class="annottext">Exp rep
</span><a href="#local-6989586621684431127"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684431126"><span class="annot"><span class="annottext">[Stm rep] -&gt; CSEM rep a
</span><a href="#local-6989586621684431126"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-228"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.CSE.html#CSEState"><span class="hs-identifier hs-type">CSEState</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684431125"><span class="annot"><span class="annottext">ExpressionSubstitutions rep
</span><a href="#local-6989586621684431125"><span class="hs-identifier hs-var">esubsts</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684431124"><span class="annot"><span class="annottext">NameSubstitutions
</span><a href="#local-6989586621684431124"><span class="hs-identifier hs-var">nsubsts</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684431123"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684431123"><span class="hs-identifier hs-var">cse_arrays</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ReaderT (CSEState rep) Identity (CSEState rep)
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-229"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684431101"><span class="annot"><span class="annottext">e' :: Exp rep
</span><a href="#local-6989586621684431101"><span class="hs-identifier hs-var hs-var">e'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Exp rep -&gt; Exp rep
forall lore. Exp lore -&gt; Exp lore
</span><a href="Futhark.Optimise.CSE.html#normExp"><span class="hs-identifier hs-var">normExp</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp rep -&gt; Exp rep) -&gt; Exp rep -&gt; Exp rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span class="annot"><span class="annottext">NameSubstitutions -&gt; Exp rep -&gt; Exp rep
forall a. Substitute a =&gt; NameSubstitutions -&gt; a -&gt; a
</span><a href="Futhark.Transform.Substitute.html#substituteNames"><span class="hs-identifier hs-var">substituteNames</span></a></span><span> </span><span class="annot"><span class="annottext">NameSubstitutions
</span><a href="#local-6989586621684431124"><span class="hs-identifier hs-var">nsubsts</span></a></span><span> </span><span class="annot"><span class="annottext">Exp rep
</span><a href="#local-6989586621684431127"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-230"></span><span>      </span><span id="local-6989586621684431097"><span class="annot"><span class="annottext">pat' :: Pat rep
</span><a href="#local-6989586621684431097"><span class="hs-identifier hs-var hs-var">pat'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NameSubstitutions -&gt; Pat rep -&gt; Pat rep
forall a. Substitute a =&gt; NameSubstitutions -&gt; a -&gt; a
</span><a href="Futhark.Transform.Substitute.html#substituteNames"><span class="hs-identifier hs-var">substituteNames</span></a></span><span> </span><span class="annot"><span class="annottext">NameSubstitutions
</span><a href="#local-6989586621684431124"><span class="hs-identifier hs-var">nsubsts</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684431132"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-231"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">(PatElemT (LetDec rep) -&gt; Bool) -&gt; [PatElemT (LetDec rep)] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; PatElemT (LetDec rep) -&gt; Bool
forall {dec}. Typed dec =&gt; Bool -&gt; PatElemT dec -&gt; Bool
</span><a href="#local-6989586621684431095"><span class="hs-identifier hs-var">bad</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684431123"><span class="hs-identifier hs-var">cse_arrays</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([PatElemT (LetDec rep)] -&gt; Bool)
-&gt; [PatElemT (LetDec rep)] -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat rep -&gt; [PatElemT (LetDec rep)]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684431132"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-232"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">[Stm rep] -&gt; CSEM rep a
</span><a href="#local-6989586621684431126"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684431097"><span class="hs-identifier hs-var">pat'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Certs -&gt; Attrs -&gt; ExpDec rep -&gt; StmAux (ExpDec rep)
forall dec. Certs -&gt; Attrs -&gt; dec -&gt; StmAux dec
</span><a href="Futhark.IR.Syntax.html#StmAux"><span class="hs-identifier hs-var">StmAux</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684431130"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684431129"><span class="hs-identifier hs-var">attrs</span></a></span><span> </span><span class="annot"><span class="annottext">ExpDec rep
</span><a href="#local-6989586621684431128"><span class="hs-identifier hs-var">edec</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Exp rep
</span><a href="#local-6989586621684431101"><span class="hs-identifier hs-var">e'</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-233"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(ExpDec rep, Exp rep)
-&gt; ExpressionSubstitutions rep -&gt; Maybe (Pat rep)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExpDec rep
</span><a href="#local-6989586621684431128"><span class="hs-identifier hs-var">edec</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Exp rep
</span><a href="#local-6989586621684431101"><span class="hs-identifier hs-var">e'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ExpressionSubstitutions rep
</span><a href="#local-6989586621684431125"><span class="hs-identifier hs-var">esubsts</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-234"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684431093"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684431093"><span class="hs-identifier hs-var">subpat</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-235"></span><span>        </span><span class="annot"><span class="annottext">(CSEState rep -&gt; CSEState rep) -&gt; CSEM rep a -&gt; CSEM rep a
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; r) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">local</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pat rep -&gt; Pat rep -&gt; CSEState rep -&gt; CSEState rep
forall dec rep.
PatT dec -&gt; PatT dec -&gt; CSEState rep -&gt; CSEState rep
</span><a href="Futhark.Optimise.CSE.html#addNameSubst"><span class="hs-identifier hs-var">addNameSubst</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684431097"><span class="hs-identifier hs-var">pat'</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684431093"><span class="hs-identifier hs-var">subpat</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(CSEM rep a -&gt; CSEM rep a) -&gt; CSEM rep a -&gt; CSEM rep a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-236"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684431090"><span class="annot"><span class="annottext">lets :: [Stm rep]
</span><a href="#local-6989586621684431090"><span class="hs-identifier hs-var hs-var">lets</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-237"></span><span>                </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PatElemT (LetDec rep)] -&gt; Pat rep
forall dec. [PatElemT dec] -&gt; PatT dec
</span><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-var">Pat</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684431088"><span class="hs-identifier hs-var">patElem'</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Certs -&gt; Attrs -&gt; ExpDec rep -&gt; StmAux (ExpDec rep)
forall dec. Certs -&gt; Attrs -&gt; dec -&gt; StmAux dec
</span><a href="Futhark.IR.Syntax.html#StmAux"><span class="hs-identifier hs-var">StmAux</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684431130"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684431129"><span class="hs-identifier hs-var">attrs</span></a></span><span> </span><span class="annot"><span class="annottext">ExpDec rep
</span><a href="#local-6989586621684431128"><span class="hs-identifier hs-var">edec</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Exp rep -&gt; Stm rep) -&gt; Exp rep -&gt; Stm rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-238"></span><span>                    </span><span class="annot"><span class="annottext">BasicOp -&gt; Exp rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; Exp rep) -&gt; BasicOp -&gt; Exp rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#SubExp"><span class="hs-identifier hs-var">SubExp</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; BasicOp) -&gt; SubExp -&gt; BasicOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SubExp) -&gt; VName -&gt; SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep) -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684431084"><span class="hs-identifier hs-var">patElem</span></a></span><span>
</span><span id="line-239"></span><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684431083"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684431083"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684431084"><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684431084"><span class="hs-identifier hs-var">patElem</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[VName]
-&gt; [PatElemT (LetDec rep)] -&gt; [(VName, PatElemT (LetDec rep))]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pat rep -&gt; [VName]
forall dec. PatT dec -&gt; [VName]
</span><a href="Futhark.IR.Prop.Patterns.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684431097"><span class="hs-identifier hs-var">pat'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([PatElemT (LetDec rep)] -&gt; [(VName, PatElemT (LetDec rep))])
-&gt; [PatElemT (LetDec rep)] -&gt; [(VName, PatElemT (LetDec rep))]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat rep -&gt; [PatElemT (LetDec rep)]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684431093"><span class="hs-identifier hs-var">subpat</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-240"></span><span>                    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684431088"><span class="annot"><span class="annottext">patElem' :: PatElemT (LetDec rep)
</span><a href="#local-6989586621684431088"><span class="hs-identifier hs-var hs-var">patElem'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684431084"><span class="hs-identifier hs-var">patElem</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">patElemName :: VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var">patElemName</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684431083"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-241"></span><span>                </span><span class="hs-special">]</span><span>
</span><span id="line-242"></span><span>          </span><span class="annot"><span class="annottext">[Stm rep] -&gt; CSEM rep a
</span><a href="#local-6989586621684431126"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">[Stm rep]
</span><a href="#local-6989586621684431090"><span class="hs-identifier hs-var">lets</span></a></span><span>
</span><span id="line-243"></span><span>      </span><span class="annot"><span class="annottext">Maybe (Pat rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-244"></span><span>        </span><span class="annot"><span class="annottext">(CSEState rep -&gt; CSEState rep) -&gt; CSEM rep a -&gt; CSEM rep a
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; r) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">local</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pat rep -&gt; ExpDec rep -&gt; Exp rep -&gt; CSEState rep -&gt; CSEState rep
forall rep.
ASTRep rep =&gt;
Pat rep -&gt; ExpDec rep -&gt; Exp rep -&gt; CSEState rep -&gt; CSEState rep
</span><a href="Futhark.Optimise.CSE.html#addExpSubst"><span class="hs-identifier hs-var">addExpSubst</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684431097"><span class="hs-identifier hs-var">pat'</span></a></span><span> </span><span class="annot"><span class="annottext">ExpDec rep
</span><a href="#local-6989586621684431128"><span class="hs-identifier hs-var">edec</span></a></span><span> </span><span class="annot"><span class="annottext">Exp rep
</span><a href="#local-6989586621684431101"><span class="hs-identifier hs-var">e'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(CSEM rep a -&gt; CSEM rep a) -&gt; CSEM rep a -&gt; CSEM rep a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-245"></span><span>          </span><span class="annot"><span class="annottext">[Stm rep] -&gt; CSEM rep a
</span><a href="#local-6989586621684431126"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684431097"><span class="hs-identifier hs-var">pat'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Certs -&gt; Attrs -&gt; ExpDec rep -&gt; StmAux (ExpDec rep)
forall dec. Certs -&gt; Attrs -&gt; dec -&gt; StmAux dec
</span><a href="Futhark.IR.Syntax.html#StmAux"><span class="hs-identifier hs-var">StmAux</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684431130"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684431129"><span class="hs-identifier hs-var">attrs</span></a></span><span> </span><span class="annot"><span class="annottext">ExpDec rep
</span><a href="#local-6989586621684431128"><span class="hs-identifier hs-var">edec</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Exp rep
</span><a href="#local-6989586621684431101"><span class="hs-identifier hs-var">e'</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-246"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-247"></span><span>    </span><span id="local-6989586621684431095"><span class="annot"><span class="annottext">bad :: Bool -&gt; PatElemT dec -&gt; Bool
</span><a href="#local-6989586621684431095"><span class="hs-identifier hs-var hs-var">bad</span></a></span></span><span> </span><span id="local-6989586621684431077"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684431077"><span class="hs-identifier hs-var">cse_arrays</span></a></span></span><span> </span><span id="local-6989586621684431076"><span class="annot"><span class="annottext">PatElemT dec
</span><a href="#local-6989586621684431076"><span class="hs-identifier hs-var">pe</span></a></span></span><span>
</span><span id="line-248"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Mem"><span class="hs-identifier hs-type">Mem</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PatElemT dec -&gt; Type
forall dec. Typed dec =&gt; PatElemT dec -&gt; Type
</span><a href="Futhark.IR.Prop.Patterns.html#patElemType"><span class="hs-identifier hs-var">patElemType</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT dec
</span><a href="#local-6989586621684431076"><span class="hs-identifier hs-var">pe</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-249"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PatElemT dec -&gt; Type
forall dec. Typed dec =&gt; PatElemT dec -&gt; Type
</span><a href="Futhark.IR.Prop.Patterns.html#patElemType"><span class="hs-identifier hs-var">patElemType</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT dec
</span><a href="#local-6989586621684431076"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684431077"><span class="hs-identifier hs-var">cse_arrays</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-250"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">PatElemT dec -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT dec
</span><a href="#local-6989586621684431076"><span class="hs-identifier hs-var">pe</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#nameIn"><span class="hs-operator hs-var">`nameIn`</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684431134"><span class="hs-identifier hs-var">consumed</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-251"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-252"></span><span>
</span><span id="line-253"></span><span class="hs-keyword">type</span><span> </span><span id="ExpressionSubstitutions"><span class="annot"><a href="Futhark.Optimise.CSE.html#ExpressionSubstitutions"><span class="hs-identifier hs-var">ExpressionSubstitutions</span></a></span></span><span> </span><span id="local-6989586621684431071"><span class="annot"><a href="#local-6989586621684431071"><span class="hs-identifier hs-type">rep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-254"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span>
</span><span id="line-255"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#ExpDec"><span class="hs-identifier hs-type">ExpDec</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431071"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431071"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-256"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431071"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-257"></span><span>
</span><span id="line-258"></span><span class="hs-keyword">type</span><span> </span><span id="NameSubstitutions"><span class="annot"><a href="Futhark.Optimise.CSE.html#NameSubstitutions"><span class="hs-identifier hs-var">NameSubstitutions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span>
</span><span id="line-259"></span><span>
</span><span id="line-260"></span><span class="hs-keyword">data</span><span> </span><span id="CSEState"><span class="annot"><a href="Futhark.Optimise.CSE.html#CSEState"><span class="hs-identifier hs-var">CSEState</span></a></span></span><span> </span><span id="local-6989586621684431622"><span class="annot"><a href="#local-6989586621684431622"><span class="hs-identifier hs-type">rep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="CSEState"><span class="annot"><a href="Futhark.Optimise.CSE.html#CSEState"><span class="hs-identifier hs-var">CSEState</span></a></span></span><span>
</span><span id="line-261"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="_cseSubstitutions"><span class="annot"><span class="annottext">forall rep.
CSEState rep -&gt; (ExpressionSubstitutions rep, NameSubstitutions)
</span><a href="Futhark.Optimise.CSE.html#_cseSubstitutions"><span class="hs-identifier hs-var hs-var">_cseSubstitutions</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.CSE.html#ExpressionSubstitutions"><span class="hs-identifier hs-type">ExpressionSubstitutions</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431622"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Optimise.CSE.html#NameSubstitutions"><span class="hs-identifier hs-type">NameSubstitutions</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-262"></span><span>    </span><span id="_cseArrays"><span class="annot"><span class="annottext">forall rep. CSEState rep -&gt; Bool
</span><a href="Futhark.Optimise.CSE.html#_cseArrays"><span class="hs-identifier hs-var hs-var">_cseArrays</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-263"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-264"></span><span>
</span><span id="line-265"></span><span id="local-6989586621684431783"><span class="annot"><a href="Futhark.Optimise.CSE.html#newCSEState"><span class="hs-identifier hs-type">newCSEState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.CSE.html#CSEState"><span class="hs-identifier hs-type">CSEState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431783"><span class="hs-identifier hs-type">rep</span></a></span></span><span>
</span><span id="line-266"></span><span id="newCSEState"><span class="annot"><span class="annottext">newCSEState :: forall rep. Bool -&gt; CSEState rep
</span><a href="Futhark.Optimise.CSE.html#newCSEState"><span class="hs-identifier hs-var hs-var">newCSEState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ExpressionSubstitutions rep, NameSubstitutions)
-&gt; Bool -&gt; CSEState rep
forall rep.
(ExpressionSubstitutions rep, NameSubstitutions)
-&gt; Bool -&gt; CSEState rep
</span><a href="Futhark.Optimise.CSE.html#CSEState"><span class="hs-identifier hs-var">CSEState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExpressionSubstitutions rep
forall k a. Map k a
</span><span class="hs-identifier hs-var">M.empty</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">NameSubstitutions
forall k a. Map k a
</span><span class="hs-identifier hs-var">M.empty</span></span><span class="hs-special">)</span><span>
</span><span id="line-267"></span><span>
</span><span id="line-268"></span><span id="local-6989586621684431616"><span class="annot"><a href="Futhark.Optimise.CSE.html#mkSubsts"><span class="hs-identifier hs-type">mkSubsts</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#PatT"><span class="hs-identifier hs-type">PatT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431616"><span class="hs-identifier hs-type">dec</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#PatT"><span class="hs-identifier hs-type">PatT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431616"><span class="hs-identifier hs-type">dec</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span></span><span>
</span><span id="line-269"></span><span id="mkSubsts"><span class="annot"><span class="annottext">mkSubsts :: forall dec. PatT dec -&gt; PatT dec -&gt; NameSubstitutions
</span><a href="Futhark.Optimise.CSE.html#mkSubsts"><span class="hs-identifier hs-var hs-var">mkSubsts</span></a></span></span><span> </span><span id="local-6989586621684431065"><span class="annot"><span class="annottext">PatT dec
</span><a href="#local-6989586621684431065"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684431064"><span class="annot"><span class="annottext">PatT dec
</span><a href="#local-6989586621684431064"><span class="hs-identifier hs-var">vs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VName, VName)] -&gt; NameSubstitutions
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="annot"><span class="annottext">([(VName, VName)] -&gt; NameSubstitutions)
-&gt; [(VName, VName)] -&gt; NameSubstitutions
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [(VName, VName)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatT dec -&gt; [VName]
forall dec. PatT dec -&gt; [VName]
</span><a href="Futhark.IR.Prop.Patterns.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="annot"><span class="annottext">PatT dec
</span><a href="#local-6989586621684431065"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatT dec -&gt; [VName]
forall dec. PatT dec -&gt; [VName]
</span><a href="Futhark.IR.Prop.Patterns.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="annot"><span class="annottext">PatT dec
</span><a href="#local-6989586621684431064"><span class="hs-identifier hs-var">vs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-270"></span><span>
</span><span id="line-271"></span><span id="local-6989586621684431629"><span id="local-6989586621684431630"><span class="annot"><a href="Futhark.Optimise.CSE.html#addNameSubst"><span class="hs-identifier hs-type">addNameSubst</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#PatT"><span class="hs-identifier hs-type">PatT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431630"><span class="hs-identifier hs-type">dec</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#PatT"><span class="hs-identifier hs-type">PatT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431630"><span class="hs-identifier hs-type">dec</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.CSE.html#CSEState"><span class="hs-identifier hs-type">CSEState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431629"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.CSE.html#CSEState"><span class="hs-identifier hs-type">CSEState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431629"><span class="hs-identifier hs-type">rep</span></a></span></span></span><span>
</span><span id="line-272"></span><span id="addNameSubst"><span class="annot"><span class="annottext">addNameSubst :: forall dec rep.
PatT dec -&gt; PatT dec -&gt; CSEState rep -&gt; CSEState rep
</span><a href="Futhark.Optimise.CSE.html#addNameSubst"><span class="hs-identifier hs-var hs-var">addNameSubst</span></a></span></span><span> </span><span id="local-6989586621684431061"><span class="annot"><span class="annottext">PatT dec
</span><a href="#local-6989586621684431061"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684431060"><span class="annot"><span class="annottext">PatT dec
</span><a href="#local-6989586621684431060"><span class="hs-identifier hs-var">subpat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.CSE.html#CSEState"><span class="hs-identifier hs-type">CSEState</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684431059"><span class="annot"><span class="annottext">ExpressionSubstitutions rep
</span><a href="#local-6989586621684431059"><span class="hs-identifier hs-var">esubsts</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684431058"><span class="annot"><span class="annottext">NameSubstitutions
</span><a href="#local-6989586621684431058"><span class="hs-identifier hs-var">nsubsts</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684431057"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684431057"><span class="hs-identifier hs-var">cse_arrays</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-273"></span><span>  </span><span class="annot"><span class="annottext">(ExpressionSubstitutions rep, NameSubstitutions)
-&gt; Bool -&gt; CSEState rep
forall rep.
(ExpressionSubstitutions rep, NameSubstitutions)
-&gt; Bool -&gt; CSEState rep
</span><a href="Futhark.Optimise.CSE.html#CSEState"><span class="hs-identifier hs-var">CSEState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExpressionSubstitutions rep
</span><a href="#local-6989586621684431059"><span class="hs-identifier hs-var">esubsts</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PatT dec -&gt; PatT dec -&gt; NameSubstitutions
forall dec. PatT dec -&gt; PatT dec -&gt; NameSubstitutions
</span><a href="Futhark.Optimise.CSE.html#mkSubsts"><span class="hs-identifier hs-var">mkSubsts</span></a></span><span> </span><span class="annot"><span class="annottext">PatT dec
</span><a href="#local-6989586621684431061"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">PatT dec
</span><a href="#local-6989586621684431060"><span class="hs-identifier hs-var">subpat</span></a></span><span> </span><span class="annot"><span class="annottext">NameSubstitutions -&gt; NameSubstitutions -&gt; NameSubstitutions
forall k a. Ord k =&gt; Map k a -&gt; Map k a -&gt; Map k a
</span><span class="hs-operator hs-var">`M.union`</span></span><span> </span><span class="annot"><span class="annottext">NameSubstitutions
</span><a href="#local-6989586621684431058"><span class="hs-identifier hs-var">nsubsts</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684431057"><span class="hs-identifier hs-var">cse_arrays</span></a></span><span>
</span><span id="line-274"></span><span>
</span><span id="line-275"></span><span id="local-6989586621684431624"><span class="annot"><a href="Futhark.Optimise.CSE.html#addExpSubst"><span class="hs-identifier hs-type">addExpSubst</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-276"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.html#ASTRep"><span class="hs-identifier hs-type">ASTRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431624"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-277"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431624"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-278"></span><span>  </span><span class="annot"><a href="Futhark.IR.Rep.html#ExpDec"><span class="hs-identifier hs-type">ExpDec</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431624"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-279"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431624"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-280"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.CSE.html#CSEState"><span class="hs-identifier hs-type">CSEState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431624"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-281"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.CSE.html#CSEState"><span class="hs-identifier hs-type">CSEState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431624"><span class="hs-identifier hs-type">rep</span></a></span></span><span>
</span><span id="line-282"></span><span id="addExpSubst"><span class="annot"><span class="annottext">addExpSubst :: forall rep.
ASTRep rep =&gt;
Pat rep -&gt; ExpDec rep -&gt; Exp rep -&gt; CSEState rep -&gt; CSEState rep
</span><a href="Futhark.Optimise.CSE.html#addExpSubst"><span class="hs-identifier hs-var hs-var">addExpSubst</span></a></span></span><span> </span><span id="local-6989586621684431047"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684431047"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684431046"><span class="annot"><span class="annottext">ExpDec rep
</span><a href="#local-6989586621684431046"><span class="hs-identifier hs-var">edec</span></a></span></span><span> </span><span id="local-6989586621684431045"><span class="annot"><span class="annottext">Exp rep
</span><a href="#local-6989586621684431045"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.CSE.html#CSEState"><span class="hs-identifier hs-type">CSEState</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684431044"><span class="annot"><span class="annottext">ExpressionSubstitutions rep
</span><a href="#local-6989586621684431044"><span class="hs-identifier hs-var">esubsts</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684431043"><span class="annot"><span class="annottext">NameSubstitutions
</span><a href="#local-6989586621684431043"><span class="hs-identifier hs-var">nsubsts</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684431042"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684431042"><span class="hs-identifier hs-var">cse_arrays</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-283"></span><span>  </span><span class="annot"><span class="annottext">(ExpressionSubstitutions rep, NameSubstitutions)
-&gt; Bool -&gt; CSEState rep
forall rep.
(ExpressionSubstitutions rep, NameSubstitutions)
-&gt; Bool -&gt; CSEState rep
</span><a href="Futhark.Optimise.CSE.html#CSEState"><span class="hs-identifier hs-var">CSEState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ExpDec rep, Exp rep)
-&gt; Pat rep
-&gt; ExpressionSubstitutions rep
-&gt; ExpressionSubstitutions rep
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExpDec rep
</span><a href="#local-6989586621684431046"><span class="hs-identifier hs-var">edec</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Exp rep
</span><a href="#local-6989586621684431045"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684431047"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">ExpressionSubstitutions rep
</span><a href="#local-6989586621684431044"><span class="hs-identifier hs-var">esubsts</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">NameSubstitutions
</span><a href="#local-6989586621684431043"><span class="hs-identifier hs-var">nsubsts</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684431042"><span class="hs-identifier hs-var">cse_arrays</span></a></span><span>
</span><span id="line-284"></span><span>
</span><span id="line-285"></span><span class="hs-comment">-- | The operations that permit CSE.</span><span>
</span><span id="line-286"></span><span class="hs-keyword">class</span><span> </span><span id="CSEInOp"><span class="annot"><a href="Futhark.Optimise.CSE.html#CSEInOp"><span class="hs-identifier hs-var">CSEInOp</span></a></span></span><span> </span><span id="local-6989586621684431672"><span class="annot"><a href="#local-6989586621684431672"><span class="hs-identifier hs-type">op</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-287"></span><span>  </span><span class="hs-comment">-- | Perform CSE within any nested expressions.</span><span>
</span><span id="line-288"></span><span>  </span><span id="local-6989586621684431671"><span id="cseInOp"><span class="annot"><a href="Futhark.Optimise.CSE.html#cseInOp"><span class="hs-identifier hs-type">cseInOp</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621684431672"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.CSE.html#CSEM"><span class="hs-identifier hs-type">CSEM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431671"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431672"><span class="hs-identifier hs-type">op</span></a></span></span><span>
</span><span id="line-289"></span><span>
</span><span id="line-290"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Futhark.Optimise.CSE.html#CSEInOp"><span class="hs-identifier hs-type">CSEInOp</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-291"></span><span>  </span><span id="local-6989586621684431035"><span class="annot"><span class="annottext">cseInOp :: forall rep. () -&gt; CSEM rep ()
</span><a href="#local-6989586621684431035"><span class="hs-identifier hs-var hs-var hs-var hs-var">cseInOp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; ReaderT (CSEState rep) Identity ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-292"></span><span>
</span><span id="line-293"></span><span id="local-6989586621684431602"><span id="local-6989586621684431603"><span id="local-6989586621684431604"><span class="annot"><a href="Futhark.Optimise.CSE.html#subCSE"><span class="hs-identifier hs-type">subCSE</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.CSE.html#CSEM"><span class="hs-identifier hs-type">CSEM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431604"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431603"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.CSE.html#CSEM"><span class="hs-identifier hs-type">CSEM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431602"><span class="hs-identifier hs-type">otherrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431603"><span class="hs-identifier hs-type">r</span></a></span></span></span></span><span>
</span><span id="line-294"></span><span id="subCSE"><span class="annot"><span class="annottext">subCSE :: forall rep r otherrep. CSEM rep r -&gt; CSEM otherrep r
</span><a href="Futhark.Optimise.CSE.html#subCSE"><span class="hs-identifier hs-var hs-var">subCSE</span></a></span></span><span> </span><span id="local-6989586621684431029"><span class="annot"><span class="annottext">CSEM rep r
</span><a href="#local-6989586621684431029"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-295"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.CSE.html#CSEState"><span class="hs-identifier hs-type">CSEState</span></a></span><span> </span><span class="annot"><span class="annottext">(ExpressionSubstitutions otherrep, NameSubstitutions)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684431028"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684431028"><span class="hs-identifier hs-var">cse_arrays</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ReaderT (CSEState otherrep) Identity (CSEState otherrep)
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-296"></span><span>  </span><span class="annot"><span class="annottext">r -&gt; CSEM otherrep r
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(r -&gt; CSEM otherrep r) -&gt; r -&gt; CSEM otherrep r
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CSEM rep r -&gt; CSEState rep -&gt; r
forall r a. Reader r a -&gt; r -&gt; a
</span><span class="hs-identifier hs-var">runReader</span></span><span> </span><span class="annot"><span class="annottext">CSEM rep r
</span><a href="#local-6989586621684431029"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">(CSEState rep -&gt; r) -&gt; CSEState rep -&gt; r
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; CSEState rep
forall rep. Bool -&gt; CSEState rep
</span><a href="Futhark.Optimise.CSE.html#newCSEState"><span class="hs-identifier hs-var">newCSEState</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684431028"><span class="hs-identifier hs-var">cse_arrays</span></a></span><span>
</span><span id="line-297"></span><span>
</span><span id="line-298"></span><span id="local-6989586621684431594"><span id="local-6989586621684431595"><span class="hs-keyword">instance</span><span>
</span><span id="line-299"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.html#ASTRep"><span class="hs-identifier hs-type">ASTRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431595"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-300"></span><span>    </span><span class="annot"><a href="Futhark.IR.Prop.Aliases.html#Aliased"><span class="hs-identifier hs-type">Aliased</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431595"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-301"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.CSE.html#CSEInOp"><span class="hs-identifier hs-type">CSEInOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431595"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-302"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.CSE.html#CSEInOp"><span class="hs-identifier hs-type">CSEInOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431594"><span class="hs-identifier hs-type">op</span></a></span><span>
</span><span id="line-303"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-304"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.CSE.html#CSEInOp"><span class="hs-identifier hs-type">CSEInOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#HostOp"><span class="hs-identifier hs-type">GPU.HostOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431595"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431594"><span class="hs-identifier hs-type">op</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-305"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-306"></span><span>  </span><span id="local-6989586621684431008"><span class="annot"><span class="annottext">cseInOp :: forall rep. HostOp rep op -&gt; CSEM rep (HostOp rep op)
</span><a href="#local-6989586621684431008"><span class="hs-identifier hs-var hs-var hs-var hs-var">cseInOp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SegOp"><span class="hs-identifier hs-type">GPU.SegOp</span></a></span><span> </span><span id="local-6989586621684431006"><span class="annot"><span class="annottext">SegOp SegLevel rep
</span><a href="#local-6989586621684431006"><span class="hs-identifier hs-var">op</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SegOp SegLevel rep -&gt; HostOp rep op
forall rep op. SegOp SegLevel rep -&gt; HostOp rep op
</span><a href="Futhark.IR.GPU.Op.html#SegOp"><span class="hs-identifier hs-var">GPU.SegOp</span></a></span><span> </span><span class="annot"><span class="annottext">(SegOp SegLevel rep -&gt; HostOp rep op)
-&gt; ReaderT (CSEState rep) Identity (SegOp SegLevel rep)
-&gt; ReaderT (CSEState rep) Identity (HostOp rep op)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">SegOp SegLevel rep
-&gt; ReaderT (CSEState rep) Identity (SegOp SegLevel rep)
forall op rep. CSEInOp op =&gt; op -&gt; CSEM rep op
</span><a href="Futhark.Optimise.CSE.html#cseInOp"><span class="hs-identifier hs-var">cseInOp</span></a></span><span> </span><span class="annot"><span class="annottext">SegOp SegLevel rep
</span><a href="#local-6989586621684431006"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-307"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.CSE.html#cseInOp"><span class="hs-identifier hs-var">cseInOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#OtherOp"><span class="hs-identifier hs-type">GPU.OtherOp</span></a></span><span> </span><span id="local-6989586621684431003"><span class="annot"><span class="annottext">op
</span><a href="#local-6989586621684431003"><span class="hs-identifier hs-var">op</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">op -&gt; HostOp rep op
forall rep op. op -&gt; HostOp rep op
</span><a href="Futhark.IR.GPU.Op.html#OtherOp"><span class="hs-identifier hs-var">GPU.OtherOp</span></a></span><span> </span><span class="annot"><span class="annottext">(op -&gt; HostOp rep op)
-&gt; ReaderT (CSEState rep) Identity op
-&gt; ReaderT (CSEState rep) Identity (HostOp rep op)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">op -&gt; ReaderT (CSEState rep) Identity op
forall op rep. CSEInOp op =&gt; op -&gt; CSEM rep op
</span><a href="Futhark.Optimise.CSE.html#cseInOp"><span class="hs-identifier hs-var">cseInOp</span></a></span><span> </span><span class="annot"><span class="annottext">op
</span><a href="#local-6989586621684431003"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-308"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.CSE.html#cseInOp"><span class="hs-identifier hs-var">cseInOp</span></a></span><span> </span><span id="local-6989586621684431002"><span class="annot"><span class="annottext">HostOp rep op
</span><a href="#local-6989586621684431002"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HostOp rep op -&gt; ReaderT (CSEState rep) Identity (HostOp rep op)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">HostOp rep op
</span><a href="#local-6989586621684431002"><span class="hs-identifier hs-var">x</span></a></span></span></span><span>
</span><span id="line-309"></span><span>
</span><span id="line-310"></span><span id="local-6989586621684431577"><span id="local-6989586621684431578"><span class="hs-keyword">instance</span><span>
</span><span id="line-311"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.html#ASTRep"><span class="hs-identifier hs-type">ASTRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431578"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-312"></span><span>    </span><span class="annot"><a href="Futhark.IR.Prop.Aliases.html#Aliased"><span class="hs-identifier hs-type">Aliased</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431578"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-313"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.CSE.html#CSEInOp"><span class="hs-identifier hs-type">CSEInOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431578"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-314"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.CSE.html#CSEInOp"><span class="hs-identifier hs-type">CSEInOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431577"><span class="hs-identifier hs-type">op</span></a></span><span>
</span><span id="line-315"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-316"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.CSE.html#CSEInOp"><span class="hs-identifier hs-type">CSEInOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.MC.Op.html#MCOp"><span class="hs-identifier hs-type">MC.MCOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431578"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431577"><span class="hs-identifier hs-type">op</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-317"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-318"></span><span>  </span><span id="local-6989586621684430981"><span class="annot"><span class="annottext">cseInOp :: forall rep. MCOp rep op -&gt; CSEM rep (MCOp rep op)
</span><a href="#local-6989586621684430981"><span class="hs-identifier hs-var hs-var hs-var hs-var">cseInOp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.MC.Op.html#ParOp"><span class="hs-identifier hs-type">MC.ParOp</span></a></span><span> </span><span id="local-6989586621684430979"><span class="annot"><span class="annottext">Maybe (SegOp () rep)
</span><a href="#local-6989586621684430979"><span class="hs-identifier hs-var">par_op</span></a></span></span><span> </span><span id="local-6989586621684430978"><span class="annot"><span class="annottext">SegOp () rep
</span><a href="#local-6989586621684430978"><span class="hs-identifier hs-var">op</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-319"></span><span>    </span><span class="annot"><span class="annottext">Maybe (SegOp () rep) -&gt; SegOp () rep -&gt; MCOp rep op
forall rep op. Maybe (SegOp () rep) -&gt; SegOp () rep -&gt; MCOp rep op
</span><a href="Futhark.IR.MC.Op.html#ParOp"><span class="hs-identifier hs-var">MC.ParOp</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (SegOp () rep) -&gt; SegOp () rep -&gt; MCOp rep op)
-&gt; ReaderT (CSEState rep) Identity (Maybe (SegOp () rep))
-&gt; ReaderT (CSEState rep) Identity (SegOp () rep -&gt; MCOp rep op)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(SegOp () rep -&gt; ReaderT (CSEState rep) Identity (SegOp () rep))
-&gt; Maybe (SegOp () rep)
-&gt; ReaderT (CSEState rep) Identity (Maybe (SegOp () rep))
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="annot"><span class="annottext">SegOp () rep -&gt; ReaderT (CSEState rep) Identity (SegOp () rep)
forall op rep. CSEInOp op =&gt; op -&gt; CSEM rep op
</span><a href="Futhark.Optimise.CSE.html#cseInOp"><span class="hs-identifier hs-var">cseInOp</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (SegOp () rep)
</span><a href="#local-6989586621684430979"><span class="hs-identifier hs-var">par_op</span></a></span><span> </span><span class="annot"><span class="annottext">ReaderT (CSEState rep) Identity (SegOp () rep -&gt; MCOp rep op)
-&gt; ReaderT (CSEState rep) Identity (SegOp () rep)
-&gt; ReaderT (CSEState rep) Identity (MCOp rep op)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">SegOp () rep -&gt; ReaderT (CSEState rep) Identity (SegOp () rep)
forall op rep. CSEInOp op =&gt; op -&gt; CSEM rep op
</span><a href="Futhark.Optimise.CSE.html#cseInOp"><span class="hs-identifier hs-var">cseInOp</span></a></span><span> </span><span class="annot"><span class="annottext">SegOp () rep
</span><a href="#local-6989586621684430978"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-320"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.CSE.html#cseInOp"><span class="hs-identifier hs-var">cseInOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.MC.Op.html#OtherOp"><span class="hs-identifier hs-type">MC.OtherOp</span></a></span><span> </span><span id="local-6989586621684430975"><span class="annot"><span class="annottext">op
</span><a href="#local-6989586621684430975"><span class="hs-identifier hs-var">op</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-321"></span><span>    </span><span class="annot"><span class="annottext">op -&gt; MCOp rep op
forall rep op. op -&gt; MCOp rep op
</span><a href="Futhark.IR.MC.Op.html#OtherOp"><span class="hs-identifier hs-var">MC.OtherOp</span></a></span><span> </span><span class="annot"><span class="annottext">(op -&gt; MCOp rep op)
-&gt; ReaderT (CSEState rep) Identity op
-&gt; ReaderT (CSEState rep) Identity (MCOp rep op)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">op -&gt; ReaderT (CSEState rep) Identity op
forall op rep. CSEInOp op =&gt; op -&gt; CSEM rep op
</span><a href="Futhark.Optimise.CSE.html#cseInOp"><span class="hs-identifier hs-var">cseInOp</span></a></span><span> </span><span class="annot"><span class="annottext">op
</span><a href="#local-6989586621684430975"><span class="hs-identifier hs-var">op</span></a></span></span></span><span>
</span><span id="line-322"></span><span>
</span><span id="line-323"></span><span id="local-6989586621684431587"><span id="local-6989586621684431588"><span class="hs-keyword">instance</span><span>
</span><span id="line-324"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Prop.html#ASTRep"><span class="hs-identifier hs-type">ASTRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431588"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Aliases.html#Aliased"><span class="hs-identifier hs-type">Aliased</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431588"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Optimise.CSE.html#CSEInOp"><span class="hs-identifier hs-type">CSEInOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431588"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-325"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.CSE.html#CSEInOp"><span class="hs-identifier hs-type">CSEInOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#SegOp"><span class="hs-identifier hs-type">GPU.SegOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431587"><span class="hs-identifier hs-type">lvl</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431588"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-326"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-327"></span><span>  </span><span id="local-6989586621684430955"><span class="annot"><span class="annottext">cseInOp :: forall rep. SegOp lvl rep -&gt; CSEM rep (SegOp lvl rep)
</span><a href="#local-6989586621684430955"><span class="hs-identifier hs-var hs-var hs-var hs-var">cseInOp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-328"></span><span>    </span><span class="annot"><span class="annottext">CSEM rep (SegOp lvl rep) -&gt; CSEM rep (SegOp lvl rep)
forall rep r otherrep. CSEM rep r -&gt; CSEM otherrep r
</span><a href="Futhark.Optimise.CSE.html#subCSE"><span class="hs-identifier hs-var">subCSE</span></a></span><span>
</span><span id="line-329"></span><span>      </span><span class="annot"><span class="annottext">(CSEM rep (SegOp lvl rep) -&gt; CSEM rep (SegOp lvl rep))
-&gt; (SegOp lvl rep -&gt; CSEM rep (SegOp lvl rep))
-&gt; SegOp lvl rep
-&gt; CSEM rep (SegOp lvl rep)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SegOpMapper lvl rep rep (ReaderT (CSEState rep) Identity)
-&gt; SegOp lvl rep -&gt; CSEM rep (SegOp lvl rep)
forall (m :: * -&gt; *) lvl frep trep.
(Applicative m, Monad m) =&gt;
SegOpMapper lvl frep trep m -&gt; SegOp lvl frep -&gt; m (SegOp lvl trep)
</span><a href="Futhark.IR.SegOp.html#mapSegOpM"><span class="hs-identifier hs-var">GPU.mapSegOpM</span></a></span><span>
</span><span id="line-330"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SubExp -&gt; ReaderT (CSEState rep) Identity SubExp)
-&gt; (Lambda rep -&gt; ReaderT (CSEState rep) Identity (Lambda rep))
-&gt; (KernelBody rep
    -&gt; ReaderT (CSEState rep) Identity (KernelBody rep))
-&gt; (VName -&gt; ReaderT (CSEState rep) Identity VName)
-&gt; (lvl -&gt; ReaderT (CSEState rep) Identity lvl)
-&gt; SegOpMapper lvl rep rep (ReaderT (CSEState rep) Identity)
forall lvl frep trep (m :: * -&gt; *).
(SubExp -&gt; m SubExp)
-&gt; (Lambda frep -&gt; m (Lambda trep))
-&gt; (KernelBody frep -&gt; m (KernelBody trep))
-&gt; (VName -&gt; m VName)
-&gt; (lvl -&gt; m lvl)
-&gt; SegOpMapper lvl frep trep m
</span><a href="Futhark.IR.SegOp.html#SegOpMapper"><span class="hs-identifier hs-var">GPU.SegOpMapper</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; ReaderT (CSEState rep) Identity SubExp
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; ReaderT (CSEState rep) Identity (Lambda rep)
forall rep.
(ASTRep rep, Aliased rep, CSEInOp (Op rep)) =&gt;
Lambda rep -&gt; CSEM rep (Lambda rep)
</span><a href="Futhark.Optimise.CSE.html#cseInLambda"><span class="hs-identifier hs-var">cseInLambda</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody rep -&gt; ReaderT (CSEState rep) Identity (KernelBody rep)
forall rep.
(ASTRep rep, Aliased rep, CSEInOp (Op rep)) =&gt;
KernelBody rep -&gt; CSEM rep (KernelBody rep)
</span><a href="Futhark.Optimise.CSE.html#cseInKernelBody"><span class="hs-identifier hs-var">cseInKernelBody</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; ReaderT (CSEState rep) Identity VName
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">lvl -&gt; ReaderT (CSEState rep) Identity lvl
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-331"></span><span>
</span><span id="line-332"></span><span id="local-6989586621684431555"><span class="annot"><a href="Futhark.Optimise.CSE.html#cseInKernelBody"><span class="hs-identifier hs-type">cseInKernelBody</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-333"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Prop.html#ASTRep"><span class="hs-identifier hs-type">ASTRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431555"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Aliases.html#Aliased"><span class="hs-identifier hs-type">Aliased</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431555"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Optimise.CSE.html#CSEInOp"><span class="hs-identifier hs-type">CSEInOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431555"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-334"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-type">GPU.KernelBody</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431555"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-335"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.CSE.html#CSEM"><span class="hs-identifier hs-type">CSEM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431555"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-type">GPU.KernelBody</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431555"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-336"></span><span id="cseInKernelBody"><span class="annot"><span class="annottext">cseInKernelBody :: forall rep.
(ASTRep rep, Aliased rep, CSEInOp (Op rep)) =&gt;
KernelBody rep -&gt; CSEM rep (KernelBody rep)
</span><a href="Futhark.Optimise.CSE.html#cseInKernelBody"><span class="hs-identifier hs-var hs-var">cseInKernelBody</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-type">GPU.KernelBody</span></a></span><span> </span><span id="local-6989586621684430939"><span class="annot"><span class="annottext">BodyDec rep
</span><a href="#local-6989586621684430939"><span class="hs-identifier hs-var">bodydec</span></a></span></span><span> </span><span id="local-6989586621684430938"><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684430938"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span id="local-6989586621684430937"><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684430937"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-337"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><span class="annottext">BodyDec rep
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684430936"><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684430936"><span class="hs-identifier hs-var">stms'</span></a></span></span><span> </span><span class="annot"><span class="annottext">Result
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Diet] -&gt; BodyT rep -&gt; CSEM rep (BodyT rep)
forall rep.
(ASTRep rep, Aliased rep, CSEInOp (Op rep)) =&gt;
[Diet] -&gt; Body rep -&gt; CSEM rep (Body rep)
</span><a href="Futhark.Optimise.CSE.html#cseInBody"><span class="hs-identifier hs-var">cseInBody</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(KernelResult -&gt; Diet) -&gt; [KernelResult] -&gt; [Diet]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Diet -&gt; KernelResult -&gt; Diet
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">Diet
</span><a href="Futhark.IR.Syntax.Core.html#Observe"><span class="hs-identifier hs-var">Observe</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684430937"><span class="hs-identifier hs-var">res</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(BodyT rep -&gt; CSEM rep (BodyT rep))
-&gt; BodyT rep -&gt; CSEM rep (BodyT rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BodyDec rep -&gt; Stms rep -&gt; Result -&gt; BodyT rep
forall rep. BodyDec rep -&gt; Stms rep -&gt; Result -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-var">Body</span></a></span><span> </span><span class="annot"><span class="annottext">BodyDec rep
</span><a href="#local-6989586621684430939"><span class="hs-identifier hs-var">bodydec</span></a></span><span> </span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684430938"><span class="hs-identifier hs-var">stms</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-338"></span><span>  </span><span class="annot"><span class="annottext">KernelBody rep -&gt; CSEM rep (KernelBody rep)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(KernelBody rep -&gt; CSEM rep (KernelBody rep))
-&gt; KernelBody rep -&gt; CSEM rep (KernelBody rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BodyDec rep -&gt; Stms rep -&gt; [KernelResult] -&gt; KernelBody rep
forall rep.
BodyDec rep -&gt; Stms rep -&gt; [KernelResult] -&gt; KernelBody rep
</span><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-var">GPU.KernelBody</span></a></span><span> </span><span class="annot"><span class="annottext">BodyDec rep
</span><a href="#local-6989586621684430939"><span class="hs-identifier hs-var">bodydec</span></a></span><span> </span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684430936"><span class="hs-identifier hs-var">stms'</span></a></span><span> </span><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684430937"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-339"></span><span>
</span><span id="line-340"></span><span id="local-6989586621684431548"><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Futhark.Optimise.CSE.html#CSEInOp"><span class="hs-identifier hs-type">CSEInOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431548"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.CSE.html#CSEInOp"><span class="hs-identifier hs-type">CSEInOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#MemOp"><span class="hs-identifier hs-type">Memory.MemOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431548"><span class="hs-identifier hs-type">op</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-341"></span><span>  </span><span id="local-6989586621684430927"><span class="annot"><span class="annottext">cseInOp :: forall rep. MemOp op -&gt; CSEM rep (MemOp op)
</span><a href="#local-6989586621684430927"><span class="hs-identifier hs-var hs-var hs-var hs-var">cseInOp</span></a></span></span><span> </span><span id="local-6989586621684430926"><span class="annot"><span class="annottext">o :: MemOp op
</span><a href="#local-6989586621684430926"><span class="hs-identifier hs-var">o</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Futhark.IR.Mem.html#Alloc"><span class="hs-identifier hs-type">Memory.Alloc</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MemOp op -&gt; ReaderT (CSEState rep) Identity (MemOp op)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">MemOp op
</span><a href="#local-6989586621684430926"><span class="hs-identifier hs-var">o</span></a></span><span>
</span><span id="line-342"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.CSE.html#cseInOp"><span class="hs-identifier hs-var">cseInOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#Inner"><span class="hs-identifier hs-type">Memory.Inner</span></a></span><span> </span><span id="local-6989586621684430923"><span class="annot"><span class="annottext">op
</span><a href="#local-6989586621684430923"><span class="hs-identifier hs-var">k</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">op -&gt; MemOp op
forall inner. inner -&gt; MemOp inner
</span><a href="Futhark.IR.Mem.html#Inner"><span class="hs-identifier hs-var">Memory.Inner</span></a></span><span> </span><span class="annot"><span class="annottext">(op -&gt; MemOp op)
-&gt; ReaderT (CSEState rep) Identity op
-&gt; ReaderT (CSEState rep) Identity (MemOp op)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">CSEM Any op -&gt; ReaderT (CSEState rep) Identity op
forall rep r otherrep. CSEM rep r -&gt; CSEM otherrep r
</span><a href="Futhark.Optimise.CSE.html#subCSE"><span class="hs-identifier hs-var">subCSE</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">op -&gt; CSEM Any op
forall op rep. CSEInOp op =&gt; op -&gt; CSEM rep op
</span><a href="Futhark.Optimise.CSE.html#cseInOp"><span class="hs-identifier hs-var">cseInOp</span></a></span><span> </span><span class="annot"><span class="annottext">op
</span><a href="#local-6989586621684430923"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-343"></span><span>
</span><span id="line-344"></span><span id="local-6989586621684431543"><span class="hs-keyword">instance</span><span>
</span><span id="line-345"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.html#ASTRep"><span class="hs-identifier hs-type">ASTRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431543"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-346"></span><span>    </span><span class="annot"><a href="Futhark.IR.Prop.Aliases.html#CanBeAliased"><span class="hs-identifier hs-type">CanBeAliased</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431543"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-347"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.CSE.html#CSEInOp"><span class="hs-identifier hs-type">CSEInOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Prop.Aliases.html#OpWithAliases"><span class="hs-identifier hs-type">OpWithAliases</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431543"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-348"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-349"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.CSE.html#CSEInOp"><span class="hs-identifier hs-type">CSEInOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#SOAC"><span class="hs-identifier hs-type">SOAC.SOAC</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Aliases.html#Aliases"><span class="hs-identifier hs-type">Aliases</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684431543"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-350"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-351"></span><span>  </span><span id="local-6989586621684430902"><span class="annot"><span class="annottext">cseInOp :: forall rep. SOAC (Aliases rep) -&gt; CSEM rep (SOAC (Aliases rep))
</span><a href="#local-6989586621684430902"><span class="hs-identifier hs-var hs-var hs-var hs-var">cseInOp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CSEM (Aliases rep) (SOAC (Aliases rep))
-&gt; CSEM rep (SOAC (Aliases rep))
forall rep r otherrep. CSEM rep r -&gt; CSEM otherrep r
</span><a href="Futhark.Optimise.CSE.html#subCSE"><span class="hs-identifier hs-var">subCSE</span></a></span><span> </span><span class="annot"><span class="annottext">(CSEM (Aliases rep) (SOAC (Aliases rep))
 -&gt; CSEM rep (SOAC (Aliases rep)))
-&gt; (SOAC (Aliases rep) -&gt; CSEM (Aliases rep) (SOAC (Aliases rep)))
-&gt; SOAC (Aliases rep)
-&gt; CSEM rep (SOAC (Aliases rep))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SOACMapper
  (Aliases rep)
  (Aliases rep)
  (ReaderT (CSEState (Aliases rep)) Identity)
-&gt; SOAC (Aliases rep) -&gt; CSEM (Aliases rep) (SOAC (Aliases rep))
forall (m :: * -&gt; *) frep trep.
(Applicative m, Monad m) =&gt;
SOACMapper frep trep m -&gt; SOAC frep -&gt; m (SOAC trep)
</span><a href="Futhark.IR.SOACS.SOAC.html#mapSOACM"><span class="hs-identifier hs-var">SOAC.mapSOACM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SubExp -&gt; ReaderT (CSEState (Aliases rep)) Identity SubExp)
-&gt; (Lambda (Aliases rep)
    -&gt; ReaderT
         (CSEState (Aliases rep)) Identity (Lambda (Aliases rep)))
-&gt; (VName -&gt; ReaderT (CSEState (Aliases rep)) Identity VName)
-&gt; SOACMapper
     (Aliases rep)
     (Aliases rep)
     (ReaderT (CSEState (Aliases rep)) Identity)
forall frep trep (m :: * -&gt; *).
(SubExp -&gt; m SubExp)
-&gt; (Lambda frep -&gt; m (Lambda trep))
-&gt; (VName -&gt; m VName)
-&gt; SOACMapper frep trep m
</span><a href="Futhark.IR.SOACS.SOAC.html#SOACMapper"><span class="hs-identifier hs-var">SOAC.SOACMapper</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; ReaderT (CSEState (Aliases rep)) Identity SubExp
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Lambda (Aliases rep)
-&gt; ReaderT (CSEState (Aliases rep)) Identity (Lambda (Aliases rep))
forall rep.
(ASTRep rep, Aliased rep, CSEInOp (Op rep)) =&gt;
Lambda rep -&gt; CSEM rep (Lambda rep)
</span><a href="Futhark.Optimise.CSE.html#cseInLambda"><span class="hs-identifier hs-var">cseInLambda</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; ReaderT (CSEState (Aliases rep)) Identity VName
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span class="hs-special">)</span></span><span>
</span><span id="line-352"></span></pre></body></html>