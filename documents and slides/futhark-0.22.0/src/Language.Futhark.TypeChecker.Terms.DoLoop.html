<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE FlexibleInstances #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-4"></span><span>
</span><span id="line-5"></span><span class="hs-comment">-- | Type inference of @loop@.  This is complicated because of the</span><span>
</span><span id="line-6"></span><span class="hs-comment">-- uniqueness and size inference, so the implementation is separate</span><span>
</span><span id="line-7"></span><span class="hs-comment">-- from the main type checker.</span><span>
</span><span id="line-8"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Language.Futhark.TypeChecker.Terms.DoLoop</span><span>
</span><span id="line-9"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.DoLoop.html#UncheckedLoop"><span class="hs-identifier">UncheckedLoop</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-10"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.DoLoop.html#CheckedLoop"><span class="hs-identifier">CheckedLoop</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-11"></span><span>    </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.DoLoop.html#checkDoLoop"><span class="hs-identifier">checkDoLoop</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-12"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-13"></span><span class="hs-keyword">where</span><span>
</span><span id="line-14"></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Except</span></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Reader</span></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.State</span></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Bifunctor</span></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Bitraversable</span></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map.Strict</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S</span></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Util.html"><span class="hs-identifier">Futhark.Util</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Util.html#nubOrd"><span class="hs-identifier">nubOrd</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Util.Pretty.html"><span class="hs-identifier">Futhark.Util.Pretty</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">bool</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">group</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">space</span></span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Language.Futhark.html"><span class="hs-identifier">Language.Futhark</span></a></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Monad.html"><span class="hs-identifier">Language.Futhark.TypeChecker.Monad</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Semantic.html#BoundV"><span class="hs-identifier">BoundV</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html"><span class="hs-identifier">Language.Futhark.TypeChecker.Terms.Monad</span></a></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Pat.html"><span class="hs-identifier">Language.Futhark.TypeChecker.Terms.Pat</span></a></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html"><span class="hs-identifier">Language.Futhark.TypeChecker.Types</span></a></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Unify.html"><span class="hs-identifier">Language.Futhark.TypeChecker.Unify</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Unify.html#Usage"><span class="hs-identifier">Usage</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Prelude</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">mod</span></span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span>
</span><span id="line-33"></span><span class="hs-comment">-- | Replace specified sizes with distinct fresh size variables.</span><span>
</span><span id="line-34"></span><span id="local-6989586621684560180"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.DoLoop.html#someDimsFreshInType"><span class="hs-identifier hs-type">someDimsFreshInType</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-35"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">SrcLoc</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-36"></span><span>  </span><span class="annot"><a href="Language.Futhark.TypeChecker.Unify.html#Rigidity"><span class="hs-identifier hs-type">Rigidity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-37"></span><span>  </span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-38"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">S.Set</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-39"></span><span>  </span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeBase"><span class="hs-identifier hs-type">TypeBase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#DimDecl"><span class="hs-identifier hs-type">DimDecl</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621684560180"><span class="hs-identifier hs-type">als</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-40"></span><span>  </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeBase"><span class="hs-identifier hs-type">TypeBase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#DimDecl"><span class="hs-identifier hs-type">DimDecl</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621684560180"><span class="hs-identifier hs-type">als</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-41"></span><span id="someDimsFreshInType"><span class="annot"><span class="annottext">someDimsFreshInType :: forall als.
SrcLoc
-&gt; Rigidity
-&gt; Name
-&gt; Set VName
-&gt; TypeBase (DimDecl VName) als
-&gt; TermTypeM (TypeBase (DimDecl VName) als)
</span><a href="Language.Futhark.TypeChecker.Terms.DoLoop.html#someDimsFreshInType"><span class="hs-identifier hs-var hs-var">someDimsFreshInType</span></a></span></span><span> </span><span id="local-6989586621684559832"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684559832"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span id="local-6989586621684559831"><span class="annot"><span class="annottext">Rigidity
</span><a href="#local-6989586621684559831"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span id="local-6989586621684559830"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684559830"><span class="hs-identifier hs-var">desc</span></a></span></span><span> </span><span id="local-6989586621684559829"><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684559829"><span class="hs-identifier hs-var">sizes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DimDecl VName -&gt; TermTypeM (DimDecl VName))
-&gt; (als -&gt; TermTypeM als)
-&gt; TypeBase (DimDecl VName) als
-&gt; TermTypeM (TypeBase (DimDecl VName) als)
forall (t :: * -&gt; * -&gt; *) (f :: * -&gt; *) a c b d.
(Bitraversable t, Applicative f) =&gt;
(a -&gt; f c) -&gt; (b -&gt; f d) -&gt; t a b -&gt; f (t c d)
</span><span class="hs-identifier hs-var">bitraverse</span></span><span> </span><span class="annot"><span class="annottext">DimDecl VName -&gt; TermTypeM (DimDecl VName)
forall {m :: * -&gt; *}.
MonadUnify m =&gt;
DimDecl VName -&gt; m (DimDecl VName)
</span><a href="#local-6989586621684559827"><span class="hs-identifier hs-var">onDim</span></a></span><span> </span><span class="annot"><span class="annottext">als -&gt; TermTypeM als
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span>
</span><span id="line-42"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-43"></span><span>    </span><span id="local-6989586621684559827"><span class="annot"><span class="annottext">onDim :: DimDecl VName -&gt; m (DimDecl VName)
</span><a href="#local-6989586621684559827"><span class="hs-identifier hs-var hs-var">onDim</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#NamedDim"><span class="hs-identifier hs-type">NamedDim</span></a></span><span> </span><span id="local-6989586621684559815"><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684559815"><span class="hs-identifier hs-var">d</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-44"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">QualName VName -&gt; VName
forall vn. QualName vn -&gt; vn
</span><a href="Language.Futhark.Syntax.html#qualLeaf"><span class="hs-identifier hs-var hs-var">qualLeaf</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684559815"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Set VName -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><span class="hs-operator hs-var">`S.member`</span></span><span> </span><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684559829"><span class="hs-identifier hs-var">sizes</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-45"></span><span>        </span><span id="local-6989586621684559812"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684559812"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SrcLoc -&gt; Rigidity -&gt; Name -&gt; m VName
forall (m :: * -&gt; *).
MonadUnify m =&gt;
SrcLoc -&gt; Rigidity -&gt; Name -&gt; m VName
</span><a href="Language.Futhark.TypeChecker.Unify.html#newDimVar"><span class="hs-identifier hs-var">newDimVar</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684559832"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">Rigidity
</span><a href="#local-6989586621684559831"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684559830"><span class="hs-identifier hs-var">desc</span></a></span><span>
</span><span id="line-46"></span><span>        </span><span class="annot"><span class="annottext">DimDecl VName -&gt; m (DimDecl VName)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(DimDecl VName -&gt; m (DimDecl VName))
-&gt; DimDecl VName -&gt; m (DimDecl VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">QualName VName -&gt; DimDecl VName
forall vn. QualName vn -&gt; DimDecl vn
</span><a href="Language.Futhark.Syntax.html#NamedDim"><span class="hs-identifier hs-var">NamedDim</span></a></span><span> </span><span class="annot"><span class="annottext">(QualName VName -&gt; DimDecl VName)
-&gt; QualName VName -&gt; DimDecl VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; QualName VName
forall v. v -&gt; QualName v
</span><a href="Language.Futhark.Prop.html#qualName"><span class="hs-identifier hs-var">qualName</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684559812"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-47"></span><span>    </span><span class="annot"><a href="#local-6989586621684559827"><span class="hs-identifier hs-var">onDim</span></a></span><span> </span><span id="local-6989586621684559809"><span class="annot"><span class="annottext">DimDecl VName
</span><a href="#local-6989586621684559809"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DimDecl VName -&gt; m (DimDecl VName)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">DimDecl VName
</span><a href="#local-6989586621684559809"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-48"></span><span>
</span><span id="line-49"></span><span class="hs-comment">-- | Replace the specified sizes with fresh size variables of the</span><span>
</span><span id="line-50"></span><span class="hs-comment">-- specified ridigity.  Returns the new fresh size variables.</span><span>
</span><span id="line-51"></span><span id="local-6989586621684560158"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.DoLoop.html#freshDimsInType"><span class="hs-identifier hs-type">freshDimsInType</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-52"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">SrcLoc</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-53"></span><span>  </span><span class="annot"><a href="Language.Futhark.TypeChecker.Unify.html#Rigidity"><span class="hs-identifier hs-type">Rigidity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-54"></span><span>  </span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-55"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">S.Set</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-56"></span><span>  </span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeBase"><span class="hs-identifier hs-type">TypeBase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#DimDecl"><span class="hs-identifier hs-type">DimDecl</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621684560158"><span class="hs-identifier hs-type">als</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-57"></span><span>  </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeBase"><span class="hs-identifier hs-type">TypeBase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#DimDecl"><span class="hs-identifier hs-type">DimDecl</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621684560158"><span class="hs-identifier hs-type">als</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span></span><span>
</span><span id="line-58"></span><span id="freshDimsInType"><span class="annot"><span class="annottext">freshDimsInType :: forall als.
SrcLoc
-&gt; Rigidity
-&gt; Name
-&gt; Set VName
-&gt; TypeBase (DimDecl VName) als
-&gt; TermTypeM (TypeBase (DimDecl VName) als, [VName])
</span><a href="Language.Futhark.TypeChecker.Terms.DoLoop.html#freshDimsInType"><span class="hs-identifier hs-var hs-var">freshDimsInType</span></a></span></span><span> </span><span id="local-6989586621684559793"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684559793"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span id="local-6989586621684559792"><span class="annot"><span class="annottext">Rigidity
</span><a href="#local-6989586621684559792"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span id="local-6989586621684559791"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684559791"><span class="hs-identifier hs-var">desc</span></a></span></span><span> </span><span id="local-6989586621684559790"><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684559790"><span class="hs-identifier hs-var">sizes</span></a></span></span><span> </span><span id="local-6989586621684559789"><span class="annot"><span class="annottext">TypeBase (DimDecl VName) als
</span><a href="#local-6989586621684559789"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-59"></span><span>  </span><span class="annot"><span class="annottext">(Map VName VName -&gt; [VName])
-&gt; (TypeBase (DimDecl VName) als, Map VName VName)
-&gt; (TypeBase (DimDecl VName) als, [VName])
forall (p :: * -&gt; * -&gt; *) b c a.
Bifunctor p =&gt;
(b -&gt; c) -&gt; p a b -&gt; p a c
</span><span class="hs-identifier hs-var">second</span></span><span> </span><span class="annot"><span class="annottext">Map VName VName -&gt; [VName]
forall k a. Map k a -&gt; [a]
</span><span class="hs-identifier hs-var">M.elems</span></span><span> </span><span class="annot"><span class="annottext">((TypeBase (DimDecl VName) als, Map VName VName)
 -&gt; (TypeBase (DimDecl VName) als, [VName]))
-&gt; TermTypeM (TypeBase (DimDecl VName) als, Map VName VName)
-&gt; TermTypeM (TypeBase (DimDecl VName) als, [VName])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">StateT (Map VName VName) TermTypeM (TypeBase (DimDecl VName) als)
-&gt; Map VName VName
-&gt; TermTypeM (TypeBase (DimDecl VName) als, Map VName VName)
forall s (m :: * -&gt; *) a. StateT s m a -&gt; s -&gt; m (a, s)
</span><span class="hs-identifier hs-var hs-var">runStateT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(DimDecl VName
 -&gt; StateT (Map VName VName) TermTypeM (DimDecl VName))
-&gt; (als -&gt; StateT (Map VName VName) TermTypeM als)
-&gt; TypeBase (DimDecl VName) als
-&gt; StateT
     (Map VName VName) TermTypeM (TypeBase (DimDecl VName) als)
forall (t :: * -&gt; * -&gt; *) (f :: * -&gt; *) a c b d.
(Bitraversable t, Applicative f) =&gt;
(a -&gt; f c) -&gt; (b -&gt; f d) -&gt; t a b -&gt; f (t c d)
</span><span class="hs-identifier hs-var">bitraverse</span></span><span> </span><span class="annot"><span class="annottext">DimDecl VName -&gt; StateT (Map VName VName) TermTypeM (DimDecl VName)
forall {t :: (* -&gt; *) -&gt; * -&gt; *} {m :: * -&gt; *}.
(MonadState (Map VName VName) (t m), MonadTrans t, MonadUnify m) =&gt;
DimDecl VName -&gt; t m (DimDecl VName)
</span><a href="#local-6989586621684559784"><span class="hs-identifier hs-var">onDim</span></a></span><span> </span><span class="annot"><span class="annottext">als -&gt; StateT (Map VName VName) TermTypeM als
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) als
</span><a href="#local-6989586621684559789"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map VName VName
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-60"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-61"></span><span>    </span><span id="local-6989586621684559784"><span class="annot"><span class="annottext">onDim :: DimDecl VName -&gt; t m (DimDecl VName)
</span><a href="#local-6989586621684559784"><span class="hs-identifier hs-var hs-var">onDim</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#NamedDim"><span class="hs-identifier hs-type">NamedDim</span></a></span><span> </span><span id="local-6989586621684559762"><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684559762"><span class="hs-identifier hs-var">d</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-62"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">QualName VName -&gt; VName
forall vn. QualName vn -&gt; vn
</span><a href="Language.Futhark.Syntax.html#qualLeaf"><span class="hs-identifier hs-var hs-var">qualLeaf</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684559762"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Set VName -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><span class="hs-operator hs-var">`S.member`</span></span><span> </span><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684559790"><span class="hs-identifier hs-var">sizes</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-63"></span><span>        </span><span id="local-6989586621684559761"><span class="annot"><span class="annottext">Maybe VName
</span><a href="#local-6989586621684559761"><span class="hs-identifier hs-var">prev_subst</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Map VName VName -&gt; Maybe VName) -&gt; t m (Maybe VName)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">((Map VName VName -&gt; Maybe VName) -&gt; t m (Maybe VName))
-&gt; (Map VName VName -&gt; Maybe VName) -&gt; t m (Maybe VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Map VName VName -&gt; Maybe VName
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Map VName VName -&gt; Maybe VName)
-&gt; VName -&gt; Map VName VName -&gt; Maybe VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">QualName VName -&gt; VName
forall vn. QualName vn -&gt; vn
</span><a href="Language.Futhark.Syntax.html#qualLeaf"><span class="hs-identifier hs-var hs-var">qualLeaf</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684559762"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-64"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe VName
</span><a href="#local-6989586621684559761"><span class="hs-identifier hs-var">prev_subst</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-65"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684559758"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684559758"><span class="hs-identifier hs-var">d'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DimDecl VName -&gt; t m (DimDecl VName)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(DimDecl VName -&gt; t m (DimDecl VName))
-&gt; DimDecl VName -&gt; t m (DimDecl VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">QualName VName -&gt; DimDecl VName
forall vn. QualName vn -&gt; DimDecl vn
</span><a href="Language.Futhark.Syntax.html#NamedDim"><span class="hs-identifier hs-var">NamedDim</span></a></span><span> </span><span class="annot"><span class="annottext">(QualName VName -&gt; DimDecl VName)
-&gt; QualName VName -&gt; DimDecl VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; QualName VName
forall v. v -&gt; QualName v
</span><a href="Language.Futhark.Prop.html#qualName"><span class="hs-identifier hs-var">qualName</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684559758"><span class="hs-identifier hs-var">d'</span></a></span><span>
</span><span id="line-66"></span><span>          </span><span class="annot"><span class="annottext">Maybe VName
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-67"></span><span>            </span><span id="local-6989586621684559757"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684559757"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m VName -&gt; t m VName
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(m VName -&gt; t m VName) -&gt; m VName -&gt; t m VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc -&gt; Rigidity -&gt; Name -&gt; m VName
forall (m :: * -&gt; *).
MonadUnify m =&gt;
SrcLoc -&gt; Rigidity -&gt; Name -&gt; m VName
</span><a href="Language.Futhark.TypeChecker.Unify.html#newDimVar"><span class="hs-identifier hs-var">newDimVar</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684559793"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">Rigidity
</span><a href="#local-6989586621684559792"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684559791"><span class="hs-identifier hs-var">desc</span></a></span><span>
</span><span id="line-68"></span><span>            </span><span class="annot"><span class="annottext">(Map VName VName -&gt; Map VName VName) -&gt; t m ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((Map VName VName -&gt; Map VName VName) -&gt; t m ())
-&gt; (Map VName VName -&gt; Map VName VName) -&gt; t m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; VName -&gt; Map VName VName -&gt; Map VName VName
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QualName VName -&gt; VName
forall vn. QualName vn -&gt; vn
</span><a href="Language.Futhark.Syntax.html#qualLeaf"><span class="hs-identifier hs-var hs-var">qualLeaf</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684559762"><span class="hs-identifier hs-var">d</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684559757"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-69"></span><span>            </span><span class="annot"><span class="annottext">DimDecl VName -&gt; t m (DimDecl VName)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(DimDecl VName -&gt; t m (DimDecl VName))
-&gt; DimDecl VName -&gt; t m (DimDecl VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">QualName VName -&gt; DimDecl VName
forall vn. QualName vn -&gt; DimDecl vn
</span><a href="Language.Futhark.Syntax.html#NamedDim"><span class="hs-identifier hs-var">NamedDim</span></a></span><span> </span><span class="annot"><span class="annottext">(QualName VName -&gt; DimDecl VName)
-&gt; QualName VName -&gt; DimDecl VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; QualName VName
forall v. v -&gt; QualName v
</span><a href="Language.Futhark.Prop.html#qualName"><span class="hs-identifier hs-var">qualName</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684559757"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-70"></span><span>    </span><span class="annot"><a href="#local-6989586621684559784"><span class="hs-identifier hs-var">onDim</span></a></span><span> </span><span id="local-6989586621684559753"><span class="annot"><span class="annottext">DimDecl VName
</span><a href="#local-6989586621684559753"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DimDecl VName -&gt; t m (DimDecl VName)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">DimDecl VName
</span><a href="#local-6989586621684559753"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-71"></span><span>
</span><span id="line-72"></span><span class="hs-comment">-- | An un-checked loop.</span><span>
</span><span id="line-73"></span><span class="hs-keyword">type</span><span> </span><span id="UncheckedLoop"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.DoLoop.html#UncheckedLoop"><span class="hs-identifier hs-var">UncheckedLoop</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-74"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Prop.html#UncheckedPat"><span class="hs-identifier hs-type">UncheckedPat</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.Prop.html#UncheckedExp"><span class="hs-identifier hs-type">UncheckedExp</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#LoopFormBase"><span class="hs-identifier hs-type">LoopFormBase</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#NoInfo"><span class="hs-identifier hs-type">NoInfo</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.Prop.html#UncheckedExp"><span class="hs-identifier hs-type">UncheckedExp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-75"></span><span>
</span><span id="line-76"></span><span class="hs-comment">-- | A loop that has been type-checked.</span><span>
</span><span id="line-77"></span><span class="hs-keyword">type</span><span> </span><span id="CheckedLoop"><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.DoLoop.html#CheckedLoop"><span class="hs-identifier hs-var">CheckedLoop</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-78"></span><span>  </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#LoopFormBase"><span class="hs-identifier hs-type">LoopFormBase</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-type">Info</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-79"></span><span>
</span><span id="line-80"></span><span class="hs-comment">-- | Type-check a @loop@ expression, passing in a function for</span><span>
</span><span id="line-81"></span><span class="hs-comment">-- type-checking subexpressions.</span><span>
</span><span id="line-82"></span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.DoLoop.html#checkDoLoop"><span class="hs-identifier hs-type">checkDoLoop</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-83"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Prop.html#UncheckedExp"><span class="hs-identifier hs-type">UncheckedExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-84"></span><span>  </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.DoLoop.html#UncheckedLoop"><span class="hs-identifier hs-type">UncheckedLoop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-85"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">SrcLoc</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-86"></span><span>  </span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.Monad.html#TermTypeM"><span class="hs-identifier hs-type">TermTypeM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.TypeChecker.Terms.DoLoop.html#CheckedLoop"><span class="hs-identifier hs-type">CheckedLoop</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#AppRes"><span class="hs-identifier hs-type">AppRes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-87"></span><span id="checkDoLoop"><span class="annot"><span class="annottext">checkDoLoop :: (UncheckedExp -&gt; TermTypeM Exp)
-&gt; UncheckedLoop -&gt; SrcLoc -&gt; TermTypeM (CheckedLoop, AppRes)
</span><a href="Language.Futhark.TypeChecker.Terms.DoLoop.html#checkDoLoop"><span class="hs-identifier hs-var hs-var">checkDoLoop</span></a></span></span><span> </span><span id="local-6989586621684559751"><span class="annot"><span class="annottext">UncheckedExp -&gt; TermTypeM Exp
</span><a href="#local-6989586621684559751"><span class="hs-identifier hs-var">checkExp</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684559750"><span class="annot"><span class="annottext">UncheckedPat
</span><a href="#local-6989586621684559750"><span class="hs-identifier hs-var">mergepat</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684559749"><span class="annot"><span class="annottext">UncheckedExp
</span><a href="#local-6989586621684559749"><span class="hs-identifier hs-var">mergeexp</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684559748"><span class="annot"><span class="annottext">LoopFormBase NoInfo Name
</span><a href="#local-6989586621684559748"><span class="hs-identifier hs-var">form</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684559747"><span class="annot"><span class="annottext">UncheckedExp
</span><a href="#local-6989586621684559747"><span class="hs-identifier hs-var">loopbody</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684559746"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684559746"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-88"></span><span>  </span><span class="annot"><span class="annottext">TermTypeM Exp
-&gt; (Exp -&gt; Occurrences -&gt; TermTypeM (CheckedLoop, AppRes))
-&gt; TermTypeM (CheckedLoop, AppRes)
forall a b.
TermTypeM a -&gt; (a -&gt; Occurrences -&gt; TermTypeM b) -&gt; TermTypeM b
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#sequentially"><span class="hs-identifier hs-var">sequentially</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UncheckedExp -&gt; TermTypeM Exp
</span><a href="#local-6989586621684559751"><span class="hs-identifier hs-var">checkExp</span></a></span><span> </span><span class="annot"><span class="annottext">UncheckedExp
</span><a href="#local-6989586621684559749"><span class="hs-identifier hs-var">mergeexp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Exp -&gt; Occurrences -&gt; TermTypeM (CheckedLoop, AppRes))
 -&gt; TermTypeM (CheckedLoop, AppRes))
-&gt; (Exp -&gt; Occurrences -&gt; TermTypeM (CheckedLoop, AppRes))
-&gt; TermTypeM (CheckedLoop, AppRes)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684559744"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684559744"><span class="hs-identifier hs-var">mergeexp'</span></a></span></span><span> </span><span class="annot"><span class="annottext">Occurrences
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-89"></span><span>    </span><span class="annot"><span class="annottext">Usage -&gt; String -&gt; PatType -&gt; TermTypeM ()
forall (m :: * -&gt; *) dim as.
(MonadUnify m, Pretty (ShapeDecl dim), Monoid as) =&gt;
Usage -&gt; String -&gt; TypeBase dim as -&gt; m ()
</span><a href="Language.Futhark.TypeChecker.Unify.html#zeroOrderType"><span class="hs-identifier hs-var">zeroOrderType</span></a></span><span>
</span><span id="line-90"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SrcLoc -&gt; String -&gt; Usage
</span><a href="Language.Futhark.TypeChecker.Unify.html#mkUsage"><span class="hs-identifier hs-var">mkUsage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UncheckedExp -&gt; SrcLoc
forall a. Located a =&gt; a -&gt; SrcLoc
</span><span class="hs-identifier hs-var">srclocOf</span></span><span> </span><span class="annot"><span class="annottext">UncheckedExp
</span><a href="#local-6989586621684559749"><span class="hs-identifier hs-var">mergeexp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;use as loop variable&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-91"></span><span>      </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;type used as loop variable&quot;</span></span><span>
</span><span id="line-92"></span><span>      </span><span class="annot"><span class="annottext">(PatType -&gt; TermTypeM ()) -&gt; TermTypeM PatType -&gt; TermTypeM ()
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; TermTypeM PatType
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#expTypeFully"><span class="hs-identifier hs-var">expTypeFully</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684559744"><span class="hs-identifier hs-var">mergeexp'</span></a></span><span>
</span><span id="line-93"></span><span>
</span><span id="line-94"></span><span>    </span><span class="hs-comment">-- The handling of dimension sizes is a bit intricate, but very</span><span>
</span><span id="line-95"></span><span>    </span><span class="hs-comment">-- similar to checking a function, followed by checking a call to</span><span>
</span><span id="line-96"></span><span>    </span><span class="hs-comment">-- it.  The overall procedure is as follows:</span><span>
</span><span id="line-97"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-98"></span><span>    </span><span class="hs-comment">-- (1) All empty dimensions in the merge pattern are instantiated</span><span>
</span><span id="line-99"></span><span>    </span><span class="hs-comment">-- with nonrigid size variables.  All explicitly specified</span><span>
</span><span id="line-100"></span><span>    </span><span class="hs-comment">-- dimensions are preserved.</span><span>
</span><span id="line-101"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-102"></span><span>    </span><span class="hs-comment">-- (2) The body of the loop is type-checked.  The result type is</span><span>
</span><span id="line-103"></span><span>    </span><span class="hs-comment">-- combined with the merge pattern type to determine which sizes are</span><span>
</span><span id="line-104"></span><span>    </span><span class="hs-comment">-- variant, and these are turned into size parameters for the merge</span><span>
</span><span id="line-105"></span><span>    </span><span class="hs-comment">-- pattern.</span><span>
</span><span id="line-106"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-107"></span><span>    </span><span class="hs-comment">-- (3) We now conceptually have a function parameter type and return</span><span>
</span><span id="line-108"></span><span>    </span><span class="hs-comment">-- type.  We check that it can be called with the initial merge</span><span>
</span><span id="line-109"></span><span>    </span><span class="hs-comment">-- values as argument.  The result of this is the type of the loop</span><span>
</span><span id="line-110"></span><span>    </span><span class="hs-comment">-- as a whole.</span><span>
</span><span id="line-111"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-112"></span><span>    </span><span class="hs-comment">-- (There is also a convergence loop for inferring uniqueness, but</span><span>
</span><span id="line-113"></span><span>    </span><span class="hs-comment">-- that's orthogonal to the size handling.)</span><span>
</span><span id="line-114"></span><span>
</span><span id="line-115"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684559738"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684559738"><span class="hs-identifier hs-var">merge_t</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684559737"><span class="annot"><span class="annottext">Map VName (DimDecl VName)
</span><a href="#local-6989586621684559737"><span class="hs-identifier hs-var">new_dims_to_initial_dim</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-116"></span><span>      </span><span class="hs-comment">-- dim handling (1)</span><span>
</span><span id="line-117"></span><span>      </span><span class="annot"><span class="annottext">SrcLoc
-&gt; Rigidity
-&gt; Name
-&gt; PatType
-&gt; TermTypeM (PatType, Map VName (DimDecl VName))
forall als.
SrcLoc
-&gt; Rigidity
-&gt; Name
-&gt; TypeBase (DimDecl VName) als
-&gt; TermTypeM
     (TypeBase (DimDecl VName) als, Map VName (DimDecl VName))
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#allDimsFreshInType"><span class="hs-identifier hs-var">allDimsFreshInType</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684559746"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">Rigidity
</span><a href="Language.Futhark.TypeChecker.Unify.html#Nonrigid"><span class="hs-identifier hs-var">Nonrigid</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-string">&quot;loop&quot;</span></span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; TermTypeM (PatType, Map VName (DimDecl VName)))
-&gt; TermTypeM PatType
-&gt; TermTypeM (PatType, Map VName (DimDecl VName))
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; TermTypeM PatType
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#expTypeFully"><span class="hs-identifier hs-var">expTypeFully</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684559744"><span class="hs-identifier hs-var">mergeexp'</span></a></span><span>
</span><span id="line-118"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684559734"><span class="annot"><span class="annottext">new_dims :: [VName]
</span><a href="#local-6989586621684559734"><span class="hs-identifier hs-var hs-var">new_dims</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map VName (DimDecl VName) -&gt; [VName]
forall k a. Map k a -&gt; [k]
</span><span class="hs-identifier hs-var">M.keys</span></span><span> </span><span class="annot"><span class="annottext">Map VName (DimDecl VName)
</span><a href="#local-6989586621684559737"><span class="hs-identifier hs-var">new_dims_to_initial_dim</span></a></span><span>
</span><span id="line-119"></span><span>
</span><span id="line-120"></span><span>    </span><span class="hs-comment">-- dim handling (2)</span><span>
</span><span id="line-121"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684559703"><span class="annot"><span class="annottext">checkLoopReturnSize :: PatBase Info VName
-&gt; Exp -&gt; TermTypeM ([VName], PatBase Info VName)
</span><a href="#local-6989586621684559703"><span class="hs-identifier hs-var hs-var">checkLoopReturnSize</span></a></span></span><span> </span><span id="local-6989586621684559702"><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684559702"><span class="hs-identifier hs-var">mergepat'</span></a></span></span><span> </span><span id="local-6989586621684559701"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684559701"><span class="hs-identifier hs-var">loopbody'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-122"></span><span>          </span><span id="local-6989586621684559700"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684559700"><span class="hs-identifier hs-var">loopbody_t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; TermTypeM PatType
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#expTypeFully"><span class="hs-identifier hs-var">expTypeFully</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684559701"><span class="hs-identifier hs-var">loopbody'</span></a></span><span>
</span><span id="line-123"></span><span>          </span><span id="local-6989586621684559699"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684559699"><span class="hs-identifier hs-var">pat_t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-124"></span><span>            </span><span class="annot"><span class="annottext">SrcLoc
-&gt; Rigidity -&gt; Name -&gt; Set VName -&gt; PatType -&gt; TermTypeM PatType
forall als.
SrcLoc
-&gt; Rigidity
-&gt; Name
-&gt; Set VName
-&gt; TypeBase (DimDecl VName) als
-&gt; TermTypeM (TypeBase (DimDecl VName) als)
</span><a href="Language.Futhark.TypeChecker.Terms.DoLoop.html#someDimsFreshInType"><span class="hs-identifier hs-var">someDimsFreshInType</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684559746"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">Rigidity
</span><a href="Language.Futhark.TypeChecker.Unify.html#Nonrigid"><span class="hs-identifier hs-var">Nonrigid</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-string">&quot;loop&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; Set VName
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">S.fromList</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684559734"><span class="hs-identifier hs-var">new_dims</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-125"></span><span>              </span><span class="annot"><span class="annottext">(PatType -&gt; TermTypeM PatType)
-&gt; TermTypeM PatType -&gt; TermTypeM PatType
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">PatType -&gt; TermTypeM PatType
forall a (m :: * -&gt; *). (Substitutable a, MonadUnify m) =&gt; a -&gt; m a
</span><a href="Language.Futhark.TypeChecker.Unify.html#normTypeFully"><span class="hs-identifier hs-var">normTypeFully</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatBase Info VName -&gt; PatType
</span><a href="Language.Futhark.Prop.html#patternType"><span class="hs-identifier hs-var">patternType</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684559702"><span class="hs-identifier hs-var">mergepat'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-126"></span><span>
</span><span id="line-127"></span><span>          </span><span class="hs-comment">-- We are ignoring the dimensions here, because any mismatches</span><span>
</span><span id="line-128"></span><span>          </span><span class="hs-comment">-- should be turned into fresh size variables.</span><span>
</span><span id="line-129"></span><span>          </span><span class="annot"><span class="annottext">Checking -&gt; TermTypeM () -&gt; TermTypeM ()
forall a. Checking -&gt; TermTypeM a -&gt; TermTypeM a
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#onFailure"><span class="hs-identifier hs-var">onFailure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StructType -&gt; StructType -&gt; Checking
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#CheckingLoopBody"><span class="hs-identifier hs-var">CheckingLoopBody</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatType -&gt; StructType
forall dim as. TypeBase dim as -&gt; TypeBase dim ()
</span><a href="Language.Futhark.Prop.html#toStruct"><span class="hs-identifier hs-var">toStruct</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684559699"><span class="hs-identifier hs-var">pat_t</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatType -&gt; StructType
forall dim as. TypeBase dim as -&gt; TypeBase dim ()
</span><a href="Language.Futhark.Prop.html#toStruct"><span class="hs-identifier hs-var">toStruct</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684559700"><span class="hs-identifier hs-var">loopbody_t</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TermTypeM () -&gt; TermTypeM ()) -&gt; TermTypeM () -&gt; TermTypeM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-130"></span><span>            </span><span class="annot"><span class="annottext">Usage -&gt; StructType -&gt; StructType -&gt; TermTypeM ()
forall (m :: * -&gt; *).
MonadUnify m =&gt;
Usage -&gt; StructType -&gt; StructType -&gt; m ()
</span><a href="Language.Futhark.TypeChecker.Unify.html#unify"><span class="hs-identifier hs-var">unify</span></a></span><span>
</span><span id="line-131"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SrcLoc -&gt; String -&gt; Usage
</span><a href="Language.Futhark.TypeChecker.Unify.html#mkUsage"><span class="hs-identifier hs-var">mkUsage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UncheckedExp -&gt; SrcLoc
forall a. Located a =&gt; a -&gt; SrcLoc
</span><span class="hs-identifier hs-var">srclocOf</span></span><span> </span><span class="annot"><span class="annottext">UncheckedExp
</span><a href="#local-6989586621684559747"><span class="hs-identifier hs-var">loopbody</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;matching loop body to loop pattern&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-132"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatType -&gt; StructType
forall dim as. TypeBase dim as -&gt; TypeBase dim ()
</span><a href="Language.Futhark.Prop.html#toStruct"><span class="hs-identifier hs-var">toStruct</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684559699"><span class="hs-identifier hs-var">pat_t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-133"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatType -&gt; StructType
forall dim as. TypeBase dim as -&gt; TypeBase dim ()
</span><a href="Language.Futhark.Prop.html#toStruct"><span class="hs-identifier hs-var">toStruct</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684559700"><span class="hs-identifier hs-var">loopbody_t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-134"></span><span>
</span><span id="line-135"></span><span>          </span><span class="hs-comment">-- Figure out which of the 'new_dims' dimensions are variant.</span><span>
</span><span id="line-136"></span><span>          </span><span class="hs-comment">-- This works because we know that each dimension from</span><span>
</span><span id="line-137"></span><span>          </span><span class="hs-comment">-- new_dims in the pattern is unique and distinct.</span><span>
</span><span id="line-138"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684559672"><span class="annot"><span class="annottext">onDims :: p -&gt; DimDecl VName -&gt; DimDecl VName -&gt; f (DimDecl VName)
</span><a href="#local-6989586621684559672"><span class="hs-identifier hs-var hs-var">onDims</span></a></span></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684559671"><span class="annot"><span class="annottext">DimDecl VName
</span><a href="#local-6989586621684559671"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621684559670"><span class="annot"><span class="annottext">DimDecl VName
</span><a href="#local-6989586621684559670"><span class="hs-identifier hs-var">y</span></a></span></span><span>
</span><span id="line-139"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">DimDecl VName
</span><a href="#local-6989586621684559671"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">DimDecl VName -&gt; DimDecl VName -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">DimDecl VName
</span><a href="#local-6989586621684559670"><span class="hs-identifier hs-var">y</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DimDecl VName -&gt; f (DimDecl VName)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">DimDecl VName
</span><a href="#local-6989586621684559671"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-140"></span><span>              </span><span class="annot"><a href="#local-6989586621684559672"><span class="hs-identifier hs-var">onDims</span></a></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#NamedDim"><span class="hs-identifier hs-type">NamedDim</span></a></span><span> </span><span id="local-6989586621684559669"><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684559669"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684559668"><span class="annot"><span class="annottext">DimDecl VName
</span><a href="#local-6989586621684559668"><span class="hs-identifier hs-var">d</span></a></span></span><span>
</span><span id="line-141"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">QualName VName -&gt; VName
forall vn. QualName vn -&gt; vn
</span><a href="Language.Futhark.Syntax.html#qualLeaf"><span class="hs-identifier hs-var hs-var">qualLeaf</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684559669"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [VName] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684559734"><span class="hs-identifier hs-var">new_dims</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-142"></span><span>                  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Map VName (DimDecl VName) -&gt; Maybe (DimDecl VName)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QualName VName -&gt; VName
forall vn. QualName vn -&gt; vn
</span><a href="Language.Futhark.Syntax.html#qualLeaf"><span class="hs-identifier hs-var hs-var">qualLeaf</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684559669"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map VName (DimDecl VName)
</span><a href="#local-6989586621684559737"><span class="hs-identifier hs-var">new_dims_to_initial_dim</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-143"></span><span>                    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684559666"><span class="annot"><span class="annottext">DimDecl VName
</span><a href="#local-6989586621684559666"><span class="hs-identifier hs-var">d'</span></a></span></span><span>
</span><span id="line-144"></span><span>                      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">DimDecl VName
</span><a href="#local-6989586621684559666"><span class="hs-identifier hs-var">d'</span></a></span><span> </span><span class="annot"><span class="annottext">DimDecl VName -&gt; DimDecl VName -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">DimDecl VName
</span><a href="#local-6989586621684559668"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-145"></span><span>                        </span><span class="annot"><span class="annottext">(p (Map VName (Subst t)) [VName]
 -&gt; p (Map VName (Subst t)) [VName])
-&gt; f ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((p (Map VName (Subst t)) [VName]
  -&gt; p (Map VName (Subst t)) [VName])
 -&gt; f ())
-&gt; (p (Map VName (Subst t)) [VName]
    -&gt; p (Map VName (Subst t)) [VName])
-&gt; f ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Map VName (Subst t) -&gt; Map VName (Subst t))
-&gt; p (Map VName (Subst t)) [VName]
-&gt; p (Map VName (Subst t)) [VName]
forall (p :: * -&gt; * -&gt; *) a b c.
Bifunctor p =&gt;
(a -&gt; b) -&gt; p a c -&gt; p b c
</span><span class="hs-identifier hs-var">first</span></span><span> </span><span class="annot"><span class="annottext">((Map VName (Subst t) -&gt; Map VName (Subst t))
 -&gt; p (Map VName (Subst t)) [VName]
 -&gt; p (Map VName (Subst t)) [VName])
-&gt; (Map VName (Subst t) -&gt; Map VName (Subst t))
-&gt; p (Map VName (Subst t)) [VName]
-&gt; p (Map VName (Subst t)) [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Subst t -&gt; Map VName (Subst t) -&gt; Map VName (Subst t)
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QualName VName -&gt; VName
forall vn. QualName vn -&gt; vn
</span><a href="Language.Futhark.Syntax.html#qualLeaf"><span class="hs-identifier hs-var hs-var">qualLeaf</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684559669"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DimDecl VName -&gt; Subst t
forall t. DimDecl VName -&gt; Subst t
</span><a href="Language.Futhark.TypeChecker.Types.html#SizeSubst"><span class="hs-identifier hs-var">SizeSubst</span></a></span><span> </span><span class="annot"><span class="annottext">DimDecl VName
</span><a href="#local-6989586621684559668"><span class="hs-identifier hs-var">d</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-146"></span><span>                    </span><span class="annot"><span class="annottext">Maybe (DimDecl VName)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-147"></span><span>                      </span><span class="annot"><span class="annottext">(p (Map VName (Subst t)) [VName]
 -&gt; p (Map VName (Subst t)) [VName])
-&gt; f ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((p (Map VName (Subst t)) [VName]
  -&gt; p (Map VName (Subst t)) [VName])
 -&gt; f ())
-&gt; (p (Map VName (Subst t)) [VName]
    -&gt; p (Map VName (Subst t)) [VName])
-&gt; f ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; [VName])
-&gt; p (Map VName (Subst t)) [VName]
-&gt; p (Map VName (Subst t)) [VName]
forall (p :: * -&gt; * -&gt; *) b c a.
Bifunctor p =&gt;
(b -&gt; c) -&gt; p a b -&gt; p a c
</span><span class="hs-identifier hs-var">second</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QualName VName -&gt; VName
forall vn. QualName vn -&gt; vn
</span><a href="Language.Futhark.Syntax.html#qualLeaf"><span class="hs-identifier hs-var hs-var">qualLeaf</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684559669"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [VName] -&gt; [VName]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="hs-special">)</span><span>
</span><span id="line-148"></span><span>                  </span><span class="annot"><span class="annottext">DimDecl VName -&gt; f (DimDecl VName)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(DimDecl VName -&gt; f (DimDecl VName))
-&gt; DimDecl VName -&gt; f (DimDecl VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">QualName VName -&gt; DimDecl VName
forall vn. QualName vn -&gt; DimDecl vn
</span><a href="Language.Futhark.Syntax.html#NamedDim"><span class="hs-identifier hs-var">NamedDim</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684559669"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-149"></span><span>              </span><span class="annot"><a href="#local-6989586621684559672"><span class="hs-identifier hs-var">onDims</span></a></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684559663"><span class="annot"><span class="annottext">DimDecl VName
</span><a href="#local-6989586621684559663"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="annot"><span class="annottext">DimDecl VName
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DimDecl VName -&gt; f (DimDecl VName)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">DimDecl VName
</span><a href="#local-6989586621684559663"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-150"></span><span>          </span><span id="local-6989586621684559662"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684559662"><span class="hs-identifier hs-var">loopbody_t'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PatType -&gt; TermTypeM PatType
forall a (m :: * -&gt; *). (Substitutable a, MonadUnify m) =&gt; a -&gt; m a
</span><a href="Language.Futhark.TypeChecker.Unify.html#normTypeFully"><span class="hs-identifier hs-var">normTypeFully</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684559700"><span class="hs-identifier hs-var">loopbody_t</span></a></span><span>
</span><span id="line-151"></span><span>          </span><span id="local-6989586621684559661"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684559661"><span class="hs-identifier hs-var">merge_t'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PatType -&gt; TermTypeM PatType
forall a (m :: * -&gt; *). (Substitutable a, MonadUnify m) =&gt; a -&gt; m a
</span><a href="Language.Futhark.TypeChecker.Unify.html#normTypeFully"><span class="hs-identifier hs-var">normTypeFully</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684559738"><span class="hs-identifier hs-var">merge_t</span></a></span><span>
</span><span id="line-152"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684559646"><span class="annot"><span class="annottext">Map VName (Subst t)
</span><a href="#local-6989586621684559646"><span class="hs-identifier hs-var">init_substs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684559645"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684559645"><span class="hs-identifier hs-var">sparams</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-153"></span><span>                </span><span class="annot"><span class="annottext">State (Map VName (Subst t), [VName]) PatType
-&gt; (Map VName (Subst t), [VName]) -&gt; (Map VName (Subst t), [VName])
forall s a. State s a -&gt; s -&gt; s
</span><span class="hs-identifier hs-var">execState</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">([VName]
 -&gt; DimDecl VName
 -&gt; DimDecl VName
 -&gt; StateT (Map VName (Subst t), [VName]) Identity (DimDecl VName))
-&gt; PatType
-&gt; PatType
-&gt; State (Map VName (Subst t), [VName]) PatType
forall as (m :: * -&gt; *) d1 d2.
(Monoid as, Monad m) =&gt;
([VName] -&gt; d1 -&gt; d2 -&gt; m d1)
-&gt; TypeBase d1 as -&gt; TypeBase d2 as -&gt; m (TypeBase d1 as)
</span><a href="Language.Futhark.Prop.html#matchDims"><span class="hs-identifier hs-var">matchDims</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
-&gt; DimDecl VName
-&gt; DimDecl VName
-&gt; StateT (Map VName (Subst t), [VName]) Identity (DimDecl VName)
forall {f :: * -&gt; *} {p :: * -&gt; * -&gt; *} {t} {p}.
(Bifunctor p, MonadState (p (Map VName (Subst t)) [VName]) f) =&gt;
p -&gt; DimDecl VName -&gt; DimDecl VName -&gt; f (DimDecl VName)
</span><a href="#local-6989586621684559672"><span class="hs-identifier hs-var">onDims</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684559661"><span class="hs-identifier hs-var">merge_t'</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684559662"><span class="hs-identifier hs-var">loopbody_t'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Map VName (Subst t), [VName])
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-154"></span><span>
</span><span id="line-155"></span><span>          </span><span class="hs-comment">-- Make sure that any of new_dims that are invariant will be</span><span>
</span><span id="line-156"></span><span>          </span><span class="hs-comment">-- replaced with the invariant size in the loop body.  Failure</span><span>
</span><span id="line-157"></span><span>          </span><span class="hs-comment">-- to do this can cause type annotations to still refer to</span><span>
</span><span id="line-158"></span><span>          </span><span class="hs-comment">-- new_dims.</span><span>
</span><span id="line-159"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684559641"><span class="annot"><span class="annottext">dimToInit :: (VName, Subst t) -&gt; TermTypeM ()
</span><a href="#local-6989586621684559641"><span class="hs-identifier hs-var hs-var">dimToInit</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684559640"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684559640"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.TypeChecker.Types.html#SizeSubst"><span class="hs-identifier hs-type">SizeSubst</span></a></span><span> </span><span id="local-6989586621684559639"><span class="annot"><span class="annottext">DimDecl VName
</span><a href="#local-6989586621684559639"><span class="hs-identifier hs-var">d</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-160"></span><span>                </span><span class="annot"><span class="annottext">VName -&gt; Constraint -&gt; TermTypeM ()
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#constrain"><span class="hs-identifier hs-var">constrain</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684559640"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">(Constraint -&gt; TermTypeM ()) -&gt; Constraint -&gt; TermTypeM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (DimDecl VName) -&gt; Usage -&gt; Constraint
</span><a href="Language.Futhark.TypeChecker.Unify.html#Size"><span class="hs-identifier hs-var">Size</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DimDecl VName -&gt; Maybe (DimDecl VName)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">DimDecl VName
</span><a href="#local-6989586621684559639"><span class="hs-identifier hs-var">d</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SrcLoc -&gt; String -&gt; Usage
</span><a href="Language.Futhark.TypeChecker.Unify.html#mkUsage"><span class="hs-identifier hs-var">mkUsage</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684559746"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;size of loop parameter&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-161"></span><span>              </span><span class="annot"><a href="#local-6989586621684559641"><span class="hs-identifier hs-var">dimToInit</span></a></span><span> </span><span class="annot"><span class="annottext">(VName, Subst t)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-162"></span><span>                </span><span class="annot"><span class="annottext">() -&gt; TermTypeM ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-163"></span><span>          </span><span class="annot"><span class="annottext">((VName, Subst Any) -&gt; TermTypeM ())
-&gt; [(VName, Subst Any)] -&gt; TermTypeM ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="annot"><span class="annottext">(VName, Subst Any) -&gt; TermTypeM ()
forall {t}. (VName, Subst t) -&gt; TermTypeM ()
</span><a href="#local-6989586621684559641"><span class="hs-identifier hs-var">dimToInit</span></a></span><span> </span><span class="annot"><span class="annottext">([(VName, Subst Any)] -&gt; TermTypeM ())
-&gt; [(VName, Subst Any)] -&gt; TermTypeM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Map VName (Subst Any) -&gt; [(VName, Subst Any)]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">M.toList</span></span><span> </span><span class="annot"><span class="annottext">Map VName (Subst Any)
forall {t}. Map VName (Subst t)
</span><a href="#local-6989586621684559646"><span class="hs-identifier hs-var">init_substs</span></a></span><span>
</span><span id="line-164"></span><span>
</span><span id="line-165"></span><span>          </span><span id="local-6989586621684559634"><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684559634"><span class="hs-identifier hs-var">mergepat''</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TypeSubs -&gt; PatBase Info VName -&gt; PatBase Info VName
forall a. Substitutable a =&gt; TypeSubs -&gt; a -&gt; a
</span><a href="Language.Futhark.TypeChecker.Types.html#applySubst"><span class="hs-identifier hs-var">applySubst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
-&gt; Map VName (Subst StructRetType) -&gt; Maybe (Subst StructRetType)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-operator hs-var">`M.lookup`</span></span><span> </span><span class="annot"><span class="annottext">Map VName (Subst StructRetType)
forall {t}. Map VName (Subst t)
</span><a href="#local-6989586621684559646"><span class="hs-identifier hs-var">init_substs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(PatBase Info VName -&gt; PatBase Info VName)
-&gt; TermTypeM (PatBase Info VName) -&gt; TermTypeM (PatBase Info VName)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; TermTypeM (PatBase Info VName)
forall e. ASTMappable e =&gt; e -&gt; TermTypeM e
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#updateTypes"><span class="hs-identifier hs-var">updateTypes</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684559702"><span class="hs-identifier hs-var">mergepat'</span></a></span><span>
</span><span id="line-166"></span><span>
</span><span id="line-167"></span><span>          </span><span class="annot"><span class="annottext">([VName], PatBase Info VName)
-&gt; TermTypeM ([VName], PatBase Info VName)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; [VName]
forall a. Ord a =&gt; [a] -&gt; [a]
</span><a href="Futhark.Util.html#nubOrd"><span class="hs-identifier hs-var">nubOrd</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684559645"><span class="hs-identifier hs-var">sparams</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684559634"><span class="hs-identifier hs-var">mergepat''</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-168"></span><span>
</span><span id="line-169"></span><span>    </span><span class="hs-comment">-- First we do a basic check of the loop body to figure out which of</span><span>
</span><span id="line-170"></span><span>    </span><span class="hs-comment">-- the merge parameters are being consumed.  For this, we first need</span><span>
</span><span id="line-171"></span><span>    </span><span class="hs-comment">-- to check the merge pattern, which requires the (initial) merge</span><span>
</span><span id="line-172"></span><span>    </span><span class="hs-comment">-- expression.</span><span>
</span><span id="line-173"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-174"></span><span>    </span><span class="hs-comment">-- Play a little with occurences to ensure it does not look like</span><span>
</span><span id="line-175"></span><span>    </span><span class="hs-comment">-- none of the merge variables are being used.</span><span>
</span><span id="line-176"></span><span>    </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621684559631"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684559631"><span class="hs-identifier hs-var">sparams</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684559630"><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684559630"><span class="hs-identifier hs-var">mergepat'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684559629"><span class="annot"><span class="annottext">LoopFormBase Info VName
</span><a href="#local-6989586621684559629"><span class="hs-identifier hs-var">form'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684559628"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684559628"><span class="hs-identifier hs-var">loopbody'</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621684559627"><span class="annot"><span class="annottext">Occurrences
</span><a href="#local-6989586621684559627"><span class="hs-identifier hs-var">bodyflow</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-177"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">LoopFormBase NoInfo Name
</span><a href="#local-6989586621684559748"><span class="hs-identifier hs-var">form</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-178"></span><span>        </span><span class="annot"><a href="Language.Futhark.Syntax.html#For"><span class="hs-identifier hs-type">For</span></a></span><span> </span><span id="local-6989586621684559625"><span class="annot"><span class="annottext">IdentBase NoInfo Name
</span><a href="#local-6989586621684559625"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621684559624"><span class="annot"><span class="annottext">UncheckedExp
</span><a href="#local-6989586621684559624"><span class="hs-identifier hs-var">uboundexp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-179"></span><span>          </span><span id="local-6989586621684559623"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684559623"><span class="hs-identifier hs-var">uboundexp'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-180"></span><span>            </span><span class="annot"><span class="annottext">String -&gt; [PrimType] -&gt; Exp -&gt; TermTypeM Exp
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#require"><span class="hs-identifier hs-var">require</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;being the bound in a 'for' loop&quot;</span></span><span> </span><span class="annot"><span class="annottext">[PrimType]
</span><a href="Language.Futhark.TypeChecker.Monad.html#anySignedType"><span class="hs-identifier hs-var">anySignedType</span></a></span><span>
</span><span id="line-181"></span><span>              </span><span class="annot"><span class="annottext">(Exp -&gt; TermTypeM Exp) -&gt; TermTypeM Exp -&gt; TermTypeM Exp
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">UncheckedExp -&gt; TermTypeM Exp
</span><a href="#local-6989586621684559751"><span class="hs-identifier hs-var">checkExp</span></a></span><span> </span><span class="annot"><span class="annottext">UncheckedExp
</span><a href="#local-6989586621684559624"><span class="hs-identifier hs-var">uboundexp</span></a></span><span>
</span><span id="line-182"></span><span>          </span><span id="local-6989586621684559620"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684559620"><span class="hs-identifier hs-var">bound_t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; TermTypeM PatType
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#expTypeFully"><span class="hs-identifier hs-var">expTypeFully</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684559623"><span class="hs-identifier hs-var">uboundexp'</span></a></span><span>
</span><span id="line-183"></span><span>          </span><span class="annot"><span class="annottext">IdentBase NoInfo Name
-&gt; PatType
-&gt; (Ident
    -&gt; TermTypeM
         (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
          Occurrences))
-&gt; TermTypeM
     (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
      Occurrences)
forall a.
IdentBase NoInfo Name
-&gt; PatType -&gt; (Ident -&gt; TermTypeM a) -&gt; TermTypeM a
</span><a href="Language.Futhark.TypeChecker.Terms.Pat.html#bindingIdent"><span class="hs-identifier hs-var">bindingIdent</span></a></span><span> </span><span class="annot"><span class="annottext">IdentBase NoInfo Name
</span><a href="#local-6989586621684559625"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684559620"><span class="hs-identifier hs-var">bound_t</span></a></span><span> </span><span class="annot"><span class="annottext">((Ident
  -&gt; TermTypeM
       (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
        Occurrences))
 -&gt; TermTypeM
      (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
       Occurrences))
-&gt; (Ident
    -&gt; TermTypeM
         (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
          Occurrences))
-&gt; TermTypeM
     (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
      Occurrences)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684559618"><span class="annot"><span class="annottext">Ident
</span><a href="#local-6989586621684559618"><span class="hs-identifier hs-var">i'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-184"></span><span>            </span><span class="annot"><span class="annottext">TermTypeM
  (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
   Occurrences)
-&gt; TermTypeM
     (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
      Occurrences)
forall a. TermTypeM a -&gt; TermTypeM a
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#noUnique"><span class="hs-identifier hs-var">noUnique</span></a></span><span> </span><span class="annot"><span class="annottext">(TermTypeM
   (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
    Occurrences)
 -&gt; TermTypeM
      (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
       Occurrences))
-&gt; ((PatBase Info VName
     -&gt; TermTypeM
          (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
           Occurrences))
    -&gt; TermTypeM
         (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
          Occurrences))
-&gt; (PatBase Info VName
    -&gt; TermTypeM
         (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
          Occurrences))
-&gt; TermTypeM
     (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
      Occurrences)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[SizeBinder VName]
-&gt; UncheckedPat
-&gt; InferredType
-&gt; (PatBase Info VName
    -&gt; TermTypeM
         (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
          Occurrences))
-&gt; TermTypeM
     (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
      Occurrences)
forall a.
[SizeBinder VName]
-&gt; UncheckedPat
-&gt; InferredType
-&gt; (PatBase Info VName -&gt; TermTypeM a)
-&gt; TermTypeM a
</span><a href="Language.Futhark.TypeChecker.Terms.Pat.html#bindingPat"><span class="hs-identifier hs-var">bindingPat</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">UncheckedPat
</span><a href="#local-6989586621684559750"><span class="hs-identifier hs-var">mergepat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatType -&gt; InferredType
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Ascribed"><span class="hs-identifier hs-var">Ascribed</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684559738"><span class="hs-identifier hs-var">merge_t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((PatBase Info VName
  -&gt; TermTypeM
       (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
        Occurrences))
 -&gt; TermTypeM
      (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
       Occurrences))
-&gt; (PatBase Info VName
    -&gt; TermTypeM
         (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
          Occurrences))
-&gt; TermTypeM
     (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
      Occurrences)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-185"></span><span>              </span><span class="hs-glyph">\</span><span id="local-6989586621684559613"><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684559613"><span class="hs-identifier hs-var">mergepat'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TermTypeM
  (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
   Occurrences)
-&gt; TermTypeM
     (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
      Occurrences)
forall a. TermTypeM a -&gt; TermTypeM a
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#onlySelfAliasing"><span class="hs-identifier hs-var">onlySelfAliasing</span></a></span><span> </span><span class="annot"><span class="annottext">(TermTypeM
   (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
    Occurrences)
 -&gt; TermTypeM
      (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
       Occurrences))
-&gt; (TermTypeM
      ([VName], PatBase Info VName, LoopFormBase Info VName, Exp)
    -&gt; TermTypeM
         (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
          Occurrences))
-&gt; TermTypeM
     ([VName], PatBase Info VName, LoopFormBase Info VName, Exp)
-&gt; TermTypeM
     (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
      Occurrences)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TermTypeM
  ([VName], PatBase Info VName, LoopFormBase Info VName, Exp)
-&gt; TermTypeM
     (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
      Occurrences)
forall a. TermTypeM a -&gt; TermTypeM (a, Occurrences)
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#tapOccurrences"><span class="hs-identifier hs-var">tapOccurrences</span></a></span><span> </span><span class="annot"><span class="annottext">(TermTypeM
   ([VName], PatBase Info VName, LoopFormBase Info VName, Exp)
 -&gt; TermTypeM
      (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
       Occurrences))
-&gt; TermTypeM
     ([VName], PatBase Info VName, LoopFormBase Info VName, Exp)
-&gt; TermTypeM
     (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
      Occurrences)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-186"></span><span>                </span><span id="local-6989586621684559610"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684559610"><span class="hs-identifier hs-var">loopbody'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TermTypeM Exp -&gt; TermTypeM Exp
forall a. TermTypeM a -&gt; TermTypeM a
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#noSizeEscape"><span class="hs-identifier hs-var">noSizeEscape</span></a></span><span> </span><span class="annot"><span class="annottext">(TermTypeM Exp -&gt; TermTypeM Exp) -&gt; TermTypeM Exp -&gt; TermTypeM Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">UncheckedExp -&gt; TermTypeM Exp
</span><a href="#local-6989586621684559751"><span class="hs-identifier hs-var">checkExp</span></a></span><span> </span><span class="annot"><span class="annottext">UncheckedExp
</span><a href="#local-6989586621684559747"><span class="hs-identifier hs-var">loopbody</span></a></span><span>
</span><span id="line-187"></span><span>                </span><span class="hs-special">(</span><span id="local-6989586621684559608"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684559608"><span class="hs-identifier hs-var">sparams</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684559607"><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684559607"><span class="hs-identifier hs-var">mergepat''</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
-&gt; Exp -&gt; TermTypeM ([VName], PatBase Info VName)
</span><a href="#local-6989586621684559703"><span class="hs-identifier hs-var">checkLoopReturnSize</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684559613"><span class="hs-identifier hs-var">mergepat'</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684559610"><span class="hs-identifier hs-var">loopbody'</span></a></span><span>
</span><span id="line-188"></span><span>                </span><span class="annot"><span class="annottext">([VName], PatBase Info VName, LoopFormBase Info VName, Exp)
-&gt; TermTypeM
     ([VName], PatBase Info VName, LoopFormBase Info VName, Exp)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-189"></span><span>                  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684559608"><span class="hs-identifier hs-var">sparams</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-190"></span><span>                    </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684559607"><span class="hs-identifier hs-var">mergepat''</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-191"></span><span>                    </span><span class="annot"><span class="annottext">Ident -&gt; Exp -&gt; LoopFormBase Info VName
forall (f :: * -&gt; *) vn.
IdentBase f vn -&gt; ExpBase f vn -&gt; LoopFormBase f vn
</span><a href="Language.Futhark.Syntax.html#For"><span class="hs-identifier hs-var">For</span></a></span><span> </span><span class="annot"><span class="annottext">Ident
</span><a href="#local-6989586621684559618"><span class="hs-identifier hs-var">i'</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684559623"><span class="hs-identifier hs-var">uboundexp'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-192"></span><span>                    </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684559610"><span class="hs-identifier hs-var">loopbody'</span></a></span><span>
</span><span id="line-193"></span><span>                  </span><span class="hs-special">)</span><span>
</span><span id="line-194"></span><span>        </span><span class="annot"><a href="Language.Futhark.Syntax.html#ForIn"><span class="hs-identifier hs-type">ForIn</span></a></span><span> </span><span id="local-6989586621684559605"><span class="annot"><span class="annottext">UncheckedPat
</span><a href="#local-6989586621684559605"><span class="hs-identifier hs-var">xpat</span></a></span></span><span> </span><span id="local-6989586621684559604"><span class="annot"><span class="annottext">UncheckedExp
</span><a href="#local-6989586621684559604"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-195"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621684559603"><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684559603"><span class="hs-identifier hs-var">arr_t</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StructType
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SrcLoc -&gt; Name -&gt; Int -&gt; TermTypeM (StructType, StructType)
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#newArrayType"><span class="hs-identifier hs-var">newArrayType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UncheckedExp -&gt; SrcLoc
forall a. Located a =&gt; a -&gt; SrcLoc
</span><span class="hs-identifier hs-var">srclocOf</span></span><span> </span><span class="annot"><span class="annottext">UncheckedExp
</span><a href="#local-6989586621684559604"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-string">&quot;e&quot;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-196"></span><span>          </span><span id="local-6989586621684559601"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684559601"><span class="hs-identifier hs-var">e'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; StructType -&gt; Exp -&gt; TermTypeM Exp
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#unifies"><span class="hs-identifier hs-var">unifies</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;being iterated in a 'for-in' loop&quot;</span></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684559603"><span class="hs-identifier hs-var">arr_t</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; TermTypeM Exp) -&gt; TermTypeM Exp -&gt; TermTypeM Exp
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">UncheckedExp -&gt; TermTypeM Exp
</span><a href="#local-6989586621684559751"><span class="hs-identifier hs-var">checkExp</span></a></span><span> </span><span class="annot"><span class="annottext">UncheckedExp
</span><a href="#local-6989586621684559604"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-197"></span><span>          </span><span id="local-6989586621684559599"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684559599"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; TermTypeM PatType
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#expTypeFully"><span class="hs-identifier hs-var">expTypeFully</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684559601"><span class="hs-identifier hs-var">e'</span></a></span><span>
</span><span id="line-198"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684559599"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-199"></span><span>            </span><span class="annot"><span class="annottext">PatType
</span><span class="hs-identifier">_</span></span><span>
</span><span id="line-200"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684559598"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684559598"><span class="hs-identifier hs-var">t'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; PatType -&gt; Maybe PatType
forall dim as. Int -&gt; TypeBase dim as -&gt; Maybe (TypeBase dim as)
</span><a href="Language.Futhark.Prop.html#peelArray"><span class="hs-identifier hs-var">peelArray</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684559599"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-201"></span><span>                </span><span class="annot"><span class="annottext">[SizeBinder VName]
-&gt; UncheckedPat
-&gt; InferredType
-&gt; (PatBase Info VName
    -&gt; TermTypeM
         (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
          Occurrences))
-&gt; TermTypeM
     (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
      Occurrences)
forall a.
[SizeBinder VName]
-&gt; UncheckedPat
-&gt; InferredType
-&gt; (PatBase Info VName -&gt; TermTypeM a)
-&gt; TermTypeM a
</span><a href="Language.Futhark.TypeChecker.Terms.Pat.html#bindingPat"><span class="hs-identifier hs-var">bindingPat</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">UncheckedPat
</span><a href="#local-6989586621684559605"><span class="hs-identifier hs-var">xpat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatType -&gt; InferredType
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Ascribed"><span class="hs-identifier hs-var">Ascribed</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684559598"><span class="hs-identifier hs-var">t'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((PatBase Info VName
  -&gt; TermTypeM
       (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
        Occurrences))
 -&gt; TermTypeM
      (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
       Occurrences))
-&gt; (PatBase Info VName
    -&gt; TermTypeM
         (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
          Occurrences))
-&gt; TermTypeM
     (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
      Occurrences)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684559596"><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684559596"><span class="hs-identifier hs-var">xpat'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-202"></span><span>                  </span><span class="annot"><span class="annottext">TermTypeM
  (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
   Occurrences)
-&gt; TermTypeM
     (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
      Occurrences)
forall a. TermTypeM a -&gt; TermTypeM a
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#noUnique"><span class="hs-identifier hs-var">noUnique</span></a></span><span> </span><span class="annot"><span class="annottext">(TermTypeM
   (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
    Occurrences)
 -&gt; TermTypeM
      (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
       Occurrences))
-&gt; ((PatBase Info VName
     -&gt; TermTypeM
          (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
           Occurrences))
    -&gt; TermTypeM
         (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
          Occurrences))
-&gt; (PatBase Info VName
    -&gt; TermTypeM
         (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
          Occurrences))
-&gt; TermTypeM
     (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
      Occurrences)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[SizeBinder VName]
-&gt; UncheckedPat
-&gt; InferredType
-&gt; (PatBase Info VName
    -&gt; TermTypeM
         (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
          Occurrences))
-&gt; TermTypeM
     (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
      Occurrences)
forall a.
[SizeBinder VName]
-&gt; UncheckedPat
-&gt; InferredType
-&gt; (PatBase Info VName -&gt; TermTypeM a)
-&gt; TermTypeM a
</span><a href="Language.Futhark.TypeChecker.Terms.Pat.html#bindingPat"><span class="hs-identifier hs-var">bindingPat</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">UncheckedPat
</span><a href="#local-6989586621684559750"><span class="hs-identifier hs-var">mergepat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatType -&gt; InferredType
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Ascribed"><span class="hs-identifier hs-var">Ascribed</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684559738"><span class="hs-identifier hs-var">merge_t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((PatBase Info VName
  -&gt; TermTypeM
       (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
        Occurrences))
 -&gt; TermTypeM
      (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
       Occurrences))
-&gt; (PatBase Info VName
    -&gt; TermTypeM
         (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
          Occurrences))
-&gt; TermTypeM
     (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
      Occurrences)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-203"></span><span>                    </span><span class="hs-glyph">\</span><span id="local-6989586621684559595"><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684559595"><span class="hs-identifier hs-var">mergepat'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TermTypeM
  (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
   Occurrences)
-&gt; TermTypeM
     (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
      Occurrences)
forall a. TermTypeM a -&gt; TermTypeM a
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#onlySelfAliasing"><span class="hs-identifier hs-var">onlySelfAliasing</span></a></span><span> </span><span class="annot"><span class="annottext">(TermTypeM
   (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
    Occurrences)
 -&gt; TermTypeM
      (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
       Occurrences))
-&gt; (TermTypeM
      ([VName], PatBase Info VName, LoopFormBase Info VName, Exp)
    -&gt; TermTypeM
         (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
          Occurrences))
-&gt; TermTypeM
     ([VName], PatBase Info VName, LoopFormBase Info VName, Exp)
-&gt; TermTypeM
     (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
      Occurrences)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TermTypeM
  ([VName], PatBase Info VName, LoopFormBase Info VName, Exp)
-&gt; TermTypeM
     (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
      Occurrences)
forall a. TermTypeM a -&gt; TermTypeM (a, Occurrences)
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#tapOccurrences"><span class="hs-identifier hs-var">tapOccurrences</span></a></span><span> </span><span class="annot"><span class="annottext">(TermTypeM
   ([VName], PatBase Info VName, LoopFormBase Info VName, Exp)
 -&gt; TermTypeM
      (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
       Occurrences))
-&gt; TermTypeM
     ([VName], PatBase Info VName, LoopFormBase Info VName, Exp)
-&gt; TermTypeM
     (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
      Occurrences)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-204"></span><span>                      </span><span id="local-6989586621684559594"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684559594"><span class="hs-identifier hs-var">loopbody'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TermTypeM Exp -&gt; TermTypeM Exp
forall a. TermTypeM a -&gt; TermTypeM a
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#noSizeEscape"><span class="hs-identifier hs-var">noSizeEscape</span></a></span><span> </span><span class="annot"><span class="annottext">(TermTypeM Exp -&gt; TermTypeM Exp) -&gt; TermTypeM Exp -&gt; TermTypeM Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">UncheckedExp -&gt; TermTypeM Exp
</span><a href="#local-6989586621684559751"><span class="hs-identifier hs-var">checkExp</span></a></span><span> </span><span class="annot"><span class="annottext">UncheckedExp
</span><a href="#local-6989586621684559747"><span class="hs-identifier hs-var">loopbody</span></a></span><span>
</span><span id="line-205"></span><span>                      </span><span class="hs-special">(</span><span id="local-6989586621684559593"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684559593"><span class="hs-identifier hs-var">sparams</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684559592"><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684559592"><span class="hs-identifier hs-var">mergepat''</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
-&gt; Exp -&gt; TermTypeM ([VName], PatBase Info VName)
</span><a href="#local-6989586621684559703"><span class="hs-identifier hs-var">checkLoopReturnSize</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684559595"><span class="hs-identifier hs-var">mergepat'</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684559594"><span class="hs-identifier hs-var">loopbody'</span></a></span><span>
</span><span id="line-206"></span><span>                      </span><span class="annot"><span class="annottext">([VName], PatBase Info VName, LoopFormBase Info VName, Exp)
-&gt; TermTypeM
     ([VName], PatBase Info VName, LoopFormBase Info VName, Exp)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-207"></span><span>                        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684559593"><span class="hs-identifier hs-var">sparams</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-208"></span><span>                          </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684559592"><span class="hs-identifier hs-var">mergepat''</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-209"></span><span>                          </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; Exp -&gt; LoopFormBase Info VName
forall (f :: * -&gt; *) vn.
PatBase f vn -&gt; ExpBase f vn -&gt; LoopFormBase f vn
</span><a href="Language.Futhark.Syntax.html#ForIn"><span class="hs-identifier hs-var">ForIn</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684559596"><span class="hs-identifier hs-var">xpat'</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684559601"><span class="hs-identifier hs-var">e'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-210"></span><span>                          </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684559594"><span class="hs-identifier hs-var">loopbody'</span></a></span><span>
</span><span id="line-211"></span><span>                        </span><span class="hs-special">)</span><span>
</span><span id="line-212"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-213"></span><span>                </span><span class="annot"><span class="annottext">SrcLoc
-&gt; Notes
-&gt; Doc
-&gt; TermTypeM
     (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
      Occurrences)
forall (m :: * -&gt; *) loc a.
(MonadTypeChecker m, Located loc) =&gt;
loc -&gt; Notes -&gt; Doc -&gt; m a
</span><a href="Language.Futhark.TypeChecker.Monad.html#typeError"><span class="hs-identifier hs-var">typeError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UncheckedExp -&gt; SrcLoc
forall a. Located a =&gt; a -&gt; SrcLoc
</span><span class="hs-identifier hs-var">srclocOf</span></span><span> </span><span class="annot"><span class="annottext">UncheckedExp
</span><a href="#local-6989586621684559604"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Notes
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">(Doc
 -&gt; TermTypeM
      (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
       Occurrences))
-&gt; Doc
-&gt; TermTypeM
     (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
      Occurrences)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-214"></span><span>                  </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Iteratee of a for-in loop must be an array, but expression has type&quot;</span></span><span>
</span><span id="line-215"></span><span>                    </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">PatType -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684559599"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-216"></span><span>        </span><span class="annot"><a href="Language.Futhark.Syntax.html#While"><span class="hs-identifier hs-type">While</span></a></span><span> </span><span id="local-6989586621684559587"><span class="annot"><span class="annottext">UncheckedExp
</span><a href="#local-6989586621684559587"><span class="hs-identifier hs-var">cond</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-217"></span><span>          </span><span class="annot"><span class="annottext">TermTypeM
  (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
   Occurrences)
-&gt; TermTypeM
     (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
      Occurrences)
forall a. TermTypeM a -&gt; TermTypeM a
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#noUnique"><span class="hs-identifier hs-var">noUnique</span></a></span><span> </span><span class="annot"><span class="annottext">(TermTypeM
   (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
    Occurrences)
 -&gt; TermTypeM
      (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
       Occurrences))
-&gt; ((PatBase Info VName
     -&gt; TermTypeM
          (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
           Occurrences))
    -&gt; TermTypeM
         (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
          Occurrences))
-&gt; (PatBase Info VName
    -&gt; TermTypeM
         (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
          Occurrences))
-&gt; TermTypeM
     (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
      Occurrences)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[SizeBinder VName]
-&gt; UncheckedPat
-&gt; InferredType
-&gt; (PatBase Info VName
    -&gt; TermTypeM
         (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
          Occurrences))
-&gt; TermTypeM
     (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
      Occurrences)
forall a.
[SizeBinder VName]
-&gt; UncheckedPat
-&gt; InferredType
-&gt; (PatBase Info VName -&gt; TermTypeM a)
-&gt; TermTypeM a
</span><a href="Language.Futhark.TypeChecker.Terms.Pat.html#bindingPat"><span class="hs-identifier hs-var">bindingPat</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">UncheckedPat
</span><a href="#local-6989586621684559750"><span class="hs-identifier hs-var">mergepat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatType -&gt; InferredType
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#Ascribed"><span class="hs-identifier hs-var">Ascribed</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684559738"><span class="hs-identifier hs-var">merge_t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((PatBase Info VName
  -&gt; TermTypeM
       (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
        Occurrences))
 -&gt; TermTypeM
      (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
       Occurrences))
-&gt; (PatBase Info VName
    -&gt; TermTypeM
         (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
          Occurrences))
-&gt; TermTypeM
     (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
      Occurrences)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684559586"><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684559586"><span class="hs-identifier hs-var">mergepat'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-218"></span><span>            </span><span class="annot"><span class="annottext">TermTypeM
  (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
   Occurrences)
-&gt; TermTypeM
     (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
      Occurrences)
forall a. TermTypeM a -&gt; TermTypeM a
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#onlySelfAliasing"><span class="hs-identifier hs-var">onlySelfAliasing</span></a></span><span> </span><span class="annot"><span class="annottext">(TermTypeM
   (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
    Occurrences)
 -&gt; TermTypeM
      (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
       Occurrences))
-&gt; ((Exp
     -&gt; Occurrences
     -&gt; TermTypeM
          ([VName], PatBase Info VName, LoopFormBase Info VName, Exp))
    -&gt; TermTypeM
         (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
          Occurrences))
-&gt; (Exp
    -&gt; Occurrences
    -&gt; TermTypeM
         ([VName], PatBase Info VName, LoopFormBase Info VName, Exp))
-&gt; TermTypeM
     (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
      Occurrences)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TermTypeM
  ([VName], PatBase Info VName, LoopFormBase Info VName, Exp)
-&gt; TermTypeM
     (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
      Occurrences)
forall a. TermTypeM a -&gt; TermTypeM (a, Occurrences)
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#tapOccurrences"><span class="hs-identifier hs-var">tapOccurrences</span></a></span><span>
</span><span id="line-219"></span><span>              </span><span class="annot"><span class="annottext">(TermTypeM
   ([VName], PatBase Info VName, LoopFormBase Info VName, Exp)
 -&gt; TermTypeM
      (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
       Occurrences))
-&gt; ((Exp
     -&gt; Occurrences
     -&gt; TermTypeM
          ([VName], PatBase Info VName, LoopFormBase Info VName, Exp))
    -&gt; TermTypeM
         ([VName], PatBase Info VName, LoopFormBase Info VName, Exp))
-&gt; (Exp
    -&gt; Occurrences
    -&gt; TermTypeM
         ([VName], PatBase Info VName, LoopFormBase Info VName, Exp))
-&gt; TermTypeM
     (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
      Occurrences)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TermTypeM Exp
-&gt; (Exp
    -&gt; Occurrences
    -&gt; TermTypeM
         ([VName], PatBase Info VName, LoopFormBase Info VName, Exp))
-&gt; TermTypeM
     ([VName], PatBase Info VName, LoopFormBase Info VName, Exp)
forall a b.
TermTypeM a -&gt; (a -&gt; Occurrences -&gt; TermTypeM b) -&gt; TermTypeM b
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#sequentially"><span class="hs-identifier hs-var">sequentially</span></a></span><span>
</span><span id="line-220"></span><span>                </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">UncheckedExp -&gt; TermTypeM Exp
</span><a href="#local-6989586621684559751"><span class="hs-identifier hs-var">checkExp</span></a></span><span> </span><span class="annot"><span class="annottext">UncheckedExp
</span><a href="#local-6989586621684559587"><span class="hs-identifier hs-var">cond</span></a></span><span>
</span><span id="line-221"></span><span>                    </span><span class="annot"><span class="annottext">TermTypeM Exp -&gt; (Exp -&gt; TermTypeM Exp) -&gt; TermTypeM Exp
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; StructType -&gt; Exp -&gt; TermTypeM Exp
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#unifies"><span class="hs-identifier hs-var">unifies</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;being the condition of a 'while' loop&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScalarTypeBase (DimDecl VName) () -&gt; StructType
forall dim as. ScalarTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-var">Scalar</span></a></span><span> </span><span class="annot"><span class="annottext">(ScalarTypeBase (DimDecl VName) () -&gt; StructType)
-&gt; ScalarTypeBase (DimDecl VName) () -&gt; StructType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; ScalarTypeBase (DimDecl VName) ()
forall dim as. PrimType -&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Language.Futhark.Syntax.html#Bool"><span class="hs-identifier hs-var">Bool</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-222"></span><span>                </span><span class="hs-special">)</span><span>
</span><span id="line-223"></span><span>              </span><span class="annot"><span class="annottext">((Exp
  -&gt; Occurrences
  -&gt; TermTypeM
       ([VName], PatBase Info VName, LoopFormBase Info VName, Exp))
 -&gt; TermTypeM
      (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
       Occurrences))
-&gt; (Exp
    -&gt; Occurrences
    -&gt; TermTypeM
         ([VName], PatBase Info VName, LoopFormBase Info VName, Exp))
-&gt; TermTypeM
     (([VName], PatBase Info VName, LoopFormBase Info VName, Exp),
      Occurrences)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684559582"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684559582"><span class="hs-identifier hs-var">cond'</span></a></span></span><span> </span><span class="annot"><span class="annottext">Occurrences
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-224"></span><span>                </span><span id="local-6989586621684559581"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684559581"><span class="hs-identifier hs-var">loopbody'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TermTypeM Exp -&gt; TermTypeM Exp
forall a. TermTypeM a -&gt; TermTypeM a
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#noSizeEscape"><span class="hs-identifier hs-var">noSizeEscape</span></a></span><span> </span><span class="annot"><span class="annottext">(TermTypeM Exp -&gt; TermTypeM Exp) -&gt; TermTypeM Exp -&gt; TermTypeM Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">UncheckedExp -&gt; TermTypeM Exp
</span><a href="#local-6989586621684559751"><span class="hs-identifier hs-var">checkExp</span></a></span><span> </span><span class="annot"><span class="annottext">UncheckedExp
</span><a href="#local-6989586621684559747"><span class="hs-identifier hs-var">loopbody</span></a></span><span>
</span><span id="line-225"></span><span>                </span><span class="hs-special">(</span><span id="local-6989586621684559580"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684559580"><span class="hs-identifier hs-var">sparams</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684559579"><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684559579"><span class="hs-identifier hs-var">mergepat''</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
-&gt; Exp -&gt; TermTypeM ([VName], PatBase Info VName)
</span><a href="#local-6989586621684559703"><span class="hs-identifier hs-var">checkLoopReturnSize</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684559586"><span class="hs-identifier hs-var">mergepat'</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684559581"><span class="hs-identifier hs-var">loopbody'</span></a></span><span>
</span><span id="line-226"></span><span>                </span><span class="annot"><span class="annottext">([VName], PatBase Info VName, LoopFormBase Info VName, Exp)
-&gt; TermTypeM
     ([VName], PatBase Info VName, LoopFormBase Info VName, Exp)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-227"></span><span>                  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684559580"><span class="hs-identifier hs-var">sparams</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-228"></span><span>                    </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684559579"><span class="hs-identifier hs-var">mergepat''</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-229"></span><span>                    </span><span class="annot"><span class="annottext">Exp -&gt; LoopFormBase Info VName
forall (f :: * -&gt; *) vn. ExpBase f vn -&gt; LoopFormBase f vn
</span><a href="Language.Futhark.Syntax.html#While"><span class="hs-identifier hs-var">While</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684559582"><span class="hs-identifier hs-var">cond'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-230"></span><span>                    </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684559581"><span class="hs-identifier hs-var">loopbody'</span></a></span><span>
</span><span id="line-231"></span><span>                  </span><span class="hs-special">)</span><span>
</span><span id="line-232"></span><span>
</span><span id="line-233"></span><span>    </span><span id="local-6989586621684559578"><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684559578"><span class="hs-identifier hs-var">mergepat''</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-234"></span><span>      </span><span id="local-6989586621684559577"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684559577"><span class="hs-identifier hs-var">loopbody_t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; TermTypeM PatType
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#expTypeFully"><span class="hs-identifier hs-var">expTypeFully</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684559628"><span class="hs-identifier hs-var">loopbody'</span></a></span><span>
</span><span id="line-235"></span><span>      </span><span class="annot"><span class="annottext">PatBase Info VName
-&gt; Set VName -&gt; PatType -&gt; Usage -&gt; TermTypeM (PatBase Info VName)
forall {m :: * -&gt; *} {t}.
(MonadUnify m, MonadTypeChecker m, Located t,
 MonadReader TermEnv m) =&gt;
PatBase Info VName
-&gt; Set VName -&gt; PatType -&gt; t -&gt; m (PatBase Info VName)
</span><a href="#local-6989586621684559576"><span class="hs-identifier hs-var">convergePat</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684559630"><span class="hs-identifier hs-var">mergepat'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Occurrences -&gt; Set VName
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#allConsumed"><span class="hs-identifier hs-var">allConsumed</span></a></span><span> </span><span class="annot"><span class="annottext">Occurrences
</span><a href="#local-6989586621684559627"><span class="hs-identifier hs-var">bodyflow</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684559577"><span class="hs-identifier hs-var">loopbody_t</span></a></span><span> </span><span class="annot"><span class="annottext">(Usage -&gt; TermTypeM (PatBase Info VName))
-&gt; Usage -&gt; TermTypeM (PatBase Info VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-236"></span><span>        </span><span class="annot"><span class="annottext">SrcLoc -&gt; String -&gt; Usage
</span><a href="Language.Futhark.TypeChecker.Unify.html#mkUsage"><span class="hs-identifier hs-var">mkUsage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp -&gt; SrcLoc
forall a. Located a =&gt; a -&gt; SrcLoc
</span><span class="hs-identifier hs-var">srclocOf</span></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684559628"><span class="hs-identifier hs-var">loopbody'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;being (part of) the result of the loop body&quot;</span></span><span>
</span><span id="line-237"></span><span>
</span><span id="line-238"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684559570"><span class="annot"><span class="annottext">consumeMerge :: PatBase Info vn -&gt; TypeBase dim Aliasing -&gt; TermTypeM ()
</span><a href="#local-6989586621684559570"><span class="hs-identifier hs-var hs-var">consumeMerge</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="annot"><span class="annottext">vn
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-type">Info</span></a></span><span> </span><span id="local-6989586621684559567"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684559567"><span class="hs-identifier hs-var">pt</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684559566"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684559566"><span class="hs-identifier hs-var">ploc</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684559565"><span class="annot"><span class="annottext">TypeBase dim Aliasing
</span><a href="#local-6989586621684559565"><span class="hs-identifier hs-var">mt</span></a></span></span><span>
</span><span id="line-239"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">PatType -&gt; Bool
forall shape as. TypeBase shape as -&gt; Bool
</span><a href="Language.Futhark.Prop.html#unique"><span class="hs-identifier hs-var">unique</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684559567"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SrcLoc -&gt; Aliasing -&gt; TermTypeM ()
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#consume"><span class="hs-identifier hs-var">consume</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684559566"><span class="hs-identifier hs-var">ploc</span></a></span><span> </span><span class="annot"><span class="annottext">(Aliasing -&gt; TermTypeM ()) -&gt; Aliasing -&gt; TermTypeM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TypeBase dim Aliasing -&gt; Aliasing
forall as shape. Monoid as =&gt; TypeBase shape as -&gt; as
</span><a href="Language.Futhark.Prop.html#aliases"><span class="hs-identifier hs-var">aliases</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase dim Aliasing
</span><a href="#local-6989586621684559565"><span class="hs-identifier hs-var">mt</span></a></span><span>
</span><span id="line-240"></span><span>        </span><span class="annot"><a href="#local-6989586621684559570"><span class="hs-identifier hs-var">consumeMerge</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TuplePat"><span class="hs-identifier hs-type">TuplePat</span></a></span><span> </span><span id="local-6989586621684559560"><span class="annot"><span class="annottext">[PatBase Info vn]
</span><a href="#local-6989586621684559560"><span class="hs-identifier hs-var">pats</span></a></span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684559559"><span class="annot"><span class="annottext">TypeBase dim Aliasing
</span><a href="#local-6989586621684559559"><span class="hs-identifier hs-var">t</span></a></span></span><span>
</span><span id="line-241"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684559558"><span class="annot"><span class="annottext">[TypeBase dim Aliasing]
</span><a href="#local-6989586621684559558"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TypeBase dim Aliasing -&gt; Maybe [TypeBase dim Aliasing]
forall dim as. TypeBase dim as -&gt; Maybe [TypeBase dim as]
</span><a href="Language.Futhark.Prop.html#isTupleRecord"><span class="hs-identifier hs-var">isTupleRecord</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase dim Aliasing
</span><a href="#local-6989586621684559559"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-242"></span><span>            </span><span class="annot"><span class="annottext">(PatBase Info vn -&gt; TypeBase dim Aliasing -&gt; TermTypeM ())
-&gt; [PatBase Info vn] -&gt; [TypeBase dim Aliasing] -&gt; TermTypeM ()
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m ()
</span><span class="hs-identifier hs-var">zipWithM_</span></span><span> </span><span class="annot"><span class="annottext">PatBase Info vn -&gt; TypeBase dim Aliasing -&gt; TermTypeM ()
</span><a href="#local-6989586621684559570"><span class="hs-identifier hs-var">consumeMerge</span></a></span><span> </span><span class="annot"><span class="annottext">[PatBase Info vn]
</span><a href="#local-6989586621684559560"><span class="hs-identifier hs-var">pats</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeBase dim Aliasing]
</span><a href="#local-6989586621684559558"><span class="hs-identifier hs-var">ts</span></a></span><span>
</span><span id="line-243"></span><span>        </span><span class="annot"><a href="#local-6989586621684559570"><span class="hs-identifier hs-var">consumeMerge</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#PatParens"><span class="hs-identifier hs-type">PatParens</span></a></span><span> </span><span id="local-6989586621684559554"><span class="annot"><span class="annottext">PatBase Info vn
</span><a href="#local-6989586621684559554"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684559553"><span class="annot"><span class="annottext">TypeBase dim Aliasing
</span><a href="#local-6989586621684559553"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-244"></span><span>          </span><span class="annot"><span class="annottext">PatBase Info vn -&gt; TypeBase dim Aliasing -&gt; TermTypeM ()
</span><a href="#local-6989586621684559570"><span class="hs-identifier hs-var">consumeMerge</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info vn
</span><a href="#local-6989586621684559554"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase dim Aliasing
</span><a href="#local-6989586621684559553"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-245"></span><span>        </span><span class="annot"><a href="#local-6989586621684559570"><span class="hs-identifier hs-var">consumeMerge</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#PatAscription"><span class="hs-identifier hs-type">PatAscription</span></a></span><span> </span><span id="local-6989586621684559551"><span class="annot"><span class="annottext">PatBase Info vn
</span><a href="#local-6989586621684559551"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="annot"><span class="annottext">TypeDeclBase Info vn
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684559550"><span class="annot"><span class="annottext">TypeBase dim Aliasing
</span><a href="#local-6989586621684559550"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-246"></span><span>          </span><span class="annot"><span class="annottext">PatBase Info vn -&gt; TypeBase dim Aliasing -&gt; TermTypeM ()
</span><a href="#local-6989586621684559570"><span class="hs-identifier hs-var">consumeMerge</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info vn
</span><a href="#local-6989586621684559551"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase dim Aliasing
</span><a href="#local-6989586621684559550"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-247"></span><span>        </span><span class="annot"><a href="#local-6989586621684559570"><span class="hs-identifier hs-var">consumeMerge</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info vn
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">TypeBase dim Aliasing
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-248"></span><span>          </span><span class="annot"><span class="annottext">() -&gt; TermTypeM ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-249"></span><span>    </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; PatType -&gt; TermTypeM ()
forall {vn} {dim}.
PatBase Info vn -&gt; TypeBase dim Aliasing -&gt; TermTypeM ()
</span><a href="#local-6989586621684559570"><span class="hs-identifier hs-var">consumeMerge</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684559578"><span class="hs-identifier hs-var">mergepat''</span></a></span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; TermTypeM ()) -&gt; TermTypeM PatType -&gt; TermTypeM ()
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; TermTypeM PatType
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#expTypeFully"><span class="hs-identifier hs-var">expTypeFully</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684559744"><span class="hs-identifier hs-var">mergeexp'</span></a></span><span>
</span><span id="line-250"></span><span>
</span><span id="line-251"></span><span>    </span><span class="hs-comment">-- dim handling (3)</span><span>
</span><span id="line-252"></span><span>    </span><span id="local-6989586621684559549"><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684559549"><span class="hs-identifier hs-var">merge_t'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-253"></span><span>      </span><span class="annot"><span class="annottext">SrcLoc
-&gt; Rigidity
-&gt; Name
-&gt; Set VName
-&gt; StructType
-&gt; TermTypeM StructType
forall als.
SrcLoc
-&gt; Rigidity
-&gt; Name
-&gt; Set VName
-&gt; TypeBase (DimDecl VName) als
-&gt; TermTypeM (TypeBase (DimDecl VName) als)
</span><a href="Language.Futhark.TypeChecker.Terms.DoLoop.html#someDimsFreshInType"><span class="hs-identifier hs-var">someDimsFreshInType</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684559746"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">Rigidity
</span><a href="Language.Futhark.TypeChecker.Unify.html#Nonrigid"><span class="hs-identifier hs-var">Nonrigid</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-string">&quot;loop&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; Set VName
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">S.fromList</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684559631"><span class="hs-identifier hs-var">sparams</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(StructType -&gt; TermTypeM StructType)
-&gt; StructType -&gt; TermTypeM StructType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-254"></span><span>        </span><span class="annot"><span class="annottext">PatType -&gt; StructType
forall dim as. TypeBase dim as -&gt; TypeBase dim ()
</span><a href="Language.Futhark.Prop.html#toStruct"><span class="hs-identifier hs-var">toStruct</span></a></span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; StructType) -&gt; PatType -&gt; StructType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; PatType
</span><a href="Language.Futhark.Prop.html#patternType"><span class="hs-identifier hs-var">patternType</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684559578"><span class="hs-identifier hs-var">mergepat''</span></a></span><span>
</span><span id="line-255"></span><span>    </span><span id="local-6989586621684559548"><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684559548"><span class="hs-identifier hs-var">mergeexp_t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PatType -&gt; StructType
forall dim as. TypeBase dim as -&gt; TypeBase dim ()
</span><a href="Language.Futhark.Prop.html#toStruct"><span class="hs-identifier hs-var">toStruct</span></a></span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; StructType)
-&gt; TermTypeM PatType -&gt; TermTypeM StructType
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; TermTypeM PatType
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#expTypeFully"><span class="hs-identifier hs-var">expTypeFully</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684559744"><span class="hs-identifier hs-var">mergeexp'</span></a></span><span>
</span><span id="line-256"></span><span>    </span><span class="annot"><span class="annottext">Checking -&gt; TermTypeM () -&gt; TermTypeM ()
forall a. Checking -&gt; TermTypeM a -&gt; TermTypeM a
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#onFailure"><span class="hs-identifier hs-var">onFailure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StructType -&gt; StructType -&gt; Checking
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#CheckingLoopInitial"><span class="hs-identifier hs-var">CheckingLoopInitial</span></a></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684559549"><span class="hs-identifier hs-var">merge_t'</span></a></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684559548"><span class="hs-identifier hs-var">mergeexp_t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TermTypeM () -&gt; TermTypeM ()) -&gt; TermTypeM () -&gt; TermTypeM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-257"></span><span>      </span><span class="annot"><span class="annottext">Usage -&gt; StructType -&gt; StructType -&gt; TermTypeM ()
forall (m :: * -&gt; *).
MonadUnify m =&gt;
Usage -&gt; StructType -&gt; StructType -&gt; m ()
</span><a href="Language.Futhark.TypeChecker.Unify.html#unify"><span class="hs-identifier hs-var">unify</span></a></span><span>
</span><span id="line-258"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SrcLoc -&gt; String -&gt; Usage
</span><a href="Language.Futhark.TypeChecker.Unify.html#mkUsage"><span class="hs-identifier hs-var">mkUsage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp -&gt; SrcLoc
forall a. Located a =&gt; a -&gt; SrcLoc
</span><span class="hs-identifier hs-var">srclocOf</span></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684559744"><span class="hs-identifier hs-var">mergeexp'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;matching initial loop values to pattern&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-259"></span><span>        </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684559549"><span class="hs-identifier hs-var">merge_t'</span></a></span><span>
</span><span id="line-260"></span><span>        </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684559548"><span class="hs-identifier hs-var">mergeexp_t</span></a></span><span>
</span><span id="line-261"></span><span>
</span><span id="line-262"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684559546"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684559546"><span class="hs-identifier hs-var">loopt</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684559545"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684559545"><span class="hs-identifier hs-var">retext</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-263"></span><span>      </span><span class="annot"><span class="annottext">SrcLoc
-&gt; Rigidity
-&gt; Name
-&gt; Set VName
-&gt; PatType
-&gt; TermTypeM (PatType, [VName])
forall als.
SrcLoc
-&gt; Rigidity
-&gt; Name
-&gt; Set VName
-&gt; TypeBase (DimDecl VName) als
-&gt; TermTypeM (TypeBase (DimDecl VName) als, [VName])
</span><a href="Language.Futhark.TypeChecker.Terms.DoLoop.html#freshDimsInType"><span class="hs-identifier hs-var">freshDimsInType</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684559746"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RigidSource -&gt; Rigidity
</span><a href="Language.Futhark.TypeChecker.Unify.html#Rigid"><span class="hs-identifier hs-var">Rigid</span></a></span><span> </span><span class="annot"><span class="annottext">RigidSource
</span><a href="Language.Futhark.TypeChecker.Unify.html#RigidLoop"><span class="hs-identifier hs-var">RigidLoop</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-string">&quot;loop&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; Set VName
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">S.fromList</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684559631"><span class="hs-identifier hs-var">sparams</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; TermTypeM (PatType, [VName]))
-&gt; PatType -&gt; TermTypeM (PatType, [VName])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-264"></span><span>        </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; PatType
</span><a href="Language.Futhark.Prop.html#patternType"><span class="hs-identifier hs-var">patternType</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684559578"><span class="hs-identifier hs-var">mergepat''</span></a></span><span>
</span><span id="line-265"></span><span>    </span><span class="hs-comment">-- We set all of the uniqueness to be unique.  This is intentional,</span><span>
</span><span id="line-266"></span><span>    </span><span class="hs-comment">-- and matches what happens for function calls.  Those arrays that</span><span>
</span><span id="line-267"></span><span>    </span><span class="hs-comment">-- really *cannot* be consumed will alias something unconsumable,</span><span>
</span><span id="line-268"></span><span>    </span><span class="hs-comment">-- and will be caught that way.</span><span>
</span><span id="line-269"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684559534"><span class="annot"><span class="annottext">bound_here :: Set VName
</span><a href="#local-6989586621684559534"><span class="hs-identifier hs-var hs-var">bound_here</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; Set VName
forall (f :: * -&gt; *) vn.
(Functor f, Ord vn) =&gt;
PatBase f vn -&gt; Set vn
</span><a href="Language.Futhark.Prop.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684559578"><span class="hs-identifier hs-var">mergepat''</span></a></span><span> </span><span class="annot"><span class="annottext">Set VName -&gt; Set VName -&gt; Set VName
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Set VName
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">S.fromList</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684559631"><span class="hs-identifier hs-var">sparams</span></a></span><span> </span><span class="annot"><span class="annottext">Set VName -&gt; Set VName -&gt; Set VName
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684559532"><span class="hs-identifier hs-var">form_bound</span></a></span><span>
</span><span id="line-270"></span><span>        </span><span id="local-6989586621684559532"><span class="annot"><span class="annottext">form_bound :: Set VName
</span><a href="#local-6989586621684559532"><span class="hs-identifier hs-var hs-var">form_bound</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-271"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">LoopFormBase Info VName
</span><a href="#local-6989586621684559629"><span class="hs-identifier hs-var">form'</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-272"></span><span>            </span><span class="annot"><a href="Language.Futhark.Syntax.html#For"><span class="hs-identifier hs-type">For</span></a></span><span> </span><span id="local-6989586621684559528"><span class="annot"><span class="annottext">Ident
</span><a href="#local-6989586621684559528"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="annot"><span class="annottext">Exp
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Set VName
forall a. a -&gt; Set a
</span><span class="hs-identifier hs-var">S.singleton</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Set VName) -&gt; VName -&gt; Set VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Ident -&gt; VName
forall (f :: * -&gt; *) vn. IdentBase f vn -&gt; vn
</span><a href="Language.Futhark.Syntax.html#identName"><span class="hs-identifier hs-var hs-var">identName</span></a></span><span> </span><span class="annot"><span class="annottext">Ident
</span><a href="#local-6989586621684559528"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-273"></span><span>            </span><span class="annot"><a href="Language.Futhark.Syntax.html#ForIn"><span class="hs-identifier hs-type">ForIn</span></a></span><span> </span><span id="local-6989586621684559525"><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684559525"><span class="hs-identifier hs-var">forpat</span></a></span></span><span> </span><span class="annot"><span class="annottext">Exp
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; Set VName
forall (f :: * -&gt; *) vn.
(Functor f, Ord vn) =&gt;
PatBase f vn -&gt; Set vn
</span><a href="Language.Futhark.Prop.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684559525"><span class="hs-identifier hs-var">forpat</span></a></span><span>
</span><span id="line-274"></span><span>            </span><span class="annot"><a href="Language.Futhark.Syntax.html#While"><span class="hs-identifier hs-type">While</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Set VName
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-275"></span><span>        </span><span id="local-6989586621684559520"><span class="annot"><span class="annottext">loopt' :: PatType
</span><a href="#local-6989586621684559520"><span class="hs-identifier hs-var hs-var">loopt'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-276"></span><span>          </span><span class="annot"><span class="annottext">(Aliasing -&gt; Aliasing) -&gt; PatType -&gt; PatType
forall (p :: * -&gt; * -&gt; *) b c a.
Bifunctor p =&gt;
(b -&gt; c) -&gt; p a b -&gt; p a c
</span><span class="hs-identifier hs-var">second</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Aliasing -&gt; Aliasing -&gt; Aliasing
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><span class="hs-operator hs-var">`S.difference`</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Alias) -&gt; Set VName -&gt; Aliasing
forall b a. Ord b =&gt; (a -&gt; b) -&gt; Set a -&gt; Set b
</span><span class="hs-identifier hs-var">S.map</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Alias
</span><a href="Language.Futhark.Syntax.html#AliasBound"><span class="hs-identifier hs-var">AliasBound</span></a></span><span> </span><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684559534"><span class="hs-identifier hs-var">bound_here</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; PatType) -&gt; PatType -&gt; PatType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-277"></span><span>            </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684559546"><span class="hs-identifier hs-var">loopt</span></a></span><span> </span><span class="annot"><span class="annottext">PatType -&gt; Uniqueness -&gt; PatType
forall dim as. TypeBase dim as -&gt; Uniqueness -&gt; TypeBase dim as
</span><a href="Language.Futhark.Prop.html#setUniqueness"><span class="hs-operator hs-var">`setUniqueness`</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="Language.Futhark.Core.html#Unique"><span class="hs-identifier hs-var">Unique</span></a></span><span>
</span><span id="line-278"></span><span>
</span><span id="line-279"></span><span>    </span><span class="hs-comment">-- Eliminate those new_dims that turned into sparams so it won't</span><span>
</span><span id="line-280"></span><span>    </span><span class="hs-comment">-- look like we have ambiguous sizes lying around.</span><span>
</span><span id="line-281"></span><span>    </span><span class="annot"><span class="annottext">(Constraints -&gt; Constraints) -&gt; TermTypeM ()
forall (m :: * -&gt; *).
MonadUnify m =&gt;
(Constraints -&gt; Constraints) -&gt; m ()
</span><a href="Language.Futhark.TypeChecker.Unify.html#modifyConstraints"><span class="hs-identifier hs-var">modifyConstraints</span></a></span><span> </span><span class="annot"><span class="annottext">((Constraints -&gt; Constraints) -&gt; TermTypeM ())
-&gt; (Constraints -&gt; Constraints) -&gt; TermTypeM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; (Int, Constraint) -&gt; Bool) -&gt; Constraints -&gt; Constraints
forall k a. (k -&gt; a -&gt; Bool) -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.filterWithKey</span></span><span> </span><span class="annot"><span class="annottext">((VName -&gt; (Int, Constraint) -&gt; Bool)
 -&gt; Constraints -&gt; Constraints)
-&gt; (VName -&gt; (Int, Constraint) -&gt; Bool)
-&gt; Constraints
-&gt; Constraints
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684559512"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684559512"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="annot"><span class="annottext">(Int, Constraint)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684559512"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [VName] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`notElem`</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684559631"><span class="hs-identifier hs-var">sparams</span></a></span><span>
</span><span id="line-282"></span><span>
</span><span id="line-283"></span><span>    </span><span class="annot"><span class="annottext">(CheckedLoop, AppRes) -&gt; TermTypeM (CheckedLoop, AppRes)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684559631"><span class="hs-identifier hs-var">sparams</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684559578"><span class="hs-identifier hs-var">mergepat''</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684559744"><span class="hs-identifier hs-var">mergeexp'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">LoopFormBase Info VName
</span><a href="#local-6989586621684559629"><span class="hs-identifier hs-var">form'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684559628"><span class="hs-identifier hs-var">loopbody'</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PatType -&gt; [VName] -&gt; AppRes
</span><a href="Language.Futhark.Syntax.html#AppRes"><span class="hs-identifier hs-var">AppRes</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684559520"><span class="hs-identifier hs-var">loopt'</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684559545"><span class="hs-identifier hs-var">retext</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-284"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-285"></span><span>    </span><span id="local-6989586621684559576"><span class="annot"><span class="annottext">convergePat :: PatBase Info VName
-&gt; Set VName -&gt; PatType -&gt; t -&gt; m (PatBase Info VName)
</span><a href="#local-6989586621684559576"><span class="hs-identifier hs-var hs-var">convergePat</span></a></span></span><span> </span><span id="local-6989586621684559475"><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684559475"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684559474"><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684559474"><span class="hs-identifier hs-var">body_cons</span></a></span></span><span> </span><span id="local-6989586621684559473"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684559473"><span class="hs-identifier hs-var">body_t</span></a></span></span><span> </span><span id="local-6989586621684559472"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621684559472"><span class="hs-identifier hs-var">body_loc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-286"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684559468"><span class="annot"><span class="annottext">consumed_merge :: Set VName
</span><a href="#local-6989586621684559468"><span class="hs-identifier hs-var hs-var">consumed_merge</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; Set VName
forall (f :: * -&gt; *) vn.
(Functor f, Ord vn) =&gt;
PatBase f vn -&gt; Set vn
</span><a href="Language.Futhark.Prop.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684559475"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">Set VName -&gt; Set VName -&gt; Set VName
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><span class="hs-operator hs-var">`S.intersection`</span></span><span> </span><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684559474"><span class="hs-identifier hs-var">body_cons</span></a></span><span>
</span><span id="line-287"></span><span>
</span><span id="line-288"></span><span>          </span><span id="local-6989586621684559463"><span class="annot"><span class="annottext">uniquePat :: PatBase Info VName -&gt; PatBase Info VName
</span><a href="#local-6989586621684559463"><span class="hs-identifier hs-var hs-var">uniquePat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Wildcard"><span class="hs-identifier hs-type">Wildcard</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-type">Info</span></a></span><span> </span><span id="local-6989586621684559461"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684559461"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684559460"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684559460"><span class="hs-identifier hs-var">wloc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-289"></span><span>            </span><span class="annot"><span class="annottext">Info PatType -&gt; SrcLoc -&gt; PatBase Info VName
forall (f :: * -&gt; *) vn. f PatType -&gt; SrcLoc -&gt; PatBase f vn
</span><a href="Language.Futhark.Syntax.html#Wildcard"><span class="hs-identifier hs-var">Wildcard</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatType -&gt; Info PatType
forall a. a -&gt; Info a
</span><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-var">Info</span></a></span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; Info PatType) -&gt; PatType -&gt; Info PatType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684559461"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">PatType -&gt; Uniqueness -&gt; PatType
forall dim as. TypeBase dim as -&gt; Uniqueness -&gt; TypeBase dim as
</span><a href="Language.Futhark.Prop.html#setUniqueness"><span class="hs-operator hs-var">`setUniqueness`</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="Language.Futhark.Core.html#Nonunique"><span class="hs-identifier hs-var">Nonunique</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684559460"><span class="hs-identifier hs-var">wloc</span></a></span><span>
</span><span id="line-290"></span><span>          </span><span class="annot"><a href="#local-6989586621684559463"><span class="hs-identifier hs-var">uniquePat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#PatParens"><span class="hs-identifier hs-type">PatParens</span></a></span><span> </span><span id="local-6989586621684559458"><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684559458"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621684559457"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684559457"><span class="hs-identifier hs-var">ploc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-291"></span><span>            </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; SrcLoc -&gt; PatBase Info VName
forall (f :: * -&gt; *) vn. PatBase f vn -&gt; SrcLoc -&gt; PatBase f vn
</span><a href="Language.Futhark.Syntax.html#PatParens"><span class="hs-identifier hs-var">PatParens</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatBase Info VName -&gt; PatBase Info VName
</span><a href="#local-6989586621684559463"><span class="hs-identifier hs-var">uniquePat</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684559458"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684559457"><span class="hs-identifier hs-var">ploc</span></a></span><span>
</span><span id="line-292"></span><span>          </span><span class="annot"><a href="#local-6989586621684559463"><span class="hs-identifier hs-var">uniquePat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#PatAttr"><span class="hs-identifier hs-type">PatAttr</span></a></span><span> </span><span id="local-6989586621684559455"><span class="annot"><span class="annottext">AttrInfo VName
</span><a href="#local-6989586621684559455"><span class="hs-identifier hs-var">attr</span></a></span></span><span> </span><span id="local-6989586621684559454"><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684559454"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621684559453"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684559453"><span class="hs-identifier hs-var">ploc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-293"></span><span>            </span><span class="annot"><span class="annottext">AttrInfo VName
-&gt; PatBase Info VName -&gt; SrcLoc -&gt; PatBase Info VName
forall (f :: * -&gt; *) vn.
AttrInfo vn -&gt; PatBase f vn -&gt; SrcLoc -&gt; PatBase f vn
</span><a href="Language.Futhark.Syntax.html#PatAttr"><span class="hs-identifier hs-var">PatAttr</span></a></span><span> </span><span class="annot"><span class="annottext">AttrInfo VName
</span><a href="#local-6989586621684559455"><span class="hs-identifier hs-var">attr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatBase Info VName -&gt; PatBase Info VName
</span><a href="#local-6989586621684559463"><span class="hs-identifier hs-var">uniquePat</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684559454"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684559453"><span class="hs-identifier hs-var">ploc</span></a></span><span>
</span><span id="line-294"></span><span>          </span><span class="annot"><a href="#local-6989586621684559463"><span class="hs-identifier hs-var">uniquePat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span id="local-6989586621684559452"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684559452"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-type">Info</span></a></span><span> </span><span id="local-6989586621684559451"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684559451"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684559450"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684559450"><span class="hs-identifier hs-var">iloc</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-295"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684559452"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Set VName -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><span class="hs-operator hs-var">`S.member`</span></span><span> </span><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684559468"><span class="hs-identifier hs-var">consumed_merge</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-296"></span><span>              </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684559447"><span class="annot"><span class="annottext">t' :: PatType
</span><a href="#local-6989586621684559447"><span class="hs-identifier hs-var hs-var">t'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684559451"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">PatType -&gt; Uniqueness -&gt; PatType
forall dim as. TypeBase dim as -&gt; Uniqueness -&gt; TypeBase dim as
</span><a href="Language.Futhark.Prop.html#setUniqueness"><span class="hs-operator hs-var">`setUniqueness`</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="Language.Futhark.Core.html#Unique"><span class="hs-identifier hs-var">Unique</span></a></span><span> </span><span class="annot"><span class="annottext">PatType -&gt; Aliasing -&gt; PatType
forall dim asf ast. TypeBase dim asf -&gt; ast -&gt; TypeBase dim ast
</span><a href="Language.Futhark.Prop.html#setAliases"><span class="hs-operator hs-var">`setAliases`</span></a></span><span> </span><span class="annot"><span class="annottext">Aliasing
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-297"></span><span>               </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Info PatType -&gt; SrcLoc -&gt; PatBase Info VName
forall (f :: * -&gt; *) vn. vn -&gt; f PatType -&gt; SrcLoc -&gt; PatBase f vn
</span><a href="Language.Futhark.Syntax.html#Id"><span class="hs-identifier hs-var">Id</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684559452"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatType -&gt; Info PatType
forall a. a -&gt; Info a
</span><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-var">Info</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684559447"><span class="hs-identifier hs-var">t'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684559450"><span class="hs-identifier hs-var">iloc</span></a></span><span>
</span><span id="line-298"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-299"></span><span>              </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684559445"><span class="annot"><span class="annottext">t' :: PatType
</span><a href="#local-6989586621684559445"><span class="hs-identifier hs-var hs-var">t'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684559451"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">PatType -&gt; Uniqueness -&gt; PatType
forall dim as. TypeBase dim as -&gt; Uniqueness -&gt; TypeBase dim as
</span><a href="Language.Futhark.Prop.html#setUniqueness"><span class="hs-operator hs-var">`setUniqueness`</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="Language.Futhark.Core.html#Nonunique"><span class="hs-identifier hs-var">Nonunique</span></a></span><span>
</span><span id="line-300"></span><span>               </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Info PatType -&gt; SrcLoc -&gt; PatBase Info VName
forall (f :: * -&gt; *) vn. vn -&gt; f PatType -&gt; SrcLoc -&gt; PatBase f vn
</span><a href="Language.Futhark.Syntax.html#Id"><span class="hs-identifier hs-var">Id</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684559452"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatType -&gt; Info PatType
forall a. a -&gt; Info a
</span><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-var">Info</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684559445"><span class="hs-identifier hs-var">t'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684559450"><span class="hs-identifier hs-var">iloc</span></a></span><span>
</span><span id="line-301"></span><span>          </span><span class="annot"><a href="#local-6989586621684559463"><span class="hs-identifier hs-var">uniquePat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TuplePat"><span class="hs-identifier hs-type">TuplePat</span></a></span><span> </span><span id="local-6989586621684559444"><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684559444"><span class="hs-identifier hs-var">pats</span></a></span></span><span> </span><span id="local-6989586621684559443"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684559443"><span class="hs-identifier hs-var">ploc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-302"></span><span>            </span><span class="annot"><span class="annottext">[PatBase Info VName] -&gt; SrcLoc -&gt; PatBase Info VName
forall (f :: * -&gt; *) vn. [PatBase f vn] -&gt; SrcLoc -&gt; PatBase f vn
</span><a href="Language.Futhark.Syntax.html#TuplePat"><span class="hs-identifier hs-var">TuplePat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PatBase Info VName -&gt; PatBase Info VName)
-&gt; [PatBase Info VName] -&gt; [PatBase Info VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; PatBase Info VName
</span><a href="#local-6989586621684559463"><span class="hs-identifier hs-var">uniquePat</span></a></span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684559444"><span class="hs-identifier hs-var">pats</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684559443"><span class="hs-identifier hs-var">ploc</span></a></span><span>
</span><span id="line-303"></span><span>          </span><span class="annot"><a href="#local-6989586621684559463"><span class="hs-identifier hs-var">uniquePat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#RecordPat"><span class="hs-identifier hs-type">RecordPat</span></a></span><span> </span><span id="local-6989586621684559441"><span class="annot"><span class="annottext">[(Name, PatBase Info VName)]
</span><a href="#local-6989586621684559441"><span class="hs-identifier hs-var">fs</span></a></span></span><span> </span><span id="local-6989586621684559440"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684559440"><span class="hs-identifier hs-var">ploc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-304"></span><span>            </span><span class="annot"><span class="annottext">[(Name, PatBase Info VName)] -&gt; SrcLoc -&gt; PatBase Info VName
forall (f :: * -&gt; *) vn.
[(Name, PatBase f vn)] -&gt; SrcLoc -&gt; PatBase f vn
</span><a href="Language.Futhark.Syntax.html#RecordPat"><span class="hs-identifier hs-var">RecordPat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Name, PatBase Info VName) -&gt; (Name, PatBase Info VName))
-&gt; [(Name, PatBase Info VName)] -&gt; [(Name, PatBase Info VName)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PatBase Info VName -&gt; PatBase Info VName)
-&gt; (Name, PatBase Info VName) -&gt; (Name, PatBase Info VName)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; PatBase Info VName
</span><a href="#local-6989586621684559463"><span class="hs-identifier hs-var">uniquePat</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Name, PatBase Info VName)]
</span><a href="#local-6989586621684559441"><span class="hs-identifier hs-var">fs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684559440"><span class="hs-identifier hs-var">ploc</span></a></span><span>
</span><span id="line-305"></span><span>          </span><span class="annot"><a href="#local-6989586621684559463"><span class="hs-identifier hs-var">uniquePat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#PatAscription"><span class="hs-identifier hs-type">PatAscription</span></a></span><span> </span><span id="local-6989586621684559439"><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684559439"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621684559438"><span class="annot"><span class="annottext">TypeDeclBase Info VName
</span><a href="#local-6989586621684559438"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621684559437"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684559437"><span class="hs-identifier hs-var">ploc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-306"></span><span>            </span><span class="annot"><span class="annottext">PatBase Info VName
-&gt; TypeDeclBase Info VName -&gt; SrcLoc -&gt; PatBase Info VName
forall (f :: * -&gt; *) vn.
PatBase f vn -&gt; TypeDeclBase f vn -&gt; SrcLoc -&gt; PatBase f vn
</span><a href="Language.Futhark.Syntax.html#PatAscription"><span class="hs-identifier hs-var">PatAscription</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684559439"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">TypeDeclBase Info VName
</span><a href="#local-6989586621684559438"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684559437"><span class="hs-identifier hs-var">ploc</span></a></span><span>
</span><span id="line-307"></span><span>          </span><span class="annot"><a href="#local-6989586621684559463"><span class="hs-identifier hs-var">uniquePat</span></a></span><span> </span><span id="local-6989586621684559436"><span class="annot"><span class="annottext">p :: PatBase Info VName
</span><a href="#local-6989586621684559436"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Language.Futhark.Syntax.html#PatLit"><span class="hs-identifier hs-type">PatLit</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684559436"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-308"></span><span>          </span><span class="annot"><a href="#local-6989586621684559463"><span class="hs-identifier hs-var">uniquePat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#PatConstr"><span class="hs-identifier hs-type">PatConstr</span></a></span><span> </span><span id="local-6989586621684559433"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684559433"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621684559432"><span class="annot"><span class="annottext">Info PatType
</span><a href="#local-6989586621684559432"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621684559431"><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684559431"><span class="hs-identifier hs-var">ps</span></a></span></span><span> </span><span id="local-6989586621684559430"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684559430"><span class="hs-identifier hs-var">ploc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-309"></span><span>            </span><span class="annot"><span class="annottext">Name
-&gt; Info PatType
-&gt; [PatBase Info VName]
-&gt; SrcLoc
-&gt; PatBase Info VName
forall (f :: * -&gt; *) vn.
Name -&gt; f PatType -&gt; [PatBase f vn] -&gt; SrcLoc -&gt; PatBase f vn
</span><a href="Language.Futhark.Syntax.html#PatConstr"><span class="hs-identifier hs-var">PatConstr</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684559433"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Info PatType
</span><a href="#local-6989586621684559432"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PatBase Info VName -&gt; PatBase Info VName)
-&gt; [PatBase Info VName] -&gt; [PatBase Info VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; PatBase Info VName
</span><a href="#local-6989586621684559463"><span class="hs-identifier hs-var">uniquePat</span></a></span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684559431"><span class="hs-identifier hs-var">ps</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684559430"><span class="hs-identifier hs-var">ploc</span></a></span><span>
</span><span id="line-310"></span><span>
</span><span id="line-311"></span><span>          </span><span class="hs-comment">-- Make the pattern unique where needed.</span><span>
</span><span id="line-312"></span><span>          </span><span id="local-6989586621684559429"><span class="annot"><span class="annottext">pat' :: PatBase Info VName
</span><a href="#local-6989586621684559429"><span class="hs-identifier hs-var hs-var">pat'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; PatBase Info VName
</span><a href="#local-6989586621684559463"><span class="hs-identifier hs-var">uniquePat</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684559475"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-313"></span><span>
</span><span id="line-314"></span><span>      </span><span id="local-6989586621684559428"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684559428"><span class="hs-identifier hs-var">pat_t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PatType -&gt; m PatType
forall a (m :: * -&gt; *). (Substitutable a, MonadUnify m) =&gt; a -&gt; m a
</span><a href="Language.Futhark.TypeChecker.Unify.html#normTypeFully"><span class="hs-identifier hs-var">normTypeFully</span></a></span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; m PatType) -&gt; PatType -&gt; m PatType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; PatType
</span><a href="Language.Futhark.Prop.html#patternType"><span class="hs-identifier hs-var">patternType</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684559429"><span class="hs-identifier hs-var">pat'</span></a></span><span>
</span><span id="line-315"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatType -&gt; TypeBase () ()
forall dim as. TypeBase dim as -&gt; TypeBase () ()
</span><a href="Language.Futhark.Prop.html#toStructural"><span class="hs-identifier hs-var">toStructural</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684559473"><span class="hs-identifier hs-var">body_t</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase () () -&gt; TypeBase () () -&gt; Bool
</span><a href="Language.Futhark.TypeChecker.Types.html#subtypeOf"><span class="hs-operator hs-var">`subtypeOf`</span></a></span><span> </span><span class="annot"><span class="annottext">PatType -&gt; TypeBase () ()
forall dim as. TypeBase dim as -&gt; TypeBase () ()
</span><a href="Language.Futhark.Prop.html#toStructural"><span class="hs-identifier hs-var">toStructural</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684559428"><span class="hs-identifier hs-var">pat_t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-316"></span><span>        </span><span class="annot"><span class="annottext">SrcLoc -&gt; StructType -&gt; [StructType] -&gt; m ()
forall (m :: * -&gt; *) a.
MonadTypeChecker m =&gt;
SrcLoc -&gt; StructType -&gt; [StructType] -&gt; m a
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#unexpectedType"><span class="hs-identifier hs-var">unexpectedType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">t -&gt; SrcLoc
forall a. Located a =&gt; a -&gt; SrcLoc
</span><span class="hs-identifier hs-var">srclocOf</span></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621684559472"><span class="hs-identifier hs-var">body_loc</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatType -&gt; StructType
forall dim as. TypeBase dim as -&gt; TypeBase dim ()
</span><a href="Language.Futhark.Prop.html#toStruct"><span class="hs-identifier hs-var">toStruct</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684559473"><span class="hs-identifier hs-var">body_t</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">PatType -&gt; StructType
forall dim as. TypeBase dim as -&gt; TypeBase dim ()
</span><a href="Language.Futhark.Prop.html#toStruct"><span class="hs-identifier hs-var">toStruct</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684559428"><span class="hs-identifier hs-var">pat_t</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-317"></span><span>
</span><span id="line-318"></span><span>      </span><span class="hs-comment">-- Check that the new values of consumed merge parameters do not</span><span>
</span><span id="line-319"></span><span>      </span><span class="hs-comment">-- alias something bound outside the loop, AND that anything</span><span>
</span><span id="line-320"></span><span>      </span><span class="hs-comment">-- returned for a unique merge parameter does not alias anything</span><span>
</span><span id="line-321"></span><span>      </span><span class="hs-comment">-- else returned.  We also update the aliases for the pattern.</span><span>
</span><span id="line-322"></span><span>      </span><span id="local-6989586621684559423"><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684559423"><span class="hs-identifier hs-var">bound_outside</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TermEnv -&gt; Set VName) -&gt; m (Set VName)
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">((TermEnv -&gt; Set VName) -&gt; m (Set VName))
-&gt; (TermEnv -&gt; Set VName) -&gt; m (Set VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Set VName
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">S.fromList</span></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; Set VName)
-&gt; (TermEnv -&gt; [VName]) -&gt; TermEnv -&gt; Set VName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Map VName ValBinding -&gt; [VName]
forall k a. Map k a -&gt; [k]
</span><span class="hs-identifier hs-var">M.keys</span></span><span> </span><span class="annot"><span class="annottext">(Map VName ValBinding -&gt; [VName])
-&gt; (TermEnv -&gt; Map VName ValBinding) -&gt; TermEnv -&gt; [VName]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TermScope -&gt; Map VName ValBinding
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#scopeVtable"><span class="hs-identifier hs-var hs-var">scopeVtable</span></a></span><span> </span><span class="annot"><span class="annottext">(TermScope -&gt; Map VName ValBinding)
-&gt; (TermEnv -&gt; TermScope) -&gt; TermEnv -&gt; Map VName ValBinding
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TermEnv -&gt; TermScope
</span><a href="Language.Futhark.TypeChecker.Terms.Monad.html#termScope"><span class="hs-identifier hs-var hs-var">termScope</span></a></span><span>
</span><span id="line-323"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684559414"><span class="annot"><span class="annottext">combAliases :: TypeBase dim ast -&gt; TypeBase shape ast -&gt; TypeBase dim ast
</span><a href="#local-6989586621684559414"><span class="hs-identifier hs-var hs-var">combAliases</span></a></span></span><span> </span><span id="local-6989586621684559413"><span class="annot"><span class="annottext">TypeBase dim ast
</span><a href="#local-6989586621684559413"><span class="hs-identifier hs-var">t1</span></a></span></span><span> </span><span id="local-6989586621684559412"><span class="annot"><span class="annottext">TypeBase shape ast
</span><a href="#local-6989586621684559412"><span class="hs-identifier hs-var">t2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-324"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TypeBase dim ast
</span><a href="#local-6989586621684559413"><span class="hs-identifier hs-var">t1</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-325"></span><span>              </span><span class="annot"><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#Record"><span class="hs-identifier hs-type">Record</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TypeBase dim ast
</span><a href="#local-6989586621684559413"><span class="hs-identifier hs-var">t1</span></a></span><span>
</span><span id="line-326"></span><span>              </span><span class="annot"><span class="annottext">TypeBase dim ast
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TypeBase dim ast
</span><a href="#local-6989586621684559413"><span class="hs-identifier hs-var">t1</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase dim ast -&gt; (ast -&gt; ast) -&gt; TypeBase dim ast
forall dim asf ast.
TypeBase dim asf -&gt; (asf -&gt; ast) -&gt; TypeBase dim ast
</span><a href="Language.Futhark.Prop.html#addAliases"><span class="hs-operator hs-var">`addAliases`</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ast -&gt; ast -&gt; ast
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">TypeBase shape ast -&gt; ast
forall as shape. Monoid as =&gt; TypeBase shape as -&gt; as
</span><a href="Language.Futhark.Prop.html#aliases"><span class="hs-identifier hs-var">aliases</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase shape ast
</span><a href="#local-6989586621684559412"><span class="hs-identifier hs-var">t2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-327"></span><span>
</span><span id="line-328"></span><span>          </span><span id="local-6989586621684559334"><span class="annot"><span class="annottext">checkMergeReturn :: PatBase Info vn -&gt; TypeBase dim Aliasing -&gt; t m (PatBase Info vn)
</span><a href="#local-6989586621684559334"><span class="hs-identifier hs-var hs-var">checkMergeReturn</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span id="local-6989586621684559333"><span class="annot"><span class="annottext">vn
</span><a href="#local-6989586621684559333"><span class="hs-identifier hs-var">pat_v</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-type">Info</span></a></span><span> </span><span id="local-6989586621684559332"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684559332"><span class="hs-identifier hs-var">pat_v_t</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684559331"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684559331"><span class="hs-identifier hs-var">patloc</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684559330"><span class="annot"><span class="annottext">TypeBase dim Aliasing
</span><a href="#local-6989586621684559330"><span class="hs-identifier hs-var">t</span></a></span></span><span>
</span><span id="line-329"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">PatType -&gt; Bool
forall shape as. TypeBase shape as -&gt; Bool
</span><a href="Language.Futhark.Prop.html#unique"><span class="hs-identifier hs-var">unique</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684559332"><span class="hs-identifier hs-var">pat_v_t</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-330"></span><span>              </span><span id="local-6989586621684559329"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684559329"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-331"></span><span>                </span><span class="annot"><span class="annottext">Set VName -&gt; [VName]
forall a. Set a -&gt; [a]
</span><span class="hs-identifier hs-var">S.toList</span></span><span> </span><span class="annot"><span class="annottext">(Set VName -&gt; [VName]) -&gt; Set VName -&gt; [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-332"></span><span>                  </span><span class="annot"><span class="annottext">(Alias -&gt; VName) -&gt; Aliasing -&gt; Set VName
forall b a. Ord b =&gt; (a -&gt; b) -&gt; Set a -&gt; Set b
</span><span class="hs-identifier hs-var">S.map</span></span><span> </span><span class="annot"><span class="annottext">Alias -&gt; VName
</span><a href="Language.Futhark.Syntax.html#aliasVar"><span class="hs-identifier hs-var hs-var">aliasVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeBase dim Aliasing -&gt; Aliasing
forall as shape. Monoid as =&gt; TypeBase shape as -&gt; as
</span><a href="Language.Futhark.Prop.html#aliases"><span class="hs-identifier hs-var">aliases</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase dim Aliasing
</span><a href="#local-6989586621684559330"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Set VName -&gt; Set VName -&gt; Set VName
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><span class="hs-operator hs-var">`S.intersection`</span></span><span> </span><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684559423"><span class="hs-identifier hs-var">bound_outside</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-333"></span><span>              </span><span class="annot"><span class="annottext">m (PatBase Info vn) -&gt; t m (PatBase Info vn)
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(m (PatBase Info vn) -&gt; t m (PatBase Info vn))
-&gt; (Doc -&gt; m (PatBase Info vn)) -&gt; Doc -&gt; t m (PatBase Info vn)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc -&gt; Notes -&gt; Doc -&gt; m (PatBase Info vn)
forall (m :: * -&gt; *) loc a.
(MonadTypeChecker m, Located loc) =&gt;
loc -&gt; Notes -&gt; Doc -&gt; m a
</span><a href="Language.Futhark.TypeChecker.Monad.html#typeError"><span class="hs-identifier hs-var">typeError</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684559746"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">Notes
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; t m (PatBase Info vn)) -&gt; Doc -&gt; t m (PatBase Info vn)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-334"></span><span>                </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Return value for loop parameter&quot;</span></span><span>
</span><span id="line-335"></span><span>                  </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><a href="Language.Futhark.Core.html#pquote"><span class="hs-identifier hs-var">pquote</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">vn -&gt; Doc
forall v. IsName v =&gt; v -&gt; Doc
</span><a href="Language.Futhark.Pretty.html#pprName"><span class="hs-identifier hs-var">pprName</span></a></span><span> </span><span class="annot"><span class="annottext">vn
</span><a href="#local-6989586621684559333"><span class="hs-identifier hs-var">pat_v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-336"></span><span>                  </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;aliases&quot;</span></span><span>
</span><span id="line-337"></span><span>                  </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Doc
forall v. IsName v =&gt; v -&gt; Doc
</span><a href="Language.Futhark.Pretty.html#pprName"><span class="hs-identifier hs-var">pprName</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684559329"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;.&quot;</span></span><span>
</span><span id="line-338"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-339"></span><span>              </span><span class="hs-special">(</span><span id="local-6989586621684559324"><span class="annot"><span class="annottext">Aliasing
</span><a href="#local-6989586621684559324"><span class="hs-identifier hs-var">cons</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684559323"><span class="annot"><span class="annottext">Aliasing
</span><a href="#local-6989586621684559323"><span class="hs-identifier hs-var">obs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">t m (Aliasing, Aliasing)
forall s (m :: * -&gt; *). MonadState s m =&gt; m s
</span><span class="hs-identifier hs-var">get</span></span><span>
</span><span id="line-340"></span><span>              </span><span class="annot"><span class="annottext">Bool -&gt; t m () -&gt; t m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Aliasing -&gt; Bool
forall a. Set a -&gt; Bool
</span><span class="hs-identifier hs-var">S.null</span></span><span> </span><span class="annot"><span class="annottext">(Aliasing -&gt; Bool) -&gt; Aliasing -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TypeBase dim Aliasing -&gt; Aliasing
forall as shape. Monoid as =&gt; TypeBase shape as -&gt; as
</span><a href="Language.Futhark.Prop.html#aliases"><span class="hs-identifier hs-var">aliases</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase dim Aliasing
</span><a href="#local-6989586621684559330"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Aliasing -&gt; Aliasing -&gt; Aliasing
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><span class="hs-operator hs-var">`S.intersection`</span></span><span> </span><span class="annot"><span class="annottext">Aliasing
</span><a href="#local-6989586621684559324"><span class="hs-identifier hs-var">cons</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(t m () -&gt; t m ()) -&gt; t m () -&gt; t m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-341"></span><span>                </span><span class="annot"><span class="annottext">m () -&gt; t m ()
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; t m ()) -&gt; (Doc -&gt; m ()) -&gt; Doc -&gt; t m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc -&gt; Notes -&gt; Doc -&gt; m ()
forall (m :: * -&gt; *) loc a.
(MonadTypeChecker m, Located loc) =&gt;
loc -&gt; Notes -&gt; Doc -&gt; m a
</span><a href="Language.Futhark.TypeChecker.Monad.html#typeError"><span class="hs-identifier hs-var">typeError</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684559746"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">Notes
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; t m ()) -&gt; Doc -&gt; t m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-342"></span><span>                  </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Return value for loop parameter&quot;</span></span><span>
</span><span id="line-343"></span><span>                    </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><a href="Language.Futhark.Core.html#pquote"><span class="hs-identifier hs-var">pquote</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">vn -&gt; Doc
forall v. IsName v =&gt; v -&gt; Doc
</span><a href="Language.Futhark.Pretty.html#pprName"><span class="hs-identifier hs-var">pprName</span></a></span><span> </span><span class="annot"><span class="annottext">vn
</span><a href="#local-6989586621684559333"><span class="hs-identifier hs-var">pat_v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-344"></span><span>                    </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;aliases other consumed loop parameter.&quot;</span></span><span>
</span><span id="line-345"></span><span>              </span><span class="annot"><span class="annottext">Bool -&gt; t m () -&gt; t m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span>
</span><span id="line-346"></span><span>                </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">PatType -&gt; Bool
forall shape as. TypeBase shape as -&gt; Bool
</span><a href="Language.Futhark.Prop.html#unique"><span class="hs-identifier hs-var">unique</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684559332"><span class="hs-identifier hs-var">pat_v_t</span></a></span><span>
</span><span id="line-347"></span><span>                    </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Aliasing -&gt; Bool
forall a. Set a -&gt; Bool
</span><span class="hs-identifier hs-var">S.null</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeBase dim Aliasing -&gt; Aliasing
forall as shape. Monoid as =&gt; TypeBase shape as -&gt; as
</span><a href="Language.Futhark.Prop.html#aliases"><span class="hs-identifier hs-var">aliases</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase dim Aliasing
</span><a href="#local-6989586621684559330"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Aliasing -&gt; Aliasing -&gt; Aliasing
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><span class="hs-operator hs-var">`S.intersection`</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Aliasing
</span><a href="#local-6989586621684559324"><span class="hs-identifier hs-var">cons</span></a></span><span> </span><span class="annot"><span class="annottext">Aliasing -&gt; Aliasing -&gt; Aliasing
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Aliasing
</span><a href="#local-6989586621684559323"><span class="hs-identifier hs-var">obs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-348"></span><span>                </span><span class="hs-special">)</span><span>
</span><span id="line-349"></span><span>                </span><span class="annot"><span class="annottext">(t m () -&gt; t m ()) -&gt; t m () -&gt; t m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">m () -&gt; t m ()
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; t m ()) -&gt; (Doc -&gt; m ()) -&gt; Doc -&gt; t m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc -&gt; Notes -&gt; Doc -&gt; m ()
forall (m :: * -&gt; *) loc a.
(MonadTypeChecker m, Located loc) =&gt;
loc -&gt; Notes -&gt; Doc -&gt; m a
</span><a href="Language.Futhark.TypeChecker.Monad.html#typeError"><span class="hs-identifier hs-var">typeError</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684559746"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">Notes
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; t m ()) -&gt; Doc -&gt; t m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-350"></span><span>                  </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;Return value for consuming loop parameter&quot;</span></span><span>
</span><span id="line-351"></span><span>                    </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><a href="Language.Futhark.Core.html#pquote"><span class="hs-identifier hs-var">pquote</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">vn -&gt; Doc
forall v. IsName v =&gt; v -&gt; Doc
</span><a href="Language.Futhark.Pretty.html#pprName"><span class="hs-identifier hs-var">pprName</span></a></span><span> </span><span class="annot"><span class="annottext">vn
</span><a href="#local-6989586621684559333"><span class="hs-identifier hs-var">pat_v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-352"></span><span>                    </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;aliases previously returned value.&quot;</span></span><span>
</span><span id="line-353"></span><span>              </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">PatType -&gt; Bool
forall shape as. TypeBase shape as -&gt; Bool
</span><a href="Language.Futhark.Prop.html#unique"><span class="hs-identifier hs-var">unique</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684559332"><span class="hs-identifier hs-var">pat_v_t</span></a></span><span>
</span><span id="line-354"></span><span>                </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">(Aliasing, Aliasing) -&gt; t m ()
forall s (m :: * -&gt; *). MonadState s m =&gt; s -&gt; m ()
</span><span class="hs-identifier hs-var">put</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Aliasing
</span><a href="#local-6989586621684559324"><span class="hs-identifier hs-var">cons</span></a></span><span> </span><span class="annot"><span class="annottext">Aliasing -&gt; Aliasing -&gt; Aliasing
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">TypeBase dim Aliasing -&gt; Aliasing
forall as shape. Monoid as =&gt; TypeBase shape as -&gt; as
</span><a href="Language.Futhark.Prop.html#aliases"><span class="hs-identifier hs-var">aliases</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase dim Aliasing
</span><a href="#local-6989586621684559330"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Aliasing
</span><a href="#local-6989586621684559323"><span class="hs-identifier hs-var">obs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-355"></span><span>                </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">(Aliasing, Aliasing) -&gt; t m ()
forall s (m :: * -&gt; *). MonadState s m =&gt; s -&gt; m ()
</span><span class="hs-identifier hs-var">put</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Aliasing
</span><a href="#local-6989586621684559324"><span class="hs-identifier hs-var">cons</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Aliasing
</span><a href="#local-6989586621684559323"><span class="hs-identifier hs-var">obs</span></a></span><span> </span><span class="annot"><span class="annottext">Aliasing -&gt; Aliasing -&gt; Aliasing
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">TypeBase dim Aliasing -&gt; Aliasing
forall as shape. Monoid as =&gt; TypeBase shape as -&gt; as
</span><a href="Language.Futhark.Prop.html#aliases"><span class="hs-identifier hs-var">aliases</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase dim Aliasing
</span><a href="#local-6989586621684559330"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-356"></span><span>
</span><span id="line-357"></span><span>              </span><span class="annot"><span class="annottext">PatBase Info vn -&gt; t m (PatBase Info vn)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(PatBase Info vn -&gt; t m (PatBase Info vn))
-&gt; PatBase Info vn -&gt; t m (PatBase Info vn)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">vn -&gt; Info PatType -&gt; SrcLoc -&gt; PatBase Info vn
forall (f :: * -&gt; *) vn. vn -&gt; f PatType -&gt; SrcLoc -&gt; PatBase f vn
</span><a href="Language.Futhark.Syntax.html#Id"><span class="hs-identifier hs-var">Id</span></a></span><span> </span><span class="annot"><span class="annottext">vn
</span><a href="#local-6989586621684559333"><span class="hs-identifier hs-var">pat_v</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatType -&gt; Info PatType
forall a. a -&gt; Info a
</span><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-var">Info</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatType -&gt; TypeBase dim Aliasing -&gt; PatType
forall {ast} {dim} {shape}.
Monoid ast =&gt;
TypeBase dim ast -&gt; TypeBase shape ast -&gt; TypeBase dim ast
</span><a href="#local-6989586621684559414"><span class="hs-identifier hs-var">combAliases</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684559332"><span class="hs-identifier hs-var">pat_v_t</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase dim Aliasing
</span><a href="#local-6989586621684559330"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684559331"><span class="hs-identifier hs-var">patloc</span></a></span><span>
</span><span id="line-358"></span><span>          </span><span class="annot"><a href="#local-6989586621684559334"><span class="hs-identifier hs-var">checkMergeReturn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Wildcard"><span class="hs-identifier hs-type">Wildcard</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-type">Info</span></a></span><span> </span><span id="local-6989586621684559316"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684559316"><span class="hs-identifier hs-var">pat_v_t</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684559315"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684559315"><span class="hs-identifier hs-var">patloc</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684559314"><span class="annot"><span class="annottext">TypeBase dim Aliasing
</span><a href="#local-6989586621684559314"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-359"></span><span>            </span><span class="annot"><span class="annottext">PatBase Info vn -&gt; t m (PatBase Info vn)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(PatBase Info vn -&gt; t m (PatBase Info vn))
-&gt; PatBase Info vn -&gt; t m (PatBase Info vn)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Info PatType -&gt; SrcLoc -&gt; PatBase Info vn
forall (f :: * -&gt; *) vn. f PatType -&gt; SrcLoc -&gt; PatBase f vn
</span><a href="Language.Futhark.Syntax.html#Wildcard"><span class="hs-identifier hs-var">Wildcard</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatType -&gt; Info PatType
forall a. a -&gt; Info a
</span><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-var">Info</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatType -&gt; TypeBase dim Aliasing -&gt; PatType
forall {ast} {dim} {shape}.
Monoid ast =&gt;
TypeBase dim ast -&gt; TypeBase shape ast -&gt; TypeBase dim ast
</span><a href="#local-6989586621684559414"><span class="hs-identifier hs-var">combAliases</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684559316"><span class="hs-identifier hs-var">pat_v_t</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase dim Aliasing
</span><a href="#local-6989586621684559314"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684559315"><span class="hs-identifier hs-var">patloc</span></a></span><span>
</span><span id="line-360"></span><span>          </span><span class="annot"><a href="#local-6989586621684559334"><span class="hs-identifier hs-var">checkMergeReturn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#PatParens"><span class="hs-identifier hs-type">PatParens</span></a></span><span> </span><span id="local-6989586621684559313"><span class="annot"><span class="annottext">PatBase Info vn
</span><a href="#local-6989586621684559313"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684559312"><span class="annot"><span class="annottext">TypeBase dim Aliasing
</span><a href="#local-6989586621684559312"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-361"></span><span>            </span><span class="annot"><span class="annottext">PatBase Info vn -&gt; TypeBase dim Aliasing -&gt; t m (PatBase Info vn)
</span><a href="#local-6989586621684559334"><span class="hs-identifier hs-var">checkMergeReturn</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info vn
</span><a href="#local-6989586621684559313"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase dim Aliasing
</span><a href="#local-6989586621684559312"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-362"></span><span>          </span><span class="annot"><a href="#local-6989586621684559334"><span class="hs-identifier hs-var">checkMergeReturn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#PatAscription"><span class="hs-identifier hs-type">PatAscription</span></a></span><span> </span><span id="local-6989586621684559311"><span class="annot"><span class="annottext">PatBase Info vn
</span><a href="#local-6989586621684559311"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="annot"><span class="annottext">TypeDeclBase Info vn
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684559310"><span class="annot"><span class="annottext">TypeBase dim Aliasing
</span><a href="#local-6989586621684559310"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-363"></span><span>            </span><span class="annot"><span class="annottext">PatBase Info vn -&gt; TypeBase dim Aliasing -&gt; t m (PatBase Info vn)
</span><a href="#local-6989586621684559334"><span class="hs-identifier hs-var">checkMergeReturn</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info vn
</span><a href="#local-6989586621684559311"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase dim Aliasing
</span><a href="#local-6989586621684559310"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-364"></span><span>          </span><span class="annot"><a href="#local-6989586621684559334"><span class="hs-identifier hs-var">checkMergeReturn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#RecordPat"><span class="hs-identifier hs-type">RecordPat</span></a></span><span> </span><span id="local-6989586621684559309"><span class="annot"><span class="annottext">[(Name, PatBase Info vn)]
</span><a href="#local-6989586621684559309"><span class="hs-identifier hs-var">pfs</span></a></span></span><span> </span><span id="local-6989586621684559308"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684559308"><span class="hs-identifier hs-var">patloc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Record"><span class="hs-identifier hs-type">Record</span></a></span><span> </span><span id="local-6989586621684559307"><span class="annot"><span class="annottext">Map Name (TypeBase dim Aliasing)
</span><a href="#local-6989586621684559307"><span class="hs-identifier hs-var">tfs</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-365"></span><span>            </span><span class="annot"><span class="annottext">[(Name, PatBase Info vn)] -&gt; SrcLoc -&gt; PatBase Info vn
forall (f :: * -&gt; *) vn.
[(Name, PatBase f vn)] -&gt; SrcLoc -&gt; PatBase f vn
</span><a href="Language.Futhark.Syntax.html#RecordPat"><span class="hs-identifier hs-var">RecordPat</span></a></span><span> </span><span class="annot"><span class="annottext">([(Name, PatBase Info vn)] -&gt; SrcLoc -&gt; PatBase Info vn)
-&gt; (Map Name (PatBase Info vn) -&gt; [(Name, PatBase Info vn)])
-&gt; Map Name (PatBase Info vn)
-&gt; SrcLoc
-&gt; PatBase Info vn
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Map Name (PatBase Info vn) -&gt; [(Name, PatBase Info vn)]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">M.toList</span></span><span> </span><span class="annot"><span class="annottext">(Map Name (PatBase Info vn) -&gt; SrcLoc -&gt; PatBase Info vn)
-&gt; t m (Map Name (PatBase Info vn))
-&gt; t m (SrcLoc -&gt; PatBase Info vn)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Map Name (t m (PatBase Info vn))
-&gt; t m (Map Name (PatBase Info vn))
forall (t :: * -&gt; *) (m :: * -&gt; *) a.
(Traversable t, Monad m) =&gt;
t (m a) -&gt; m (t a)
</span><span class="hs-identifier hs-var">sequence</span></span><span> </span><span class="annot"><span class="annottext">Map Name (t m (PatBase Info vn))
</span><a href="#local-6989586621684559305"><span class="hs-identifier hs-var">pfs'</span></a></span><span> </span><span class="annot"><span class="annottext">t m (SrcLoc -&gt; PatBase Info vn)
-&gt; t m SrcLoc -&gt; t m (PatBase Info vn)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc -&gt; t m SrcLoc
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684559308"><span class="hs-identifier hs-var">patloc</span></a></span><span>
</span><span id="line-366"></span><span>            </span><span class="hs-keyword">where</span><span>
</span><span id="line-367"></span><span>              </span><span id="local-6989586621684559305"><span class="annot"><span class="annottext">pfs' :: Map Name (t m (PatBase Info vn))
</span><a href="#local-6989586621684559305"><span class="hs-identifier hs-var hs-var">pfs'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(PatBase Info vn -&gt; TypeBase dim Aliasing -&gt; t m (PatBase Info vn))
-&gt; Map Name (PatBase Info vn)
-&gt; Map Name (TypeBase dim Aliasing)
-&gt; Map Name (t m (PatBase Info vn))
forall k a b c.
Ord k =&gt;
(a -&gt; b -&gt; c) -&gt; Map k a -&gt; Map k b -&gt; Map k c
</span><span class="hs-identifier hs-var">M.intersectionWith</span></span><span> </span><span class="annot"><span class="annottext">PatBase Info vn -&gt; TypeBase dim Aliasing -&gt; t m (PatBase Info vn)
</span><a href="#local-6989586621684559334"><span class="hs-identifier hs-var">checkMergeReturn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(Name, PatBase Info vn)] -&gt; Map Name (PatBase Info vn)
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="annot"><span class="annottext">[(Name, PatBase Info vn)]
</span><a href="#local-6989586621684559309"><span class="hs-identifier hs-var">pfs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map Name (TypeBase dim Aliasing)
</span><a href="#local-6989586621684559307"><span class="hs-identifier hs-var">tfs</span></a></span><span>
</span><span id="line-368"></span><span>          </span><span class="annot"><a href="#local-6989586621684559334"><span class="hs-identifier hs-var">checkMergeReturn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TuplePat"><span class="hs-identifier hs-type">TuplePat</span></a></span><span> </span><span id="local-6989586621684559299"><span class="annot"><span class="annottext">[PatBase Info vn]
</span><a href="#local-6989586621684559299"><span class="hs-identifier hs-var">pats</span></a></span></span><span> </span><span id="local-6989586621684559298"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684559298"><span class="hs-identifier hs-var">patloc</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684559297"><span class="annot"><span class="annottext">TypeBase dim Aliasing
</span><a href="#local-6989586621684559297"><span class="hs-identifier hs-var">t</span></a></span></span><span>
</span><span id="line-369"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684559296"><span class="annot"><span class="annottext">[TypeBase dim Aliasing]
</span><a href="#local-6989586621684559296"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TypeBase dim Aliasing -&gt; Maybe [TypeBase dim Aliasing]
forall dim as. TypeBase dim as -&gt; Maybe [TypeBase dim as]
</span><a href="Language.Futhark.Prop.html#isTupleRecord"><span class="hs-identifier hs-var">isTupleRecord</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase dim Aliasing
</span><a href="#local-6989586621684559297"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-370"></span><span>              </span><span class="annot"><span class="annottext">[PatBase Info vn] -&gt; SrcLoc -&gt; PatBase Info vn
forall (f :: * -&gt; *) vn. [PatBase f vn] -&gt; SrcLoc -&gt; PatBase f vn
</span><a href="Language.Futhark.Syntax.html#TuplePat"><span class="hs-identifier hs-var">TuplePat</span></a></span><span> </span><span class="annot"><span class="annottext">([PatBase Info vn] -&gt; SrcLoc -&gt; PatBase Info vn)
-&gt; t m [PatBase Info vn] -&gt; t m (SrcLoc -&gt; PatBase Info vn)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(PatBase Info vn -&gt; TypeBase dim Aliasing -&gt; t m (PatBase Info vn))
-&gt; [PatBase Info vn]
-&gt; [TypeBase dim Aliasing]
-&gt; t m [PatBase Info vn]
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m [c]
</span><span class="hs-identifier hs-var">zipWithM</span></span><span> </span><span class="annot"><span class="annottext">PatBase Info vn -&gt; TypeBase dim Aliasing -&gt; t m (PatBase Info vn)
</span><a href="#local-6989586621684559334"><span class="hs-identifier hs-var">checkMergeReturn</span></a></span><span> </span><span class="annot"><span class="annottext">[PatBase Info vn]
</span><a href="#local-6989586621684559299"><span class="hs-identifier hs-var">pats</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeBase dim Aliasing]
</span><a href="#local-6989586621684559296"><span class="hs-identifier hs-var">ts</span></a></span><span> </span><span class="annot"><span class="annottext">t m (SrcLoc -&gt; PatBase Info vn)
-&gt; t m SrcLoc -&gt; t m (PatBase Info vn)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc -&gt; t m SrcLoc
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684559298"><span class="hs-identifier hs-var">patloc</span></a></span><span>
</span><span id="line-371"></span><span>          </span><span class="annot"><a href="#local-6989586621684559334"><span class="hs-identifier hs-var">checkMergeReturn</span></a></span><span> </span><span id="local-6989586621684559294"><span class="annot"><span class="annottext">PatBase Info vn
</span><a href="#local-6989586621684559294"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="annot"><span class="annottext">TypeBase dim Aliasing
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-372"></span><span>            </span><span class="annot"><span class="annottext">PatBase Info vn -&gt; t m (PatBase Info vn)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">PatBase Info vn
</span><a href="#local-6989586621684559294"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-373"></span><span>
</span><span id="line-374"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684559293"><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684559293"><span class="hs-identifier hs-var">pat''</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684559292"><span class="annot"><span class="annottext">Aliasing
</span><a href="#local-6989586621684559292"><span class="hs-identifier hs-var">pat_cons</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Aliasing
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-375"></span><span>        </span><span class="annot"><span class="annottext">StateT (Aliasing, Aliasing) m (PatBase Info VName)
-&gt; (Aliasing, Aliasing)
-&gt; m (PatBase Info VName, (Aliasing, Aliasing))
forall s (m :: * -&gt; *) a. StateT s m a -&gt; s -&gt; m (a, s)
</span><span class="hs-identifier hs-var hs-var">runStateT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatBase Info VName
-&gt; PatType -&gt; StateT (Aliasing, Aliasing) m (PatBase Info VName)
forall {t :: (* -&gt; *) -&gt; * -&gt; *} {m :: * -&gt; *} {vn} {dim}.
(MonadTrans t, MonadTypeChecker m, IsName vn,
 MonadState (Aliasing, Aliasing) (t m)) =&gt;
PatBase Info vn -&gt; TypeBase dim Aliasing -&gt; t m (PatBase Info vn)
</span><a href="#local-6989586621684559334"><span class="hs-identifier hs-var">checkMergeReturn</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684559429"><span class="hs-identifier hs-var">pat'</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684559473"><span class="hs-identifier hs-var">body_t</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Aliasing
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Aliasing
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span>
</span><span id="line-376"></span><span>
</span><span id="line-377"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684559288"><span class="annot"><span class="annottext">body_cons' :: Set VName
</span><a href="#local-6989586621684559288"><span class="hs-identifier hs-var hs-var">body_cons'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684559474"><span class="hs-identifier hs-var">body_cons</span></a></span><span> </span><span class="annot"><span class="annottext">Set VName -&gt; Set VName -&gt; Set VName
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Alias -&gt; VName) -&gt; Aliasing -&gt; Set VName
forall b a. Ord b =&gt; (a -&gt; b) -&gt; Set a -&gt; Set b
</span><span class="hs-identifier hs-var">S.map</span></span><span> </span><span class="annot"><span class="annottext">Alias -&gt; VName
</span><a href="Language.Futhark.Syntax.html#aliasVar"><span class="hs-identifier hs-var hs-var">aliasVar</span></a></span><span> </span><span class="annot"><span class="annottext">Aliasing
</span><a href="#local-6989586621684559292"><span class="hs-identifier hs-var">pat_cons</span></a></span><span>
</span><span id="line-378"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684559288"><span class="hs-identifier hs-var">body_cons'</span></a></span><span> </span><span class="annot"><span class="annottext">Set VName -&gt; Set VName -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684559474"><span class="hs-identifier hs-var">body_cons</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; PatType
</span><a href="Language.Futhark.Prop.html#patternType"><span class="hs-identifier hs-var">patternType</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684559293"><span class="hs-identifier hs-var">pat''</span></a></span><span> </span><span class="annot"><span class="annottext">PatType -&gt; PatType -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; PatType
</span><a href="Language.Futhark.Prop.html#patternType"><span class="hs-identifier hs-var">patternType</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684559475"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-379"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; m (PatBase Info VName)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684559429"><span class="hs-identifier hs-var">pat'</span></a></span><span>
</span><span id="line-380"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
-&gt; Set VName -&gt; PatType -&gt; t -&gt; m (PatBase Info VName)
</span><a href="#local-6989586621684559576"><span class="hs-identifier hs-var">convergePat</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684559293"><span class="hs-identifier hs-var">pat''</span></a></span><span> </span><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684559288"><span class="hs-identifier hs-var">body_cons'</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684559473"><span class="hs-identifier hs-var">body_t</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621684559472"><span class="hs-identifier hs-var">body_loc</span></a></span><span>
</span><span id="line-381"></span></pre></body></html>