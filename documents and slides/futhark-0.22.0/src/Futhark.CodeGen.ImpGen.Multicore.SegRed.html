<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Futhark.CodeGen.ImpGen.Multicore.SegRed</span><span>
</span><span id="line-2"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#compileSegRed"><span class="hs-identifier">compileSegRed</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-3"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#compileSegRed%27"><span class="hs-identifier">compileSegRed'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-4"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-5"></span><span class="hs-keyword">where</span><span>
</span><span id="line-6"></span><span>
</span><span id="line-7"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span>
</span><span id="line-8"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.Multicore.html"><span class="hs-identifier">Futhark.CodeGen.ImpCode.Multicore</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Imp</span></span><span>
</span><span id="line-9"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html"><span class="hs-identifier">Futhark.CodeGen.ImpGen</span></a></span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html"><span class="hs-identifier">Futhark.CodeGen.ImpGen.Multicore.Base</span></a></span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html"><span class="hs-identifier">Futhark.IR.MCMem</span></a></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Util.html"><span class="hs-identifier">Futhark.Util</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Util.html#chunks"><span class="hs-identifier">chunks</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Prelude</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">quot</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">rem</span></span><span class="hs-special">)</span><span>
</span><span id="line-14"></span><span>
</span><span id="line-15"></span><span class="hs-keyword">type</span><span> </span><span id="DoSegBody"><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#DoSegBody"><span class="hs-identifier hs-var">DoSegBody</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#MulticoreGen"><span class="hs-identifier hs-type">MulticoreGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#MulticoreGen"><span class="hs-identifier hs-type">MulticoreGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-16"></span><span>
</span><span id="line-17"></span><span class="hs-comment">-- | Generate code for a SegRed construct</span><span>
</span><span id="line-18"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#compileSegRed"><span class="hs-identifier hs-type">compileSegRed</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-19"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-20"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegSpace"><span class="hs-identifier hs-type">SegSpace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-21"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.SegOp.html#SegBinOp"><span class="hs-identifier hs-type">SegBinOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-22"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-type">KernelBody</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-23"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#TV"><span class="hs-identifier hs-type">TV</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-24"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#MulticoreGen"><span class="hs-identifier hs-type">MulticoreGen</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.Multicore.html#Code"><span class="hs-identifier hs-type">Imp.Code</span></a></span><span>
</span><span id="line-25"></span><span id="compileSegRed"><span class="annot"><span class="annottext">compileSegRed :: Pat MCMem
-&gt; SegSpace
-&gt; [SegBinOp MCMem]
-&gt; KernelBody MCMem
-&gt; TV Int32
-&gt; MulticoreGen Code
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#compileSegRed"><span class="hs-identifier hs-var hs-var">compileSegRed</span></a></span></span><span> </span><span id="local-6989586621684532913"><span class="annot"><span class="annottext">Pat MCMem
</span><a href="#local-6989586621684532913"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684532912"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684532912"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684532911"><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532911"><span class="hs-identifier hs-var">reds</span></a></span></span><span> </span><span id="local-6989586621684532910"><span class="annot"><span class="annottext">KernelBody MCMem
</span><a href="#local-6989586621684532910"><span class="hs-identifier hs-var">kbody</span></a></span></span><span> </span><span id="local-6989586621684532909"><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684532909"><span class="hs-identifier hs-var">nsubtasks</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-26"></span><span>  </span><span class="annot"><span class="annottext">Pat MCMem
-&gt; SegSpace
-&gt; [SegBinOp MCMem]
-&gt; TV Int32
-&gt; DoSegBody
-&gt; MulticoreGen Code
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#compileSegRed%27"><span class="hs-identifier hs-var">compileSegRed'</span></a></span><span> </span><span class="annot"><span class="annottext">Pat MCMem
</span><a href="#local-6989586621684532913"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684532912"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532911"><span class="hs-identifier hs-var">reds</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684532909"><span class="hs-identifier hs-var">nsubtasks</span></a></span><span> </span><span class="annot"><span class="annottext">(DoSegBody -&gt; MulticoreGen Code) -&gt; DoSegBody -&gt; MulticoreGen Code
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684532908"><span class="annot"><span class="annottext">[(SubExp, [TExp Int64])] -&gt; MulticoreGen ()
</span><a href="#local-6989586621684532908"><span class="hs-identifier hs-var">red_cont</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-27"></span><span>    </span><span class="annot"><span class="annottext">Names -&gt; Stms MCMem -&gt; MulticoreGen () -&gt; MulticoreGen ()
forall rep r op.
Names -&gt; Stms rep -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileStms"><span class="hs-identifier hs-var">compileStms</span></a></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelBody MCMem -&gt; Stms MCMem
forall rep. KernelBody rep -&gt; Stms rep
</span><a href="Futhark.IR.SegOp.html#kernelBodyStms"><span class="hs-identifier hs-var hs-var">kernelBodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody MCMem
</span><a href="#local-6989586621684532910"><span class="hs-identifier hs-var">kbody</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(MulticoreGen () -&gt; MulticoreGen ())
-&gt; MulticoreGen () -&gt; MulticoreGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-28"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684532905"><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684532905"><span class="hs-identifier hs-var">red_res</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532904"><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684532904"><span class="hs-identifier hs-var">map_res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [KernelResult] -&gt; ([KernelResult], [KernelResult])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SegBinOp MCMem] -&gt; Int
forall rep. [SegBinOp rep] -&gt; Int
</span><a href="Futhark.IR.SegOp.html#segBinOpResults"><span class="hs-identifier hs-var">segBinOpResults</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532911"><span class="hs-identifier hs-var">reds</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([KernelResult] -&gt; ([KernelResult], [KernelResult]))
-&gt; [KernelResult] -&gt; ([KernelResult], [KernelResult])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KernelBody MCMem -&gt; [KernelResult]
forall rep. KernelBody rep -&gt; [KernelResult]
</span><a href="Futhark.IR.SegOp.html#kernelBodyResult"><span class="hs-identifier hs-var hs-var">kernelBodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody MCMem
</span><a href="#local-6989586621684532910"><span class="hs-identifier hs-var">kbody</span></a></span><span>
</span><span id="line-29"></span><span>
</span><span id="line-30"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; MulticoreGen () -&gt; MulticoreGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;save map-out results&quot;</span></span><span> </span><span class="annot"><span class="annottext">(MulticoreGen () -&gt; MulticoreGen ())
-&gt; MulticoreGen () -&gt; MulticoreGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-31"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684532899"><span class="annot"><span class="annottext">map_arrs :: [PatElemT LParamMem]
</span><a href="#local-6989586621684532899"><span class="hs-identifier hs-var hs-var">map_arrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [PatElemT LParamMem] -&gt; [PatElemT LParamMem]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SegBinOp MCMem] -&gt; Int
forall rep. [SegBinOp rep] -&gt; Int
</span><a href="Futhark.IR.SegOp.html#segBinOpResults"><span class="hs-identifier hs-var">segBinOpResults</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532911"><span class="hs-identifier hs-var">reds</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([PatElemT LParamMem] -&gt; [PatElemT LParamMem])
-&gt; [PatElemT LParamMem] -&gt; [PatElemT LParamMem]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatT LParamMem -&gt; [PatElemT LParamMem]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span> </span><span class="annot"><span class="annottext">Pat MCMem
PatT LParamMem
</span><a href="#local-6989586621684532913"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-32"></span><span>        </span><span class="annot"><span class="annottext">(PatElemT LParamMem -&gt; KernelResult -&gt; MulticoreGen ())
-&gt; [PatElemT LParamMem] -&gt; [KernelResult] -&gt; MulticoreGen ()
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m ()
</span><span class="hs-identifier hs-var">zipWithM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegSpace -&gt; PatElem MCMem -&gt; KernelResult -&gt; MulticoreGen ()
</span><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#compileThreadResult"><span class="hs-identifier hs-var">compileThreadResult</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684532912"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684532899"><span class="hs-identifier hs-var">map_arrs</span></a></span><span> </span><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684532904"><span class="hs-identifier hs-var">map_res</span></a></span><span>
</span><span id="line-33"></span><span>
</span><span id="line-34"></span><span>      </span><span class="annot"><span class="annottext">[(SubExp, [TExp Int64])] -&gt; MulticoreGen ()
</span><a href="#local-6989586621684532908"><span class="hs-identifier hs-var">red_cont</span></a></span><span> </span><span class="annot"><span class="annottext">([(SubExp, [TExp Int64])] -&gt; MulticoreGen ())
-&gt; [(SubExp, [TExp Int64])] -&gt; MulticoreGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; [[TExp Int64]] -&gt; [(SubExp, [TExp Int64])]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(KernelResult -&gt; SubExp) -&gt; [KernelResult] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">KernelResult -&gt; SubExp
</span><a href="Futhark.IR.SegOp.html#kernelResultSubExp"><span class="hs-identifier hs-var">kernelResultSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684532905"><span class="hs-identifier hs-var">red_res</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([[TExp Int64]] -&gt; [(SubExp, [TExp Int64])])
-&gt; [[TExp Int64]] -&gt; [(SubExp, [TExp Int64])]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; [[TExp Int64]]
forall a. a -&gt; [a]
</span><span class="hs-identifier hs-var">repeat</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-35"></span><span>
</span><span id="line-36"></span><span class="hs-comment">-- | Like 'compileSegRed', but where the body is a monadic action.</span><span>
</span><span id="line-37"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#compileSegRed%27"><span class="hs-identifier hs-type">compileSegRed'</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-38"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-39"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegSpace"><span class="hs-identifier hs-type">SegSpace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-40"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.SegOp.html#SegBinOp"><span class="hs-identifier hs-type">SegBinOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-41"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#TV"><span class="hs-identifier hs-type">TV</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-42"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#DoSegBody"><span class="hs-identifier hs-type">DoSegBody</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-43"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#MulticoreGen"><span class="hs-identifier hs-type">MulticoreGen</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.Multicore.html#Code"><span class="hs-identifier hs-type">Imp.Code</span></a></span><span>
</span><span id="line-44"></span><span id="compileSegRed%27"><span class="annot"><span class="annottext">compileSegRed' :: Pat MCMem
-&gt; SegSpace
-&gt; [SegBinOp MCMem]
-&gt; TV Int32
-&gt; DoSegBody
-&gt; MulticoreGen Code
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#compileSegRed%27"><span class="hs-identifier hs-var hs-var">compileSegRed'</span></a></span></span><span> </span><span id="local-6989586621684532892"><span class="annot"><span class="annottext">Pat MCMem
</span><a href="#local-6989586621684532892"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684532891"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684532891"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684532890"><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532890"><span class="hs-identifier hs-var">reds</span></a></span></span><span> </span><span id="local-6989586621684532889"><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684532889"><span class="hs-identifier hs-var">nsubtasks</span></a></span></span><span> </span><span id="local-6989586621684532888"><span class="annot"><span class="annottext">DoSegBody
</span><a href="#local-6989586621684532888"><span class="hs-identifier hs-var">kbody</span></a></span></span><span>
</span><span id="line-45"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">(VName, SubExp)
</span><span class="hs-identifier">_</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; [(VName, SubExp)]
</span><a href="Futhark.IR.SegOp.html#unSegSpace"><span class="hs-identifier hs-var hs-var">unSegSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684532891"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-46"></span><span>    </span><span class="annot"><span class="annottext">Pat MCMem
-&gt; SegSpace
-&gt; [SegBinOp MCMem]
-&gt; TV Int32
-&gt; DoSegBody
-&gt; MulticoreGen Code
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#nonsegmentedReduction"><span class="hs-identifier hs-var">nonsegmentedReduction</span></a></span><span> </span><span class="annot"><span class="annottext">Pat MCMem
</span><a href="#local-6989586621684532892"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684532891"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532890"><span class="hs-identifier hs-var">reds</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684532889"><span class="hs-identifier hs-var">nsubtasks</span></a></span><span> </span><span class="annot"><span class="annottext">DoSegBody
</span><a href="#local-6989586621684532888"><span class="hs-identifier hs-var">kbody</span></a></span><span>
</span><span id="line-47"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-48"></span><span>    </span><span class="annot"><span class="annottext">Pat MCMem
-&gt; SegSpace -&gt; [SegBinOp MCMem] -&gt; DoSegBody -&gt; MulticoreGen Code
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#segmentedReduction"><span class="hs-identifier hs-var">segmentedReduction</span></a></span><span> </span><span class="annot"><span class="annottext">Pat MCMem
</span><a href="#local-6989586621684532892"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684532891"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532890"><span class="hs-identifier hs-var">reds</span></a></span><span> </span><span class="annot"><span class="annottext">DoSegBody
</span><a href="#local-6989586621684532888"><span class="hs-identifier hs-var">kbody</span></a></span><span>
</span><span id="line-49"></span><span>
</span><span id="line-50"></span><span class="hs-comment">-- | A SegBinOp with auxiliary information.</span><span>
</span><span id="line-51"></span><span class="hs-keyword">data</span><span> </span><span id="SegBinOpSlug"><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#SegBinOpSlug"><span class="hs-identifier hs-var">SegBinOpSlug</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="SegBinOpSlug"><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#SegBinOpSlug"><span class="hs-identifier hs-var">SegBinOpSlug</span></a></span></span><span>
</span><span id="line-52"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="slugOp"><span class="annot"><span class="annottext">SegBinOpSlug -&gt; SegBinOp MCMem
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#slugOp"><span class="hs-identifier hs-var hs-var">slugOp</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegBinOp"><span class="hs-identifier hs-type">SegBinOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-53"></span><span>    </span><span class="hs-comment">-- | The array in which we write the intermediate results, indexed</span><span>
</span><span id="line-54"></span><span>    </span><span class="hs-comment">-- by the flat/physical thread ID.</span><span>
</span><span id="line-55"></span><span>    </span><span id="slugResArrs"><span class="annot"><span class="annottext">SegBinOpSlug -&gt; [VName]
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#slugResArrs"><span class="hs-identifier hs-var hs-var">slugResArrs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-56"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-57"></span><span>
</span><span id="line-58"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#slugBody"><span class="hs-identifier hs-type">slugBody</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#SegBinOpSlug"><span class="hs-identifier hs-type">SegBinOpSlug</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span>
</span><span id="line-59"></span><span id="slugBody"><span class="annot"><span class="annottext">slugBody :: SegBinOpSlug -&gt; Body MCMem
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#slugBody"><span class="hs-identifier hs-var hs-var">slugBody</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LambdaT MCMem -&gt; Body MCMem
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">(LambdaT MCMem -&gt; Body MCMem)
-&gt; (SegBinOpSlug -&gt; LambdaT MCMem) -&gt; SegBinOpSlug -&gt; Body MCMem
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; LambdaT MCMem
forall rep. SegBinOp rep -&gt; Lambda rep
</span><a href="Futhark.IR.SegOp.html#segBinOpLambda"><span class="hs-identifier hs-var hs-var">segBinOpLambda</span></a></span><span> </span><span class="annot"><span class="annottext">(SegBinOp MCMem -&gt; LambdaT MCMem)
-&gt; (SegBinOpSlug -&gt; SegBinOp MCMem)
-&gt; SegBinOpSlug
-&gt; LambdaT MCMem
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; SegBinOp MCMem
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#slugOp"><span class="hs-identifier hs-var hs-var">slugOp</span></a></span><span>
</span><span id="line-60"></span><span>
</span><span id="line-61"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#slugParams"><span class="hs-identifier hs-type">slugParams</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#SegBinOpSlug"><span class="hs-identifier hs-type">SegBinOpSlug</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#LParam"><span class="hs-identifier hs-type">LParam</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-62"></span><span id="slugParams"><span class="annot"><span class="annottext">slugParams :: SegBinOpSlug -&gt; [LParam MCMem]
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#slugParams"><span class="hs-identifier hs-var hs-var">slugParams</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LambdaT MCMem -&gt; [Param LParamMem]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">(LambdaT MCMem -&gt; [Param LParamMem])
-&gt; (SegBinOpSlug -&gt; LambdaT MCMem)
-&gt; SegBinOpSlug
-&gt; [Param LParamMem]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; LambdaT MCMem
forall rep. SegBinOp rep -&gt; Lambda rep
</span><a href="Futhark.IR.SegOp.html#segBinOpLambda"><span class="hs-identifier hs-var hs-var">segBinOpLambda</span></a></span><span> </span><span class="annot"><span class="annottext">(SegBinOp MCMem -&gt; LambdaT MCMem)
-&gt; (SegBinOpSlug -&gt; SegBinOp MCMem)
-&gt; SegBinOpSlug
-&gt; LambdaT MCMem
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; SegBinOp MCMem
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#slugOp"><span class="hs-identifier hs-var hs-var">slugOp</span></a></span><span>
</span><span id="line-63"></span><span>
</span><span id="line-64"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#slugNeutral"><span class="hs-identifier hs-type">slugNeutral</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#SegBinOpSlug"><span class="hs-identifier hs-type">SegBinOpSlug</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-65"></span><span id="slugNeutral"><span class="annot"><span class="annottext">slugNeutral :: SegBinOpSlug -&gt; [SubExp]
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#slugNeutral"><span class="hs-identifier hs-var hs-var">slugNeutral</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; [SubExp]
forall rep. SegBinOp rep -&gt; [SubExp]
</span><a href="Futhark.IR.SegOp.html#segBinOpNeutral"><span class="hs-identifier hs-var hs-var">segBinOpNeutral</span></a></span><span> </span><span class="annot"><span class="annottext">(SegBinOp MCMem -&gt; [SubExp])
-&gt; (SegBinOpSlug -&gt; SegBinOp MCMem) -&gt; SegBinOpSlug -&gt; [SubExp]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; SegBinOp MCMem
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#slugOp"><span class="hs-identifier hs-var hs-var">slugOp</span></a></span><span>
</span><span id="line-66"></span><span>
</span><span id="line-67"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#slugShape"><span class="hs-identifier hs-type">slugShape</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#SegBinOpSlug"><span class="hs-identifier hs-type">SegBinOpSlug</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-type">Shape</span></a></span><span>
</span><span id="line-68"></span><span id="slugShape"><span class="annot"><span class="annottext">slugShape :: SegBinOpSlug -&gt; Shape
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#slugShape"><span class="hs-identifier hs-var hs-var">slugShape</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; Shape
forall rep. SegBinOp rep -&gt; Shape
</span><a href="Futhark.IR.SegOp.html#segBinOpShape"><span class="hs-identifier hs-var hs-var">segBinOpShape</span></a></span><span> </span><span class="annot"><span class="annottext">(SegBinOp MCMem -&gt; Shape)
-&gt; (SegBinOpSlug -&gt; SegBinOp MCMem) -&gt; SegBinOpSlug -&gt; Shape
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; SegBinOp MCMem
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#slugOp"><span class="hs-identifier hs-var hs-var">slugOp</span></a></span><span>
</span><span id="line-69"></span><span>
</span><span id="line-70"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#accParams"><span class="hs-identifier hs-type">accParams</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#nextParams"><span class="hs-identifier hs-type">nextParams</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#SegBinOpSlug"><span class="hs-identifier hs-type">SegBinOpSlug</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#LParam"><span class="hs-identifier hs-type">LParam</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-71"></span><span id="accParams"><span class="annot"><span class="annottext">accParams :: SegBinOpSlug -&gt; [LParam MCMem]
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#accParams"><span class="hs-identifier hs-var hs-var">accParams</span></a></span></span><span> </span><span id="local-6989586621684532869"><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684532869"><span class="hs-identifier hs-var">slug</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Param LParamMem] -&gt; [Param LParamMem]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">take</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; [SubExp]
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#slugNeutral"><span class="hs-identifier hs-var">slugNeutral</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684532869"><span class="hs-identifier hs-var">slug</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Param LParamMem] -&gt; [Param LParamMem])
-&gt; [Param LParamMem] -&gt; [Param LParamMem]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; [LParam MCMem]
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#slugParams"><span class="hs-identifier hs-var">slugParams</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684532869"><span class="hs-identifier hs-var">slug</span></a></span><span>
</span><span id="line-72"></span><span id="nextParams"><span class="annot"><span class="annottext">nextParams :: SegBinOpSlug -&gt; [LParam MCMem]
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#nextParams"><span class="hs-identifier hs-var hs-var">nextParams</span></a></span></span><span> </span><span id="local-6989586621684532866"><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684532866"><span class="hs-identifier hs-var">slug</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Param LParamMem] -&gt; [Param LParamMem]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; [SubExp]
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#slugNeutral"><span class="hs-identifier hs-var">slugNeutral</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684532866"><span class="hs-identifier hs-var">slug</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Param LParamMem] -&gt; [Param LParamMem])
-&gt; [Param LParamMem] -&gt; [Param LParamMem]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; [LParam MCMem]
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#slugParams"><span class="hs-identifier hs-var">slugParams</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684532866"><span class="hs-identifier hs-var">slug</span></a></span><span>
</span><span id="line-73"></span><span>
</span><span id="line-74"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#nonsegmentedReduction"><span class="hs-identifier hs-type">nonsegmentedReduction</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-75"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-76"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegSpace"><span class="hs-identifier hs-type">SegSpace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-77"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.SegOp.html#SegBinOp"><span class="hs-identifier hs-type">SegBinOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-78"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#TV"><span class="hs-identifier hs-type">TV</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-79"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#DoSegBody"><span class="hs-identifier hs-type">DoSegBody</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-80"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#MulticoreGen"><span class="hs-identifier hs-type">MulticoreGen</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.Multicore.html#Code"><span class="hs-identifier hs-type">Imp.Code</span></a></span><span>
</span><span id="line-81"></span><span id="nonsegmentedReduction"><span class="annot"><span class="annottext">nonsegmentedReduction :: Pat MCMem
-&gt; SegSpace
-&gt; [SegBinOp MCMem]
-&gt; TV Int32
-&gt; DoSegBody
-&gt; MulticoreGen Code
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#nonsegmentedReduction"><span class="hs-identifier hs-var hs-var">nonsegmentedReduction</span></a></span></span><span> </span><span id="local-6989586621684532865"><span class="annot"><span class="annottext">Pat MCMem
</span><a href="#local-6989586621684532865"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684532864"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684532864"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684532863"><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532863"><span class="hs-identifier hs-var">reds</span></a></span></span><span> </span><span id="local-6989586621684532862"><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684532862"><span class="hs-identifier hs-var">nsubtasks</span></a></span></span><span> </span><span id="local-6989586621684532861"><span class="annot"><span class="annottext">DoSegBody
</span><a href="#local-6989586621684532861"><span class="hs-identifier hs-var">kbody</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MulticoreGen () -&gt; MulticoreGen Code
forall rep r op. ImpM rep r op () -&gt; ImpM rep r op (Code op)
</span><a href="Futhark.CodeGen.ImpGen.html#collect"><span class="hs-identifier hs-var">collect</span></a></span><span> </span><span class="annot"><span class="annottext">(MulticoreGen () -&gt; MulticoreGen Code)
-&gt; MulticoreGen () -&gt; MulticoreGen Code
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-82"></span><span>  </span><span id="local-6989586621684532859"><span class="annot"><span class="annottext">[[VName]]
</span><a href="#local-6989586621684532859"><span class="hs-identifier hs-var">thread_res_arrs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; SubExp -&gt; [SegBinOp MCMem] -&gt; MulticoreGen [[VName]]
</span><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#groupResultArrays"><span class="hs-identifier hs-var">groupResultArrays</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;reduce_stage_1_tid_res_arr&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int32 -&gt; SubExp
forall t. TV t -&gt; SubExp
</span><a href="Futhark.CodeGen.ImpGen.html#tvSize"><span class="hs-identifier hs-var">tvSize</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684532862"><span class="hs-identifier hs-var">nsubtasks</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532863"><span class="hs-identifier hs-var">reds</span></a></span><span>
</span><span id="line-83"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684532856"><span class="annot"><span class="annottext">slugs1 :: [SegBinOpSlug]
</span><a href="#local-6989586621684532856"><span class="hs-identifier hs-var hs-var">slugs1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SegBinOp MCMem -&gt; [VName] -&gt; SegBinOpSlug)
-&gt; [SegBinOp MCMem] -&gt; [[VName]] -&gt; [SegBinOpSlug]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; [VName] -&gt; SegBinOpSlug
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#SegBinOpSlug"><span class="hs-identifier hs-var">SegBinOpSlug</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532863"><span class="hs-identifier hs-var">reds</span></a></span><span> </span><span class="annot"><span class="annottext">[[VName]]
</span><a href="#local-6989586621684532859"><span class="hs-identifier hs-var">thread_res_arrs</span></a></span><span>
</span><span id="line-84"></span><span>      </span><span id="local-6989586621684532854"><span class="annot"><span class="annottext">nsubtasks' :: TExp Int32
</span><a href="#local-6989586621684532854"><span class="hs-identifier hs-var hs-var">nsubtasks'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TV Int32 -&gt; TExp Int32
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684532862"><span class="hs-identifier hs-var">nsubtasks</span></a></span><span>
</span><span id="line-85"></span><span>
</span><span id="line-86"></span><span>  </span><span class="annot"><span class="annottext">SegSpace -&gt; [SegBinOpSlug] -&gt; DoSegBody -&gt; MulticoreGen ()
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#reductionStage1"><span class="hs-identifier hs-var">reductionStage1</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684532864"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOpSlug]
</span><a href="#local-6989586621684532856"><span class="hs-identifier hs-var">slugs1</span></a></span><span> </span><span class="annot"><span class="annottext">DoSegBody
</span><a href="#local-6989586621684532861"><span class="hs-identifier hs-var">kbody</span></a></span><span>
</span><span id="line-87"></span><span>  </span><span id="local-6989586621684532851"><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532851"><span class="hs-identifier hs-var">reds2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem] -&gt; MulticoreGen [SegBinOp MCMem]
</span><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#renameSegBinOp"><span class="hs-identifier hs-var">renameSegBinOp</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532863"><span class="hs-identifier hs-var">reds</span></a></span><span>
</span><span id="line-88"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684532849"><span class="annot"><span class="annottext">slugs2 :: [SegBinOpSlug]
</span><a href="#local-6989586621684532849"><span class="hs-identifier hs-var hs-var">slugs2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SegBinOp MCMem -&gt; [VName] -&gt; SegBinOpSlug)
-&gt; [SegBinOp MCMem] -&gt; [[VName]] -&gt; [SegBinOpSlug]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; [VName] -&gt; SegBinOpSlug
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#SegBinOpSlug"><span class="hs-identifier hs-var">SegBinOpSlug</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532851"><span class="hs-identifier hs-var">reds2</span></a></span><span> </span><span class="annot"><span class="annottext">[[VName]]
</span><a href="#local-6989586621684532859"><span class="hs-identifier hs-var">thread_res_arrs</span></a></span><span>
</span><span id="line-89"></span><span>  </span><span class="annot"><span class="annottext">Pat MCMem
-&gt; SegSpace -&gt; TExp Int32 -&gt; [SegBinOpSlug] -&gt; MulticoreGen ()
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#reductionStage2"><span class="hs-identifier hs-var">reductionStage2</span></a></span><span> </span><span class="annot"><span class="annottext">Pat MCMem
</span><a href="#local-6989586621684532865"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684532864"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684532854"><span class="hs-identifier hs-var">nsubtasks'</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOpSlug]
</span><a href="#local-6989586621684532849"><span class="hs-identifier hs-var">slugs2</span></a></span><span>
</span><span id="line-90"></span><span>
</span><span id="line-91"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#reductionStage1"><span class="hs-identifier hs-type">reductionStage1</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-92"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegSpace"><span class="hs-identifier hs-type">SegSpace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-93"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#SegBinOpSlug"><span class="hs-identifier hs-type">SegBinOpSlug</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-94"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#DoSegBody"><span class="hs-identifier hs-type">DoSegBody</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-95"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#MulticoreGen"><span class="hs-identifier hs-type">MulticoreGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-96"></span><span id="reductionStage1"><span class="annot"><span class="annottext">reductionStage1 :: SegSpace -&gt; [SegBinOpSlug] -&gt; DoSegBody -&gt; MulticoreGen ()
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#reductionStage1"><span class="hs-identifier hs-var hs-var">reductionStage1</span></a></span></span><span> </span><span id="local-6989586621684532847"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684532847"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684532846"><span class="annot"><span class="annottext">[SegBinOpSlug]
</span><a href="#local-6989586621684532846"><span class="hs-identifier hs-var">slugs</span></a></span></span><span> </span><span id="local-6989586621684532845"><span class="annot"><span class="annottext">DoSegBody
</span><a href="#local-6989586621684532845"><span class="hs-identifier hs-var">kbody</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-97"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684532844"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684532844"><span class="hs-identifier hs-var">is</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532843"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684532843"><span class="hs-identifier hs-var">ns</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VName, SubExp)] -&gt; ([VName], [SubExp])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(VName, SubExp)] -&gt; ([VName], [SubExp]))
-&gt; [(VName, SubExp)] -&gt; ([VName], [SubExp])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; [(VName, SubExp)]
</span><a href="Futhark.IR.SegOp.html#unSegSpace"><span class="hs-identifier hs-var hs-var">unSegSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684532847"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-98"></span><span>      </span><span id="local-6989586621684532839"><span class="annot"><span class="annottext">ns' :: [TExp Int64]
</span><a href="#local-6989586621684532839"><span class="hs-identifier hs-var hs-var">ns'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684532843"><span class="hs-identifier hs-var">ns</span></a></span><span>
</span><span id="line-99"></span><span>  </span><span id="local-6989586621684532837"><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684532837"><span class="hs-identifier hs-var">flat_idx</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; PrimType -&gt; ImpM MCMem HostEnv Multicore (TV Int64)
forall rep r op t. String -&gt; PrimType -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrim"><span class="hs-identifier hs-var">dPrim</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;iter&quot;</span></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int64"><span class="hs-identifier hs-var">int64</span></a></span><span>
</span><span id="line-100"></span><span>
</span><span id="line-101"></span><span>  </span><span class="hs-comment">-- Create local accumulator variables in which we carry out the</span><span>
</span><span id="line-102"></span><span>  </span><span class="hs-comment">-- sequential reduction of this function.  If we are dealing with</span><span>
</span><span id="line-103"></span><span>  </span><span class="hs-comment">-- vectorised operators, then this implies a private allocation.  If</span><span>
</span><span id="line-104"></span><span>  </span><span class="hs-comment">-- the original operand type of the reduction is a memory block,</span><span>
</span><span id="line-105"></span><span>  </span><span class="hs-comment">-- then our hands are unfortunately tied, and we have to use exactly</span><span>
</span><span id="line-106"></span><span>  </span><span class="hs-comment">-- that memory.  This is likely to be slow.</span><span>
</span><span id="line-107"></span><span>
</span><span id="line-108"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684532834"><span class="annot"><span class="annottext">[[VName]]
</span><a href="#local-6989586621684532834"><span class="hs-identifier hs-var">slug_local_accs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532833"><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684532833"><span class="hs-identifier hs-var">prebody</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MulticoreGen [[VName]]
-&gt; ImpM MCMem HostEnv Multicore ([[VName]], Code)
forall rep r op a. ImpM rep r op a -&gt; ImpM rep r op (a, Code op)
</span><a href="Futhark.CodeGen.ImpGen.html#collect%27"><span class="hs-identifier hs-var">collect'</span></a></span><span> </span><span class="annot"><span class="annottext">(MulticoreGen [[VName]]
 -&gt; ImpM MCMem HostEnv Multicore ([[VName]], Code))
-&gt; MulticoreGen [[VName]]
-&gt; ImpM MCMem HostEnv Multicore ([[VName]], Code)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-109"></span><span>    </span><span class="annot"><span class="annottext">Maybe (Exp MCMem) -&gt; Scope MCMem -&gt; MulticoreGen ()
forall rep inner r op.
Mem rep inner =&gt;
Maybe (Exp rep) -&gt; Scope rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dScope"><span class="hs-identifier hs-var">dScope</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp MCMem)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">(Scope MCMem -&gt; MulticoreGen ()) -&gt; Scope MCMem -&gt; MulticoreGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem] -&gt; Scope MCMem
forall rep dec. (LParamInfo rep ~ dec) =&gt; [Param dec] -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOfLParams"><span class="hs-identifier hs-var">scopeOfLParams</span></a></span><span> </span><span class="annot"><span class="annottext">([Param LParamMem] -&gt; Scope MCMem)
-&gt; [Param LParamMem] -&gt; Scope MCMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SegBinOpSlug -&gt; [Param LParamMem])
-&gt; [SegBinOpSlug] -&gt; [Param LParamMem]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; [LParam MCMem]
SegBinOpSlug -&gt; [Param LParamMem]
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#slugParams"><span class="hs-identifier hs-var">slugParams</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOpSlug]
</span><a href="#local-6989586621684532846"><span class="hs-identifier hs-var">slugs</span></a></span><span>
</span><span id="line-110"></span><span>
</span><span id="line-111"></span><span>    </span><span class="annot"><span class="annottext">[SegBinOpSlug]
-&gt; (SegBinOpSlug -&gt; ImpM MCMem HostEnv Multicore [VName])
-&gt; MulticoreGen [[VName]]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="annot"><span class="annottext">[SegBinOpSlug]
</span><a href="#local-6989586621684532846"><span class="hs-identifier hs-var">slugs</span></a></span><span> </span><span class="annot"><span class="annottext">((SegBinOpSlug -&gt; ImpM MCMem HostEnv Multicore [VName])
 -&gt; MulticoreGen [[VName]])
-&gt; (SegBinOpSlug -&gt; ImpM MCMem HostEnv Multicore [VName])
-&gt; MulticoreGen [[VName]]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684532827"><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684532827"><span class="hs-identifier hs-var">slug</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-112"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684532826"><span class="annot"><span class="annottext">shape :: Shape
</span><a href="#local-6989586621684532826"><span class="hs-identifier hs-var hs-var">shape</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; Shape
forall rep. SegBinOp rep -&gt; Shape
</span><a href="Futhark.IR.SegOp.html#segBinOpShape"><span class="hs-identifier hs-var hs-var">segBinOpShape</span></a></span><span> </span><span class="annot"><span class="annottext">(SegBinOp MCMem -&gt; Shape) -&gt; SegBinOp MCMem -&gt; Shape
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; SegBinOp MCMem
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#slugOp"><span class="hs-identifier hs-var hs-var">slugOp</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684532827"><span class="hs-identifier hs-var">slug</span></a></span><span>
</span><span id="line-113"></span><span>
</span><span id="line-114"></span><span>      </span><span class="annot"><span class="annottext">[(Param LParamMem, SubExp)]
-&gt; ((Param LParamMem, SubExp)
    -&gt; ImpM MCMem HostEnv Multicore VName)
-&gt; ImpM MCMem HostEnv Multicore [VName]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param LParamMem] -&gt; [SubExp] -&gt; [(Param LParamMem, SubExp)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; [LParam MCMem]
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#accParams"><span class="hs-identifier hs-var">accParams</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684532827"><span class="hs-identifier hs-var">slug</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; [SubExp]
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#slugNeutral"><span class="hs-identifier hs-var">slugNeutral</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684532827"><span class="hs-identifier hs-var">slug</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Param LParamMem, SubExp) -&gt; ImpM MCMem HostEnv Multicore VName)
 -&gt; ImpM MCMem HostEnv Multicore [VName])
-&gt; ((Param LParamMem, SubExp)
    -&gt; ImpM MCMem HostEnv Multicore VName)
-&gt; ImpM MCMem HostEnv Multicore [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684532825"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684532825"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532824"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684532824"><span class="hs-identifier hs-var">ne</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-115"></span><span>        </span><span class="hs-comment">-- Declare accumulator variable.</span><span>
</span><span id="line-116"></span><span>        </span><span id="local-6989586621684532823"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684532823"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-117"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Param LParamMem -&gt; Type
forall dec. Typed dec =&gt; Param dec -&gt; Type
</span><a href="Futhark.IR.Prop.Patterns.html#paramType"><span class="hs-identifier hs-var">paramType</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684532825"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-118"></span><span>            </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-type">Prim</span></a></span><span> </span><span id="local-6989586621684532820"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684532820"><span class="hs-identifier hs-var">pt</span></a></span></span><span>
</span><span id="line-119"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684532826"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">Shape -&gt; Shape -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Shape
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-120"></span><span>                </span><span class="annot"><span class="annottext">TV Any -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">(TV Any -&gt; VName)
-&gt; ImpM MCMem HostEnv Multicore (TV Any)
-&gt; ImpM MCMem HostEnv Multicore VName
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; PrimType -&gt; ImpM MCMem HostEnv Multicore (TV Any)
forall rep r op t. String -&gt; PrimType -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrim"><span class="hs-identifier hs-var">dPrim</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;local_acc&quot;</span></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684532820"><span class="hs-identifier hs-var">pt</span></a></span><span>
</span><span id="line-121"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-122"></span><span>                </span><span class="annot"><span class="annottext">String
-&gt; PrimType -&gt; Shape -&gt; Space -&gt; ImpM MCMem HostEnv Multicore VName
forall rep r op.
String -&gt; PrimType -&gt; Shape -&gt; Space -&gt; ImpM rep r op VName
</span><a href="Futhark.CodeGen.ImpGen.html#sAllocArray"><span class="hs-identifier hs-var">sAllocArray</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;local_acc&quot;</span></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684532820"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684532826"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="Futhark.IR.Syntax.Core.html#DefaultSpace"><span class="hs-identifier hs-var">DefaultSpace</span></a></span><span>
</span><span id="line-123"></span><span>            </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-124"></span><span>              </span><span class="annot"><span class="annottext">VName -&gt; ImpM MCMem HostEnv Multicore VName
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; ImpM MCMem HostEnv Multicore VName)
-&gt; VName -&gt; ImpM MCMem HostEnv Multicore VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684532825"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-125"></span><span>
</span><span id="line-126"></span><span>        </span><span class="hs-comment">-- Now neutral-initialise the accumulator.</span><span>
</span><span id="line-127"></span><span>        </span><span class="annot"><span class="annottext">Shape -&gt; ([TExp Int64] -&gt; MulticoreGen ()) -&gt; MulticoreGen ()
forall rep r op.
Shape -&gt; ([TExp Int64] -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sLoopNest"><span class="hs-identifier hs-var">sLoopNest</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; Shape
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#slugShape"><span class="hs-identifier hs-var">slugShape</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684532827"><span class="hs-identifier hs-var">slug</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(([TExp Int64] -&gt; MulticoreGen ()) -&gt; MulticoreGen ())
-&gt; ([TExp Int64] -&gt; MulticoreGen ()) -&gt; MulticoreGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684532813"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684532813"><span class="hs-identifier hs-var">vec_is</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-128"></span><span>          </span><span class="annot"><span class="annottext">VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; MulticoreGen ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684532823"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684532813"><span class="hs-identifier hs-var">vec_is</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684532824"><span class="hs-identifier hs-var">ne</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-129"></span><span>
</span><span id="line-130"></span><span>        </span><span class="annot"><span class="annottext">VName -&gt; ImpM MCMem HostEnv Multicore VName
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684532823"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-131"></span><span>
</span><span id="line-132"></span><span>  </span><span id="local-6989586621684532811"><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684532811"><span class="hs-identifier hs-var">fbody</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MulticoreGen () -&gt; MulticoreGen Code
forall rep r op. ImpM rep r op () -&gt; ImpM rep r op (Code op)
</span><a href="Futhark.CodeGen.ImpGen.html#collect"><span class="hs-identifier hs-var">collect</span></a></span><span> </span><span class="annot"><span class="annottext">(MulticoreGen () -&gt; MulticoreGen Code)
-&gt; MulticoreGen () -&gt; MulticoreGen Code
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-133"></span><span>    </span><span class="annot"><span class="annottext">(VName -&gt; TExp Int64 -&gt; MulticoreGen ())
-&gt; [VName] -&gt; [TExp Int64] -&gt; MulticoreGen ()
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m ()
</span><span class="hs-identifier hs-var">zipWithM_</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TExp Int64 -&gt; MulticoreGen ()
forall t rep r op. VName -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV_"><span class="hs-identifier hs-var">dPrimV_</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684532844"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">([TExp Int64] -&gt; MulticoreGen ())
-&gt; [TExp Int64] -&gt; MulticoreGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; TExp Int64 -&gt; [TExp Int64]
forall num. IntegralExp num =&gt; [num] -&gt; num -&gt; [num]
</span><a href="Futhark.IR.Prop.Reshape.html#unflattenIndex"><span class="hs-identifier hs-var">unflattenIndex</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684532839"><span class="hs-identifier hs-var">ns'</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; [TExp Int64]) -&gt; TExp Int64 -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TV Int64 -&gt; TExp Int64
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684532837"><span class="hs-identifier hs-var">flat_idx</span></a></span><span>
</span><span id="line-134"></span><span>    </span><span class="annot"><span class="annottext">DoSegBody
</span><a href="#local-6989586621684532845"><span class="hs-identifier hs-var">kbody</span></a></span><span> </span><span class="annot"><span class="annottext">DoSegBody -&gt; DoSegBody
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684532808"><span class="annot"><span class="annottext">[(SubExp, [TExp Int64])]
</span><a href="#local-6989586621684532808"><span class="hs-identifier hs-var">all_red_res</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-135"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684532807"><span class="annot"><span class="annottext">all_red_res' :: [[(SubExp, [TExp Int64])]]
</span><a href="#local-6989586621684532807"><span class="hs-identifier hs-var hs-var">all_red_res'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem]
-&gt; [(SubExp, [TExp Int64])] -&gt; [[(SubExp, [TExp Int64])]]
forall rep a. [SegBinOp rep] -&gt; [a] -&gt; [[a]]
</span><a href="Futhark.IR.SegOp.html#segBinOpChunks"><span class="hs-identifier hs-var">segBinOpChunks</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SegBinOpSlug -&gt; SegBinOp MCMem)
-&gt; [SegBinOpSlug] -&gt; [SegBinOp MCMem]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; SegBinOp MCMem
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#slugOp"><span class="hs-identifier hs-var hs-var">slugOp</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOpSlug]
</span><a href="#local-6989586621684532846"><span class="hs-identifier hs-var">slugs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(SubExp, [TExp Int64])]
</span><a href="#local-6989586621684532808"><span class="hs-identifier hs-var">all_red_res</span></a></span><span>
</span><span id="line-136"></span><span>      </span><span class="annot"><span class="annottext">[([(SubExp, [TExp Int64])], SegBinOpSlug, [VName])]
-&gt; (([(SubExp, [TExp Int64])], SegBinOpSlug, [VName])
    -&gt; MulticoreGen ())
-&gt; MulticoreGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[[(SubExp, [TExp Int64])]]
-&gt; [SegBinOpSlug]
-&gt; [[VName]]
-&gt; [([(SubExp, [TExp Int64])], SegBinOpSlug, [VName])]
forall a b c. [a] -&gt; [b] -&gt; [c] -&gt; [(a, b, c)]
</span><span class="hs-identifier hs-var">zip3</span></span><span> </span><span class="annot"><span class="annottext">[[(SubExp, [TExp Int64])]]
</span><a href="#local-6989586621684532807"><span class="hs-identifier hs-var">all_red_res'</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOpSlug]
</span><a href="#local-6989586621684532846"><span class="hs-identifier hs-var">slugs</span></a></span><span> </span><span class="annot"><span class="annottext">[[VName]]
</span><a href="#local-6989586621684532834"><span class="hs-identifier hs-var">slug_local_accs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((([(SubExp, [TExp Int64])], SegBinOpSlug, [VName])
  -&gt; MulticoreGen ())
 -&gt; MulticoreGen ())
-&gt; (([(SubExp, [TExp Int64])], SegBinOpSlug, [VName])
    -&gt; MulticoreGen ())
-&gt; MulticoreGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684532803"><span class="annot"><span class="annottext">[(SubExp, [TExp Int64])]
</span><a href="#local-6989586621684532803"><span class="hs-identifier hs-var">red_res</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532802"><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684532802"><span class="hs-identifier hs-var">slug</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532801"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684532801"><span class="hs-identifier hs-var">local_accs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-137"></span><span>        </span><span class="annot"><span class="annottext">Shape -&gt; ([TExp Int64] -&gt; MulticoreGen ()) -&gt; MulticoreGen ()
forall rep r op.
Shape -&gt; ([TExp Int64] -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sLoopNest"><span class="hs-identifier hs-var">sLoopNest</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; Shape
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#slugShape"><span class="hs-identifier hs-var">slugShape</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684532802"><span class="hs-identifier hs-var">slug</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(([TExp Int64] -&gt; MulticoreGen ()) -&gt; MulticoreGen ())
-&gt; ([TExp Int64] -&gt; MulticoreGen ()) -&gt; MulticoreGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684532800"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684532800"><span class="hs-identifier hs-var">vec_is</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-138"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684532799"><span class="annot"><span class="annottext">lamtypes :: [Type]
</span><a href="#local-6989586621684532799"><span class="hs-identifier hs-var hs-var">lamtypes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LambdaT MCMem -&gt; [Type]
forall rep. LambdaT rep -&gt; [Type]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">(LambdaT MCMem -&gt; [Type]) -&gt; LambdaT MCMem -&gt; [Type]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; LambdaT MCMem
forall rep. SegBinOp rep -&gt; Lambda rep
</span><a href="Futhark.IR.SegOp.html#segBinOpLambda"><span class="hs-identifier hs-var hs-var">segBinOpLambda</span></a></span><span> </span><span class="annot"><span class="annottext">(SegBinOp MCMem -&gt; LambdaT MCMem)
-&gt; SegBinOp MCMem -&gt; LambdaT MCMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; SegBinOp MCMem
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#slugOp"><span class="hs-identifier hs-var hs-var">slugOp</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684532802"><span class="hs-identifier hs-var">slug</span></a></span><span>
</span><span id="line-139"></span><span>          </span><span class="hs-comment">-- Load accum params</span><span>
</span><span id="line-140"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; MulticoreGen () -&gt; MulticoreGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Load accum params&quot;</span></span><span> </span><span class="annot"><span class="annottext">(MulticoreGen () -&gt; MulticoreGen ())
-&gt; MulticoreGen () -&gt; MulticoreGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-141"></span><span>            </span><span class="annot"><span class="annottext">[(Param LParamMem, VName, Type)]
-&gt; ((Param LParamMem, VName, Type) -&gt; MulticoreGen ())
-&gt; MulticoreGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param LParamMem]
-&gt; [VName] -&gt; [Type] -&gt; [(Param LParamMem, VName, Type)]
forall a b c. [a] -&gt; [b] -&gt; [c] -&gt; [(a, b, c)]
</span><span class="hs-identifier hs-var">zip3</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; [LParam MCMem]
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#accParams"><span class="hs-identifier hs-var">accParams</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684532802"><span class="hs-identifier hs-var">slug</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684532801"><span class="hs-identifier hs-var">local_accs</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684532799"><span class="hs-identifier hs-var">lamtypes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Param LParamMem, VName, Type) -&gt; MulticoreGen ())
 -&gt; MulticoreGen ())
-&gt; ((Param LParamMem, VName, Type) -&gt; MulticoreGen ())
-&gt; MulticoreGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-142"></span><span>              </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684532797"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684532797"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532796"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684532796"><span class="hs-identifier hs-var">local_acc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532795"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684532795"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-143"></span><span>                </span><span class="annot"><span class="annottext">Bool -&gt; MulticoreGen () -&gt; MulticoreGen ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Bool
forall shape u. TypeBase shape u -&gt; Bool
</span><a href="Futhark.IR.Prop.Types.html#primType"><span class="hs-identifier hs-var">primType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684532795"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(MulticoreGen () -&gt; MulticoreGen ())
-&gt; MulticoreGen () -&gt; MulticoreGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-144"></span><span>                  </span><span class="annot"><span class="annottext">VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; MulticoreGen ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684532797"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684532796"><span class="hs-identifier hs-var">local_acc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684532800"><span class="hs-identifier hs-var">vec_is</span></a></span><span>
</span><span id="line-145"></span><span>
</span><span id="line-146"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; MulticoreGen () -&gt; MulticoreGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Load next params&quot;</span></span><span> </span><span class="annot"><span class="annottext">(MulticoreGen () -&gt; MulticoreGen ())
-&gt; MulticoreGen () -&gt; MulticoreGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-147"></span><span>            </span><span class="annot"><span class="annottext">[(Param LParamMem, (SubExp, [TExp Int64]))]
-&gt; ((Param LParamMem, (SubExp, [TExp Int64])) -&gt; MulticoreGen ())
-&gt; MulticoreGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param LParamMem]
-&gt; [(SubExp, [TExp Int64])]
-&gt; [(Param LParamMem, (SubExp, [TExp Int64]))]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; [LParam MCMem]
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#nextParams"><span class="hs-identifier hs-var">nextParams</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684532802"><span class="hs-identifier hs-var">slug</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(SubExp, [TExp Int64])]
</span><a href="#local-6989586621684532803"><span class="hs-identifier hs-var">red_res</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Param LParamMem, (SubExp, [TExp Int64])) -&gt; MulticoreGen ())
 -&gt; MulticoreGen ())
-&gt; ((Param LParamMem, (SubExp, [TExp Int64])) -&gt; MulticoreGen ())
-&gt; MulticoreGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684532791"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684532791"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684532790"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684532790"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532789"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684532789"><span class="hs-identifier hs-var">res_is</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-148"></span><span>              </span><span class="annot"><span class="annottext">VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; MulticoreGen ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684532791"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684532790"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684532789"><span class="hs-identifier hs-var">res_is</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; [TExp Int64] -&gt; [TExp Int64]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684532800"><span class="hs-identifier hs-var">vec_is</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-149"></span><span>
</span><span id="line-150"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; MulticoreGen () -&gt; MulticoreGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Red body&quot;</span></span><span> </span><span class="annot"><span class="annottext">(MulticoreGen () -&gt; MulticoreGen ())
-&gt; MulticoreGen () -&gt; MulticoreGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-151"></span><span>            </span><span class="annot"><span class="annottext">Names -&gt; Stms MCMem -&gt; MulticoreGen () -&gt; MulticoreGen ()
forall rep r op.
Names -&gt; Stms rep -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileStms"><span class="hs-identifier hs-var">compileStms</span></a></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Body MCMem -&gt; Stms MCMem
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">(Body MCMem -&gt; Stms MCMem) -&gt; Body MCMem -&gt; Stms MCMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; Body MCMem
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#slugBody"><span class="hs-identifier hs-var">slugBody</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684532802"><span class="hs-identifier hs-var">slug</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(MulticoreGen () -&gt; MulticoreGen ())
-&gt; MulticoreGen () -&gt; MulticoreGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-152"></span><span>              </span><span class="annot"><span class="annottext">[(VName, SubExp)]
-&gt; ((VName, SubExp) -&gt; MulticoreGen ()) -&gt; MulticoreGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; [SubExp] -&gt; [(VName, SubExp)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684532801"><span class="hs-identifier hs-var">local_accs</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [(VName, SubExp)]) -&gt; [SubExp] -&gt; [(VName, SubExp)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExpRes -&gt; SubExp) -&gt; [SubExpRes] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExpRes -&gt; SubExp
</span><a href="Futhark.IR.Syntax.html#resSubExp"><span class="hs-identifier hs-var hs-var">resSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExpRes] -&gt; [SubExp]) -&gt; [SubExpRes] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Body MCMem -&gt; [SubExpRes]
forall rep. BodyT rep -&gt; [SubExpRes]
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var hs-var">bodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">(Body MCMem -&gt; [SubExpRes]) -&gt; Body MCMem -&gt; [SubExpRes]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; Body MCMem
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#slugBody"><span class="hs-identifier hs-var">slugBody</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684532802"><span class="hs-identifier hs-var">slug</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((VName, SubExp) -&gt; MulticoreGen ()) -&gt; MulticoreGen ())
-&gt; ((VName, SubExp) -&gt; MulticoreGen ()) -&gt; MulticoreGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-153"></span><span>                </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684532785"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684532785"><span class="hs-identifier hs-var">local_acc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532784"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684532784"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-154"></span><span>                  </span><span class="annot"><span class="annottext">VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; MulticoreGen ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684532785"><span class="hs-identifier hs-var">local_acc</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684532800"><span class="hs-identifier hs-var">vec_is</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684532784"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-155"></span><span>
</span><span id="line-156"></span><span>  </span><span id="local-6989586621684532783"><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684532783"><span class="hs-identifier hs-var">postbody</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MulticoreGen () -&gt; MulticoreGen Code
forall rep r op. ImpM rep r op () -&gt; ImpM rep r op (Code op)
</span><a href="Futhark.CodeGen.ImpGen.html#collect"><span class="hs-identifier hs-var">collect</span></a></span><span> </span><span class="annot"><span class="annottext">(MulticoreGen () -&gt; MulticoreGen Code)
-&gt; MulticoreGen () -&gt; MulticoreGen Code
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-157"></span><span>    </span><span class="annot"><span class="annottext">[(SegBinOpSlug, [VName])]
-&gt; ((SegBinOpSlug, [VName]) -&gt; ImpM MCMem HostEnv Multicore [()])
-&gt; MulticoreGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SegBinOpSlug] -&gt; [[VName]] -&gt; [(SegBinOpSlug, [VName])]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[SegBinOpSlug]
</span><a href="#local-6989586621684532846"><span class="hs-identifier hs-var">slugs</span></a></span><span> </span><span class="annot"><span class="annottext">[[VName]]
</span><a href="#local-6989586621684532834"><span class="hs-identifier hs-var">slug_local_accs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((SegBinOpSlug, [VName]) -&gt; ImpM MCMem HostEnv Multicore [()])
 -&gt; MulticoreGen ())
-&gt; ((SegBinOpSlug, [VName]) -&gt; ImpM MCMem HostEnv Multicore [()])
-&gt; MulticoreGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684532782"><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684532782"><span class="hs-identifier hs-var">slug</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532781"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684532781"><span class="hs-identifier hs-var">local_accs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-158"></span><span>      </span><span class="annot"><span class="annottext">[(VName, VName)]
-&gt; ((VName, VName) -&gt; MulticoreGen ())
-&gt; ImpM MCMem HostEnv Multicore [()]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [(VName, VName)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; [VName]
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#slugResArrs"><span class="hs-identifier hs-var hs-var">slugResArrs</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684532782"><span class="hs-identifier hs-var">slug</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684532781"><span class="hs-identifier hs-var">local_accs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((VName, VName) -&gt; MulticoreGen ())
 -&gt; ImpM MCMem HostEnv Multicore [()])
-&gt; ((VName, VName) -&gt; MulticoreGen ())
-&gt; ImpM MCMem HostEnv Multicore [()]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684532780"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684532780"><span class="hs-identifier hs-var">acc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532779"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684532779"><span class="hs-identifier hs-var">local_acc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-159"></span><span>        </span><span class="annot"><span class="annottext">VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; MulticoreGen ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684532780"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">VName -&gt; TExp Int64
forall a. a -&gt; TPrimExp Int64 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le64"><span class="hs-identifier hs-var">Imp.le64</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; TExp Int64) -&gt; VName -&gt; TExp Int64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; VName
</span><a href="Futhark.IR.SegOp.html#segFlat"><span class="hs-identifier hs-var hs-var">segFlat</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684532847"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684532779"><span class="hs-identifier hs-var">local_acc</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-160"></span><span>
</span><span id="line-161"></span><span>  </span><span id="local-6989586621684532776"><span class="annot"><span class="annottext">[Param]
</span><a href="#local-6989586621684532776"><span class="hs-identifier hs-var">free_params</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Code -&gt; [VName] -&gt; MulticoreGen [Param]
</span><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#freeParams"><span class="hs-identifier hs-var">freeParams</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684532833"><span class="hs-identifier hs-var">prebody</span></a></span><span> </span><span class="annot"><span class="annottext">Code -&gt; Code -&gt; Code
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684532811"><span class="hs-identifier hs-var">fbody</span></a></span><span> </span><span class="annot"><span class="annottext">Code -&gt; Code -&gt; Code
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684532783"><span class="hs-identifier hs-var">postbody</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegSpace -&gt; VName
</span><a href="Futhark.IR.SegOp.html#segFlat"><span class="hs-identifier hs-var hs-var">segFlat</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684532847"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [VName] -&gt; [VName]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TV Int64 -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684532837"><span class="hs-identifier hs-var">flat_idx</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-162"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684532774"><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684532774"><span class="hs-identifier hs-var">body_allocs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532773"><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684532773"><span class="hs-identifier hs-var">fbody'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Code -&gt; (Code, Code)
</span><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#extractAllocations"><span class="hs-identifier hs-var">extractAllocations</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684532811"><span class="hs-identifier hs-var">fbody</span></a></span><span>
</span><span id="line-163"></span><span>  </span><span class="annot"><span class="annottext">Code -&gt; MulticoreGen ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code -&gt; MulticoreGen ()) -&gt; Code -&gt; MulticoreGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Multicore -&gt; Code
forall a. a -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#Op"><span class="hs-identifier hs-var">Imp.Op</span></a></span><span> </span><span class="annot"><span class="annottext">(Multicore -&gt; Code) -&gt; Multicore -&gt; Code
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
-&gt; VName -&gt; Code -&gt; Code -&gt; Code -&gt; [Param] -&gt; VName -&gt; Multicore
</span><a href="Futhark.CodeGen.ImpCode.Multicore.html#ParLoop"><span class="hs-identifier hs-var">Imp.ParLoop</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;segred_stage_1&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int64 -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684532837"><span class="hs-identifier hs-var">flat_idx</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684532774"><span class="hs-identifier hs-var">body_allocs</span></a></span><span> </span><span class="annot"><span class="annottext">Code -&gt; Code -&gt; Code
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684532833"><span class="hs-identifier hs-var">prebody</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684532773"><span class="hs-identifier hs-var">fbody'</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684532783"><span class="hs-identifier hs-var">postbody</span></a></span><span> </span><span class="annot"><span class="annottext">[Param]
</span><a href="#local-6989586621684532776"><span class="hs-identifier hs-var">free_params</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Multicore) -&gt; VName -&gt; Multicore
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; VName
</span><a href="Futhark.IR.SegOp.html#segFlat"><span class="hs-identifier hs-var hs-var">segFlat</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684532847"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-164"></span><span>
</span><span id="line-165"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#reductionStage2"><span class="hs-identifier hs-type">reductionStage2</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-166"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-167"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegSpace"><span class="hs-identifier hs-type">SegSpace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-168"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-169"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#SegBinOpSlug"><span class="hs-identifier hs-type">SegBinOpSlug</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-170"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#MulticoreGen"><span class="hs-identifier hs-type">MulticoreGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-171"></span><span id="reductionStage2"><span class="annot"><span class="annottext">reductionStage2 :: Pat MCMem
-&gt; SegSpace -&gt; TExp Int32 -&gt; [SegBinOpSlug] -&gt; MulticoreGen ()
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#reductionStage2"><span class="hs-identifier hs-var hs-var">reductionStage2</span></a></span></span><span> </span><span id="local-6989586621684532768"><span class="annot"><span class="annottext">Pat MCMem
</span><a href="#local-6989586621684532768"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684532767"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684532767"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684532766"><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684532766"><span class="hs-identifier hs-var">nsubtasks</span></a></span></span><span> </span><span id="local-6989586621684532765"><span class="annot"><span class="annottext">[SegBinOpSlug]
</span><a href="#local-6989586621684532765"><span class="hs-identifier hs-var">slugs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-172"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684532764"><span class="annot"><span class="annottext">per_red_pes :: [[PatElemT LParamMem]]
</span><a href="#local-6989586621684532764"><span class="hs-identifier hs-var hs-var">per_red_pes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem] -&gt; [PatElemT LParamMem] -&gt; [[PatElemT LParamMem]]
forall rep a. [SegBinOp rep] -&gt; [a] -&gt; [[a]]
</span><a href="Futhark.IR.SegOp.html#segBinOpChunks"><span class="hs-identifier hs-var">segBinOpChunks</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SegBinOpSlug -&gt; SegBinOp MCMem)
-&gt; [SegBinOpSlug] -&gt; [SegBinOp MCMem]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; SegBinOp MCMem
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#slugOp"><span class="hs-identifier hs-var hs-var">slugOp</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOpSlug]
</span><a href="#local-6989586621684532765"><span class="hs-identifier hs-var">slugs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([PatElemT LParamMem] -&gt; [[PatElemT LParamMem]])
-&gt; [PatElemT LParamMem] -&gt; [[PatElemT LParamMem]]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatT LParamMem -&gt; [PatElemT LParamMem]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span> </span><span class="annot"><span class="annottext">Pat MCMem
PatT LParamMem
</span><a href="#local-6989586621684532768"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-173"></span><span>      </span><span id="local-6989586621684532763"><span class="annot"><span class="annottext">phys_id :: TExp Int64
</span><a href="#local-6989586621684532763"><span class="hs-identifier hs-var hs-var">phys_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; TExp Int64
forall a. a -&gt; TPrimExp Int64 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le64"><span class="hs-identifier hs-var">Imp.le64</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegSpace -&gt; VName
</span><a href="Futhark.IR.SegOp.html#segFlat"><span class="hs-identifier hs-var hs-var">segFlat</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684532767"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-174"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; MulticoreGen () -&gt; MulticoreGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;neutral-initialise the output&quot;</span></span><span> </span><span class="annot"><span class="annottext">(MulticoreGen () -&gt; MulticoreGen ())
-&gt; MulticoreGen () -&gt; MulticoreGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-175"></span><span>    </span><span class="annot"><span class="annottext">[(SegBinOp MCMem, [PatElemT LParamMem])]
-&gt; ((SegBinOp MCMem, [PatElemT LParamMem]) -&gt; MulticoreGen ())
-&gt; MulticoreGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SegBinOp MCMem]
-&gt; [[PatElemT LParamMem]]
-&gt; [(SegBinOp MCMem, [PatElemT LParamMem])]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SegBinOpSlug -&gt; SegBinOp MCMem)
-&gt; [SegBinOpSlug] -&gt; [SegBinOp MCMem]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; SegBinOp MCMem
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#slugOp"><span class="hs-identifier hs-var hs-var">slugOp</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOpSlug]
</span><a href="#local-6989586621684532765"><span class="hs-identifier hs-var">slugs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[[PatElemT LParamMem]]
</span><a href="#local-6989586621684532764"><span class="hs-identifier hs-var">per_red_pes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((SegBinOp MCMem, [PatElemT LParamMem]) -&gt; MulticoreGen ())
 -&gt; MulticoreGen ())
-&gt; ((SegBinOp MCMem, [PatElemT LParamMem]) -&gt; MulticoreGen ())
-&gt; MulticoreGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684532762"><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684532762"><span class="hs-identifier hs-var">red</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532761"><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684532761"><span class="hs-identifier hs-var">red_res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-176"></span><span>      </span><span class="annot"><span class="annottext">[(PatElemT LParamMem, SubExp)]
-&gt; ((PatElemT LParamMem, SubExp) -&gt; MulticoreGen ())
-&gt; MulticoreGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PatElemT LParamMem] -&gt; [SubExp] -&gt; [(PatElemT LParamMem, SubExp)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684532761"><span class="hs-identifier hs-var">red_res</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [(PatElemT LParamMem, SubExp)])
-&gt; [SubExp] -&gt; [(PatElemT LParamMem, SubExp)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; [SubExp]
forall rep. SegBinOp rep -&gt; [SubExp]
</span><a href="Futhark.IR.SegOp.html#segBinOpNeutral"><span class="hs-identifier hs-var hs-var">segBinOpNeutral</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684532762"><span class="hs-identifier hs-var">red</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((PatElemT LParamMem, SubExp) -&gt; MulticoreGen ())
 -&gt; MulticoreGen ())
-&gt; ((PatElemT LParamMem, SubExp) -&gt; MulticoreGen ())
-&gt; MulticoreGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684532760"><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684532760"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532759"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684532759"><span class="hs-identifier hs-var">ne</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-177"></span><span>        </span><span class="annot"><span class="annottext">Shape -&gt; ([TExp Int64] -&gt; MulticoreGen ()) -&gt; MulticoreGen ()
forall rep r op.
Shape -&gt; ([TExp Int64] -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sLoopNest"><span class="hs-identifier hs-var">sLoopNest</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; Shape
forall rep. SegBinOp rep -&gt; Shape
</span><a href="Futhark.IR.SegOp.html#segBinOpShape"><span class="hs-identifier hs-var hs-var">segBinOpShape</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684532762"><span class="hs-identifier hs-var">red</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(([TExp Int64] -&gt; MulticoreGen ()) -&gt; MulticoreGen ())
-&gt; ([TExp Int64] -&gt; MulticoreGen ()) -&gt; MulticoreGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684532758"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684532758"><span class="hs-identifier hs-var">vec_is</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-178"></span><span>          </span><span class="annot"><span class="annottext">VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; MulticoreGen ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684532760"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684532758"><span class="hs-identifier hs-var">vec_is</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684532759"><span class="hs-identifier hs-var">ne</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-179"></span><span>
</span><span id="line-180"></span><span>  </span><span class="annot"><span class="annottext">Maybe (Exp MCMem) -&gt; Scope MCMem -&gt; MulticoreGen ()
forall rep inner r op.
Mem rep inner =&gt;
Maybe (Exp rep) -&gt; Scope rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dScope"><span class="hs-identifier hs-var">dScope</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp MCMem)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">(Scope MCMem -&gt; MulticoreGen ()) -&gt; Scope MCMem -&gt; MulticoreGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem] -&gt; Scope MCMem
forall rep dec. (LParamInfo rep ~ dec) =&gt; [Param dec] -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOfLParams"><span class="hs-identifier hs-var">scopeOfLParams</span></a></span><span> </span><span class="annot"><span class="annottext">([Param LParamMem] -&gt; Scope MCMem)
-&gt; [Param LParamMem] -&gt; Scope MCMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SegBinOpSlug -&gt; [Param LParamMem])
-&gt; [SegBinOpSlug] -&gt; [Param LParamMem]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; [LParam MCMem]
SegBinOpSlug -&gt; [Param LParamMem]
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#slugParams"><span class="hs-identifier hs-var">slugParams</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOpSlug]
</span><a href="#local-6989586621684532765"><span class="hs-identifier hs-var">slugs</span></a></span><span>
</span><span id="line-181"></span><span>
</span><span id="line-182"></span><span>  </span><span class="annot"><span class="annottext">String
-&gt; TExp Int32 -&gt; (TExp Int32 -&gt; MulticoreGen ()) -&gt; MulticoreGen ()
forall t rep r op.
String
-&gt; TExp t -&gt; (TExp t -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sFor"><span class="hs-identifier hs-var">sFor</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;i&quot;</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684532766"><span class="hs-identifier hs-var">nsubtasks</span></a></span><span> </span><span class="annot"><span class="annottext">((TExp Int32 -&gt; MulticoreGen ()) -&gt; MulticoreGen ())
-&gt; (TExp Int32 -&gt; MulticoreGen ()) -&gt; MulticoreGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684532755"><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684532755"><span class="hs-identifier hs-var">i'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-183"></span><span>    </span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; TV Int32
forall t. VName -&gt; PrimType -&gt; TV t
</span><a href="Futhark.CodeGen.ImpGen.html#mkTV"><span class="hs-identifier hs-var">mkTV</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegSpace -&gt; VName
</span><a href="Futhark.IR.SegOp.html#segFlat"><span class="hs-identifier hs-var hs-var">segFlat</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684532767"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int64"><span class="hs-identifier hs-var">int64</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32 -&gt; TExp Int32 -&gt; MulticoreGen ()
forall t rep r op. TV t -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#%3C--"><span class="hs-operator hs-var">&lt;--</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684532755"><span class="hs-identifier hs-var">i'</span></a></span><span>
</span><span id="line-184"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; MulticoreGen () -&gt; MulticoreGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Apply main thread reduction&quot;</span></span><span> </span><span class="annot"><span class="annottext">(MulticoreGen () -&gt; MulticoreGen ())
-&gt; MulticoreGen () -&gt; MulticoreGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-185"></span><span>      </span><span class="annot"><span class="annottext">[(SegBinOpSlug, [PatElemT LParamMem])]
-&gt; ((SegBinOpSlug, [PatElemT LParamMem]) -&gt; MulticoreGen ())
-&gt; MulticoreGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SegBinOpSlug]
-&gt; [[PatElemT LParamMem]] -&gt; [(SegBinOpSlug, [PatElemT LParamMem])]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[SegBinOpSlug]
</span><a href="#local-6989586621684532765"><span class="hs-identifier hs-var">slugs</span></a></span><span> </span><span class="annot"><span class="annottext">[[PatElemT LParamMem]]
</span><a href="#local-6989586621684532764"><span class="hs-identifier hs-var">per_red_pes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((SegBinOpSlug, [PatElemT LParamMem]) -&gt; MulticoreGen ())
 -&gt; MulticoreGen ())
-&gt; ((SegBinOpSlug, [PatElemT LParamMem]) -&gt; MulticoreGen ())
-&gt; MulticoreGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684532752"><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684532752"><span class="hs-identifier hs-var">slug</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532751"><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684532751"><span class="hs-identifier hs-var">red_res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-186"></span><span>        </span><span class="annot"><span class="annottext">Shape -&gt; ([TExp Int64] -&gt; MulticoreGen ()) -&gt; MulticoreGen ()
forall rep r op.
Shape -&gt; ([TExp Int64] -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sLoopNest"><span class="hs-identifier hs-var">sLoopNest</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; Shape
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#slugShape"><span class="hs-identifier hs-var">slugShape</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684532752"><span class="hs-identifier hs-var">slug</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(([TExp Int64] -&gt; MulticoreGen ()) -&gt; MulticoreGen ())
-&gt; ([TExp Int64] -&gt; MulticoreGen ()) -&gt; MulticoreGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684532750"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684532750"><span class="hs-identifier hs-var">vec_is</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-187"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; MulticoreGen () -&gt; MulticoreGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;load acc params&quot;</span></span><span> </span><span class="annot"><span class="annottext">(MulticoreGen () -&gt; MulticoreGen ())
-&gt; MulticoreGen () -&gt; MulticoreGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-188"></span><span>            </span><span class="annot"><span class="annottext">[(Param LParamMem, PatElemT LParamMem)]
-&gt; ((Param LParamMem, PatElemT LParamMem) -&gt; MulticoreGen ())
-&gt; MulticoreGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param LParamMem]
-&gt; [PatElemT LParamMem] -&gt; [(Param LParamMem, PatElemT LParamMem)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; [LParam MCMem]
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#accParams"><span class="hs-identifier hs-var">accParams</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684532752"><span class="hs-identifier hs-var">slug</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684532751"><span class="hs-identifier hs-var">red_res</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Param LParamMem, PatElemT LParamMem) -&gt; MulticoreGen ())
 -&gt; MulticoreGen ())
-&gt; ((Param LParamMem, PatElemT LParamMem) -&gt; MulticoreGen ())
-&gt; MulticoreGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684532749"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684532749"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532748"><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684532748"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-189"></span><span>              </span><span class="annot"><span class="annottext">VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; MulticoreGen ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684532749"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SubExp) -&gt; VName -&gt; SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684532748"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684532750"><span class="hs-identifier hs-var">vec_is</span></a></span><span>
</span><span id="line-190"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; MulticoreGen () -&gt; MulticoreGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;load next params&quot;</span></span><span> </span><span class="annot"><span class="annottext">(MulticoreGen () -&gt; MulticoreGen ())
-&gt; MulticoreGen () -&gt; MulticoreGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-191"></span><span>            </span><span class="annot"><span class="annottext">[(Param LParamMem, VName)]
-&gt; ((Param LParamMem, VName) -&gt; MulticoreGen ()) -&gt; MulticoreGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param LParamMem] -&gt; [VName] -&gt; [(Param LParamMem, VName)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; [LParam MCMem]
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#nextParams"><span class="hs-identifier hs-var">nextParams</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684532752"><span class="hs-identifier hs-var">slug</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; [VName]
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#slugResArrs"><span class="hs-identifier hs-var hs-var">slugResArrs</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684532752"><span class="hs-identifier hs-var">slug</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Param LParamMem, VName) -&gt; MulticoreGen ()) -&gt; MulticoreGen ())
-&gt; ((Param LParamMem, VName) -&gt; MulticoreGen ()) -&gt; MulticoreGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684532747"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684532747"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532746"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684532746"><span class="hs-identifier hs-var">acc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-192"></span><span>              </span><span class="annot"><span class="annottext">VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; MulticoreGen ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684532747"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684532746"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684532763"><span class="hs-identifier hs-var">phys_id</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; [TExp Int64] -&gt; [TExp Int64]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684532750"><span class="hs-identifier hs-var">vec_is</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-193"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; MulticoreGen () -&gt; MulticoreGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;red body&quot;</span></span><span> </span><span class="annot"><span class="annottext">(MulticoreGen () -&gt; MulticoreGen ())
-&gt; MulticoreGen () -&gt; MulticoreGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-194"></span><span>            </span><span class="annot"><span class="annottext">Names -&gt; Stms MCMem -&gt; MulticoreGen () -&gt; MulticoreGen ()
forall rep r op.
Names -&gt; Stms rep -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileStms"><span class="hs-identifier hs-var">compileStms</span></a></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Body MCMem -&gt; Stms MCMem
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">(Body MCMem -&gt; Stms MCMem) -&gt; Body MCMem -&gt; Stms MCMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; Body MCMem
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#slugBody"><span class="hs-identifier hs-var">slugBody</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684532752"><span class="hs-identifier hs-var">slug</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(MulticoreGen () -&gt; MulticoreGen ())
-&gt; MulticoreGen () -&gt; MulticoreGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-195"></span><span>              </span><span class="annot"><span class="annottext">[(PatElemT LParamMem, SubExp)]
-&gt; ((PatElemT LParamMem, SubExp) -&gt; MulticoreGen ())
-&gt; MulticoreGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PatElemT LParamMem] -&gt; [SubExp] -&gt; [(PatElemT LParamMem, SubExp)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684532751"><span class="hs-identifier hs-var">red_res</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [(PatElemT LParamMem, SubExp)])
-&gt; [SubExp] -&gt; [(PatElemT LParamMem, SubExp)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExpRes -&gt; SubExp) -&gt; [SubExpRes] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExpRes -&gt; SubExp
</span><a href="Futhark.IR.Syntax.html#resSubExp"><span class="hs-identifier hs-var hs-var">resSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExpRes] -&gt; [SubExp]) -&gt; [SubExpRes] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Body MCMem -&gt; [SubExpRes]
forall rep. BodyT rep -&gt; [SubExpRes]
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var hs-var">bodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">(Body MCMem -&gt; [SubExpRes]) -&gt; Body MCMem -&gt; [SubExpRes]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; Body MCMem
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#slugBody"><span class="hs-identifier hs-var">slugBody</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684532752"><span class="hs-identifier hs-var">slug</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((PatElemT LParamMem, SubExp) -&gt; MulticoreGen ())
 -&gt; MulticoreGen ())
-&gt; ((PatElemT LParamMem, SubExp) -&gt; MulticoreGen ())
-&gt; MulticoreGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-196"></span><span>                </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684532745"><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684532745"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532744"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684532744"><span class="hs-identifier hs-var">se'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; MulticoreGen ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684532745"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684532750"><span class="hs-identifier hs-var">vec_is</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684532744"><span class="hs-identifier hs-var">se'</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-197"></span><span>
</span><span id="line-198"></span><span class="hs-comment">-- Each thread reduces over the number of segments</span><span>
</span><span id="line-199"></span><span class="hs-comment">-- each of which is done sequentially</span><span>
</span><span id="line-200"></span><span class="hs-comment">-- Maybe we should select the work of the inner loop</span><span>
</span><span id="line-201"></span><span class="hs-comment">-- based on n_segments and dimensions etc.</span><span>
</span><span id="line-202"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#segmentedReduction"><span class="hs-identifier hs-type">segmentedReduction</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-203"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-204"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegSpace"><span class="hs-identifier hs-type">SegSpace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-205"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.SegOp.html#SegBinOp"><span class="hs-identifier hs-type">SegBinOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-206"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#DoSegBody"><span class="hs-identifier hs-type">DoSegBody</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-207"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#MulticoreGen"><span class="hs-identifier hs-type">MulticoreGen</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.Multicore.html#Code"><span class="hs-identifier hs-type">Imp.Code</span></a></span><span>
</span><span id="line-208"></span><span id="segmentedReduction"><span class="annot"><span class="annottext">segmentedReduction :: Pat MCMem
-&gt; SegSpace -&gt; [SegBinOp MCMem] -&gt; DoSegBody -&gt; MulticoreGen Code
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#segmentedReduction"><span class="hs-identifier hs-var hs-var">segmentedReduction</span></a></span></span><span> </span><span id="local-6989586621684532743"><span class="annot"><span class="annottext">Pat MCMem
</span><a href="#local-6989586621684532743"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684532742"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684532742"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684532741"><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532741"><span class="hs-identifier hs-var">reds</span></a></span></span><span> </span><span id="local-6989586621684532740"><span class="annot"><span class="annottext">DoSegBody
</span><a href="#local-6989586621684532740"><span class="hs-identifier hs-var">kbody</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-209"></span><span>  </span><span class="annot"><span class="annottext">MulticoreGen () -&gt; MulticoreGen Code
forall rep r op. ImpM rep r op () -&gt; ImpM rep r op (Code op)
</span><a href="Futhark.CodeGen.ImpGen.html#collect"><span class="hs-identifier hs-var">collect</span></a></span><span> </span><span class="annot"><span class="annottext">(MulticoreGen () -&gt; MulticoreGen Code)
-&gt; MulticoreGen () -&gt; MulticoreGen Code
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-210"></span><span>    </span><span id="local-6989586621684532739"><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684532739"><span class="hs-identifier hs-var">n_par_segments</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; PrimType -&gt; ImpM MCMem HostEnv Multicore (TV Int64)
forall rep r op t. String -&gt; PrimType -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrim"><span class="hs-identifier hs-var">dPrim</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;segment_iter&quot;</span></span><span> </span><span class="annot"><span class="annottext">(PrimType -&gt; ImpM MCMem HostEnv Multicore (TV Int64))
-&gt; PrimType -&gt; ImpM MCMem HostEnv Multicore (TV Int64)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IntType -&gt; PrimType
</span><a href="Futhark.IR.Primitive.html#IntType"><span class="hs-identifier hs-var">IntType</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span>
</span><span id="line-211"></span><span>    </span><span id="local-6989586621684532736"><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684532736"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TV Int64
-&gt; Pat MCMem
-&gt; SegSpace
-&gt; [SegBinOp MCMem]
-&gt; DoSegBody
-&gt; MulticoreGen Code
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#compileSegRedBody"><span class="hs-identifier hs-var">compileSegRedBody</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684532739"><span class="hs-identifier hs-var">n_par_segments</span></a></span><span> </span><span class="annot"><span class="annottext">Pat MCMem
</span><a href="#local-6989586621684532743"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684532742"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532741"><span class="hs-identifier hs-var">reds</span></a></span><span> </span><span class="annot"><span class="annottext">DoSegBody
</span><a href="#local-6989586621684532740"><span class="hs-identifier hs-var">kbody</span></a></span><span>
</span><span id="line-212"></span><span>    </span><span id="local-6989586621684532734"><span class="annot"><span class="annottext">[Param]
</span><a href="#local-6989586621684532734"><span class="hs-identifier hs-var">free_params</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Code -&gt; [VName] -&gt; MulticoreGen [Param]
</span><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#freeParams"><span class="hs-identifier hs-var">freeParams</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684532736"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegSpace -&gt; VName
</span><a href="Futhark.IR.SegOp.html#segFlat"><span class="hs-identifier hs-var hs-var">segFlat</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684532742"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [VName] -&gt; [VName]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TV Int64 -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684532739"><span class="hs-identifier hs-var">n_par_segments</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-213"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684532733"><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684532733"><span class="hs-identifier hs-var">body_allocs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532732"><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684532732"><span class="hs-identifier hs-var">body'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Code -&gt; (Code, Code)
</span><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#extractAllocations"><span class="hs-identifier hs-var">extractAllocations</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684532736"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-214"></span><span>    </span><span class="annot"><span class="annottext">Code -&gt; MulticoreGen ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code -&gt; MulticoreGen ()) -&gt; Code -&gt; MulticoreGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Multicore -&gt; Code
forall a. a -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#Op"><span class="hs-identifier hs-var">Imp.Op</span></a></span><span> </span><span class="annot"><span class="annottext">(Multicore -&gt; Code) -&gt; Multicore -&gt; Code
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
-&gt; VName -&gt; Code -&gt; Code -&gt; Code -&gt; [Param] -&gt; VName -&gt; Multicore
</span><a href="Futhark.CodeGen.ImpCode.Multicore.html#ParLoop"><span class="hs-identifier hs-var">Imp.ParLoop</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;segmented_segred&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int64 -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684532739"><span class="hs-identifier hs-var">n_par_segments</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684532733"><span class="hs-identifier hs-var">body_allocs</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684532732"><span class="hs-identifier hs-var">body'</span></a></span><span> </span><span class="annot"><span class="annottext">Code
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">[Param]
</span><a href="#local-6989586621684532734"><span class="hs-identifier hs-var">free_params</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Multicore) -&gt; VName -&gt; Multicore
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; VName
</span><a href="Futhark.IR.SegOp.html#segFlat"><span class="hs-identifier hs-var hs-var">segFlat</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684532742"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-215"></span><span>
</span><span id="line-216"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#compileSegRedBody"><span class="hs-identifier hs-type">compileSegRedBody</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-217"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#TV"><span class="hs-identifier hs-type">TV</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-218"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-219"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegSpace"><span class="hs-identifier hs-type">SegSpace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-220"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.SegOp.html#SegBinOp"><span class="hs-identifier hs-type">SegBinOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-221"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#DoSegBody"><span class="hs-identifier hs-type">DoSegBody</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-222"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#MulticoreGen"><span class="hs-identifier hs-type">MulticoreGen</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.Multicore.html#Code"><span class="hs-identifier hs-type">Imp.Code</span></a></span><span>
</span><span id="line-223"></span><span id="compileSegRedBody"><span class="annot"><span class="annottext">compileSegRedBody :: TV Int64
-&gt; Pat MCMem
-&gt; SegSpace
-&gt; [SegBinOp MCMem]
-&gt; DoSegBody
-&gt; MulticoreGen Code
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#compileSegRedBody"><span class="hs-identifier hs-var hs-var">compileSegRedBody</span></a></span></span><span> </span><span id="local-6989586621684532731"><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684532731"><span class="hs-identifier hs-var">n_segments</span></a></span></span><span> </span><span id="local-6989586621684532730"><span class="annot"><span class="annottext">Pat MCMem
</span><a href="#local-6989586621684532730"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684532729"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684532729"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684532728"><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532728"><span class="hs-identifier hs-var">reds</span></a></span></span><span> </span><span id="local-6989586621684532727"><span class="annot"><span class="annottext">DoSegBody
</span><a href="#local-6989586621684532727"><span class="hs-identifier hs-var">kbody</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-224"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684532726"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684532726"><span class="hs-identifier hs-var">is</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532725"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684532725"><span class="hs-identifier hs-var">ns</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VName, SubExp)] -&gt; ([VName], [SubExp])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(VName, SubExp)] -&gt; ([VName], [SubExp]))
-&gt; [(VName, SubExp)] -&gt; ([VName], [SubExp])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; [(VName, SubExp)]
</span><a href="Futhark.IR.SegOp.html#unSegSpace"><span class="hs-identifier hs-var hs-var">unSegSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684532729"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-225"></span><span>      </span><span id="local-6989586621684532723"><span class="annot"><span class="annottext">ns_64 :: [TExp Int64]
</span><a href="#local-6989586621684532723"><span class="hs-identifier hs-var hs-var">ns_64</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684532725"><span class="hs-identifier hs-var">ns</span></a></span><span>
</span><span id="line-226"></span><span>      </span><span id="local-6989586621684532722"><span class="annot"><span class="annottext">inner_bound :: TExp Int64
</span><a href="#local-6989586621684532722"><span class="hs-identifier hs-var hs-var">inner_bound</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; TExp Int64
forall a. [a] -&gt; a
</span><span class="hs-identifier hs-var">last</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684532723"><span class="hs-identifier hs-var">ns_64</span></a></span><span>
</span><span id="line-227"></span><span>      </span><span id="local-6989586621684532720"><span class="annot"><span class="annottext">n_segments' :: TExp Int64
</span><a href="#local-6989586621684532720"><span class="hs-identifier hs-var hs-var">n_segments'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TV Int64 -&gt; TExp Int64
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684532731"><span class="hs-identifier hs-var">n_segments</span></a></span><span>
</span><span id="line-228"></span><span>
</span><span id="line-229"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684532719"><span class="annot"><span class="annottext">per_red_pes :: [[PatElemT LParamMem]]
</span><a href="#local-6989586621684532719"><span class="hs-identifier hs-var hs-var">per_red_pes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem] -&gt; [PatElemT LParamMem] -&gt; [[PatElemT LParamMem]]
forall rep a. [SegBinOp rep] -&gt; [a] -&gt; [[a]]
</span><a href="Futhark.IR.SegOp.html#segBinOpChunks"><span class="hs-identifier hs-var">segBinOpChunks</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532728"><span class="hs-identifier hs-var">reds</span></a></span><span> </span><span class="annot"><span class="annottext">([PatElemT LParamMem] -&gt; [[PatElemT LParamMem]])
-&gt; [PatElemT LParamMem] -&gt; [[PatElemT LParamMem]]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatT LParamMem -&gt; [PatElemT LParamMem]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span> </span><span class="annot"><span class="annottext">Pat MCMem
PatT LParamMem
</span><a href="#local-6989586621684532730"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-230"></span><span>  </span><span class="hs-comment">-- Perform sequential reduce on inner most dimension</span><span>
</span><span id="line-231"></span><span>  </span><span class="annot"><span class="annottext">MulticoreGen () -&gt; MulticoreGen Code
forall rep r op. ImpM rep r op () -&gt; ImpM rep r op (Code op)
</span><a href="Futhark.CodeGen.ImpGen.html#collect"><span class="hs-identifier hs-var">collect</span></a></span><span> </span><span class="annot"><span class="annottext">(MulticoreGen () -&gt; MulticoreGen Code)
-&gt; MulticoreGen () -&gt; MulticoreGen Code
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-232"></span><span>    </span><span id="local-6989586621684532718"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684532718"><span class="hs-identifier hs-var">flat_idx</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; TExp Int64 -&gt; ImpM MCMem HostEnv Multicore (TExp Int64)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TExp t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimVE"><span class="hs-identifier hs-var">dPrimVE</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;flat_idx&quot;</span></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; ImpM MCMem HostEnv Multicore (TExp Int64))
-&gt; TExp Int64 -&gt; ImpM MCMem HostEnv Multicore (TExp Int64)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684532720"><span class="hs-identifier hs-var">n_segments'</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684532722"><span class="hs-identifier hs-var">inner_bound</span></a></span><span>
</span><span id="line-233"></span><span>    </span><span class="annot"><span class="annottext">(VName -&gt; TExp Int64 -&gt; MulticoreGen ())
-&gt; [VName] -&gt; [TExp Int64] -&gt; MulticoreGen ()
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m ()
</span><span class="hs-identifier hs-var">zipWithM_</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TExp Int64 -&gt; MulticoreGen ()
forall t rep r op. VName -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV_"><span class="hs-identifier hs-var">dPrimV_</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684532726"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">([TExp Int64] -&gt; MulticoreGen ())
-&gt; [TExp Int64] -&gt; MulticoreGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; TExp Int64 -&gt; [TExp Int64]
forall num. IntegralExp num =&gt; [num] -&gt; num -&gt; [num]
</span><a href="Futhark.IR.Prop.Reshape.html#unflattenIndex"><span class="hs-identifier hs-var">unflattenIndex</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684532723"><span class="hs-identifier hs-var">ns_64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684532718"><span class="hs-identifier hs-var">flat_idx</span></a></span><span>
</span><span id="line-234"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; MulticoreGen () -&gt; MulticoreGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;neutral-initialise the accumulators&quot;</span></span><span> </span><span class="annot"><span class="annottext">(MulticoreGen () -&gt; MulticoreGen ())
-&gt; MulticoreGen () -&gt; MulticoreGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-235"></span><span>      </span><span class="annot"><span class="annottext">[([PatElemT LParamMem], SegBinOp MCMem)]
-&gt; (([PatElemT LParamMem], SegBinOp MCMem) -&gt; MulticoreGen ())
-&gt; MulticoreGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[[PatElemT LParamMem]]
-&gt; [SegBinOp MCMem] -&gt; [([PatElemT LParamMem], SegBinOp MCMem)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[[PatElemT LParamMem]]
</span><a href="#local-6989586621684532719"><span class="hs-identifier hs-var">per_red_pes</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532728"><span class="hs-identifier hs-var">reds</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((([PatElemT LParamMem], SegBinOp MCMem) -&gt; MulticoreGen ())
 -&gt; MulticoreGen ())
-&gt; (([PatElemT LParamMem], SegBinOp MCMem) -&gt; MulticoreGen ())
-&gt; MulticoreGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684532715"><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684532715"><span class="hs-identifier hs-var">pes</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532714"><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684532714"><span class="hs-identifier hs-var">red</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-236"></span><span>        </span><span class="annot"><span class="annottext">[(PatElemT LParamMem, SubExp)]
-&gt; ((PatElemT LParamMem, SubExp) -&gt; MulticoreGen ())
-&gt; MulticoreGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PatElemT LParamMem] -&gt; [SubExp] -&gt; [(PatElemT LParamMem, SubExp)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684532715"><span class="hs-identifier hs-var">pes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; [SubExp]
forall rep. SegBinOp rep -&gt; [SubExp]
</span><a href="Futhark.IR.SegOp.html#segBinOpNeutral"><span class="hs-identifier hs-var hs-var">segBinOpNeutral</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684532714"><span class="hs-identifier hs-var">red</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((PatElemT LParamMem, SubExp) -&gt; MulticoreGen ())
 -&gt; MulticoreGen ())
-&gt; ((PatElemT LParamMem, SubExp) -&gt; MulticoreGen ())
-&gt; MulticoreGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684532713"><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684532713"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532712"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684532712"><span class="hs-identifier hs-var">ne</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-237"></span><span>          </span><span class="annot"><span class="annottext">Shape -&gt; ([TExp Int64] -&gt; MulticoreGen ()) -&gt; MulticoreGen ()
forall rep r op.
Shape -&gt; ([TExp Int64] -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sLoopNest"><span class="hs-identifier hs-var">sLoopNest</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; Shape
forall rep. SegBinOp rep -&gt; Shape
</span><a href="Futhark.IR.SegOp.html#segBinOpShape"><span class="hs-identifier hs-var hs-var">segBinOpShape</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684532714"><span class="hs-identifier hs-var">red</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(([TExp Int64] -&gt; MulticoreGen ()) -&gt; MulticoreGen ())
-&gt; ([TExp Int64] -&gt; MulticoreGen ()) -&gt; MulticoreGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684532711"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684532711"><span class="hs-identifier hs-var">vec_is</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-238"></span><span>            </span><span class="annot"><span class="annottext">VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; MulticoreGen ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684532713"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(VName -&gt; TExp Int64) -&gt; [VName] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TExp Int64
forall a. a -&gt; TPrimExp Int64 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le64"><span class="hs-identifier hs-var">Imp.le64</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; [VName]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">init</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684532726"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; [TExp Int64] -&gt; [TExp Int64]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684532711"><span class="hs-identifier hs-var">vec_is</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684532712"><span class="hs-identifier hs-var">ne</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-239"></span><span>
</span><span id="line-240"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; MulticoreGen () -&gt; MulticoreGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;main body&quot;</span></span><span> </span><span class="annot"><span class="annottext">(MulticoreGen () -&gt; MulticoreGen ())
-&gt; MulticoreGen () -&gt; MulticoreGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-241"></span><span>      </span><span class="annot"><span class="annottext">Maybe (Exp MCMem) -&gt; Scope MCMem -&gt; MulticoreGen ()
forall rep inner r op.
Mem rep inner =&gt;
Maybe (Exp rep) -&gt; Scope rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dScope"><span class="hs-identifier hs-var">dScope</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp MCMem)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">(Scope MCMem -&gt; MulticoreGen ()) -&gt; Scope MCMem -&gt; MulticoreGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem] -&gt; Scope MCMem
forall rep dec. (LParamInfo rep ~ dec) =&gt; [Param dec] -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOfLParams"><span class="hs-identifier hs-var">scopeOfLParams</span></a></span><span> </span><span class="annot"><span class="annottext">([Param LParamMem] -&gt; Scope MCMem)
-&gt; [Param LParamMem] -&gt; Scope MCMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SegBinOp MCMem -&gt; [Param LParamMem])
-&gt; [SegBinOp MCMem] -&gt; [Param LParamMem]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LambdaT MCMem -&gt; [Param LParamMem]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">(LambdaT MCMem -&gt; [Param LParamMem])
-&gt; (SegBinOp MCMem -&gt; LambdaT MCMem)
-&gt; SegBinOp MCMem
-&gt; [Param LParamMem]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; LambdaT MCMem
forall rep. SegBinOp rep -&gt; Lambda rep
</span><a href="Futhark.IR.SegOp.html#segBinOpLambda"><span class="hs-identifier hs-var hs-var">segBinOpLambda</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532728"><span class="hs-identifier hs-var">reds</span></a></span><span>
</span><span id="line-242"></span><span>      </span><span class="annot"><span class="annottext">String
-&gt; TExp Int64 -&gt; (TExp Int64 -&gt; MulticoreGen ()) -&gt; MulticoreGen ()
forall t rep r op.
String
-&gt; TExp t -&gt; (TExp t -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sFor"><span class="hs-identifier hs-var">sFor</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;i&quot;</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684532722"><span class="hs-identifier hs-var">inner_bound</span></a></span><span> </span><span class="annot"><span class="annottext">((TExp Int64 -&gt; MulticoreGen ()) -&gt; MulticoreGen ())
-&gt; (TExp Int64 -&gt; MulticoreGen ()) -&gt; MulticoreGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684532709"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684532709"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-243"></span><span>        </span><span class="annot"><span class="annottext">(TV Int64 -&gt; TExp Int64 -&gt; MulticoreGen ())
-&gt; [TV Int64] -&gt; [TExp Int64] -&gt; MulticoreGen ()
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m ()
</span><span class="hs-identifier hs-var">zipWithM_</span></span><span>
</span><span id="line-244"></span><span>          </span><span class="annot"><span class="annottext">TV Int64 -&gt; TExp Int64 -&gt; MulticoreGen ()
forall t rep r op. TV t -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#%3C--"><span class="hs-operator hs-var">(&lt;--)</span></a></span><span>
</span><span id="line-245"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(VName -&gt; TV Int64) -&gt; [VName] -&gt; [TV Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; TV Int64
forall t. VName -&gt; PrimType -&gt; TV t
</span><a href="Futhark.CodeGen.ImpGen.html#mkTV"><span class="hs-operator hs-var">`mkTV`</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int64"><span class="hs-identifier hs-var">int64</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; [TV Int64]) -&gt; [VName] -&gt; [TV Int64]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">init</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684532726"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-246"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TExp Int64] -&gt; TExp Int64 -&gt; [TExp Int64]
forall num. IntegralExp num =&gt; [num] -&gt; num -&gt; [num]
</span><a href="Futhark.IR.Prop.Reshape.html#unflattenIndex"><span class="hs-identifier hs-var">unflattenIndex</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TExp Int64] -&gt; [TExp Int64]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">init</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684532723"><span class="hs-identifier hs-var">ns_64</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684532720"><span class="hs-identifier hs-var">n_segments'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-247"></span><span>        </span><span class="annot"><span class="annottext">VName -&gt; TExp Int64 -&gt; MulticoreGen ()
forall t rep r op. VName -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV_"><span class="hs-identifier hs-var">dPrimV_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; VName
forall a. [a] -&gt; a
</span><span class="hs-identifier hs-var">last</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684532726"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684532709"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-248"></span><span>        </span><span class="annot"><span class="annottext">DoSegBody
</span><a href="#local-6989586621684532727"><span class="hs-identifier hs-var">kbody</span></a></span><span> </span><span class="annot"><span class="annottext">DoSegBody -&gt; DoSegBody
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684532707"><span class="annot"><span class="annottext">[(SubExp, [TExp Int64])]
</span><a href="#local-6989586621684532707"><span class="hs-identifier hs-var">all_red_res</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-249"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684532705"><span class="annot"><span class="annottext">red_res' :: [[(SubExp, [TExp Int64])]]
</span><a href="#local-6989586621684532705"><span class="hs-identifier hs-var hs-var">red_res'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; [(SubExp, [TExp Int64])] -&gt; [[(SubExp, [TExp Int64])]]
forall a. [Int] -&gt; [a] -&gt; [[a]]
</span><a href="Futhark.Util.html#chunks"><span class="hs-identifier hs-var">chunks</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SegBinOp MCMem -&gt; Int) -&gt; [SegBinOp MCMem] -&gt; [Int]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; Int)
-&gt; (SegBinOp MCMem -&gt; [SubExp]) -&gt; SegBinOp MCMem -&gt; Int
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; [SubExp]
forall rep. SegBinOp rep -&gt; [SubExp]
</span><a href="Futhark.IR.SegOp.html#segBinOpNeutral"><span class="hs-identifier hs-var hs-var">segBinOpNeutral</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532728"><span class="hs-identifier hs-var">reds</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(SubExp, [TExp Int64])]
</span><a href="#local-6989586621684532707"><span class="hs-identifier hs-var">all_red_res</span></a></span><span>
</span><span id="line-250"></span><span>          </span><span class="annot"><span class="annottext">[([PatElemT LParamMem], SegBinOp MCMem, [(SubExp, [TExp Int64])])]
-&gt; (([PatElemT LParamMem], SegBinOp MCMem,
     [(SubExp, [TExp Int64])])
    -&gt; MulticoreGen ())
-&gt; MulticoreGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[[PatElemT LParamMem]]
-&gt; [SegBinOp MCMem]
-&gt; [[(SubExp, [TExp Int64])]]
-&gt; [([PatElemT LParamMem], SegBinOp MCMem,
     [(SubExp, [TExp Int64])])]
forall a b c. [a] -&gt; [b] -&gt; [c] -&gt; [(a, b, c)]
</span><span class="hs-identifier hs-var">zip3</span></span><span> </span><span class="annot"><span class="annottext">[[PatElemT LParamMem]]
</span><a href="#local-6989586621684532719"><span class="hs-identifier hs-var">per_red_pes</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOp MCMem]
</span><a href="#local-6989586621684532728"><span class="hs-identifier hs-var">reds</span></a></span><span> </span><span class="annot"><span class="annottext">[[(SubExp, [TExp Int64])]]
</span><a href="#local-6989586621684532705"><span class="hs-identifier hs-var">red_res'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((([PatElemT LParamMem], SegBinOp MCMem, [(SubExp, [TExp Int64])])
  -&gt; MulticoreGen ())
 -&gt; MulticoreGen ())
-&gt; (([PatElemT LParamMem], SegBinOp MCMem,
     [(SubExp, [TExp Int64])])
    -&gt; MulticoreGen ())
-&gt; MulticoreGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684532704"><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684532704"><span class="hs-identifier hs-var">pes</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532703"><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684532703"><span class="hs-identifier hs-var">red</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532702"><span class="annot"><span class="annottext">[(SubExp, [TExp Int64])]
</span><a href="#local-6989586621684532702"><span class="hs-identifier hs-var">res'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-251"></span><span>            </span><span class="annot"><span class="annottext">Shape -&gt; ([TExp Int64] -&gt; MulticoreGen ()) -&gt; MulticoreGen ()
forall rep r op.
Shape -&gt; ([TExp Int64] -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sLoopNest"><span class="hs-identifier hs-var">sLoopNest</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; Shape
forall rep. SegBinOp rep -&gt; Shape
</span><a href="Futhark.IR.SegOp.html#segBinOpShape"><span class="hs-identifier hs-var hs-var">segBinOpShape</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684532703"><span class="hs-identifier hs-var">red</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(([TExp Int64] -&gt; MulticoreGen ()) -&gt; MulticoreGen ())
-&gt; ([TExp Int64] -&gt; MulticoreGen ()) -&gt; MulticoreGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684532701"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684532701"><span class="hs-identifier hs-var">vec_is</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-252"></span><span>              </span><span class="annot"><span class="annottext">String -&gt; MulticoreGen () -&gt; MulticoreGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;load accum&quot;</span></span><span> </span><span class="annot"><span class="annottext">(MulticoreGen () -&gt; MulticoreGen ())
-&gt; MulticoreGen () -&gt; MulticoreGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-253"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684532699"><span class="annot"><span class="annottext">acc_params :: [Param LParamMem]
</span><a href="#local-6989586621684532699"><span class="hs-identifier hs-var hs-var">acc_params</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Param LParamMem] -&gt; [Param LParamMem]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">take</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; [SubExp]
forall rep. SegBinOp rep -&gt; [SubExp]
</span><a href="Futhark.IR.SegOp.html#segBinOpNeutral"><span class="hs-identifier hs-var hs-var">segBinOpNeutral</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684532703"><span class="hs-identifier hs-var">red</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Param LParamMem] -&gt; [Param LParamMem])
-&gt; [Param LParamMem] -&gt; [Param LParamMem]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LambdaT MCMem -&gt; [Param LParamMem]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">(LambdaT MCMem -&gt; [Param LParamMem])
-&gt; (SegBinOp MCMem -&gt; LambdaT MCMem)
-&gt; SegBinOp MCMem
-&gt; [Param LParamMem]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; LambdaT MCMem
forall rep. SegBinOp rep -&gt; Lambda rep
</span><a href="Futhark.IR.SegOp.html#segBinOpLambda"><span class="hs-identifier hs-var hs-var">segBinOpLambda</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684532703"><span class="hs-identifier hs-var">red</span></a></span><span>
</span><span id="line-254"></span><span>                </span><span class="annot"><span class="annottext">[(Param LParamMem, PatElemT LParamMem)]
-&gt; ((Param LParamMem, PatElemT LParamMem) -&gt; MulticoreGen ())
-&gt; MulticoreGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param LParamMem]
-&gt; [PatElemT LParamMem] -&gt; [(Param LParamMem, PatElemT LParamMem)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684532699"><span class="hs-identifier hs-var">acc_params</span></a></span><span> </span><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684532704"><span class="hs-identifier hs-var">pes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Param LParamMem, PatElemT LParamMem) -&gt; MulticoreGen ())
 -&gt; MulticoreGen ())
-&gt; ((Param LParamMem, PatElemT LParamMem) -&gt; MulticoreGen ())
-&gt; MulticoreGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684532698"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684532698"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532697"><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684532697"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-255"></span><span>                  </span><span class="annot"><span class="annottext">VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; MulticoreGen ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684532698"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SubExp) -&gt; VName -&gt; SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684532697"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(VName -&gt; TExp Int64) -&gt; [VName] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TExp Int64
forall a. a -&gt; TPrimExp Int64 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le64"><span class="hs-identifier hs-var">Imp.le64</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; [VName]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">init</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684532726"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; [TExp Int64] -&gt; [TExp Int64]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684532701"><span class="hs-identifier hs-var">vec_is</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-256"></span><span>
</span><span id="line-257"></span><span>              </span><span class="annot"><span class="annottext">String -&gt; MulticoreGen () -&gt; MulticoreGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;load new val&quot;</span></span><span> </span><span class="annot"><span class="annottext">(MulticoreGen () -&gt; MulticoreGen ())
-&gt; MulticoreGen () -&gt; MulticoreGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-258"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684532695"><span class="annot"><span class="annottext">next_params :: [Param LParamMem]
</span><a href="#local-6989586621684532695"><span class="hs-identifier hs-var hs-var">next_params</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Param LParamMem] -&gt; [Param LParamMem]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; [SubExp]
forall rep. SegBinOp rep -&gt; [SubExp]
</span><a href="Futhark.IR.SegOp.html#segBinOpNeutral"><span class="hs-identifier hs-var hs-var">segBinOpNeutral</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684532703"><span class="hs-identifier hs-var">red</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Param LParamMem] -&gt; [Param LParamMem])
-&gt; [Param LParamMem] -&gt; [Param LParamMem]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LambdaT MCMem -&gt; [Param LParamMem]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">(LambdaT MCMem -&gt; [Param LParamMem])
-&gt; (SegBinOp MCMem -&gt; LambdaT MCMem)
-&gt; SegBinOp MCMem
-&gt; [Param LParamMem]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; LambdaT MCMem
forall rep. SegBinOp rep -&gt; Lambda rep
</span><a href="Futhark.IR.SegOp.html#segBinOpLambda"><span class="hs-identifier hs-var hs-var">segBinOpLambda</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684532703"><span class="hs-identifier hs-var">red</span></a></span><span>
</span><span id="line-259"></span><span>                </span><span class="annot"><span class="annottext">[(Param LParamMem, (SubExp, [TExp Int64]))]
-&gt; ((Param LParamMem, (SubExp, [TExp Int64])) -&gt; MulticoreGen ())
-&gt; MulticoreGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param LParamMem]
-&gt; [(SubExp, [TExp Int64])]
-&gt; [(Param LParamMem, (SubExp, [TExp Int64]))]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684532695"><span class="hs-identifier hs-var">next_params</span></a></span><span> </span><span class="annot"><span class="annottext">[(SubExp, [TExp Int64])]
</span><a href="#local-6989586621684532702"><span class="hs-identifier hs-var">res'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Param LParamMem, (SubExp, [TExp Int64])) -&gt; MulticoreGen ())
 -&gt; MulticoreGen ())
-&gt; ((Param LParamMem, (SubExp, [TExp Int64])) -&gt; MulticoreGen ())
-&gt; MulticoreGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684532694"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684532694"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684532693"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684532693"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532692"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684532692"><span class="hs-identifier hs-var">res_is</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-260"></span><span>                  </span><span class="annot"><span class="annottext">VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; MulticoreGen ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684532694"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684532693"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684532692"><span class="hs-identifier hs-var">res_is</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; [TExp Int64] -&gt; [TExp Int64]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684532701"><span class="hs-identifier hs-var">vec_is</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-261"></span><span>
</span><span id="line-262"></span><span>              </span><span class="annot"><span class="annottext">String -&gt; MulticoreGen () -&gt; MulticoreGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;apply reduction&quot;</span></span><span> </span><span class="annot"><span class="annottext">(MulticoreGen () -&gt; MulticoreGen ())
-&gt; MulticoreGen () -&gt; MulticoreGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-263"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684532691"><span class="annot"><span class="annottext">lbody :: Body MCMem
</span><a href="#local-6989586621684532691"><span class="hs-identifier hs-var hs-var">lbody</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LambdaT MCMem -&gt; Body MCMem
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">(LambdaT MCMem -&gt; Body MCMem)
-&gt; (SegBinOp MCMem -&gt; LambdaT MCMem)
-&gt; SegBinOp MCMem
-&gt; Body MCMem
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem -&gt; LambdaT MCMem
forall rep. SegBinOp rep -&gt; Lambda rep
</span><a href="Futhark.IR.SegOp.html#segBinOpLambda"><span class="hs-identifier hs-var hs-var">segBinOpLambda</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684532703"><span class="hs-identifier hs-var">red</span></a></span><span>
</span><span id="line-264"></span><span>                </span><span class="annot"><span class="annottext">Names -&gt; Stms MCMem -&gt; MulticoreGen () -&gt; MulticoreGen ()
forall rep r op.
Names -&gt; Stms rep -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileStms"><span class="hs-identifier hs-var">compileStms</span></a></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Body MCMem -&gt; Stms MCMem
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">Body MCMem
</span><a href="#local-6989586621684532691"><span class="hs-identifier hs-var">lbody</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(MulticoreGen () -&gt; MulticoreGen ())
-&gt; MulticoreGen () -&gt; MulticoreGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-265"></span><span>                  </span><span class="annot"><span class="annottext">String -&gt; MulticoreGen () -&gt; MulticoreGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;write back to res&quot;</span></span><span> </span><span class="annot"><span class="annottext">(MulticoreGen () -&gt; MulticoreGen ())
-&gt; MulticoreGen () -&gt; MulticoreGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-266"></span><span>                    </span><span class="annot"><span class="annottext">[(PatElemT LParamMem, SubExp)]
-&gt; ((PatElemT LParamMem, SubExp) -&gt; MulticoreGen ())
-&gt; MulticoreGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PatElemT LParamMem] -&gt; [SubExp] -&gt; [(PatElemT LParamMem, SubExp)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684532704"><span class="hs-identifier hs-var">pes</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [(PatElemT LParamMem, SubExp)])
-&gt; [SubExp] -&gt; [(PatElemT LParamMem, SubExp)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExpRes -&gt; SubExp) -&gt; [SubExpRes] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExpRes -&gt; SubExp
</span><a href="Futhark.IR.Syntax.html#resSubExp"><span class="hs-identifier hs-var hs-var">resSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExpRes] -&gt; [SubExp]) -&gt; [SubExpRes] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Body MCMem -&gt; [SubExpRes]
forall rep. BodyT rep -&gt; [SubExpRes]
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var hs-var">bodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">Body MCMem
</span><a href="#local-6989586621684532691"><span class="hs-identifier hs-var">lbody</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((PatElemT LParamMem, SubExp) -&gt; MulticoreGen ())
 -&gt; MulticoreGen ())
-&gt; ((PatElemT LParamMem, SubExp) -&gt; MulticoreGen ())
-&gt; MulticoreGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-267"></span><span>                      </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684532690"><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684532690"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684532689"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684532689"><span class="hs-identifier hs-var">se'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; MulticoreGen ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684532690"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(VName -&gt; TExp Int64) -&gt; [VName] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TExp Int64
forall a. a -&gt; TPrimExp Int64 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le64"><span class="hs-identifier hs-var">Imp.le64</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; [VName]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">init</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684532726"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; [TExp Int64] -&gt; [TExp Int64]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684532701"><span class="hs-identifier hs-var">vec_is</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684532689"><span class="hs-identifier hs-var">se'</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-268"></span></pre></body></html>